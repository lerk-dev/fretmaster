<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="msapplication-navbutton-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title data-i18n-key="page_title">🎸 吉他练习工具 v0.361</title>
    <!-- ml5.js库 - 用于CREPE音高检测算法 -->
    <script src="js/ml5.min.js"></script>

    
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="styles/main.css">
    
    <!-- 内联i18n核心功能 -->
    <script>
        // 内联i18n核心功能
        (function() {
            
            // 定义语言数据
            const translations = {
                'zh-CN': {
                    'app_title': '🎸 吉他指板视觉化练习工具',
                 
                    'page_title': '吉他指板视觉化练习工具',
                    'btn_start': '开始练习',
                    'status_ready': '准备就绪',
                    'lang_zh': '中文',
                    'lang_en': 'English',
                    'nav_scale': '音阶练习',
                    'nav_chord': '和弦练习',
                    'nav_progression': '和弦进行',
                    'nav_pitch_finding': '音程练习',
                    'settings_pitch_finding': '音程练习设置',
                    'nav_settings': '设置',
                    'settings_scale': '音阶练习选项',
                    'settings_chord': '和弦练习选项',
                    'settings_device': '设备设置',
                    'settings_general': '通用设置',
                    'general_language': '语言设置',
                    'interface_language': '界面语言',
                    'test_language_switch': '测试语言切换',
                    
                    // 快捷键提示
                    'shortcut_hint': '按 ESC 返回主菜单',
                    
                    // 音高显示
                    'pitch_display': '音高',
                    'cents_display': '音分差',
                    
                    // 和弦设置
                    'chord_root_note': '根音',
                    'chord_root_note_hint': '选择和弦的根音',
                    'chord_type': '和弦类型',
                    'chord_type_hint': '选择要练习的和弦类型',
                    'chord_order': '顺序',
                    'chord_order_hint': '选择和弦音符的演奏顺序',
                    'chord_custom': '自定义和弦进行',
                    
                    // 和弦转位设置
                    'chord_bass_note': '低音音符',
                    'chord_bass_root': '根音',
                    'chord_bass_3rd': '三音',
                    'chord_bass_5th': '五音',
                    'chord_bass_7th': '七音',
                    'chord_bass_random': '随机',

                    
                    // 顺序按钮
                    'order_ascending': '上行',
                    'order_descending': '下行',
                    'order_random': '随机',
                    
                    // 和弦类型
                    'chord_major': '大三和弦',
                    'chord_minor': '小三和弦',
                    'chord_dim': '减三和弦',
                    'chord_aug': '增三和弦',
                    'chord_6': '大六和弦',
                    'chord_m6': '小六和弦',
                    'chord_7': '属七和弦',
                    'chord_maj7': '大七和弦',
                    'chord_m7': '小七和弦',
                    'chord_m7b5': '半减七和弦',
                    'chord_dim7': '减七和弦',
                    'chord_9': '属九和弦',
                    'chord_maj9': '大九和弦',
                    'chord_m9': '小九和弦',
                    'chord_7sharp9': '属7♯9和弦',
                    'chord_7flat9': '属7♭9和弦',
                    'chord_11': '属十一和弦',
                    'chord_m11': '小十一和弦',
                    'chord_7sharp11': '属7♯11和弦',
                    'chord_13': '属十三和弦',
                    'chord_m13': '小十三和弦',
                    'chord_sus2': '挂二和弦',
                    'chord_sus4': '挂四和弦',
                    'chord_add9': '加九和弦',
                    'chord_madd9': '小加九和弦',
                    'chord_6add9': '六加九和弦',
                    'chord_m6add9': '小六加九和弦',
                    
                    // 随机选项
                    'random': '随机',
                    'random_root': '随机根音',
                    'random_chord': '随机和弦',
                    
                    // 选择器页面
                    'search_song_placeholder': '搜索歌曲名...',
                    'select_song': '选择乐曲',
                    'practice_level': '练习等级',
                    'select_key': '选择调性',
                    'key_desc': '调性',
                    
                    // 练习等级选项
                    'single_chord_notes': '单和弦音',
                    'double_chord_notes': '双和弦音',
                    'triple_chord_notes': '三和弦音',
                    'quad_chord_notes': '四和弦音',
                    'all_chord_notes': '全部和弦音',

                    // 音程描述
                    'root_note': 'R',
                    'third_note': '3rd',
                    'fifth_note': '5th',
                    'seventh_note': '7th',
                    'root': '根音',
                    'third': '三音',
                    'fifth': '五音',
                    'seventh': '七音',
                    'root_third': 'R,3rd',
                    'root_fifth': 'R,5th',
                    'root_seventh': 'R,7th',
                    'third_fifth': '3rd,5th',
                    'third_seventh': '3rd,7th',
                    'root_third_fifth': '原位三和弦',
                    'third_fifth_seventh': '3rd,5th,7th',
                    'random_inversion': '随机转位',
                    'root_third_fifth_seventh': '原位七和弦',
                    'first_inversion': '第一转位',
                    'second_inversion': '第二转位',
                    'third_inversion': '第三转位',
                    'with_octave_root': '含高八度根音',
                    'all_notes': '全部音',
                    'all_chord_notes_desc': '和弦所有音符',

                    // 新增选项描述翻译
                    'root_to_third': '1,2,3,5 on major/dominant chords\n1,3,4,5 on minor chords\n1,2,4,5 on sus chords\n1,2,3,5 on diminished chords\n(No altered 5ths on dominant chords)',
                    'root_to_fifth': '根音到五音的旋律线',
                    'third_to_fifth': '三音到五音的旋律线',
                    'root_third_fifth_line': '根音三音五音连接线',
                    'random_inversions': '随机转位进行',
                    'fifth_to_seventh': '五音到七音的旋律线',
                    'seventh_to_ninth': '七音到九音的旋律线',
                    'fifth_to_ninth': '五音到九音的旋律线',
                    'fifth_seventh_ninth_line': '五音七音九音连接线',
                    'stepwise_voice_leading': '级进式的声部进行',
                    'common_tone_voice_leading': '保持共同音的声部进行',
                    'contrary_motion_voice_leading': '反向声部进行',
                    'parallel_motion_voice_leading': '平行声部进行',
                    'sus4_to_sus2': 'Sus4挂留到Sus2挂留',
                    'sus4_to_third': 'Sus4挂留解决到三音',
                    'sus2_to_third': 'Sus2挂留解决到三音',
                    'suspension_resolution_chain': '挂留解决链条',
                    'triadic_chord_scales': '基于三和弦的和弦音阶',
                    'seventh_chord_scales': '基于七和弦的和弦音阶',
                    'extended_chord_scales': '基于扩展和弦的和弦音阶',
                    'modal_chord_scales': '调式和弦音阶',
                    'diatonic_passing_tones': '自然音阶经过音',
                    'chromatic_passing_tones': '半音经过音',
                    'enclosure_passing_tones': '包围音经过技巧',
                    'appoggiatura_passing_tones': '装饰音经过技巧',
                    'random_scale': '随机调式',
                    
                    // 自定义和弦进行页面
                    'custom_chord_title': '自定义和弦进行',
                    'custom_chord_root': '根音',
                    'custom_chord_type': '和弦类型',
                    'custom_chord_inversion': '转位',
                    'custom_chord_bass_root': '根音',
                    'custom_chord_bass_3rd': '三音',
                    'custom_chord_bass_5th': '五音',
                    'custom_chord_bass_7th': '七音',
                    'custom_chord_add': '添加和弦',
                    'custom_chord_sequence_name': '输入歌曲名称...',
                    'custom_chord_clear': '清空',
                    'custom_chord_save': '保存',
                    'custom_chord_load': '加载',
                    'custom_chord_load_practice': '加载练习',
                    'btn_custom_chords': '自定义和弦进行',
                    
                    // 音阶设置
                    'scale_key': '调',
                    'scale_mode': '调式',
                    'scale_direction': '方向',
                    'scale_practice_sequence': '练习序列',
                    'scale_order': '演奏顺序',
                    
                    // 设备设置
                    'device_audio_input': '音频输入设备',
                    'device_gain': '输入增益',
                    'device_metronome': '节拍器',
                    'device_tempo': '速度',
                    'device_sensitivity': '灵敏度',
                    'device_cooldown': '冷却时间',
                    'device_confidence': '置信度阈值',
                    'device_noise': '噪音等级',
                    'device_volume': '最小音量',
                    'device_buffer': '缓冲区大小',
                    'device_harmonic': '谐波权重',
                    'device_zero_crossing': '零交叉阈值',
                    
                    // 通用设置
                    'general_language': '语言设置',
                    'interface_language': '界面语言',
                    
                    // 按钮和操作
                    'btn_save': '保存设置',
                    'btn_reset': '重置设置',
                    'btn_refresh': '刷新设备列表',
                    'btn_back': '返回主菜单',
                    'btn_cancel': '取消',
                    'btn_confirm': '确认',

                    // 调式选择控制按钮
                    'select_all': '全选',
                    'deselect_all': '全不选',
                    'random_select': '随机选择',
                    'btn_delete': '删除',
                    'btn_edit': '编辑',
                    'btn_add': '添加',
                    'btn_clear': '清空',
                    
                    // 状态信息
                    'status_recording': '录音中',
                    'status_processing': '处理中',
                    'status_error': '错误',
                    'status_success': '成功',
                    
                    // 错误信息
                    'error_no_audio_support': '您的浏览器不支持音频API',
                    'error_microphone_permission': '无法获取麦克风权限',
                    'error_audio_device': '音频设备初始化失败',
                    'error_pitch_detection': '音高检测失败',
                    
                    // 提示信息
                    'hint_select_device': '请选择音频输入设备',
                    'hint_connect_guitar': '请连接您的吉他',
                    'hint_start_practice': '点击开始练习按钮开始',
                    'hint_select_chord_type': '请选择至少一个和弦类型',
                    'hint_select_scale': '请选择音阶类型',
                    'device_count_detected': '{count} 个音频输入设备',
                    'device_count_none': '未检测到音频输入设备',
                    'default_device': '默认设备',
                    'audio_device': '音频设备',
                    'key_c_default': 'C 默认',
                    
                    // CAGED练习设置
                    'caged_practice': 'CAGED练习',
                    'caged_practice_hint': '基于CAGED系统的音阶和和弦练习',
                    'caged_practice_mode': 'CAGED练习模式',
                    'caged_shape': 'CAGED形状',
                    'caged_shape_hint': '选择要练习的CAGED形状',
                    'caged_key': '调性',
                    'caged_key_hint': '选择练习调性',
                    'caged_mode': '练习模式',
                    'caged_mode_hint': '选择CAGED练习模式',
                    'caged_shape_connection': '形状连接',
                    'caged_random_shapes': '随机形状',
                    'caged_show_fretboard': '显示指板',
                    'caged_show_fingering': '显示指法',
                    'caged_show_scale': '显示音阶',
                    'caged_chord_practice': 'CAGED和弦练习',
                    'caged_show_chord': '显示和弦',
                    'caged_c_shape': 'C形状',
                    'caged_a_shape': 'A形状',
                    'caged_g_shape': 'G形状',
                    'caged_e_shape': 'E形状',
                    'caged_d_shape': 'D形状',
                    'midi_support': 'MIDI设备支持',
                    'midi_support_hint': '连接MIDI键盘或控制器进行练习',
                    'midi_device_connected': 'MIDI设备已连接',
                    'midi_device_disconnected': 'MIDI设备未连接',
                    'midi_device_detected': '检测到 {count} 个MIDI设备',
                    'midi_device_none': '未检测到MIDI设备',

                    // 歌曲信息相关
                    'basic_info': '基本信息',
                    'song_composer': '作曲家:',
                    'song_year': '年代:',
                    'song_style': '风格:',
                    'song_tempo': '速度:',
                    'song_key': '原调:',
                    'song_description': '曲目介绍',
                    'select_this_song': '选择此曲目',
                    'unknown': '未知',
                    'jazz_standard': '爵士标准曲',
                    'chord_progression': '和弦进行',

                    // 和弦练习分组
                    'chord_single_notes': '单和弦音',
                    'chord_double_notes': '双和弦音',
                    'chord_triple_notes': '三和弦音',
                    'chord_quad_notes': '四和弦音',
                    'chord_all_notes': '全部和弦音',

                    // 新增练习分组
                    'melodic_structure_r_to_5th': '旋律结构 - R→5th',
                    'melodic_structure_5th_to_9th': '旋律结构 - 5th→9th',
                    'voice_led_structure': 'Voice Led结构',
                    'suspension_structure': '挂留结构',
                    'chord_scale_structure': '和弦音阶',
                    'passing_tone_structure': '经过音分组',

                    // 键盘操作提示
                    'keyboard_hide': '隐藏',
                    'keyboard_show': '显示',
                    'keyboard_space': '空格',
                    'keyboard_next': '下一个',

                    // 麦克风权限相关
                    'mic_permission_denied': '麦克风权限被拒绝',
                    'mic_permission_needed': '此应用需要麦克风权限才能检测音高。',
                    'mic_permission_steps': '请按照以下步骤操作：',
                    'mic_step_1': '点击浏览器地址栏左侧的锁定/信息图标',
                    'mic_step_2': '在弹出的菜单中找到"麦克风"选项',
                    'mic_step_3': '将其设置为"允许"',
                    'mic_step_4': '刷新页面后重试',
                    'refresh_page': '刷新页面',
                    'return_to_main': '返回主菜单',

                    // 练习相关
                    'practice_scale': '音阶练习',
                    'practice_chord': '和弦练习',
                    'practice_progression': '和弦进行练习',
                    'practice_arpeggio': '琶音练习',
                    'practice_interval': '音程练习',
                    
                    // 音阶类型
                    'scale_major': '大调',
                    'scale_minor': '小调',
                    'scale_dorian': '多利亚',
                    'scale_phrygian': '弗里几亚',
                    'scale_lydian': '利底亚',
                    'scale_mixolydian': '混合利底亚',
                    'scale_locrian': '洛克里亚',
                    'scale_harmonic_minor': '和声小调',
                    'scale_melodic_minor': '旋律小调',
                    'scale_pentatonic_major': '大调五声音阶',
                    'scale_pentatonic_minor': '小调五声音阶',
                    'scale_blues': '蓝调音阶',
                    
                    // 和弦转换设置
                    'progression_settings': '转换设置',
                    'progression_level': '练习等级',
                    'progression_level_hint': '选择和弦复杂度',
                    'single_chord_notes': '单和弦音',
                    'double_chord_notes': '双和弦音',
                    'triple_chord_notes': '三和弦音',
                    'quad_chord_notes': '四和弦音',
                    'progression_key': '乐曲',
                    'progression_key_hint': '选择乐曲',
                    'progression_tunes': '乐曲',
                    'progression_tunes_hint': '选择练习乐曲',
                    'progression_style': '风格',
                    'progression_style_hint': '选择练习风格',
                    'progression_tempo': '速度',
                    'progression_tempo_hint': '设置练习速度',
                    'progression_difficulty': '难度',
                    'progression_difficulty_hint': '选择练习难度',
                    
                    // 音阶设置详细
                    'scale_root_note': '调',
                    'scale_root_note_hint': '选择调',
                    'scale_type': '调式',
                    'scale_type_hint': '选择调式',
                    'scale_direction_hint': '选择演奏方向',
                    'scale_practice_sequence_hint': '选择练习序列',
                    'scale_arpeggio': '琶音',
                    'scale_arpeggio_hint': '选择琶音类型',
                    'scale_interval': '音程',
                    'scale_interval_hint': '选择音程练习',
                    'scale_random': '随机',
                    'scale_random_hint': '随机生成练习',
                    
                    // 设备设置详细
                    'device_audio_input_hint': '选择音频输入设备',
                    'device_gain_hint': '调整输入增益',
                    'device_metronome_hint': '启用节拍器',
                    'device_tempo_hint': '设置节拍器速度',
                    'device_sensitivity_hint': '调整音高检测灵敏度',
                    'device_cooldown_hint': '设置冷却时间',
                    'device_confidence_hint': '设置置信度阈值',
                    'device_noise_hint': '设置噪音等级',
                    'device_volume_hint': '设置最小音量',
                    'device_buffer_hint': '设置缓冲区大小',
                    'device_harmonic_hint': '设置谐波权重',
                    'device_zero_crossing_hint': '设置零交叉阈值',
                    
                    // 通用设置详细
                    'general_language_hint': '选择界面语言',
                    'interface_language_hint': '选择界面语言',
                    'general_theme': '主题',
                    'general_theme_hint': '选择界面主题',
                    'theme_dark': '深色主题',
                    'theme_light': '浅色主题',
                    'theme_auto': '跟随系统',
                    'general_sound': '声音',
                    'general_sound_hint': '设置声音选项',
                    'general_display': '显示',
                    'general_display_hint': '设置显示选项',
                    'general_advanced': '高级',
                    'general_advanced_hint': '高级设置选项',
                    
                    // 音阶设置optgroup标签
                    'basic_modes': '基本调式',
                    'church_modes': '教会调式 (Church Modes)',
                    'harmonic_minor_series': '和声小调系列',
                    'melodic_minor_series': '旋律小调系列',
                    'pentatonic_scales': '五声音阶',
                    'blues_scales': '布鲁斯音阶',
                    'special_scales': '特殊音阶',
                    'exotic_scales': '异国风格',
                    
                    // 和弦转换设置optgroup标签
                    'single_chord_notes': '单和弦音',
                    'double_chord_notes': '双和弦音',
                    'triple_chord_notes': '三和弦音',
                    'quad_chord_notes': '四和弦音',
                    
                    // 和弦转换设置选项
                    'single_chord_tones': '单和弦音',
                    'two_chord_tones': '双和弦音',
                    'three_chord_tones': '三和弦音',
                    'four_chord_tones': '四和弦音',
                    'random_inversions_135': '135随机转位',
                    'random_inversions_1357': '1357随机转位',
                    'all_chord_tones': '全部和弦音',
                    'all': '全部',
                    
                    // 找音练习设置
                    'pitch_finding_practice_time': '练习时间',
                    'pitch_finding_practice_time_hint': '选择练习时长',
                    'pitch_finding_show_fretboard': '显示指板',
                    'pitch_finding_show_fretboard_hint': '检测到正确音高时在指板上显示位置',
                    'fretboard_keyboard_hint': '💡 ↓隐藏 ↑显示 空格下一个',
                    'pitch_finding_fretboard_range': '指板长度',
                    'pitch_finding_fretboard_range_hint': '选择指板显示范围',
                    'pitch_finding_12_frets': '12品',
                    'pitch_finding_15_frets': '15品',
                    'pitch_finding_18_frets': '18品',
                    'pitch_finding_24_frets': '24品',
                    'pitch_finding_current_note': '当前音符',
                    'pitch_finding_time_remaining': '剩余时间',
                    'pitch_finding_practice_complete': '练习完成',
                    'pitch_finding_next_interval': '下一题间隔',
                    'pitch_finding_next_interval_hint': '答对后自动进入下一题的时间间隔',
                    'pitch_finding_no_auto': '手动',
                    'pitch_finding_2_seconds': '2秒',
                    'pitch_finding_3_seconds': '3秒',
                    'pitch_finding_5_seconds': '5秒',
                    'pitch_finding_1_minute': '1分钟',
                    'pitch_finding_2_minutes': '2分钟',
                    'pitch_finding_3_minutes': '3分钟',
                    'pitch_finding_5_minutes': '5分钟',
                    'pitch_finding_10_minutes': '10分钟',
                    'pitch_finding_15_minutes': '15分钟',
                    'pitch_finding_30_minutes': '30分钟',
                    'pitch_finding_next_question': '下一题',
                    'practice_mode': '练习模式',
                    'practice_mode_hint': '选择练习类型',
                    'note_interval_practice': '音程练习',
                    'single_note_practice': '找音练习',
                    'interval_selection': '选择音程',
                    'interval_selection_hint': '选择要练习的音程',
                    'root_note_setting': '设置根音',
                    'root_note_setting_hint': '选择根音或随机',
                    'find_root_first': '先找根音',
                    'find_root_first_hint': '开启后先练习根音，再练习音程',
                    'start_practice': '开始练习',
                    
                    // 设备设置其他标签
                    'practice_settings': '练习设置',
                    'metronome_settings': '节拍器设置',
                    'time_label': '时间',
                    'fixed_delay_generation': '延迟生成下一题',
                    'background_flash': '背景闪光',
                    
                    // 通用设置其他标签
                    'settings_management': '设置管理',
                    'reset_settings_hint': '点击重置按钮将恢复所有设置为默认值',
                    'chord_name_display': '和弦名显示',
                    'chord_name_display_hint': '选择和弦名称的显示方式',
                    'chord_name_english': '英文名',
                    'chord_name_symbols': '符号名',
                    
                    // 遗漏的翻译键
                    'sound_metronome': '声音节拍',
                    'custom_chord_progression': '自定义和弦进行',
                    'song_name_placeholder': '请输入歌曲名（可选）',
                    'btn_clear_custom_chords': '清空自定义和弦进行',
                    'btn_save_custom_chords': '保存和弦进行到本地',
                    'btn_load_local_chords': '加载本地和弦进行',
                    'btn_load_sequence': '加载序列',
                    'btn_add_chord': '添加和弦',
                    'progression_order': '顺序',
                    'progression_order_hint': '选择和弦进行的演奏顺序',
                    'progression_repeat': '重复练习',
                    'progression_repeat_hint': '开启后对歌曲进行重复练习',
                    'progression_key_label': '调',
                    'progression_key_hint': '选择练习的调性',
                    'order_ordered': '顺序',
                    'order_reverse': '倒序',
                    
                    // MIDI设备
                    'midi_support': 'MIDI设备支持',
                    'midi_support_hint': '连接MIDI键盘或控制器进行练习',
                    'midi_enable': 'MIDI设备'
                },
                'en': {
                    'app_title': '🎸 Fretboard Master',
                   
                    'page_title': 'Fretboard Master',
                    'btn_start': 'Start Practice',
                    'status_ready': 'Ready',
                    'lang_zh': '中文',
                    'lang_en': 'English',
                    'nav_scale': 'Scale',
                    'nav_chord': 'Chord',
                    'nav_progression': 'Changes',
                    'nav_pitch_finding': 'Note&Interval',
                    'settings_pitch_finding': 'Note&Interval Settings',
                    'nav_settings': 'Settings',
                    'settings_scale': 'Scale Practice Options',
                    'settings_chord': 'Chord Practice Options',
                    'settings_device': 'Device Settings',
                    'settings_general': 'General Settings',
                    'general_language': 'Language Settings',
                    'interface_language': 'Interface Language',
                    'test_language_switch': 'Test Language Switch',
                    
                    // 快捷键提示
                    'shortcut_hint': 'Press ESC to return to main menu',
                    
                    // 音高显示
                    'pitch_display': 'Pitch',
                    'cents_display': 'Cents',
                    
                    // 和弦设置
                    'chord_root_note': 'Root Note',
                    'chord_root_note_hint': 'Select chord root note',
                    'chord_type': 'Chord Type',
                    'chord_type_hint': 'Select chord types to practice',
                    'chord_order': 'Order',
                    'chord_order_hint': 'Select chord note playing order',
                    'chord_custom': 'Custom Chords',
                    
                    // 和弦转位设置
                    'chord_bass_note': 'Bass Note',
                    'chord_bass_root': 'Root',
                    'chord_bass_3rd': '3rd',
                    'chord_bass_5th': '5th',
                    'chord_bass_7th': '7th',
                    'chord_bass_random': 'Random',

                    
                    // 顺序按钮
                    'order_ascending': 'Ascending',
                    'order_descending': 'Descending',
                    'order_random': 'Random',
                    
                    // 和弦类型
                    'chord_major': 'Major',
                    'chord_minor': 'Minor',
                    'chord_dim': 'Dim',
                    'chord_aug': 'Aug',
                    'chord_6': '6',
                    'chord_m6': 'm6',
                    'chord_7': '7',
                    'chord_maj7': 'Maj7',
                    'chord_m7': 'm7',
                    'chord_m7b5': 'm7♭5',
                    'chord_dim7': 'dim7',
                    'chord_9': '9',
                    'chord_maj9': 'Maj9',
                    'chord_m9': 'm9',
                    'chord_7sharp9': '7♯9',
                    'chord_7flat9': '7♭9',
                    'chord_11': '11',
                    'chord_m11': 'm11',
                    'chord_7sharp11': '7♯11',
                    'chord_13': '13',
                    'chord_m13': 'm13',
                    'chord_sus2': 'sus2',
                    'chord_sus4': 'sus4',
                    'chord_add9': 'add9',
                    'chord_madd9': 'madd9',
                    'chord_6add9': '6add9',
                    'chord_m6add9': 'm6add9',
                    'chord_diminished7': 'Diminished 7',
                    'chord_dominant9': 'Dominant 9',
                    'chord_major9': 'Major 9',
                    'chord_minor9': 'Minor 9',
                    'chord_dominant7sharp9': 'Dominant 7♯9',
                    'chord_sus2': 'Sus2',
                    'chord_sus4': 'Sus4',
                    'chord_add9': 'Add9',
                    'chord_madd9': 'mAdd9',
                    'chord_6add9': '6Add9',
                    'chord_m6add9': 'm6Add9',
                    
                    // 随机选项
                    'random': 'Random',
                    'random_root': 'Random Root',
                    'random_chord': 'Random Chord',
                    
                    // 选择器页面
                    'search_song_placeholder': 'Search song name...',
                    'select_song': 'Select Song',
                    'practice_level': 'Level',
                    'select_key': 'Select Key',
                    'key_desc': 'Key',
                    
                    // 练习等级选项
                    'single_chord_notes': 'Single Chord Notes',
                    'double_chord_notes': 'Double Chord Notes',
                    'triple_chord_notes': 'Triple Chord Notes',
                    'quad_chord_notes': 'Quad Chord Notes',
                    'all_chord_notes': 'All Chord Notes',

                    // 音程描述
                    'root_note': 'R',
                    'third_note': '3rd',
                    'fifth_note': '5th',
                    'seventh_note': '7th',
                    'root': 'Root',
                    'third': '3rd',
                    'fifth': '5th',
                    'seventh': '7th',
                    'root_third': 'R,3rd',
                    'root_fifth': 'R,5th',
                    'root_seventh': 'R,7th',
                    'third_fifth': '3rd,5th',
                    'third_seventh': '3rd,7th',
                    'root_third_fifth': 'Root Position Triad',
                    'third_fifth_seventh': '3rd,5th,7th',
                    'random_inversion': 'Random Inversion',
                    'root_third_fifth_seventh': 'Root Position 7th',
                    'first_inversion': '1st Inversion',
                    'second_inversion': '2nd Inversion',
                    'third_inversion': '3rd Inversion',
                    'with_octave_root': 'With Octave Root',
                    'all_notes': 'All Notes',
                    'all_chord_notes_desc': 'All chord notes',

                    // New option descriptions
                    'root_to_third': 'Melodic line from root to third',
                    'root_to_fifth': 'Melodic line from root to fifth',
                    'third_to_fifth': 'Melodic line from third to fifth',
                    'root_third_fifth_line': 'Root-third-fifth connection line',
                    'random_inversions': 'Random inversions progression',
                    'fifth_to_seventh': 'Melodic line from fifth to seventh',
                    'seventh_to_ninth': 'Melodic line from seventh to ninth',
                    'fifth_to_ninth': 'Melodic line from fifth to ninth',
                    'fifth_seventh_ninth_line': 'Fifth-seventh-ninth connection line',
                    'stepwise_voice_leading': 'Stepwise voice leading',
                    'common_tone_voice_leading': 'Common tone voice leading',
                    'contrary_motion_voice_leading': 'Contrary motion voice leading',
                    'parallel_motion_voice_leading': 'Parallel motion voice leading',
                    'sus4_to_sus2': 'Sus4 suspension to Sus2 suspension',
                    'sus4_to_third': 'Sus4 suspension resolves to third',
                    'sus2_to_third': 'Sus2 suspension resolves to third',
                    'suspension_resolution_chain': 'Suspension resolution chain',
                    'triadic_chord_scales': 'Triad-based chord scales',
                    'seventh_chord_scales': 'Seventh chord-based scales',
                    'extended_chord_scales': 'Extended chord-based scales',
                    'modal_chord_scales': 'Modal chord scales',
                    'diatonic_passing_tones': 'Diatonic passing tones',
                    'chromatic_passing_tones': 'Chromatic passing tones',
                    'enclosure_passing_tones': 'Enclosure passing techniques',
                    'appoggiatura_passing_tones': 'Appoggiatura passing techniques',
                    'random_scale': 'Random Mode',
                    
                    // 自定义和弦进行页面
                    'custom_chord_title': 'Custom Chord Progression',
                    'custom_chord_root': 'Root Note',
                    'custom_chord_type': 'Chord Type',
                    'custom_chord_inversion': 'Inversion',
                    'custom_chord_bass_root': 'Root',
                    'custom_chord_bass_3rd': '3rd',
                    'custom_chord_bass_5th': '5th',
                    'custom_chord_bass_7th': '7th',
                    'custom_chord_add': 'Add Chord',
                    'custom_chord_sequence_name': 'Enter song name...',
                    'custom_chord_clear': 'Clear',
                    'custom_chord_save': 'Save',
                    'custom_chord_load': 'Load',
                    'custom_chord_load_practice': 'Load Practice',
                    'btn_custom_chords': 'Custom Chord Progression',
                    
                    // 音阶设置
                    'scale_key': 'Key',
                    'scale_mode': 'Mode',
                    'scale_direction': 'Direction',
                    'scale_practice_sequence': 'Practice Sequence',
                    'scale_order': 'Playing Order',
                    
                    // 设备设置
                    'device_audio_input': 'Audio Input Device',
                    'device_gain': 'Input Gain',
                    'device_metronome': 'Metronome',
                    'device_tempo': 'Tempo',
                    'device_sensitivity': 'Sensitivity',
                    'device_cooldown': 'Cooldown Time',
                    'device_confidence': 'Confidence Threshold',
                    'device_noise': 'Noise Level',
                    'device_volume': 'Minimum Volume',
                    'device_buffer': 'Buffer Size',
                    'device_harmonic': 'Harmonic Weights',
                    'device_zero_crossing': 'Zero Crossing Threshold',
                    
                    // 通用设置
                    'general_language': 'Language Settings',
                    'interface_language': 'Interface Language',
                    
                    // 按钮和操作
                    'btn_save': 'Save Settings',
                    'btn_reset': 'Reset Settings',
                    'btn_refresh': 'Refresh Device List',
                    'btn_back': 'Back to Main Menu',
                    'btn_cancel': 'Cancel',
                    'btn_confirm': 'Confirm',

                    // 调式选择控制按钮
                    'select_all': 'Select All',
                    'deselect_all': 'Deselect All',
                    'random_select': 'Random Select',
                    'btn_delete': 'Delete',
                    'btn_edit': 'Edit',
                    'btn_add': 'Add',
                    'btn_clear': 'Clear',
                    
                    // 状态信息
                    'status_recording': 'Recording',
                    'status_processing': 'Processing',
                    'status_error': 'Error',
                    'status_success': 'Success',
                    
                    // 错误信息
                    'error_no_audio_support': 'Your browser does not support audio API',
                    'error_microphone_permission': 'Cannot get microphone permission',
                    'error_audio_device': 'Audio device initialization failed',
                    'error_pitch_detection': 'Pitch detection failed',
                    
                    // 提示信息
                    'hint_select_device': 'Please select an audio input device',
                    'hint_connect_guitar': 'Please connect your guitar',
                    'hint_start_practice': 'Click start practice button to begin',
                    'hint_select_chord_type': 'Please select at least one chord type',
                    'hint_select_scale': 'Please select a scale type',
                    
                    // 练习相关
                    'practice_scale': 'Scale Practice',
                    'practice_chord': 'Chord Practice',
                    'practice_progression': 'Changes Practice',
                    'practice_arpeggio': 'Arpeggio Practice',
                    'practice_interval': 'Interval Practice',
                    
                    // 音阶类型
                    'scale_major': 'Major',
                    'scale_minor': 'Minor',
                    'scale_dorian': 'Dorian',
                    'scale_phrygian': 'Phrygian',
                    'scale_lydian': 'Lydian',
                    'scale_mixolydian': 'Mixolydian',
                    'scale_locrian': 'Locrian',
                    'scale_harmonic_minor': 'Harmonic Minor',
                    'scale_melodic_minor': 'Melodic Minor',
                    'scale_pentatonic_major': 'Major Pentatonic',
                    'scale_pentatonic_minor': 'Minor Pentatonic',
                    'scale_blues': 'Blues Scale',
                    
                    // 和弦转换设置
                    'progression_settings': 'Progression Settings',
                    'progression_level': 'Practice Level',
                    'progression_level_hint': 'Select chord complexity',
                    'single_chord_notes': 'Single Chord Notes',
                    'double_chord_notes': 'Double Chord Notes',
                    'triple_chord_notes': 'Triple Chord Notes',
                    'quad_chord_notes': 'Quad Chord Notes',
                    'progression_key': 'Tunes',
                    'progression_key_hint': 'Select a Tune',
                    'progression_tunes': 'Tunes',
                    'progression_tunes_hint': 'Select practice tunes',
                    'progression_style': 'Style',
                    'progression_style_hint': 'Select practice style',
                    'progression_tempo': 'Tempo',
                    'progression_tempo_hint': 'Set practice tempo',
                    'progression_difficulty': 'Difficulty',
                    'progression_difficulty_hint': 'Select practice difficulty',
                    
                    // 音阶设置详细
                    'scale_root_note': 'Key',
                    'scale_root_note_hint': 'Select key',
                    'scale_type': 'Mode',
                    'scale_type_hint': 'Select mode',
                    'scale_direction_hint': 'Select playing direction',
                    'scale_practice_sequence_hint': 'Select practice sequence',
                    'scale_arpeggio': 'Arpeggio',
                    'scale_arpeggio_hint': 'Select arpeggio type',
                    'scale_interval': 'Interval',
                    'scale_interval_hint': 'Select interval practice',
                    'scale_random': 'Random',
                    'scale_random_hint': 'Generate random practice',
                    
                    // 设备设置详细
                    'device_audio_input_hint': 'Select audio input device',
                    'device_gain_hint': 'Adjust input gain',
                    'device_metronome_hint': 'Enable metronome',
                    'device_tempo_hint': 'Set metronome tempo',
                    'device_sensitivity_hint': 'Adjust pitch detection sensitivity',
                    'device_cooldown_hint': 'Set cooldown time',
                    'device_confidence_hint': 'Set confidence threshold',
                    'device_noise_hint': 'Set noise level',
                    'device_volume_hint': 'Set minimum volume',
                    'device_buffer_hint': 'Set buffer size',
                    'device_harmonic_hint': 'Set harmonic weights',
                    'device_zero_crossing_hint': 'Set zero crossing threshold',
                    
                    // 通用设置详细
                    'general_language_hint': 'Select interface language',
                    'interface_language_hint': 'Select interface language',
                    'general_theme': 'Theme',
                    'general_theme_hint': 'Select interface theme',
                    'theme_dark': 'Dark Theme',
                    'theme_light': 'Light Theme',
                    'theme_auto': 'Follow System',
                    'general_sound': 'Sound',
                    'general_sound_hint': 'Set sound options',
                    'general_display': 'Display',
                    'general_display_hint': 'Set display options',
                    'general_advanced': 'Advanced',
                    'general_advanced_hint': 'Advanced settings options',
                    
                    // 音阶设置optgroup标签
                    'basic_modes': 'Basic Modes',
                    'church_modes': 'Church Modes',
                    'harmonic_minor_series': 'Harmonic Minor Series',
                    'melodic_minor_series': 'Melodic Minor Series',
                    'pentatonic_scales': 'Pentatonic Scales',
                    'blues_scales': 'Blues Scales',
                    'special_scales': 'Special Scales',
                    'exotic_scales': 'Exotic Scales',
                    
                    // 和弦转换设置optgroup标签
                    'single_chord_notes': 'Single Chord Notes',
                    'double_chord_notes': 'Double Chord Notes',
                    'triple_chord_notes': 'Triple Chord Notes',
                    'quad_chord_notes': 'Quad Chord Notes',
                    
                    // 和弦转换设置选项
                    'single_chord_tones': 'Single Chord Tones',
                    'two_chord_tones': 'Two Chord Tones',
                    'three_chord_tones': 'Three Chord Tones',
                    'four_chord_tones': 'Four Chord Tones',
                    'random_inversions_135': '1,3,5 Random Inversions',
                    'random_inversions_1357': '1357 Random Inversions',
                    'all_chord_tones': 'All Chord Tones',
                    'all': 'All',
                    
                    // 找音练习设置
                    'pitch_finding_practice_time': 'Practice Time',
                    'pitch_finding_practice_time_hint': 'Select practice duration',
                    'pitch_finding_show_fretboard': 'Show Fretboard',
                    'pitch_finding_show_fretboard_hint': 'Display note positions on fretboard when correct pitch is detected',
                    'fretboard_keyboard_hint': '💡 ↓Hide ↑Show Space Next',
                    'pitch_finding_fretboard_range': 'Fretboard Range',
                    'pitch_finding_fretboard_range_hint': 'Select fretboard display range',
                    'pitch_finding_12_frets': '12 Frets',
                    'pitch_finding_15_frets': '15 Frets',
                    'pitch_finding_18_frets': '18 Frets',
                    'pitch_finding_24_frets': '24 Frets',
                    'pitch_finding_current_note': 'Current Note',
                    'pitch_finding_time_remaining': 'Time Remaining',
                    'pitch_finding_practice_complete': 'Practice Complete',
                    'pitch_finding_next_interval': 'Next Question Interval',
                    'pitch_finding_next_interval_hint': 'Time interval before automatically moving to next question after correct answer',
                    'pitch_finding_no_auto': 'Manual',
                    'pitch_finding_2_seconds': '2 Seconds',
                    'pitch_finding_3_seconds': '3 Seconds',
                    'pitch_finding_5_seconds': '5 Seconds',
                    'pitch_finding_1_minute': '1 Minute',
                    'pitch_finding_2_minutes': '2 Minutes',
                    'pitch_finding_3_minutes': '3 Minutes',
                    'pitch_finding_5_minutes': '5 Minutes',
                    'pitch_finding_10_minutes': '10 Minutes',
                    'pitch_finding_15_minutes': '15 Minutes',
                    'pitch_finding_30_minutes': '30 Minutes',
                    'pitch_finding_next_question': 'Next',
                    'practice_mode': 'Practice Mode',
                    'practice_mode_hint': 'Select practice type',
                    'note_interval_practice': 'Interval Practice',
                    'single_note_practice': 'Single Note Practice',
                    'interval_selection': 'Select Intervals',
                    'interval_selection_hint': 'Select intervals to practice',
                    'root_note_setting': 'Root Note Setting',
                    'root_note_setting_hint': 'Choose root note or random',
                    'find_root_first': 'Find Root First',
                    'find_root_first_hint': 'Practice root note first, then intervals',
                    'start_practice': 'Start Practice',
                    
                    // 设备设置其他标签
                    'practice_settings': 'Practice Settings',
                    'metronome_settings': 'Metronome Settings',
                    'time_label': 'Time',
                    'fixed_delay_generation': 'Fixed Delay Generation',
                    'background_flash': 'Background Flash',
                    
                    // 通用设置其他标签
                    'settings_management': 'Settings Management',
                    'reset_settings_hint': 'Click reset button to restore all settings to default values',
                    'chord_name_display': 'Chord Name Display',
                    'chord_name_display_hint': 'Select chord name display format',
                    'chord_name_english': 'English',
                    'chord_name_symbols': 'Symbols',
                    
                    // 遗漏的翻译键
                    'sound_metronome': 'Sound Metronome',
                    'custom_chord_progression': 'Custom Changes',
                    'song_name_placeholder': 'Enter song name (optional)',
                    'btn_clear_custom_chords': 'Clear Custom Changes',
                    'btn_save_custom_chords': 'Save Changes to Local',
                    'btn_load_local_chords': 'Load Local Changes',
                    'btn_load_sequence': 'Load Sequence',
                    'btn_add_chord': 'Add Chord',
                    'progression_order': 'Order',
                    'progression_order_hint': 'Select chord progression playing order',
                    'progression_repeat': 'Repeat Practice',
                    'progression_repeat_hint': 'Enable to repeat the song for practice',
                    'progression_key_label': 'Key',
                    'progression_key_hint': 'Select practice key',
                    'order_ordered': 'Ordered',
                    'order_reverse': 'Reverse',
                    'device_count_detected': '{count} Audio Input Devices',
                    'device_count_none': 'No Audio Input Devices Detected',
                    'default_device': 'Default Device',
                    'audio_device': 'Audio Device',
                    'key_c_default': 'C Default',
                    
                    // CAGED Practice Settings
                    'caged_practice': 'CAGED Practice',
                    'caged_practice_hint': 'Scale and chord practice based on CAGED system',
                    'caged_practice_mode': 'CAGED Practice Mode',
                    'caged_shape': 'CAGED Shape',
                    'caged_shape_hint': 'Select CAGED shape to practice',
                    'caged_key': 'Key',
                    'caged_key_hint': 'Select practice key',
                    'caged_mode': 'Practice Mode',
                    'caged_mode_hint': 'Select CAGED practice mode',
                    'caged_shape_connection': 'Shape Connection',
                    'caged_random_shapes': 'Random Shapes',
                    'caged_show_fretboard': 'Show Fretboard',
                    'caged_show_fingering': 'Show Fingering',
                    'caged_show_scale': 'Show Scale',
                    'caged_c_shape': 'C Shape',
                    'caged_a_shape': 'A Shape',
                    'caged_g_shape': 'G Shape',
                    'caged_e_shape': 'E Shape',
                    'caged_d_shape': 'D Shape',
                    'midi_support': 'MIDI Device Support',
                    'midi_support_hint': 'Connect MIDI keyboard or controller for practice',
                    'midi_enable': 'MIDI Device',
                    'midi_device_connected': 'MIDI device connected',
                    'midi_device_disconnected': 'MIDI device disconnected',
                    'midi_device_detected': 'Detected {count} MIDI devices',
                    'midi_device_none': 'No MIDI devices detected',

                    // 歌曲信息相关
                    'basic_info': 'Basic Information',
                    'song_composer': 'Composer:',
                    'song_year': 'Year:',
                    'song_style': 'Style:',
                    'song_tempo': 'Tempo:',
                    'song_key': 'Original Key:',
                    'song_description': 'Song Description',
                    'select_this_song': 'Select This Song',
                    'unknown': 'Unknown',
                    'jazz_standard': 'Jazz Standard',
                    'chord_progression': 'Chord Progression',

                    // 和弦练习分组
                    'chord_single_notes': 'Single Chord Notes',
                    'chord_double_notes': 'Double Chord Notes',
                    'chord_triple_notes': 'Triple Chord Notes',
                    'chord_quad_notes': 'Quad Chord Notes',
                    'chord_all_notes': 'All Chord Notes',

                    // New practice groups
                    'melodic_structure_r_to_5th': 'Melodic Structure - R→5th',
                    'melodic_structure_5th_to_9th': 'Melodic Structure - 5th→9th',
                    'voice_led_structure': 'Voice Leading Structure',
                    'suspension_structure': 'Suspension Structure',
                    'chord_scale_structure': 'Chord Scale Structure',
                    'passing_tone_structure': 'Passing Tones Structure',

                    // 键盘操作提示
                    'keyboard_hide': 'Hide',
                    'keyboard_show': 'Show',
                    'keyboard_space': 'Space',
                    'keyboard_next': 'Next',

                    // 麦克风权限相关
                    'mic_permission_denied': 'Microphone Permission Denied',
                    'mic_permission_needed': 'This app needs microphone permission to detect pitch.',
                    'mic_permission_steps': 'Please follow these steps:',
                    'mic_step_1': 'Click the lock/info icon on the left side of the browser address bar',
                    'mic_step_2': 'Find "Microphone" option in the popup menu',
                    'mic_step_3': 'Set it to "Allow"',
                    'mic_step_4': 'Refresh the page and try again',
                    'refresh_page': 'Refresh Page',
                    'return_to_main': 'Return to Main Menu'
                }
            };
            
            // CAGED系统数据结构
            const cagedSystem = {
                shapes: {
                    'C': {
                        name: 'C Shape',
                        rootString: 5,
                        rootFret: 3,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 5, fret: 3, finger: 1, interval: '1' }, // C
                            { string: 4, fret: 2, finger: 2, interval: '2' }, // D
                            { string: 3, fret: 0, finger: 1, interval: '3' }, // E
                            { string: 2, fret: 1, finger: 2, interval: '4' }, // F
                            { string: 1, fret: 0, finger: 1, interval: '5' }, // G
                            { string: 0, fret: 1, finger: 2, interval: '6' }  // A
                        ]
                    },
                    'A': {
                        name: 'A Shape',
                        rootString: 5,
                        rootFret: 5,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 5, fret: 5, finger: 1, interval: '1' }, // A
                            { string: 4, fret: 5, finger: 1, interval: '2' }, // B
                            { string: 3, fret: 5, finger: 1, interval: '3' }, // C
                            { string: 2, fret: 5, finger: 1, interval: '4' }, // D
                            { string: 1, fret: 5, finger: 1, interval: '5' }, // E
                            { string: 0, fret: 5, finger: 1, interval: '6' }  // F
                        ]
                    },
                    'G': {
                        name: 'G Shape',
                        rootString: 6,
                        rootFret: 3,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 6, fret: 3, finger: 1, interval: '1' }, // G
                            { string: 5, fret: 0, finger: 1, interval: '2' }, // A
                            { string: 4, fret: 0, finger: 1, interval: '3' }, // B
                            { string: 3, fret: 0, finger: 1, interval: '4' }, // C
                            { string: 2, fret: 0, finger: 1, interval: '5' }, // D
                            { string: 1, fret: 0, finger: 1, interval: '6' }  // E
                        ]
                    },
                    'E': {
                        name: 'E Shape',
                        rootString: 6,
                        rootFret: 0,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 6, fret: 0, finger: 1, interval: '1' }, // E
                            { string: 5, fret: 0, finger: 1, interval: '2' }, // F
                            { string: 4, fret: 2, finger: 2, interval: '3' }, // G
                            { string: 3, fret: 2, finger: 2, interval: '4' }, // A
                            { string: 2, fret: 2, finger: 2, interval: '5' }, // B
                            { string: 1, fret: 0, finger: 1, interval: '6' }  // C
                        ]
                    },
                    'D': {
                        name: 'D Shape',
                        rootString: 4,
                        rootFret: 0,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 4, fret: 0, finger: 1, interval: '1' }, // D
                            { string: 3, fret: 2, finger: 2, interval: '2' }, // E
                            { string: 2, fret: 2, finger: 2, interval: '3' }, // F
                            { string: 1, fret: 0, finger: 1, interval: '4' }, // G
                            { string: 0, fret: 0, finger: 1, interval: '5' }, // A
                            { string: 0, fret: 2, finger: 2, interval: '6' }  // B
                        ]
                    }
                },
                keys: ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'],
                practiceTypes: ['scale', 'chord'],
                modes: ['single', 'connection', 'random']
            };

            // CAGED练习状态
            let cagedState = {
                enabled: false,
                practiceType: 'scale', // 固定为音阶练习
                selectedShapes: ['C', 'A', 'G', 'E', 'D'], // 默认全部选中
                currentKey: 'C',
                practiceMode: 'connection', // 默认为形状连接
                currentShape: 'C',
                currentExercise: null,
                currentScaleType: null, // 当前练习的音阶类型（用于保持一致性）
                currentRootNote: null, // 当前练习的根音（用于保持一致性）
                isManualSwitch: false, // 标记是否为手动切换形状
                completedShapesInCurrentRound: [], // 当前轮次中已完成的形状
                isNewRound: true // 标记是否开始新一轮练习
            };

            // CAGED和弦练习状态
            let cagedChordState = {
                enabled: false,
                practiceType: 'chord', // 固定为和弦练习
                selectedShapes: ['C', 'A', 'G', 'E', 'D'], // 默认全部选中
                currentKey: 'C',
                practiceMode: 'connection', // 默认为形状连接
                currentShape: 'C',
                currentExercise: null,
                currentChordType: null, // 当前练习的和弦类型（用于保持一致性）
                currentRootNote: null, // 当前练习的根音（用于保持一致性）
                isManualSwitch: false, // 标记是否为手动切换形状
                completedShapesInCurrentRound: [], // 当前轮次中已完成的形状
                isNewRound: true // 标记是否开始新一轮练习
            };
            
            // 将cagedState、cagedSystem、cagedChordState暴露到全局作用域
            window.cagedState = cagedState;
            window.cagedSystem = cagedSystem;
            window.cagedChordState = cagedChordState;

            // MIDI设备状态
            let midiState = {
                enabled: false,
                devices: [],
                currentDevice: null,
                midiAccess: null,
                lastNote: null,
                lastVelocity: 0,
                lastTimestamp: 0,
                errorCount: 0,
                maxErrors: 5,
                isConnected: false
            };
            
            // 将midiState暴露到全局作用域
            window.midiState = midiState;

            // MIDI设备检测和处理
            async function initializeMIDI() {
                try {
                    // 检查浏览器是否支持Web MIDI API
                    if (!navigator.requestMIDIAccess) {
                        console.log('浏览器不支持Web MIDI API');
                        updateMIDIStatus('浏览器不支持MIDI功能', false);
                        return false;
                    }

                    // 请求MIDI访问权限
                    const midiAccess = await navigator.requestMIDIAccess({ sysex: false });
                    window.midiState.midiAccess = midiAccess;
                    window.midiState.errorCount = 0; // 重置错误计数

                    // 监听MIDI设备连接/断开
                    midiAccess.onstatechange = handleMIDIStateChange;

                    // 获取已连接的设备
                    updateMIDIDevices();

                    console.log('MIDI初始化成功');
                    return true;
                } catch (error) {
                    console.error('MIDI初始化失败:', error);
                    window.midiState.errorCount++;

                    let errorMessage = 'MIDI初始化失败';
                    if (error.name === 'SecurityError') {
                        errorMessage = 'MIDI权限被拒绝，请检查浏览器设置';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'MIDI设备访问被中断';
                    } else if (error.name === 'InvalidStateError') {
                        errorMessage = 'MIDI设备状态无效';
                    }

                    updateMIDIStatus(errorMessage, false);

                    // 尝试自动重连
                    if (window.midiState.errorCount < window.midiState.maxErrors) {
                        console.log(`尝试重新连接MIDI设备 (${window.midiState.errorCount}/${window.midiState.maxErrors})`);
                        setTimeout(() => {
                            if (window.midiState.enabled) {
                                initializeMIDI();
                            }
                        }, 2000 * window.midiState.errorCount); // 递增延迟
                    }

                    return false;
                }
            }

            // 将MIDI函数暴露到全局作用域
            window.initializeMIDI = initializeMIDI;

            // 处理MIDI设备状态变化
            function handleMIDIStateChange(event) {
                console.log('MIDI设备状态变化:', event.port.name, event.port.state);
                updateMIDIDevices();
            }

            // 更新MIDI设备列表
            function updateMIDIDevices() {
                if (!window.midiState.midiAccess) return;

                const devices = [];
                let connectedCount = 0;

                for (const input of window.midiState.midiAccess.inputs.values()) {
                    if (input.state === 'connected') {
                        const device = {
                            id: input.id,
                            name: input.name,
                            manufacturer: input.manufacturer,
                            state: input.state,
                            connection: input.connection,
                            input: input
                        };
                        devices.push(device);
                        connectedCount++;
                    }
                }

                window.midiState.devices = devices;
                window.midiState.isConnected = connectedCount > 0;

                displayMIDIDevices();
                updateMIDIConnectionStatus(connectedCount);
            }

            // 更新MIDI连接状态
            function updateMIDIConnectionStatus(connectedCount) {
                const deviceStatus = document.getElementById('midiDeviceStatus');
                if (!deviceStatus) return;

                if (connectedCount > 0) {
                    deviceStatus.textContent = `已连接 ${connectedCount} 个MIDI设备`;
                    deviceStatus.className = 'midi-device-status connected';
                } else {
                    deviceStatus.textContent = '未检测到MIDI设备';
                    deviceStatus.className = 'midi-device-status disconnected';
                }
            }

            // 显示MIDI设备信息
            function displayMIDIDevices() {
                const deviceInfo = document.getElementById('midiDeviceInfo');
                const deviceStatus = document.getElementById('midiDeviceStatus');
                const deviceList = document.getElementById('midiDeviceList');
                
                if (!deviceInfo || !deviceStatus || !deviceList) return;
                
                if (window.midiState.devices.length > 0) {
                    deviceStatus.textContent = `检测到 ${window.midiState.devices.length} 个MIDI设备`;
                    deviceInfo.style.display = 'block';
                    
                    // 显示设备列表
                    deviceList.innerHTML = '';
                    window.midiState.devices.forEach(device => {
                        const deviceItem = document.createElement('div');
                        deviceItem.className = 'midi-device-item';
                        deviceItem.textContent = `${device.name} (${device.manufacturer})`;
                        deviceList.appendChild(deviceItem);
                    });
                } else {
                    deviceStatus.textContent = '未检测到MIDI设备';
                    deviceInfo.style.display = 'none';
                }
            }

            // 更新MIDI状态显示
            function updateMIDIStatus(message, connected) {
                const deviceStatus = document.getElementById('midiDeviceStatus');
                if (deviceStatus) {
                    deviceStatus.textContent = message;
                    deviceStatus.style.color = connected ? '#10b981' : '#ef4444';
                }
            }

            // 处理MIDI输入
            function handleMIDIInput(event) {
                if (!window.midiState.enabled) return;

                // 处理所有MIDI通道的Note On事件
                const command = event.data[0] & 0xF0; // 提取命令部分
                const noteNumber = event.data[1];
                const velocity = event.data[2];

                // 只处理Note On消息 (0x90)
                if (command === 0x90 && velocity > 0) {
                    // 设置最小力度阈值，避免误触发
                    const minVelocity = 10; // 最小力度阈值
                    if (velocity < minVelocity) return;

                    // 将MIDI音符号转换为音符名称
                    const noteName = midiToNoteName(noteNumber);

                    console.log('MIDI输入:', noteName, '力度:', velocity);

                    // 更新MIDI状态
                    window.midiState.lastNote = noteName;
                    window.midiState.lastVelocity = velocity;
                    window.midiState.lastTimestamp = Date.now();

                    // 显示MIDI输入反馈
                    showMIDIInputFeedback(noteName, velocity);

                    // 处理音符检测
                    processMIDINote(noteName);
                }
            }

            // 显示MIDI输入反馈
            function showMIDIInputFeedback(noteName, velocity) {
                // 创建或更新MIDI反馈显示元素
                let feedbackEl = document.getElementById('midiInputFeedback');
                if (!feedbackEl) {
                    feedbackEl = document.createElement('div');
                    feedbackEl.id = 'midiInputFeedback';
                    feedbackEl.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(58, 159, 196, 0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-size: 18px;
                        font-weight: bold;
                        z-index: 10001;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    `;
                    document.body.appendChild(feedbackEl);
                }

                // 更新显示内容
                const noteWithoutOctave = noteName.replace(/\d+$/, '');
                feedbackEl.textContent = `♪ ${noteWithoutOctave}`;

                // 根据力度调整透明度和大小
                const opacity = Math.min(1, 0.5 + (velocity / 127) * 0.5);
                const scale = 1 + (velocity / 127) * 0.2;
                feedbackEl.style.opacity = opacity;
                feedbackEl.style.transform = `scale(${scale})`;

                // 短暂显示后淡出
                feedbackEl.style.display = 'block';
                clearTimeout(window.midiState.feedbackTimeout);
                window.midiState.feedbackTimeout = setTimeout(() => {
                    feedbackEl.style.opacity = '0';
                    setTimeout(() => {
                        feedbackEl.style.display = 'none';
                    }, 300);
                }, 800);
            }

            // MIDI音符号转换为音符名称
            function midiToNoteName(midiNumber) {
                const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];
                const octave = Math.floor(midiNumber / 12) - 1;
                const noteIndex = midiNumber % 12;
                return noteNames[noteIndex] + octave;
            }

            // 判断两个音符是否等价（考虑升号和降号）
            function isEquivalentNote(note1, note2) {
                if (note1 === note2) return true;

                // 定义等价的音符对
                const equivalentPairs = [
                    ['C♯', 'D♭'], ['D♯', 'E♭'], ['F♯', 'G♭'],
                    ['G♯', 'A♭'], ['A♯', 'B♭']
                ];

                for (const pair of equivalentPairs) {
                    if ((note1 === pair[0] && note2 === pair[1]) ||
                        (note1 === pair[1] && note2 === pair[0])) {
                        return true;
                    }
                }

                return false;
            }

            // 音级到半音数的映射
            const intervalToSemitones = {
                '1': 0, '♭2': 1, '2': 2, '♯2': 3, '♭3': 3, '3': 4, '4': 5,
                '♯4': 6, '♭5': 6, '5': 7, '♯5': 8, '♭6': 8, '6': 9, '♯6': 10,
                '♭7': 10, '7': 11, '♭♭7': 10,
                // 复合音程映射（9=2, 11=4, 13=6）
                '♭9': 1, '9': 2, '♯9': 3,
                '11': 4, '♯11': 6,
                '♭13': 8, '13': 9
            };

            // 音符到半音数的映射
            const noteToSemitones = {
                'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4,
                'F': 5, 'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8,
                'A': 9, 'A♯': 10, 'B♭': 10, 'B': 11
            };

            // 半音数到音符的映射
            const semitonesToNoteName = {
                0: 'C', 1: 'C♯', 2: 'D', 3: 'D♯', 4: 'E', 5: 'F',
                6: 'F♯', 7: 'G', 8: 'G♯', 9: 'A', 10: 'A♯', 11: 'B'
            };

            // 更新正确答案显示
            function updateCorrectAnswerDisplay() {
                // 这个函数应该已经在原代码中定义
                if (typeof window.updateCorrectAnswerDisplay === 'function') {
                    window.updateCorrectAnswerDisplay();
                }
            }

            // 处理MIDI音符检测
            function processMIDINote(noteName) {
                // 提取音符名称（去掉八度）
                const note = noteName.replace(/\d+$/, '');

                console.log('MIDI路由处理: 音符=' + note +
                    ', pitchFindingMode=' + (window.state ? window.state.pitchFindingMode : 'undefined') +
                    ', currentIntervalExercise=' + (window.state && window.state.currentIntervalExercise ? 'true' : 'false') +
                    ', currentSequence=' + (window.state && window.state.currentSequence ? `[${window.state.currentSequence.join(', ')}]` : 'undefined') +
                    ', currentNote=' + (window.state ? window.state.currentNote : 'undefined'));

                // 根据当前练习模式处理音符 - 与processAudio相同的路由逻辑
                if (window.cagedState && window.cagedState.enabled && window.cagedState.practiceMode) {
                    console.log('MIDI路由: 转到CAGED练习处理');
                    processCagedMIDINote(note);
                } else if (window.state && window.state.pitchFindingMode) {
                    // 找音练习模式（优先级高于音程练习）
                    console.log('MIDI路由: 转到找音练习处理');
                    processPitchFindingMIDINote(note);
                } else if (window.state && window.state.currentIntervalExercise) {
                    // 音程练习模式
                    console.log('MIDI路由: 转到音程练习处理');
                    processIntervalExerciseMIDINote(note);
                } else if (window.state && window.state.currentSequence && window.state.currentSequence.length > 0) {
                    // 序列练习模式 - 明确检查序列练习状态
                    console.log('MIDI路由: 转到序列练习处理');
                    processSequenceMIDINote(note);
                } else if (window.state && window.state.currentNote) {
                    // 常规音高练习模式
                    console.log('MIDI路由: 转到常规音高练习处理');
                    processPitchFindingMIDINote(note);
                } else {
                    // 其他模式
                    console.log('MIDI路由: 转到其他模式处理');
                    processRegularMIDINote(note);
                }
            }

            // CAGED练习的MIDI处理
            function processCagedMIDINote(note) {
                const currentShape = window.cagedSystem.shapes[window.cagedState.currentShape];
                const rootNote = window.cagedState.currentKey;
                
                if (checkCagedMatch(note, rootNote, currentShape)) {
                    handleCagedCorrect();
                }
            }

            // 找音练习的MIDI处理
            function processPitchFindingMIDINote(note) {
                console.log('找音练习MIDI处理:', note);
                if (!window.state) return;

                const targetNote = window.state.currentNote;
                if (!targetNote) return;

                console.log('目标音符:', targetNote, '找音模式:', window.state.pitchFindingMode);

                // 检查是否在找音练习模式且已经答对了
                if (window.state.pitchFindingAnswered) return;

                // 检查是否在常规练习模式且已经答对了
                if (window.state.isAnswered) return;

                if (isEquivalentNote(note, targetNote)) {
                    console.log(`找音练习: 音符 ${note} 匹配目标音符 ${targetNote}`);
                    if (window.state.pitchFindingMode) {
                        // 找音练习模式：直接调用主要的handlePitchFindingCorrect函数
                        console.log('找音练习MIDI: 调用handlePitchFindingCorrect');
                        if (typeof handlePitchFindingCorrect === 'function') {
                            handlePitchFindingCorrect();
                        } else if (typeof window.handlePitchFindingCorrect === 'function') {
                            window.handlePitchFindingCorrect();
                        } else {
                            console.error('找音练习MIDI: handlePitchFindingCorrect函数不可用');
                        }
                    } else {
                        // 常规练习模式：执行本地版本的handleCorrectAnswer逻辑
                        console.log('找音练习MIDI: 执行本地handleCorrectAnswer');
                        if (window.state) {
                            window.state.correctCount++;
                            window.state.currentStep++;
                            const justDone = window.state.currentStep - 1;

                            const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                            if (el) {
                                el.classList.remove('current');
                                el.classList.add('played');
                                console.log('找音练习MIDI: 已标记音级为已播放', justDone);
                            }

                            // 检查是否完成整个序列
                            if (window.state.currentStep >= window.state.currentSequence.length) {
                                window.state.isAnswered = true;
                                console.log('找音练习MIDI: 序列完成');

                                // 延迟生成下一题
                                setTimeout(() => {
                                    console.log('找音练习MIDI: 尝试生成下一题');

                                    // 重置必要的状态以便生成新题目
                                    if (window.state) {
                                        window.state.isAnswered = false;
                                        window.state.currentStep = 0;
                                        console.log('找音练习MIDI: 已重置状态');
                                    }

                                    try {
                                        if (typeof window.generateExercise === 'function') {
                                            window.generateExercise();
                                        } else if (typeof generateExercise === 'function') {
                                            generateExercise();
                                        } else {
                                            console.error('找音练习MIDI: generateExercise函数不可用');
                                            // 尝试手动触发开始按钮
                                            const startBtn = document.getElementById('startBtn');
                                            if (startBtn && !window.state.isRecording) {
                                                console.log('找音练习MIDI: 尝试点击开始按钮');
                                                startBtn.click();
                                            }
                                        }
                                    } catch (error) {
                                        console.error('找音练习MIDI: 生成下一题时出错:', error);
                                    }
                                }, 1000);
                            } else {
                                // 标记下一个音级为当前
                                const next = document.querySelector(`.sequence-item[data-index="${window.state.currentStep}"]`);
                                if (next) {
                                    next.classList.add('current');
                                    console.log('找音练习MIDI: 已标记下一个音级为当前', window.state.currentStep);
                                }
                            }
                        }
                    }
                }
            }

            // 常规练习的MIDI处理
            function processRegularMIDINote(note) {
                // 检查是否在音程练习模式
                if (window.state && window.state.currentIntervalExercise) {
                    processIntervalExerciseMIDINote(note);
                    return;
                }

                // 检查是否在常规音高练习模式
                if (window.state && window.state.currentNote) {
                    processPitchDetectionMIDINote(note);
                    return;
                }

                // 检查是否在自定义和弦模式
                if (window.state && window.state.isCustomChordMode) {
                    processCustomChordMIDINote(note);
                    return;
                }

        
                console.log('常规练习MIDI音符:', note);
            }

            // 音程练习的MIDI处理
            function processIntervalExerciseMIDINote(note) {
                console.log('音程练习MIDI处理:', note);
                if (!window.state || !window.state.currentIntervalExercise) return;

                const exercise = window.state.currentIntervalExercise;
                if (!exercise || exercise.answered) return;

                // 检查弹对的音符是哪个音程
                const intervals = exercise.currentInterval.split(' ');
                const rootNote = exercise.rootNote;

                console.log('检查音程:', intervals, '根音:', rootNote);

                for (const interval of intervals) {
                    if (exercise.completedIntervals && exercise.completedIntervals.includes(interval)) {
                        continue; // 跳过已经完成的音程
                    }

                    const intervalNoteValue = noteToSemitones[rootNote] + intervalToSemitones[interval];
                    const intervalNoteName = semitonesToNoteName[intervalNoteValue % 12];

                    console.log(`音程 ${interval}: 期望音符 ${intervalNoteName}, 收到音符 ${note}`);

                    if (isEquivalentNote(note, intervalNoteName)) {
                        console.log(`音程练习: 音符 ${note} 匹配音程 ${interval}`);

                        // 执行本地版本的handleIntervalPartialCorrect逻辑
                        if (window.state.currentIntervalExercise) {
                            const exercise = window.state.currentIntervalExercise;

                            // 初始化已完成的音程数组
                            if (!exercise.completedIntervals) {
                                exercise.completedIntervals = [];
                            }

                            // 检查这个音程是否已经弹对过了
                            if (exercise.completedIntervals.includes(interval)) {
                                console.log(`音程 ${interval} 已经弹对过了，忽略重复`);
                                return;
                            }

                            // 添加到已完成列表
                            exercise.completedIntervals.push(interval);
                            console.log(`音程练习: 音程 ${interval} 已标记为完成`, exercise.completedIntervals);

                            // 更新显示，将弹对的音程变灰
                            const intervalDisplay = document.getElementById('intervalExerciseDisplay');
                            if (intervalDisplay) {
                                // 查找当前题目显示元素并更新
                                const currentInterval = intervalDisplay.querySelector('.current-interval');
                                if (currentInterval) {
                                    const intervalSpans = currentInterval.querySelectorAll('span');
                                    intervalSpans.forEach(span => {
                                        if (span.textContent.trim() === interval) {
                                            span.style.opacity = '0.3';
                                            span.style.textDecoration = 'line-through';
                                        }
                                    });
                                }
                            }

                            // 检查是否所有音程都弹对了
                            const intervals = exercise.currentInterval.split(' ');
                            if (exercise.completedIntervals.length >= intervals.length) {
                                console.log('音程练习: 所有音程都弹对了，完成题目');
                                exercise.answered = true;

                                // 显示完成提示
                                const statusIndicator = document.getElementById('statusIndicator');
                                if (statusIndicator) {
                                    statusIndicator.textContent = '音程练习完成！';
                                    statusIndicator.className = 'status-indicator success';
                                    setTimeout(() => {
                                        if (window.isRecording) {
                                            statusIndicator.textContent = '录音中...';
                                            statusIndicator.className = 'status-indicator recording';
                                        }
                                    }, 1500);
                                }

                                // 获取下一题间隔时间设置
                                const intervalSecondsSelect = document.getElementById('intervalSeconds');
                                let delayTime = 2000; // 默认2秒

                                if (intervalSecondsSelect) {
                                    const intervalSeconds = parseInt(intervalSecondsSelect.value);
                                    if (intervalSeconds === 0) {
                                        delayTime = 0; // 手动模式
                                    } else {
                                        delayTime = intervalSeconds * 1000;
                                    }
                                }

                                // 检查指板是否隐藏，隐藏则立即进入下一题
                                const fretboardContainer = document.getElementById('fretboardContainer');
                                const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';

                                if (!isFretboardVisible) {
                                    delayTime = 100; // 隐藏指板时快速进入下一题
                                } else if (delayTime === 0) {
                                    // 手动模式且显示指板，不自动进入下一题
                                    console.log('音程练习MIDI: 手动模式，等待用户手动进入下一题');
                                    return;
                                }

                                // 设置定时器进入下一题
                                if (window.state.intervalNextTimeout) {
                                    clearTimeout(window.state.intervalNextTimeout);
                                }

                                window.state.intervalNextTimeout = setTimeout(() => {
                                    if (typeof generateNextIntervalExercise === 'function') {
                                        generateNextIntervalExercise();
                                    } else if (typeof window.generateNextIntervalExercise === 'function') {
                                        window.generateNextIntervalExercise();
                                    } else {
                                        console.error('音程练习MIDI: generateNextIntervalExercise函数不可用');
                                    }
                                }, delayTime);
                            }
                        }
                        break;
                    }
                }
            }

            // 音高检测练习的MIDI处理
            function processPitchDetectionMIDINote(note) {
                if (!window.state || !window.state.currentNote || window.state.isAnswered) return;

                const targetNote = window.state.currentNote;
                if (isEquivalentNote(note, targetNote)) {
                    console.log('音高检测MIDI: 音符匹配，执行本地handleCorrectAnswer');

                    // 执行本地版本的handleCorrectAnswer逻辑
                    if (window.state && window.state.currentSequence && window.state.currentSequence.length > 0) {
                        window.state.correctCount++;
                        window.state.currentStep++;
                        const justDone = window.state.currentStep - 1;

                        const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                        if (el) {
                            el.classList.remove('current');
                            el.classList.add('played');
                            console.log('音高检测MIDI: 已标记音级为已播放', justDone);
                        }

                        // 检查是否完成整个序列
                        if (window.state.currentStep >= window.state.currentSequence.length) {
                            window.state.isAnswered = true;
                            console.log('音高检测MIDI: 序列完成');

                            // 延迟生成下一题
                            setTimeout(() => {
                                console.log('音高检测MIDI: 尝试生成下一题');

                                // 重置必要的状态以便生成新题目
                                if (window.state) {
                                    window.state.isAnswered = false;
                                    window.state.currentStep = 0;
                                    console.log('音高检测MIDI: 已重置状态');
                                }

                                try {
                                    if (typeof window.generateExercise === 'function') {
                                        window.generateExercise();
                                    } else if (typeof generateExercise === 'function') {
                                        generateExercise();
                                    } else {
                                        console.error('音高检测MIDI: generateExercise函数不可用');
                                        // 尝试手动触发开始按钮
                                        const startBtn = document.getElementById('startBtn');
                                        if (startBtn && !window.state.isRecording) {
                                            console.log('音高检测MIDI: 尝试点击开始按钮');
                                            startBtn.click();
                                        }
                                    }
                                } catch (error) {
                                    console.error('音高检测MIDI: 生成下一题时出错:', error);
                                }
                            }, 1000);
                        } else {
                            // 标记下一个音级为当前
                            const next = document.querySelector(`.sequence-item[data-index="${window.state.currentStep}"]`);
                            if (next) {
                                next.classList.add('current');
                                console.log('音高检测MIDI: 已标记下一个音级为当前', window.state.currentStep);
                            }
                        }
                    }
                }
            }

            // 自定义和弦练习的MIDI处理
            function processCustomChordMIDINote(note) {
                if (!window.state || !window.state.isCustomChordMode) return;

                // 这里可以添加自定义和弦练习的MIDI处理逻辑
                console.log('自定义和弦练习MIDI音符:', note);
            }

            // 序列练习的MIDI处理
            function processSequenceMIDINote(note) {
                if (!window.state || !window.state.currentSequence || window.state.isAnswered ||
                    (window.state.enableCooldown && window.state.isCoolingDown)) return;

                if (window.state.currentStep >= window.state.currentSequence.length) return;

                const currentInterval = window.state.currentSequence[window.state.currentStep];
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error('序列练习MIDI处理: 未知的音级', currentInterval);
                    return;
                }

                // 计算当前步骤的目标音符
                const rootValue = noteToSemitones[window.state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetNote = semitonesToNoteName[targetSemitone];

                console.log(`序列练习MIDI: 当前音级=${currentInterval}, 目标音符=${targetNote}, 收到音符=${note}`);

                if (isEquivalentNote(note, targetNote)) {
                    console.log('序列练习MIDI: 音符匹配，执行本地handleCorrectAnswer');

                    // 执行本地版本的handleCorrectAnswer逻辑
                    if (window.state) {
                        window.state.correctCount++;
                        window.state.currentStep++;
                        const justDone = window.state.currentStep - 1;

                        const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                        if (el) {
                            el.classList.remove('current');
                            el.classList.add('played');
                            console.log('序列练习MIDI: 已标记音级为已播放', justDone);
                        }

                        // 检查是否完成整个序列
                        if (window.state.currentStep >= window.state.currentSequence.length) {
                            window.state.isAnswered = true;
                            console.log('序列练习MIDI: 序列完成');

                            // 根据设置决定是否进入冷却期
                            if (window.state.enableCooldown) {
                                window.state.isCoolingDown = true;
                                if (window.state.cooldownTimeout) {
                                    clearTimeout(window.state.cooldownTimeout);
                                }
                                window.state.cooldownTimeout = setTimeout(() => {
                                    window.state.isCoolingDown = false;
                                }, window.state.cooldownDuration);
                            }

                            // 根据设置决定延迟时间
                            let delayTime = 0; // 默认无延迟
                            if (window.state.enableFixedDelay) {
                                delayTime = window.state.fixedDelayDuration;
                            }

                            // 延迟生成下一题
                            setTimeout(() => {
                                console.log('序列练习MIDI: 尝试生成下一题');

                                // 重置必要的状态以便生成新题目
                                if (window.state) {
                                    window.state.isAnswered = false;
                                    window.state.currentStep = 0;
                                    console.log('序列练习MIDI: 已重置状态');
                                }

                                try {
                                    if (typeof window.generateExercise === 'function') {
                                        window.generateExercise();
                                    } else if (typeof generateExercise === 'function') {
                                        generateExercise();
                                    } else {
                                        console.error('序列练习MIDI: generateExercise函数不可用');
                                        // 尝试手动触发开始按钮
                                        const startBtn = document.getElementById('startBtn');
                                        if (startBtn && !window.state.isRecording) {
                                            console.log('序列练习MIDI: 尝试点击开始按钮');
                                            startBtn.click();
                                        }
                                    }
                                } catch (error) {
                                    console.error('序列练习MIDI: 生成下一题时出错:', error);
                                }
                            }, delayTime);
                        } else {
                            // 标记下一个音级为当前
                            const next = document.querySelector(`.sequence-item[data-index="${window.state.currentStep}"]`);
                            if (next) {
                                next.classList.add('current');
                                console.log('序列练习MIDI: 已标记下一个音级为当前', window.state.currentStep);
                            }
                        }
                    }
                }
            }

            // 获取当前音程练习的目标音符
            function getCurrentIntervalTargetNote() {
                if (!window.state || !window.state.intervalState) return null;

                const intervalState = window.state.intervalState;
                const rootNote = intervalState.rootNote;
                const interval = intervalState.currentInterval;

                if (!rootNote || !interval) return null;

                // 计算目标音符
                const rootValue = noteToSemitones[rootNote];
                const intervalSemitones = intervalToSemitones[interval];
                const targetSemitone = (rootValue + intervalSemitones) % 12;

                return semitonesToNoteName(targetSemitone);
            }

            // 连接MIDI设备
            function connectMIDIDevices() {
                if (!window.midiState.midiAccess) return;

                let connectedCount = 0;

                // 连接所有输入设备
                for (const input of window.midiState.midiAccess.inputs.values()) {
                    if (input.state === 'connected') {
                        try {
                            input.onmidimessage = handleMIDIInput;
                            connectedCount++;
                            console.log('已连接MIDI设备:', input.name, 'ID:', input.id);
                        } catch (error) {
                            console.error('连接MIDI设备失败:', input.name, error);
                        }
                    }
                }

                window.midiState.isConnected = connectedCount > 0;
                console.log(`成功连接 ${connectedCount} 个MIDI设备`);

                // 更新状态显示
                updateMIDIConnectionStatus(connectedCount);
            }

            // 断开MIDI设备
            function disconnectMIDIDevices() {
                if (!window.midiState.midiAccess) return;
                
                // 断开所有输入设备
                for (const input of window.midiState.midiAccess.inputs.values()) {
                    input.onmidimessage = null;
                    console.log('已断开MIDI设备:', input.name);
                }
            }

            // 将MIDI设备连接函数暴露到全局作用域
            window.connectMIDIDevices = connectMIDIDevices;
            window.disconnectMIDIDevices = disconnectMIDIDevices;
            function positionDropdown(menu, trigger) {
                const rect = trigger.getBoundingClientRect();
                menu.style.top = (rect.bottom + window.scrollY + 4) + 'px';
                menu.style.left = (rect.left + window.scrollX) + 'px';
                menu.style.minWidth = rect.width + 'px';
            }
                        // 初始化乐曲下拉框功能
            window.initJazzStandardDropdown = function() {
                console.log('初始化乐曲下拉列表...');
                const dropdown = document.getElementById('jazzStandardDropdown');
                
                if (!dropdown) {
                    console.error('找不到jazzStandardDropdown元素');
                    return;
                }
                
                // 检查是否已经初始化过
                if (dropdown.dataset.initialized === 'true') {
                    console.log('乐曲下拉列表已经初始化过，跳过');
                    return;
                }
                
                const trigger = dropdown.querySelector('.dropdown-trigger');
                const menu = dropdown.querySelector('.dropdown-menu');
                const nativeSelect = document.getElementById('jazzStandard');
                
                // 动态生成歌曲列表
                const jazzStandardsData = window.jazzStandards || jazzStandards;
                console.log('开始生成歌曲列表，jazzStandards对象:', jazzStandardsData);
                
                // 清空现有内容
                menu.innerHTML = '';
                
                // 按字母顺序生成分组
                const letters = Object.keys(jazzStandardsData).sort();
                console.log('找到分组:', letters);
                
                letters.forEach(letter => {
                    const group = jazzStandardsData[letter];
                    const songs = Object.keys(group).sort();
                    
                    if (songs.length > 0) {
                        // 创建分组
                        const groupLi = document.createElement('li');
                        groupLi.className = 'dropdown-group';
                        
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'group-header';
                        groupHeader.textContent = letter;
                        groupLi.appendChild(groupHeader);
                        
                        const groupItems = document.createElement('ul');
                        groupItems.className = 'group-items';
                        
                        // 添加歌曲
                        songs.forEach(songName => {
                            const songLi = document.createElement('li');
                            songLi.className = 'dropdown-item';
                            songLi.setAttribute('data-value', songName);
                            
                            const itemText = document.createElement('span');
                            itemText.className = 'item-text';
                            itemText.textContent = songName;
                            songLi.appendChild(itemText);
                            
                            const infoIcon = document.createElement('span');
                            infoIcon.className = 'info-icon';
                            infoIcon.setAttribute('data-info', songName);
                            infoIcon.textContent = 'ℹ️';
                            songLi.appendChild(infoIcon);
                            
                            groupItems.appendChild(songLi);
                        });
                        
                        groupLi.appendChild(groupItems);
                        menu.appendChild(groupLi);
                    }
                });
                
                // 重新获取动态生成的元素
                const items = dropdown.querySelectorAll('.dropdown-item');
                const infoIcons = dropdown.querySelectorAll('.info-icon');
                
                console.log('动态生成完成，找到乐曲元素:', {
                    dropdown: !!dropdown,
                    trigger: !!trigger,
                    menu: !!menu,
                    items: items.length,
                    infoIcons: infoIcons.length,
                    nativeSelect: !!nativeSelect
                });
                
                // 标记为已初始化
                dropdown.dataset.initialized = 'true';

                // 切换下拉菜单显示/隐藏
                trigger.addEventListener('click', function(e) {
                    console.log('乐曲下拉列表触发器被点击');
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = menu.classList.contains('show');
                    console.log('当前状态:', isOpen ? '打开' : '关闭');
                    
                    if (isOpen) {
                        closeJazzDropdown();
                    } else {
                        openJazzDropdown();
                    }
                });

                // 点击外部关闭下拉菜单
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        closeJazzDropdown();
                    }
                });

                // 选择选项
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        // 检查是否点击的是信息图标
                        if (e.target.classList.contains('info-icon') || e.target.closest('.info-icon')) {
                            return;
                        }
                        
                        e.stopPropagation();
                        const value = this.dataset.value;
                        const text = this.querySelector('.item-text').textContent;
                        
                        // 更新显示文本
                        dropdown.querySelector('.dropdown-text').textContent = text;
                        
                        // 更新原生select的值
                        nativeSelect.value = value;
                        
                        // 触发change事件
                        const changeEvent = new Event('change', { bubbles: true });
                        nativeSelect.dispatchEvent(changeEvent);
                        
                        // 关闭下拉菜单
                        closeJazzDropdown();
                        
                        console.log('选择了乐曲:', value);
                    });
                });

                // 信息图标点击事件 - 使用事件委托
                
                // 直接为每个信息图标绑定点击事件
                infoIcons.forEach((icon, index) => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation(); // 阻止事件进一步传播
                        const songName = this.dataset.info;
                        showSongInfo(songName);
                    });
                });
                
                // 使用事件委托作为备用方案
                menu.addEventListener('click', function(e) {
                    if (e.target.classList.contains('info-icon')) {
                        e.stopPropagation();
                        e.preventDefault();
                        const songName = e.target.dataset.info;
                        showSongInfo(songName);
                        return;
                    }
                    
                    // 检查是否点击了包含info-icon的元素
                    const infoIcon = e.target.closest('.info-icon');
                    if (infoIcon) {
                        e.stopPropagation();
                        e.preventDefault();
                        const songName = infoIcon.dataset.info;
                        showSongInfo(songName);
                        return;
                    }
                });

                function openJazzDropdown() {
                    positionDropdown(menu, trigger);
                    menu.classList.add('show');
                    trigger.classList.add('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = '▲';
                    
                    // 动态计算位置，确保不被遮挡
                    const rect = trigger.getBoundingClientRect();
                    const menuHeight = menu.offsetHeight || 300;
                    const viewportHeight = window.innerHeight;
                    
                    // 如果下方空间不够，向上展开
                    if (rect.bottom + menuHeight > viewportHeight) {
                        menu.style.top = (rect.top - menuHeight) + 'px';
                    } else {
                        menu.style.top = rect.bottom + 'px';
                    }
                    
                    menu.style.left = rect.left + 'px';
                    menu.style.width = rect.width + 'px';
                }

                function closeJazzDropdown() {
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = '▼';
                }

                // 显示歌曲信息弹窗
                window.showSongInfo = function(songName) {
                    console.log('=== showSongInfo 函数被调用 ===');
                    console.log('歌曲名称:', songName);
                    
                    // 确保可以访问jazzStandards对象
                    const jazzStandardsData = window.jazzStandards || jazzStandards;
                    console.log('jazzStandards 对象:', jazzStandardsData);
                    
                    // 获取歌曲数据
                    let songData = null;
                    for (const letter in jazzStandardsData) {
                        if (jazzStandardsData[letter][songName]) {
                            songData = jazzStandardsData[letter][songName];
                            break;
                        }
                    }
                    
                    if (!songData) {
                        console.error('找不到歌曲数据:', songName);
                        alert('找不到歌曲信息：' + songName);
                        return;
                    }
                    
                    console.log('找到歌曲数据:', songData);
                    
                    // 创建弹窗
                    const modal = document.createElement('div');
                    modal.className = 'song-info-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10001;
                    `;
                    
                    const content = document.createElement('div');
                    content.style.cssText = `
                        background: linear-gradient(135deg, #1e293b, #334155);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 500px;
                        width: 90%;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    `;
                    
                    // 构建和弦进行显示
                    let chordsDisplay;
                    if (songName.includes('练习') && songName.includes('个调')) {
                        // 练习曲目：显示详细的和弦循环信息
                        const circleOfFifthsReverse = ['A', 'D', 'G', 'C', 'F', 'B♭', 'E♭', 'A♭', 'D♭', 'G♭', 'B', 'E'];

                        if (songName.includes('Maj7') && !songName.includes('#11') && !songName.includes('#5')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}Maj7`).join(' → ');
                        } else if (songName.includes('Min7') && !songName.includes('b5') && !songName.includes('Maj7')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m7`).join(' → ');
                        } else if (songName.includes('Sus4b9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}sus4(b9)`).join(' → ');
                        } else if (songName.includes('Maj7#11')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}Maj7(#11)`).join(' → ');
                        } else if (songName.includes('7sus4') && !songName.includes('b9') && !songName.includes('13')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}7sus4`).join(' → ');
                        } else if (songName.includes('Dom7')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}7`).join(' → ');
                        } else if (songName.includes('Min7b5') && !songName.includes('♮9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m7(b5)`).join(' → ');
                        } else if (songName.includes('MinMaj7')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m(Maj7)`).join(' → ');
                        } else if (songName.includes('13sus4b9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}13sus4(b9)`).join(' → ');
                        } else if (songName.includes('Maj7#5')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}Maj7(#5)`).join(' → ');
                        } else if (songName.includes('7#11') && !songName.includes('13')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}7(#11)`).join(' → ');
                        } else if (songName.includes('Min7b5♮9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m7(b5,♮9)`).join(' → ');
                        } else if (songName.includes('13b9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}13(b9)`).join(' → ');
                        }
                    } else {
                        // 普通歌曲：显示标准和弦进行
                        chordsDisplay = songData.chords.join(' - ');
                    }

                    // 获取歌曲信息，提供默认值
                    const info = songData.info || {
                        composer: '未知',
                        year: '未知',
                        style: '爵士标准曲',
                        tempo: 'Medium',
                        description: '经典爵士标准曲，适合和弦进行练习。'
                    };
                    
                    content.innerHTML = `
                        <div class="song-info-header">
                            <h2 class="song-info-title">${songName}</h2>
                            <button class="close-btn">×</button>
                        </div>

                        <div class="song-info-section">
                            <h3 class="song-info-subtitle" data-i18n-key="basic_info">基本信息</h3>
                            <div class="song-info-content">
                                <p><strong data-i18n-key="song_composer">作曲家:</strong> ${info.composer || '未知'}</p>
                                <p><strong data-i18n-key="song_year">年代:</strong> ${info.year || '未知'}</p>
                                <p><strong data-i18n-key="song_style">风格:</strong> ${info.style || '爵士标准曲'}</p>
                                <p><strong data-i18n-key="song_tempo">速度:</strong> ${info.tempo || 'Medium'}</p>
                                <p><strong data-i18n-key="song_key">原调:</strong> ${songData.key}</p>
                            </div>
                        </div>

                        <div class="song-info-section">
                            <h3 class="song-info-subtitle" data-i18n-key="chord_progression">和弦进行</h3>
                            <div class="song-info-content song-chord-progression">
                                ${chordsDisplay}
                            </div>
                        </div>
                        
                        ${info.description ? `
                        <div class="song-info-section">
                            <h3 class="song-info-subtitle" data-i18n-key="song_description">曲目介绍</h3>
                            <div class="song-info-content">
                                ${info.description}
                            </div>
                        </div>
                        ` : ''}

                        ${info.details ? `
                        <div class="song-info-section">
                            <h3 class="song-info-subtitle">练习说明</h3>
                            <div class="song-info-content">
                                ${info.details}
                            </div>
                        </div>
                        ` : ''}

                        <div class="song-info-footer">
                            <button class="select-song-btn" data-i18n-key="select_this_song">
                                选择此曲目
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                    
                    // 关闭按钮事件
                    content.querySelector('.close-btn').addEventListener('click', function() {
                        document.body.removeChild(modal);
                    });
                    
                    // 选择曲目按钮事件
                    content.querySelector('.select-song-btn').addEventListener('click', function() {
                        // 更新下拉框显示
                        const jazzStandardDropdown = document.getElementById('jazzStandardDropdown');
                        const jazzStandardSelect = document.getElementById('jazzStandard');
                        
                        if (jazzStandardDropdown) {
                            jazzStandardDropdown.querySelector('.dropdown-text').textContent = songName;
                        }
                        
                        if (jazzStandardSelect) {
                            jazzStandardSelect.value = songName;
                            // 触发change事件
                            const changeEvent = new Event('change', { bubbles: true });
                            jazzStandardSelect.dispatchEvent(changeEvent);
                        }
                        
                        // 关闭弹窗
                        document.body.removeChild(modal);
                        
                        // 如果是在全屏选择器中打开的，也关闭全屏选择器
                        const fullscreenSelector = document.getElementById('fullscreenSelector');
                        if (fullscreenSelector && fullscreenSelector.classList.contains('active')) {
                            fullscreenSelector.classList.remove('active');
                        }
                        
                        console.log('从信息弹窗选择了乐曲:', songName);
                    });
                    
                    // 点击背景关闭
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                }
                
                // 测试函数 - 可以在控制台调用
                window.testShowSongInfo = function(songName) {
                    console.log('测试显示歌曲信息:', songName || 'All Of Me');
                    if (typeof window.showSongInfo === 'function') {
                        window.showSongInfo(songName || 'All Of Me');
                    }
                };
            };
            
            // 自定义和弦弹窗相关变量 - 移到全局作用域
            window.customChordSequence = [];
            window.currentChordRoot = 'C';
            window.currentChordType = 'major';
            window.currentChordBass = 'root';

            // 初始化自定义和弦弹窗
            window.initCustomChordsDialog = function() {
                const openBtn = document.getElementById('openCustomChordsDialog');
                const dialog = document.getElementById('customChordsDialog');
                const closeBtn = document.getElementById('closeCustomChordsDialog');
                const addChordBtn = document.getElementById('addCustomChord');
                const clearBtn = document.getElementById('clearCustomChords');
                const saveBtn = document.getElementById('saveCustomChords');
                const loadBtn = document.getElementById('loadLocalChords');
                const loadPracticeBtn = document.getElementById('loadPracticeBtn');

                // 打开弹窗
                openBtn.addEventListener('click', () => {
                    dialog.classList.add('active');
                    updateChordSequenceDisplay();
                });

                // 关闭弹窗
                closeBtn.addEventListener('click', () => {
                    dialog.classList.remove('active');
                });

                // 点击背景关闭弹窗
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.classList.remove('active');
                    }
                });

                // 根音选择
                const rootNoteGrid = document.getElementById('rootNoteGrid');
                rootNoteGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('note-btn')) {
                        // 移除所有active类
                        rootNoteGrid.querySelectorAll('.note-btn').forEach(btn => btn.classList.remove('active'));
                        // 添加active类到点击的按钮
                        e.target.classList.add('active');
                        // 更新当前选择的根音
                        window.currentChordRoot = e.target.dataset.note;
                    }
                });

                // 和弦类型选择
                const chordTypeGrid = document.getElementById('chordTypeGrid');
                chordTypeGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('custom-chord-type-btn')) {
                        // 移除所有active类
                        chordTypeGrid.querySelectorAll('.custom-chord-type-btn').forEach(btn => btn.classList.remove('active'));
                        // 添加active类到点击的按钮
                        e.target.classList.add('active');
                        // 更新当前选择的和弦类型
                        window.currentChordType = e.target.dataset.type;
                    }
                });

                // 转位选择
                const bassGrid = document.getElementById('bassGrid');
                bassGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('bass-btn')) {
                        // 移除所有active类
                        bassGrid.querySelectorAll('.bass-btn').forEach(btn => btn.classList.remove('active'));
                        // 添加active类到点击的按钮
                        e.target.classList.add('active');
                        // 更新当前选择的转位
                        window.currentChordBass = e.target.dataset.bass;
                    }
                });

                // 添加和弦
                addChordBtn.addEventListener('click', () => {
                    const chord = {
                        root: window.currentChordRoot,
                        type: window.currentChordType,
                        bass: window.currentChordBass
                    };
                    window.customChordSequence.push(chord);
                    updateChordSequenceDisplay();
                });

                // 清空序列
                clearBtn.addEventListener('click', () => {
                    window.customChordSequence = [];
                    updateChordSequenceDisplay();
                });

                // 保存序列
                saveBtn.addEventListener('click', () => {
                    const sequenceName = document.getElementById('sequenceName').value || '未命名序列';
                    const data = {
                        name: sequenceName,
                        sequence: window.customChordSequence
                    };
                    localStorage.setItem('customChordSequence', JSON.stringify(data));
                    alert('和弦进行已保存到本地！');
                });

                // 加载序列
                loadBtn.addEventListener('click', () => {
                    const saved = localStorage.getItem('customChordSequence');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            window.customChordSequence = data.sequence || [];
                            document.getElementById('sequenceName').value = data.name || '';
                            updateChordSequenceDisplay();
                            alert('和弦进行已加载！');
                        } catch (e) {
                            alert('加载失败：数据格式错误！');
                        }
                    } else {
                        alert('没有找到保存的和弦进行！');
                    }
                });

                // 加载练习
                loadPracticeBtn.addEventListener('click', () => {
                    if (window.customChordSequence && window.customChordSequence.length > 0) {
                        // 关闭自定义和弦弹窗
                        dialog.style.display = 'none';
                        
                        // 清空歌曲相关状态，确保使用自定义和弦
                        const jazzStandardEl = document.getElementById('jazzStandard');
                        if (jazzStandardEl) {
                            jazzStandardEl.value = '';
                        }
                        
                        // 切换到和弦进行练习页面
                        document.querySelector('.nav-item[data-tab="progression"]').click();
                        
                        // 等待页面切换完成后再设置选项
                        setTimeout(() => {
                            // 自定义和弦模式已通过 state.isCustomChordMode 管理
                            
                            // 设置自定义和弦模式状态
                            state.isCustomChordMode = true;
                            
                            // 更新和弦进行显示
                            updateCustomChordProgressionDisplay();
                            
                            // 直接开始练习
                            setTimeout(() => {
                                const startBtn = document.getElementById('startBtn');
                                if (startBtn) {
                                    startBtn.click();
                                }
                            }, 200);
                        }, 100);
                    } else {
                        alert('请先添加和弦到序列中！');
                    }
                });
            }

            // 更新和弦序列显示
            function updateChordSequenceDisplay() {
                const container = document.getElementById('customChordSequence');
                container.innerHTML = '';

                if (window.customChordSequence.length === 0) {
                    container.innerHTML = '<div class="chord-sequence-empty">点击"添加和弦"开始创建和弦进行</div>';
                    return;
                }

                window.customChordSequence.forEach((chord, index) => {
                    const chordElement = document.createElement('div');
                    chordElement.className = 'chord-item';
                    chordElement.innerHTML = `
                        <span>${formatChordDisplay(chord)}</span>
                        <button class="remove-chord" onclick="removeChord(${index})">×</button>
                    `;
                    container.appendChild(chordElement);
                });
            }

            // 更新自定义和弦进行显示
            function updateCustomChordProgressionDisplay() {
                const progressionDisplay = document.getElementById('customChordProgression');
                if (progressionDisplay && window.customChordSequence && window.customChordSequence.length > 0) {
                    progressionDisplay.innerHTML = window.customChordSequence.map(chord => formatChordDisplay(chord)).join(' - ');
                }
            }

            // 获取音名从根音和音级
            function getBassNoteName(rootNote, bassType, chordType) {
                const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];

                // 找到根音在音阶中的索引
                let rootIndex = noteNames.indexOf(rootNote);
                if (rootIndex === -1) {
                    // 处理降号情况
                    const flatToSharp = {
                        'D♭': 'C♯', 'E♭': 'D♯', 'G♭': 'F♯', 'A♭': 'G♯', 'B♭': 'A♯'
                    };
                    rootIndex = noteNames.indexOf(flatToSharp[rootNote] || rootNote);
                }

                if (rootIndex === -1) return rootNote; // 如果找不到，返回原根音

                // 音级间隔映射（半音数）
                let semitones = 0;
                switch (bassType) {
                    case 'root':
                        semitones = 0;
                        break;
                    case '3rd':
                        // 根据和弦类型决定三度
                        if (chordType === 'minor' || chordType === 'minor6' || chordType === 'minor7' ||
                            chordType === 'minor9' || chordType === 'minor11' || chordType === 'minor13' ||
                            chordType === 'madd9' || chordType === 'm6add9') {
                            semitones = 3; // 小三度
                        } else {
                            semitones = 4; // 大三度
                        }
                        break;
                    case '5th':
                        // 减和弦的减五度
                        if (chordType === 'diminished' || chordType === 'diminished7' || chordType === 'minor7b5') {
                            semitones = 6; // 减五度
                        } else {
                            semitones = 7; // 纯五度
                        }
                        break;
                    case '7th':
                        // 各种七度
                        if (chordType === 'major7' || chordType === 'major9' || chordType === 'major6' || chordType === '6add9') {
                            semitones = 11; // 大七度
                        } else if (chordType === 'dominant7' || chordType === 'dominant9' || chordType === 'dominant11' ||
                                  chordType === 'dominant13' || chordType === 'dominant7sharp9' || chordType === 'dominant7flat9' ||
                                  chordType === 'dominant7sharp11') {
                            semitones = 10; // 小七度
                        } else if (chordType === 'diminished7') {
                            semitones = 9; // 减七度
                        } else if (chordType === 'minor7' || chordType === 'minor9' || chordType === 'minor11' ||
                                  chordType === 'minor13' || chordType === 'madd9' || chordType === 'm6add9') {
                            semitones = 10; // 小七度
                        } else {
                            semitones = 11; // 默认大七度
                        }
                        break;
                }

                const bassIndex = (rootIndex + semitones) % 12;
                return noteNames[bassIndex];
            }

            // 格式化和弦显示
            function formatChordDisplay(chord) {
                const typeMap = {
                    'major': '',
                    'minor': 'm',
                    'diminished': 'dim',
                    'augmented': 'aug',
                    'major6': '6',
                    'minor6': 'm6',
                    'dominant7': '7',
                    'major7': 'maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7♭5',
                    'diminished7': 'dim7',
                    'dominant9': '9',
                    'major9': 'maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7♯9',
                    'dominant7flat9': '7♭9',
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7♯11',
                    'dominant13': '13',
                    'minor13': 'm13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };

                let chordText = chord.root + (typeMap[chord.type] || '');

                if (chord.bass !== 'root') {
                    const bassNoteName = getBassNoteName(chord.root, chord.bass, chord.type);
                    chordText += `/${bassNoteName}`;
                }

                return chordText;
            }

            // 移除和弦
            function removeChord(index) {
                window.customChordSequence.splice(index, 1);
                updateChordSequenceDisplay();
            }
            
            // 初始化调性下拉框功能
            window.initProgressionKeyDropdown = function() {
                console.log('初始化调性下拉列表...');
                const dropdown = document.getElementById('progressionKeyDropdown');
                
                if (!dropdown) {
                    console.error('找不到progressionKeyDropdown元素');
                    return;
                }
                
                // 检查是否已经初始化过
                if (dropdown.dataset.initialized === 'true') {
                    console.log('调性下拉列表已经初始化过，跳过');
                    return;
                }
                
                const trigger = dropdown.querySelector('.dropdown-trigger');
                const menu = dropdown.querySelector('.dropdown-menu');
                const nativeSelect = document.getElementById('progressionKey');
                
                if (!trigger || !menu || !nativeSelect) {
                    console.error('调性下拉列表缺少必要元素');
                    return;
                }
                
                // 生成调性列表
                const allKeys = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                menu.innerHTML = '';
                
                console.log('开始生成调性选项，总数:', allKeys.length);
                
                allKeys.forEach(key => {
                    const keyLi = document.createElement('li');
                    keyLi.className = 'dropdown-item';
                    keyLi.setAttribute('data-value', key);
                    
                    const itemText = document.createElement('span');
                    itemText.className = 'item-text';
                    itemText.textContent = key;
                    keyLi.appendChild(itemText);
                    
                    menu.appendChild(keyLi);
                });
                
                // 重新查询动态生成的元素
                const items = dropdown.querySelectorAll('.dropdown-item');
                console.log('调性选项生成完成，实际生成数量:', items.length);
                
                // 点击触发器打开/关闭下拉菜单
                trigger.addEventListener('click', function(e) {
                    console.log('调性下拉框触发器被点击');
                    e.stopPropagation();
                    if (menu.classList.contains('show')) {
                        console.log('菜单当前显示，准备关闭');
                        closeKeyDropdown();
                    } else {
                        console.log('菜单当前隐藏，准备打开');
                        openKeyDropdown();
                    }
                });
                
                // 点击选项
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const value = this.dataset.value;
                        const text = this.querySelector('.item-text').textContent;
                        
                        // 更新显示文本
                        trigger.querySelector('.dropdown-text').textContent = text;
                        
                        // 更新原生select的值
                        nativeSelect.value = value;
                        
                        // 触发change事件
                        const changeEvent = new Event('change', { bubbles: true });
                        nativeSelect.dispatchEvent(changeEvent);
                        
                        closeKeyDropdown();
                    });
                });
                
                // 点击外部关闭下拉菜单
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        closeKeyDropdown();
                    }
                });
                
                function openKeyDropdown() {
                    positionDropdown(menu, trigger);
                    console.log('打开调性下拉菜单');
                    menu.classList.add('show');
                    trigger.classList.add('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = '▲';
                    
                    // 动态计算位置，确保不被遮挡
                    const rect = trigger.getBoundingClientRect();
                    const menuHeight = menu.offsetHeight || 200;
                    const viewportHeight = window.innerHeight;
                    
                    console.log('调性下拉菜单定位信息:', {
                        triggerRect: rect,
                        menuHeight: menuHeight,
                        viewportHeight: viewportHeight
                    });
                    
                    // 计算可用空间并选择最佳展开方向
                    const spaceBelow = viewportHeight - rect.bottom;
                    const spaceAbove = rect.top;
                    
                    console.log('空间计算:', {
                        spaceBelow: spaceBelow,
                        spaceAbove: spaceAbove,
                        menuHeight: menuHeight,
                        needsUpward: spaceBelow < menuHeight && spaceAbove > spaceBelow
                    });
                    
                    // 如果下方空间不够且上方空间更大，向上展开
                    if (spaceBelow < menuHeight && spaceAbove > spaceBelow) {
                        const topPosition = Math.max(10, rect.top - menuHeight);
                        menu.style.top = topPosition + 'px';
                        console.log('向上展开，top:', topPosition);
                    } else {
                        // 向下展开，但确保不超出视口
                        const topPosition = Math.min(rect.bottom, viewportHeight - menuHeight - 10);
                        menu.style.top = Math.max(10, topPosition) + 'px';
                        console.log('向下展开，top:', Math.max(10, topPosition));
                    }
                    
                    menu.style.left = rect.left + 'px';
                    menu.style.width = rect.width + 'px';
                    
                    // 计算合适的最大高度，确保不超出视口
                    let maxHeight;
                    if (spaceBelow < menuHeight && spaceAbove > spaceBelow) {
                        // 向上展开时，限制高度为上方可用空间
                        maxHeight = Math.min(300, spaceAbove - 20);
                    } else {
                        // 向下展开时，限制高度为下方可用空间
                        maxHeight = Math.min(300, spaceBelow - 20);
                    }
                    
                    // 确保最小高度，避免过小
                    maxHeight = Math.max(100, maxHeight);
                    menu.style.maxHeight = maxHeight + 'px';
                    
                    console.log('高度设置:', {
                        calculatedMaxHeight: maxHeight,
                        spaceBelow: spaceBelow,
                        spaceAbove: spaceAbove,
                        originalMenuHeight: menuHeight
                    });
                    
                    console.log('调性下拉菜单最终样式:', {
                        top: menu.style.top,
                        left: menu.style.left,
                        width: menu.style.width,
                        display: getComputedStyle(menu).display,
                        zIndex: getComputedStyle(menu).zIndex
                    });
                }
                
                function closeKeyDropdown() {
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = '▼';
                }
                
                // 标记为已初始化
                dropdown.dataset.initialized = 'true';
                console.log('调性下拉列表初始化完成');
                
                // 测试函数 - 可以在控制台调用
                window.testProgressionKeyDropdown = function() {
                    console.log('=== 测试调性下拉框 ===');
                    console.log('下拉框元素:', dropdown);
                    console.log('触发器元素:', trigger);
                    console.log('菜单元素:', menu);
                    console.log('菜单项数量:', items.length);
                    console.log('菜单当前显示状态:', menu.classList.contains('show'));
                    
                    const computedStyle = getComputedStyle(menu);
                    console.log('菜单计算样式:', {
                        display: computedStyle.display,
                        position: computedStyle.position,
                        zIndex: computedStyle.zIndex,
                        top: computedStyle.top,
                        left: computedStyle.left,
                        maxHeight: computedStyle.maxHeight,
                        overflowY: computedStyle.overflowY,
                        overflowX: computedStyle.overflowX
                    });
                    
                    // 强制打开菜单进行测试
                    menu.classList.add('show');
                    console.log('强制添加show类后的显示状态:', getComputedStyle(menu).display);
                    
                    // 检查滚动状态
                    setTimeout(() => {
                        console.log('滚动状态检查:', {
                            scrollHeight: menu.scrollHeight,
                            clientHeight: menu.clientHeight,
                            offsetHeight: menu.offsetHeight,
                            needsScroll: menu.scrollHeight > menu.clientHeight
                        });
                    }, 100);
                };
            };

            // 自定义下拉列表功能
            window.initCustomDropdown = function() {
                console.log('初始化自定义下拉列表...');
                const dropdown = document.getElementById('progressionLevelDropdown');
                
                if (!dropdown) {
                    console.error('找不到progressionLevelDropdown元素');
                    return;
                }
                
                // 检查是否已经初始化过
                if (dropdown.dataset.initialized === 'true') {
                    console.log('自定义下拉列表已经初始化过，跳过');
                    return;
                }
                
                const trigger = dropdown.querySelector('.dropdown-trigger');
                const menu = dropdown.querySelector('.dropdown-menu');
                const items = dropdown.querySelectorAll('.dropdown-item');
                const infoIcons = dropdown.querySelectorAll('.info-icon');
                const nativeSelect = document.getElementById('progressionLevel');
                
                console.log('找到元素:', {
                    dropdown: !!dropdown,
                    trigger: !!trigger,
                    menu: !!menu,
                    items: items.length,
                    infoIcons: infoIcons.length,
                    nativeSelect: !!nativeSelect
                });
                
                // 标记为已初始化
                dropdown.dataset.initialized = 'true';

                // 切换下拉菜单显示/隐藏
                trigger.addEventListener('click', function(e) {
                    console.log('下拉列表触发器被点击');
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = menu.classList.contains('show');
                    console.log('当前状态:', isOpen ? '打开' : '关闭');
                    
                    if (isOpen) {
                        closeDropdown();
                    } else {
                        openDropdown();
                    }
                });

                // 点击外部关闭下拉菜单 - 使用延迟执行避免立即关闭
                document.addEventListener('click', function(e) {
                    // 延迟执行，避免与trigger点击冲突
                    setTimeout(() => {
                        if (!dropdown.contains(e.target) && menu.classList.contains('show')) {
                            closeDropdown();
                        }
                    }, 10);
                });

                // 选择选项
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const value = this.dataset.value;
                        const text = this.querySelector('.item-text').textContent;
                        
                        // 更新显示文本
                        trigger.querySelector('.dropdown-text').textContent = text;
                        
                        // 更新活动状态
                        items.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 同步原生select
                        nativeSelect.value = value;
                        
                        // 关闭下拉菜单
                        closeDropdown();
                        
                        // 触发change事件
                        nativeSelect.dispatchEvent(new Event('change'));
                    });
                });

                // 信息图标点击事件
                infoIcons.forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const infoKey = this.dataset.info;
                        showInfoModal(infoKey);
                    });
                });

                function openDropdown() {
                    positionDropdown(menu, trigger);
                    console.log('打开下拉菜单');
                    menu.classList.add('show');
                    trigger.classList.add('active');
                    
                    // 计算下拉菜单的位置（因为使用fixed定位）
                    const triggerRect = trigger.getBoundingClientRect();
                    menu.style.top = (triggerRect.bottom + 4) + 'px';
                    menu.style.left = triggerRect.left + 'px';
                    menu.style.width = triggerRect.width + 'px';  // 设置宽度与触发器一致
                }

                function closeDropdown() {
                    console.log('关闭下拉菜单');
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                }
            }

            // 信息模态框数据
            const infoModalData = {
                // 单和弦音练习
                'single-root-info': {
                    title: '单音练习 - 根音 (1)',
                    content: `
                        <h3>练习内容</h3>
                        <p>只练习和弦的根音，这是最基础的练习模式。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>初学者熟悉和弦根音</li>
                            <li>建立音高记忆</li>
                            <li>基础音准训练</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>建议先掌握根音的音高，再逐步学习其他音程。</p>
                    `
                },
                'single-3-info': {
                    title: '单音练习 - 三音 (3)',
                    content: `
                        <h3>练习内容</h3>
                        <p>只练习和弦的三音，区分大三度和小三度。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>学习和弦色彩</li>
                            <li>区分大调和小调</li>
                            <li>音程识别训练</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>注意大三度和小三度的音高差异，这是和弦性质的关键。</p>
                    `
                },
                'single-5-info': {
                    title: '单音练习 - 五音 (5)',
                    content: `
                        <h3>练习内容</h3>
                        <p>只练习和弦的五音，建立纯五度音程概念。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>音程基础训练</li>
                            <li>和声稳定性练习</li>
                            <li>音准精确度提升</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>五音是和弦中最稳定的音程，适合建立音高基准。</p>
                    `
                },
                'single-7-info': {
                    title: '单音练习 - 七音 (7)',
                    content: `
                        <h3>练习内容</h3>
                        <p>只练习和弦的七音，学习七度音程。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦基础训练</li>
                            <li>复杂音程练习</li>
                            <li>爵士和声入门</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>七音是七和弦的特征音，需要重点掌握其音高。</p>
                    `
                },
                
                // 双和弦音练习
                'double-root-3-info': {
                    title: '双音练习 - 根音+三音 (1,3)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习根音和三音的组合，建立三度音程概念。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>三度音程训练</li>
                            <li>和弦色彩识别</li>
                            <li>和声基础建立</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>这是和弦的核心音程，建议重点练习。</p>
                    `
                },
                'double-root-5-info': {
                    title: '双音练习 - 根音+五音 (1,5)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习根音和五音的组合，建立纯五度音程概念。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>纯五度音程训练</li>
                            <li>和声稳定性练习</li>
                            <li>音程基础建立</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>纯五度是最稳定的音程，适合建立和声基础。</p>
                    `
                },
                'double-root-7-info': {
                    title: '双音练习 - 根音+七音 (1,7)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习根音和七音的组合，建立七度音程概念。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七度音程训练</li>
                            <li>七和弦基础练习</li>
                            <li>复杂和声入门</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>七度音程是七和弦的特征，需要重点掌握。</p>
                    `
                },
                'double-3-5-info': {
                    title: '双音练习 - 三音+五音 (3,5)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习三音和五音的组合，建立小三度音程概念。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>小三度音程训练</li>
                            <li>和弦内部音程练习</li>
                            <li>和声色彩识别</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>小三度是重要的和声音程，需要熟练掌握。</p>
                    `
                },
                'double-3-7-info': {
                    title: '双音练习 - 三音+七音 (3,7)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习三音和七音的组合，建立五度音程概念。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>五度音程训练</li>
                            <li>七和弦内部练习</li>
                            <li>复杂和声训练</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>五度音程在七和弦中很重要，需要重点练习。</p>
                    `
                },
                
                // 三和弦音练习
                'triple-root-3-5-info': {
                    title: '三和弦练习 - 根音+三音+五音 (1,3,5)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习完整的三和弦，包含根音、三音和五音。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>标准三和弦练习</li>
                            <li>和弦指法训练</li>
                            <li>和声基础建立</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>这是最常用的和弦练习模式，建议重点掌握。</p>
                    `
                },
                'triple-3-5-7-info': {
                    title: '三和弦练习 - 三音+五音+七音 (3,5,7)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习三音、五音和七音的组合，建立七和弦内部音程。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦内部练习</li>
                            <li>复杂音程训练</li>
                            <li>爵士和声练习</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>这种组合适合高级练习，需要扎实的基础。</p>
                    `
                },
                'triple-random-inversion-info': {
                    title: '三和弦练习 - 随机转位 (1,3,5随机转位)',
                    content: `
                        <h3>练习内容</h3>
                        <p>随机练习三和弦的不同转位形式。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>和弦转位训练</li>
                            <li>灵活性和声练习</li>
                            <li>高级和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>转位练习能提高和声的灵活性，适合进阶学习。</p>
                    `
                },
                
                // 四和弦音练习
                'quad-root-3-5-7-info': {
                    title: '七和弦练习 - 根音+三音+五音+七音 (1,3,5,7)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习完整的七和弦，包含根音、三音、五音和七音。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>高级和弦练习</li>
                            <li>爵士和声训练</li>
                            <li>复杂和弦掌握</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>七和弦比三和弦更复杂，建议先掌握三和弦再学习。</p>
                    `
                },
                'quad-3-5-7-root-info': {
                    title: '七和弦练习 - 三音+五音+七音+根音 (3,5,7,1)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习七和弦的第一转位，根音在最高音。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦转位练习</li>
                            <li>和声连接训练</li>
                            <li>高级和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>转位练习能提高和声的流畅性，适合高级练习。</p>
                    `
                },
                'quad-5-7-root-3-info': {
                    title: '七和弦练习 - 五音+七音+根音+三音 (5,7,1,3)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习七和弦的第二转位，三音在最高音。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦第二转位练习</li>
                            <li>复杂和声连接</li>
                            <li>高级和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>第二转位练习能提高和声的多样性，适合专业练习。</p>
                    `
                },
                'quad-7-root-3-5-info': {
                    title: '七和弦练习 - 七音+根音+三音+五音 (7,1,3,5)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习七和弦的第三转位，五音在最高音。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦第三转位练习</li>
                            <li>专业和声训练</li>
                            <li>复杂和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>第三转位是最复杂的转位，需要扎实的基础。</p>
                    `
                },
                'quad-random-inversion-info': {
                    title: '七和弦练习 - 随机转位 (1,3,5,7随机转位)',
                    content: `
                        <h3>练习内容</h3>
                        <p>随机练习七和弦的不同转位形式。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦转位训练</li>
                            <li>灵活性和声练习</li>
                            <li>专业和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>随机转位练习能提高和声的应变能力，适合专业学习。</p>
                    `
                },
                'quad-root-3-5-7-root-info': {
                    title: '七和弦练习 - 扩展练习 (1,3,5,7,1)',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习七和弦的扩展形式，包含重复的根音。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>七和弦扩展练习</li>
                            <li>复杂和声训练</li>
                            <li>专业和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>扩展练习能提高和声的丰富性，适合高级练习。</p>
                    `
                },
                
                // 全部和弦音练习
                'all-notes-info': {
                    title: '全部和弦音练习',
                    content: `
                        <h3>练习内容</h3>
                        <p>练习和弦的所有音，包括根音、三音、五音、七音等。</p>
                        
                        <h3>适用场景</h3>
                        <ul>
                            <li>完整和弦练习</li>
                            <li>综合和声训练</li>
                            <li>专业和声技巧</li>
                        </ul>
                        
                        <h3>练习建议</h3>
                        <p>全部音练习是最全面的练习模式，适合高级学习者。</p>
                    `
                }
            };

            // 显示信息模态框
            function showInfoModal(infoKey) {
                const data = infoModalData[infoKey];
                if (!data) return;

                // 创建模态框
                const modal = document.createElement('div');
                modal.className = 'info-modal';
                modal.innerHTML = `
                    <div class="info-modal-content">
                        <div class="info-modal-header">
                            <h2 class="info-modal-title">${data.title}</h2>
                            <button class="info-modal-close">&times;</button>
                        </div>
                        <div class="info-modal-body">
                            ${data.content}
                        </div>
                    </div>
                `;

                // 添加到页面
                document.body.appendChild(modal);

                // 关闭按钮事件
                const closeBtn = modal.querySelector('.info-modal-close');
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // 点击背景关闭
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                // ESC键关闭
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            }
            
            // 当前语言
            let currentLanguage = 'zh-CN';
            
            // 初始化语言设置
            function initLanguage() {
                const savedLanguage = localStorage.getItem('appLanguage');
                if (savedLanguage && (savedLanguage === 'zh-CN' || savedLanguage === 'en')) {
                    currentLanguage = savedLanguage;
                } else {
                    currentLanguage = 'zh-CN';
                    localStorage.setItem('appLanguage', currentLanguage);
                }
            }
            
            // 获取翻译文本
            function t(key) {
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    return translations[currentLanguage][key];
                }
                return translations['en'][key] || key;
            }
            
            // 切换语言
            function switchLanguage(lang) {
                if (lang === 'zh-CN' || lang === 'en') {
                    currentLanguage = lang;
                    localStorage.setItem('appLanguage', lang);
                    window.dispatchEvent(new CustomEvent('languageChanged', { detail: lang }));
                    return true;
                }
                return false;
            }
            
            // 获取当前语言
            function getCurrentLanguage() {
                return currentLanguage;
            }
            
            // 获取支持的语言列表
            function getSupportedLanguages() {
                return [
                    { code: 'zh-CN', name: '中文' },
                    { code: 'en', name: 'English' }
                ];
            }
            
            // 初始化
            initLanguage();
            
            // 暴露到全局作用域
            window.t = t;
            window.switchLanguage = switchLanguage;
            window.getCurrentLanguage = getCurrentLanguage;
            window.getSupportedLanguages = getSupportedLanguages;
            
        })();
    </script>
    <style>
        /* 保留少量仅在此页面需要的特定样式 */
        /* 权限指导模态框样式 */
        .permission-guidance {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 40, 50, 0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            width: 80%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .permission-guidance h3 {
            margin-bottom: 15px;
            color: #3a9fc4;
        }

        .permission-guidance ol {
            margin-left: 20px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .permission-guidance button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        #refresh-page {
            background: #3a9fc4;
        }

        #dismiss-guidance {
            background: #6c757d;
        }









        /* .btn 和 .controls 样式已在 styles/main.css 中定义 */

        @media (min-width: 768px) {
            .chord-type-container {
                grid-template-columns: repeat(6, 1fr);
            }

            .settings-row {
                flex-direction: row;
                align-items: center;
            }

            .settings-label {
                min-width: 100px;
                margin-bottom: 0;
            }
        }

        @media (min-width: 1024px) {
            .chord-type-container {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        @media (min-width: 1440px) {
            .chord-type-container {
                grid-template-columns: repeat(10, 1fr);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 24px;
            }

            /* .btn 响应式样式已在 styles/main.css 中定义 */

            .settings-section-title {
                font-size: 16px;
            }

            .settings-tab {
                padding: 14px 12px;
                font-size: 14px;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.1s ease;
        }

        #practiceScreen.metronome-active {
            /* 节拍器激活状态的基础样式 */
            transition: background-color 0.1s ease;
        }



        .exercise-container {
            background:rgb(51 65 85 / 74%);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }
        
        .song-title-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 100%;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.1);
        }
        
        .song-title {
            font-size: 28px;
            font-weight: bold;
            color: #60a5fa;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            letter-spacing: 0.5px;
        }

        .scale-info {
            margin-bottom: 24px;
        }

        .target-interval {
            font-size: 36px;
            font-weight: 700;
            color: #38bdf8;
            margin: 12px 0;
            text-shadow: 0 4px 8px rgba(56, 189, 248, 0.3);
            letter-spacing: -0.5px;
        }

        .sequence-display {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 0px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sequence-title {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .sequence-items {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            margin: 15px auto;
            width: 100%;
            max-width: 100%;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: #ff8a00;
            transition: all 0.3s ease;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(51, 65, 85, 0.9);
            min-width: 36px;
            max-width: 150px;
            min-height: 36px;
            height: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 0 0 auto;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            line-height: 1.2;
        }

        .sequence-item.played {
            color: #64748b !important;
            background: rgba(30, 41, 59, 0.6) !important;
            box-shadow: none !important;
            border-color: rgba(100, 116, 139, 0.3);
            transform: scale(0.95);
        }

        .sequence-item.current {
            color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
        }

        .next-exercise {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            width: 100%;
            max-width: 600px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .next-label {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .next-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .next-content {
            font-size: 16px;
            color: #ff8a00;
            font-weight: 600;
            text-align: center;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-recording {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-weight: 600;
            color: #ff8a00;
        }

        .pitch-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .pitch-display.in-tune {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .pitch-display.out-of-tune {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .confidence-bar {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: #38bdf8;
            border-radius: 2px;
            transition: width 0.2s ease;
        }



        .device-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .gain-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .gain-control input {
            flex: 1;
        }

        .gain-value {
            min-width: 40px;
            text-align: right;
        }

        .usb-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #22c55e;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.3s ease;
        }

        #practiceScreen.metronome-flash {
            background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            transition: background-color 0.1s ease;
        }

        /* 其他样式保持不变... */

        .metronome-flash {
            animation: metronomeFlash 0.3s ease;
        }
        
        /* 手机横屏适配 - 调整sequence-item字体大小 */
        @media (max-height: 480px) and (orientation: landscape) {
            .sequence-item {
                font-size: 25px;
            }
            
            /* 进一步压缩页面元素上下的margin */
            #practiceScreen {
                padding: 8px;
            }
            
            .exercise-container {
                padding: 16px 12px; /* 增加上下padding使内容更舒展 */
                margin-bottom: 8px;
            }
            
            .scale-info {
                margin-bottom: 12px; /* 增加底部margin */
            }
            
            .target-interval {
                font-size: 24px;
                margin: 10px 0; /* 增加上下margin */
            }
            
            .sequence-display {
                padding: 12px 8px; /* 增加上下padding */
                margin: 12px 0; /* 增加上下margin */
            }
            
            .sequence-item {
                font-size: 22px;
                /* min-width: 30px; */
                min-height: 34px;
                height: auto;
                padding: 6px;

            }
            
            .next-exercise {
                margin: 12px 0; /* 增加上下margin */
                padding: 12px 8px; /* 增加上下padding */
            }
            
            .song-title-display {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .song-title {
                font-size: 22px;
            }
            
            .next-label {
                font-size: 12px;
                margin-bottom: 6px; /* 增加底部margin */
            }
            
            .next-content {
                font-size: 14px;
            }
            
            /* 横屏模式下隐藏header */
            .header {
                display: none;
            }
            
            /* 手机模式下隐藏快捷键提示 */
            .shortcut-hint {
                display: none;
            }
        }
        
        /* 手机模式下隐藏快捷键提示（覆盖所有手机尺寸） */
        @media (max-width: 768px) {
            .shortcut-hint {
                display: none !important;
            }
        }
        
        /* 手机模式下隐藏header（覆盖所有手机尺寸）
        @media (max-width: 768px) {
            .header {
                display: none !important;
            }
        } */
        
        /* 底部导航栏样式 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(40, 40, 50, 0.95);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #aaa;
        }
        
        .nav-item.active {
            color: #3a9fc4;
        }
        
        /* 降低转换按钮的亮度 */
        .nav-item[data-tab="progression"] {
            color: #888;
        }
        
        .nav-item[data-tab="progression"].active {
            color: #2a7f94; /* 调低亮度的颜色 */
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* 调整主容器的底部边距，为底部导航栏留出空间 */
        .container {
            margin-bottom: 60px;
        }

        /* CAGED滑块样式 */
        .caged-slider-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 12px;
        }

        .caged-slider-input {
            display: none;
        }

        .caged-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 116, 139, 0.5);
        }

        .caged-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #64748b;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .caged-slider-input:checked + .caged-slider {
            background: rgba(58, 159, 196, 0.3);
            border-color: #3a9fc4;
        }

        .caged-slider-input:checked + .caged-slider::before {
            transform: translateX(26px);
            background: #3a9fc4;
            box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
        }

        .caged-slider-text {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
        }

        .caged-slider-container:hover .caged-slider {
            border-color: rgba(58, 159, 196, 0.7);
        }

        .caged-slider-container:hover .caged-slider::before {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* MIDI滑块样式 */
        .midi-slider-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 12px;
        }

        .midi-slider-input {
            display: none;
        }

        .midi-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 116, 139, 0.5);
        }

        .midi-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #64748b;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .midi-slider-input:checked + .midi-slider {
            background: rgba(58, 159, 196, 0.3);
            border-color: #3a9fc4;
        }

        .midi-slider-input:checked + .midi-slider::before {
            transform: translateX(26px);
            background: #3a9fc4;
            box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
        }

        .midi-slider-text {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
        }

        .midi-slider-container:hover .midi-slider {
            border-color: rgba(58, 159, 196, 0.7);
        }

        .midi-slider-container:hover .midi-slider::before {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* MIDI设备连接状态样式 */
        .midi-device-status.connected {
            color: #4ade80;
            font-weight: bold;
        }

        .midi-device-status.disconnected {
            color: #f87171;
        }

        /* 全屏选择器样式 */
        .fullscreen-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2a 0%, #2c2c3c 100%);
            z-index: 10000;
            overflow: hidden;
            display: none; /* 默认隐藏 */
            flex-direction: column;
        }

        .fullscreen-selector.active {
            display: flex;
        }

        .fullscreen-selector-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-selector-back {
            background: rgba(58, 159, 196, 0.2);
            border: 1px solid rgba(58, 159, 196, 0.4);
            color: #3a9fc4;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .fullscreen-selector-back:hover {
            background: rgba(58, 159, 196, 0.3);
            border-color: #3a9fc4;
            transform: translateX(-2px);
        }

        .fullscreen-selector-back:active {
            transform: translateX(-4px);
        }

        .fullscreen-selector-title {
            margin: 0;
            font-size: 24px;
            color: #3a9fc4;
            font-weight: 600;
        }

        .fullscreen-selector-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* 选择项网格布局 */
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* 选择项卡片 */
        .selector-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .selector-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(58, 159, 196, 0) 0%, rgba(58, 159, 196, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .selector-item:hover {
            border-color: #3a9fc4;
            background: rgba(58, 159, 196, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(58, 159, 196, 0.2);
        }

        .selector-item:hover::before {
            opacity: 1;
        }

        .selector-item.active {
            background: rgba(58, 159, 196, 0.2);
            border-color: #3a9fc4;
            box-shadow: 0 0 20px rgba(58, 159, 196, 0.4);
        }

        .selector-item-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .selector-item-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.3;
        }

        /* 分组标题 */
        .selector-group-title {
            grid-column: 1 / -1;
            font-size: 14px;
            color: #3a9fc4;
            font-weight: 600;
            margin: 12px 0 8px 0;
            padding: 8px 12px;
            background: rgba(58, 159, 196, 0.1);
            border-left: 3px solid #3a9fc4;
            border-radius: 6px;
        }

        .selector-group-title:first-child {
            margin-top: 0;
        }
        
        /* 分组容器 */
        .selector-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        /* 搜索框样式 */
        .selector-search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto 20px auto;
        }

        .selector-search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            font-size: 16px;
            border: 2px solid rgba(58, 159, 196, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            outline: none;
            transition: all 0.3s ease;
        }

        .selector-search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .selector-search-input:focus {
            border-color: #3a9fc4;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(58, 159, 196, 0.3);
        }

        .selector-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            pointer-events: none;
            opacity: 0.6;
        }

        /* 列表布局（用于乐曲选择） */
        .selector-list {
            max-width: 800px;
            margin: 0 auto;
        }

        .selector-list-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selector-list-item:hover {
            border-color: #3a9fc4;
            background: rgba(58, 159, 196, 0.1);
            transform: translateX(5px);
        }

        .selector-list-item.active {
            background: rgba(58, 159, 196, 0.2);
            border-color: #3a9fc4;
        }

        .selector-list-item-name {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
        }

        .selector-list-item-badge {
            background: rgba(58, 159, 196, 0.3);
            color: #3a9fc4;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .selector-list-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-info-icon {
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .selector-info-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .selector-grid {
                grid-template-columns: 1fr;
            }

            .fullscreen-selector-title {
                font-size: 20px;
            }

            .fullscreen-selector-back {
                padding: 6px 12px;
                font-size: 14px;
            }
        }

    /* 自定义和弦弹窗样式 */
    .custom-chord-btn {
        padding: 13px 20px;
        border: 2px solid rgba(58, 159, 196, 0.5);
        border-radius: 12px;
        background: transparent;
        color: #3a9fc4;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        letter-spacing: 0.5px;
        width: auto;
        /* min-width: 200px; */
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .custom-chord-btn:hover {
        background: rgba(58, 159, 196, 0.15);
        border-color: #3a9fc4;
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(58, 159, 196, 0.3);
    }

    .custom-chord-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(58, 159, 196, 0.2);
    }

    .custom-chords-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2a 0%, #2c2c3c 100%);
        z-index: 10000;
        overflow: hidden;
        display: none; /* 默认隐藏 */
        flex-direction: column;
    }

    .custom-chords-dialog.active {
        display: flex;
    }

    .custom-chords-dialog-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .custom-chords-dialog-header {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .custom-chords-dialog-header h3 {
        margin: 0;
        font-size: 24px;
        color: #3a9fc4;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .close-dialog-btn {
        background: rgba(58, 159, 196, 0.2);
        border: 1px solid rgba(58, 159, 196, 0.4);
        color: #3a9fc4;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .close-dialog-btn:hover {
        background: rgba(58, 159, 196, 0.3);
        border-color: #3a9fc4;
        transform: translateX(-2px);
    }

    .close-dialog-btn:active {
        transform: translateX(-4px);
    }

    .custom-chords-dialog-body {
        flex: 1;
        overflow-y: auto;
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
    }

    .selection-section {
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .selection-section h4 {
        margin: 0 0 15px 0;
        color: #3a9fc4;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .note-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        gap: 8px;
    }

    .note-btn {
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        color: #e2e8f0;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .note-btn:hover {
        background: rgba(58, 159, 196, 0.2);
        border-color: #3a9fc4;
        color: #3a9fc4;
    }

    .note-btn.active {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c);
        border-color: #3a9fc4;
        color: white;
        box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
    }

    .chord-type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
    }

    .custom-chord-type-btn {
        background: rgba(51, 65, 85, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 6px;
        padding: 8px 12px;
        color: #ffffff !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .custom-chord-type-btn:hover {
        background: rgba(58, 159, 196, 0.3) !important;
        border-color: #3a9fc4 !important;
        color: #ffffff !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }

    .custom-chord-type-btn.active {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c) !important;
        border-color: #3a9fc4 !important;
        color: #ffffff !important;
        box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .bass-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }

    .bass-btn {
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 12px 16px;
        color: #e2e8f0;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .bass-btn:hover {
        background: rgba(58, 159, 196, 0.2);
        border-color: #3a9fc4;
        color: #3a9fc4;
    }

    .bass-btn.active {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c);
        border-color: #3a9fc4;
        color: white;
        box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
    }

    .add-chord-section {
        text-align: center;
        margin: 20px 0;
    }

    .add-chord-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        height: fit-content;
    }

    .add-chord-btn:hover {
        background: linear-gradient(135deg, #34d399, #10b981);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .chord-sequence-area {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sequence-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .sequence-name-input {
        flex: 1;
        min-width: 200px;
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px 16px;
        color: #e2e8f0;
        font-size: 14px;
    }

    .sequence-name-input::placeholder {
        color: #94a3b8;
    }

    .sequence-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .action-btn {
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        color: #94a3b8;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: rgba(58, 159, 196, 0.2);
        border-color: #3a9fc4;
        color: #3a9fc4;
    }

    .chord-sequence-display {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 40px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        border: 1px dashed rgba(255, 255, 255, 0.1);
    }

    .chord-item {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chord-item:hover {
        background: linear-gradient(135deg, #4fc3f7, #3a9fc4);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(58, 159, 196, 0.3);
    }

    .remove-chord {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 16px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .remove-chord:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #ff6b6b;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .custom-chords-dialog-header h3 {
            font-size: 20px;
        }
        
        .close-dialog-btn {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .selection-section {
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .note-grid {
            grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
            gap: 8px;
        }
        
        .note-btn {
            padding: 8px 10px;
            font-size: 13px;
        }
        
        .chord-type-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .custom-chord-type-btn {
            padding: 6px 8px;
            font-size: 11px;
            min-height: 32px;
            color: #ffffff !important;
            background: rgba(51, 65, 85, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .bass-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .bass-btn {
            padding: 12px 16px;
            font-size: 14px;
        }
        
        .sequence-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .sequence-actions {
            justify-content: center;
            }
        }

        /* CAGED形状显示区域 */
        .caged-shape-display {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-medium);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* CAGED形状按钮容器 */
        .caged-shape-buttons {
            display: flex;
            flex-direction: row;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

      </style>
</head>

<body>
    <!-- 全屏弹出选择页面 -->
    <div class="fullscreen-selector" id="fullscreenSelector">
        <div class="fullscreen-selector-header">
            <button class="fullscreen-selector-back" id="fullscreenSelectorBack">
                <span>←</span>
                <span data-i18n-key="btn_back">返回</span>
            </button>
            <h2 class="fullscreen-selector-title" id="fullscreenSelectorTitle">选择</h2>
        </div>
        <div class="fullscreen-selector-content" id="fullscreenSelectorContent">
            <!-- 内容将通过JavaScript动态生成 -->
        </div>
    </div>

    <!-- 自定义和弦弹窗 -->
    <div id="customChordsDialog" class="custom-chords-dialog">
        <div class="custom-chords-dialog-content">
            <div class="custom-chords-dialog-header">
                <button class="close-dialog-btn" id="closeCustomChordsDialog">
                    <span>←</span>
                    <span>返回</span>
                </button>
                <h3><i>🎵</i> <span data-i18n-key="custom_chord_title">自定义和弦进行</span></h3>
            </div>
            
            <div class="custom-chords-dialog-body">
                <!-- 根音选择区域 -->
                <div class="selection-section">
                    <h4 data-i18n-key="custom_chord_root">根音</h4>
                    <div class="note-grid" id="rootNoteGrid">
                        <button class="note-btn active" data-note="C">C</button>
                        <button class="note-btn" data-note="C♯">C♯</button>
                        <button class="note-btn" data-note="D♭">D♭</button>
                        <button class="note-btn" data-note="D">D</button>
                        <button class="note-btn" data-note="D♯">D♯</button>
                        <button class="note-btn" data-note="E♭">E♭</button>
                        <button class="note-btn" data-note="E">E</button>
                        <button class="note-btn" data-note="F">F</button>
                        <button class="note-btn" data-note="F♯">F♯</button>
                        <button class="note-btn" data-note="G♭">G♭</button>
                        <button class="note-btn" data-note="G">G</button>
                        <button class="note-btn" data-note="G♯">G♯</button>
                        <button class="note-btn" data-note="A♭">A♭</button>
                        <button class="note-btn" data-note="A">A</button>
                        <button class="note-btn" data-note="A♯">A♯</button>
                        <button class="note-btn" data-note="B♭">B♭</button>
                        <button class="note-btn" data-note="B">B</button>
                    </div>
                </div>

                <!-- 和弦类型选择区域 -->
                <div class="selection-section">
                    <h4 data-i18n-key="custom_chord_type">和弦类型</h4>
                    <div class="chord-type-grid" id="chordTypeGrid">
                        <button class="custom-chord-type-btn active" data-type="major">Major</button>
                        <button class="custom-chord-type-btn" data-type="minor">Minor</button>
                        <button class="custom-chord-type-btn" data-type="diminished">Dim</button>
                        <button class="custom-chord-type-btn" data-type="augmented">Aug</button>
                        <button class="custom-chord-type-btn" data-type="major6">6</button>
                        <button class="custom-chord-type-btn" data-type="minor6">m6</button>
                        <button class="custom-chord-type-btn" data-type="dominant7">7</button>
                        <button class="custom-chord-type-btn" data-type="major7">Maj7</button>
                        <button class="custom-chord-type-btn" data-type="minor7">m7</button>
                        <button class="custom-chord-type-btn" data-type="minor7b5">m7♭5</button>
                        <button class="custom-chord-type-btn" data-type="diminished7">dim7</button>
                        <button class="custom-chord-type-btn" data-type="dominant9">9</button>
                        <button class="custom-chord-type-btn" data-type="major9">Maj9</button>
                        <button class="custom-chord-type-btn" data-type="minor9">m9</button>
                        <button class="custom-chord-type-btn" data-type="dominant7sharp9">7♯9</button>
                        <button class="custom-chord-type-btn" data-type="dominant7flat9">7♭9</button>
                        <button class="custom-chord-type-btn" data-type="dominant11">11</button>
                        <button class="custom-chord-type-btn" data-type="minor11">m11</button>
                        <button class="custom-chord-type-btn" data-type="dominant7sharp11">7♯11</button>
                        <button class="custom-chord-type-btn" data-type="dominant13">13</button>
                        <button class="custom-chord-type-btn" data-type="minor13">m13</button>
                        <button class="custom-chord-type-btn" data-type="sus2">sus2</button>
                        <button class="custom-chord-type-btn" data-type="sus4">sus4</button>
                        <button class="custom-chord-type-btn" data-type="add9">add9</button>
                        <button class="custom-chord-type-btn" data-type="madd9">madd9</button>
                        <button class="custom-chord-type-btn" data-type="6add9">6add9</button>
                        <button class="custom-chord-type-btn" data-type="m6add9">m6add9</button>
                    </div>
                </div>

                <!-- 转位选择区域 -->
                <div class="selection-section">
                    <h4 data-i18n-key="custom_chord_inversion">转位</h4>
                    <div class="bass-grid" id="bassGrid">
                        <button class="bass-btn active" data-bass="root" data-i18n-key="custom_chord_bass_root">根音</button>
                        <button class="bass-btn" data-bass="3rd" data-i18n-key="custom_chord_bass_3rd">三音</button>
                        <button class="bass-btn" data-bass="5th" data-i18n-key="custom_chord_bass_5th">五音</button>
                        <button class="bass-btn" data-bass="7th" data-i18n-key="custom_chord_bass_7th">七音</button>
                    </div>
                </div>

                <!-- 添加和弦按钮 -->
                <div class="add-chord-section">
                    <button class="add-chord-btn" id="addCustomChord">
                        <i>➕</i> <span data-i18n-key="custom_chord_add">添加和弦</span>
                    </button>
                </div>
                
                <!-- 和弦序列显示区域 -->
                <div class="chord-sequence-area">
                    <div class="sequence-header">
                        <input type="text" id="sequenceName" placeholder="输入歌曲名称..." class="sequence-name-input" data-i18n-key="custom_chord_sequence_name" />
                        <div class="sequence-actions">
                            <button class="action-btn" id="clearCustomChords" data-i18n-key="custom_chord_clear">清空</button>
                            <button class="action-btn" id="saveCustomChords" data-i18n-key="custom_chord_save">保存</button>
                            <button class="action-btn" id="loadLocalChords" data-i18n-key="custom_chord_load">加载</button>
                            <button class="action-btn load-practice-btn" id="loadPracticeBtn" data-i18n-key="custom_chord_load_practice">加载练习</button>
                        </div>
                    </div>
                    
                    <div id="customChordSequence" class="chord-sequence-display"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 其他HTML内容保持不变... -->
    <div class="status-indicator status-ready" id="statusIndicator" data-i18n-key="status_ready">准备就绪</div>

    <!-- 键盘快捷键提示 -->
    <div class="shortcut-hint" id="shortcutHint">
        <span data-i18n-key="shortcut_hint">按 <span class="shortcut-key">ESC</span> 返回主菜单</span>
    </div>

    <!-- 实时音高显示 -->
    <div class="pitch-display hidden" id="pitchDisplay">
        <div><span data-i18n-key="pitch_display">音高</span>: --</div>
        <div><span data-i18n-key="cents_display">音分差</span>: 0</div>
        <div class="confidence-bar">
            <div class="confidence-fill confidence-fill-zero"></div>
        </div>
    </div>

    <div class="container" id="mainScreen">
        <div class="header">
            <h1 data-i18n-key="app_title">🎸 吉他指板视觉化练习工具</h1>

        </div>

        <!-- 设置面板 -->
        <div class="settings-panel">
            <!-- 设置内容区域 -->
            <div class="settings-content">

                <!-- CAGED和弦练习设置 - 独立设置面板 -->
                <div class="settings-section caged-chord-settings-section hidden">
                    <div class="settings-section-title">
                        <i>🎸</i> <span data-i18n-key="caged_chord_practice">CAGED和弦练习</span>
                    </div>

                    <!-- CAGED和弦练习模式选择 -->
                    <div class="settings-row">
                        <div class="caged-toggle-container">
                            <label class="caged-slider-container">
                                <input type="checkbox" id="cagedChordModeToggle" class="caged-slider-input">
                                <span class="caged-slider"></span>
                                <span class="caged-slider-text" data-i18n-key="caged_chord_practice">CAGED和弦练习</span>
                            </label>
                        </div>
                    </div>

                    <!-- CAGED和弦设置选项 -->
                    <div id="cagedChordSettings" class="caged-settings hidden">
                        <!-- CAGED形状选择 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_shape">CAGED形状</span>
                            </div>
                            <div class="caged-shape-container">
                                <div class="caged-shape-btn order-btn active" data-shape="C" data-i18n-key="caged_c_shape">C形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="A" data-i18n-key="caged_a_shape">A形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="G" data-i18n-key="caged_g_shape">G形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="E" data-i18n-key="caged_e_shape">E形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="D" data-i18n-key="caged_d_shape">D形状</div>
                            </div>
                        </div>

                        <!-- CAGED和弦练习模式 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_mode">练习模式</span>
                            </div>
                            <div class="order-btn-container">
                                <div class="order-btn caged-chord-mode-btn active" data-mode="connection" data-i18n-key="caged_shape_connection">形状连接</div>
                                <div class="order-btn caged-chord-mode-btn" data-mode="random" data-i18n-key="caged_random_shapes">随机形状</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 和弦设置 -->
                <div class="settings-section chord-settings hidden">
                    <div class="settings-section-title">
                        <i>🎶</i> <span data-i18n-key="settings_chord">和弦设置</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_root_note">根音</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C" >C</option>
                                <option value="C♯" >C♯</option>
                                <option value="D♭" >D♭</option>
                                <option value="D" >D</option>
                                <option value="D♯" >D♯</option>
                                <option value="E♭" >E♭</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="F♯" >F♯</option>
                                <option value="G♭" >G♭</option>
                                <option value="G" >G</option>
                                <option value="G♯" >G♯</option>
                                <option value="A♭" >A♭</option>
                                <option value="A" >A</option>
                                <option value="A♯" >A♯</option>
                                <option value="B♭" >B♭</option>
                                <option value="B" >B</option>
                                <option value="random" selected data-i18n-key="random_root" >随机根音</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_type">和弦类型</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">Dim</div>
                            <div class="chord-type-btn" data-value="augmented">Aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7♭5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7♯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7♭9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7♯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>

                    </div>

                    <!-- 低音音符选择 -->
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_bass_note">低音音符</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordBassNote">
                                <option value="root" data-i18n-key="chord_bass_root">根音</option>
                                <option value="3rd" data-i18n-key="chord_bass_3rd">三音</option>
                                <option value="5th" data-i18n-key="chord_bass_5th">五音</option>
                                <option value="7th" data-i18n-key="chord_bass_7th">七音</option>
                                <option value="random" data-i18n-key="chord_bass_random">随机</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_order">顺序</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered" data-i18n-key="order_ascending">上行</div>
                            <div class="order-btn chord-order-btn" data-value="reverse" data-i18n-key="order_descending">下行</div>
                            <div class="order-btn chord-order-btn" data-value="random" data-i18n-key="order_random">随机</div>
                        </div>
                    </div>


                </div>

                <!-- 和弦转换设置 -->
                <div class="settings-section progression-settings hidden">
                    <div class="settings-section-title">
                        <i>🎶</i> <span data-i18n-key="progression_settings">转换设置</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_level">练习等级</span>
                        </div>
                        <!-- 隐藏的原生select -->
                        <select id="progressionLevel" class="hidden">
                            <option value="single-root">1</option>
                            <option value="single-3">3</option>
                            <option value="single-5">5</option>
                            <option value="single-7">7</option>
                            <option value="double-root-3">1,3</option>
                            <option value="double-root-5">1,5</option>
                            <option value="double-root-7">1,7</option>
                            <option value="double-3-5">3,5</option>
                            <option value="double-3-7">3,7</option>
                            <option value="triple-root-3-5" selected>1,3,5</option>
                            <option value="triple-3-5-7">3,5,7</option>
                            <option value="triple-random-inversion">1,3,5随机转位</option>
                            <option value="quad-root-3-5-7">1,3,5,7</option>
                            <option value="quad-3-5-7-root">3,5,7,1</option>
                            <option value="quad-5-7-root-3">5,7,1,3</option>
                            <option value="quad-7-root-3-5">7,1,3,5</option>
                            <option value="quad-random-inversion">1,3,5,7随机转位</option>
                            <option value="quad-root-3-5-7-root">1,3,5,7,1</option>
                            <option value="all-notes">全部</option>
                        </select>

                        <!-- 自定义下拉列表 -->
                        <div class="custom-dropdown" id="progressionLevelDropdown">
                            <div class="dropdown-trigger">
                                <span class="dropdown-text">1,3,5</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <ul class="dropdown-menu">
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_single_notes">单和弦音</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="single-root">
                                            <span class="item-text">1</span>
                                            <span class="info-icon" data-info="single-root-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="single-3">
                                            <span class="item-text">3</span>
                                            <span class="info-icon" data-info="single-3-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="single-5">
                                            <span class="item-text">5</span>
                                            <span class="info-icon" data-info="single-5-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="single-7">
                                            <span class="item-text">7</span>
                                            <span class="info-icon" data-info="single-7-info">ℹ️</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_double_notes">双和弦音</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="double-root-3">
                                            <span class="item-text">1,3</span>
                                            <span class="info-icon" data-info="double-root-3-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-root-5">
                                            <span class="item-text">1,5</span>
                                            <span class="info-icon" data-info="double-root-5-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-root-7">
                                            <span class="item-text">1,7</span>
                                            <span class="info-icon" data-info="double-root-7-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-3-5">
                                            <span class="item-text">3,5</span>
                                            <span class="info-icon" data-info="double-3-5-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-3-7">
                                            <span class="item-text">3,7</span>
                                            <span class="info-icon" data-info="double-3-7-info">ℹ️</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_triple_notes">三和弦音</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item active" data-value="triple-root-3-5">
                                            <span class="item-text">1,3,5</span>
                                            <span class="info-icon" data-info="triple-root-3-5-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="triple-3-5-7">
                                            <span class="item-text">3,5,7</span>
                                            <span class="info-icon" data-info="triple-3-5-7-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="triple-random-inversion">
                                            <span class="item-text">1,3,5随机转位</span>
                                            <span class="info-icon" data-info="triple-random-inversion-info">ℹ️</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_quad_notes">四和弦音</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="quad-root-3-5-7">
                                            <span class="item-text">1,3,5,7</span>
                                            <span class="info-icon" data-info="quad-root-3-5-7-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-3-5-7-root">
                                            <span class="item-text">3,5,7,1</span>
                                            <span class="info-icon" data-info="quad-3-5-7-root-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-5-7-root-3">
                                            <span class="item-text">5,7,1,3</span>
                                            <span class="info-icon" data-info="quad-5-7-root-3-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-7-root-3-5">
                                            <span class="item-text">7,1,3,5</span>
                                            <span class="info-icon" data-info="quad-7-root-3-5-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-random-inversion">
                                            <span class="item-text">1,3,5,7随机转位</span>
                                            <span class="info-icon" data-info="quad-random-inversion-info">ℹ️</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-root-3-5-7-root">
                                            <span class="item-text">1,3,5,7,1</span>
                                            <span class="info-icon" data-info="quad-root-3-5-7-root-info">ℹ️</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_all_notes">全部和弦音</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="all-notes">
                                            <span class="item-text">全部</span>
                                            <span class="info-icon" data-info="all-notes-info">ℹ️</span>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_tunes">乐曲</span>
                        </div>
                        <div class="select-wrapper">
                            <!-- 隐藏的原生select -->
                            <select id="jazzStandard" class="hidden">
                                
                                <optgroup label="5" >
                                    <option value="500 Miles High" >500 Miles High</option>
                                </optgroup>
                                <optgroup label="A" >
                                    <option value="All The Things You Are" >All The Things You Are</option>
                                    <option value="Autumn Leaves" >Autumn Leaves</option>
                                    <option value="All Of Me"  selected>All Of Me</option>
                                    <option value="A Night In Tunisia" >A Night In Tunisia</option>
                                    <option value="All of You" >All of You</option>
                                    <option value="Alone Together" >Alone Together</option>
                                    <option value="Ambleside" >Ambleside</option>
                                    <option value="Anthropology" >Anthropology</option>
                                    <option value="Ask Me Now" >Ask Me Now</option>
                                </optgroup>
                                <optgroup label="B" >
                                    <option value="Blue Moon" >Blue Moon</option>
                                    <option value="Body And Soul" >Body And Soul</option>
                                    <option value="Bye Bye Blackbird" >Bye Bye Blackbird</option>
                                    <option value="Beautiful Love" >Beautiful Love</option>
                                    <option value="Blue Bossa" >Blue Bossa</option>
                                    <option value="Blue in Green" >Blue in Green</option>
                                    <option value="Blues for Alice" >Blues for Alice</option>
                                </optgroup>
                                <optgroup label="C" >
                                    <option value="Cherokee" >Cherokee</option>
                                    <option value="Come Rain Or Come Shine" >Come Rain Or Come Shine</option>
                                    <option value="Confirmation" >Confirmation</option>
                                    <option value="Coral" >Coral</option>
                                    <option value="Corcovado" >Corcovado</option>
                                    <option value="Countdown" >Countdown</option>
                                </optgroup>
                                <optgroup label="D" >
                                    <option value="Days Of Wine And Roses" >Days Of Wine And Roses</option>
                                    <option value="Donna Lee" >Donna Lee</option>
                                    <option value="Doxy" >Doxy</option>
                                    <option value="Dream A Little Dream" >Dream A Little Dream</option>
                                </optgroup>
                                <optgroup label="F" >
                                    <option value="Fall" >Fall</option>
                                    <option value="Falling Grace" >Falling Grace</option>
                                    <option value="Fly Me To The Moon" >Fly Me To The Moon</option>
                                    <option value="Four" >Four</option>
                                    <option value="Footprints" >Footprints</option>
                                </optgroup>
                                <optgroup label="G" >
                                    <option value="Giant Steps" >Giant Steps</option>
                                    <option value="Georgia On My Mind" >Georgia On My Mind</option>
                                    <option value="Girl From Ipanema" >Girl From Ipanema</option>
                                </optgroup>
                                <optgroup label="H" >
                                    <option value="Have You Met Miss Jones" >Have You Met Miss Jones</option>
                                    <option value="Here's That Rainy Day" >Here's That Rainy Day</option>
                                    <option value="How High The Moon" >How High The Moon</option>
                                </optgroup>
                                <optgroup label="I" >
                                    <option value="I Got Rhythm" >I Got Rhythm</option>
                                    <option value="I Can't Get Started" >I Can't Get Started</option>
                                    <option value="In A Sentimental Mood" >In A Sentimental Mood</option>
                                    <option value="Infant Eyes" >Infant Eyes</option>
                                    <option value="Inner Urge" >Inner Urge</option>
                                </optgroup>
                                <optgroup label="J" >
                                    <option value="Just Friends" >Just Friends</option>
                                    <option value="Joy Spring" >Joy Spring</option>
                                    <option value="Jordu" >Jordu</option>
                                </optgroup>
                                <optgroup label="L" >
                                    <option value="Lady Bird" >Lady Bird</option>
                                    <option value="Love For Sale" >Love For Sale</option>
                                    <option value="Lover Man" >Lover Man</option>
                                </optgroup>
                                <optgroup label="M" >
                                    <option value="Misty" >Misty</option>
                                    <option value="My Funny Valentine" >My Funny Valentine</option>
                                    <option value="Maiden Voyage" >Maiden Voyage</option>
                                </optgroup>
                                <optgroup label="N" >
                                    <option value="Night And Day" >Night And Day</option>
                                    <option value="Nardis" >Nardis</option>
                                    <option value="Night Train" >Night Train</option>
                                </optgroup>
                                <optgroup label="O" >
                                    <option value="Oleo" >Oleo</option>
                                </optgroup>
                                <optgroup label="S" >
                                    <option value="Someday My Prince Will Come" >Someday My Prince Will Come</option>
                                    <option value="Spain" >Spain</option>
                                    <option value="Stella By Starlight" >Stella By Starlight</option>
                                    <option value="Summertime" >Summertime</option>
                                    <option value="Solar" >Solar</option>
                                </optgroup>
                                <optgroup label="T" >
                                    <option value="Take Five" >Take Five</option>
                                    <option value="Take the A-Train" >Take the A-Train</option>
                                    <option value="There Will Never Be Another You" >There Will Never Be Another You</option>
                                    <option value="The Way You Look Tonight" >The Way You Look Tonight</option>
                                    <option value="Time Remembered" >Time Remembered</option>
                                </optgroup>
                                <optgroup label="V" >
                                    <option value="Very Early" >Very Early</option>
                                    <option value="Virgo" >Virgo</option>
                                </optgroup>
                                <optgroup label="练习" >
                                    <option value="练习1 - Maj7和弦(12个调)" >练习1 - Maj7和弦(12个调)</option>
                                    <option value="练习2 - Min7和弦(12个调)" >练习2 - Min7和弦(12个调)</option>
                                    <option value="练习3 - Sus4b9和弦(12个调)" >练习3 - Sus4b9和弦(12个调)</option>
                                    <option value="练习4 - Maj7#11和弦(12个调)" >练习4 - Maj7#11和弦(12个调)</option>
                                    <option value="练习5 - 7sus4和弦(12个调)" >练习5 - 7sus4和弦(12个调)</option>
                                    <option value="练习5a - Dom7和弦(12个调)" >练习5a - Dom7和弦(12个调)</option>
                                    <option value="练习6 - Min7b5和弦(12个调)" >练习6 - Min7b5和弦(12个调)</option>
                                    <option value="练习7 - MinMaj7和弦(12个调)" >练习7 - MinMaj7和弦(12个调)</option>
                                    <option value="练习8 - 13sus4b9和弦(12个调)" >练习8 - 13sus4b9和弦(12个调)</option>
                                    <option value="练习9 - Maj7#5和弦(12个调)" >练习9 - Maj7#5和弦(12个调)</option>
                                    <option value="练习10 - 7#11和弦(12个调)" >练习10 - 7#11和弦(12个调)</option>
                                    <option value="练习11 - Min7b5♮9和弦(12个调)" >练习11 - Min7b5♮9和弦(12个调)</option>
                                    <option value="练习12 - 13b9和弦(12个调)" >练习12 - 13b9和弦(12个调)</option>
                                </optgroup>
                            </select>
                            
                            <!-- 自定义乐曲下拉列表 - 将通过JavaScript动态生成 -->
                            <div class="custom-dropdown" id="jazzStandardDropdown">
                                <div class="dropdown-trigger">
                                    <span class="dropdown-text">All Of Me</span>
                                    <span class="dropdown-arrow">▼</span>
                        </div>
                                <ul class="dropdown-menu">
                                    <!-- 歌曲列表将通过JavaScript动态生成 -->
                                </ul>
                        </div>
                    </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_key_label">调</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="progressionKey" class="hidden">
                                <option value="C" >C</option>
                                <option value="C♯" >C♯</option>
                                <option value="D♭" >D♭</option>
                                <option value="D" >D</option>
                                <option value="D♯" >D♯</option>
                                <option value="E♭" >E♭</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="F♯" >F♯</option>
                                <option value="G♭" >G♭</option>
                                <option value="G" >G</option>
                                <option value="G♯" >G♯</option>
                                <option value="A♭" >A♭</option>
                                <option value="A" >A</option>
                                <option value="A♯" >A♯</option>
                                <option value="B♭" >B♭</option>
                                <option value="B" >B</option>
                            </select>
                            
                            <!-- 自定义调性下拉列表 -->
                            <div class="custom-dropdown" id="progressionKeyDropdown">
                                <div class="dropdown-trigger">
                                    <span class="dropdown-text" data-i18n-key="key_c_default">C 默认</span>
                                    <span class="dropdown-arrow">▼</span>
                        </div>
                                <ul class="dropdown-menu">
                                    <!-- 调性列表将通过JavaScript动态生成 -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_order">顺序</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn progression-order-btn active" data-value="ordered" data-i18n-key="order_ordered">顺序</div>
                            <div class="order-btn progression-order-btn" data-value="reverse" data-i18n-key="order_reverse">倒序</div>
                            <div class="order-btn progression-order-btn" data-value="random" data-i18n-key="order_random">随机</div>
                    </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_repeat">重复练习</span>
                        </div>
                        <label class="midi-slider-container">
                            <input type="checkbox" id="enableRepeat" class="midi-slider-input">
                            <span class="midi-slider"></span>
                        </label>
                    </div>

                    <!-- 自定义和弦进行控件 -->
                    <div class="settings-section-title settings-section-spacing">
                        <i>🎵</i> <span data-i18n-key="custom_chord_progression">自定义和弦进行</span>
                    </div>
                    
                    
                    <div class="settings-row">

                        <button id="openCustomChordsDialog" class="custom-chord-btn" data-i18n-key="btn_custom_chords">
                            <i>🎵</i> 自定义和弦进行
                        </button>
                    </div>

                </div>

                <!-- 找音练习设置 -->
                <div class="settings-section pitch-finding-settings hidden">
                    <div class="settings-section-title">
                        <i>📏</i> <span data-i18n-key="settings_pitch_finding">音程练习设置</span>
                    </div>

                    <!-- 练习模式选择 -->
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="practice_mode">练习模式</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn practice-mode-btn active" data-mode="single" data-i18n-key="single_note_practice">找音练习</div>
                            <div class="order-btn practice-mode-btn" data-mode="interval" data-i18n-key="note_interval_practice">音程练习</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_practice_time">练习时间</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="pitchFindingTime">
                                <option value="1"  data-i18n-key="pitch_finding_1_minute">1分钟</option>
                                <option value="2"  data-i18n-key="pitch_finding_2_minutes">2分钟</option>
                                <option value="3"  data-i18n-key="pitch_finding_3_minutes">3分钟</option>
                                <option value="5" selected  data-i18n-key="pitch_finding_5_minutes">5分钟</option>
                                <option value="10"  data-i18n-key="pitch_finding_10_minutes">10分钟</option>
                                <option value="15"  data-i18n-key="pitch_finding_15_minutes">15分钟</option>
                                <option value="30"  data-i18n-key="pitch_finding_30_minutes">30分钟</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_show_fretboard">显示指板</span>
                        </div>
                        <div class="settings-control-group">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="showFretboard" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                        </label>
                            <div class="keyboard-hint-inline">
                                <span class="hint-text-inline" data-i18n-key="fretboard_keyboard_hint">
                                    💡 <kbd>↓</kbd><span data-i18n-key="keyboard_hide">隐藏</span> <kbd>↑</kbd><span data-i18n-key="keyboard_show">显示</span> <kbd><span data-i18n-key="keyboard_space">空格</span></kbd><span data-i18n-key="keyboard_next">下一个</span>
                                </span>
                            </div>
                        </div>
                    </div>


                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_fretboard_range">指板长度</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn pitch-finding-range-btn active" data-value="12" data-i18n-key="pitch_finding_12_frets">12品</div>
                            <div class="order-btn pitch-finding-range-btn" data-value="15" data-i18n-key="pitch_finding_15_frets">15品</div>
                            <div class="order-btn pitch-finding-range-btn" data-value="18" data-i18n-key="pitch_finding_18_frets">18品</div>
                            <div class="order-btn pitch-finding-range-btn" data-value="24" data-i18n-key="pitch_finding_24_frets">24品</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_next_interval">下一题间隔</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn pitch-finding-interval-btn" data-value="0" data-i18n-key="pitch_finding_no_auto">不自动</div>
                            <div class="order-btn pitch-finding-interval-btn active" data-value="2" data-i18n-key="pitch_finding_2_seconds">2秒</div>
                            <div class="order-btn pitch-finding-interval-btn" data-value="3" data-i18n-key="pitch_finding_3_seconds">3秒</div>
                            <div class="order-btn pitch-finding-interval-btn" data-value="5" data-i18n-key="pitch_finding_5_seconds">5秒</div>
                        </div>
                    </div>

                    <!-- 音程练习设置 -->
                    <div id="intervalSettings" class="interval-settings hidden">
                        <!-- 音程选择 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="interval_selection">选择音程</span>
                            </div>
                            <div class="interval-grid">
                                <div class="interval-btn" data-interval="♭2">♭2</div>
                                <div class="interval-btn" data-interval="2">2</div>
                                <div class="interval-btn" data-interval="♯2">♯2</div>
                                <div class="interval-btn" data-interval="♭3">♭3</div>
                                <div class="interval-btn" data-interval="3">3</div>
                                <div class="interval-btn" data-interval="4">4</div>
                                <div class="interval-btn" data-interval="♯4">♯4</div>
                                <div class="interval-btn" data-interval="♭5">♭5</div>
                                <div class="interval-btn" data-interval="5">5</div>
                                <div class="interval-btn" data-interval="♯5">♯5</div>
                                <div class="interval-btn" data-interval="♭6">♭6</div>
                                <div class="interval-btn" data-interval="6">6</div>
                                <div class="interval-btn" data-interval="♯6">♯6</div>
                                <div class="interval-btn" data-interval="♭7">♭7</div>
                                <div class="interval-btn" data-interval="7">7</div>
                                <div class="interval-btn" data-interval="♭♭7">♭♭7</div>
                                <div class="interval-btn" data-interval="♭9">♭9</div>
                                <div class="interval-btn" data-interval="9">9</div>
                                <div class="interval-btn" data-interval="♯9">♯9</div>
                                <div class="interval-btn" data-interval="11">11</div>
                                <div class="interval-btn" data-interval="♯11">♯11</div>
                                <div class="interval-btn" data-interval="♭13">♭13</div>
                                <div class="interval-btn" data-interval="13">13</div>
                            </div>
                        </div>

                        <!-- 根音设置 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="root_note_setting">设置根音</span>
                            </div>
                            <div class="select-wrapper">
                                <select id="rootNoteSelect" class="custom-select">
                                    <option value="random" data-i18n-key="random">随机</option>
                                    <option value="C">C</option>
                                    <option value="C♯">C♯</option>
                                    <option value="D♭">D♭</option>
                                    <option value="D">D</option>
                                    <option value="D♯">D♯</option>
                                    <option value="E♭">E♭</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="F♯">F♯</option>
                                    <option value="G♭">G♭</option>
                                    <option value="G">G</option>
                                    <option value="G♯">G♯</option>
                                    <option value="A♭">A♭</option>
                                    <option value="A">A</option>
                                    <option value="A♯">A♯</option>
                                    <option value="B♭">B♭</option>
                                    <option value="B">B</option>
                                </select>
                            </div>
                        </div>

                        <!-- 先找根音开关 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="find_root_first">先找根音</span>
                            </div>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="findRootFirst" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                    </div>

                </div>

                <!-- 设置 -->
                <div class="settings-section device-settings hidden">
                    <div class="settings-section-title">
                        <i>🎤</i> <span data-i18n-key="settings_device">音频输入设置</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="device_audio_input">音频输入设备</span>
                        </div>

                    </div>
                    <div
                        class="device-settings-flex">
                        <select id="audioInputDevice" class="audio-device-select"></select>
                        <button class="btn" id="refreshDevicesBtn"
                            class="refresh-device-btn" data-i18n-key="btn_refresh">刷新设备列表</button>
                    </div>

                    <div class="device-info" id="deviceInfo" data-i18n-key="hint_select_device">
                        检测到设备后，请选择您的USB音频接口
                    </div>
                    <div class="settings-row settings-row-spacing">
                        <div class="settings-label">
                            <span data-i18n-key="device_gain">输入增益</span>
                        </div>
                        <div class="gain-control">
                            <input type="range" id="inputGain" min="0" max="200" value="100">
                            <span class="gain-value" id="inputGainValue">100%</span>
                        </div>
                    </div>

                    <div class="settings-row settings-row-spacing">
                        <div class="settings-label">
                            <span data-i18n-key="device_sensitivity">音高检测敏感度</span>
                        </div>
                        <div class="settings-flex">
                            <input type="range" id="sensitivity" min="0.1" max="1.0" step="0.1" value="0.5"
                                class="settings-flex-item">
                            <span id="sensitivityValue"
                                class="volume-label">0.5</span>
                        </div>
                    </div>

                    <div class="settings-row settings-row-bottom">
                        <div class="settings-label">
                            <span data-i18n-key="device_confidence">置信度阈值</span>
                        </div>
                        <div class="settings-flex">
                            <input type="range" id="confidenceThreshold" min="0.3" max="0.9" step="0.1" value="0.6"
                                class="settings-flex-item">
                            <span id="confidenceThresholdValue"
                                class="volume-label">0.6</span>
                        </div>
                    </div>

                    <div class="settings-section-title mt-md">
                        <i>⚙️</i> <span data-i18n-key="practice_settings">练习设置</span>
                    </div>
                    
                    <!-- 冷却时间设置 -->
                    <div class="metronome-controls">
                        <div class="metronome-left">
                            <span class="switch-label" data-i18n-key="device_cooldown">麦克风冷却时间</span>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="enableCooldown" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                        <div class="metronome-right">
                            <span class="time-label" data-i18n-key="time_label">时间:</span>
                            <input type="range" id="cooldownDuration" min="200" max="3000" step="100" value="600"
                                class="time-slider">
                            <span id="cooldownDurationValue"
                                class="time-display">600ms</span>
                        </div>
                    </div>

                    <!-- 固定延迟生成下一题设置 -->
                    <div class="metronome-controls">
                        <div class="metronome-left">
                            <span class="switch-label" data-i18n-key="fixed_delay_generation">延迟生成下一题</span>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="enableFixedDelay" class="midi-slider-input">
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                        <div class="metronome-right">
                            <span class="time-label" data-i18n-key="time_label">时间:</span>
                            <input type="range" id="fixedDelayDuration" min="500" max="2000" step="100" value="800"
                                class="time-slider">
                            <span id="fixedDelayDurationValue"
                                class="time-display">800ms</span>
                        </div>
                    </div>



                    <div class="settings-section-title mt-md">
                        <i>🎯</i> <span data-i18n-key="metronome_settings">节拍器设置</span>
                    </div>
                    <div
                        class="metronome-controls">
                        <div class="metronome-left">
                            <span class="switch-label" data-i18n-key="device_metronome">启用节拍器</span>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="metronomeToggle" class="midi-slider-input">
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                        <div class="metronome-right">
                            <span class="time-label" data-i18n-key="device_tempo">速度:</span>
                            <input type="range" id="metronomeTempo" min="20" max="120" step="1" value="40"
                                class="time-slider">
                            <span id="metronomeTempoValue"
                                class="min-w-sm text-right text-sm">40</span>
                        </div>
                    </div>
                    
                    <!-- 节拍器选项 -->
                    <div class="flex-container flex-gap-md mb-sm ml-md">
                        <div class="flex-container flex-gap-sm flex-align-center">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="metronomeFlashToggle" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                            <span class="switch-label" data-i18n-key="background_flash">背景闪光</span>
                        </div>
                        <div class="flex-container flex-gap-sm flex-align-center">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="metronomeSoundToggle" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                            <span class="switch-label" data-i18n-key="sound_metronome">声音节拍</span>
                        </div>
                    </div>

                    <!-- MIDI设备支持 -->
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="midi_support">MIDI设备支持</span>
                        </div>
                        <div class="midi-toggle-container">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="midiToggle" class="midi-slider-input">
                                <span class="midi-slider"></span>
                                <span class="midi-slider-text" data-i18n-key="midi_enable">MIDI设备</span>
                            </label>
                        </div>
                    </div>

                    <!-- MIDI设备信息 -->
                    <div id="midiDeviceInfo" class="midi-device-info hidden">
                        <div class="midi-device-status">
                            <span id="midiDeviceStatus">未检测到MIDI设备</span>
                        </div>
                        <div class="midi-device-list" id="midiDeviceList">
                            <!-- MIDI设备列表将在这里显示 -->
                        </div>
                    </div>
                    
                    <!-- 语言设置 -->
                    <div class="settings-section-title mt-md">
                        <i>🌍</i> <span data-i18n-key="general_language">语言设置</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="interface_language">语言 / Language</span>
                        </div>
                        <div class="flex-container flex-gap-lg flex-1">
                            <button id="langZhBtn" class="btn btn-lang">中文</button>
                            <button id="langEnBtn" class="btn btn-lang">English</button>
                        </div>
                    </div>

                    <!-- 主题设置 -->
                    <div class="settings-section-title mt-md">
                        <i>🎨</i> <span data-i18n-key="general_theme">主题设置</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="general_theme_hint">选择界面主题</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn theme-btn active" data-theme="dark" data-i18n-key="theme_dark">深色主题</div>
                            <div class="order-btn theme-btn" data-theme="light" data-i18n-key="theme_light">浅色主题</div>
                            <div class="order-btn theme-btn" data-theme="auto" data-i18n-key="theme_auto">跟随系统</div>
                        </div>
                    </div>
                    
                    <!-- 和弦名显示设置 -->
                    <div class="settings-section-title mt-md">
                        <i>🎵</i> <span data-i18n-key="chord_name_display">和弦名显示</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_name_display_hint">选择和弦名称的显示方式</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-name-display-btn active" data-value="english" data-i18n-key="chord_name_english">英文名</div>
                            <div class="order-btn chord-name-display-btn" data-value="symbols" data-i18n-key="chord_name_symbols">符号名</div>
                        </div>
                    </div>
                    
                    <!-- 设置管理 -->
                    <div class="settings-section-title mt-md">
                        <i>😎</i> <span data-i18n-key="settings_management">设置管理</span>
                    </div>
                    <div class="flex-container flex-gap-lg mt-sm">
                        <button id="resetSettingsBtn" class="btn-danger">
                            <span data-i18n-key="btn_reset">重置所有设置</span>
                        </button>
                    </div>
                    <div class="text-xs text-secondary mt-sm text-center">
                        <span data-i18n-key="reset_settings_hint">点击重置按钮将恢复所有设置为默认值</span>
                    </div>
                </div>

                <!-- CAGED练习设置 - 独立设置面板 -->
                <div class="settings-section caged-settings-section hidden">
                    <div class="settings-section-title">
                        <i>🎸</i> <span data-i18n-key="caged_practice">CAGED练习</span>
                    </div>

                    <!-- CAGED练习模式选择 -->
                    <div class="settings-row">

                        <div class="caged-toggle-container">
                            <label class="caged-slider-container">
                                <input type="checkbox" id="cagedModeToggle" class="caged-slider-input">
                                <span class="caged-slider"></span>
                                <span class="caged-slider-text" data-i18n-key="caged_practice_mode">CAGED练习模式</span>
                            </label>
                        </div>
                    </div>

                    <!-- CAGED设置选项 -->
                    <div id="cagedSettings" class="caged-settings hidden">

                        <!-- CAGED形状选择 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_shape">CAGED形状</span>
                            </div>
                            <div class="caged-shape-container">
                                <div class="caged-shape-btn order-btn active" data-shape="C" data-i18n-key="caged_c_shape">C形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="A" data-i18n-key="caged_a_shape">A形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="G" data-i18n-key="caged_g_shape">G形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="E" data-i18n-key="caged_e_shape">E形状</div>
                                <div class="caged-shape-btn order-btn active" data-shape="D" data-i18n-key="caged_d_shape">D形状</div>
                            </div>
                        </div>

                        <!-- CAGED练习模式 -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_mode">练习模式</span>
                            </div>
                            <div class="order-btn-container">
                                <div class="order-btn caged-mode-btn active" data-mode="connection" data-i18n-key="caged_shape_connection">形状连接</div>
                                <div class="order-btn caged-mode-btn" data-mode="random" data-i18n-key="caged_random_shapes">随机形状</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- 音阶设置 - 只在音阶练习标签页显示 -->
                <div class="settings-section scale-settings hidden">
                    <div class="settings-section-title">
                        <i>🎵</i> <span data-i18n-key="settings_scale">音阶练习选项</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_root_note">调</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="rootNote">
                                <option value="C" >C</option>
                                <option value="C♯" >C♯</option>
                                <option value="D♭" >D♭</option>
                                <option value="D" >D</option>
                                <option value="D♯" >D♯</option>
                                <option value="E♭" >E♭</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="F♯" >F♯</option>
                                <option value="G♭" >G♭</option>
                                <option value="G" >G</option>
                                <option value="G♯" >G♯</option>
                                <option value="A♭" >A♭</option>
                                <option value="A" >A</option>
                                <option value="A♯" >A♯</option>
                                <option value="B♭" >B♭</option>
                                <option value="B" >B</option>
                                <option value="random" selected data-i18n-key="random" >随机</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_type">调式</span>
                        </div>
                        <div class="multiselect-dropdown">
                            <div class="dropdown-trigger" id="scaleTypeDropdown">
                                <div class="dropdown-display">
                                    <span class="selected-text">选择调式...</span>
                                    <span class="dropdown-arrow">▼</span>
                                </div>
                            </div>
                            <div class="dropdown-content" id="scaleTypeDropdownContent">
                                <div class="dropdown-controls">
                                    <button type="button" class="dropdown-btn" id="selectAllScales">全选</button>
                                    <button type="button" class="dropdown-btn" id="deselectAllScales">全不选</button>
                                    <button type="button" class="dropdown-btn" id="randomSelectScales">随机选择</button>
                                </div>

                                <div class="dropdown-groups">
                                    <!-- 基本调式 -->
                                    <div class="dropdown-group">
                                        <div class="group-header">基本调式</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="major">
                                            <span class="option-text">
                                                <span class="scale-name">Major - 1 2 3 4 5 6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="minor">
                                            <span class="option-text">
                                                <span class="scale-name">Minor - 1 2 ♭3 4 5 ♭6 ♭7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- 教会调式 -->
                                    <div class="dropdown-group">
                                        <div class="group-header">教会调式</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="ionian">
                                            <span class="option-text">
                                                <span class="scale-name">Ionian - 1 2 3 4 5 6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="dorian">
                                            <span class="option-text">
                                                <span class="scale-name">Dorian - 1 2 ♭3 4 5 6 ♭7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="phrygian">
                                            <span class="option-text">
                                                <span class="scale-name">Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="lydian">
                                            <span class="option-text">
                                                <span class="scale-name">Lydian - 1 2 3 ♯4 5 6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="mixolydian">
                                            <span class="option-text">
                                                <span class="scale-name">Mixolydian - 1 2 3 4 5 6 ♭7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="aeolian">
                                            <span class="option-text">
                                                <span class="scale-name">Aeolian - 1 2 ♭3 4 5 ♭6 ♭7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="locrian">
                                            <span class="option-text">
                                                <span class="scale-name">Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- 小调系列 -->
                                    <div class="dropdown-group">
                                        <div class="group-header">小调系列</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="harmonicMinor">
                                            <span class="option-text">
                                                <span class="scale-name">Harmonic Minor - 1 2 ♭3 4 5 ♭6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="melodicMinor">
                                            <span class="option-text">
                                                <span class="scale-name">Melodic Minor - 1 2 ♭3 4 5 6 7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- 五声音阶 -->
                                    <div class="dropdown-group">
                                        <div class="group-header">五声音阶</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="majorPentatonic">
                                            <span class="option-text">
                                                <span class="scale-name">Major Pentatonic - 1 2 3 5 6</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="minorPentatonic">
                                            <span class="option-text">
                                                <span class="scale-name">Minor Pentatonic - 1 ♭3 4 5 ♭7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- 其他音阶 -->
                                    <div class="dropdown-group">
                                        <div class="group-header">其他音阶</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="blues">
                                            <span class="option-text">
                                                <span class="scale-name">Blues - 1 ♭3 4 ♯4 5 ♭7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="wholeTone">
                                            <span class="option-text">
                                                <span class="scale-name">Whole Tone - 1 2 3 ♯4 ♯5 ♯6</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="diminished">
                                            <span class="option-text">
                                                <span class="scale-name">Diminished - 1 ♭2 ♭3 3 ♯4 5 6 ♭7</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 隐藏的select元素用于兼容现有代码 -->
                        <select id="scaleType" class="hidden-select">
                            <option value="major" selected>Major</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_direction">方向</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-order-btn active" data-value="ordered" data-i18n-key="order_ascending">上行</div>
                            <div class="order-btn scale-order-btn" data-value="reverse" data-i18n-key="order_descending">下行</div>
                            <div class="order-btn scale-order-btn" data-value="random" data-i18n-key="order_random">随机</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_practice_sequence">练习序列</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-arpeggio-btn active" data-value="1to1">1→1</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="3to3" id="arpeggio-3-btn">3→3</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="5to5" id="arpeggio-5-btn">5→5</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="7to7" id="arpeggio-7-btn">7→7</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="random-arpeggio" data-i18n-key="scale_random">随机</div>
                        </div>
                    </div>

                    <script>
                    // 直接在页面中定义scaleTypes对象，避免模块导入问题
                    window.scaleTypes = {
                        // 大调系列
                        'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'minor': { name: 'Minor', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                        
                        // 教会调式 (Church Modes)
                        'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'dorian': { name: 'Dorian - 1 2 ♭3 4 5 6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '6', '♭7'] },
                        'phrygian': { name: 'Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '♭7'] },
                        'lydian': { name: 'Lydian - 1 2 3 ♯4 5 6 7', intervals: ['1', '2', '3', '♯4', '5', '6', '7'] },
                        'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 ♭7', intervals: ['1', '2', '3', '4', '5', '6', '♭7'] },
                        'aeolian': { name: 'Aeolian - 1 2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                        'locrian': { name: 'Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '♭5', '♭6', '♭7'] },
                        
                        // 和声小调系列
                        'harmonicMinor': { name: 'Harmonic Minor - 1 2 ♭3 4 5 ♭6 7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '7'] },
                        'dorianSharp2': { name: 'Dorian ♯2 - 1 ♯2 3 4 5 6 ♭7', intervals: ['1', '♯2', '3', '4', '5', '6', '♭7'] },
                        'phrygianMajor': { name: 'Phrygian Major - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                        'lydianSharp2': { name: 'Lydian ♯2 - 1 ♯2 3 ♯4 5 6 7', intervals: ['1', '♯2', '3', '♯4', '5', '6', '7'] },
                        'mixolydianFlat6': { name: 'Mixolydian ♭6 - 1 2 3 4 5 ♭6 ♭7', intervals: ['1', '2', '3', '4', '5', '♭6', '♭7'] },
                        'lydianFlat2': { name: 'Lydian ♭2 - 1 ♭2 3 ♯4 5 6 7', intervals: ['1', '♭2', '3', '♯4', '5', '6', '7'] },
                        'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 ♭2 ♭3 ♭4 ♭5 ♭6 6', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '6'] },

                        // 旋律小调系列
                        'melodicMinor': { name: 'Melodic Minor - 1 2 ♭3 4 5 6 7', intervals: ['1', '2', '♭3', '4', '5', '6', '7'] },
                        'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 ♭7 ♭6 5 4 ♭3 2 1', intervals: ['1', '♭7', '♭6', '5', '4', '♭3', '2', '1'] },
                        'dorianFlat2': { name: 'Dorian ♭2 - 1 ♭2 ♭3 4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '6', '♭7'] },
                        'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 ♯4 ♯5 6 7', intervals: ['1', '2', '3', '♯4', '♯5', '6', '7'] },
                        'lydianFlat7': { name: 'Lydian ♭7 - 1 2 3 ♯4 5 6 ♭7', intervals: ['1', '2', '3', '♯4', '5', '6', '♭7'] },
                        'aeolianFlat5': { name: 'Aeolian ♭5 - 1 2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '♭5', '♭6', '♭7'] },
                        'superLocrian': { name: 'Super Locrian - 1 ♭2 ♭3 ♭4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '♭7'] },
                        
                        // 五声音阶系列
                        'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                        'minorPentatonic': { name: 'Minor Pentatonic - 1 ♭3 4 5 ♭7', intervals: ['1', '♭3', '4', '5', '♭7'] },
                        'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 ♭3 5 6', intervals: ['1', '2', '♭3', '5', '6'] },
                        'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                        'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 ♭7', intervals: ['1', '2', '3', '5', '♭7'] },
                        
                        // 布鲁斯音阶系列
                        'blues': { name: 'Blues - 1 ♭3 4 ♯4 5 ♭7', intervals: ['1', '♭3', '4', '♯4', '5', '♭7'] },
                        'majorBlues': { name: 'Major Blues - 1 2 ♭3 3 5 6', intervals: ['1', '2', '♭3', '3', '5', '6'] },
                        
                        // 其他常见音阶
                        'wholeTone': { name: 'Whole Tone - 1 2 3 ♯4 ♯5 ♯6', intervals: ['1', '2', '3', '♯4', '♯5', '♯6'] },
                        'diminished': { name: 'Diminished (Half-Whole) - 1 ♭2 ♭3 3 ♯4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '3', '♯4', '5', '6', '♭7'] },
                        'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 ♭3 ♯4 ♯5 6 7', intervals: ['1', '2', '♭3', '♯4', '♯5', '6', '7'] },
                        
                        // 异国风格音阶
                        'arabic': { name: 'Arabic - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                        'gypsy': { name: 'Gypsy - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                        'japanese': { name: 'Japanese - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                        'egyptian': { name: 'Egyptian - 1 2 4 5 ♭7', intervals: ['1', '2', '4', '5', '♭7'] },
                        'hungarian': { name: 'Hungarian - 1 ♯2 3 ♯4 5 ♭6 7', intervals: ['1', '♯2', '3', '♯4', '5', '♭6', '7'] },
                        'persian': { name: 'Persian - 1 ♭2 3 4 ♭5 ♭6 7', intervals: ['1', '♭2', '3', '4', '♭5', '♭6', '7'] },
                        'byzantine': { name: 'Byzantine - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                        'enigmatic': { name: 'Enigmatic - 1 ♭2 3 ♯4 ♯5 ♯6 7', intervals: ['1', '♭2', '3', '♯4', '♯5', '♯6', '7'] },
                        'neapolitan': { name: 'Neapolitan - 1 ♭2 ♭3 4 5 ♭6 7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '7'] },
                        'spanish': { name: 'Spanish - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] }

                    };

                    // 标准下拉选择器事件处理
                    function updateArpeggioButtons() {
                        const scaleType = document.getElementById('scaleType').value;

                        // 获取音阶类型对应的音程数组
                        let intervals = [];
                        if (window.scaleTypes && window.scaleTypes[scaleType] && window.scaleTypes[scaleType].intervals) {
                            intervals = window.scaleTypes[scaleType].intervals;
                        } else {
                            // 如果没有找到scaleTypes对象或对应的音阶，使用默认的大调音阶
                            intervals = ['1', '2', '3', '4', '5', '6', '7'];
                        }

                        // 获取3音、5音、7音的音程（优先查找实际存在的变音记号版本，如果没有则查找最近的音程）
                        const thirdInterval = findNearestIntervalInScale(intervals, '3');
                        const fifthInterval = findNearestIntervalInScale(intervals, '5');
                        const seventhInterval = findNearestIntervalInScale(intervals, '7');

                        // 更新预定义按钮文本和确保按钮可点击
                        const arpeggio3Btn = document.getElementById('arpeggio-3-btn');
                        const arpeggio5Btn = document.getElementById('arpeggio-5-btn');
                        const arpeggio7Btn = document.getElementById('arpeggio-7-btn');
                        const randomArpeggioBtn = document.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');

                        if (arpeggio3Btn) {
                            arpeggio3Btn.textContent = `${thirdInterval}→${thirdInterval}`;
                            arpeggio3Btn.setAttribute('data-value', `${thirdInterval}to${thirdInterval}`);
                            arpeggio3Btn.style.pointerEvents = 'auto';
                            arpeggio3Btn.style.opacity = '1';
                        }

                        if (arpeggio5Btn) {
                            arpeggio5Btn.textContent = `${fifthInterval}→${fifthInterval}`;
                            arpeggio5Btn.setAttribute('data-value', `${fifthInterval}to${fifthInterval}`);
                            arpeggio5Btn.style.pointerEvents = 'auto';
                            arpeggio5Btn.style.opacity = '1';
                        }

                        if (arpeggio7Btn) {
                            arpeggio7Btn.textContent = `${seventhInterval}→${seventhInterval}`;
                            arpeggio7Btn.setAttribute('data-value', `${seventhInterval}to${seventhInterval}`);
                            arpeggio7Btn.style.pointerEvents = 'auto';
                            arpeggio7Btn.style.opacity = '1';
                        }

                        if (randomArpeggioBtn) {
                            randomArpeggioBtn.style.pointerEvents = 'auto';
                            randomArpeggioBtn.style.opacity = '1';
                        }

                        // 动态创建额外的按钮来显示音阶中其他可用的音程
                        const container = document.querySelector('.order-btn-container');
                        if (container) {
                            // 查找现有的动态按钮并移除
                            const existingDynamicButtons = container.querySelectorAll('.scale-arpeggio-btn.dynamic');
                            existingDynamicButtons.forEach(btn => btn.remove());

                            // 只在音阶练习模式下创建动态按钮，和弦练习模式下不创建
                            const activeTab = document.querySelector('.nav-item.active');
                            if (activeTab && activeTab.dataset.tab === 'scale') {
                                // 为音阶中每个独特的音程创建按钮（除了1、3、5、7，因为它们已经有预定义按钮了）
                                const uniqueIntervals = [...new Set(intervals)];
                                const predefinedIntervals = ['1', '3', '5', '7'];

                                uniqueIntervals.forEach(interval => {
                                    // 提取数字部分
                                    const intervalNumber = interval.replace(/[^0-9]/g, '');

                                    // 跳过预定义的音程
                                    if (predefinedIntervals.includes(intervalNumber)) {
                                        return;
                                    }

                                    // 创建按钮
                                    const btn = document.createElement('div');
                                    btn.className = 'order-btn scale-arpeggio-btn dynamic';
                                    btn.setAttribute('data-value', `${interval}to${interval}`);
                                    btn.textContent = `${interval}→${interval}`;
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.opacity = '1';

                                    // 添加点击事件
                                    btn.addEventListener('click', function() {
                                        // 移除其他按钮的active状态
                                        const allButtons = container.querySelectorAll('.scale-arpeggio-btn');
                                        allButtons.forEach(b => b.classList.remove('active'));
                                        // 添加当前按钮的active状态
                                        this.classList.add('active');
                                    });

                                    // 将按钮添加到容器中，放在随机按钮之前
                                    const randomBtn = container.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');
                                    if (randomBtn) {
                                        container.insertBefore(btn, randomBtn);
                                    } else {
                                        container.appendChild(btn);
                                    }
                                });
                            }
                        }
                    }

                    // 查找音阶中第一个出现的指定音程（如'3', '♭3', '♯3'等）
                    function findFirstIntervalOfType(intervals, degree) {
                        // 特殊处理：对于blues音阶等特殊音阶，优先检查是否有对应度数的变音记号版本
                        if (degree === '3') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === '♭3') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '4') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === '♭4') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '7') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === '♭7') {
                                    return intervals[i];
                                }
                            }
                        }

                        // 检查音阶中是否包含该度数的任何变体
                        for (let i = 0; i < intervals.length; i++) {
                            const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                            if (intervalNumber === degree) {
                                return intervals[i];
                            }
                        }

                        return null;
                    }

                    // 当音阶中缺少特定音程时，查找音阶中实际存在的最近音程
                    function findNearestIntervalInScale(intervals, degree) {
                        // 首先尝试查找指定度数的音程
                        const foundInterval = findFirstIntervalOfType(intervals, degree);
                        if (foundInterval) {
                            return foundInterval;
                        }

                        // 如果没找到，根据音程类型选择最近的替代音程
                        switch (degree) {
                            case '3':
                                // 3音缺失时，查找4音（优先）或2音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '2') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '5':
                                // 5音缺失时，查找4音或6音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '7':
                                // 7音缺失时，查找6音（优先）或1音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '1') {
                                        return intervals[i];
                                    }
                                }
                                break;
                        }

                        // 如果还是没找到，返回音阶中的第一个音程作为默认值
                        return intervals.length > 0 ? intervals[0] : '1';
                    }

                    // 页面加载完成后绑定事件和初始化
                    document.addEventListener('DOMContentLoaded', function() {
                        const scaleTypeElement = document.getElementById('scaleType');
                        if (scaleTypeElement) {
                            scaleTypeElement.addEventListener('change', updateArpeggioButtons);
                        }
                        updateArpeggioButtons();
                    });
                    </script>
                </div>


                <!-- 和弦设置 -->
                <div class="settings-section chord-settings hidden">
                    <div class="settings-section-title">
                        <i>🎶</i> <span data-i18n-key="settings_chord">和弦设置</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_root_note">根音</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNoteScale">
                                <option value="C" >C</option>
                                <option value="C♯" >C♯</option>
                                <option value="D♭" >D♭</option>
                                <option value="D" >D</option>
                                <option value="D♯" >D♯</option>
                                <option value="E♭" >E♭</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="F♯" >F♯</option>
                                <option value="G♭" >G♭</option>
                                <option value="G" >G</option>
                                <option value="G♯" >G♯</option>
                                <option value="A♭" >A♭</option>
                                <option value="A" >A</option>
                                <option value="A♯" >A♯</option>
                                <option value="B♭" >B♭</option>
                                <option value="B" >B</option>
                                <option value="random" selected data-i18n-key="random_root" >随机根音</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_type">和弦类型</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">Dim</div>
                            <div class="chord-type-btn" data-value="augmented">Aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7♭5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7♯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7♭9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7♯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>

                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_order">顺序</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered" data-i18n-key="order_ascending">上行</div>
                            <div class="order-btn chord-order-btn" data-value="reverse" data-i18n-key="order_descending">下行</div>
                            <div class="order-btn chord-order-btn" data-value="random" data-i18n-key="order_random">随机</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="controls">
            <button class="btn" id="startBtn" data-i18n-key="btn_start">开始练习</button>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="scale">
            <div class="nav-icon">🎼</div>
            <div class="nav-label" data-i18n-key="nav_scale">音阶练习</div>
        </div>
        <div class="nav-item" data-tab="chord">
            <div class="nav-icon">🎹</div>
            <div class="nav-label" data-i18n-key="nav_chord">和弦练习</div>
        </div>
        <div class="nav-item" data-tab="progression">
            <div class="nav-icon">🎵</div>
            <div class="nav-label" data-i18n-key="nav_progression">和弦转换</div>
        </div>
        <div class="nav-item" data-tab="pitch-finding">
            <div class="nav-icon">📏</div>
            <div class="nav-label" data-i18n-key="nav_pitch_finding">音程练习</div>
        </div>
        <div class="nav-item" data-tab="device">
            <div class="nav-icon">⚙️</div>
            <div class="nav-label" data-i18n-key="nav_settings">设置</div>
        </div>
    </div>

    <!-- 练习模式全屏页面 -->
    <div id="practiceScreen">
        <!-- 乐曲名显示区域 -->
        <div class="song-title-display hidden" id="songTitleDisplay">
            <div class="song-title" id="songTitle"></div>
        </div>
        
        <!-- CAGED形状显示区域 -->
        <div class="caged-shape-display" id="cagedShapeDisplay" class="hidden">
            <div class="caged-shape-buttons">
                <div class="caged-shape-btn-display" data-shape="C">C</div>
                <div class="caged-shape-btn-display" data-shape="A">A</div>
                <div class="caged-shape-btn-display" data-shape="G">G</div>
                <div class="caged-shape-btn-display" data-shape="E">E</div>
                <div class="caged-shape-btn-display" data-shape="D">D</div>
            </div>
        </div>
        
        <div class="exercise-container">
            <div class="scale-info">
                <div class="target-interval" id="targetInterval">C Major</div>
            </div>

            <div class="sequence-display">

                <div class="sequence-items" id="sequenceDisplay"></div>
            </div>
        </div>

        <div class="next-exercise">
            <div class="next-content-wrapper">
                <div class="next-label">下一个:</div>
                <div class="next-content" id="nextExercise">-</div>
            </div>
        </div>

        <!-- 找音练习特定元素 -->
        <div id="pitchFindingElements" class="hidden">
            <!-- 练习时间显示（独立显示） -->
            <div class="pitch-finding-timer">
                <div class="timer-label" data-i18n-key="pitch_finding_time_remaining">剩余时间</div>
                <div class="timer-display" id="timerDisplay">05:00</div>
            </div>

            <!-- 当前音符显示（居中） -->
            <div class="pitch-finding-current-note">
                <div class="current-note-label" data-i18n-key="pitch_finding_current_note">当前音符</div>
                <div class="current-note-display" id="currentNoteDisplay">C</div>
            </div>

            <!-- 指板显示区域 -->
            <div id="fretboardContainer" class="fretboard-container hidden">
                <div id="fretboard" class="fretboard"></div>
            </div>
            
            <!-- 指板品数 -->
            <div class="fretboard-footer" id="fretboardFooter" class="hidden">
                <div class="fret-numbers" id="fretNumbers"></div>
            </div>

            <!-- 下一题按钮 -->
            <div class="pitch-finding-next-btn-container hidden">
                <button id="pitchFindingNextBtn" class="pitch-finding-next-btn" data-i18n-key="pitch_finding_next_question">下一题</button>
            </div>

        </div>
    </div>

    <script>
        // PitchFinder库内联代码 - 直接嵌入增强版YIN算法实现
        (function (global) {
            // PitchFinder主对象
            var Pitchfinder = {};

            // 增强版YIN算法实现
            Pitchfinder.YIN = function (config) {
                config = config || {};
                var threshold = config.threshold || 0.15;
                var probabilityCliff = config.probabilityCliff || 0.1;

                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);

                    // 步骤1: 差分函数
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }

                    // 步骤2: 累积平均归一化
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }

                    // 步骤3: 阈值检测
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }

                    if (tauEstimate === -1) return null;

                    // 步骤4: 抛物线插值提高精度
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }

                    const frequency = 48000 / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));

                    if (probability < probabilityCliff) return null;

                    return { frequency, probability };
                };
            };

            // 将PitchFinder暴露给全局
            global.Pitchfinder = Pitchfinder;
        })(window);

        document.addEventListener('DOMContentLoaded', function () {
            // 吉他标准调弦
            const standardTuning = ['E', 'B', 'G', 'D', 'A', 'E'];

            // 所有可能的音级
            const intervals = ['1', '♭2', '2', '♭3', '3', '4', '♯4', '5', '♭6', '6', '♭7', '7'];

            // 音级到半音距离的映射
            const intervalToSemitones = {
                '1': 0,
                '♭2': 1,
                '2': 2,
                '♯2': 3,
                '♭3': 3,
                '3': 4,
                '4': 5,
                '♭4': 4,
                '♯4': 6,
                '♭5': 6,
                '5': 7,
                '♯5': 8,
                '♭6': 8,
                '6': 9,
                '♯6': 10,
                '♭7': 10,
                '7': 11,
                // 复合音程映射（9=2, 11=4, 13=6）
                '♭9': 1,
                '9': 2,
                '♯9': 3,
                '11': 4,
                '♯11': 6,
                '♭13': 8,
                '13': 9
            };

            // 音名到半音数的映射（C = 0）
            const noteToSemitones = {
                'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4,
                'F': 5, 'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8,
                'A': 9, 'A♯': 10, 'B♭': 10, 'B': 11
            };

            // 音阶类型定义
            const scaleTypes = {
                // 基本调式
                'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'minor': { name: 'Minor', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                
                // 教会调式 (Church Modes)
                'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'dorian': { name: 'Dorian - 1 2 ♭3 4 5 6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '6', '♭7'] },
                'phrygian': { name: 'Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '♭7'] },
                'lydian': { name: 'Lydian - 1 2 3 ♯4 5 6 7', intervals: ['1', '2', '3', '♯4', '5', '6', '7'] },
                'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 ♭7', intervals: ['1', '2', '3', '4', '5', '6', '♭7'] },
                'aeolian': { name: 'Aeolian - 1 2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                'locrian': { name: 'Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '♭5', '♭6', '♭7'] },
                
                // 和声小调系列
                'harmonicMinor': { name: 'Harmonic Minor - 1 2 ♭3 4 5 ♭6 7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '7'] },
                'dorianSharp2': { name: 'Dorian ♯2 - 1 ♯2 3 4 5 6 ♭7', intervals: ['1', '♯2', '3', '4', '5', '6', '♭7'] },
                'phrygianMajor': { name: 'Phrygian Major - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                'lydianSharp2': { name: 'Lydian ♯2 - 1 ♯2 3 ♯4 5 6 7', intervals: ['1', '♯2', '3', '♯4', '5', '6', '7'] },
                'mixolydianFlat6': { name: 'Mixolydian ♭6 - 1 2 3 4 5 ♭6 ♭7', intervals: ['1', '2', '3', '4', '5', '♭6', '♭7'] },
                'lydianFlat2': { name: 'Lydian ♭2 - 1 ♭2 3 ♯4 5 6 7', intervals: ['1', '♭2', '3', '♯4', '5', '6', '7'] },
                'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 ♭2 ♭3 ♭4 ♭5 ♭6 6', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '6'] },
                
                // 旋律小调系列
                'melodicMinor': { name: 'Melodic Minor - 1 2 ♭3 4 5 6 7', intervals: ['1', '2', '♭3', '4', '5', '6', '7'] },
                'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 ♭7 ♭6 5 4 ♭3 2 1', intervals: ['1', '♭7', '♭6', '5', '4', '♭3', '2', '1'] },
                'dorianFlat2': { name: 'Dorian ♭2 - 1 ♭2 ♭3 4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '6', '♭7'] },
                'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 ♯4 ♯5 6 7', intervals: ['1', '2', '3', '♯4', '♯5', '6', '7'] },
                'lydianFlat7': { name: 'Lydian ♭7 - 1 2 3 ♯4 5 6 ♭7', intervals: ['1', '2', '3', '♯4', '5', '6', '♭7'] },
                'aeolianFlat5': { name: 'Aeolian ♭5 - 1 2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '♭5', '♭6', '♭7'] },
                'superLocrian': { name: 'Super Locrian - 1 ♭2 ♭3 ♭4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '♭7'] },
                
                // 五声音阶系列
                'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                'minorPentatonic': { name: 'Minor Pentatonic - 1 ♭3 4 5 ♭7', intervals: ['1', '♭3', '4', '5', '♭7'] },
                'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 ♭3 5 6', intervals: ['1', '2', '♭3', '5', '6'] },
                'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 ♭7', intervals: ['1', '2', '3', '5', '♭7'] },
                
                // 布鲁斯音阶系列
                'blues': { name: 'Blues - 1 ♭3 4 ♯4 5 ♭7', intervals: ['1', '♭3', '4', '♯4', '5', '♭7'] },
                'majorBlues': { name: 'Major Blues - 1 2 ♭3 3 5 6', intervals: ['1', '2', '♭3', '3', '5', '6'] },
                
                // 其他常见音阶
                'wholeTone': { name: 'Whole Tone - 1 2 3 ♯4 ♯5 ♯6', intervals: ['1', '2', '3', '♯4', '♯5', '♯6'] },
                'diminished': { name: 'Diminished (Half-Whole) - 1 ♭2 ♭3 3 ♯4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '3', '♯4', '5', '6', '♭7'] },
                'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 ♭3 ♯4 ♯5 6 7', intervals: ['1', '2', '♭3', '♯4', '♯5', '6', '7'] },
                
                // 异国风格音阶
                'arabic': { name: 'Arabic - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                'gypsy': { name: 'Gypsy - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                'japanese': { name: 'Japanese - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                'egyptian': { name: 'Egyptian - 1 2 4 5 ♭7', intervals: ['1', '2', '4', '5', '♭7'] },
                'hungarian': { name: 'Hungarian - 1 ♯2 3 ♯4 5 ♭6 7', intervals: ['1', '♯2', '3', '♯4', '5', '♭6', '7'] },
                'persian': { name: 'Persian - 1 ♭2 3 4 ♭5 ♭6 7', intervals: ['1', '♭2', '3', '4', '♭5', '♭6', '7'] },
                'byzantine': { name: 'Byzantine - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                'enigmatic': { name: 'Enigmatic - 1 ♭2 3 ♯4 ♯5 ♯6 7', intervals: ['1', '♭2', '3', '♯4', '♯5', '♯6', '7'] },
                'neapolitan': { name: 'Neapolitan - 1 ♭2 ♭3 4 5 ♭6 7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '7'] },
                'spanish': { name: 'Spanish - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] }

            };

            // 和弦类型定义
            const chordTypes = {
                // 基础三和弦
                'major': { name: '大三和弦', intervals: ['1', '3', '5'] },
                'minor': { name: '小三和弦', intervals: ['1', '♭3', '5'] },
                'diminished': { name: '减三和弦', intervals: ['1', '♭3', '♭5'] },
                'augmented': { name: '增三和弦', intervals: ['1', '3', '♯5'] },
                
                // 六和弦
                'major6': { name: '大六和弦', intervals: ['1', '3', '5', '6'] },
                'minor6': { name: '小六和弦', intervals: ['1', '♭3', '5', '6'] },
                
                // 七和弦
                'dominant7': { name: '属七和弦', intervals: ['1', '3', '5', '♭7'] },
                'major7': { name: '大七和弦', intervals: ['1', '3', '5', '7'] },
                'minor7': { name: '小七和弦', intervals: ['1', '♭3', '5', '♭7'] },
                'minor7b5': { name: '半减七和弦', intervals: ['1', '♭3', '♭5', '♭7'] },
                'diminished7': { name: '减七和弦', intervals: ['1', '♭3', '♭5', '6'] },
                
                // 九和弦
                'dominant9': { name: '属九和弦', intervals: ['1', '3', '5', '♭7', '9'] },
                'major9': { name: '大九和弦', intervals: ['1', '3', '5', '7', '9'] },
                'minor9': { name: '小九和弦', intervals: ['1', '♭3', '5', '♭7', '9'] },
                'dominant7sharp9': { name: '属7♯9和弦', intervals: ['1', '3', '5', '♭7', '♯9'] },
                'dominant7flat9': { name: '属7♭9和弦', intervals: ['1', '3', '5', '♭7', '♭9'] },
                
                // 十一和弦
                'dominant11': { name: '属11和弦', intervals: ['1', '3', '5', '♭7', '9', '11'] },
                'minor11': { name: '小11和弦', intervals: ['1', '♭3', '5', '♭7', '9', '11'] },
                'dominant7sharp11': { name: '属7♯11和弦', intervals: ['1', '3', '5', '♭7', '♯11'] },
                
                // 十三和弦
                'dominant13': { name: '属13和弦', intervals: ['1', '3', '5', '♭7', '9', '13'] },
                'minor13': { name: '小13和弦', intervals: ['1', '♭3', '5', '♭7', '9', '13'] },
                
                // 挂留和弦
                'sus2': { name: '挂二和弦', intervals: ['1', '2', '5'] },
                'sus4': { name: '挂四和弦', intervals: ['1', '4', '5'] },
                '7sus4': { name: '七挂四和弦', intervals: ['1', '4', '5', '♭7'] },
                '7sus2': { name: '七挂二和弦', intervals: ['1', '2', '5', '♭7'] },
                
                // 加音和弦
                'add9': { name: '加九和弦', intervals: ['1', '3', '5', '9'] },
                'madd9': { name: '小加九和弦', intervals: ['1', '♭3', '5', '9'] },
                '6add9': { name: '六加九和弦', intervals: ['1', '3', '5', '6', '9'] },
                'm6add9': { name: '小六加九和弦', intervals: ['1', '♭3', '5', '6', '9'] },

                // 复杂和弦类型 - 用于练习曲目
                'sus4b9': { name: '挂留四降九和弦', intervals: ['1', '4', '5', '♭9'] },
                '13sus4b9': { name: '十三挂留四降九和弦', intervals: ['1', '4', '5', '♭7', '9', '13'] },
                'Maj7#11': { name: '大七升十一和弦', intervals: ['1', '3', '5', '7', '♯11'] },
                'Maj7#5': { name: '大七升五和弦', intervals: ['1', '3', '♯5', '7'] },
                '7#11': { name: '属七升十一和弦', intervals: ['1', '3', '5', '♭7', '♯11'] },
                'MinMaj7': { name: '小大七和弦', intervals: ['1', '♭3', '5', '7'] },
                'Min7b5♮9': { name: '小七降五自然九和弦', intervals: ['1', '♭3', '♭5', '♭7', '9'] },
                '13b9': { name: '十三降九和弦', intervals: ['1', '3', '5', '♭7', '♭9', '13'] }
            };

            // 经典爵士乐歌曲和弦进行（基于音级储存）
            const jazzStandards = {
                '5': {
                    '500 Miles High': {
                        key: 'E',
                        chords: ['Im7', '♭IIIm7', 'Im7', '♭IIIm7', '♭VIM7', '♭IIM7', 'Im7', 'Im7']
                    }
                },
                'A': {
                    'All The Things You Are': {
                        key: 'C',
                        chords: ['VIIm7♭5', 'III7', 'VIm7', 'II7', 'IIm7', 'V7', 'IM7', 'IM7'],
                        info: {
                            composer: 'Jerome Kern',
                            year: '1939',
                            style: '爵士标准曲/百老汇音乐剧',
                            tempo: 'Medium Ballad',
                            description: '被誉为最完美的爵士标准曲之一，和声进行复杂而优美，是学习高级和声的经典教材。'
                        }
                    },
                    'Autumn Leaves': {
                        key: 'G',
                        chords: ['IVm7', '♭VII7', '♭IIIM7', '♭VIM7', 'IIm7♭5', 'V7', 'Im7', 'Im7'],
                        info: {
                            composer: 'Joseph Kosma',
                            year: '1945',
                            style: '法式香颂/爵士标准曲',
                            tempo: 'Medium Ballad',
                            description: '法国作曲家创作的经典曲目，展现了从大调到小调的自然转换，是学习ii-V-i进行的绝佳教材。'
                        }
                    },
                    'All Of Me': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'IVM7', 'IIIm7♭5', 'VI7'],
                        info: {
                            composer: 'Gerald Marks & Seymour Simons',
                            year: '1931',
                            style: '爵士标准曲',
                            tempo: 'Medium Swing',
                            description: '经典的32小节AABA结构爵士标准曲，以其简单而优美的和声进行著称。'
                        }
                    },
                    'A Night In Tunisia': {
                        key: 'D',
                        chords: ['IIm7♭5', 'V7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'Im7', '♭IIM7']
                    },
                    'All of You': {
                        key: 'C',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Alone Together': {
                        key: 'G',
                        chords: ['IIm7♭5', 'V7', 'Im7', '♭VI7', '♭IIM7', 'IIm7♭5', 'V7', 'Im7']
                    },
                    'Ambleside': {
                        key: 'C',
                        chords: ['IM7', 'V7sus4', 'IM7', 'IVM7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Anthropology': {
                        key: 'B♭',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Ask Me Now': {
                        key: 'F',
                        chords: ['IM7', '♭II7', 'IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'IM7']
                    }
                },
                'B': {
                    'Blue Moon': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Body And Soul': {
                        key: 'D♭',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', '♭VIIM7', 'Vm7', 'II7', 'V7']
                    },
                    'Bye Bye Blackbird': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'II7', 'VIIm7', 'III7', 'VIm7', 'IIm7']
                    },
                    'Beautiful Love': {
                        key: 'G',
                        chords: ['IIm7♭5', 'V7', 'Im7', 'Im7', 'IVm7', '♭VII7', '♭IIIM7', '♭IIIM7']
                    },
                    'Blue Bossa': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7♭5', 'V7', '♭VIIM7', '♭VIIM7']
                    },
                    'Blue in Green': {
                        key: 'C',
                        chords: ['IM7', '♭VII7', '♭IIIM7', '♭VIM7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    },
                    'Blues for Alice': {
                        key: 'F',
                        chords: ['I7', 'VI7', 'II7', 'V7', 'III7', 'VI7', 'II7', 'V7']
                    }
                },
                'C': {
                    'Cherokee': {
                        key: 'B♭',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Come Rain Or Come Shine': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Confirmation': {
                        key: 'F',
                        chords: ['IM7', '♭VII7', 'IIIm7♭5', 'VI7', 'IIm7', 'V7', 'IIIm7♭5', 'VI7']
                    },
                    'Coral': {
                        key: 'G',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Corcovado': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7']
                    },
                    'Countdown': {
                        key: 'E♭',
                        chords: ['IM7', '♭III7', '♭VIM7', '♭II7', 'VM7', 'I7', 'IVM7', '♭VII7']
                    }
                },
                'D': {
                    'Days Of Wine And Roses': {
                        key: 'F',
                        chords: ['IM7', 'IV7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Donna Lee': {
                        key: 'A♭',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Doxy': {
                        key: 'B♭',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7']
                    },
                    'Dream A Little Dream': {
                        key: 'C',
                        chords: ['IM7', '♭IIIdim', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'F': {
                    'Fall': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    },
                    'Falling Grace': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Fly Me To The Moon': {
                        key: 'C',
                        chords: ['VIm7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7']
                    },
                    'Four': {
                        key: 'E♭',
                        chords: ['IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Footprints': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IVm7', 'IVm7', 'Im7', 'Im7']
                    }
                },
                'G': {
                    'Giant Steps': {
                        key: 'B',
                        chords: ['IM7', '♭III7', '♭VIM7', '♭VII7', '♭IIM7', '♭VIm7', '♭III7', '♭VIM7']
                    },
                    'Georgia On My Mind': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Girl From Ipanema': {
                        key: 'F',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'IIIm7♭5', 'VI7', 'IIm7', 'IIm7']
                    }
                },
                'H': {
                    'Have You Met Miss Jones': {
                        key: 'B♭',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Here\'s That Rainy Day': {
                        key: 'G',
                        chords: ['♭VII7', 'IVm7', '♭VII7', '♭IIIM7', '♭VIM7', 'IIm7♭5', 'V7', 'Im7']
                    },
                    'How High The Moon': {
                        key: 'G',
                        chords: ['IM7', 'Im7', 'IV7', '♭VIIM7', '♭VIIM7', 'IIIm7♭5', 'VI7', 'IIm7']
                    }
                },
                'I': {
                    'I Got Rhythm': {
                        key: 'B♭',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'I Can\'t Get Started': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'VI7', 'IIm7', 'V7']
                    },
                    'In A Sentimental Mood': {
                        key: 'D',
                        chords: ['Im7', 'IV7', 'IIm7♭5', 'V7', 'Im7', 'IV7', '♭VIIM7', '♭VIIM7']
                    },
                    'Infant Eyes': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7']
                    },
                    'Inner Urge': {
                        key: 'A♭',
                        chords: ['IM7', '♭II7', 'IM7', '♭II7', 'IVM7', '♭VII7', 'IM7', 'IM7']
                    }
                },
                'J': {
                    'Just Friends': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIM7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Joy Spring': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Jordu': {
                        key: 'A',
                        chords: ['IIm7', 'V7', '♭VIIM7', '♭IIIM7', 'VIm7♭5', 'II7', 'Vm7', 'IIm7']
                    }
                },
                'L': {
                    'Lady Bird': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IVm7♭5', '♭VII7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Love For Sale': {
                        key: 'G',
                        chords: ['Im7', 'IV7', 'Im7', 'IV7', '♭VIIM7', 'Vm7', 'Im7', 'IV7']
                    },
                    'Lover Man': {
                        key: 'A♭',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    }
                },
                'M': {
                    'Misty': {
                        key: 'E♭',
                        chords: ['IM7', 'Vm7', 'I7', 'IVM7', 'IVm7', '♭VII7', 'IM7', 'VIm7']
                    },
                    'My Funny Valentine': {
                        key: 'C',
                        chords: ['Im7', 'IV7', '♭VIIM7', '♭IIIM7', 'VIm7♭5', 'II7', 'Vm7', 'I7']
                    },
                    'Maiden Voyage': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IIm7', 'V7', '♭IIIm7', '♭VI7', '♭IIM7', '♭IIM7']
                    }
                },
                'N': {
                    'Night And Day': {
                        key: 'C',
                        chords: ['IM7', 'IIm7', 'IIIm7', 'IIm7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Nardis': {
                        key: 'E',
                        chords: ['Im7', '♭IIM7', 'Im7', '♭IIM7', '♭VIIM7', '♭IIM7', 'Im7', 'Im7']
                    },
                    'Night Train': {
                        key: 'G',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'V7']
                    }
                },
                'O': {
                    'Oleo': {
                        key: 'B♭',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'S': {
                    'Someday My Prince Will Come': {
                        key: 'B♭',
                        chords: ['IM7', 'IV7', 'VIIm7♭5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Spain': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7', 'VIm7']
                    },
                    'Stella By Starlight': {
                        key: 'D',
                        chords: ['IIm7♭5', 'V7', 'Im7', '♭VI7', '♭IIIM7', 'IIm7♭5', 'V7', 'Im7']
                    },
                    'Summertime': {
                        key: 'A',
                        chords: ['Im7', 'V7', 'Im7', 'V7', 'IVm7', '♭VII7', '♭IIIM7', '♭VIM7']
                    },
                    'Solar': {
                        key: 'C',
                        chords: ['Im7', 'IV7', '♭VIIM7', '♭IIIM7', 'VIm7♭5', 'II7', 'Vm7', 'I7']
                    }
                },
                'T': {
                    'Take Five': {
                        key: 'E♭m',
                        chords: ['Im7', 'IV7', '♭VIIM7', '♭IIIM7', 'IIm7', 'V7', 'Im7', 'Im7']
                    },
                    'Take the A-Train': {
                        key: 'C',
                        chords: ['IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'There Will Never Be Another You': {
                        key: 'E♭',
                        chords: ['IM7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IM7', 'IIIm7', 'VI7']
                    },
                    'The Way You Look Tonight': {
                        key: 'E♭',
                        chords: ['IM7', 'IV7', 'IM7', 'VIm7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Time Remembered': {
                        key: 'F',
                        chords: ['IM7', '♭VII7', 'IM7', '♭VII7', 'IVM7', '♭VII7', 'IM7', 'IM7']
                    }
                },
                'V': {
                    'Very Early': {
                        key: 'E♭',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Virgo': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    }
                },
                '练习': {
                    '练习1 - Maj7和弦(12个调)': {
                        key: 'A',
                        chords: ['IM7', 'IV7', 'V7', 'IM7'], // 简化的和弦进行示例
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Maj7和弦五度圈循环练习。从AMaj7开始，按照五度圈倒序方向（A-D-G-C-F-B♭-E♭-A♭-D♭-G♭-B-E）进行12个调的Maj7和弦练习。每个和弦持续一个小节，共48小节的完整循环。适合练习大七和弦在不同调中的指法和声音色彩。',
                            details: '五度圈倒序进行：AMaj7 → DMaj7 → GMaj7 → CMaj7 → FMaj7 → B♭Maj7 → E♭Maj7 → A♭Maj7 → D♭Maj7 → G♭Maj7 → BMaj7 → EMaj7 → 回到AMaj7。每个调的Maj7和弦练习帮助你掌握不同调性下的声音特点。'
                        }
                    },
                    '练习2 - Min7和弦(12个调)': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Vm7', 'Im7'], // 简化的和弦进行示例
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Min7和弦五度圈循环练习。从Am7开始，按照五度圈倒序方向（A-D-G-C-F-B♭-E♭-A♭-D♭-G♭-B-E）进行12个调的小七和弦练习。每个和弦持续一个小节，共48小节的完整循环。适合练习小七和弦在不同调中的指法和声音色彩。',
                            details: '五度圈倒序进行：Am7 → Dm7 → Gm7 → Cm7 → Fm7 → B♭m7 → E♭m7 → A♭m7 → D♭m7 → G♭m7 → Bm7 → Em7 → 回到Am7。每个调的小七和弦练习帮助你掌握不同调性下的和声色彩。'
                        }
                    },
                    '练习3 - Sus4b9和弦(12个调)': {
                        key: 'A',
                        chords: ['Isus4(b9)', 'IVsus4(b9)', 'Vsus4(b9)', 'Isus4(b9)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Sus4(b9)和弦五度圈循环练习。从Asus4(b9)开始，按照五度圈倒序方向进行12个调的挂留四和弦加降九音练习。这个和弦组合具有紧张和解决的强烈倾向性，适合练习爵士和声的张力处理。',
                            details: '五度圈倒序进行：Asus4(b9) → Dsus4(b9) → Gsus4(b9) → Csus4(b9) → Fsus4(b9) → B♭sus4(b9) → E♭sus4(b9) → A♭sus4(b9) → D♭sus4(b9) → G♭sus4(b9) → Bsus4(b9) → Esus4(b9) → 回到Asus4(b9)。'
                        }
                    },
                    '练习4 - Maj7#11和弦(12个调)': {
                        key: 'A',
                        chords: ['IMaj7(#11)', 'IVMaj7(#11)', 'VMaj7(#11)', 'IMaj7(#11)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Maj7(#11)和弦五度圈循环练习。从AMaj7(#11)开始，按照五度圈倒序方向进行12个调的升十一音大七和弦练习。这个和弦具有强烈的Lydian调式色彩，是现代爵士和声的重要元素。',
                            details: '五度圈倒序进行：AMaj7(#11) → DMaj7(#11) → GMaj7(#11) → CMaj7(#11) → FMaj7(#11) → B♭Maj7(#11) → E♭Maj7(#11) → A♭Maj7(#11) → D♭Maj7(#11) → G♭Maj7(#11) → BMaj7(#11) → EMaj7(#11) → 回到AMaj7(#11)。'
                        }
                    },
                    '练习5 - 7sus4和弦(12个调)': {
                        key: 'A',
                        chords: ['I7sus4', 'IV7sus4', 'V7sus4', 'I7sus4'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: '7sus4和弦五度圈循环练习。从A7sus4开始，按照五度圈倒序方向进行12个调的属七挂留四和弦练习。这个和弦在不解决前保持高度张力，是爵士即兴的常用手法。',
                            details: '五度圈倒序进行：A7sus4 → D7sus4 → G7sus4 → C7sus4 → F7sus4 → B♭7sus4 → E♭7sus4 → A♭7sus4 → D♭7sus4 → G♭7sus4 → B7sus4 → E7sus4 → 回到A7sus4。'
                        }
                    },
                    '练习5a - Dom7和弦(12个调)': {
                        key: 'A',
                        chords: ['I7', 'IV7', 'V7', 'I7'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Dom7和弦五度圈循环练习。从A7开始，按照五度圈倒序方向进行12个调的属七和弦练习。属七和弦是布鲁斯和爵士音乐的核心，掌握其循环对于理解功能性和声至关重要。',
                            details: '五度圈倒序进行：A7 → D7 → G7 → C7 → F7 → B♭7 → E♭7 → A♭7 → D♭7 → G♭7 → B7 → E7 → 回到A7。'
                        }
                    },
                    '练习6 - Min7b5和弦(12个调)': {
                        key: 'A',
                        chords: ['Im7(b5)', 'IVm7(b5)', 'Vm7(b5)', 'Im7(b5)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Min7(b5)和弦五度圈循环练习。从Am7(b5)开始，按照五度圈倒序方向进行12个调的小七降五和弦练习。这个和弦是小调和声和减音阶的重要组成部分，具有强烈的紧张感。',
                            details: '五度圈倒序进行：Am7(b5) → Dm7(b5) → Gm7(b5) → Cm7(b5) → Fm7(b5) → B♭m7(b5) → E♭m7(b5) → A♭m7(b5) → D♭m7(b5) → G♭m7(b5) → Bm7(b5) → Em7(b5) → 回到Am7(b5)。'
                        }
                    },
                    '练习7 - MinMaj7和弦(12个调)': {
                        key: 'A',
                        chords: ['Im(Maj7)', 'IVm(Maj7)', 'Vm(Maj7)', 'Im(Maj7)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'MinMaj7和弦五度圈循环练习。从Am(Maj7)开始，按照五度圈倒序方向进行12个调的小大七和弦练习。这个和弦具有独特的神秘色彩，是小调和声和旋律小调音阶的代表性和弦。',
                            details: '五度圈倒序进行：Am(Maj7) → Dm(Maj7) → Gm(Maj7) → Cm(Maj7) → Fm(Maj7) → B♭m(Maj7) → E♭m(Maj7) → A♭m(Maj7) → D♭m(Maj7) → G♭m(Maj7) → Bm(Maj7) → Em(Maj7) → 回到Am(Maj7)。'
                        }
                    },
                    '练习8 - 13sus4b9和弦(12个调)': {
                        key: 'A',
                        chords: ['I13sus4(b9)', 'IV13sus4(b9)', 'V13sus4(b9)', 'I13sus4(b9)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: '13sus4(b9)和弦五度圈循环练习。从A13sus4(b9)开始，按照五度圈倒序方向进行12个调的十三挂留四降九和弦练习。这是一个复杂的延伸和弦，结合了多个音程层次，适合高级和声练习。',
                            details: '五度圈倒序进行：A13sus4(b9) → D13sus4(b9) → G13sus4(b9) → C13sus4(b9) → F13sus4(b9) → B♭13sus4(b9) → E♭13sus4(b9) → A♭13sus4(b9) → D♭13sus4(b9) → G♭13sus4(b9) → B13sus4(b9) → E13sus4(b9) → 回到A13sus4(b9)。'
                        }
                    },
                    '练习9 - Maj7#5和弦(12个调)': {
                        key: 'A',
                        chords: ['IMaj7(#5)', 'IVMaj7(#5)', 'VMaj7(#5)', 'IMaj7(#5)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Maj7(#5)和弦五度圈循环练习。从AMaj7(#5)开始，按照五度圈倒序方向进行12个调的升五大七和弦练习。这个和弦具有增三和弦的色彩，适合练习调性和声的扩展。',
                            details: '五度圈倒序进行：AMaj7(#5) → DMaj7(#5) → GMaj7(#5) → CMaj7(#5) → FMaj7(#5) → B♭Maj7(#5) → E♭Maj7(#5) → A♭Maj7(#5) → D♭Maj7(#5) → G♭Maj7(#5) → BMaj7(#5) → EMaj7(#5) → 回到AMaj7(#5)。'
                        }
                    },
                    '练习10 - 7#11和弦(12个调)': {
                        key: 'A',
                        chords: ['I7(#11)', 'IV7(#11)', 'V7(#11)', 'I7(#11)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: '7#11和弦五度圈循环练习。从A7(#11)开始，按照五度圈倒序方向进行12个调的升十一音属七和弦练习。这个和弦融合了属功能和Lydian色彩，是现代爵士的重要和声词汇。',
                            details: '五度圈倒序进行：A7(#11) → D7(#11) → G7(#11) → C7(#11) → F7(#11) → B♭7(#11) → E♭7(#11) → A♭7(#11) → D♭7(#11) → G♭7(#11) → B7(#11) → E7(#11) → 回到A7(#11)。'
                        }
                    },
                    '练习11 - Min7b5♮9和弦(12个调)': {
                        key: 'A',
                        chords: ['Im7(b5,♮9)', 'IVm7(b5,♮9)', 'Vm7(b5,♮9)', 'Im7(b5,♮9)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: 'Min7(b5,♮9)和弦五度圈循环练习。从Am7(b5,♮9)开始，按照五度圈倒序方向进行12个调的小七降五自然九和弦练习。这个和弦结合了减音程和自然音，创造出独特的和声张力。',
                            details: '五度圈倒序进行：Am7(b5,♮9) → Dm7(b5,♮9) → Gm7(b5,♮9) → Cm7(b5,♮9) → Fm7(b5,♮9) → B♭m7(b5,♮9) → E♭m7(b5,♮9) → A♭m7(b5,♮9) → D♭m7(b5,♮9) → G♭m7(b5,♮9) → Bm7(b5,♮9) → Em7(b5,♮9) → 回到Am7(b5,♮9)。'
                        }
                    },
                    '练习12 - 13b9和弦(12个调)': {
                        key: 'A',
                        chords: ['I13(b9)', 'IV13(b9)', 'V13(b9)', 'I13(b9)'],
                        info: {
                            composer: '系统生成',
                            year: '2024',
                            style: '和弦循环练习',
                            tempo: 'Medium',
                            description: '13(b9)和弦五度圈循环练习。从A13(b9)开始，按照五度圈倒序方向进行12个调的十三降九和弦练习。这是一个复杂的属功能和弦，结合了多个音程层次，适合高级爵士和声练习。',
                            details: '五度圈倒序进行：A13(b9) → D13(b9) → G13(b9) → C13(b9) → F13(b9) → B♭13(b9) → E♭13(b9) → A♭13(b9) → D♭13(b9) → G♭13(b9) → B13(b9) → E13(b9) → 回到A13(b9)。'
                        }
                    }
                }
            };
            
            // 将jazzStandards暴露到全局作用域
            window.jazzStandards = jazzStandards;

            // 元素引用
            const mainScreen = document.getElementById('mainScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const targetIntervalEl = document.getElementById('targetInterval');
            const sequenceDisplayEl = document.getElementById('sequenceDisplay');
            const nextExerciseEl = document.getElementById('nextExercise');
            const startBtn = document.getElementById('startBtn');
            const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
            const rootNoteEl = document.getElementById('rootNote');
            const scaleTypeEl = document.getElementById('scaleType');
            const chordRootNoteEl = document.getElementById('chordRootNote');
            const audioInputDeviceEl = document.getElementById('audioInputDevice');
            const inputGainEl = document.getElementById('inputGain');
            const inputGainValueEl = document.getElementById('inputGainValue');
            const deviceInfoEl = document.getElementById('deviceInfo');
            const statusIndicator = document.getElementById('statusIndicator');
            const shortcutHint = document.getElementById('shortcutHint');
            const metronomeToggleEl = document.getElementById('metronomeToggle');
            const metronomeTempoEl = document.getElementById('metronomeTempo');
            const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
            const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
            const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
            const deviceSettings = document.querySelector('.device-settings');

            // 选项卡元素
            // const settingsTabs = document.querySelectorAll('.settings-tab'); // 已移除顶部选项卡
            const scaleSettings = document.querySelector('.scale-settings');
            const chordSettings = document.querySelector('.chord-settings');
            const progressionSettings = document.querySelector('.progression-settings');

            // 和弦类型按钮
            const chordTypeBtns = document.querySelectorAll('.chord-type-btn');

            // 音频设备管理
            let audioDevices = [];
            let selectedDeviceId = 'default';
            let inputGain = 1.0;
            let gainNode = null;

            // 屏幕唤醒锁变量
            let wakeLock = null;

            // 音频分析变量
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let audioWorkletNode = null;
            let javascriptNode = null;
            let isRecording = false;
            let mediaStream = null;

            // 练习状态
            let state = {
                score: 0,
                correctCount: 0,
                totalCount: 0,
                accuracy: 0,
                rootNote: '',
                scaleType: '',
                chordType: '',
                currentIntervals: [],
                currentSequence: [],
                currentStep: 0,
                correctPositions: [],
                isCoolingDown: false,
                cooldownTimeout: null,
                cooldownDuration: 600, // 冷却期持续时间(毫秒)
                enableCooldown: true, // 是否启用冷却时间
                enableFixedDelay: false, // 是否启用固定延迟生成下一题
                fixedDelayDuration: 800, // 固定延迟时间(毫秒)
                isAnswered: false,
                timeoutId: null,
                maxFret: 12,
                previousMaxFret: 12,
                isRecording: false,
                sensitivity: 0.5,
                confidenceThreshold: 0.5,
                noiseLevel: 0.001,
                minVolume: 0.001,
                microphoneInitialized: false,
                pitchBuffer: [],
                bufferSize: 3,
                zeroCrossingThreshold: 0.1,
                harmonicWeights: [1.0, 0.8, 0.6],
                nextExerciseInfo: '',
                nextExerciseIntervals: [],
                metronomeEnabled: document.getElementById('metronomeToggle').checked,
                metronomeTempo: parseInt(document.getElementById('metronomeTempo').value),
                metronomeFlashEnabled: document.getElementById('metronomeFlashToggle').checked,
                metronomeSoundEnabled: document.getElementById('metronomeSoundToggle').checked,
                metronomeInterval: null,
                // 和弦转换练习状态
                isInProgressionSession: false, // 是否在练习会话中
                // 自定义和弦模式状态
                isCustomChordMode: false, // 是否在自定义和弦模式
                // 和弦名显示模式
                chordNameDisplayMode: 'english' // 'english' 或 'symbols'
            };

            // 初始化练习设置
            const cooldownDurationEl = document.getElementById('cooldownDuration');
            if (cooldownDurationEl) {
                state.cooldownDuration = parseInt(cooldownDurationEl.value);
            }

            const enableCooldownEl = document.getElementById('enableCooldown');
            if (enableCooldownEl) {
                state.enableCooldown = enableCooldownEl.checked;
            }

            const enableFixedDelayEl = document.getElementById('enableFixedDelay');
            if (enableFixedDelayEl) {
                state.enableFixedDelay = enableFixedDelayEl.checked;
            }

            const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
            if (fixedDelayDurationEl) {
                state.fixedDelayDuration = parseInt(fixedDelayDurationEl.value);
            }

            // 初始化音高检测设置
            const sensitivityEl = document.getElementById('sensitivity');
            if (sensitivityEl) {
                state.sensitivity = parseFloat(sensitivityEl.value);
            }

            const confidenceThresholdEl = document.getElementById('confidenceThreshold');
            if (confidenceThresholdEl) {
                state.confidenceThreshold = parseFloat(confidenceThresholdEl.value);
            }
            
            // 在初始化完成后加载保存的设置（这样可以覆盖默认值）
            setTimeout(() => {
                loadSettings();
            }, 100);

            // 设置管理功能
            function saveSettings() {
                const settings = {
                    // 练习设置
                    enableCooldown: state.enableCooldown,
                    cooldownDuration: state.cooldownDuration,
                    enableFixedDelay: state.enableFixedDelay,
                    fixedDelayDuration: state.fixedDelayDuration,
                    
                    // 音高检测设置
                    sensitivity: state.sensitivity,
                    confidenceThreshold: state.confidenceThreshold,
                    noiseLevel: state.noiseLevel,
                    minVolume: state.minVolume,
                    
                    // 节拍器设置
                    metronomeEnabled: state.metronomeEnabled,
                    metronomeTempo: state.metronomeTempo,
                    metronomeFlashEnabled: state.metronomeFlashEnabled,
                    metronomeSoundEnabled: state.metronomeSoundEnabled,
                    
                    // 音频设置
                    selectedDeviceId: selectedDeviceId,
                    inputGain: inputGain,
                    
                    // 显示设置
                    chordNameDisplayMode: state.chordNameDisplayMode,
                    
                    // 版本信息（用于兼容性检查）
                    version: '1.0'
                };
                
                try {
                    localStorage.setItem('guitarPracticeSettings', JSON.stringify(settings));
                    console.log('设置已保存');
                } catch (error) {
                    console.error('保存设置失败:', error);
                }
            }
            
            function loadSettings() {
                try {
                    const savedSettings = localStorage.getItem('guitarPracticeSettings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        
                        // 更新state对象
                        if (settings.enableCooldown !== undefined) state.enableCooldown = settings.enableCooldown;
                        if (settings.cooldownDuration !== undefined) state.cooldownDuration = settings.cooldownDuration;
                        if (settings.enableFixedDelay !== undefined) state.enableFixedDelay = settings.enableFixedDelay;
                        if (settings.fixedDelayDuration !== undefined) state.fixedDelayDuration = settings.fixedDelayDuration;
                        if (settings.sensitivity !== undefined) state.sensitivity = settings.sensitivity;
                        if (settings.confidenceThreshold !== undefined) state.confidenceThreshold = settings.confidenceThreshold;
                        if (settings.noiseLevel !== undefined) state.noiseLevel = settings.noiseLevel;
                        if (settings.minVolume !== undefined) state.minVolume = settings.minVolume;
                        if (settings.metronomeEnabled !== undefined) state.metronomeEnabled = settings.metronomeEnabled;
                        if (settings.metronomeTempo !== undefined) state.metronomeTempo = settings.metronomeTempo;
                        if (settings.metronomeFlashEnabled !== undefined) state.metronomeFlashEnabled = settings.metronomeFlashEnabled;
                        if (settings.metronomeSoundEnabled !== undefined) state.metronomeSoundEnabled = settings.metronomeSoundEnabled;
                        if (settings.selectedDeviceId !== undefined) selectedDeviceId = settings.selectedDeviceId;
                        if (settings.inputGain !== undefined) inputGain = settings.inputGain;
                        if (settings.chordNameDisplayMode !== undefined) state.chordNameDisplayMode = settings.chordNameDisplayMode;
                        
                        // 更新界面元素
                        updateUIFromSettings();
                        
                        console.log('设置已加载');
                        return true;
                    }
                } catch (error) {
                    console.error('加载设置失败:', error);
                }
                return false;
            }
            
            function updateUIFromSettings() {
                // 更新练习设置
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.checked = state.enableCooldown;
                }
                
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.value = state.cooldownDuration;
                    cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                }
                
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.checked = state.enableFixedDelay;
                }
                
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.value = state.fixedDelayDuration;
                    fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                }
                
                // 更新音高检测设置
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.value = state.sensitivity;
                    sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                }
                
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.value = state.confidenceThreshold;
                    confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                }
                
                // 更新节拍器设置
                const metronomeToggleEl = document.getElementById('metronomeToggle');
                if (metronomeToggleEl) {
                    metronomeToggleEl.checked = state.metronomeEnabled;
                }
                
                const metronomeTempoEl = document.getElementById('metronomeTempo');
                const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
                if (metronomeTempoEl && metronomeTempoValueEl) {
                    metronomeTempoEl.value = state.metronomeTempo;
                    metronomeTempoValueEl.textContent = state.metronomeTempo;
                }
                
                // 更新节拍器选项设置
                const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
                if (metronomeFlashToggleEl) {
                    metronomeFlashToggleEl.checked = state.metronomeFlashEnabled;
                }
                
                const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
                if (metronomeSoundToggleEl) {
                    metronomeSoundToggleEl.checked = state.metronomeSoundEnabled;
                }
                
                // 更新音频设置
                const audioInputDeviceEl = document.getElementById('audioInputDevice');
                if (audioInputDeviceEl && selectedDeviceId) {
                    // 等待设备列表更新完成后再设置选中项
                    setTimeout(() => {
                        audioInputDeviceEl.value = selectedDeviceId;
                    }, 100);
                }
                
                const inputGainEl = document.getElementById('inputGain');
                const inputGainValueEl = document.getElementById('inputGainValue');
                if (inputGainEl && inputGainValueEl) {
                    inputGainEl.value = inputGain * 100;
                    inputGainValueEl.textContent = Math.round(inputGain * 100) + '%';
                }
                
                // 更新和弦名显示按钮
                const chordNameDisplayBtns = document.querySelectorAll('.chord-name-display-btn');
                chordNameDisplayBtns.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.value === state.chordNameDisplayMode) {
                        btn.classList.add('active');
                    }
                });
                
                // 更新和弦类型按钮的显示文本
                updateChordTypeButtonTexts();
            }
            
            function resetSettings() {
                if (confirm('确定要重置所有设置吗？这将恢复到默认值。')) {
                    try {
                        localStorage.removeItem('guitarPracticeSettings');
                        
                        // 重置为默认值
                        state.enableCooldown = true;
                        state.cooldownDuration = 600;
                        state.enableFixedDelay = false;
                        state.fixedDelayDuration = 800;
                        state.sensitivity = 0.5;
                        state.confidenceThreshold = 0.5;
                        state.noiseLevel = 0.001;
                        state.minVolume = 0.001;
                        state.metronomeEnabled = false;
                        state.metronomeTempo = 40;
                        state.metronomeFlashEnabled = true;
                        state.metronomeSoundEnabled = true;
                        selectedDeviceId = 'default';
                        inputGain = 1.0;
                        state.chordNameDisplayMode = 'english';
                        
                        updateUIFromSettings();
                        
                        console.log('设置已重置');
                    } catch (error) {
                        console.error('重置设置失败:', error);
                    }
                }
            }
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('屏幕唤醒锁已激活');

                        wakeLock.addEventListener('release', () => {
                            console.log('屏幕唤醒锁已释放');
                        });
                    }
                } catch (err) {
                    console.error(`无法获取屏幕唤醒锁: ${err.message}`);
                }
            }

            // 释放屏幕唤醒锁
            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }

            // 获取音频设备列表
            async function getAudioDevices() {
                try {
                    // 请求权限以获取设备标签
                    await navigator.mediaDevices.getUserMedia({ audio: true });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    audioDevices = devices.filter(device => device.kind === 'audioinput');

                    updateAudioDeviceSelector();
                    checkForAudioInterfaces();
                    
                    // 保存设置以确保设备选择被记住
                    saveSettings();
                } catch (error) {
                    console.error('获取音频设备失败:', error);
                    deviceInfoEl.textContent = "无法获取音频设备列表，请确保已授予麦克风权限";
                }
            }

            // 更新设备选择器
            function updateAudioDeviceSelector() {
                const selector = document.getElementById('audioInputDevice');
                selector.innerHTML = '<option value="default" data-i18n-key="default_device" >默认设备</option>';

                // 设备名称映射表
                const deviceNameMap = {
                    'Speakerphone': '麦克风',
                    'Headset earpiece': 'USB音频'
                };

                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // 应用设备名称映射
                    let displayName = device.label || `音频设备 ${selector.options.length}`;
                    if (deviceNameMap[displayName]) {
                        displayName = deviceNameMap[displayName];
                    }
                    
                    // 为设备选项添加国际化支持
                    option.setAttribute('data-i18n-key', 'audio_device');
                    option.setAttribute('data-i18n-args', JSON.stringify({deviceName: displayName}));
                    
                    option.textContent = displayName;
                    selector.appendChild(option);
                });

                // 恢复之前保存的设备选择
                if (selectedDeviceId && selectedDeviceId !== 'default') {
                    selector.value = selectedDeviceId;
                }

                if (audioDevices.length > 0) {
                    deviceInfoEl.setAttribute('data-i18n-key', 'device_count_detected');
                    deviceInfoEl.setAttribute('data-i18n-args', JSON.stringify({count: audioDevices.length}));
                    deviceInfoEl.textContent = `${audioDevices.length} 个音频输入设备`;
                } else {
                    deviceInfoEl.setAttribute('data-i18n-key', 'device_count_none');
                    deviceInfoEl.textContent = "未检测到音频输入设备";
                }
            }

            // 检测是否有专业音频设备
            function checkForAudioInterfaces() {
                const hasProfessionalDevices = audioDevices.some(device =>
                    device.label.toLowerCase().includes('interface') ||
                    device.label.toLowerCase().includes('usb') ||
                    device.label.toLowerCase().includes('focusrite') ||
                    device.label.toLowerCase().includes('scarlett') ||
                    device.label.toLowerCase().includes('presonus') ||
                    device.label.toLowerCase().includes('behringer') ||
                    device.label.toLowerCase().includes('steinberg') ||
                    device.label.toLowerCase().includes('zoom') ||
                    device.label.toLowerCase().includes('boss') ||
                    device.label.toLowerCase().includes('line6')
                );

                if (hasProfessionalDevices) {
                    showAudioInterfaceTip();
                }
            }

            function showAudioInterfaceTip() {
                const tip = document.createElement('div');
                tip.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    background: rgba(56, 189, 248, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 1002;
                    max-width: 250px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                tip.innerHTML = `
                    <strong><span class="usb-indicator"></span> USB声卡已检测</strong><br>
                    建议选择您的音频接口设备以获得最佳效果
                `;
                document.body.appendChild(tip);

                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.parentNode.removeChild(tip);
                    }
                }, 5000);
            }

            // 使用指定设备重新启动音频
            async function restartAudioWithNewDevice() {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 100));
                startRecording();
            }

            // 启动麦克风录音 - 支持设备选择
            async function startRecording() {
                if (isRecording) return;

                try {
                    const constraints = {
                        audio: {
                            deviceId: selectedDeviceId !== 'default' ?
                                { exact: selectedDeviceId } : undefined,
                            sampleRate: 48000,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            latency: 0.01
                        }
                    };

                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 48000,
                            latencyHint: 'interactive'
                        });
                    }

                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 4096;

                    // 创建增益节点用于音量控制
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = inputGain;

                    // 默认使用ScriptProcessorNode（稳定性更好）
                    javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                    javascriptNode.onaudioprocess = processAudio;

                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    microphone.connect(gainNode);
                    gainNode.connect(analyser);
                    analyser.connect(javascriptNode);
                    javascriptNode.connect(audioContext.destination);

                    console.log('ScriptProcessorNode初始化成功');

                    isRecording = true;
                    state.microphoneInitialized = true;
                    updateStatusIndicator('录音中...', 'recording');

                    console.log('音频输入已启动，设备:',
                        selectedDeviceId === 'default' ? '默认设备' :
                            audioDevices.find(d => d.deviceId === selectedDeviceId)?.label);

                } catch (e) {
                    console.error('音频初始化失败:', e);
                    updateStatusIndicator('音频初始化失败', 'error');

                    // 尝试使用默认设置
                    if (e.name === 'OverconstrainedError') {
                        console.log('尝试使用兼容的音频设置...');
                        try {
                            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            initializeBasicAudio();
                        } catch (fallbackError) {
                            console.error('备用音频初始化也失败:', fallbackError);
                        }
                    }
                }
            }

            // 简化的音频初始化（兼容模式）
            async function initializeBasicAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
                
                // 兼容模式也使用ScriptProcessorNode（最稳定的方案）
                javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                javascriptNode.onaudioprocess = processAudio;

                microphone = audioContext.createMediaStreamSource(mediaStream);
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                console.log('兼容模式ScriptProcessorNode初始化成功');

                isRecording = true;
                state.microphoneInitialized = true;
                updateStatusIndicator('录音中(兼容模式)', 'recording');
            }

            // 停止麦克风录音
            function stopRecording() {
                if (!isRecording) return;

                // 清理AudioWorkletNode
                if (audioWorkletNode) {
                    audioWorkletNode.disconnect();
                    audioWorkletNode = null;
                }
                
                // 清理ScriptProcessorNode（兼容模式）
                if (javascriptNode) {
                    javascriptNode.disconnect();
                    javascriptNode = null;
                }
                
                if (analyser) {
                    analyser.disconnect();
                }
                if (microphone) {
                    microphone.disconnect();
                }
                if (gainNode) {
                    gainNode.disconnect();
                }

                isRecording = false;
            }

            // 完全关闭麦克风（退出应用时使用）
            function closeMicrophone() {
                stopRecording();

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                state.microphoneInitialized = false;
            }

            // 辅助函数和类
            class MedianFilter {
                constructor(size) {
                    this.size = Math.max(1, size | 0);
                    this.buffer = [];
                }
                push(val) {
                    this.buffer.push(val == null ? null : val);
                    if (this.buffer.length > this.size) this.buffer.shift();
                    const arr = this.buffer.filter(v => v != null);
                    if (arr.length === 0) return null;
                    const sorted = arr.slice().sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    if (sorted.length % 2 === 1) return sorted[mid];
                    return (sorted[mid - 1] + sorted[mid]) / 2;
                }
            }

            function ema(prev, current, alpha) {
                if (prev == null) return current;
                return alpha * current + (1 - alpha) * prev;
            }

            function applyHannWindow(buf) {
                const N = buf.length;
                for (let i = 0; i < N; i++) {
                    const w = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (N - 1)));
                    buf[i] *= w;
                }
            }

            function rms(buf) {
                let sum = 0;
                for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
                return Math.sqrt(sum / buf.length);
            }

            function downsampleBuffer(buffer, originalRate, targetRate) {
                if (targetRate >= originalRate) return buffer.slice(0);
                const ratio = originalRate / targetRate;
                const newLength = Math.floor(buffer.length / ratio);
                const out = new Float32Array(newLength);
                for (let i = 0; i < newLength; i++) {
                    const start = Math.floor(i * ratio);
                    const end = Math.floor((i + 1) * ratio);
                    let sum = 0;
                    for (let j = start; j < end && j < buffer.length; j++) sum += buffer[j];
                    out[i] = sum / Math.max(1, end - start);
                }
                return out;
            }

            function YINDetectorFactory(sampleRate, config) {
                config = config || {};
                const threshold = config.threshold || 0.15;
                const probabilityCliff = config.probabilityCliff || 0.1;
                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }
                    if (tauEstimate === -1) return null;
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }
                    const frequency = sampleRate / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));
                    if (probability < probabilityCliff) return null;
                    return { frequency, probability };
                };
            }

            // 增强版音高检测器
            class EnhancedPitchDetector {
                constructor() {
                    this.bufferSize = 8; // 增加缓冲区大小，提高稳定性
                    this.pitchBuffer = [];
                    this.lastStablePitch = null;
                    this.stabilityCounter = 0;
                    this.frequencyBias = { // 针对特定频率范围的偏差校正
                        'F': 1.02,  // 轻微提升F区域的检测值
                        'F♯': 0.98  // 轻微降低F♯区域的检测值
                    };
                }

                detect(float32AudioBuffer, sampleRate) {
                    // 使用YIN算法作为基础，但降低阈值提高灵敏度
                    const yinPitch = Pitchfinder.YIN({ threshold: 0.08 })(float32AudioBuffer);

                    // 使用增强的自相关检测
                    const autocorrPitch = this.autocorrelationDetect(float32AudioBuffer, sampleRate);

                    // 结合两种算法结果，并应用频率偏差校正
                    let finalPitch = this.combineResults(yinPitch, autocorrPitch, sampleRate);

                    // 应用更严格的滤波和缓冲
                    finalPitch = this.applyFilter(finalPitch);

                    // 应用频率偏差校正
                    finalPitch = this.applyFrequencyBias(finalPitch);

                    return finalPitch;
                }

                autocorrelationDetect(buffer, sampleRate) {
                    // 增强版自相关算法，特别优化中频区域检测
                    const maxLag = Math.floor(sampleRate / 65);
                    const minLag = Math.floor(sampleRate / 1000);

                    let bestLag = 0;
                    let bestCorrelation = -1;

                    // 使用加权窗口增强F和F♯区域的检测
                    const fFreq = 349.23;
                    const fSharpFreq = 369.99;
                    const fLag = Math.floor(sampleRate / fFreq);
                    const fSharpLag = Math.floor(sampleRate / fSharpFreq);

                    for (let lag = minLag; lag <= maxLag; lag++) {
                        let correlation = 0;

                        for (let i = 0; i < buffer.length - lag; i++) {
                            correlation += buffer[i] * buffer[i + lag];
                        }

                        correlation /= (buffer.length - lag);

                        // 应用汉宁窗减少边界效应
                        const window = 0.5 * (1 - Math.cos(2 * Math.PI * lag / maxLag));
                        correlation *= window;

                        // 对F和F♯区域应用额外权重
                        if (Math.abs(lag - fLag) < 10 || Math.abs(lag - fSharpLag) < 10) {
                            correlation *= 1.2; // 增强这些区域的相关性
                        }

                        if (correlation > bestCorrelation) {
                            bestCorrelation = correlation;
                            bestLag = lag;
                        }
                    }

                    return bestLag > 0 ? sampleRate / bestLag : null;
                }

                combineResults(yinPitch, autocorrPitch, sampleRate) {
                    if (!yinPitch || yinPitch <= 0) return autocorrPitch;
                    if (!autocorrPitch || autocorrPitch <= 0) return yinPitch;

                    const ratio = yinPitch / autocorrPitch;

                    // 更严格的一致性检查
                    if (ratio > 0.9 && ratio < 1.1) {
                        // 如果两种算法结果接近，取加权平均
                        return (yinPitch * 0.6 + autocorrPitch * 0.4);
                    }

                    // 否则选择置信度更高的结果
                    const yinConfidence = this.calculateConfidence(yinPitch, sampleRate);
                    const autocorrConfidence = this.calculateConfidence(autocorrPitch, sampleRate);

                    return yinConfidence > autocorrConfidence ? yinPitch : autocorrPitch;
                }

                applyFilter(pitch) {
                    if (!pitch || pitch <= 0) return null;

                    this.pitchBuffer.push(pitch);
                    if (this.pitchBuffer.length > this.bufferSize) {
                        this.pitchBuffer.shift();
                    }

                    // 使用中位数滤波而不是平均值，更能抵抗异常值
                    const sorted = [...this.pitchBuffer].sort((a, b) => a - b);
                    const medianPitch = sorted[Math.floor(sorted.length / 2)];

                    // 增强稳定性检测
                    if (this.lastStablePitch) {
                        const ratio = medianPitch / this.lastStablePitch;
                        if (ratio > 0.97 && ratio < 1.03) { // 更严格的稳定性标准
                            this.stabilityCounter++;
                        } else {
                            this.stabilityCounter = 0;
                        }
                    }

                    if (this.stabilityCounter >= 4) { // 需要更多的连续稳定样本
                        this.lastStablePitch = medianPitch;
                    }

                    return this.lastStablePitch || medianPitch;
                }

                applyFrequencyBias(pitch) {
                    if (!pitch) return null;

                    // 将频率转换为音符
                    const note = this.frequencyToNoteName(pitch);

                    // 应用特定音符的频率偏差校正
                    if (note && this.frequencyBias[note.name]) {
                        return pitch * this.frequencyBias[note.name];
                    }

                    return pitch;
                }

                frequencyToNoteName(frequency) {
                    const A4 = 440;
                    const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];

                    const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                    const noteIndex = Math.round(noteNum) % 12;
                    const octave = Math.floor(noteNum / 12) - 1;

                    return {
                        name: noteNames[noteIndex],
                        octave: octave
                    };
                }

                calculateConfidence(pitch, sampleRate) {
                    // 增强的置信度计算，特别关注F和F♯区域
                    if (pitch < 65 || pitch > 1000) return 0;

                    // F和F♯的频率范围
                    const isInFRange = pitch >= 340 && pitch <= 380;

                    // 对F和F♯区域给予更高的基础置信度
                    let confidence = isInFRange ? 1.2 : 1.0;

                    // 根据频率范围调整置信度
                    if (pitch < 100) confidence *= 0.8;
                    else if (pitch > 800) confidence *= 0.8;

                    return Math.min(1.0, confidence);
                }
            }

            // 音高检测辅助变量
            const medianFilter = new MedianFilter(5);
            let smoothedFreq = null;

            // 频率转换为音符名称和八度
            function freqToNoteInfo(freq) {
                if (!freq || freq <= 0) return null;
                const A4 = 440;
                const noteNumber = 12 * (Math.log(freq / A4) / Math.log(2)) + 69;
                const rounded = Math.round(noteNumber);
                const noteIndex = (rounded + 120) % 12;
                const octave = Math.floor(rounded / 12) - 1;
                const name = NOTE_NAMES[noteIndex] + octave;
                const cents = Math.round((noteNumber - rounded) * 100);
                return { name, cents, midi: rounded };
            }

            
            // 将频率转换为音符名（不考虑八度）
            function frequencyToNoteName(frequency) {
                // A4 = 440Hz
                const A4 = 440;
                const semitones = Math.round(12 * Math.log2(frequency / A4));
                let noteIndex = (9 + semitones) % 12;
                
                // 调试信息
                console.log(`频率转换调试: ${frequency}Hz -> semitones=${semitones}, noteIndex=${noteIndex}`);
                
                // 确保noteIndex为正数
                if (noteIndex < 0) {
                    noteIndex = noteIndex + 12;
                    console.log(`修正负数noteIndex: ${noteIndex}`);
                }
                
                // 使用升号表示法，因为这是更常见的表示方式
                const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];
                const result = noteNames[noteIndex];
                console.log(`最终结果: noteNames[${noteIndex}] = ${result}`);
                return result;
            }
            
            // 判断两个音符是否等价（考虑升号和降号）
            function isEquivalentNote(note1, note2) {
                if (note1 === note2) return true;
                
                // 定义等价的音符对
                const equivalentPairs = [
                    ['C♯', 'D♭'], ['D♯', 'E♭'], ['F♯', 'G♭'], 
                    ['G♯', 'A♭'], ['A♯', 'B♭']
                ];
                
                for (const pair of equivalentPairs) {
                    if ((note1 === pair[0] && note2 === pair[1]) || 
                        (note1 === pair[1] && note2 === pair[0])) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // 处理找音练习正确答案
            function handlePitchFindingCorrect() {
                if (state.pitchFindingAnswered) return;

                state.pitchFindingAnswered = true;
                state.pitchFindingCorrect = true;

                // 在指板上显示该音符的所有位置
                showNoteOnFretboard(state.currentNote);

                // 获取下一题间隔时间设置
                const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;

                // 检查指板是否显示
                const fretboardContainer = document.getElementById('fretboardContainer');
                const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';

                // 动态设置延迟时间：
                // - 指板隐藏时：立即自动进入下一题（忽略手动模式设置）
                // - 指板显示且手动模式：不自动切换，等待用户手动操作
                // - 指板显示且自动模式：使用设置的延迟时间
                let delayTime;
                if (!isFretboardVisible) {
                    // 指板隐藏时立即自动切换（100ms最小延迟避免闪烁）
                    delayTime = 100;
                    console.log(`找音练习指板隐藏: 立即自动切换下一题`);
                } else if (intervalSeconds === 0) {
                    // 指板显示且手动模式：不设置自动切换
                    delayTime = 0;
                    console.log(`找音练习指板显示且手动模式: 不自动切换下一题，等待用户操作`);
                } else {
                    // 指板显示且自动模式：使用设置的延迟时间
                    delayTime = intervalSeconds * 1000;
                    console.log(`找音练习指板显示且自动模式: 延迟${delayTime}ms切换下一题`);
                }

                if (delayTime > 0) {
                    console.log(`找音练习设置自动延迟: ${delayTime}ms`);
                    // 设置自动进入下一题的定时器
                    state.pitchFindingNextTimeout = setTimeout(() => {
                        generateNextPitchFindingQuestion();
                    }, delayTime);
                }
            }

            // 暴露到全局作用域，让MIDI处理可以访问
            window.handlePitchFindingCorrect = handlePitchFindingCorrect;
            
            // 生成下一个找音练习题目
            function generateNextPitchFindingQuestion() {
                // 清除之前的定时器
                if (state.pitchFindingNextTimeout) {
                    clearTimeout(state.pitchFindingNextTimeout);
                    state.pitchFindingNextTimeout = null;
                }
                
                // 重置状态
                state.pitchFindingAnswered = false;
                state.pitchFindingCorrect = false;
                
                // 清除指板上的高亮和音符显示
                clearFretboardHighlights();
                
                // 生成新的随机音符
                const notes = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                const randomNote = notes[Math.floor(Math.random() * notes.length)];
                
                // 更新显示
                document.getElementById('currentNoteDisplay').textContent = randomNote;
                state.currentNote = randomNote;
            }
            
            // 在指板上显示音符的所有位置
            function showNoteOnFretboard(noteName) {
                const fretboard = document.getElementById('fretboard');
                if (!fretboard) return;
                
                const frets = fretboard.querySelectorAll('.fretboard-fret');
                
                // 清除之前的高亮
                clearFretboardHighlights();
                
                // 吉他弦的开放音（从1弦到6弦）
                const strings = ['E', 'B', 'G', 'D', 'A', 'E'];
                
                // 获取选择的指板长度
                const selectedRangeBtn = document.querySelector('.pitch-finding-range-btn.active');
                const maxFret = selectedRangeBtn ? parseInt(selectedRangeBtn.dataset.value) : 12;
                
                // 计算每根弦上该音符的位置
                strings.forEach((openNote, stringIndex) => {
                    const openNoteValue = noteToSemitones[openNote];
                    const targetNoteValue = noteToSemitones[noteName];
                    
                    // 计算从开放音到目标音符的半音数
                    let semitones = (targetNoteValue - openNoteValue + 12) % 12;
                    
                    // 检查是否在指板范围内
                    if (semitones <= maxFret) {
                        const fretElement = frets[stringIndex * (maxFret + 1) + semitones];
                        if (fretElement) {
                            // 高亮背景
                            fretElement.style.backgroundColor = '#3b82f6';
                            fretElement.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.5)';
                            
                            // 添加音符名称显示，居中定位
                            const noteDisplay = document.createElement('div');
                            noteDisplay.className = 'note-display';
                            noteDisplay.textContent = noteName;
                            noteDisplay.style.cssText = `
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                font-size: 12px;
                                color: #fff;
                                font-weight: bold;
                                z-index: 10;
                                pointer-events: none;
                            `;
                            fretElement.appendChild(noteDisplay);
                        }
                    }
                });
            }
            
            // 清除指板上的高亮
            function clearFretboardHighlights() {
                const fretboard = document.getElementById('fretboard');
                if (!fretboard) return;
                
                const frets = fretboard.querySelectorAll('.fretboard-fret');
                
                frets.forEach(fret => {
                    fret.style.backgroundColor = '';
                    fret.style.boxShadow = '';
                    
                    // 移除音符显示和音程显示
                    const noteDisplay = fret.querySelector('.note-display');
                    if (noteDisplay) {
                        noteDisplay.remove();
                    }
                    
                    const intervalDisplay = fret.querySelector('.interval-display');
                    if (intervalDisplay) {
                        intervalDisplay.remove();
                    }
                });
                
                // 清除可能存在的fretboard-note元素（旧版本的音符显示）
                const existingNotes = fretboard.querySelectorAll('.fretboard-note');
                existingNotes.forEach(note => note.remove());
                
                // 清除CAGED相关元素（重要：防止在非CAGED练习中显示）
                const fretboardContainer = document.getElementById('fretboardContainer');
                if (fretboardContainer) {
                    const cagedElements = fretboardContainer.querySelectorAll('.caged-shape-highlight, .caged-fingering');
                    if (cagedElements.length > 0) {
                        cagedElements.forEach(el => el.remove());
                        console.log('清除CAGED元素:', cagedElements.length, '个');
                    }
                }
            }

            // 检查音程匹配的辅助函数
            function checkIntervalMatch(detectedNote, targetIntervalPair, rootNote) {
                // 获取根音值
                const rootValue = noteToSemitones[rootNote] || 0;
                
                // 解析目标音程对（如 "1 7" 或 "7 b13"）
                const intervals = targetIntervalPair.split(' ');
                if (intervals.length !== 2) {
                    console.error('目标音程格式错误:', targetIntervalPair);
                    return null;
                }
                
                // 计算两个音程的目标音符值
                const interval1Semitones = intervalToSemitones[intervals[0]] || 0;
                const interval2Semitones = intervalToSemitones[intervals[1]] || 0;
                
                const targetNote1Value = (rootValue + interval1Semitones) % 12;
                const targetNote2Value = (rootValue + interval2Semitones) % 12;
                
                // 计算检测到的音符值
                const detectedNoteValue = noteToSemitones[detectedNote] || 0;
                
                // 检查匹配哪个音程
                let matchedInterval = null;
                if (detectedNoteValue === targetNote1Value) {
                    matchedInterval = intervals[0];
                } else if (detectedNoteValue === targetNote2Value) {
                    matchedInterval = intervals[1];
                }
                
                // 调试信息
                console.log(`音程练习匹配检查:`);
                console.log(`- 根音: ${rootNote} (${rootValue})`);
                console.log(`- 目标音程对: ${targetIntervalPair}`);
                console.log(`- 音程1: ${intervals[0]} -> 半音数 ${interval1Semitones} -> 音符值 ${targetNote1Value}`);
                console.log(`- 音程2: ${intervals[1]} -> 半音数 ${interval2Semitones} -> 音符值 ${targetNote2Value}`);
                console.log(`- 检测到的音符: ${detectedNote} (${detectedNoteValue})`);
                console.log(`- 匹配的音程: ${matchedInterval}`);
                
                // 额外调试：显示目标音符名称
                const targetNote1Name = Object.keys(noteToSemitones).find(key => noteToSemitones[key] === targetNote1Value);
                const targetNote2Name = Object.keys(noteToSemitones).find(key => noteToSemitones[key] === targetNote2Value);
                console.log(`- 目标音符1: ${targetNote1Name} (${targetNote1Value})`);
                console.log(`- 目标音符2: ${targetNote2Name} (${targetNote2Value})`);
                
                return matchedInterval;
            }

            // 处理音程练习部分正确的函数（弹对了其中一个音程）
            function handleIntervalPartialCorrect(matchedInterval) {
                if (!state.currentIntervalExercise || state.currentIntervalExercise.answered) return;
                
                // 初始化已完成的音程数组
                if (!state.currentIntervalExercise.completedIntervals) {
                    state.currentIntervalExercise.completedIntervals = [];
                }
                
                // 检查这个音程是否已经弹对过了
                if (state.currentIntervalExercise.completedIntervals.includes(matchedInterval)) {
                    console.log(`音程 ${matchedInterval} 已经弹对过了，忽略重复`);
                    return;
                }
                
                // 添加到已完成列表
                state.currentIntervalExercise.completedIntervals.push(matchedInterval);
                console.log(`音程 ${matchedInterval} 弹对了！已完成: ${state.currentIntervalExercise.completedIntervals.join(', ')}`);
                
                // 更新显示，将弹对的音程变灰
                updateIntervalDisplay(matchedInterval);
                
                // 检查是否所有音程都弹对了
                const intervals = state.currentIntervalExercise.currentInterval.split(' ');
                if (state.currentIntervalExercise.completedIntervals.length >= intervals.length) {
                    // 所有音程都弹对了，完成这道题
                    handleIntervalFullyCorrect();
                }
            }

            // 更新音程显示，将弹对的音程变灰
            function updateIntervalDisplay(completedInterval) {
                const intervalDisplay = document.getElementById('intervalExerciseDisplay');
                if (!intervalDisplay) return;
                
                // 查找当前题目显示元素并更新
                const currentInterval = intervalDisplay.querySelector('.current-interval');
                if (currentInterval) {
                    const intervals = state.currentIntervalExercise.currentInterval.split(' ');
                    const completedIntervals = state.currentIntervalExercise.completedIntervals || [];
                    
                    // 重新构建当前题目显示，已完成的音程用灰色显示
                    const displayText = intervals.map(interval => {
                        if (completedIntervals.includes(interval)) {
                            return `<span style="color: #888;">${interval}</span>`;
                        } else {
                            return interval;
                        }
                    }).join(' ');
                    
                    currentInterval.innerHTML = displayText;
                }
                
                console.log(`音程显示已更新，已完成: ${state.currentIntervalExercise.completedIntervals.join(', ')}`);
            }

            // 处理音程练习完全正确的函数（所有音程都弹对了）
            function handleIntervalFullyCorrect() {
                if (!state.currentIntervalExercise || state.currentIntervalExercise.answered) return;
                
                state.currentIntervalExercise.answered = true;
                
                // 检查是否显示指板（检查设置和当前状态）
                const showFretboard = document.getElementById('showFretboard').checked;
                const fretboardContainer = document.getElementById('fretboardContainer');
                const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';
                
                if (showFretboard && isFretboardVisible) {
                    // 在指板上显示当前题目的两个音级
                    showIntervalOnFretboard(state.currentIntervalExercise.currentInterval, state.currentIntervalExercise.rootNote);
                }
                
                // 获取下一题间隔时间
                const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;
                
                // 动态设置延迟时间：
                // - 指板隐藏时：立即自动进入下一题（忽略手动模式设置）
                // - 指板显示且手动模式：不自动切换，等待用户手动操作
                // - 指板显示且自动模式：使用设置的延迟时间
                let delayTime;
                if (!isFretboardVisible) {
                    // 指板隐藏时立即自动切换（100ms最小延迟避免闪烁）
                    delayTime = 100;
                    console.log(`音程练习指板隐藏: 立即自动切换下一题`);
                } else if (intervalSeconds === 0) {
                    // 指板显示且手动模式：不设置自动切换
                    delayTime = 0;
                    console.log(`音程练习指板显示且手动模式: 不自动切换下一题，等待用户操作`);
                } else {
                    // 指板显示且自动模式：使用设置的延迟时间
                    delayTime = intervalSeconds * 1000;
                    console.log(`音程练习指板显示且自动模式: 延迟${delayTime}ms切换下一题`);
                }

                if (delayTime > 0) {
                    console.log(`音程练习自动延迟: 指板显示=${isFretboardVisible}, 延迟时间=${delayTime}ms`);
                    // 设置音程练习延迟定时器
                    state.intervalNextTimeout = setTimeout(() => {
                        generateNextIntervalExercise();
                    }, delayTime);
                }
            }

            // 在指板上显示音程位置的函数
            function showIntervalOnFretboard(intervalPair, rootNote) {
                const fretboard = document.getElementById('fretboard');
                if (!fretboard) return;
                
                // 解析音程对
                const intervals = intervalPair.split(' ');
                if (intervals.length !== 2) return;
                
                // 清除之前的高亮
                clearFretboardHighlights();
                
                // 获取根音值
                const rootValue = noteToSemitones[rootNote] || 0;
                
                // 吉他弦的开放音（从1弦到6弦）
                const strings = ['E', 'B', 'G', 'D', 'A', 'E'];
                
                // 获取选择的指板长度
                const selectedRangeBtn = document.querySelector('.pitch-finding-range-btn.active');
                const maxFret = selectedRangeBtn ? parseInt(selectedRangeBtn.dataset.value) : 12;
                
                // 显示两个音程在指板上的位置
                intervals.forEach(interval => {
                    const intervalSemitones = intervalToSemitones[interval] || 0;
                    const targetNoteValue = (rootValue + intervalSemitones) % 12;
                    
                    // 计算每根弦上该音符的位置
                    strings.forEach((openNote, stringIndex) => {
                        const openNoteValue = noteToSemitones[openNote];
                        
                        // 计算从开放音到目标音符的半音数
                        let semitones = (targetNoteValue - openNoteValue + 12) % 12;
                        
                        // 检查是否在指板范围内
                        if (semitones <= maxFret) {
                            const frets = fretboard.querySelectorAll('.fretboard-fret');
                            const fretElement = frets[stringIndex * (maxFret + 1) + semitones];
                            if (fretElement) {
                                // 高亮背景
                                fretElement.style.backgroundColor = '#3b82f6';
                                fretElement.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.5)';
                                
                                // 添加音程标记，居中定位
                                const intervalDisplay = document.createElement('div');
                                intervalDisplay.className = 'interval-display';
                                intervalDisplay.textContent = interval;
                                intervalDisplay.style.cssText = `
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    font-size: 12px;
                                    color: #fff;
                                    font-weight: bold;
                                    z-index: 10;
                                    pointer-events: none;
                                `;
                                fretElement.appendChild(intervalDisplay);
                            }
                        }
                    });
                });
            }

            // 音程练习的音频处理函数
            function processIntervalAudio(inputData, sampleRate) {
                if (!state.currentIntervalExercise || state.currentIntervalExercise.answered) return;
                
                const yinResult = Pitchfinder.YIN({ threshold: 0.1, probabilityCliff: 0.1 })(inputData);
                if (!yinResult || !yinResult.frequency) return;
                
                const energy = rms(inputData);
                if (energy < 0.002) return;
                
                const detectedNote = frequencyToNoteName(yinResult.frequency);
                const exercise = state.currentIntervalExercise;
                
                console.log(`音程练习音频处理: 频率=${yinResult.frequency.toFixed(2)}Hz, 检测音符=${detectedNote}, 目标音程=${exercise.currentInterval}, 根音=${exercise.rootNote}`);
                
                // 检查是否匹配当前音程对中的某个音程
                const matchedInterval = checkIntervalMatch(detectedNote, exercise.currentInterval, exercise.rootNote);
                if (matchedInterval) {
                    handleIntervalPartialCorrect(matchedInterval);
                } else {
                    console.log(`音程练习: 未匹配到任何音程`);
                }
                
                updatePitchDisplay(yinResult.frequency, 0, yinResult.probability);
            }

            // 找音练习的音频处理函数
            function processPitchFindingAudio(inputData, sampleRate) {
                console.log('processPitchFindingAudio 被调用');
                
                // 检查是否为音程练习模式
                const practiceMode = document.querySelector('.practice-mode-btn.active');
                console.log('当前练习模式:', practiceMode ? practiceMode.dataset.mode : 'null');
                
                if (practiceMode && practiceMode.dataset.mode === 'interval') {
                    // 音程练习模式
                    console.log('路由到音程练习模式');
                    processIntervalAudio(inputData, sampleRate);
                    return;
                }
                
                // 单音练习模式
                console.log('单音练习模式 - pitchFindingAnswered:', state.pitchFindingAnswered);
                console.log('当前目标音符:', state.currentNote);
                
                if (state.pitchFindingAnswered) return;

                const yinResult = Pitchfinder.YIN({ threshold: 0.1, probabilityCliff: 0.1 })(inputData);
                if (!yinResult || !yinResult.frequency) {
                    console.log('YIN检测失败或无频率');
                    return;
                }

                const energy = rms(inputData);
                if (energy < 0.002) {
                    console.log('能量过低，忽略');
                    return;
                }
                
                const detectedNote = frequencyToNoteName(yinResult.frequency); // 直接返回音符名字符串
                console.log('检测到音符:', detectedNote, '(类型:', typeof detectedNote, ') 目标音符:', state.currentNote, '(类型:', typeof state.currentNote, ')');
                
                if (detectedNote === state.currentNote || isEquivalentNote(detectedNote, state.currentNote)) {
                    console.log('音符匹配！调用handlePitchFindingCorrect');
                    handlePitchFindingCorrect();
                } else {
                    console.log('音符不匹配');
                }
                updatePitchDisplay(yinResult.frequency, 0, yinResult.probability);
            }

            // 处理AudioWorklet的音高检测结果
            function handlePitchDetectionResult(event) {
                if (!isRecording || state.isAnswered || (state.enableCooldown && state.isCoolingDown)) return;

                const { type, data } = event.data;

                // 处理调试信息
                if (type === 'debug') {
                    console.log('AudioWorklet Debug:', data);
                    if (data.hasSignal) {
                        console.log('AudioWorklet: 检测到音频信号，振幅:', data.amplitude.toFixed(6));
                    } else {
                        console.log('AudioWorklet: 无音频信号');
                    }
                    return;
                }

                // 处理YIN算法调试信息
                if (type === 'yinDebug') {
                    console.log('YIN算法结果:', data);
                    if (data.hasResult && data.frequency > 0) {
                        console.log(`YIN检测到音高: ${data.frequency.toFixed(2)}Hz, 音符: ${data.detectedNote}, 概率: ${data.probability.toFixed(3)}`);

                        // 计算标准音高对比
                        const noteFrequencies = {
                            'C': [130.81, 261.63, 523.25],  // C3, C4, C5
                            'B': [123.47, 246.94, 493.88],  // B2, B3, B4
                        };

                        console.log(`C音标准频率: ${noteFrequencies.C.join('Hz, ')}Hz`);
                        console.log(`B音标准频率: ${noteFrequencies.B.join('Hz, ')}Hz`);

                        // 计算偏差
                        const closestC = noteFrequencies.C.reduce((prev, curr) =>
                            Math.abs(curr - data.frequency) < Math.abs(prev - data.frequency) ? curr : prev
                        );
                        const closestB = noteFrequencies.B.reduce((prev, curr) =>
                            Math.abs(curr - data.frequency) < Math.abs(prev - data.frequency) ? curr : prev
                        );

                        console.log(`与C音偏差: ${Math.abs(data.frequency - closestC).toFixed(2)}Hz`);
                        console.log(`与B音偏差: ${Math.abs(data.frequency - closestB).toFixed(2)}Hz`);
                    } else {
                        console.log('YIN未检测到有效音高，阈值:', data.threshold);
                    }
                    return;
                }

                // 处理信号调试信息
                if (type === 'signalDebug') {
                    console.log(`信号检测: RMS=${data.rms.toFixed(6)}, ${data.message}`);
                    return;
                }

                if (type === 'pitchDetected') {
                    const { frequency, probability, detectedNote, isRaw, rms } = data;

                    if (isRaw) {
                        console.log(`AudioWorklet原始音高: ${frequency.toFixed(2)}Hz (${detectedNote}), 概率: ${probability.toFixed(3)}, RMS: ${(rms || 0).toFixed(4)}`);
                    } else {
                        console.log('AudioWorklet: 检测到音高', frequency.toFixed(2) + 'Hz, 概率:', probability.toFixed(3));
                    }

                    // 根据当前练习模式处理检测到的音高
                    if (window.cagedState && window.cagedState.enabled && state.cagedMode) {
                        processCagedAudioWithFrequency(frequency, probability);
                    } else if (state.pitchFindingMode) {
                        processPitchFindingAudioWithFrequency(frequency, probability);
                    } else {
                        processRegularAudioWithFrequency(frequency, probability);
                    }
                }
            }
            
            // 处理CAGED练习模式的音高检测
            function processCagedAudioWithFrequency(frequency, probability) {
                if (!window.cagedState || !window.cagedState.enabled) return;
                
                const cagedState = window.cagedState;
                const currentInterval = cagedState.currentIntervals[cagedState.currentStep];
                
                if (!currentInterval) return;
                
                // 计算目标频率
                const rootValue = noteToSemitones[cagedState.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);
                
                // 计算音分差
                const cents = 1200 * Math.log2(frequency / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;
                
                // 动态调整匹配阈值
                const baseThreshold = frequency < 110 ? 35 : 15;
                const sensitivity = parseFloat(document.getElementById('sensitivity').value) || 0.5;
                const threshold = baseThreshold * (2 - sensitivity);
                
                if (adjustedCents <= threshold) {
                    // CAGED练习答对
                    handleCagedCorrect();
                } else {
                    // 显示音分差
                    updatePitchDisplay(frequency, adjustedCents, probability);
                }
            }
            
            // 处理音程练习模式的音高检测
            function processPitchFindingAudioWithFrequency(frequency, probability) {
                if (!state.currentIntervalExercise) return;
                
                const exercise = state.currentIntervalExercise;
                const targetNote = exercise.targetNote;
                
                // 将频率转换为音符名
                const detectedNote = frequencyToNoteName(frequency);
                
                if (detectedNote === targetNote || isEquivalentNote(detectedNote, targetNote)) {
                    // 音程练习答对
                    handleIntervalPartialCorrect(exercise.targetInterval);
                } else {
                    // 显示当前检测到的音符
                    updatePitchDisplay(frequency, 0, probability);
                }
            }
            
            // 处理常规练习模式的音高检测
            function processRegularAudioWithFrequency(frequency, probability) {
                // 动态调整YIN算法参数 - 低频使用更高灵敏度
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    if (!interval || !intervalToSemitones.hasOwnProperty(interval)) {
                        console.error(`未知的音级: ${interval}`, { interval, currentSequence: state.currentSequence });
                        return false;
                    }
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110;
                });

                // 动态能量检测 - 低频使用更低阈值
                const energyThreshold = frequency < 110 ? 0.001 : 0.002;
                
                // 谐波增强处理 - 特别针对低频
                let detectedFreq = frequency;
                if (detectedFreq < 110) {
                    // 检查是否是基频的谐波
                    const possibleFundamental = detectedFreq / 2;
                    if (Math.abs(frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }

                // 添加防护检查
                if (!state.currentSequence || state.currentStep >= state.currentSequence.length) {
                    console.error('processRegularAudioWithFrequency中currentSequence或currentStep无效:', {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        sequenceLength: state.currentSequence ? state.currentSequence.length : 'undefined'
                    });
                    return;
                }

                const currentInterval = state.currentSequence[state.currentStep];
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`processRegularAudioWithFrequency中未知的音级: ${currentInterval}`, {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        intervalValue: currentInterval
                    });
                    return;
                }
                
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // 优化音高匹配算法
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // 动态调整匹配阈值 - 低频更宽松，并且基于敏感度设置
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                const sensitivity = parseFloat(document.getElementById('sensitivity').value) || 0.5;
                const threshold = baseThreshold * (2 - sensitivity);

                if (adjustedCents <= threshold) {
                    // 音高匹配成功
                    handleCorrectAnswer();
                } else {
                    // 显示音分差
                    updatePitchDisplay(detectedFreq, adjustedCents, probability);
                }
            }

            // 增强低频检测的音频处理函数
            // 修改processAudio函数，在冷却期内不处理音频
            function processAudio(event) {
                if (!isRecording || state.isAnswered || (state.enableCooldown && state.isCoolingDown)) return;

                const inputData = event.inputBuffer.getChannelData(0);
                const sampleRate = audioContext.sampleRate;
                
                // 调试：显示当前状态
                // console.log('processAudio - pitchFindingMode:', state.pitchFindingMode, 'cagedMode:', state.cagedMode);
                
                // 如果是CAGED练习模式，使用CAGED音频处理
                if (window.cagedState && window.cagedState.enabled && state.cagedMode) {
                    processCagedAudio(inputData, sampleRate);
                    return;
                }
                
                // 如果是找音练习模式，使用不同的处理逻辑
                if (state.pitchFindingMode) {
                    processPitchFindingAudio(inputData, sampleRate);
                    return;
                }
                

                // 动态调整YIN算法参数 - 低频使用更高灵敏度
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    // 检查音级是否在映射中存在
                    if (!interval || !intervalToSemitones.hasOwnProperty(interval)) {
                        console.error(`未知的音级: ${interval}`, { interval, currentSequence: state.currentSequence });
                        return false;
                    }
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110;
                });

                const yinParams = isLowFrequencyTarget ?
                    { threshold: 0.05, probabilityCliff: 0.05 } : // 低频参数
                    { threshold: 0.1, probabilityCliff: 0.1 };   // 常规参数

                const yinResult = Pitchfinder.YIN(yinParams)(inputData);

                if (!yinResult || !yinResult.frequency) return;

                // 动态能量检测 - 低频使用更低阈值
                const energy = rms(inputData);
                const energyThreshold = yinResult.frequency < 110 ? 0.001 : 0.002;
                if (energy < energyThreshold) return;

                // 谐波增强处理 - 特别针对低频
                let detectedFreq = yinResult.frequency;
                if (detectedFreq < 110) {
                    // 检查是否是基频的谐波
                    const possibleFundamental = detectedFreq / 2;
                    const fundamentalResult = Pitchfinder.YIN(yinParams)(inputData);
                    if (fundamentalResult && fundamentalResult.frequency &&
                        Math.abs(fundamentalResult.frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }

                // 添加防护检查
                if (!state.currentSequence || state.currentStep >= state.currentSequence.length) {
                    console.error('processAudio中currentSequence或currentStep无效:', {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        sequenceLength: state.currentSequence ? state.currentSequence.length : 'undefined'
                    });
                    return;
                }

                const currentInterval = state.currentSequence[state.currentStep];
                // 检查音级是否在映射中存在
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`processAudio中未知的音级: ${currentInterval}`, {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        intervalValue: currentInterval
                    });
                    return;
                }
                
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;

                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // 优化音高匹配算法
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // 动态调整匹配阈值 - 低频更宽松，并且基于敏感度设置
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                
                // 根据敏感度调整阈值 - 敏感度越高，阈值越小
                const threshold = baseThreshold * (2 - state.sensitivity);

                if (adjustedCents <= threshold && yinResult.probability > state.confidenceThreshold) {
                    handleCorrectAnswer();
                }

                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }


            // 应用高通滤波器
            function applyHighPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = RC / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = alpha * (y + buffer[i] - buffer[i - 1]);
                    buffer[i] = y;
                }
            }

            // 应用低通滤波器
            function applyLowPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = dt / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = y + alpha * (buffer[i] - y);
                    buffer[i] = y;
                }
            }

            // 计算信号强度作为置信度的估计
            function calculateSignalStrength(buffer) {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += Math.abs(buffer[i]);
                }
                const average = sum / buffer.length;
                return Math.min(1.0, average * 10);
            }


            // 检查检测到的音高是否匹配当前步骤的目标音高
            function checkPitchMatch(detectedPitch, confidence) {
                if (state.isAnswered || confidence < state.confidenceThreshold) return;

                // 添加防护检查
                if (!state.currentSequence || state.currentStep >= state.currentSequence.length) {
                    console.error('currentSequence或currentStep无效:', {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        sequenceLength: state.currentSequence ? state.currentSequence.length : 'undefined'
                    });
                    return;
                }

                const currentInterval = state.currentSequence[state.currentStep];
                // 检查音级是否在映射中存在
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`未知的音级: ${currentInterval}`, {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        intervalValue: currentInterval
                    });
                    return;
                }
                
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // 优化音高匹配算法
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // 动态调整匹配阈值 - 低频更宽松，并且基于敏感度设置
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                
                // 根据敏感度调整阈值 - 敏感度越高，阈值越小
                const threshold = baseThreshold * (2 - state.sensitivity);

                if (adjustedCents <= threshold && yinResult.probability > state.confidenceThreshold) {
                    handleCorrectAnswer();
                }

                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }

            // 更新实时音高显示
            function updatePitchDisplay(frequency, cents, confidence) {
                const pitchDisplay = document.getElementById('pitchDisplay');
                if (!pitchDisplay) return;

                const note = frequencyToNoteName(frequency);
                const centsMod = cents % 1200;
                const adjustedCents = centsMod > 600 ? centsMod - 1200 : centsMod;
                const roundedFreq = Math.round(frequency);
                const roundedCents = Math.round(adjustedCents);
                const confidencePercent = Math.round(confidence * 100);

                if (!pitchDisplay._cache) {
                    pitchDisplay._cache = {
                        note: '',
                        octave: '',
                        freq: 0,
                        cents: 0,
                        confidence: 0,
                        inTune: false
                    };
                }

                const cache = pitchDisplay._cache;
                const inTune = Math.abs(adjustedCents) <= 20;

                if (cache.note !== note.name ||
                    cache.octave !== note.octave ||
                    cache.freq !== roundedFreq ||
                    cache.cents !== roundedCents ||
                    cache.confidence !== confidencePercent ||
                    cache.inTune !== inTune) {

                    cache.note = note.name;
                    cache.octave = note.octave;
                    cache.freq = roundedFreq;
                    cache.cents = roundedCents;
                    cache.confidence = confidencePercent;
                    cache.inTune = inTune;

                    const children = pitchDisplay.children;

                    if (children.length < 3) {
                        pitchDisplay.innerHTML = `
                            <div>音高: ${note.name}${note.octave} (${roundedFreq}Hz)</div>
                            <div>音分差: ${adjustedCents > 0 ? '+' : ''}${roundedCents}</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        `;
                    } else {
                        children[0].textContent = `音高: ${note.name}${note.octave} (${roundedFreq}Hz)`;
                        children[1].textContent = `音分差: ${adjustedCents > 0 ? '+' : ''}${roundedCents}`;
                        children[2].querySelector('.confidence-fill').style.width = `${confidencePercent}%`;
                    }

                    pitchDisplay.classList.toggle('in-tune', inTune);
                    pitchDisplay.classList.toggle('out-of-tune', !inTune);
                }
            }

            // 优化后的正确答案处理
            function handleCorrectAnswer() {
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;

                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }

                requestAnimationFrame(() => {
                    if (state.currentStep >= state.currentSequence.length) {
                        state.isAnswered = true;

                        // 根据设置决定是否进入冷却期
                        if (state.enableCooldown) {
                            state.isCoolingDown = true;
                            if (state.cooldownTimeout) {
                                clearTimeout(state.cooldownTimeout);
                            }
                            state.cooldownTimeout = setTimeout(() => {
                                state.isCoolingDown = false;
                            }, state.cooldownDuration);
                        }

                        // 根据设置决定延迟时间
                        let delayTime = 0; // 默认无延迟
                        if (state.enableFixedDelay) {
                            delayTime = state.fixedDelayDuration;
                        }

                        // 延迟生成下一题，给用户停止弹奏的时间
                        setTimeout(() => {
                            generateExercise();
                        }, delayTime);
                    } else {
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                    }
                });
            }

            // 通用函数：重置CAGED模式状态
            function resetCagedModeState() {
                state.cagedMode = false;
                
                // 隐藏CAGED形状显示区域
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'none';
                }
            }

            // 预生成下一个练习
            function generateNextExercise() {
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;

                if (activeTab === 'scale') {
                    let rootNote = rootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }

                    let scaleType = 'random'; // 在多选模式下，总是使用随机选择
                    // 使用多选调式选择器的随机功能
                    scaleType = window.getRandomSelectedScaleType ?
                        window.getRandomSelectedScaleType() :
                        (function() {
                            const types = Object.keys(scaleTypes);
                            return types[Math.floor(Math.random() * types.length)];
                        })();

                    // 保存预选的调式，确保实际生成下一题时使用相同的调式
                    state.nextScaleType = scaleType;
                    state.nextRootNote = rootNote;

                    // 获取方向
                    const activeOrderBtn = document.querySelector('.scale-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                    // 获取旋律模进类型
                    const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                    let arpeggioType = '1to1';
                    
                    for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                      if (arpeggioTypeButtons[i].classList.contains('active')) {
                        arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                        break;
                      }
                    }

                    // 特殊处理旋律小调：根据方向选择上行或下行形式
                    let intervals;
                    let isMelodicMinorDescending = false;
                    if (scaleType === 'melodicMinor' && order === 'reverse') {
                        // 下行旋律小调
                        intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                        isMelodicMinorDescending = true;
                    } else {
                        // 默认使用上行形式
                        intervals = [...scaleTypes[scaleType].intervals];
                    }
                    state.currentIntervals = intervals;
                    let startEndInterval = '1'; // 默认使用1作为首尾音
                    
                    // 根据练习序列类型确定首尾音
                    if (arpeggioType === 'random-arpeggio') {
                        // 随机选择1、3、5、7音作为首尾音，但只包含音阶中实际存在的音程
                        const availableChordTones = [];
                        const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                        if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                        const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                        if (fifthInterval) availableChordTones.push(fifthInterval);
                        const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                        if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                        
                        // 如果有可用的3/5/7度音程，则从中随机选择
                        if (availableChordTones.length > 0) {
                            startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                        } else {
                            startEndInterval = '1'; // 回退到根音
                        }
                    } else if (arpeggioType === '3to3') {
                        // 使用3音作为首尾音
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    } else if (arpeggioType === '5to5') {
                        // 使用5音作为首尾音
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    } else if (arpeggioType === '7to7') {
                        // 使用7音作为首尾音
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                        // 处理其他特定音程作为首尾音的情况（如♯6→♯6）
                        // arpeggioType格式为"xtox"，提取x部分
                        const match = arpeggioType.match(/^(.+)to\1$/);
                        if (match) {
                            const intervalType = match[1];
                            console.log('处理特定音程:', intervalType, '在音阶中:', state.currentIntervals);
                            // 查找音阶中对应的音程
                            const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                            console.log('找到的完整音程:', completeInterval);
                            if (completeInterval) {
                                startEndInterval = completeInterval;
                            } else {
                                const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                                console.log('找到的最近音程:', nearestInterval);
                                startEndInterval = nearestInterval || intervalType;
                            }
                            console.log('最终首尾音:', startEndInterval);
                        }
                    }

                    // 特殊处理旋律小调下行：直接使用预定义的序列，不进行额外处理
                    if (!isMelodicMinorDescending) {
                        if (order === 'reverse') {
                            // 倒序模式
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // 找到首尾音在原始音阶中的位置
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // 提取从首尾音开始的所有音，然后倒序，最后添加首尾音
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                    const middleIntervals = state.currentIntervals.slice(1).reverse();
                                    state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // 保持原有的倒序逻辑
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else if (order === 'random') {
                            // 随机模式
                            if (arpeggioType === 'random-arpeggio') {
                                // 对于随机和弦类型，整个序列都应该只包含和弦音（1、3、5、7度音程）
                                // 收集所有实际存在的3/5/7度音程
                                const availableChordTones = [];
                                const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                                if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                                const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                                if (fifthInterval) availableChordTones.push(fifthInterval);
                                const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                                if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                                
                                // 如果找不到足够的和弦音，回退到使用首尾音
                                if (availableChordTones.length > 0) {
                                    // 随机打乱和弦音
                                    const shuffledChordTones = [...availableChordTones];
                                    for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                    }
                                    
                                    // 从找到的和弦音中随机选择一个作为首尾音
                                    startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                    
                                    // 构建新序列，确保包含首尾音
                                    state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                                } else {
                                    // 如果没有足够的和弦音，使用根音作为整个序列
                                    state.currentIntervals = ['1', '1'];
                                }
                            } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                                // 找到首尾音在原始音阶中的位置
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // 提取除了首尾音之外的所有音
                                    const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                    
                                    // 随机打乱
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    
                                    // 构建新序列，确保首尾都是指定的音
                                    state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                                } else {
                                    // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                    const otherIntervals = state.currentIntervals.slice(1);
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // 保持原有的随机逻辑
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // 顺序模式
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // 找到首尾音在原始音阶中的位置
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // 提取从首尾音开始的所有音，然后添加首尾音
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                    state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                                }
                            } else {
                                // 保持原有的顺序逻辑
                                state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                            }
                        }
                    }

                    state.nextExerciseInfo = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                    // 修复：使用处理后的state.currentIntervals而不是原始的intervals
                    state.nextExerciseIntervals = [...state.currentIntervals];
                } else if (activeTab === 'progression') {
                    // 和弦转换练习预生成下一题（使用已存储的和弦进行和索引）
                    if (state.progressionChords && state.progressionIndex !== undefined) {
                        const chords = state.progressionChords;
                        const enableRepeatEl = document.getElementById('enableRepeat');
                        const progressionLevelEl = document.getElementById('progressionLevel');
                        
                        // 获取下一个和弦的索引
                        let nextIndex = state.progressionIndex;
                        
                        // 检查是否超出和弦数量
                        if (nextIndex >= chords.length) {
                            const isRepeatEnabled = enableRepeatEl.checked;
                            if (isRepeatEnabled) {
                                nextIndex = 0; // 重新开始
                            } else {
                                state.nextExerciseInfo = '练习完成';
                                state.nextExerciseIntervals = [];
                                return;
                            }
                        }
                        
                        if (nextIndex < chords.length) {
                            const nextChord = chords[nextIndex];
                            const level = progressionLevelEl.value;
                            
                            // 解析下一个和弦的类型
                            const { root: nextRoot, type: nextType } = parseChordSymbol(nextChord);
                            
                            let intervals = getIntervalsForLevel(level, nextType);
                            
                            state.nextExerciseInfo = nextChord; // 只显示和弦名
                            state.nextExerciseIntervals = intervals;
                        }
                    }
                } else {
                    // 和弦练习预生成下一题
                    // 如果是自定义和弦模式，直接从自定义和弦序列中获取下一个和弦
                    if (state.isCustomChordMode && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            const bass = item.querySelector('.remove-chord').dataset.bass || 'root';
                            return { root, type, bass };
                        });

                        const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                        const nextIndex = (currentIndex + 1) % chords.length;
                        const nextChord = chords[nextIndex];

                        // 应用转位设置
                        let intervals = [...chordTypes[nextChord.type].intervals];
                        if (nextChord.bass && nextChord.bass !== 'root') {
                            intervals = applyChordInversion(intervals, nextChord.bass);
                        }
                        
                        state.nextExerciseInfo = getInversionChordName(nextChord.root, nextChord.type, nextChord.bass || 'root');
                        state.nextExerciseIntervals = intervals;
                    } else {
                        // 常规和弦模式 - 实时获取当前选中的和弦类型
                        let rootNote = chordRootNoteEl.value;
                        if (rootNote === 'random') {
                            const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                            rootNote = notes[Math.floor(Math.random() * notes.length)];
                        }

                        // 实时获取当前选中的和弦类型（不使用缓存）
                        const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                        let chordType = 'major';
                        if (activeChordTypes.length > 0) {
                            const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                            chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                        } else {
                            // 如果没有选中任何和弦类型，不生成默认和弦，而是直接返回空值
                            console.warn('没有选中任何和弦类型，无法生成练习');
                            return; // 不生成练习
                        }

                        const activeOrderBtn = document.querySelector('.chord-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                        let intervals = [...chordTypes[chordType].intervals];
                        
                        // 处理转位和弦
                        const bassNoteSelect = document.getElementById('chordBassNote');
                        if (bassNoteSelect) {
                            const bassNote = bassNoteSelect.value;
                            if (bassNote !== 'root') {
                                intervals = applyChordInversion(intervals, bassNote);
                            }
                        }
                        
                        if (order === 'reverse') {
                            // 下行模式：倒序排列
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }

                        // 获取转位和弦名称
                        const bassNote = bassNoteSelect ? bassNoteSelect.value : 'root';
                        const chordSymbol = getInversionChordName(rootNote, chordType, bassNote);
                        state.nextExerciseInfo = chordSymbol;
                        state.nextExerciseIntervals = intervals;
                    }
                }

                updateNextExerciseDisplay();
            }
            function requestRecordPermission() {
                // 使用标准Web API请求媒体权限
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            // 用户已授权，可以开始录音
                            console.log('录音权限已获取');
                            // 调用你的开始录音逻辑
                            // startRecording();
                            
                            // 停止临时流，因为我们只是在检查权限
                            stream.getTracks().forEach(track => track.stop());
                        })
                        .catch(function(err) {
                            console.error('获取录音权限失败:', err);
                            if (err.name === 'NotAllowedError') {
                                console.log('用户拒绝授权');
                            } else if (err.name === 'NotFoundError') {
                                console.log('未找到录音设备');
                            } else {
                                console.log('权限申请错误');
                            }
                        });
                } else {
                    console.warn('当前浏览器不支持媒体设备API');
                }
            }
            // 更新下一个练习显示
            function updateNextExerciseDisplay() {
                if (state.nextExerciseInfo) {
                    // 显示调性和音阶名/和弦名以及音级结构
                    let displayHTML = state.nextExerciseInfo;
                    if (state.nextExerciseIntervals && state.nextExerciseIntervals.length > 0) {
                        displayHTML += '<br><span style="font-size: 14px; color: #94a3b8;">' + state.nextExerciseIntervals.join(' ') + '</span>';
                    }
                    nextExerciseEl.innerHTML = displayHTML;
                } else {
                    nextExerciseEl.innerHTML = '-';
                }
            }

            // 优化后的练习生成函数
            // 修改generateExercise函数，重置冷却期状态
            function generateExercise() {
                console.log('generateExercise开始 - 当前状态:', {
                    currentIntervals: state.currentIntervals,
                    currentSequence: state.currentSequence,
                    rootNote: state.rootNote,
                    scaleType: state.scaleType,
                    chordType: state.chordType
                });
                
                // 清除之前的状态信息，确保从当前设置生成
                state.nextExerciseInfo = '';
                state.nextExerciseIntervals = [];
                state.chordType = ''; // 清除之前的和弦类型

                // 清除预选的调式和根音，确保新一轮练习重新随机选择
                state.nextScaleType = null;
                state.nextRootNote = null;
                
                // 清理sequence-item的CSS状态
                const sequenceItems = document.querySelectorAll('.sequence-item');
                sequenceItems.forEach(item => {
                    item.classList.remove('current');
                    // 只清理可能影响布局的属性，保留必要的flex布局属性
                    item.style.width = '';
                    item.style.maxWidth = '';
                    item.style.transform = '';
                });
                
                // 确保sequenceDisplay使用正确的display属性
                document.getElementById('sequenceDisplay').style.display = 'flex';
                
                // 获取当前活动标签页
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                console.log('当前活跃标签页:', activeTab);
                
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                
                // 只在和弦转换练习时显示乐曲名，其他情况下隐藏
                if (activeTab === 'progression') {
                    songTitleDisplayEl.style.display = 'block';
                } else {
                    songTitleDisplayEl.style.display = 'none';
                }
                
                state.pitchBuffer = [];
                state.isAnswered = false;
                state.currentStep = 0;

                // 重置冷却期状态
                if (state.enableCooldown) {
                    state.isCoolingDown = false;
                    if (state.cooldownTimeout) {
                        clearTimeout(state.cooldownTimeout);
                        state.cooldownTimeout = null;
                    }
                }

                // 直接生成新练习，不使用预加载数据
                    if (activeTab === 'scale') {
                        if (window.cagedState && window.cagedState.enabled) {
                            console.log('调用generateCagedExercise - CAGED模式启用');
                            generateCagedExercise();
                        } else {
                            console.log('调用generateScaleExercise - 普通音阶模式');
                            generateScaleExercise();
                        }
                    } else if (activeTab === 'chord') {
                        console.log('调用generateChordExercise - 和弦模式');
                        generateChordExercise();
                    } else if (activeTab === 'progression') {
                        console.log('调用generateProgressionExercise - 和弦进行模式');
                        generateProgressionExercise();
                } else if (activeTab === 'pitch-finding') {
                    console.log('调用generatePitchFindingExercise - 找音模式');
                    generatePitchFindingExercise();
                    }

                    // 立即预加载下一题（如果在generateChordExercise中没有调用）
                    if (!state.nextExerciseInfo) {
                        generateNextExercise();
                    }
                }


            // 生成CAGED练习
            function generateCagedExercise() {
                if (!window.cagedState || !window.cagedState.enabled) {
                    generateScaleExercise();
                    return;
                }

                if (!window.cagedSystem || !window.cagedSystem.shapes) {
                    console.error('CAGED系统数据未正确加载');
                    return;
                }
                
                // 隐藏乐曲名显示
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                if (songTitleDisplayEl) {
                    songTitleDisplayEl.style.display = 'none';
                }

                // 如果不是手动切换且是第一次生成练习，重置轮次状态
                if (!window.cagedState.isManualSwitch && 
                    (!window.cagedState.currentScaleType || !window.cagedState.currentRootNote)) {
                    window.cagedState.completedShapesInCurrentRound = [];
                    window.cagedState.isNewRound = true;
                    console.log('开始新的CAGED练习，重置轮次状态');
                }

                // 根据练习模式生成练习
                switch (window.cagedState.practiceMode) {
                    case 'connection':
                        generateShapeConnectionExercise();
                        break;
                    case 'random':
                        generateRandomShapeExercise();
                        break;
                    default:
                        generateShapeConnectionExercise();
                }
            }

            // 单个形状练习
            function generateSingleShapeExercise() {
                // 重置练习状态
                state.currentStep = 0;
                state.isAnswered = false;
                
                // 显示CAGED形状选择界面
                displayCagedShapeSelection();
                
                // 获取当前形状
                const shape = window.cagedSystem.shapes[window.cagedState.currentShape];
                
                // 使用Scale Settings中的根音设置
                let key = rootNoteEl.value;
                
                // 如果是手动切换或在同一轮练习中，保持当前根音和音阶类型
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    // 保持当前根音和音阶类型
                    key = window.cagedState.currentRootNote || key;
                    console.log('保持当前根音:', key);
                } else {
                    // 新一轮练习，可以重新选择根音
                    if (key === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        key = notes[Math.floor(Math.random() * notes.length)];
                    }
                    window.cagedState.currentRootNote = key;
                    console.log('新一轮练习 - 选择根音:', key);
                }
                
                // 更新CAGED状态中的调性（保持同步）
                window.cagedState.currentKey = key;
                
                // 使用Scale Settings中的音阶类型
                let scaleType = scaleTypeEl.value;
                
                // 如果是手动切换或在同一轮练习中，保持当前音阶类型
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    if (window.cagedState.currentScaleType) {
                        scaleType = window.cagedState.currentScaleType;
                        console.log('保持当前音阶类型:', scaleType);
                    }
                } else {
                    // 新一轮练习，可以重新选择音阶类型
                    if (scaleType === 'random') {
                        scaleType = window.getRandomSelectedScaleType ?
                            window.getRandomSelectedScaleType() :
                            (function() {
                                const types = Object.keys(scaleTypes);
                                return types[Math.floor(Math.random() * types.length)];
                            })();
                        console.log('新一轮练习 - 随机选择音阶类型:', scaleType);
                    }
                    window.cagedState.currentScaleType = scaleType;
                }
                
                // 标记不再是新一轮
                window.cagedState.isNewRound = false;
                
                // 更新目标音程显示
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                
                // 生成CAGED音阶序列（使用选择的音阶类型）
                state.currentIntervals = [...scaleTypes[scaleType].intervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedState.currentShape;
                state.cagedKey = window.cagedState.currentKey;
                state.cagedPracticeType = window.cagedState.practiceType;
                state.scaleType = scaleType;
                
                displaySequence();
                
                // 生成CAGED下一题预览
                generateCagedNextExercise();
                
            }

            // 形状连接练习
            function generateShapeConnectionExercise() {
                // 重置练习状态
                state.currentStep = 0;
                state.isAnswered = false;
                
                // 显示CAGED形状选择界面
                displayCagedShapeSelection();
                
                // 获取当前形状和下一个形状
                const currentShape = window.cagedSystem.shapes[window.cagedState.currentShape];
                const nextShape = getNextShape();
                
                // 使用Scale Settings中的根音设置
                let key = rootNoteEl.value;
                
                // 如果是手动切换或在同一轮练习中，保持当前根音和音阶类型
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    // 保持当前根音和音阶类型
                    key = window.cagedState.currentRootNote || key;
                    console.log('保持当前根音:', key);
                } else {
                    // 新一轮练习，可以重新选择根音
                    if (key === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        key = notes[Math.floor(Math.random() * notes.length)];
                    }
                    window.cagedState.currentRootNote = key;
                    console.log('新一轮练习 - 选择根音:', key);
                }
                
                // 更新CAGED状态中的调性（保持同步）
                window.cagedState.currentKey = key;
                
                // 使用Scale Settings中的音阶类型
                let scaleType = scaleTypeEl.value;
                
                // 如果是手动切换或在同一轮练习中，保持当前音阶类型
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    if (window.cagedState.currentScaleType) {
                        scaleType = window.cagedState.currentScaleType;
                        console.log('保持当前音阶类型:', scaleType);
                    }
                } else {
                    // 新一轮练习，可以重新选择音阶类型
                    if (scaleType === 'random') {
                        scaleType = window.getRandomSelectedScaleType ?
                            window.getRandomSelectedScaleType() :
                            (function() {
                                const types = Object.keys(scaleTypes);
                                return types[Math.floor(Math.random() * types.length)];
                            })();
                        console.log('新一轮练习 - 随机选择音阶类型:', scaleType);
                    }
                    window.cagedState.currentScaleType = scaleType;
                }
                
                // 标记不再是新一轮
                window.cagedState.isNewRound = false;
                
                // 更新目标音程显示
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                
                // 生成连接练习的音阶序列（使用选择的音阶类型，单遍即可）
                const scaleIntervals = [...scaleTypes[scaleType].intervals];
                state.currentIntervals = [...scaleIntervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedState.currentShape;
                state.cagedKey = window.cagedState.currentKey;
                state.cagedPracticeType = window.cagedState.practiceType;
                state.scaleType = scaleType;
                
                displaySequence();
                
                // 生成CAGED下一题预览
                generateCagedNextExercise();
                
            }

            // 随机形状练习
            function generateRandomShapeExercise() {
                // 重置练习状态
                state.currentStep = 0;
                state.isAnswered = false;
                
                // 显示CAGED形状选择界面
                displayCagedShapeSelection();
                
                // 随机选择一个形状
                const availableShapes = window.cagedState.selectedShapes;
                const randomIndex = Math.floor(Math.random() * availableShapes.length);
                const randomShapeName = availableShapes[randomIndex];
                const shape = window.cagedSystem.shapes[randomShapeName];
                
                // 使用Scale Settings中的根音设置
                let key = rootNoteEl.value;
                
                // 如果是手动切换或在同一轮练习中，保持当前根音和音阶类型
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    // 保持当前根音和音阶类型
                    key = window.cagedState.currentRootNote || key;
                    console.log('保持当前根音:', key);
                } else {
                    // 新一轮练习，可以重新选择根音
                    if (key === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        key = notes[Math.floor(Math.random() * notes.length)];
                    }
                    window.cagedState.currentRootNote = key;
                    console.log('新一轮练习 - 选择根音:', key);
                }
                
                // 更新CAGED状态中的调性（保持同步）
                window.cagedState.currentKey = key;
                
                // 更新当前形状
                window.cagedState.currentShape = randomShapeName;
                
                // 使用Scale Settings中的音阶类型
                let scaleType = scaleTypeEl.value;
                
                // 如果是手动切换或在同一轮练习中，保持当前音阶类型
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    if (window.cagedState.currentScaleType) {
                        scaleType = window.cagedState.currentScaleType;
                        console.log('保持当前音阶类型:', scaleType);
                    }
                } else {
                    // 新一轮练习，可以重新选择音阶类型
                    if (scaleType === 'random') {
                        scaleType = window.getRandomSelectedScaleType ?
                            window.getRandomSelectedScaleType() :
                            (function() {
                                const types = Object.keys(scaleTypes);
                                return types[Math.floor(Math.random() * types.length)];
                            })();
                        console.log('新一轮练习 - 随机选择音阶类型:', scaleType);
                    }
                    window.cagedState.currentScaleType = scaleType;
                }
                
                // 标记不再是新一轮
                window.cagedState.isNewRound = false;
                
                // 更新目标音程显示
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                
                // 生成CAGED音阶序列（使用选择的音阶类型）
                state.currentIntervals = [...scaleTypes[scaleType].intervals];
                state.cagedMode = true;
                state.cagedShape = randomShapeName;
                state.cagedKey = window.cagedState.currentKey;
                state.cagedPracticeType = window.cagedState.practiceType;
                state.scaleType = scaleType;
                
                displaySequence();
                
                // 生成CAGED下一题预览
                generateCagedNextExercise();
                
            }

            // 生成CAGED下一题预览
            function generateCagedNextExercise() {
                if (!window.cagedState || !window.cagedState.enabled) {
                    return;
                }
                
                const selectedShapes = window.cagedState.selectedShapes;
                const currentShape = window.cagedState.currentShape;
                const currentIndex = selectedShapes.indexOf(currentShape);
                
                // 获取下一个形状
                let nextShapeName;
                if (window.cagedState.practiceMode === 'random') {
                    // 随机模式：随机选择一个形状
                    nextShapeName = selectedShapes[Math.floor(Math.random() * selectedShapes.length)];
                } else {
                    // 单个形状或连接模式：按顺序循环
                    const nextIndex = (currentIndex + 1) % selectedShapes.length;
                    nextShapeName = selectedShapes[nextIndex];
                }
                
                const nextShape = window.cagedSystem.shapes[nextShapeName];
                const key = window.cagedState.currentKey;
                const scaleType = state.scaleType || 'major';
                
                // 设置下一题信息
                state.nextExerciseInfo = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                state.nextExerciseIntervals = [...scaleTypes[scaleType].intervals];
                
                updateNextExerciseDisplay();
            }

            // 获取下一个形状
            function getNextShape() {
                const currentIndex = window.cagedState.selectedShapes.indexOf(window.cagedState.currentShape);
                const nextIndex = (currentIndex + 1) % window.cagedState.selectedShapes.length;
                const nextShapeName = window.cagedState.selectedShapes[nextIndex];
                return window.cagedSystem.shapes[nextShapeName];
            }

            // 显示CAGED形状选择界面
            function displayCagedShapeSelection() {
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedShapes();
                }
            }

            // 只显示选中的形状
            function showOnlySelectedShapes() {
                const shapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                const container = document.querySelector('.caged-shape-buttons');
                const selectedShapes = window.cagedState.selectedShapes;

                // 如果是随机模式，需要重新排列按钮顺序
                if (window.cagedState.practiceMode === 'random') {
                    // 创建选中的形状数组并随机排序
                    const shuffledSelectedShapes = [...selectedShapes].sort(() => Math.random() - 0.5);

                    // 先隐藏所有按钮
                    shapeButtons.forEach(btn => {
                        btn.style.display = 'none';
                    });

                    // 按随机顺序重新排列和显示按钮
                    shuffledSelectedShapes.forEach((shape, index) => {
                        const btn = document.querySelector(`.caged-shape-btn-display[data-shape="${shape}"]`);
                        if (btn) {
                            btn.style.display = 'flex';
                            btn.style.order = index.toString(); // 设置随机顺序
                        }
                    });

                    // 确保容器使用flex order排序
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center';
                    container.style.gap = '15px';
                    container.style.flexWrap = 'wrap';
                } else {
                    // 非随机模式，按C-A-G-E-D原顺序显示选中的形状
                    const fixedOrder = ['C', 'A', 'G', 'E', 'D'];
                    shapeButtons.forEach(btn => {
                        const shape = btn.dataset.shape;
                        if (selectedShapes.includes(shape)) {
                            btn.style.display = 'flex';
                            // 按固定顺序设置order
                            btn.style.order = fixedOrder.indexOf(shape).toString();
                        } else {
                            btn.style.display = 'none';
                        }
                    });
                }
            }

            // 只显示选中的和弦形状
            function showOnlySelectedChordShapes() {
                const shapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                const container = document.querySelector('.caged-shape-buttons');
                const selectedShapes = window.cagedChordState.selectedShapes;

                // 如果是随机模式，需要重新排列按钮顺序
                if (window.cagedChordState.practiceMode === 'random') {
                    // 创建选中的形状数组并随机排序
                    const shuffledSelectedShapes = [...selectedShapes].sort(() => Math.random() - 0.5);

                    // 先隐藏所有按钮
                    shapeButtons.forEach(btn => {
                        btn.style.display = 'none';
                    });

                    // 按随机顺序重新排列和显示按钮
                    shuffledSelectedShapes.forEach((shape, index) => {
                        const btn = document.querySelector(`.caged-shape-btn-display[data-shape="${shape}"]`);
                        if (btn) {
                            btn.style.display = 'flex';
                            btn.style.order = index.toString(); // 设置随机顺序
                        }
                    });

                    // 确保容器使用flex order排序
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center';
                    container.style.gap = '15px';
                    container.style.flexWrap = 'wrap';
                } else {
                    // 非随机模式，按C-A-G-E-D原顺序显示选中的形状
                    const fixedOrder = ['C', 'A', 'G', 'E', 'D'];
                    shapeButtons.forEach(btn => {
                        const shape = btn.dataset.shape;
                        if (selectedShapes.includes(shape)) {
                            btn.style.display = 'flex';
                            // 按固定顺序设置order
                            btn.style.order = fixedOrder.indexOf(shape).toString();
                        } else {
                            btn.style.display = 'none';
                        }
                    });
                }
            }

            // 更新CAGED形状按钮状态
            function updateCagedShapeButtons() {
                const shapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                const selectedShapes = window.cagedState.selectedShapes;
                const currentShape = window.cagedState.currentShape;
                const completedShapes = window.cagedState.completedShapesInCurrentRound || [];

                shapeButtons.forEach(btn => {
                    const shape = btn.dataset.shape;
                    btn.classList.remove('current', 'completed', 'disabled', 'played');

                    // 只处理选中的形状
                    if (selectedShapes.includes(shape)) {
                        if (shape === currentShape) {
                            btn.classList.add('current');
                            btn.title = `当前形状: ${shape}`;
                        } else if (completedShapes.includes(shape)) {
                            // 弹过的形状显示为透明
                            btn.classList.add('played');
                            btn.title = `已完成 ${shape} 形状`;
                        } else {
                            btn.classList.add('completed');
                            btn.title = `点击切换到 ${shape} 形状`;
                        }
                    } else {
                        btn.classList.add('disabled');
                        btn.title = `${shape} 形状未选中`;
                    }
                });
            }

            // CAGED形状自动切换
            function switchToNextCagedShape() {
                // 获取原始选择的形状列表（不修改，用于循环）
                const originalSelectedShapes = [...window.cagedState.selectedShapes];
                const currentShape = window.cagedState.currentShape;
                const currentIndex = originalSelectedShapes.indexOf(currentShape);
                
                // 将当前形状标记为已完成
                if (!window.cagedState.completedShapesInCurrentRound.includes(currentShape)) {
                    window.cagedState.completedShapesInCurrentRound.push(currentShape);
                }
                
                console.log('已完成形状:', window.cagedState.completedShapesInCurrentRound);
                console.log('总共需要完成:', originalSelectedShapes);
                
                // 检查是否完成了当前轮次的所有形状
                if (window.cagedState.completedShapesInCurrentRound.length >= originalSelectedShapes.length) {
                    // 完成一轮，开始新一轮
                    window.cagedState.completedShapesInCurrentRound = [];
                    window.cagedState.isNewRound = true;
                    console.log('完成一轮CAGED形状，开始新一轮练习');
                }
                
                // 循环切换到下一个形状
                let nextIndex;
                if (window.cagedState.practiceMode === 'random') {
                    // 随机模式：随机选择下一个形状
                    nextIndex = Math.floor(Math.random() * originalSelectedShapes.length);
                } else {
                    // 单个形状或连接模式：按顺序循环
                    nextIndex = (currentIndex + 1) % originalSelectedShapes.length;
                }
                
                window.cagedState.currentShape = originalSelectedShapes[nextIndex];
                    updateCagedShapeButtons();
                showOnlySelectedShapes();
                    
                    // 立即生成新形状的练习（延迟已在handleCagedCorrect中处理）
                        generateCagedExercise();
            }

            // 完成所有CAGED形状
            function completeAllCagedShapes() {
                // 显示完成消息
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = '🎉 所有CAGED形状练习完成！';
                
                // 隐藏CAGED形状显示
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'none';
                }
                
                // 3秒后重新开始或退出练习
                setTimeout(() => {
                    if (confirm('所有CAGED形状练习完成！是否重新开始？')) {
                        // 重新开始CAGED练习
                        resetCagedShapes();
                        generateCagedExercise();
                } else {
                        // 退出CAGED练习
                        window.cagedState.enabled = false;
                        generateScaleExercise();
                    }
                }, 3000);
            }

            // 重置CAGED形状
            function resetCagedShapes() {
                // 恢复所有选中的形状
                window.cagedState.selectedShapes = ['C', 'A', 'G', 'E', 'D'];
                window.cagedState.currentShape = window.cagedState.selectedShapes[0];
            }

            // CAGED音频处理
            function processCagedAudio(inputData, sampleRate) {
                if (!window.cagedState || !window.cagedState.enabled) {
                    return;
                }

                // 使用与普通模式相同的YIN算法调用方式
                const yinResult = Pitchfinder.YIN({ threshold: 0.1, probabilityCliff: 0.1 })(inputData);
                if (!yinResult || !yinResult.frequency) return;
                
                // 能量检测
                const energy = rms(inputData);
                if (energy < 0.002) return;
                
                const detectedNote = frequencyToNoteName(yinResult.frequency);
                
                console.log(`CAGED音频处理: 检测到音符=${detectedNote}, 频率=${yinResult.frequency.toFixed(2)}Hz, 能量=${energy.toFixed(4)}`);
                
                // 检查检测到的音符是否有效
                if (!detectedNote) {
                    console.error('CAGED音频处理: frequencyToNoteName返回了undefined或空值');
                    return;
                }
                
                // 获取当前应该弹奏的音级
                const currentInterval = state.currentSequence[state.currentStep];
                    const rootNote = window.cagedState.currentKey;
                    
                console.log(`CAGED状态检查: currentStep=${state.currentStep}, currentSequence长度=${state.currentSequence.length}, currentInterval=${currentInterval}, rootNote=${rootNote}`);
                
                // 检查状态是否有效
                if (!currentInterval) {
                    console.error('CAGED音频处理: 当前音级为undefined');
                    return;
                }
                
                if (!rootNote) {
                    console.error('CAGED音频处理: 根音为undefined');
                    return;
                }
                    
                // 检查是否匹配当前音级（使用与普通音阶练习相同的逻辑）
                if (checkCagedCurrentInterval(detectedNote, rootNote, currentInterval)) {
                        handleCagedCorrect();
                    }
                }

            // 检查CAGED当前音级匹配（使用与普通音阶练习相同的逻辑）
            function checkCagedCurrentInterval(detectedNote, rootNote, currentInterval) {
                // 检查输入参数的有效性
                if (!detectedNote) {
                    console.error(`CAGED检查: 检测音符为空或undefined`);
                    return false;
                }
                
                if (!rootNote) {
                    console.error(`CAGED检查: 根音为空或undefined`);
                    return false;
                }
                
                if (!currentInterval) {
                    console.error(`CAGED检查: 当前音级为空或undefined`);
                    return false;
                }
                
                // 检查音级是否在映射中存在
                if (!intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`未知的音级: ${currentInterval}`);
                    return false;
                }
                
                // 检查音符是否在映射中存在
                if (!noteToSemitones.hasOwnProperty(detectedNote)) {
                    console.error(`未知的检测音符: ${detectedNote}`);
                    return false;
                }
                
                if (!noteToSemitones.hasOwnProperty(rootNote)) {
                    console.error(`未知的根音: ${rootNote}`);
                    return false;
                }
                
                const rootValue = noteToSemitones[rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const detectedSemitone = noteToSemitones[detectedNote] % 12;
                
                console.log(`CAGED音级检查: 当前音级=${currentInterval}, 目标音符=${semitonesToNoteName(targetSemitone)}, 检测音符=${detectedNote}`);
                
                // 检查是否匹配（考虑等价音符）
                const isMatch = detectedSemitone === targetSemitone || isEquivalentNote(detectedNote, semitonesToNoteName(targetSemitone));
                console.log(`CAGED音级匹配结果: ${isMatch}`);
                
                return isMatch;
            }

            // 检查CAGED匹配
            function checkCagedMatch(detectedNote, rootNote, shape) {
                // 吉他标准调弦（从粗到细：6弦到1弦）
                const guitarStrings = ['E', 'A', 'D', 'G', 'B', 'E']; // 6弦到1弦
                
                // 计算调性偏移
                const keyOffsets = { 
                    'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4, 
                    'F': 5, 'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8, 'A': 9, 
                    'A♯': 10, 'B♭': 10, 'B': 11 
                };
                const keyOffset = keyOffsets[rootNote] || 0;
                
                // 获取形状中的所有音符
                const shapeNotes = shape.positions.map(pos => {
                    // CAGED中string编号：5=5弦，4=4弦，3=3弦，2=2弦，1=1弦，0=?
                    // guitarStrings数组：[6弦E, 5弦A, 4弦D, 3弦G, 2弦B, 1弦E]
                    // 所以 pos.string=5 -> guitarStrings[1] (5弦A)
                    const stringIndex = pos.string === 5 ? 1 : pos.string === 4 ? 2 : pos.string === 3 ? 3 : pos.string === 2 ? 4 : pos.string === 1 ? 5 : 0;
                    const openNote = guitarStrings[stringIndex];
                    const openNoteValue = noteToSemitones[openNote];
                    
                    // 计算该位置的实际音符值（考虑调性偏移）
                    const actualNoteValue = (openNoteValue + pos.fret + keyOffset) % 12;
                    
                    // 转换回音符名
                    const noteName = semitonesToNoteName(actualNoteValue);
                    
                    // 详细调试信息
                    const guitarStringNumber = pos.string === 5 ? 5 : pos.string === 4 ? 4 : pos.string === 3 ? 3 : pos.string === 2 ? 2 : pos.string === 1 ? 1 : 6;
                    console.log(`CAGED弦${pos.string} -> 吉他第${guitarStringNumber}弦(${openNote}) 第${pos.fret}品 + 调性偏移${keyOffset} = ${noteName} (音程${pos.interval})`);
                    
                    return noteName;
                });
                
                // 调试信息
                console.log(`CAGED匹配检查: 检测音符=${detectedNote}, 根音=${rootNote}, 形状=${shape.name}`);
                console.log(`形状音符:`, shapeNotes);
                console.log(`调性偏移:`, keyOffset);
                
                // 检查检测到的音符是否在形状中
                const isMatch = shapeNotes.some(note => isEquivalentNote(detectedNote, note));
                console.log(`匹配结果:`, isMatch);
                
                return isMatch;
            }
            
            // 半音数转音符名
            function semitonesToNoteName(semitones) {
                const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];
                return noteNames[semitones % 12];
            }

            // 处理CAGED正确回答
            function handleCagedCorrect() {
                if (state.isAnswered) return;
                
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;
                
                // 显示正确反馈
                const feedbackEl = document.getElementById('feedback');
                if (feedbackEl) {
                    feedbackEl.textContent = '正确！';
                    feedbackEl.style.color = '#10b981';
                }
                
                // 使用与普通练习相同的逻辑标记序列项
                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }
                
                requestAnimationFrame(() => {
                // 检查是否完成当前形状的所有音阶
                if (state.currentStep >= state.currentIntervals.length) {
                        state.isAnswered = true;
                    
                    // 根据全局设置决定延迟时间
                    let delayTime = 0; // 默认无延迟
                    if (state.enableFixedDelay) {
                        delayTime = state.fixedDelayDuration;
                    }
                    
                    console.log(`CAGED形状切换延迟: ${delayTime}ms (全局设置: ${state.enableFixedDelay ? '启用' : '禁用'})`);
                    
                    // 当前形状练习完成，切换到下一个形状
                    setTimeout(() => {
                        switchToNextCagedShape();
                    }, delayTime);
                } else {
                        // 设置下一个序列项为当前项
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                        
                        // 继续当前形状的练习，重置答题状态（音级间使用较短延迟）
                    setTimeout(() => {
                            state.isAnswered = false;
                        }, 300); // 音级间延迟减少到300ms
                }
                });
            }


            // 生成音阶练习
            function generateScaleExercise() {
                resetCagedModeState();

                let rootNote = rootNoteEl.value;
                if (rootNote === 'random') {
                    // 如果有预选的根音（从generateNextExercise设置的），使用预选的根音
                    if (state.nextRootNote) {
                        rootNote = state.nextRootNote;
                        console.log('使用预选的根音:', rootNote);
                    } else {
                        // 否则重新随机选择
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                }
                state.rootNote = rootNote;

                // 在多选模式下，总是使用随机选择
                let scaleType;
                // 如果有预选的调式（从generateNextExercise设置的），使用预选的调式
                if (state.nextScaleType) {
                    scaleType = state.nextScaleType;
                } else {
                    // 否则重新随机选择
                    scaleType = window.getRandomSelectedScaleType ?
                        window.getRandomSelectedScaleType() :
                        (function() {
                            const types = Object.keys(scaleTypes);
                            return types[Math.floor(Math.random() * types.length)];
                        })();
                }
                state.scaleType = scaleType;

                // 清除预选的调式，因为已经使用过了
                state.nextScaleType = null;
                state.nextRootNote = null;

                // 获取练习序列类型
                const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                let arpeggioType = '1to1';
                
                for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                  if (arpeggioTypeButtons[i].classList.contains('active')) {
                    arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                    break;
                  }
                }
                
                console.log('当前选择的练习序列类型:', arpeggioType);

                // 获取方向
                const activeScaleOrderBtn = document.querySelector('.scale-order-btn.active');
                const order = activeScaleOrderBtn ? activeScaleOrderBtn.dataset.value : 'ordered';

                // 特殊处理旋律小调：根据方向选择上行或下行形式
                let intervals;
                let isMelodicMinorDescending = false;
                if (scaleType === 'melodicMinor' && order === 'reverse') {
                    // 下行旋律小调
                    intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                    isMelodicMinorDescending = true;
                } else {
                    // 默认使用上行形式
                    intervals = [...scaleTypes[scaleType].intervals];
                }
                state.currentIntervals = intervals;
                let startEndInterval = '1'; // 默认使用1作为首尾音
                
                // 根据练习序列类型确定首尾音
                if (arpeggioType === 'random-arpeggio') {
                    // 随机选择1、3、5、7音作为首尾音，但只包含音阶中实际存在的音程
                    const availableChordTones = [];
                    const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                    const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    if (fifthInterval) availableChordTones.push(fifthInterval);
                    const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                    
                    // 如果有可用的3/5/7度音程，则从中随机选择
                    if (availableChordTones.length > 0) {
                        startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                    } else {
                        startEndInterval = '1'; // 回退到根音
                    }
                } else if (arpeggioType === '3to3') {
                    // 使用3音作为首尾音
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                } else if (arpeggioType === '5to5') {
                    // 使用5音作为首尾音
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                } else if (arpeggioType === '7to7') {
                    // 使用7音作为首尾音
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                    // 处理其他特定音程作为首尾音的情况（如♯6→♯6）
                    // arpeggioType格式为"xtox"，提取x部分
                    const match = arpeggioType.match(/^(.+)to\1$/);
                    if (match) {
                        const intervalType = match[1];
                        console.log('处理特定音程:', intervalType, '在音阶中:', state.currentIntervals);
                        // 查找音阶中对应的音程
                        const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                        console.log('找到的完整音程:', completeInterval);
                        if (completeInterval) {
                            startEndInterval = completeInterval;
                        } else {
                            const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                            console.log('找到的最近音程:', nearestInterval);
                            startEndInterval = nearestInterval || intervalType;
                        }
                        console.log('最终首尾音:', startEndInterval);
                    }
                }

                // 特殊处理旋律小调下行：直接使用预定义的序列，不进行额外处理
                if (!isMelodicMinorDescending) {
                    if (order === 'reverse') {
                        // 倒序模式
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // 找到首尾音在原始音阶中的位置
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // 提取从首尾音开始的所有音，然后倒序，最后添加首尾音
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // 保持原有的倒序逻辑
                            const middleIntervals = state.currentIntervals.slice(1).reverse();
                            state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                        }
                    } else if (order === 'random') {
                        // 随机模式
                        if (arpeggioType === 'random-arpeggio') {
                            // 对于随机和弦类型，整个序列都应该只包含和弦音（1、3、5、7度音程）
                            // 收集所有实际存在的3/5/7度音程
                            const availableChordTones = [];
                            const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                            if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                            const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                            if (fifthInterval) availableChordTones.push(fifthInterval);
                            const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                            if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                            
                            // 如果找不到足够的和弦音，回退到使用首尾音
                            if (availableChordTones.length > 0) {
                                // 随机打乱和弦音
                                const shuffledChordTones = [...availableChordTones];
                                for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                }
                                
                                // 从找到的和弦音中随机选择一个作为首尾音
                                startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                
                                // 构建新序列，确保包含首尾音
                                state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                            } else {
                                // 如果没有足够的和弦音，使用根音作为整个序列
                                state.currentIntervals = ['1', '1'];
                            }
                        } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                            // 找到首尾音在原始音阶中的位置
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // 提取除了首尾音之外的所有音
                                const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                
                                // 随机打乱
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                
                                // 构建新序列，确保首尾都是指定的音
                                state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                            } else {
                                // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // 保持原有的随机逻辑
                            const otherIntervals = state.currentIntervals.slice(1);
                            for (let i = otherIntervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                            }
                            state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                        }
                    } else {
                        // 顺序模式
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // 找到首尾音在原始音阶中的位置
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // 提取从首尾音开始的所有音，然后添加首尾音
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                            }
                        } else {
                            // 保持原有的顺序逻辑
                            state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                        }
                    }
                }

                targetIntervalEl.textContent = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                displaySequence();
            }

            // 生成找音练习
            function generatePitchFindingExercise() {
                resetCagedModeState();
                
                // 清理sequence-item的CSS状态
                const sequenceItems = document.querySelectorAll('.sequence-item');
                sequenceItems.forEach(item => {
                    item.classList.remove('current');
                    // 只清理可能影响布局的属性，保留必要的flex布局属性
                    item.style.width = '';
                    item.style.maxWidth = '';
                    item.style.transform = '';
                });
                
                // 清除之前的计时器状态
                if (state.pitchFindingTimer) {
                    clearInterval(state.pitchFindingTimer);
                    state.pitchFindingTimer = null;
                }
                
                // 清除指板上的高亮和音符显示
                clearFretboardHighlights();
                
                // 显示找音练习特定元素
                document.getElementById('pitchFindingElements').style.display = 'block';
                
                // 隐藏其他练习元素
                document.getElementById('targetInterval').style.display = 'none';
                document.getElementById('sequenceDisplay').style.display = 'none';
                document.getElementById('nextExercise').style.display = 'none';
                
                // 隐藏next-exercise容器
                const nextExerciseContainer = document.querySelector('.next-exercise');
                if (nextExerciseContainer) {
                    nextExerciseContainer.style.display = 'none';
                }
                
                // 隐藏练习容器，因为找音练习有自己的界面
                const exerciseContainer = document.querySelector('.exercise-container');
                if (exerciseContainer) {
                    exerciseContainer.style.display = 'none';
                }
                
                // 生成随机音符
                const notes = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                const randomNote = notes[Math.floor(Math.random() * notes.length)];
                
                // 更新当前音符显示
                document.getElementById('currentNoteDisplay').textContent = randomNote;
                state.currentNote = randomNote;
                
                // 获取设置
                const showFretboard = document.getElementById('showFretboard').checked;
                const practiceTime = parseInt(document.getElementById('pitchFindingTime').value);
                
                // 显示或隐藏指板
                const fretboardContainer = document.getElementById('fretboardContainer');
                const fretboardFooter = document.getElementById('fretboardFooter');
                if (showFretboard) {
                    fretboardContainer.style.display = 'block';
                    fretboardFooter.style.display = 'block';
                    createFretboard();
                } else {
                    fretboardContainer.style.display = 'none';
                    fretboardFooter.style.display = 'none';
                }
                
                // 显示下一题按钮
                document.querySelector('.pitch-finding-next-btn-container').style.display = 'flex';
                
                // 隐藏乐曲名显示
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                if (songTitleDisplayEl) {
                    songTitleDisplayEl.style.display = 'none';
                }
                
                // 启动计时器
                startPitchFindingTimer(practiceTime);
                
                // 设置音高检测回调
                state.pitchFindingMode = true;
                state.pitchFindingCorrect = false;
                state.pitchFindingAnswered = false;
                state.pitchFindingNextTimeout = null;
                
                console.log('generatePitchFindingExercise 完成 - 目标音符:', randomNote, 'pitchFindingMode:', state.pitchFindingMode);
            }

            // 创建指板
            function createFretboard() {
                const fretboard = document.getElementById('fretboard');
                const fretNumbers = document.getElementById('fretNumbers');
                fretboard.innerHTML = '';
                fretNumbers.innerHTML = '';
                
                // 获取选择的指板长度
                const selectedRangeBtn = document.querySelector('.pitch-finding-range-btn.active');
                const maxFret = selectedRangeBtn ? parseInt(selectedRangeBtn.dataset.value) : 12;
                
                // 吉他弦的开放音（从1弦到6弦）
                const strings = ['E', 'B', 'G', 'D', 'A', 'E'];
                
                // 创建6根弦
                for (let stringIdx = 0; stringIdx < 6; stringIdx++) {
                    const stringElement = document.createElement('div');
                    stringElement.className = 'fretboard-string';
                    
                    // 添加品格
                    for (let fret = 0; fret <= maxFret; fret++) {
                        const fretElement = document.createElement('div');
                        fretElement.className = 'fretboard-fret';
                        fretElement.dataset.string = stringIdx;
                        fretElement.dataset.fret = fret;
                        
                        // 如果是0品，添加开放音标记
                        if (fret === 0) {
                            const openNoteEl = document.createElement('div');
                            openNoteEl.className = 'fret-marker';
                            openNoteEl.textContent = strings[stringIdx];
                            fretElement.appendChild(openNoteEl);
                        }
                        
                        stringElement.appendChild(fretElement);
                    }
                    
                    fretboard.appendChild(stringElement);
                }
                
                // 创建品格数字标记
                for (let fret = 0; fret <= maxFret; fret++) {
                    const fretNumberEl = document.createElement('div');
                    fretNumberEl.className = 'fret-number';
                    if (fret > 0) fretNumberEl.textContent = fret;
                    fretNumbers.appendChild(fretNumberEl);
                }
            }


            // 启动找音练习计时器
            function startPitchFindingTimer(minutes) {
                // 确保清理之前的计时器
                if (state.pitchFindingTimer) {
                    clearInterval(state.pitchFindingTimer);
                    state.pitchFindingTimer = null;
                }
                
                let timeLeft = minutes * 60; // 转换为秒
                const timerDisplay = document.getElementById('timerDisplay');
                
                if (!timerDisplay) {
                    return;
                }
                
                // 立即设置初始显示
                const initialMinutes = Math.floor(timeLeft / 60);
                const initialSeconds = timeLeft % 60;
                timerDisplay.textContent = `${initialMinutes.toString().padStart(2, '0')}:${initialSeconds.toString().padStart(2, '0')}`;
                
                const timer = setInterval(() => {
                    timeLeft--;
                    
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        endPitchFindingPractice();
                    }
                }, 1000);
                
                state.pitchFindingTimer = timer;
                
                // 添加点击事件监听器，点击屏幕任何位置退出找音练习
                const pitchFindingClickHandler = function(event) {
                    // 检查点击的是否是下一题按钮或其容器
                    if (event.target.closest('.pitch-finding-next-btn-container') || 
                        event.target.closest('.pitch-finding-next-btn') ||
                        event.target.id === 'pitchFindingNextBtn') {
                        return; // 如果点击的是下一题按钮，不退出练习
                    }
                    
                    // 阻止事件冒泡，避免触发其他点击事件
                    event.stopPropagation();
                    
                    // 退出找音练习
                    endPitchFindingPractice();
                    
                    // 移除事件监听器，避免重复绑定
                    document.removeEventListener('click', pitchFindingClickHandler);
                };
                
                // 添加点击事件监听器
                document.addEventListener('click', pitchFindingClickHandler);
            }

            // 结束找音练习
            function endPitchFindingPractice() {
                if (state.pitchFindingTimer) {
                    clearInterval(state.pitchFindingTimer);
                    state.pitchFindingTimer = null;
                }
                
                // 直接退出练习，不显示完成提示
                practiceScreen.click();
            }

            // 生成CAGED和弦练习
            function generateCagedChordExercise() {
                try {
                    if (!window.cagedChordState || !window.cagedChordState.enabled) {
                        console.error('CAGED和弦练习未启用');
                        return;
                    }

                    if (!window.cagedSystem || !window.cagedSystem.shapes) {
                        console.error('CAGED系统数据未正确加载');
                        return;
                    }
                    
                    // 隐藏乐曲名显示
                    const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                    if (songTitleDisplayEl) {
                        songTitleDisplayEl.style.display = 'none';
                    }

                    // 如果不是手动切换且是第一次生成练习，重置轮次状态
                    if (!window.cagedChordState.isManualSwitch && 
                        (!window.cagedChordState.currentChordType || !window.cagedChordState.currentRootNote)) {
                        window.cagedChordState.completedShapesInCurrentRound = [];
                        window.cagedChordState.isNewRound = true;
                        console.log('开始新的CAGED和弦练习，重置轮次状态');
                    }

                    // 根据练习模式生成练习
                    switch (window.cagedChordState.practiceMode) {
                        case 'connection':
                            generateCagedChordConnectionExercise();
                            break;
                        case 'random':
                            generateRandomCagedChordExercise();
                            break;
                        default:
                            generateCagedChordConnectionExercise();
                    }
                } catch (error) {
                    console.error('生成CAGED和弦练习失败:', error);
                    updateStatusIndicator('CAGED和弦练习生成失败: ' + error.message, 'error');
                }
            }

            // 单个CAGED形状和弦练习
            function generateSingleCagedChordExercise() {
                const selectedShapes = window.cagedChordState.selectedShapes;
                if (selectedShapes.length === 0) {
                    console.warn('没有选中任何CAGED形状');
                    return;
                }

                // 选择当前形状
                let currentShapeName = window.cagedChordState.currentShape;
                if (!selectedShapes.includes(currentShapeName)) {
                    currentShapeName = selectedShapes[0];
                    window.cagedChordState.currentShape = currentShapeName;
                }

                // 获取根音
                let key = window.cagedChordState.currentKey;
                if (key === 'random') {
                    const keys = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];
                    key = keys[Math.floor(Math.random() * keys.length)];
                    window.cagedChordState.currentKey = key;
                }

                // 获取和弦类型
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }

                // 如果是手动切换或在同一轮练习中，保持当前和弦类型
                if (window.cagedChordState.isManualSwitch || !window.cagedChordState.isNewRound) {
                    if (window.cagedChordState.currentChordType) {
                        chordType = window.cagedChordState.currentChordType;
                        console.log('保持当前和弦类型:', chordType);
                    }
                } else {
                    // 新一轮练习，可以重新选择和弦类型
                    window.cagedChordState.currentChordType = chordType;
                }
                
                // 标记不再是新一轮
                window.cagedChordState.isNewRound = false;
                
                // 更新目标音程显示
                const targetIntervalEl = document.getElementById('targetInterval');
                const chordSymbol = formatChordSymbol(key, chordType);
                targetIntervalEl.textContent = chordSymbol;
                
                // 生成CAGED和弦序列
                state.currentIntervals = [...chordTypes[chordType].intervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedChordState.currentShape;
                state.cagedKey = window.cagedChordState.currentKey;
                state.cagedPracticeType = window.cagedChordState.practiceType;
                state.chordType = chordType;
                
                displaySequence();
                
                // 显示CAGED形状选择界面
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedChordShapes();
                }
                
                // 生成CAGED下一题预览
                generateCagedChordNextExercise();
                
            }

            // CAGED形状连接和弦练习
            function generateCagedChordConnectionExercise() {
                const selectedShapes = window.cagedChordState.selectedShapes;
                if (selectedShapes.length === 0) {
                    console.warn('没有选中任何CAGED形状');
                    return;
                }

                // 选择下一个形状
                let currentShapeName = window.cagedChordState.currentShape;
                const currentIndex = selectedShapes.indexOf(currentShapeName);
                const nextIndex = (currentIndex + 1) % selectedShapes.length;
                const nextShapeName = selectedShapes[nextIndex];
                
                window.cagedChordState.currentShape = nextShapeName;

                // 获取根音
                let key = window.cagedChordState.currentKey;
                if (key === 'random') {
                    const keys = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];
                    key = keys[Math.floor(Math.random() * keys.length)];
                    window.cagedChordState.currentKey = key;
                }

                // 获取和弦类型
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }

                // 如果是手动切换或在同一轮练习中，保持当前和弦类型
                if (window.cagedChordState.isManualSwitch || !window.cagedChordState.isNewRound) {
                    if (window.cagedChordState.currentChordType) {
                        chordType = window.cagedChordState.currentChordType;
                        console.log('保持当前和弦类型:', chordType);
                    }
                } else {
                    // 新一轮练习，可以重新选择和弦类型
                    window.cagedChordState.currentChordType = chordType;
                }
                
                // 标记不再是新一轮
                window.cagedChordState.isNewRound = false;
                
                // 更新目标音程显示
                const targetIntervalEl = document.getElementById('targetInterval');
                const chordSymbol = formatChordSymbol(key, chordType);
                targetIntervalEl.textContent = chordSymbol;
                
                // 生成CAGED和弦序列
                state.currentIntervals = [...chordTypes[chordType].intervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedChordState.currentShape;
                state.cagedKey = window.cagedChordState.currentKey;
                state.cagedPracticeType = window.cagedChordState.practiceType;
                state.chordType = chordType;
                
                displaySequence();
                
                // 显示CAGED形状选择界面
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedChordShapes();
                }
                
                // 生成CAGED下一题预览
                generateCagedChordNextExercise();
                
            }

            // 随机CAGED形状和弦练习
            function generateRandomCagedChordExercise() {
                const selectedShapes = window.cagedChordState.selectedShapes;
                if (selectedShapes.length === 0) {
                    console.warn('没有选中任何CAGED形状');
                    return;
                }

                // 随机选择形状
                const randomShapeName = selectedShapes[Math.floor(Math.random() * selectedShapes.length)];
                window.cagedChordState.currentShape = randomShapeName;

                // 获取根音
                let key = window.cagedChordState.currentKey;
                if (key === 'random') {
                    const keys = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];
                    key = keys[Math.floor(Math.random() * keys.length)];
                }
                
                // 更新CAGED状态中的调性（保持同步）
                window.cagedChordState.currentKey = key;
                
                // 获取和弦类型
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }

                // 如果是手动切换或在同一轮练习中，保持当前和弦类型
                if (window.cagedChordState.isManualSwitch || !window.cagedChordState.isNewRound) {
                    if (window.cagedChordState.currentChordType) {
                        chordType = window.cagedChordState.currentChordType;
                        console.log('保持当前和弦类型:', chordType);
                    }
                } else {
                    // 新一轮练习，可以重新选择和弦类型
                    window.cagedChordState.currentChordType = chordType;
                }
                
                // 标记不再是新一轮
                window.cagedChordState.isNewRound = false;
                
                // 更新目标音程显示
                const targetIntervalEl = document.getElementById('targetInterval');
                const chordSymbol = formatChordSymbol(key, chordType);
                targetIntervalEl.textContent = chordSymbol;
                
                // 生成CAGED和弦序列
                state.currentIntervals = [...chordTypes[chordType].intervals];
                state.cagedMode = true;
                state.cagedShape = randomShapeName;
                state.cagedKey = window.cagedChordState.currentKey;
                state.cagedPracticeType = window.cagedChordState.practiceType;
                state.chordType = chordType;
                
                displaySequence();
                
                // 显示CAGED形状选择界面
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedChordShapes();
                }
                
                // 生成CAGED下一题预览
                generateCagedChordNextExercise();
                
            }

            // 生成CAGED和弦下一题预览
            function generateCagedChordNextExercise() {
                if (!window.cagedChordState || !window.cagedChordState.enabled) {
                    return;
                }
                
                const selectedShapes = window.cagedChordState.selectedShapes;
                const currentShape = window.cagedChordState.currentShape;
                const currentIndex = selectedShapes.indexOf(currentShape);
                
                // 获取下一个形状
                let nextShapeName;
                if (window.cagedChordState.practiceMode === 'random') {
                    // 随机模式：随机选择一个形状
                    nextShapeName = selectedShapes[Math.floor(Math.random() * selectedShapes.length)];
                } else {
                    // 单个形状或连接模式：按顺序循环
                    const nextIndex = (currentIndex + 1) % selectedShapes.length;
                    nextShapeName = selectedShapes[nextIndex];
                }
                
                const nextShape = window.cagedSystem.shapes[nextShapeName];
                const key = window.cagedChordState.currentKey;
                const chordType = state.chordType || 'major';
                
                // 设置下一题信息
                const chordSymbol = formatChordSymbol(key, chordType);
                state.nextExerciseInfo = chordSymbol;
                state.nextExerciseIntervals = [...chordTypes[chordType].intervals];
                
                updateNextExerciseDisplay();
            }


            // 生成和弦练习
            function generateChordExercise() {
                try {
                    // 检查是否启用CAGED和弦练习模式
                    if (window.cagedChordState && window.cagedChordState.enabled) {
                        generateCagedChordExercise();
                        return;
                    }
                    
                    resetCagedModeState();
                    
                    // 隐藏乐曲名显示
                    const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                    if (songTitleDisplayEl) {
                        songTitleDisplayEl.style.display = 'none';
                    }
                    
                    // 清除之前的状态信息，确保从当前选中的和弦类型生成
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // 清除之前的和弦类型
                    
                    if (state.isCustomChordMode && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        // 使用自定义和弦序列
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            const bass = item.querySelector('.remove-chord').dataset.bass || 'root';
                            return { root, type, bass };
                        });

                        // 按顺序练习自定义和弦序列
                        const currentChordIndex = state.customChordIndex || 0;
                        const chord = chords[currentChordIndex];

                        state.rootNote = chord.root;
                        state.chordType = chord.type;
                        state.bassNote = chord.bass || 'root';
                        
                        // 检查和弦类型是否存在
                        if (!chordTypes[state.chordType]) {
                            throw new Error(`未知的和弦类型: ${state.chordType}`);
                        }
                        
                        state.currentIntervals = [...chordTypes[state.chordType].intervals];
                        
                        // 处理转位和弦
                        if (state.bassNote !== 'root') {
                            state.currentIntervals = applyChordInversion(state.currentIntervals, state.bassNote);
                        }

                    // 处理转位和弦
                    const bassNoteSelect = document.getElementById('chordBassNote');
                    if (bassNoteSelect) {
                        const bassNote = bassNoteSelect.value;
                        if (bassNote !== 'root') {
                            state.currentIntervals = applyChordInversion(state.currentIntervals, bassNote);
                        }
                    }

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // 下行模式：倒序排列
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    // 获取转位和弦名称
                    const bassNote = state.bassNote || (bassNoteSelect ? bassNoteSelect.value : 'root');
                    const chordSymbol = getInversionChordName(state.rootNote, state.chordType, bassNote);
                    // 只显示和弦名称，不显示音级结构
                    targetIntervalEl.textContent = chordSymbol;
                    targetIntervalEl.innerHTML = chordSymbol; // 确保只显示和弦名称
                    displaySequence();

                    // 设置下一个和弦为序列中的下一个
                    const nextIndex = (currentChordIndex + 1) % chords.length;
                    state.customChordIndex = nextIndex;
                    const nextChord = chords[nextIndex];

                    state.nextExerciseInfo = formatChordSymbol(nextChord.root, nextChord.type);                    state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    updateNextExerciseDisplay();
                } else {
                    // 使用原始和弦生成逻辑
                    state.customChordIndex = null;
                    originalGenerateChordExercise();
                }
                } catch (error) {
                    console.error('生成和弦练习失败:', error);
                    updateStatusIndicator('和弦练习生成失败: ' + error.message, 'error');
                    // 回退到默认和弦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // 显示音阶/和弦序列
            function displaySequence() {
                console.log('displaySequence调用 - currentIntervals:', state.currentIntervals);
                
                const fragment = document.createDocumentFragment();
                state.currentSequence = [];

                // 检查currentIntervals是否为空
                if (!state.currentIntervals || state.currentIntervals.length === 0) {
                    console.error('displaySequence: currentIntervals为空或未定义', {
                        currentIntervals: state.currentIntervals,
                        rootNote: state.rootNote,
                        scaleType: state.scaleType,
                        chordType: state.chordType
                    });
                    return;
                }

                // 直接使用原始音程进行显示（保持复合音程9、11、13等）
                state.currentIntervals.forEach((interval, index) => {
                    const span = document.createElement('div');
                    span.className = 'sequence-item';
                    if (index === 0) span.classList.add('current');
                    span.textContent = interval;
                    span.dataset.index = index;
                    fragment.appendChild(span);
                    state.currentSequence.push(interval);
                });

                sequenceDisplayEl.innerHTML = '';
                sequenceDisplayEl.appendChild(fragment);
            }

            // 启动节拍器
            function startMetronome() {
                if (state.metronomeInterval) {
                    stopMetronome();
                }

                if (!state.metronomeEnabled) return;

                const beatInterval = 60000 / state.metronomeTempo;

                document.documentElement.style.setProperty('--metronome-speed', `${beatInterval}ms`);

                if (practiceScreen.style.display === 'flex') {
                    practiceScreen.classList.add('metronome-active');
                }

                state.metronomeInterval = setInterval(() => {
                    // 背景闪光效果
                    if (state.metronomeFlashEnabled) {
                        practiceScreen.classList.add('metronome-flash');
                        setTimeout(() => {
                            practiceScreen.classList.remove('metronome-flash');
                        }, 300);
                    }

                    // 播放节拍器声音
                    if (state.metronomeSoundEnabled && audioContext) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 892; //远离一般乐音，避免干扰
                        gainNode.gain.value = 0.1;
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.05);
                    }
                }, beatInterval);
            }

            // 停止节拍器
            function stopMetronome() {
                if (state.metronomeInterval) {
                    clearInterval(state.metronomeInterval);
                    state.metronomeInterval = null;
                }

                practiceScreen.classList.remove('metronome-active');
                practiceScreen.classList.remove('metronome-flash');
            }

            // 初始化事件监听器
            function initEventListeners() {
                // 音频设备选择事件
                audioInputDeviceEl.addEventListener('change', function () {
                    selectedDeviceId = this.value;
                    if (isRecording) {
                        restartAudioWithNewDevice();
                    }
                    // 保存设置
                    saveSettings();
                    console.log('音频设备已保存到localStorage:', selectedDeviceId);
                });

                // 输入增益控制
                inputGainEl.addEventListener('input', function () {
                    inputGain = this.value / 100;
                    inputGainValueEl.textContent = this.value + '%';

                    if (gainNode) {
                        gainNode.gain.value = inputGain;
                    }
                    saveSettings(); // 保存设置
                });

                // 刷新设备列表
                refreshDevicesBtn.addEventListener('click', function () {
                    getAudioDevices();
                    updateStatusIndicator('正在刷新设备列表...', 'ready');
                    setTimeout(() => {
                        updateStatusIndicator('准备就绪', 'ready');
                    }, 1000);
                });

                // 歌曲选择事件监听器
                const jazzStandardEl = document.getElementById('jazzStandard');
                if (jazzStandardEl) {
                    jazzStandardEl.addEventListener('change', function() {
                        const selectedSong = this.value;
                        if (selectedSong) {
                            updateKeySelector(selectedSong);
                        }
                    });
                }

                // 节拍器开关事件
                metronomeToggleEl.addEventListener('change', function () {
                    state.metronomeEnabled = this.checked;
                    if (state.metronomeEnabled && practiceScreen.style.display === 'flex') {
                        startMetronome();
                    } else {
                        stopMetronome();
                    }
                    saveSettings(); // 保存设置
                });

                // 节拍器速度滑块事件
                metronomeTempoEl.addEventListener('input', function () {
                    state.metronomeTempo = parseInt(this.value);
                    metronomeTempoValueEl.textContent = state.metronomeTempo;

                    if (state.metronomeEnabled && state.metronomeInterval) {
                        startMetronome();
                    }
                    saveSettings(); // 保存设置
                });

                // 节拍器背景闪光开关事件
                metronomeFlashToggleEl.addEventListener('change', function () {
                    state.metronomeFlashEnabled = this.checked;
                    saveSettings(); // 保存设置
                });

                // 节拍器声音开关事件
                metronomeSoundToggleEl.addEventListener('change', function () {
                    state.metronomeSoundEnabled = this.checked;
                    saveSettings(); // 保存设置
                });

                // 冷却时间开关事件
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.addEventListener('change', function () {
                        state.enableCooldown = this.checked;
                        console.log('冷却时间功能:', this.checked ? '已启用' : '已关闭');
                        saveSettings(); // 保存设置
                    });
                }

                // 冷却时间滑块事件
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.addEventListener('input', function () {
                        state.cooldownDuration = parseInt(this.value);
                        cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                        console.log('冷却时间设置为:', state.cooldownDuration + 'ms');
                        saveSettings(); // 保存设置
                    });
                }

                // 固定延迟生成开关事件
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.addEventListener('change', function () {
                        state.enableFixedDelay = this.checked;
                        console.log('固定延迟生成功能:', this.checked ? '已启用' : '已关闭');
                        saveSettings(); // 保存设置
                    });
                }

                // 固定延迟时间滑块事件
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.addEventListener('input', function () {
                        state.fixedDelayDuration = parseInt(this.value);
                        fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                        console.log('固定延迟时间设置为:', state.fixedDelayDuration + 'ms');
                        saveSettings(); // 保存设置
                    });
                }

                // 音高检测敏感度滑块事件
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.addEventListener('input', function () {
                        state.sensitivity = parseFloat(this.value);
                        sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                        console.log('音高检测敏感度设置为:', state.sensitivity);
                        saveSettings(); // 保存设置
                    });
                }

                // 置信度阈值滑块事件
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.addEventListener('input', function () {
                        state.confidenceThreshold = parseFloat(this.value);
                        confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                        console.log('置信度阈值设置为:', state.confidenceThreshold);
                        saveSettings(); // 保存设置
                    });
                }
                
                // 重置设置按钮事件
                const resetSettingsBtn = document.getElementById('resetSettingsBtn');
                if (resetSettingsBtn) {
                    resetSettingsBtn.addEventListener('click', function () {
                        resetSettings();
                    });
                }

                // 开始练习按钮
                startBtn.addEventListener('click', function () {
                    console.log('开始练习按钮被点击');
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                    console.log('当前选择的标签页:', activeTab);
                    
                    // 验证和弦设置
                    if (activeTab === 'chord') {
                        // useCustomChords 开关已移除，直接检查和弦类型
                        if (!state.isCustomChordMode) {
                            const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                            if (activeChordTypes.length === 0) {
                                alert('请先选择至少一个和弦类型！');
                                return;
                            }
                        } else {
                            const customChordItems = document.querySelectorAll('#customChordSequence .chord-item');
                            if (customChordItems.length === 0) {
                                alert('请先添加至少一个自定义和弦！');
                                return;
                            }
                        }
                    }

                    // 验证音阶设置
                    if (activeTab === 'scale') {
                        // 检查是否选择了调式
                        if (window.ScaleTypeManager && window.ScaleTypeManager.selectedScales.size === 0) {
                            alert('请选择要练习的调式！');
                            return;
                        }
                    }
                    
                    updateStatusIndicator('正在启动麦克风...', 'recording');

                    // 检查浏览器是否支持getUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('浏览器不支持getUserMedia');
                        updateStatusIndicator('浏览器不支持麦克风访问', 'error');
                        return;
                    }
                    
                    console.log('正在请求麦克风权限...');
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function (stream) {
                            console.log('麦克风权限获取成功，音频流:', stream);
                            mediaStream = stream;

                            mainScreen.style.display = 'none';
                            practiceScreen.style.display = 'flex';
                            document.getElementById('pitchDisplay').style.display = 'block';

                            requestWakeLock();

                            state.nextExerciseInfo = '';
                            state.nextExerciseIntervals = [];

                            // 根据标签页类型生成相应的练习
                            if (activeTab === 'pitch-finding') {
                                const practiceMode = document.querySelector('.practice-mode-btn.active');
                                
                                if (practiceMode && practiceMode.dataset.mode === 'interval') {
                                    // 音程练习模式
                                    generateIntervalExercise();
                                } else {
                                    // 单音练习模式
                                    generatePitchFindingExercise();
                                }
                            } else {
                                // 其他练习模式
                            generateExercise();
                            }

                            console.log('开始录音...');
                            startRecording();

                            state.metronomeEnabled = document.getElementById('metronomeToggle').checked;
                            state.metronomeTempo = parseInt(document.getElementById('metronomeTempo').value);
                            state.metronomeFlashEnabled = document.getElementById('metronomeFlashToggle').checked;
                            state.metronomeSoundEnabled = document.getElementById('metronomeSoundToggle').checked;

                            if (state.metronomeEnabled) {
                                startMetronome();
                                practiceScreen.classList.add('metronome-active');
                            }
                        })
                        .catch(function (err) {
                            console.error('麦克风获取失败:', err);
                            console.error('错误类型:', err.name);
                            console.error('错误信息:', err.message);

                            updateStatusIndicator('未获取录音权限', 'error');

                            const errorMessage = document.createElement('div');
                            errorMessage.style.position = 'fixed';
                            errorMessage.style.top = '50%';
                            errorMessage.style.left = '50%';
                            errorMessage.style.transform = 'translate(-50%, -50%)';
                            errorMessage.style.background = 'rgba(239, 68, 68, 0.9)';
                            errorMessage.style.color = 'white';
                            errorMessage.style.padding = '20px';
                            errorMessage.style.borderRadius = '10px';
                            errorMessage.style.zIndex = '2000';
                            errorMessage.style.maxWidth = '80%';
                            errorMessage.style.textAlign = 'center';
                            errorMessage.innerHTML = `
                                <h3 style="margin-bottom: 10px; font-size: 18px;" data-i18n-key="mic_permission_denied">麦克风权限被拒绝</h3>
                                <p style="margin-bottom: 15px;" data-i18n-key="mic_permission_needed">此应用需要麦克风权限才能检测音高。</p>
                                <p data-i18n-key="mic_permission_steps">请按照以下步骤操作：</p>
                                <ol style="text-align: left; margin: 15px 0; padding-left: 20px;">
                                    <li data-i18n-key="mic_step_1">点击浏览器地址栏左侧的锁定/信息图标</li>
                                    <li data-i18n-key="mic_step_2">在弹出的菜单中找到"麦克风"选项</li>
                                    <li data-i18n-key="mic_step_3">将其设置为"允许"</li>
                                    <li data-i18n-key="mic_step_4">刷新页面后重试</li>
                                </ol>
                                <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                    <button id="refreshPage" style="padding: 8px 16px; background: #3a9fc4; border: none; border-radius: 5px; color: white; cursor: pointer;" data-i18n-key="refresh_page">刷新页面</button>
                                    <button id="returnToMain" style="padding: 8px 16px; background: #6c757d; border: none; border-radius: 5px; color: white; cursor: pointer;" data-i18n-key="return_to_main">返回主菜单</button>
                                </div>
                            `;
                            document.body.appendChild(errorMessage);

                            document.getElementById('refreshPage').addEventListener('click', function() {
                                location.reload();
                            });
                            
                            document.getElementById('returnToMain').addEventListener('click', function () {
                                document.body.removeChild(errorMessage);
                                updateStatusIndicator('准备就绪', 'ready');
                            });
                        });
                });

                // 底部导航栏切换
                const bottomNavItems = document.querySelectorAll('.nav-item');
                bottomNavItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const tabName = this.dataset.tab;

                        // 移除所有导航项的active状态
                        bottomNavItems.forEach(navItem => navItem.classList.remove('active'));
                        // 为当前点击的导航项添加active状态
                        this.classList.add('active');

                        // 默认隐藏所有设置区域
                        scaleSettings.style.display = 'none';
                        chordSettings.style.display = 'none';
                        progressionSettings.style.display = 'none';
                        deviceSettings.style.display = 'none';
                        const pitchFindingSettings = document.querySelector('.pitch-finding-settings');
                        if (pitchFindingSettings) {
                            pitchFindingSettings.style.display = 'none';
                        }
                                const cagedChordSettingsSection = document.querySelector('.caged-chord-settings-section');
                        if (cagedChordSettingsSection) {
                            cagedChordSettingsSection.style.display = 'none';
                        }
                        const cagedSettingsSection = document.querySelector('.caged-settings-section');
                        if (cagedSettingsSection) {
                            cagedSettingsSection.style.display = 'none';
                        }

                        // 根据标签页显示对应设置
                        if (tabName === 'scale') {
                            scaleSettings.style.display = 'block';
                            if (cagedSettingsSection) {
                                cagedSettingsSection.style.display = 'block';
                            }
                            // 更新音阶练习按钮显示
                            updateArpeggioButtons();
                        } else if (tabName === 'chord') {
                            chordSettings.style.display = 'block';
                            const cagedChordSettingsSection = document.querySelector('.caged-chord-settings-section');
                            if (cagedChordSettingsSection) {
                                cagedChordSettingsSection.style.display = 'block';
                            }
                            // 更新音阶练习按钮显示，确保移除动态按钮
                            updateArpeggioButtons();
                        } else if (tabName === 'progression') {
                            progressionSettings.style.display = 'block';
                            // 更新音阶练习按钮显示，确保移除动态按钮
                            updateArpeggioButtons();
                        } else if (tabName === 'pitch-finding') {
                            if (pitchFindingSettings) {
                                pitchFindingSettings.style.display = 'block';
                            }
                        } else if (tabName === 'device') {
                            deviceSettings.style.display = 'block';
                            // 更新音阶练习按钮显示，确保移除动态按钮
                            updateArpeggioButtons();
                        }
                        
                        // 控制开始练习按钮的显示
                        const controls = document.querySelector('.controls');
                        if (controls) {
                            // 在设置标签页中隐藏开始练习按钮
                            if (tabName === 'device') {
                                controls.style.display = 'none';
                            } else {
                                controls.style.display = 'flex';
                            }
                        }
                    });
                });

                // 初始化显示音阶设置（如果是音阶练习标签页）
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                if (activeTab === 'scale') {
                    scaleSettings.style.display = 'block';
                    const cagedSettingsSection = document.querySelector('.caged-settings-section');
                    if (cagedSettingsSection) {
                        cagedSettingsSection.style.display = 'block';
                    }
                }
                
                // 初始化时根据默认选中的标签页来控制按钮的显示
                const controls = document.querySelector('.controls');
                if (controls) {
                    // 在设置标签页中隐藏开始练习按钮
                    if (activeTab === 'device') {
                        controls.style.display = 'none';
                    } else {
                        controls.style.display = 'flex';
                    }
                }

                // 和弦类型按钮点击事件
                // 定义切换和弦类型的函数
                function toggleChordType() {
                        this.classList.toggle('active');
                    console.log('和弦类型按钮被点击:', this.dataset.value, this.classList.contains('active') ? '已激活' : '已取消');
                }
                
                chordTypeBtns.forEach(btn => {
                    // 移除可能存在的旧监听器，防止重复绑定
                    btn.removeEventListener('click', toggleChordType);
                    // 添加新的监听器
                    btn.addEventListener('click', toggleChordType);
                });

                // 音阶顺序按钮点击事件
                const scaleOrderBtns = document.querySelectorAll('.scale-order-btn');
                scaleOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // 练习序列按钮点击事件
                const scaleArpeggioBtns = document.querySelectorAll('.scale-arpeggio-btn');
                scaleArpeggioBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleArpeggioBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 当按钮被点击时，更新按钮显示以反映当前音阶
                        updateArpeggioButtons();
                    });
                });

                // 和弦顺序按钮点击事件
                const chordOrderBtns = document.querySelectorAll('.chord-order-btn');
                chordOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        chordOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // 和弦名显示模式按钮点击事件
                const chordNameDisplayBtns = document.querySelectorAll('.chord-name-display-btn');
                chordNameDisplayBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        chordNameDisplayBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 更新状态
                        state.chordNameDisplayMode = this.dataset.value;
                        
                        // 更新和弦类型按钮的显示文本
                        updateChordTypeButtonTexts();
                        
                        // 重新生成当前练习以应用新的显示模式
                        const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                        if (activeTab === 'chord') {
                            generateChordExercise();
                        } else if (activeTab === 'progression') {
                            generateProgressionExercise();
                        }
                        
                        // 保存设置
                        saveSettings();
                    });
                });

                // 和弦转换顺序按钮点击事件
                const progressionOrderBtns = document.querySelectorAll('.progression-order-btn');
                progressionOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        progressionOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // 找音练习指板长度按钮点击事件
                const pitchFindingRangeBtns = document.querySelectorAll('.pitch-finding-range-btn');
                pitchFindingRangeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        pitchFindingRangeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 如果当前在找音练习模式且指板已显示，重新创建指板
                        if (state.pitchFindingMode && document.getElementById('fretboardContainer').style.display !== 'none') {
                            createFretboard();
                        }
                    });
                });

                // 找音练习下一题间隔时间按钮点击事件
                const pitchFindingIntervalBtns = document.querySelectorAll('.pitch-finding-interval-btn');
                pitchFindingIntervalBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        pitchFindingIntervalBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // 找音练习下一题按钮点击事件
                const pitchFindingNextBtn = document.getElementById('pitchFindingNextBtn');
                if (pitchFindingNextBtn) {
                    pitchFindingNextBtn.addEventListener('click', function (event) {
                        // 阻止事件冒泡，避免触发退出练习的逻辑
                        event.stopPropagation();
                        event.preventDefault();
                        
                        // 检查当前练习模式
                        const practiceMode = document.querySelector('.practice-mode-btn.active');
                        if (practiceMode && practiceMode.dataset.mode === 'interval') {
                            // 音程练习模式
                            generateNextIntervalExercise();
                        } else {
                            // 单音练习模式
                            generateNextPitchFindingQuestion();
                        }
                    });
                }

                // 练习模式按钮点击事件
                const practiceModeBtns = document.querySelectorAll('.practice-mode-btn');
                practiceModeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        practiceModeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        const mode = this.dataset.mode;
                        const intervalSettings = document.getElementById('intervalSettings');
                        
                        if (mode === 'interval') {
                            intervalSettings.style.display = 'block';
                        } else {
                            intervalSettings.style.display = 'none';
                        }
                    });
                });


                // 音程选择按钮点击事件
                const intervalBtns = document.querySelectorAll('.interval-btn');
                intervalBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                    });
                });

                // 添加缺失的变量和函数
                const noteToSemitones = {
                    'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4, 
                    'F': 5, 'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8, 
                    'A': 9, 'A♯': 10, 'B♭': 10, 'B': 11
                };
                
                const intervalToSemitones = {
                    '1': 0, '♭2': 1, '2': 2, '♯2': 3, '♭3': 3, '3': 4, '4': 5,
                    '♯4': 6, '♭5': 6, '5': 7, '♯5': 8, '♭6': 8, '6': 9, '♯6': 10,
                    '♭7': 10, '7': 11, '♭♭7': 10, 
                    // 复合音程映射（9=2, 11=4, 13=6）
                    '♭9': 1, '9': 2, '♯9': 3,
                    '11': 4, '♯11': 6, 
                    '♭13': 8, '13': 9
                };
                
                // 音程练习相关函数
                function generateIntervalExercise() {
                    resetCagedModeState();

                    // 清除之前的定时器
                    if (state.intervalNextTimeout) {
                        clearTimeout(state.intervalNextTimeout);
                        state.intervalNextTimeout = null;
                    }

                    // 设置音程练习模式
                    window.state.intervalExerciseMode = true;
                    window.state.pitchFindingMode = false;

                    // 隐藏乐曲名显示
                    const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                    if (songTitleDisplayEl) {
                        songTitleDisplayEl.style.display = 'none';
                    }
                    
                    // 清理sequence-item的CSS状态
                    const sequenceItems = document.querySelectorAll('.sequence-item');
                    sequenceItems.forEach(item => {
                        item.classList.remove('current');
                        item.style.width = '';
                        item.style.flex = '';
                        item.style.maxWidth = '';
                    });
                    
                    // 先检查是否选择了音程
                    const selectedIntervals = Array.from(document.querySelectorAll('.interval-btn.active'))
                        .map(btn => btn.dataset.interval);
                    
                    if (selectedIntervals.length === 0) {
                        alert('请至少选择一个音程进行练习！');
                        // 重置练习模式状态
                        state.cagedMode = false;
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;
                        console.log('音程练习退出 - 重置练习模式状态');
                        // 停止录音并返回主页面
                        stopRecording();
                        practiceScreen.style.display = 'none';
                        mainScreen.style.display = 'block';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        return;
                    }
                    
                    // 清除之前的计时器状态
                    if (state.pitchFindingTimer) {
                        clearInterval(state.pitchFindingTimer);
                        state.pitchFindingTimer = null;
                    }
                    
                    // 显示音程练习界面
                    document.getElementById('pitchFindingElements').style.display = 'block';
                    
                    // 隐藏其他练习元素
                    document.getElementById('targetInterval').style.display = 'none';
                    document.getElementById('sequenceDisplay').style.display = 'none';
                    document.getElementById('nextExercise').style.display = 'none';
                    
                    // 隐藏练习容器，因为音程练习有自己的界面
                    const intervalExerciseContainer = document.querySelector('.exercise-container');
                    if (intervalExerciseContainer) {
                        intervalExerciseContainer.style.display = 'none';
                    }
                    
                    // 获取指板设置
                    const showFretboard = document.getElementById('showFretboard').checked;
                    
                    // 显示或隐藏指板
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    const fretboardFooter = document.getElementById('fretboardFooter');
                    if (showFretboard) {
                        fretboardContainer.style.display = 'block';
                        fretboardFooter.style.display = 'block';
                        createFretboard();
                    } else {
                        fretboardContainer.style.display = 'none';
                        fretboardFooter.style.display = 'none';
                    }
                    
                    // 显示下一题按钮
                    document.querySelector('.pitch-finding-next-btn-container').style.display = 'flex';
                    
                    // 隐藏next-exercise容器
                    const nextExerciseContainer = document.querySelector('.next-exercise');
                    if (nextExerciseContainer) {
                        nextExerciseContainer.style.display = 'none';
                    }
                    const exerciseContainer = document.querySelector('.exercise-container');
                    if (exerciseContainer) {
                        exerciseContainer.style.display = 'none';
                    }
                    
                    // 获取根音设置
                    const rootNoteSelect = document.getElementById('rootNoteSelect');
                    let selectedRootNote = rootNoteSelect.value;
                    
                    // 如果是随机，则随机选择一个根音
                    if (selectedRootNote === 'random') {
                        const allNotes = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                        selectedRootNote = allNotes[Math.floor(Math.random() * allNotes.length)];
                    }
                    
                    // 获取是否先找根音
                    const findRootFirst = document.getElementById('findRootFirst').checked;
                    
                    // 生成题目
                    let exerciseIntervals = [];
                    let currentInterval = '';
                    
                    if (findRootFirst) {
                        // 先找根音：生成 1 + 其他音程 的组合
                        exerciseIntervals = selectedIntervals;
                        // 随机选择一个音程与1配对
                        const randomInterval = selectedIntervals[Math.floor(Math.random() * selectedIntervals.length)];
                        currentInterval = `1 ${randomInterval}`;
                    } else {
                        // 不先找根音：从选中的音程中随机选择两个配对
                        exerciseIntervals = selectedIntervals;
                        if (selectedIntervals.length >= 2) {
                            // 随机选择两个不同的音程
                            const shuffled = [...selectedIntervals].sort(() => Math.random() - 0.5);
                            currentInterval = `${shuffled[0]} ${shuffled[1]}`;
                        } else {
                            // 只有一个音程，重复显示
                            currentInterval = `${selectedIntervals[0]} ${selectedIntervals[0]}`;
                        }
                    }
                    
                    // 显示根音作为当前音符
                    const currentNoteDisplay = document.getElementById('currentNoteDisplay');
                    currentNoteDisplay.textContent = selectedRootNote;
                    
                    // 保存当前练习状态
                    state.currentIntervalExercise = {
                        intervals: exerciseIntervals,
                        currentInterval: currentInterval,
                        rootNote: selectedRootNote,
                        findRootFirst: findRootFirst,
                        answered: false,
                        completedIntervals: [] // 跟踪已完成的音程
                    };
                    
                    // 显示音级信息
                    updateIntervalExerciseDisplay();
                    
                    // 重置单音练习状态，避免混淆
                    state.pitchFindingAnswered = false;
                    state.currentNote = null;
                    
                    // 设置音程练习模式标志，确保processAudio正确路由
                    state.pitchFindingMode = true;
                    
                    // 启动音程练习计时器
                    const practiceTimeSelect = document.getElementById('pitchFindingTime');
                    if (practiceTimeSelect) {
                        const minutes = parseInt(practiceTimeSelect.value);
                        startPitchFindingTimer(minutes);
                    }
                }
                
                // 生成下一题音程练习（不重新启动计时器）
                function generateNextIntervalExercise() {
                    // 清除之前的定时器
                    if (state.intervalNextTimeout) {
                        clearTimeout(state.intervalNextTimeout);
                        state.intervalNextTimeout = null;
                    }

                    if (!state.currentIntervalExercise) return;
                    
                    const exercise = state.currentIntervalExercise;
                    const selectedIntervals = exercise.intervals.filter(interval => interval !== '1');
                    
                    // 检查根音设置，如果是随机则生成新的随机根音
                    const rootNoteSelect = document.getElementById('rootNoteSelect');
                    let newRootNote = exercise.rootNote;
                    
                    if (rootNoteSelect.value === 'random') {
                        const allNotes = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                        newRootNote = allNotes[Math.floor(Math.random() * allNotes.length)];
                        
                        // 更新根音显示
                        const currentNoteDisplay = document.getElementById('currentNoteDisplay');
                        currentNoteDisplay.textContent = newRootNote;
                        
                        // 更新练习状态中的根音
                        state.currentIntervalExercise.rootNote = newRootNote;
                    }
                    
                    // 随机选择当前音程对
                    let currentInterval;
                    if (exercise.findRootFirst) {
                        // 如果开启先找根音，则随机选择1和某个选中的音程
                        const randomInterval = selectedIntervals[Math.floor(Math.random() * selectedIntervals.length)];
                        currentInterval = `1 ${randomInterval}`;
                    } else {
                        // 如果关闭先找根音，则随机选择两个选中的音程
                        if (selectedIntervals.length >= 2) {
                            const shuffled = [...selectedIntervals].sort(() => Math.random() - 0.5);
                            currentInterval = `${shuffled[0]} ${shuffled[1]}`;
                        } else {
                            currentInterval = `${selectedIntervals[0]} ${selectedIntervals[0]}`;
                        }
                    }
                    
                    // 更新练习状态
                    state.currentIntervalExercise.currentInterval = currentInterval;
                    state.currentIntervalExercise.answered = false;
                    state.currentIntervalExercise.completedIntervals = []; // 重置已完成的音程
                    
                    // 清除指板上的高亮和音程显示
                    clearFretboardHighlights();
                    
                    // 显示音级信息
                    updateIntervalExerciseDisplay();
                    
                    // 重置单音练习状态，避免混淆
                    state.pitchFindingAnswered = false;
                    state.currentNote = null;
                }
                
                // 将函数暴露到全局作用域
                window.generateNextIntervalExercise = generateNextIntervalExercise;
                
                // 显示指板功能
                function showFretboardForPractice() {
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    const fretboardFooter = document.getElementById('fretboardFooter');
                    
                    if (fretboardContainer && fretboardFooter) {
                        fretboardContainer.style.display = 'block';
                        fretboardFooter.style.display = 'block';
                        createFretboard();
                        
                        // 设置指板显示状态
                        state.fretboardVisible = true;
                        console.log('指板已显示');
                        
                        // 如果当前有正在等待的延迟，重新设置延迟时间
                        updateCurrentDelay();
                    }
                }
                
                // 隐藏指板功能
                function hideFretboardForPractice() {
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    const fretboardFooter = document.getElementById('fretboardFooter');

                    if (fretboardContainer && fretboardFooter) {
                        fretboardContainer.style.display = 'none';
                        fretboardFooter.style.display = 'none';

                        // 清除指板高亮
                        clearFretboardHighlights();

                        // 设置指板隐藏状态
                        state.fretboardVisible = false;
                        console.log('指板已隐藏');

                        // 隐藏指板时立即进入下一题（如果当前练习已完成）
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            const practiceMode = document.querySelector('.practice-mode-btn.active');

                            if (practiceMode && practiceMode.dataset.mode === 'interval') {
                                // 音程练习模式
                                if (state.currentIntervalExercise && state.currentIntervalExercise.answered) {
                                    console.log('隐藏指板，音程练习立即进入下一题');
                                    // 清除延迟
                                    if (state.intervalNextTimeout) {
                                        clearTimeout(state.intervalNextTimeout);
                                        state.intervalNextTimeout = null;
                                    }
                                    // 立即进入下一题
                                    generateNextIntervalExercise();
                                }
                            } else {
                                // 单音练习模式
                                if (state.pitchFindingAnswered) {
                                    console.log('隐藏指板，单音练习立即进入下一题');
                                    // 清除延迟
                                    if (state.pitchFindingNextTimeout) {
                                        clearTimeout(state.pitchFindingNextTimeout);
                                        state.pitchFindingNextTimeout = null;
                                    }
                                    // 立即进入下一题
                                    generateNextPitchFindingQuestion();
                                }
                            }
                        }
                    }
                }
                
                // 更新当前延迟时间（当指板显示状态改变时）
                function updateCurrentDelay() {
                    // 检查是否有正在进行的找音练习延迟
                    if (state.pitchFindingNextTimeout && state.pitchFindingAnswered) {
                        console.log('检测到找音练习延迟，重新设置延迟时间');
                        
                        // 清除当前的延迟
                        clearTimeout(state.pitchFindingNextTimeout);
                        
                        // 获取当前设置
                        const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                        const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;
                        
                        // 检查指板是否显示
                        const fretboardContainer = document.getElementById('fretboardContainer');
                        const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';
                        
                        // 重新计算延迟时间
                        let delayTime;
                        if (!isFretboardVisible) {
                            // 指板隐藏时立即自动切换（忽略手动模式设置）
                            delayTime = 100;
                            console.log(`重新设置找音练习指板隐藏: 立即自动切换下一题`);
                        } else if (intervalSeconds === 0) {
                            // 指板显示且手动模式：不设置自动切换
                            delayTime = 0;
                            console.log(`重新设置找音练习指板显示且手动模式: 取消自动切换，等待用户操作`);
                        } else {
                            // 指板显示且自动模式：使用设置的延迟时间
                            delayTime = intervalSeconds * 1000;
                            console.log(`重新设置找音练习指板显示且自动模式: 延迟${delayTime}ms`);
                        }

                        if (delayTime > 0) {
                            console.log(`重新设置找音练习延迟: 指板显示=${isFretboardVisible}, 新延迟时间=${delayTime}ms`);
                            // 重新设置延迟
                            state.pitchFindingNextTimeout = setTimeout(() => {
                                generateNextPitchFindingQuestion();
                            }, delayTime);
                        }
                    }
                    
                    // 检查是否有正在进行的音程练习延迟
                    if (state.intervalNextTimeout && state.currentIntervalExercise && state.currentIntervalExercise.answered) {
                        console.log('检测到音程练习延迟，重新设置延迟时间');

                        // 清除当前的延迟
                        clearTimeout(state.intervalNextTimeout);
                        state.intervalNextTimeout = null;

                        // 获取当前设置
                        const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                        const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;

                        // 检查指板是否显示
                        const fretboardContainer = document.getElementById('fretboardContainer');
                        const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';

                        // 重新计算延迟时间
                        let delayTime;
                        if (!isFretboardVisible) {
                            // 指板隐藏时立即自动切换（忽略手动模式设置）
                            delayTime = 100;
                            console.log(`重新设置音程练习指板隐藏: 立即自动切换下一题`);
                        } else if (intervalSeconds === 0) {
                            // 指板显示且手动模式：不设置自动切换
                            delayTime = 0;
                            console.log(`重新设置音程练习指板显示且手动模式: 取消自动切换，等待用户操作`);
                        } else {
                            // 指板显示且自动模式：使用设置的延迟时间
                            delayTime = intervalSeconds * 1000;
                            console.log(`重新设置音程练习指板显示且自动模式: 延迟${delayTime}ms`);
                        }

                        if (delayTime > 0) {
                            console.log(`重新设置音程练习延迟: 指板显示=${isFretboardVisible}, 新延迟时间=${delayTime}ms`);
                            // 重新设置延迟
                            state.intervalNextTimeout = setTimeout(() => {
                                generateNextIntervalExercise();
                            }, delayTime);
                        }
                    }
                }
                
                // 将指板控制函数暴露到全局作用域
                window.showFretboardForPractice = showFretboardForPractice;
                window.hideFretboardForPractice = hideFretboardForPractice;
                
                function updateIntervalExerciseDisplay() {
                    const exercise = state.currentIntervalExercise;
                    if (!exercise) return;
                    
                    // 创建或更新显示元素
                    let intervalDisplay = document.getElementById('intervalExerciseDisplay');
                    if (!intervalDisplay) {
                        intervalDisplay = document.createElement('div');
                        intervalDisplay.id = 'intervalExerciseDisplay';
                        intervalDisplay.className = 'interval-exercise-display';
                        const currentNoteContainer = document.querySelector('.pitch-finding-current-note');
                        currentNoteContainer.appendChild(intervalDisplay);
                    }
                    
                    // 清空内容
                    intervalDisplay.innerHTML = '';
                    
                    // 创建背景音级显示
                    const backgroundIntervals = document.createElement('div');
                    backgroundIntervals.className = 'background-intervals';
                    // 只显示选中的音程，不显示1
                    backgroundIntervals.textContent = exercise.intervals.join(' ');
                    
                    // 创建当前题目显示
                    const currentInterval = document.createElement('div');
                    currentInterval.className = 'current-interval';
                    currentInterval.textContent = exercise.currentInterval;
                    
                    intervalDisplay.appendChild(backgroundIntervals);
                    intervalDisplay.appendChild(currentInterval);
                }
                
                
                // 清除指板高亮
                function clearFretboardHighlights() {
                    const fretboard = document.getElementById('fretboard');
                    if (!fretboard) return;

                    const frets = fretboard.querySelectorAll('.fretboard-fret');
                    frets.forEach(fret => {
                        fret.style.backgroundColor = '';
                        fret.style.boxShadow = '';

                        // 移除音程标记
                        const intervalDisplay = fret.querySelector('.interval-display');
                        if (intervalDisplay) {
                            intervalDisplay.remove();
                        }
                    });

                    // 清除CAGED相关元素（重要：防止在非CAGED练习中显示）
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    if (fretboardContainer) {
                        const cagedElements = fretboardContainer.querySelectorAll('.caged-shape-highlight, .caged-fingering');
                        if (cagedElements.length > 0) {
                            cagedElements.forEach(el => el.remove());
                            console.log('音程练习 - 清除CAGED元素:', cagedElements.length, '个');
                        }
                    }

                    // 恢复所有被隐藏的空弦音名
                    const hiddenMarkers = document.querySelectorAll('.fret-marker.hidden');
                    hiddenMarkers.forEach(marker => {
                        const originalNote = marker.dataset.originalNote;
                        if (originalNote) {
                            marker.textContent = originalNote;
                            marker.classList.remove('hidden');
                            delete marker.dataset.originalNote;
                        }
                    });
                }
                

                
                

                // 点击练习屏幕返回主页面
                // 修改练习屏幕点击事件，确保退出时重置冷却期
                practiceScreen.addEventListener('click', function () {
                    updateStatusIndicator('正在停止录音...', 'ready');

                    // 根据当前模式重置相应的状态
                    if (state.isCustomChordMode) {
                        state.isCustomChordMode = false;
                        console.log('退出自定义和弦练习页面 - 重置 state.isCustomChordMode = false');
                    } else {
                    state.cagedMode = false;
                    console.log('退出练习页面 - 重置 state.cagedMode = false');
                    }

                    // 重置和弦转换练习的会话状态
                    state.isInProgressionSession = false;

                    // 重置找音练习计时器
                    if (state.pitchFindingTimer) {
                        clearInterval(state.pitchFindingTimer);
                        state.pitchFindingTimer = null;
                    }

                    // 只有在启用冷却时间时才重置冷却期状态
                    if (state.enableCooldown) {
                        state.isCoolingDown = false;
                        if (state.cooldownTimeout) {
                            clearTimeout(state.cooldownTimeout);
                            state.cooldownTimeout = null;
                        }
                    }

                    setTimeout(() => {
                        stopRecording();
                        stopMetronome();
                        //releaseWakeLock();

                        // 重置练习模式状态
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;

                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';

                        // 隐藏找音练习特定元素
                        const pitchFindingElements = document.getElementById('pitchFindingElements');
                        if (pitchFindingElements) {
                            pitchFindingElements.style.display = 'none';
                        }
                        
                        // 隐藏下一题按钮
                        const nextBtnContainer = document.querySelector('.pitch-finding-next-btn-container');
                        if (nextBtnContainer) {
                            nextBtnContainer.style.display = 'none';
                        }
                        
                        // 隐藏乐曲名显示
                        const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                        if (songTitleDisplayEl) {
                            songTitleDisplayEl.style.display = 'none';
                        }
                        
                        // 恢复练习容器显示
                        const exerciseContainer = document.querySelector('.exercise-container');
                        if (exerciseContainer) {
                            exerciseContainer.style.display = 'block';
                        }
                        
                        // 恢复其他练习元素显示
                        document.getElementById('targetInterval').style.display = 'block';
                        document.getElementById('sequenceDisplay').style.display = 'flex';
                        document.getElementById('nextExercise').style.display = 'block';
                        
                        // 清理sequence-item的CSS状态
                        const sequenceItems = document.querySelectorAll('.sequence-item');
                        sequenceItems.forEach(item => {
                            item.classList.remove('current');
                            // 只清理可能影响布局的属性，保留必要的flex布局属性
                            item.style.width = '';
                            item.style.maxWidth = '';
                            item.style.transform = '';
                        });
                        
                        // 恢复next-exercise容器显示
                        const nextExerciseContainer = document.querySelector('.next-exercise');
                        if (nextExerciseContainer) {
                            nextExerciseContainer.style.display = 'flex';
                        }
                        
                        mainScreen.style.display = 'block';

                        updateStatusIndicator('准备就绪', 'ready');
                    }, 300);
                });
                // 页面关闭时完全关闭麦克风
                window.addEventListener('beforeunload', function () {
                    closeMicrophone();
                });
            }

            // 初始化CAGED事件监听器
            function initCagedEventListeners() {
                // CAGED设置事件监听器
                const cagedModeToggle = document.getElementById('cagedModeToggle');
                const cagedSettings = document.getElementById('cagedSettings');
                
                // CAGED和弦练习设置事件监听器
                const cagedChordModeToggle = document.getElementById('cagedChordModeToggle');
                const cagedChordSettings = document.getElementById('cagedChordSettings');
                
                // CAGED和弦练习模式切换
                if (cagedChordModeToggle) {
                    // 初始化滑块状态
                    cagedChordModeToggle.checked = window.cagedChordState.enabled;
                    if (cagedChordSettings) {
                        cagedChordSettings.style.display = window.cagedChordState.enabled ? 'block' : 'none';
                    }
                    
                    cagedChordModeToggle.addEventListener('change', function() {
                        window.cagedChordState.enabled = this.checked;
                        if (cagedChordSettings) {
                            cagedChordSettings.style.display = this.checked ? 'block' : 'none';
                        }
                        saveSettings();
                    });
                }
                
                // CAGED和弦形状选择
                const cagedChordShapeBtns = document.querySelectorAll('#cagedChordSettings .caged-shape-btn');
                cagedChordShapeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        const shape = this.dataset.shape;
                        if (this.classList.contains('active')) {
                            if (!window.cagedChordState.selectedShapes.includes(shape)) {
                                window.cagedChordState.selectedShapes.push(shape);
                            }
                        } else {
                            window.cagedChordState.selectedShapes = window.cagedChordState.selectedShapes.filter(s => s !== shape);
                        }
                        saveSettings();
                    });
                });
                
                // CAGED和弦练习模式选择
                const cagedChordModeBtns = document.querySelectorAll('.caged-chord-mode-btn');
                cagedChordModeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        cagedChordModeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        window.cagedChordState.practiceMode = this.dataset.mode;
                        saveSettings();
                    });
                });
                
                
                if (cagedModeToggle) {
                    // 初始化滑块状态
                    cagedModeToggle.checked = window.cagedState.enabled;
                    if (cagedSettings) {
                        cagedSettings.style.display = window.cagedState.enabled ? 'block' : 'none';
                    }
                    
                    cagedModeToggle.addEventListener('change', function() {
                        window.cagedState.enabled = this.checked;
                        
                        if (cagedSettings) {
                            cagedSettings.style.display = window.cagedState.enabled ? 'block' : 'none';
                        }
                    });
                }

                // MIDI开关事件
                const midiToggle = document.getElementById('midiToggle');
                if (midiToggle) {
                    // 初始化滑块状态
                    midiToggle.checked = window.midiState.enabled;
                    
                    midiToggle.addEventListener('change', async function() {
                        if (this.checked) {
                            // 启用MIDI
                            const success = await initializeMIDI();
                            if (success) {
                                window.midiState.enabled = true;
                                
                                // 连接所有MIDI输入设备
                                connectMIDIDevices();
                            } else {
                                // 如果初始化失败，取消选中状态
                                this.checked = false;
                                alert('无法启用MIDI设备，请检查浏览器支持或设备连接');
                            }
                        } else {
                            // 禁用MIDI
                            window.midiState.enabled = false;
                            
                            // 断开所有MIDI输入设备
                            disconnectMIDIDevices();
                        }
                    });
                }

                // CAGED练习类型固定为音阶练习，无需事件监听器

                // CAGED形状选择按钮
                const cagedShapeBtns = document.querySelectorAll('.caged-shape-btn');
                cagedShapeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        const shape = this.dataset.shape;
                        if (this.classList.contains('active')) {
                            if (!window.cagedState.selectedShapes.includes(shape)) {
                                window.cagedState.selectedShapes.push(shape);
                            }
                        } else {
                            window.cagedState.selectedShapes = window.cagedState.selectedShapes.filter(s => s !== shape);
                        }
                        // 更新当前形状
                        if (window.cagedState.selectedShapes.length > 0) {
                            window.cagedState.currentShape = window.cagedState.selectedShapes[0];
                        }
                    });
                });

                // CAGED练习模式按钮
                const cagedModeBtns = document.querySelectorAll('.caged-mode-btn');
                cagedModeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        cagedModeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        window.cagedState.practiceMode = this.dataset.mode;
                    });
                });

                
                // 练习界面中的CAGED形状按钮点击事件（手动切换形状）
                const practiceShapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                practiceShapeButtons.forEach(btn => {
                    btn.addEventListener('click', function(event) {
                        // 阻止事件冒泡，防止触发练习屏幕的退出事件
                        event.stopPropagation();
                        event.preventDefault();
                        
                        const targetShape = this.dataset.shape;
                        
                        // 检查是否是选中的形状且不是当前形状
                        if (window.cagedState.selectedShapes.includes(targetShape) && 
                            targetShape !== window.cagedState.currentShape) {
                            
                            console.log(`手动切换CAGED形状: ${window.cagedState.currentShape} → ${targetShape}`);
                            
                            // 标记为手动切换，保持当前音阶类型
                            window.cagedState.isManualSwitch = true;
                            
                            // 更新当前形状
                            window.cagedState.currentShape = targetShape;
                            
                            // 更新按钮状态
                            updateCagedShapeButtons();
                            
                            // 重新生成当前形状的练习
                            generateCagedExercise();
                            
                            // 重置手动切换标记
                            window.cagedState.isManualSwitch = false;
                        }
                    });
                });
            }

            // 初始化应用
            function initApp() {
                if (typeof Pitchfinder === 'undefined') {
                    console.error('PitchFinder库加载失败，请检查网络连接');
                    alert('音高检测库加载失败，请检查网络连接后刷新页面');
                } else {
                    console.log('PitchFinder库加载成功');
                }

                // 获取音频设备列表
                getAudioDevices();

                initEventListeners();
                initCagedEventListeners();
                initKeyboardShortcuts();
                
                // 初始化自定义下拉列表
                if (typeof window.initCustomDropdown === 'function') {
                    window.initCustomDropdown();
                } else {
                    console.error('initCustomDropdown函数未定义');
                }
                
                // 初始化乐曲下拉列表
                if (typeof window.initJazzStandardDropdown === 'function') {
                    window.initJazzStandardDropdown();
                } else {
                    console.error('initJazzStandardDropdown函数未定义');
                }
                
                // 初始化调性下拉列表
                if (typeof window.initProgressionKeyDropdown === 'function') {
                    window.initProgressionKeyDropdown();
                } else {
                    console.error('initProgressionKeyDropdown函数未定义');
                }
                
                requestRecordPermission();
            }

            // 初始化键盘快捷键
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && practiceScreen.style.display === 'flex') {
                        practiceScreen.click();
                    }

                    if ((e.key === ' ' || e.key === 'ArrowRight') && practiceScreen.style.display === 'flex') {
                        // 阻止默认行为
                        e.preventDefault();
                        
                        // 检查当前练习模式
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            // 找音练习模式
                            const practiceMode = document.querySelector('.practice-mode-btn.active');
                            if (practiceMode && practiceMode.dataset.mode === 'interval') {
                                // 音程练习模式：直接调用函数
                                console.log('音程练习下一题触发');
                                // 使用window对象访问函数
                                if (window.generateNextIntervalExercise) {
                                    window.generateNextIntervalExercise();
                                } else {
                                    console.log('generateNextIntervalExercise函数未找到');
                                }
                            } else {
                                // 单音练习模式：生成下一题单音练习
                                console.log('单音练习下一题触发');
                                if (typeof generateNextPitchFindingQuestion === 'function') {
                                    generateNextPitchFindingQuestion();
                                }
                            }
                        } else {
                            // 其他练习模式：生成下一题
                            console.log('其他练习模式下一题触发');
                        generateExercise();
                        }
                    }
                    
                    // 向上键：显示指板
                    if (e.key === 'ArrowUp' && practiceScreen.style.display === 'flex') {
                        e.preventDefault();
                        
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            console.log('显示指板');
                            showFretboardForPractice();
                        }
                    }
                    
                    // 向下键：隐藏指板
                    if (e.key === 'ArrowDown' && practiceScreen.style.display === 'flex') {
                        e.preventDefault();
                        
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            console.log('隐藏指板');
                            hideFretboardForPractice();
                        }
                    }
                });
            }

            // 更新状态指示器
            function updateStatusIndicator(status, type = 'ready') {
                statusIndicator.textContent = status;
                statusIndicator.className = `status-indicator status-${type}`;
            }
            
            // 应用翻译
            function applyTranslations() {
                if (typeof window.t !== 'function') {
                    return;
                }
                
                // 更新页面标题
                document.title = window.t('page_title');
                
                // 使用data-i18n-key属性翻译所有元素
                const elementsWithI18n = document.querySelectorAll('[data-i18n-key]');
                elementsWithI18n.forEach(element => {
                    const key = element.getAttribute('data-i18n-key');
                    const translation = window.t(key);
                    if (translation && translation !== key) {
                        // 对于optgroup元素，更新label属性
                        if (element.tagName === 'OPTGROUP') {
                            element.setAttribute('label', translation);
                        } else {
                        element.textContent = translation;
                        }
                    }
                });
            }
            
            // 缓存DOM元素引用
            let langZhBtn, langEnBtn;
            
            // 初始化语言切换按钮
            function initLanguageButtons() {
                langZhBtn = document.getElementById('langZhBtn');
                langEnBtn = document.getElementById('langEnBtn');
                
                if (langZhBtn) {
                    langZhBtn.addEventListener('click', function () {
                        if (typeof window.switchLanguage === 'function') {
                            const success = window.switchLanguage('zh-CN');
                            if (success) {
                                updateLanguageButtons();
                                applyTranslations();
                            }
                        }
                    });
                }
                
                if (langEnBtn) {
                    langEnBtn.addEventListener('click', function () {
                        if (typeof window.switchLanguage === 'function') {
                            const success = window.switchLanguage('en');
                            if (success) {
                                updateLanguageButtons();
                                applyTranslations();
                            }
                        }
                    });
                }
                
                // 更新语言按钮状态
                updateLanguageButtons();
            }
            
            // 更新语言按钮状态
            function updateLanguageButtons() {
                if (langZhBtn && langEnBtn) {
                    // 移除所有按钮的active状态
                    langZhBtn.classList.remove('active');
                    langEnBtn.classList.remove('active');
                    
                    // 根据当前语言设置active状态
                    const currentLang = window.getCurrentLanguage();
                    if (currentLang === 'zh-CN') {
                        langZhBtn.classList.add('active');
                    } else if (currentLang === 'en') {
                        langEnBtn.classList.add('active');
                    }
                }
            }

            // 自定义和弦功能 - 已改为弹窗设计，这些元素不再需要
            // 所有自定义和弦功能现在通过 initCustomChordsDialog 函数处理

            // 更新自定义和弦类型下拉框显示
            function updateCustomChordTypeDisplay() {
                // 由于改为弹窗设计，这个函数现在不需要更新下拉框
                // 和弦类型选择现在通过全屏选择器处理
                    return;
                }

            // 旧的自定义和弦代码已删除，现在使用弹窗设计

            // 旧的自定义和弦代码已删除，现在使用弹窗设计

            // 旧的自定义和弦代码已删除，现在使用弹窗设计
            // 旧的自定义和弦代码已删除，现在使用弹窗设计

            // 修改generateChordExercise函数以支持自定义和弦
            function originalGenerateChordExercise() {
                try {
                    // 清除之前的状态信息，确保从当前选中的和弦类型生成
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // 清除之前的和弦类型
                    
                    let rootNote = chordRootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    state.rootNote = rootNote;

                    const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                    let chordType = 'major';
                    if (activeChordTypes.length > 0) {
                        const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                        chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                    } else {
                        // 如果没有选中任何和弦类型，不生成默认和弦，而是直接返回空值
                        console.warn('没有选中任何和弦类型，无法生成下一题');
                        return; // 不生成下一题
                    }
                    state.chordType = chordType;

                    // 检查和弦类型是否存在
                    if (!chordTypes[chordType]) {
                        throw new Error(`未知的和弦类型: ${chordType}`);
                    }

                    state.currentIntervals = [...chordTypes[chordType].intervals];

                    // 处理转位和弦
                    const bassNoteSelect = document.getElementById('chordBassNote');
                    if (bassNoteSelect) {
                        const bassNote = bassNoteSelect.value;
                        if (bassNote !== 'root') {
                            state.currentIntervals = applyChordInversion(state.currentIntervals, bassNote);
                        }
                    }

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // 下行模式：倒序排列
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    // 获取转位和弦名称
                    const bassNote = bassNoteSelect ? bassNoteSelect.value : 'root';
                    const chordSymbol = getInversionChordName(rootNote, chordType, bassNote);
                    // 只显示和弦名称，不显示音级结构
                    targetIntervalEl.textContent = chordSymbol;
                    targetIntervalEl.innerHTML = chordSymbol; // 确保只显示和弦名称
                    displaySequence();
                    
                    // 预生成下一题
                    generateNextExercise();
                } catch (error) {
                    console.error('生成和弦练习失败:', error);
                    updateStatusIndicator('和弦练习生成失败: ' + error.message, 'error');
                    // 回退到默认和弦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // 生成和弦转换练习
            function generateProgressionExercise() {
                resetCagedModeState();
                
                const jazzStandardEl = document.getElementById('jazzStandard');
                const progressionKeyEl = document.getElementById('progressionKey');
                const progressionLevelEl = document.getElementById('progressionLevel');
                const enableRepeatEl = document.getElementById('enableRepeat');
                const songTitleEl = document.getElementById('songTitle');
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                // useCustomChords 开关已移除，现在完全基于 state.isCustomChordMode 状态
                
                // 根据自定义和弦模式状态决定练习类型
                if (state.isCustomChordMode) {
                    // 自定义和弦模式：使用自定义和弦序列
                    console.log('使用自定义和弦模式');
                } else {
                    // 非自定义和弦模式：清空自定义和弦状态，使用歌曲练习
                    console.log('使用歌曲练习模式');
                    window.customChordSequence = [];
                    state.progressionChords = null;
                    state.progressionSong = null;
                    state.progressionOrder = null;
                    state.progressionKey = null;
                    state.progressionLevel = null;
                    state.progressionIndex = 0;
                }
                
                // 检查是否使用自定义和弦进行
                if (state.isCustomChordMode && window.customChordSequence && window.customChordSequence.length > 0) {
                    // 使用自定义和弦进行
                    const sequenceName = document.getElementById('sequenceName').value || '自定义和弦进行';
                    songTitleEl.textContent = sequenceName;
                    songTitleDisplayEl.style.display = 'block';
                    
                    // 将自定义和弦序列转换为和弦符号
                    const chords = window.customChordSequence.map(chord => {
                        const root = chord.root;
                        const type = chord.type;
                        const bass = chord.bass;
                        
                        // 根据和弦类型生成符号
                        let chordSymbol = root;
                        if (type === 'minor') chordSymbol += 'm';
                        else if (type === 'diminished') chordSymbol += 'dim';
                        else if (type === 'augmented') chordSymbol += 'aug';
                        else if (type === 'major6') chordSymbol += '6';
                        else if (type === 'minor6') chordSymbol += 'm6';
                        else if (type === 'dominant7') chordSymbol += '7';
                        else if (type === 'major7') chordSymbol += 'Maj7';
                        else if (type === 'minor7') chordSymbol += 'm7';
                        else if (type === 'minor7b5') chordSymbol += 'm7♭5';
                        else if (type === 'diminished7') chordSymbol += 'dim7';
                        else if (type === 'dominant9') chordSymbol += '9';
                        else if (type === 'major9') chordSymbol += 'Maj9';
                        else if (type === 'minor9') chordSymbol += 'm9';
                        else if (type === 'dominant7sharp9') chordSymbol += '7♯9';
                        else if (type === 'dominant7flat9') chordSymbol += '7♭9';
                        else if (type === 'dominant11') chordSymbol += '11';
                        else if (type === 'minor11') chordSymbol += 'm11';
                        else if (type === 'dominant7sharp11') chordSymbol += '7♯11';
                        else if (type === 'dominant13') chordSymbol += '13';
                        else if (type === 'minor13') chordSymbol += 'm13';
                        else if (type === 'sus2') chordSymbol += 'sus2';
                        else if (type === 'sus4') chordSymbol += 'sus4';
                        else if (type === 'add9') chordSymbol += 'add9';
                        else if (type === 'madd9') chordSymbol += 'madd9';
                        else if (type === '6add9') chordSymbol += '6add9';
                        else if (type === 'm6add9') chordSymbol += 'm6add9';
                        
                        // 添加转位信息
                        if (bass !== 'root') {
                            if (bass === '3rd') chordSymbol += '/3';
                            else if (bass === '5th') chordSymbol += '/5';
                            else if (bass === '7th') chordSymbol += '/7';
                        }
                        
                        return chordSymbol;
                    });
                    
                    // 应用和弦进行的顺序设置
                    const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                    
                    let finalChords = [...chords];
                    if (order === 'reverse') {
                        finalChords = finalChords.reverse();
                    } else if (order === 'random') {
                        // 打乱和弦顺序
                        for (let i = finalChords.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [finalChords[i], finalChords[j]] = [finalChords[j], finalChords[i]];
                        }
                    }
                    
                    // 初始化或重置和弦进行索引
                    const currentOrderBtn = document.querySelector('.progression-order-btn.active');
                    const currentOrder = currentOrderBtn ? currentOrderBtn.dataset.value : 'ordered';
                    const currentLevel = progressionLevelEl.value;
                    
                    if (!state.progressionChords || 
                        state.progressionSong !== sequenceName ||
                        state.progressionOrder !== currentOrder ||
                        state.progressionLevel !== currentLevel) {
                        
                        state.progressionChords = finalChords;
                        state.progressionSong = sequenceName;
                        state.progressionOrder = currentOrder;
                        state.progressionLevel = currentLevel;
                        state.progressionIndex = 0;
                    }
                    
                    // 每次开始新的练习会话时，都从第一个和弦开始
                    if (!state.isInProgressionSession) {
                        state.progressionIndex = 0;
                        state.isInProgressionSession = true;
                    }
                    
                    // 生成当前和弦的练习
                    generateCurrentProgressionChord();
                    return;
                }
                
                const selectedSong = jazzStandardEl.value;
                if (!selectedSong) {
                    alert('请选择一首歌曲');
                    return;
                }

                // 显示乐曲名
                songTitleEl.textContent = selectedSong;
                songTitleDisplayEl.style.display = 'block';

                // 获取歌曲和弦进行数据
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][selectedSong]) {
                        songData = jazzStandards[letter][selectedSong];
                        break;
                    }
                }

                if (!songData) {
                    alert('找不到歌曲和弦进行');
                    return;
                }

                // 获取原调和音级和弦进行
                const originalKey = songData.key;
                let chords = [];

                // 检查是否是练习曲目
                if (selectedSong.includes('练习') && selectedSong.includes('个调')) {
                    console.log('检测到练习曲目，生成和弦循环');

                    const circleOfFifthsReverse = ['A', 'D', 'G', 'C', 'F', 'B♭', 'E♭', 'A♭', 'D♭', 'G♭', 'B', 'E'];

                    if (selectedSong.includes('Maj7') && !selectedSong.includes('#11') && !selectedSong.includes('#5')) {
                        // Maj7和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}Maj7`);
                    } else if (selectedSong.includes('Min7') && !selectedSong.includes('b5') && !selectedSong.includes('Maj7')) {
                        // Min7和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}m7`);
                    } else if (selectedSong.includes('Sus4b9')) {
                        // Sus4b9和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}sus4(b9)`);
                    } else if (selectedSong.includes('Maj7#11')) {
                        // Maj7#11和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}Maj7(#11)`);
                    } else if (selectedSong.includes('7sus4') && !selectedSong.includes('b9') && !selectedSong.includes('13')) {
                        // 7sus4和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}7sus4`);
                    } else if (selectedSong.includes('Dom7')) {
                        // Dom7和弦练习（7和弦）
                        chords = circleOfFifthsReverse.map(key => `${key}7`);
                    } else if (selectedSong.includes('Min7b5') && !selectedSong.includes('♮9')) {
                        // Min7b5和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}m7(b5)`);
                    } else if (selectedSong.includes('MinMaj7')) {
                        // MinMaj7和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}m(Maj7)`);
                    } else if (selectedSong.includes('13sus4b9')) {
                        // 13sus4b9和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}13sus4(b9)`);
                    } else if (selectedSong.includes('Maj7#5')) {
                        // Maj7#5和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}Maj7(#5)`);
                    } else if (selectedSong.includes('7#11') && !selectedSong.includes('13')) {
                        // 7#11和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}7(#11)`);
                    } else if (selectedSong.includes('Min7b5♮9')) {
                        // Min7b5♮9和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}m7(b5,♮9)`);
                    } else if (selectedSong.includes('13b9')) {
                        // 13b9和弦练习
                        chords = circleOfFifthsReverse.map(key => `${key}13(b9)`);
                    }

                    console.log(`生成的${selectedSong}和弦循环：`, chords);

                } else {
                    // 普通歌曲处理
                    const degreeChords = [...songData.chords];
                    const selectedKey = progressionKeyEl.value;

                    // 移调到目标调
                    chords = degreeChords.map(degreeChord =>
                        transposeChordFromDegree(degreeChord, originalKey, selectedKey)
                    );
                }

    
                // 显示调性转换信息（调试用）
                if (selectedSong.includes('练习') && selectedSong.includes('个调')) {
                    console.log(`练习曲目：${selectedSong}`);
                    console.log(`和弦循环：`, chords);
                } else {
                    const keyInfo = selectedKey === originalKey ?
                        `原调：${originalKey}` :
                        `${originalKey} → ${selectedKey}`;
                    console.log(`歌曲：${selectedSong}`);
                    console.log(`调性转换：${keyInfo}`);
                    console.log(`音级和弦：`, songData.chords);
                    console.log(`转换后和弦：`, chords);
                }

                // 应用和弦进行的顺序设置（顺序按钮控制整个和弦进行的顺序）
                const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                
                if (order === 'reverse') {
                    chords = chords.reverse();
                } else if (order === 'random') {
                    // 打乱和弦顺序
                    for (let i = chords.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [chords[i], chords[j]] = [chords[j], chords[i]];
                    }
                }

                // 初始化或重置和弦进行索引（当歌曲或设置改变时）
                const currentOrderBtn = document.querySelector('.progression-order-btn.active');
                const currentOrder = currentOrderBtn ? currentOrderBtn.dataset.value : 'ordered';
                const currentKey = progressionKeyEl.value;
                const currentLevel = progressionLevelEl.value;
                
                // 只有在歌曲、顺序、调性或等级改变时才重置，否则保持当前进度
                if (!state.progressionChords || 
                    state.progressionSong !== selectedSong ||
                    state.progressionOrder !== currentOrder ||
                    state.progressionKey !== currentKey ||
                    state.progressionLevel !== currentLevel) {
                    
                    state.progressionChords = chords;
                    state.progressionSong = selectedSong;
                    state.progressionOrder = currentOrder;
                    state.progressionKey = currentKey;
                    state.progressionLevel = currentLevel;
                    state.progressionIndex = 0; // 重新开始
                }
                
                // 每次开始新的练习会话时，都从第一个和弦开始
                if (!state.isInProgressionSession) {
                    state.progressionIndex = 0;
                    state.isInProgressionSession = true;
                }

                // 检查是否已完成所有和弦
                if (state.progressionIndex >= chords.length) {
                    const isRepeatEnabled = enableRepeatEl.checked;
                    if (isRepeatEnabled) {
                        state.progressionIndex = 0; // 重新开始
                    } else {
                        // 重置自定义和弦模式状态（退出练习时立即重置）
                        state.isCustomChordMode = false;
                        console.log('自定义和弦练习完成退出 - 重置 state.isCustomChordMode = false');
                        
                        // 清空自定义和弦相关状态
                        // useCustomChords 开关已移除
                        
                        // 清空全局自定义和弦序列
                        window.customChordSequence = [];
                        console.log('练习完成 - 清空自定义和弦序列');
                        
                        // 清空和弦进行状态
                        state.progressionChords = null;
                        state.progressionSong = null;
                        state.progressionOrder = null;
                        state.progressionKey = null;
                        state.progressionLevel = null;
                        state.progressionIndex = 0;
                        
                        // 直接退出练习界面，不弹出提示窗口
                        stopRecording();
                        stopMetronome();
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        updateStatusIndicator('练习已完成', 'ready');

                        // 重置所有练习模式状态
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;
                        state.isInProgressionSession = false;
                        return;
                    }
                }

                const currentChord = chords[state.progressionIndex];
                
                // 将音级符号转换为实际的和弦名称
                let actualChord = currentChord;
                if (currentChord.match(/^[IVX]+[mM]?[0-9♭♯]*/)) {
                    // 这是一个音级符号，需要转换为实际和弦
                    const songData = jazzStandards[state.progressionKey][state.progressionSong];
                    const keyRoot = songData.key;
                    actualChord = transposeChordFromDegree(currentChord, keyRoot, keyRoot);
                }
                
                const { root, type } = parseChordSymbol(actualChord);

                state.rootNote = root;
                state.chordType = type;

                // 根据练习等级生成音程
                const level = progressionLevelEl.value;
                let intervals = getIntervalsForLevel(level, type);
                
                // 如果选择了"全部"选项，则使用和弦的所有音程
                if (level === 'all-notes') {
                    // 获取和弦类型对应的完整音程
                    if (chordTypes[type]) {
                        intervals = [...chordTypes[type].intervals];
                        
                        // 根据顺序设置调整音程顺序
                        const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                        
                        if (order === 'reverse') {
                            // 倒序
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            // 随机
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }
                        // 如果是顺序(ordered)，保持原顺序
                    } else {
                        // 如果无法获取和弦类型信息，回退到默认设置
                        intervals = ['1', '3', '5'];
                    }
                }

                state.currentIntervals = intervals;
                // 只显示和弦名称，不显示音级结构
                targetIntervalEl.textContent = currentChord;
                targetIntervalEl.innerHTML = currentChord; // 确保只显示和弦名称，不显示音级结构
                displaySequence();

                // 准备下一个和弦（保持相同的顺序）
                const nextIndex = (state.progressionIndex + 1) % chords.length;
                const isRepeatEnabled = enableRepeatEl.checked;
                
                if (isRepeatEnabled || nextIndex !== 0) {
                    const nextChord = chords[nextIndex];
                    state.nextExerciseInfo = nextChord; // 只显示和弦名
                    
                    // 为下一个和弦生成音程
                    const level = progressionLevelEl.value;
                        const { root: nextRoot, type: nextType } = parseChordSymbol(nextChord);
                    
                    if (level === 'all-notes') {
                        // 对于"全部"选项，使用和弦的完整音程
                        if (chordTypes[nextType]) {
                            let nextIntervals = [...chordTypes[nextType].intervals];
                            
                            // 根据顺序设置调整音程顺序
                            const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                            const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                            
                            if (order === 'reverse') {
                                // 倒序
                                nextIntervals = nextIntervals.reverse();
                            } else if (order === 'random') {
                                // 随机
                                for (let i = nextIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [nextIntervals[i], nextIntervals[j]] = [nextIntervals[j], nextIntervals[i]];
                                }
                            }
                            // 如果是顺序(ordered)，保持原顺序
                            
                            state.nextExerciseIntervals = nextIntervals;
                        } else {
                            // 如果无法获取和弦类型信息，回退到默认设置
                            state.nextExerciseIntervals = getIntervalsForLevel(level);
                        }
                    } else {
                        // 对于非"全部"级别，使用getIntervalsForLevel并传入和弦类型
                        state.nextExerciseIntervals = getIntervalsForLevel(level, nextType);
                    }
                } else {
                    state.nextExerciseInfo = '练习完成';
                    state.nextExerciseIntervals = [];
                }
                
                // 更新下一题显示
                updateNextExerciseDisplay();

                // 更新索引准备下一题
                // 修复：只有在成功显示当前和弦后才递增索引
                // 这样可以确保第一次调用时显示第一个和弦
                if (state.progressionIndex < chords.length) {
                    state.progressionIndex++;
                }
            }
            
            // 生成当前和弦进行练习
            function generateCurrentProgressionChord() {
                if (!state.progressionChords || state.progressionChords.length === 0) {
                    console.error('没有可用的和弦进行数据');
                    return;
                }
                
                const progressionLevelEl = document.getElementById('progressionLevel');
                const enableRepeatEl = document.getElementById('enableRepeat');
                const targetIntervalEl = document.getElementById('targetInterval');
                
                // 检查是否已完成所有和弦
                if (state.progressionIndex >= state.progressionChords.length) {
                    const isRepeatEnabled = enableRepeatEl.checked;
                    if (isRepeatEnabled) {
                        state.progressionIndex = 0; // 重新开始
                    } else {
                        // 重置自定义和弦模式状态（退出练习时立即重置）
                        state.isCustomChordMode = false;
                        console.log('自定义和弦练习完成退出 - 重置 state.isCustomChordMode = false');
                        
                        // 清空自定义和弦相关状态
                        // useCustomChords 开关已移除
                        
                        // 清空全局自定义和弦序列
                        window.customChordSequence = [];
                        console.log('练习完成 - 清空自定义和弦序列');
                        
                        // 清空和弦进行状态
                        state.progressionChords = null;
                        state.progressionSong = null;
                        state.progressionOrder = null;
                        state.progressionKey = null;
                        state.progressionLevel = null;
                        state.progressionIndex = 0;
                        
                        // 直接退出练习界面，不弹出提示窗口
                        stopRecording();
                        stopMetronome();
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        updateStatusIndicator('练习已完成', 'ready');

                        // 重置所有练习模式状态
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;
                        state.isInProgressionSession = false;
                        return;
                    }
                }

                const currentChord = state.progressionChords[state.progressionIndex];
                const { root, type } = parseChordSymbol(currentChord);

                state.rootNote = root;
                state.chordType = type;

                // 根据练习等级生成音程
                const level = progressionLevelEl.value;
                let intervals = getIntervalsForLevel(level, type);
                
                // 如果选择了"全部"选项，则使用和弦的所有音程
                if (level === 'all-notes') {
                    // 获取和弦类型对应的完整音程
                    if (chordTypes[type]) {
                        intervals = [...chordTypes[type].intervals];
                        
                        // 根据顺序设置调整音程顺序
                        const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                        
                        if (order === 'reverse') {
                            // 倒序
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            // 随机
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }
                        // 如果是顺序(ordered)，保持原顺序
                    } else {
                        // 如果无法获取和弦类型信息，回退到默认设置
                        intervals = ['1', '3', '5'];
                    }
                }

                state.currentIntervals = intervals;
                // 只显示和弦名称，不显示音级结构
                targetIntervalEl.textContent = currentChord;
                targetIntervalEl.innerHTML = currentChord; // 确保只显示和弦名称，不显示音级结构
                displaySequence();

                // 准备下一个和弦（保持相同的顺序）
                const nextIndex = (state.progressionIndex + 1) % state.progressionChords.length;
                if (nextIndex < state.progressionChords.length) {
                    const nextChord = state.progressionChords[nextIndex];
                    const { root: nextRoot, type: nextType } = parseChordSymbol(nextChord);
                    
                    state.nextExerciseInfo = nextChord;
                    
                    // 根据练习等级生成下一题的音程
                    const level = progressionLevelEl.value;
                    if (level === 'all-notes') {
                        // 对于"全部"选项，使用和弦的完整音程
                        if (chordTypes[nextType]) {
                            let nextIntervals = [...chordTypes[nextType].intervals];
                            
                            // 根据顺序设置调整音程顺序
                            const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                            const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                            
                            if (order === 'reverse') {
                                // 倒序
                                nextIntervals = nextIntervals.reverse();
                            } else if (order === 'random') {
                                // 随机
                                for (let i = nextIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [nextIntervals[i], nextIntervals[j]] = [nextIntervals[j], nextIntervals[i]];
                                }
                            }
                            // 如果是顺序(ordered)，保持原顺序
                            
                            state.nextExerciseIntervals = nextIntervals;
                        } else {
                            // 如果无法获取和弦类型信息，回退到默认设置
                            state.nextExerciseIntervals = getIntervalsForLevel(level);
                        }
                    } else {
                        // 对于非"全部"级别，使用getIntervalsForLevel并传入和弦类型
                        state.nextExerciseIntervals = getIntervalsForLevel(level, nextType);
                    }
                } else {
                    state.nextExerciseInfo = '练习完成';
                    state.nextExerciseIntervals = [];
                }
                
                // 更新下一题显示
                updateNextExerciseDisplay();

                // 更新索引准备下一题
                // 修复：只有在成功显示当前和弦后才递增索引
                // 这样可以确保第一次调用时显示第一个和弦
                if (state.progressionIndex < state.progressionChords.length) {
                    state.progressionIndex++;
                }
            }
            
            // 根据练习等级获取对应的音程
            // 根据和弦类型调整音程的函数
            function adjustIntervalsForChordType(intervals, chordType) {
                if (!chordTypes[chordType]) {
                    return intervals;
                }
                
                const chordIntervals = chordTypes[chordType].intervals;
                const adjustedIntervals = [];
                
                for (const interval of intervals) {
                    if (chordIntervals.includes(interval)) {
                        // 如果和弦包含这个音程，直接使用
                        adjustedIntervals.push(interval);
                    } else {
                        // 如果和弦不包含这个音程，寻找替代
                        let replacement = null;
                        
                        switch (interval) {
                            case '3':
                                // 3度音程的替代
                                if (chordIntervals.includes('2')) {
                                    replacement = '2'; // sus2和弦用2替代3
                                } else if (chordIntervals.includes('4')) {
                                    replacement = '4'; // sus4和弦用4替代3
                                } else if (chordIntervals.includes('♭3')) {
                                    replacement = '♭3'; // 小和弦用♭3替代3
                                }
                                break;
                            case '♭3':
                                // ♭3度音程的替代
                                if (chordIntervals.includes('2')) {
                                    replacement = '2'; // sus2和弦用2替代♭3
                                } else if (chordIntervals.includes('4')) {
                                    replacement = '4'; // sus4和弦用4替代♭3
                                } else if (chordIntervals.includes('3')) {
                                    replacement = '3'; // 大和弦用3替代♭3
                                }
                                break;
                            case '7':
                                // 7度音程的替代
                                if (chordIntervals.includes('6')) {
                                    replacement = '6'; // 6和弦用6替代7
                                } else if (chordIntervals.includes('♭7')) {
                                    replacement = '♭7'; // 小7和弦用♭7替代7
                                }
                                break;
                            case '♭7':
                                // ♭7度音程的替代
                                if (chordIntervals.includes('6')) {
                                    replacement = '6'; // 6和弦用6替代♭7
                                } else if (chordIntervals.includes('7')) {
                                    replacement = '7'; // 大7和弦用7替代♭7
                                }
                                break;
                            case '5':
                                // 5度音程的替代
                                if (chordIntervals.includes('♭5')) {
                                    replacement = '♭5'; // 减和弦用♭5替代5
                                } else if (chordIntervals.includes('♯5')) {
                                    replacement = '♯5'; // 增和弦用♯5替代5
                                }
                                break;
                            case '♭5':
                                // ♭5度音程的替代
                                if (chordIntervals.includes('5')) {
                                    replacement = '5'; // 大三和弦用5替代♭5
                                } else if (chordIntervals.includes('♯5')) {
                                    replacement = '♯5'; // 增和弦用♯5替代♭5
                                }
                                break;
                            case '♯5':
                                // ♯5度音程的替代
                                if (chordIntervals.includes('5')) {
                                    replacement = '5'; // 大三和弦用5替代♯5
                                } else if (chordIntervals.includes('♭5')) {
                                    replacement = '♭5'; // 减和弦用♭5替代♯5
                                }
                                break;
                        }
                        
                        if (replacement && chordIntervals.includes(replacement)) {
                            adjustedIntervals.push(replacement);
                        } else {
                            // 如果找不到合适的替代，对于7音和♭7音，直接跳过不显示
                            if (interval === '7' || interval === '♭7') {
                                // 对于没有7音的和弦，不显示7音
                                // 不添加任何音程，直接跳过
                            } else {
                                // 对于其他音程，尝试使用和弦中存在的音程
                            const availableIntervals = chordIntervals.filter(i => i !== '1');
                            if (availableIntervals.length > 0) {
                                adjustedIntervals.push(availableIntervals[0]);
                                }
                            }
                        }
                    }
                }
                
                return adjustedIntervals;
            }

            // 旋律结构1的音程映射函数
            function getMelodicStructure1Intervals(chordType) {
                // 根据和弦类型映射到不同的结构
                // 描述：大调和弦/属七和弦: 1,2,3,5；小三和弦: 1,3,4,5；挂留和弦: 1,2,4,5；减和弦: 1,2,3,5（属七和弦不含变化五音）

                if (!chordType) {
                    // 默认返回大调和弦结构
                    return ['1', '2', '3', '5'];
                }

                // 判断和弦类型类别
                if (chordType === 'major' || chordType === 'major7' || chordType === 'major9' ||
                    chordType === 'dominant7' || chordType === 'dominant9' || chordType === 'dominant13' ||
                    chordType === 'dominant7b5' || chordType === 'dominant7#5' || chordType === 'dominant9b5' ||
                    chordType === 'augmented' || chordType === 'augmented7') {
                    // 大调和弦/属七和弦: 1,2,3,5 (注意：描述中说属七和弦不含变化五音，所以这里用纯五度)
                    return ['1', '2', '3', '5'];

                } else if (chordType === 'minor' || chordType === 'minor7' || chordType === 'minor9' ||
                          chordType === 'minor11' || chordType === 'minor6' || chordType === 'minMaj7') {
                    // 小三和弦: 1,3,4,5
                    return ['1', '3', '4', '5'];

                } else if (chordType === 'sus4' || chordType === 'sus2' || chordType === 'sus4b9' ||
                          chordType === 'sus4b9b13' || chordType === '7sus4' || chordType === '7sus2' ||
                          chordType === 'sus4add3' || chordType === 'sus2add3') {
                    // 挂留和弦: 1,2,4,5
                    return ['1', '2', '4', '5'];

                } else if (chordType === 'dim' || chordType === 'dim7' || chordType === 'minor7b5' ||
                          chordType === 'diminished' || chordType === 'diminished7' || chordType === 'halfDiminished') {
                    // 减和弦: 1,2,3,5
                    return ['1', '2', '3', '5'];

                } else {
                    // 其他和弦类型默认使用大调和弦结构
                    return ['1', '2', '3', '5'];
                }
            }

            function getIntervalsForLevel(level, chordType = null) {
                let intervals = [];
                
                switch (level) {
                    // 单和弦音
                    case 'single-root':
                        intervals = ['1'];
                        break;
                    case 'single-3':
                        intervals = ['3'];
                        break;
                    case 'single-5':
                        intervals = ['5'];
                        break;
                    case 'single-7':
                        intervals = ['7'];
                        break;
                    
                    // 双和弦音
                    case 'double-root-3':
                        intervals = ['1', '3'];
                        break;
                    case 'double-root-5':
                        intervals = ['1', '5'];
                        break;
                    case 'double-root-7':
                        intervals = ['1', '7'];
                        break;
                    case 'double-3-5':
                        intervals = ['3', '5'];
                        break;
                    case 'double-3-7':
                        intervals = ['3', '7'];
                        break;
                    case 'double-5-7':
                        intervals = ['5', '7'];
                        break;
                    
                    // 三和弦音
                    case 'triple-root-3-5':
                        intervals = ['1', '3', '5'];
                        break;
                    case 'triple-3-5-7':
                        intervals = ['3', '5', '7'];
                        break;
                    case 'triple-random-inversion':
                        // 1,3,5随机转位
                        const tripleInversions = [
                            ['1', '3', '5'], // 原位
                            ['3', '5', '1'], // 第一转位  
                            ['5', '1', '3']  // 第二转位
                        ];
                        intervals = tripleInversions[Math.floor(Math.random() * tripleInversions.length)];
                        break;
                    
                    // 四和弦音
                    case 'quad-root-3-5-7':
                        intervals = ['1', '3', '5', '7'];
                        break;
                    case 'quad-3-5-7-root':
                        intervals = ['3', '5', '7', '1'];
                        break;
                    case 'quad-5-7-root-3':
                        intervals = ['5', '7', '1', '3'];
                        break;
                    case 'quad-7-root-3-5':
                        intervals = ['7', '1', '3', '5'];
                        break;
                    case 'quad-random-inversion':
                        // 1,3,5,7随机转位
                        const quadInversions = [
                            ['1', '3', '5', '7'], // 原位
                            ['3', '5', '7', '1'], // 第一转位
                            ['5', '7', '1', '3'], // 第二转位
                            ['7', '1', '3', '5']  // 第三转位
                        ];
                        intervals = quadInversions[Math.floor(Math.random() * quadInversions.length)];
                        break;
                    case 'quad-root-3-5-7-root':
                        intervals = ['1', '3', '5', '7', '1'];
                        break;
                    
                    // 旋律结构 - R→5th
                    case 'melodic-r-3':
                        // 旋律结构1: 根据和弦类型映射到不同结构
                        intervals = getMelodicStructure1Intervals(chordType);
                        break;
                    case 'melodic-r-5':
                        intervals = ['1', '5'];
                        break;
                    case 'melodic-3-5':
                        intervals = ['3', '5'];
                        break;
                    case 'melodic-r-3-5':
                        intervals = ['1', '3', '5'];
                        break;
                    case 'melodic-random-inversions':
                        const melodicInversions = [
                            ['1', '3', '5'],
                            ['3', '5', '1'],
                            ['5', '1', '3']
                        ];
                        intervals = melodicInversions[Math.floor(Math.random() * melodicInversions.length)];
                        break;

                    // 全部和弦音
                    case 'all-notes':
                        // 这个选项会在调用处特殊处理，返回和弦的所有音符
                        // 这里返回空数组，表示需要使用和弦的完整音程
                        intervals = [];
                        break;

                    default:
                        intervals = ['1', '3', '5'];
                }
                
                // 如果提供了和弦类型，则根据和弦类型调整音程
                if (chordType) {
                    intervals = adjustIntervalsForChordType(intervals, chordType);
                }
                
                return intervals;
            }
            
            // 获取和弦的特定音级对应的音符
            function getChordTone(root, chordType, interval) {
                const noteIndex = notes.indexOf(root);
                if (noteIndex === -1) return null;
                
                let semitones = 0;
                
                // 根据音级和和弦类型计算半音数
                switch (interval) {
                    case '1':
                        semitones = 0; // 根音
                        break;
                    case '3':
                        // 三音：大三度或小三度
                        if (chordType === 'minor' || chordType === 'minor7' || chordType === 'minor6' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 3; // 小三度
                        } else {
                            semitones = 4; // 大三度
                        }
                        break;
                    case '5':
                        // 五音：纯五度或减五度
                        if (chordType === 'minor7b5') {
                            semitones = 6; // 减五度
                        } else {
                            semitones = 7; // 纯五度
                        }
                        break;
                    case '7':
                        // 七音：大七度或小七度
                        if (chordType === 'major7' || chordType === 'major9') {
                            semitones = 11; // 大七度
                        } else if (chordType === 'dominant7' || chordType === 'minor7' || chordType === 'dominant9' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 10; // 小七度
                        } else {
                            semitones = 11; // 默认大七度
                        }
                        break;
                    default:
                        semitones = 0;
                }
                
                const targetIndex = (noteIndex + semitones) % 12;
                return notes[targetIndex];
            }


            // 解析和弦符号

            // 提取音阶名称（不包含结构信息）
            function getScaleDisplayName(scaleName) {
                // 从完整名称中提取音阶名称，移除结构部分
                // 例如："Major" -> "Major"
                // 例如："Dorian - 1 2 ♭3 4 5 6 ♭7" -> "Dorian"
                // 例如："Diminished (Half-Whole) - 1 ♭2 ♭3 3 ♯4 5 6 ♭7" -> "Diminished"
                
                let displayName = scaleName;
                
                // 移除破折号及其后面的所有内容（音程结构）
                const dashIndex = displayName.indexOf(' - ');
                if (dashIndex !== -1) {
                    displayName = displayName.substring(0, dashIndex);
                }
                
                // 移除括号部分，如 (Half-Whole), (Whole-Half) 等
                displayName = displayName.replace(/\s*\([^)]*\)\s*/g, '');
                
                return displayName.trim();
            }

            // 获取和弦类型的显示名称
            function getChordTypeDisplayName(chordType) {
                const displayMode = state.chordNameDisplayMode || 'english';
                
                // 英文名称映射
                const englishNames = {
                    'major': 'Major',
                    'minor': 'Minor',
                    'diminished': 'Dim',
                    'augmented': 'Aug',
                    'major6': '6',
                    'minor6': 'm6',
                    'dominant7': '7',
                    'major7': 'Maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7♭5',
                    'diminished7': 'dim7',
                    'dominant9': '9',
                    'major9': 'Maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7♯9',
                    'dominant7flat9': '7♭9',
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7♯11',
                    'dominant13': '13',
                    'minor13': 'm13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                // 符号名称映射
                const symbolNames = {
                    'major': 'Major',
                    'minor': '-',
                    'diminished': '°',
                    'augmented': '+',
                    'major6': '6',
                    'minor6': '-6',
                    'dominant7': '7',
                    'major7': '∆7',
                    'minor7': '-7',
                    'minor7b5': 'ø7',
                    'diminished7': '°7',
                    'dominant9': '9',
                    'major9': '∆9',
                    'minor9': '-9',
                    'dominant7sharp9': '7♯9',
                    'dominant7flat9': '7♭9',
                    'dominant11': '11',
                    'minor11': '-11',
                    'dominant7sharp11': '7♯11',
                    'dominant13': '13',
                    'minor13': '-13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    'add9': 'add9',
                    'madd9': '-add9',
                    '6add9': '6add9',
                    'm6add9': '-6add9'
                };
                
                const nameMap = displayMode === 'symbols' ? symbolNames : englishNames;
                return nameMap[chordType] || chordType;
            }

            // 更新和弦类型按钮的显示文本
            function updateChordTypeButtonTexts() {
                const chordTypeBtns = document.querySelectorAll('.chord-type-btn');
                chordTypeBtns.forEach(btn => {
                    const chordType = btn.dataset.value;
                    btn.textContent = getChordTypeDisplayName(chordType);
                });
                
                // 更新自定义和弦下拉框显示
                updateCustomChordTypeDisplay();
            }

            // 将复合音程转换为单音程（用于显示和识别）
            function convertCompoundIntervals(intervals) {
                // 复合音程在八度内应该显示为对应的单音程
                const compoundToSimple = {
                    '9': '2',      // 九度 = 二度
                    '♯9': '♯2',    // 升九度 = 升二度
                    '♭9': '♭2',    // 降九度 = 降二度
                    '11': '4',     // 十一度 = 四度
                    '♯11': '♯4',   // 升十一度 = 升四度
                    '♭11': '♭4',   // 降十一度 = 降四度
                    '13': '6',     // 十三度 = 六度
                    '♯13': '♯6',   // 升十三度 = 升六度
                    '♭13': '♭6'    // 降十三度 = 降六度
                };
                
                return intervals.map(interval => {
                    return compoundToSimple[interval] || interval;
                });
            }

            // 应用和弦转位
            function applyChordInversion(intervals, bassNote) {
                if (bassNote === 'root') {
                    return intervals;
                }
                
                // 找到目标音程（支持变化音程）
                let targetInterval = null;
                let targetIndex = -1;
                
                if (bassNote === '3rd') {
                    // 查找三度音程（可能是3, ♭3, ♯3等）
                    for (let i = 0; i < intervals.length; i++) {
                        if (intervals[i].includes('3')) {
                            targetInterval = intervals[i];
                            targetIndex = i;
                            break;
                        }
                    }
                } else if (bassNote === '5th') {
                    // 查找五度音程（可能是5, ♭5, ♯5等）
                    for (let i = 0; i < intervals.length; i++) {
                        if (intervals[i].includes('5')) {
                            targetInterval = intervals[i];
                            targetIndex = i;
                            break;
                        }
                    }
                } else if (bassNote === '7th') {
                    // 查找七度音程（可能是7, ♭7, ♯7等）
                    for (let i = 0; i < intervals.length; i++) {
                        if (intervals[i].includes('7')) {
                            targetInterval = intervals[i];
                            targetIndex = i;
                            break;
                        }
                    }
                }
                
                if (!targetInterval || targetIndex === -1) {
                    return intervals;
                }
                
                // 创建新的音程数组，将目标音程移到前面
                const newIntervals = [...intervals];
                const targetIntervalValue = newIntervals.splice(targetIndex, 1)[0];
                newIntervals.unshift(targetIntervalValue);
                
                return newIntervals;
            }

            // 获取转位和弦的显示名称
            function getInversionChordName(rootNote, chordType, bassNote) {
                if (bassNote === 'root') {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // 获取和弦的音程结构
                const chordIntervals = chordTypes[chordType]?.intervals;
                if (!chordIntervals) {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // 找到目标音程
                let targetInterval = null;
                if (bassNote === '3rd') {
                    targetInterval = chordIntervals.find(interval => interval.includes('3'));
                } else if (bassNote === '5th') {
                    targetInterval = chordIntervals.find(interval => interval.includes('5'));
                } else if (bassNote === '7th') {
                    targetInterval = chordIntervals.find(interval => interval.includes('7'));
                }
                
                if (!targetInterval) {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // 计算低音音符的半音偏移
                const semitoneOffset = intervalToSemitones[targetInterval] || 0;
                
                // 计算低音音符
                const rootSemitones = noteToSemitones[rootNote] || 0;
                const bassSemitones = (rootSemitones + semitoneOffset) % 12;
                const bassNoteName = Object.keys(noteToSemitones).find(note => 
                    noteToSemitones[note] === bassSemitones
                );
                
                if (!bassNoteName) {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // 返回斜线和弦格式 (如 C/E)
                const chordSymbol = formatChordSymbol(rootNote, chordType);
                return `${chordSymbol}/${bassNoteName}`;
            }

            // 格式化和弦符号
            function formatChordSymbol(rootNote, chordType) {
                const displayMode = state.chordNameDisplayMode || 'english';
                
                // 英文名称映射
                const englishSuffixMap = {
                    // 基础三和弦
                    'major': '',
                    'minor': 'm',
                    'diminished': 'dim',
                    'augmented': 'aug',
                    
                    // 六和弦
                    'major6': '6',
                    'minor6': 'm6',
                    
                    // 七和弦
                    'dominant7': '7',
                    'major7': 'maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7♭5',
                    'diminished7': 'dim7',
                    
                    // 九和弦
                    'dominant9': '9',
                    'major9': 'maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7♯9',
                    'dominant7flat9': '7♭9',
                    
                    // 十一和弦
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7♯11',
                    
                    // 十三和弦
                    'dominant13': '13',
                    'minor13': 'm13',
                    
                    // 挂留和弦
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    
                    // 加音和弦
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                // 符号名称映射（用∆代替maj等）
                const symbolSuffixMap = {
                    // 基础三和弦
                    'major': '',
                    'minor': '-',
                    'diminished': '°',
                    'augmented': '+',
                    
                    // 六和弦
                    'major6': '6',
                    'minor6': '-6',
                    
                    // 七和弦
                    'dominant7': '7',
                    'major7': '∆7',
                    'minor7': '-7',
                    'minor7b5': 'ø7',
                    'diminished7': '°7',
                    
                    // 九和弦
                    'dominant9': '9',
                    'major9': '∆9',
                    'minor9': '-9',
                    'dominant7sharp9': '7♯9',
                    'dominant7flat9': '7♭9',
                    
                    // 十一和弦
                    'dominant11': '11',
                    'minor11': '-11',
                    'dominant7sharp11': '7♯11',
                    
                    // 十三和弦
                    'dominant13': '13',
                    'minor13': '-13',
                    
                    // 挂留和弦
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    
                    // 加音和弦
                    'add9': 'add9',
                    'madd9': '-add9',
                    '6add9': '6add9',
                    'm6add9': '-6add9'
                };
                
                const suffixMap = displayMode === 'symbols' ? symbolSuffixMap : englishSuffixMap;
                return `${rootNote}${suffixMap[chordType] || ''}`;
            }

            // 解析和弦符号
            function parseChordSymbol(chordSymbol) {
                const match = chordSymbol.match(/^([A-G][\u266f\u266d]?)(.*)$/);
                if (!match) {
                    return { root: 'C', type: 'major' };
                }
                
                const root = match[1];
                let suffix = match[2];
                
                // 特殊处理复合后缀，如7sus4应该保持为7sus4类型
                // 检查是否包含sus4但不是以sus4结尾
                if (suffix.includes('sus4') && !suffix.endsWith('sus4')) {
                    // 对于7sus4这样的后缀，我们保持为7sus4类型
                    // suffix = 'sus4'; // 注释掉，保持原始后缀
                }
                // 同样处理sus2
                else if (suffix.includes('sus2') && !suffix.endsWith('sus2')) {
                    // 对于7sus2这样的后缀，我们保持为7sus2类型
                    // suffix = 'sus2'; // 注释掉，保持原始后缀
                }
                
                // 创建后缀到和弦类型的映射
                const typeMap = {
                    '': 'major',
                    'm': 'minor',
                    'dim': 'diminished',
                    'aug': 'augmented',
                    '6': 'major6',
                    'm6': 'minor6',
                    '7': 'dominant7',
                    'maj7': 'major7',
                    'm7': 'minor7',
                    'm7♭5': 'minor7b5',
                    'dim7': 'diminished7',
                    '9': 'dominant9',
                    'maj9': 'major9',
                    'm9': 'minor9',
                    '7♯9': 'dominant7sharp9',
                    '7♭9': 'dominant7flat9',
                    '11': 'dominant11',
                    'm11': 'minor11',
                    '7♯11': 'dominant7sharp11',
                    '13': 'dominant13',
                    'm13': 'minor13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                const type = typeMap[suffix] || 'major';
                return { root, type };
            }

            // 更新调性选择器，设置歌曲的原调为默认选项
            function updateKeySelector(songName) {
                const progressionKeyEl = document.getElementById('progressionKey');
                const customDropdown = document.getElementById('progressionKeyDropdown');
                
                // 获取歌曲数据
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][songName]) {
                        songData = jazzStandards[letter][songName];
                        break;
                    }
                }
                
                if (!songData) return;
                
                const originalKey = songData.key;
                
                // 重新生成原生select选项列表
                const allKeys = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                
                progressionKeyEl.innerHTML = '';
                
                allKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    
                    if (key === originalKey) {
                        option.textContent = `${key} 默认`;
                        option.selected = true;
                    } else {
                        option.textContent = key;
                    }
                    
                    progressionKeyEl.appendChild(option);
                });
                
                // 更新自定义下拉框的显示
                if (customDropdown) {
                    const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                    if (trigger) {
                        trigger.textContent = `${originalKey} 默认`;
                    }
                    
                    // 重新生成自定义下拉框的选项
                    const menu = customDropdown.querySelector('.dropdown-menu');
                    if (menu) {
                        menu.innerHTML = '';
                        
                        allKeys.forEach(key => {
                            const keyLi = document.createElement('li');
                            keyLi.className = 'dropdown-item';
                            keyLi.setAttribute('data-value', key);
                            
                            const itemText = document.createElement('span');
                            itemText.className = 'item-text';
                            if (key === originalKey) {
                                itemText.textContent = `${key} 默认`;
                            } else {
                                itemText.textContent = key;
                            }
                            keyLi.appendChild(itemText);
                            
                            menu.appendChild(keyLi);
                        });
                        
                        // 重新绑定事件监听器
                        const items = menu.querySelectorAll('.dropdown-item');
                        items.forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const value = this.dataset.value;
                                const text = this.querySelector('.item-text').textContent;
                                
                                // 更新显示文本
                                trigger.textContent = text;
                                
                                // 更新原生select的值
                                progressionKeyEl.value = value;
                                
                                // 触发change事件
                                const changeEvent = new Event('change', { bubbles: true });
                                progressionKeyEl.dispatchEvent(changeEvent);
                                
                                // 关闭下拉菜单
                                menu.classList.remove('show');
                                customDropdown.querySelector('.dropdown-trigger').classList.remove('active');
                                customDropdown.querySelector('.dropdown-arrow').textContent = '▼';
                            });
                        });
                    }
                }
            }

            // 主题管理
            const ThemeManager = {
                currentTheme: 'dark',

                init() {
                    // 从本地存储加载保存的主题
                    const savedTheme = localStorage.getItem('appTheme') || 'dark';
                    this.setTheme(savedTheme);
                    this.updateThemeButtons();
                },

                setTheme(theme) {
                    this.currentTheme = theme;
                    localStorage.setItem('appTheme', theme);

                    if (theme === 'light') {
                        document.documentElement.setAttribute('data-theme', 'light');
                        this.applyLightTheme();
                    } else if (theme === 'dark') {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        this.applyDarkTheme();
                    } else if (theme === 'auto') {
                        // 跟随系统主题
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        const actualTheme = prefersDark ? 'dark' : 'light';
                        document.documentElement.setAttribute('data-theme', actualTheme);

                        if (actualTheme === 'light') {
                            this.applyLightTheme();
                        } else {
                            this.applyDarkTheme();
                        }

                        // 监听系统主题变化
                        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                            if (this.currentTheme === 'auto') {
                                const newTheme = e.matches ? 'dark' : 'light';
                                document.documentElement.setAttribute('data-theme', newTheme);
                                if (newTheme === 'light') {
                                    this.applyLightTheme();
                                } else {
                                    this.applyDarkTheme();
                                }
                            }
                        });
                    }
                },

                applyLightTheme() {
                    const root = document.documentElement;
                    // 背景色
                    root.style.setProperty('--bg-glass', 'rgba(255, 255, 255, 0.8)');
                    root.style.setProperty('--bg-glass-hover', 'rgba(255, 255, 255, 0.95)');
                    root.style.setProperty('--bg-white-glass', 'rgba(0, 0, 0, 0.03)');
                    root.style.setProperty('--bg-white-glass-hover', 'rgba(0, 0, 0, 0.08)');
                    root.style.setProperty('--bg-white-glass-disabled', 'rgba(0, 0, 0, 0.01)');

                    // 边框色
                    root.style.setProperty('--border-glass', 'rgba(0, 0, 0, 0.08)');
                    root.style.setProperty('--border-glass-hover', 'rgba(0, 0, 0, 0.15)');
                    root.style.setProperty('--border-glass-strong', 'rgba(0, 0, 0, 0.25)');

                    // 文字色
                    root.style.setProperty('--text-primary', '#1e293b');
                    root.style.setProperty('--text-secondary', '#475569');
                    root.style.setProperty('--text-disabled', 'rgba(0, 0, 0, 0.25)');

                    // 按钮和交互元素
                    root.style.setProperty('--btn-primary-bg', 'linear-gradient(135deg, #3b82f6, #2563eb)');
                    root.style.setProperty('--btn-primary-border', '#3b82f6');
                    root.style.setProperty('--btn-primary-text', '#ffffff');
                    root.style.setProperty('--btn-secondary-bg', 'rgba(0, 0, 0, 0.05)');
                    root.style.setProperty('--btn-secondary-border', 'rgba(0, 0, 0, 0.15)');
                    root.style.setProperty('--btn-secondary-text', '#1e293b');

                    // 状态颜色
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--warning-color', '#f59e0b');
                    root.style.setProperty('--error-color', '#ef4444');
                    root.style.setProperty('--info-color', '#3b82f6');

                    // 阴影
                    root.style.setProperty('--shadow-light', '0 4px 12px rgba(0, 0, 0, 0.05)');
                    root.style.setProperty('--shadow-medium', '0 8px 24px rgba(0, 0, 0, 0.08)');
                    root.style.setProperty('--shadow-heavy', '0 16px 48px rgba(0, 0, 0, 0.12)');
                },

                applyDarkTheme() {
                    const root = document.documentElement;
                    // 背景色
                    root.style.setProperty('--bg-glass', 'rgba(30, 41, 59, 0.3)');
                    root.style.setProperty('--bg-glass-hover', 'rgba(30, 41, 59, 0.5)');
                    root.style.setProperty('--bg-white-glass', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--bg-white-glass-hover', 'rgba(255, 255, 255, 0.2)');
                    root.style.setProperty('--bg-white-glass-disabled', 'rgba(255, 255, 255, 0.05)');

                    // 边框色
                    root.style.setProperty('--border-glass', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--border-glass-hover', 'rgba(255, 255, 255, 0.2)');
                    root.style.setProperty('--border-glass-strong', 'rgba(255, 255, 255, 0.4)');

                    // 文字色
                    root.style.setProperty('--text-primary', '#e2e8f0');
                    root.style.setProperty('--text-secondary', '#94a3b8');
                    root.style.setProperty('--text-disabled', 'rgba(255, 255, 255, 0.3)');

                    // 按钮和交互元素
                    root.style.setProperty('--btn-primary-bg', 'linear-gradient(135deg, #3b82f6, #1d4ed8)');
                    root.style.setProperty('--btn-primary-border', '#3b82f6');
                    root.style.setProperty('--btn-primary-text', '#ffffff');
                    root.style.setProperty('--btn-secondary-bg', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--btn-secondary-border', 'rgba(255, 255, 255, 0.2)');
                    root.style.setProperty('--btn-secondary-text', '#e2e8f0');

                    // 状态颜色
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--warning-color', '#f59e0b');
                    root.style.setProperty('--error-color', '#ef4444');
                    root.style.setProperty('--info-color', '#3b82f6');

                    // 阴影
                    root.style.setProperty('--shadow-light', '0 4px 12px rgba(0, 0, 0, 0.15)');
                    root.style.setProperty('--shadow-medium', '0 8px 24px rgba(0, 0, 0, 0.25)');
                    root.style.setProperty('--shadow-heavy', '0 16px 48px rgba(0, 0, 0, 0.35)');
                },

                updateThemeButtons() {
                    const themeButtons = document.querySelectorAll('.theme-btn');
                    themeButtons.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.theme === this.currentTheme) {
                            btn.classList.add('active');
                        }
                    });
                }
            };

            // 初始化主题切换按钮
            function initThemeButtons() {
                const themeButtons = document.querySelectorAll('.theme-btn');

                themeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const theme = this.dataset.theme;
                        ThemeManager.setTheme(theme);
                        ThemeManager.updateThemeButtons();
                    });
                });

                // 初始化主题管理器
                ThemeManager.init();
            }

            // 大调音阶的音级对应关系
            const majorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5, 
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // 小调音阶的音级对应关系（以自然小调为基础）
            const minorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5,
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // 十二平均律音名数组
            const chromaticNotes = ['C', 'C♯', 'D', 'E♭', 'E', 'F', 'F♯', 'G', 'A♭', 'A', 'B♭', 'B'];
            const chromaticNotesFlat = ['C', 'D♭', 'D', 'E♭', 'E', 'F', 'G♭', 'G', 'A♭', 'A', 'B♭', 'B'];
            
            // 音名到数字的映射
            const noteToNumber = {
                'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4, 'F': 5,
                'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8, 'A': 9, 'A♯': 10, 'B♭': 10, 'B': 11
            };
            
            // 根据调性选择合适的音名数组（优先使用升号或降号）
            function getNotesForKey(key) {
                // 升号调：G, D, A, E, B, F♯, C♯
                const sharpKeys = ['G', 'D', 'A', 'E', 'B', 'F♯', 'C♯'];
                // 降号调：F, B♭, E♭, A♭, D♭, G♭, C♭
                const flatKeys = ['F', 'B♭', 'E♭', 'A♭', 'D♭', 'G♭', 'C♭'];
                
                if (sharpKeys.includes(key)) {
                    return chromaticNotes; // 使用升号
                } else {
                    return chromaticNotesFlat; // 使用降号
                }
            }
            
            // 解析罗马数字级数
            function parseRomanNumeral(roman) {
                // 匹配罗马数字部分（包括可能的降号前缀，支持♭和b）
                const match = roman.match(/^([♭b]?)([IVX]+|[ivx]+)/); 
                if (!match) {
                    console.warn(`Cannot parse roman numeral: ${roman}`);
                    return { degree: 'I', isMinor: false, suffix: '' };
                }
                
                const flatPrefix = match[1]; // '♭'、'b' 或空字符串
                const romanPart = match[2];
                const suffix = roman.replace(match[0], ''); // 移除罗马数字部分后的部分
                
                // 判断是否为小写（小调）
                const isMinor = /[ivx]/.test(romanPart);
                const upperRoman = flatPrefix + romanPart.toUpperCase();
                
                return {
                    degree: upperRoman,
                    isMinor: isMinor,
                    suffix: suffix
                };
            }
            
            // 将音级转换为具体的音名
            function degreeToNote(degree, keyRoot, keyMode = 'major') {
                const keyRootNumber = noteToNumber[keyRoot];
                const scaleDegrees = keyMode === 'major' ? majorScaleDegrees : minorScaleDegrees;
                
                if (!(degree in scaleDegrees)) {
                    console.warn(`Unknown degree: ${degree}`);
                    return keyRoot;
                }
                
                const semitones = scaleDegrees[degree];
                const resultNumber = (keyRootNumber + semitones) % 12;
                
                const notesArray = getNotesForKey(keyRoot);
                return notesArray[resultNumber];
            }
            
            // 将基于音级的和弦转换为具体调性的和弦
            function transposeChordFromDegree(degreeChord, originalKey, targetKey) {
                const parsed = parseRomanNumeral(degreeChord);
                const targetNote = degreeToNote(parsed.degree, targetKey, 'major');
                
                // 构建和弦符号
                let chordSymbol = targetNote;
                
                // 添加和弦类型
                if (parsed.isMinor) {
                    chordSymbol += 'm';
                }
                
                // 添加其他后缀
                chordSymbol += parsed.suffix;
                
                // 处理特殊符号替换
                chordSymbol = chordSymbol.replace('M7', 'maj7').replace('M', 'maj');
                
                return chordSymbol;
            }

            // 调式多选下拉框管理器
            const ScaleTypeManager = {
                // 选中的调式
                selectedScales: new Set(['major']),
                isOpen: false,

                // 初始化多选调式功能
                init() {
                    console.log('初始化调式多选下拉框');
                    this.bindEvents();
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                    // 默认选中major
                    this.checkInitialScale();
                },

                // 检查初始调式
                checkInitialScale() {
                    // 清空selectedScales，然后根据实际复选框状态重新设置
                    this.selectedScales.clear();

                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            this.selectedScales.add(checkbox.value);
                        }
                    });

                    // 如果没有选中的，默认选中major
                    if (this.selectedScales.size === 0) {
                        const majorCheckbox = document.querySelector('.dropdown-option input[value="major"]');
                        if (majorCheckbox) {
                            majorCheckbox.checked = true;
                            this.selectedScales.add('major');
                        }
                    }
                },

                // 绑定事件
                bindEvents() {
                    const dropdown = document.getElementById('scaleTypeDropdown');
                    const content = document.getElementById('scaleTypeDropdownContent');

                    // 下拉框点击事件 - 使用全屏选择器
                    if (dropdown) {
                        dropdown.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            // 打开全屏选择器而不是原来的下拉框
                            if (typeof openFullscreenSelector === 'function') {
                                openFullscreenSelector('scaleType', '选择调式', null);
                            } else {
                                this.toggleDropdown(); // 备用方案
                            }
                        }, true);
                    }

                    // 控制按钮事件
                    document.getElementById('selectAllScales')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectAll();
                    });

                    document.getElementById('deselectAllScales')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deselectAll();
                    });

                    document.getElementById('randomSelectScales')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.randomSelect();
                    });

                    // 调式复选框事件
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            if (checkbox.checked) {
                                this.selectedScales.add(checkbox.value);
                            } else {
                                this.selectedScales.delete(checkbox.value);
                            }
                            this.updateHiddenSelect();
                            this.updateDisplayText();
                            this.updateArpeggioButtons();
                        });
                    });

                    // 点击外部关闭下拉框
                    document.addEventListener('click', (e) => {
                        if (!dropdown?.contains(e.target)) {
                            this.closeDropdown();
                        }
                    });

                    // 阻止下拉内容点击事件冒泡
                    if (content) {
                        content.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                    }
                },

                // 切换下拉框显示状态
                toggleDropdown() {
                    if (this.isOpen) {
                        this.closeDropdown();
                    } else {
                        this.openDropdown();
                    }
                },

                // 打开下拉框
                openDropdown() {
                    const dropdown = document.getElementById('scaleTypeDropdown');
                    const content = document.getElementById('scaleTypeDropdownContent');
                    const startBtn = document.getElementById('startBtn');

                    if (dropdown && content) {
                        dropdown.classList.add('active');
                        content.classList.add('show');
                        this.isOpen = true;

                        // 隐藏开始练习按钮以避免遮挡
                        if (startBtn) {
                            startBtn.style.visibility = 'hidden';
                            startBtn.style.opacity = '0';
                            startBtn.style.pointerEvents = 'none';
                        }
                    }
                },

                // 关闭下拉框
                closeDropdown() {
                    const dropdown = document.getElementById('scaleTypeDropdown');
                    const content = document.getElementById('scaleTypeDropdownContent');
                    const startBtn = document.getElementById('startBtn');

                    if (dropdown && content) {
                        dropdown.classList.remove('active');
                        content.classList.remove('show');
                        this.isOpen = false;

                        // 恢复开始练习按钮显示
                        if (startBtn) {
                            startBtn.style.visibility = 'visible';
                            startBtn.style.opacity = '1';
                            startBtn.style.pointerEvents = 'auto';
                        }
                    }
                },

                // 全选
                selectAll() {
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                        this.selectedScales.add(checkbox.value);
                    });
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                },

                // 全不选
                deselectAll() {
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    this.selectedScales.clear();
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                },

                // 随机选择
                randomSelect() {
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    const availableScales = Array.from(checkboxes).map(cb => cb.value);

                    // 随机选择1-5个调式
                    const count = Math.floor(Math.random() * 5) + 1;
                    const selected = this.shuffleArray(availableScales).slice(0, count);

                    // 更新复选框状态
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = selected.includes(checkbox.value);
                    });

                    // 更新选中的调式
                    this.selectedScales = new Set(selected);
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                },

                // 洗牌算法
                shuffleArray(array) {
                    const shuffled = [...array];
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                    return shuffled;
                },

                // 更新显示文本
                updateDisplayText() {
                    const displayText = document.querySelector('.selected-text');
                    if (displayText) {
                        if (this.selectedScales.size === 0) {
                            displayText.textContent = '选择调式...';
                        } else {
                            // 根据选择数量决定显示方式
                            if (this.selectedScales.size <= 2) {
                                // 1-2个调式，显示完整信息（包含音级结构）
                                const selectedNames = Array.from(this.selectedScales).map(scale => this.getScaleDisplayName(scale));
                                displayText.textContent = selectedNames.join(', ');
                            } else {
                                // 超过2个调式，只显示调式名（不包含音级结构）
                                const selectedShortNames = Array.from(this.selectedScales).map(scale => this.getScaleShortName(scale));

                                if (this.selectedScales.size <= 5) {
                                    // 3-5个调式，显示全部简称
                                    displayText.textContent = selectedShortNames.join(', ');
                                } else {
                                    // 超过5个，显示前几个 + "等N个"
                                    const firstFew = selectedShortNames.slice(0, 4);
                                    displayText.textContent = `${firstFew.join(', ')} 等${this.selectedScales.size}个`;
                                }
                            }
                        }
                    }
                },

                // 更新隐藏的select元素
                updateHiddenSelect() {
                    const hiddenSelect = document.getElementById('scaleType');
                    if (hiddenSelect && this.selectedScales.size > 0) {
                        // 清空现有选项
                        hiddenSelect.innerHTML = '';

                        // 添加选中的调式
                        this.selectedScales.forEach(scale => {
                            const option = document.createElement('option');
                            option.value = scale;
                            option.selected = true;
                            option.textContent = this.getScaleDisplayName(scale);
                            hiddenSelect.appendChild(option);
                        });
                    }
                },

                // 获取调式显示名称
                getScaleDisplayName(scaleType) {
                    const scaleNames = {
                        'major': 'Major - 1 2 3 4 5 6 7',
                        'minor': 'Minor - 1 2 ♭3 4 5 ♭6 ♭7',
                        'ionian': 'Ionian - 1 2 3 4 5 6 7',
                        'dorian': 'Dorian - 1 2 ♭3 4 5 6 ♭7',
                        'phrygian': 'Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7',
                        'lydian': 'Lydian - 1 2 3 ♯4 5 6 7',
                        'mixolydian': 'Mixolydian - 1 2 3 4 5 6 ♭7',
                        'aeolian': 'Aeolian - 1 2 ♭3 4 5 ♭6 ♭7',
                        'locrian': 'Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7',
                        'harmonicMinor': 'Harmonic Minor - 1 2 ♭3 4 5 ♭6 7',
                        'melodicMinor': 'Melodic Minor - 1 2 ♭3 4 5 6 7',
                        'majorPentatonic': 'Major Pentatonic - 1 2 3 5 6',
                        'minorPentatonic': 'Minor Pentatonic - 1 ♭3 4 5 ♭7',
                        'blues': 'Blues - 1 ♭3 4 ♯4 5 ♭7',
                        'wholeTone': 'Whole Tone - 1 2 3 ♯4 ♯5 ♯6',
                        'diminished': 'Diminished - 1 ♭2 ♭3 3 ♯4 5 6 ♭7'
                    };
                    return scaleNames[scaleType] || scaleType;
                },

                // 获取调式简称（不包含音级结构）
                getScaleShortName(scaleType) {
                    const scaleNames = {
                        'major': 'Major',
                        'minor': 'Minor',
                        'ionian': 'Ionian',
                        'dorian': 'Dorian',
                        'phrygian': 'Phrygian',
                        'lydian': 'Lydian',
                        'mixolydian': 'Mixolydian',
                        'aeolian': 'Aeolian',
                        'locrian': 'Locrian',
                        'harmonicMinor': 'Harmonic Minor',
                        'melodicMinor': 'Melodic Minor',
                        'majorPentatonic': 'Major Pentatonic',
                        'minorPentatonic': 'Minor Pentatonic',
                        'blues': 'Blues',
                        'wholeTone': 'Whole Tone',
                        'diminished': 'Diminished'
                    };
                    return scaleNames[scaleType] || scaleType;
                },

                // 获取随机选中的调式类型
                getRandomSelectedScaleType() {
                    if (this.selectedScales.size === 0) return 'major';
                    const selectedArray = Array.from(this.selectedScales);
                    return selectedArray[Math.floor(Math.random() * selectedArray.length)];
                },

                // 更新琶音按钮
                updateArpeggioButtons() {
                    // 获取当前选中的调式
                    let currentScaleType = 'major';
                    if (this.selectedScales.size > 0) {
                        currentScaleType = Array.from(this.selectedScales)[0];
                    }

                    // 调用原有的琶音按钮更新函数
                    if (typeof updateArpeggioButtons === 'function') {
                        // 临时修改scaleType的值为当前选中的调式
                        const hiddenSelect = document.getElementById('scaleType');
                        if (hiddenSelect) {
                            const originalValue = hiddenSelect.value;
                            hiddenSelect.value = currentScaleType;
                            updateArpeggioButtons();
                            hiddenSelect.value = originalValue;
                        }
                    }
                }
            };

            // 将ScaleTypeManager暴露到全局作用域
            window.ScaleTypeManager = ScaleTypeManager;
            window.getRandomSelectedScaleType = ScaleTypeManager.getRandomSelectedScaleType.bind(ScaleTypeManager);

            // 应用初始化标志
            let appInitialized = false;
            
            // 初始化应用函数
            function initializeApplication() {
                if (appInitialized) {
                    console.log('应用已经初始化，跳过重复初始化');
                    return;
                }
                
                console.log('开始初始化应用');
                appInitialized = true;

                // 初始化调式多选功能
                ScaleTypeManager.init();

                // 启动应用
                if (typeof initApp === 'function') {
                    initApp();
                } else {
                    console.error('initApp函数未定义');
                }
                
                // 语言设置已在第一个script标签中初始化
                
                // 应用翻译
                if (typeof applyTranslations === 'function') {
                    applyTranslations();
                } else {
                    console.error('applyTranslations函数未定义');
                }
                
                // 初始化语言切换按钮
                initLanguageButtons();

                // 初始化主题切换按钮
                initThemeButtons();
                
                // 初始化和弦类型按钮文本
                setTimeout(() => {
                    updateChordTypeButtonTexts();
                }, 100);
            }
            
            // 将state暴露到全局作用域
            window.state = state;
            
            // 等待DOM加载完成后再初始化应用
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                console.log('DOM已加载完成，直接初始化应用');
                initializeApplication();
            } else {
                console.log('DOM未加载完成，等待DOMContentLoaded事件');
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOMContentLoaded事件触发，初始化应用');
                    initializeApplication();
                });
            }
        });
    </script>
    
    <script>
        // 全屏选择器功能
        (function() {
            const fullscreenSelector = document.getElementById('fullscreenSelector');
            const fullscreenSelectorBack = document.getElementById('fullscreenSelectorBack');
            const fullscreenSelectorTitle = document.getElementById('fullscreenSelectorTitle');
            const fullscreenSelectorContent = document.getElementById('fullscreenSelectorContent');
            
            let currentSelectorType = null;
            let currentCallback = null;
            
            // 打开全屏选择器
            window.openFullscreenSelector = function(type, title, callback, selectId) {
                currentSelectorType = type;
                currentCallback = callback;
                fullscreenSelectorTitle.textContent = title;
                
                // 根据类型生成不同的内容
                if (type === 'progressionLevel') {
                    generateProgressionLevelContent();
                } else if (type === 'jazzStandard') {
                    generateJazzStandardContent();
                } else if (type === 'progressionKey') {
                    generateProgressionKeyContent();
                } else if (type === 'rootNote') {
                    generateRootNoteContent(selectId || 'rootNote');
                } else if (type === 'scaleType') {
                    generateScaleTypeContent();
                } else if (type === 'chordRootNote') {
                    generateRootNoteContent(selectId || 'chordRootNote');
                } else if (type === 'customChordRoot') {
                    generateRootNoteContent('customChordRoot');
                } else if (type === 'customChordType') {
                    generateChordTypeContent();
                } else if (type === 'customChordBass') {
                    generateCustomChordBassContent();
                } else if (type === 'pitchFindingTime') {
                    generatePitchFindingTimeContent();
                } else if (type === 'rootNoteSelect') {
                    generateRootNoteSelectContent();
                }
                
                fullscreenSelector.classList.add('active');
            };
            
            // 简单方案1: 直接使用浏览器原生tooltip
            function showNativeTooltip(element, descKey) {
                const infoText = window.t ? window.t(descKey) : descKey;
                element.title = infoText.replace(/\n/g, ' | ');
            }

            // 简单方案2: 在按钮下方添加可展开的说明文字
            function toggleDescription(element, descKey) {
                const infoText = window.t ? window.t(descKey) : descKey;
                const selectorItem = element.closest('.selector-item');

                // 查找或创建说明容器
                let descContainer = selectorItem.querySelector('.item-description');
                if (descContainer) {
                    // 如果已存在，切换显示状态
                    descContainer.style.display = descContainer.style.display === 'none' ? 'block' : 'none';
                    if (descContainer.style.display === 'none') {
                        element.textContent = 'ℹ️';
                    } else {
                        element.textContent = '✖️';
                    }
                } else {
                    // 创建说明容器
                    descContainer = document.createElement('div');
                    descContainer.className = 'item-description';
                    descContainer.innerHTML = infoText.replace(/\n/g, '<br>');
                    selectorItem.appendChild(descContainer);
                    element.textContent = '✖️';

                    // 自动关闭其他说明
                    document.querySelectorAll('.item-description').forEach(desc => {
                        if (desc !== descContainer) {
                            desc.remove();
                            const otherIcon = desc.closest('.selector-item').querySelector('.info-icon');
                            if (otherIcon) otherIcon.textContent = 'ℹ️';
                        }
                    });
                }
            }

            // 简单方案3: 在选择器顶部显示说明区域
            let currentTopDescription = null;
            function showTopDescription(descKey, buttonText) {
                const infoText = window.t ? window.t(descKey) : descKey;

                // 移除之前的说明
                if (currentTopDescription) {
                    currentTopDescription.remove();
                }

                // 查找或创建顶部说明区域
                let topDesc = document.querySelector('.top-description');
                if (!topDesc) {
                    topDesc = document.createElement('div');
                    topDesc.className = 'top-description';
                    const content = document.querySelector('.fullscreen-selector-content');
                    if (content) {
                        content.insertBefore(topDesc, content.firstChild);
                    }
                }

                topDesc.innerHTML = `
                    <strong>${buttonText}</strong>: ${infoText.replace(/\n/g, ' | ')}
                    <button class="close-desc" onclick="this.parentElement.remove()">×</button>
                `;

                currentTopDescription = topDesc;
            }

            // 显示hover提示
            function showTooltip(element, descKey) {
                const infoText = window.t ? window.t(descKey) : descKey;

                // 创建tooltip元素
                const tooltip = document.createElement('div');
                tooltip.className = 'info-tooltip';
                tooltip.innerHTML = infoText.replace(/\n/g, '<br>');

                document.body.appendChild(tooltip);

                // 计算位置
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();

                // 设置tooltip位置，在按钮上方
                tooltip.style.left = rect.left + (rect.width / 2) - (tooltipRect.width / 2) + 'px';
                tooltip.style.top = rect.top - tooltipRect.height - 8 + 'px';

                // 添加显示动画
                requestAnimationFrame(() => {
                    tooltip.classList.add('show');
                });

                return tooltip;
            }

            // 隐藏hover提示
            function hideTooltip(tooltip) {
                if (tooltip && tooltip.parentNode) {
                    tooltip.classList.remove('show');
                    setTimeout(() => {
                        if (tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                    }, 200);
                }
            }

            // 关闭全屏选择器
            function closeFullscreenSelector() {
                fullscreenSelector.classList.remove('active');
                currentSelectorType = null;
                currentCallback = null;
            }
            
            // 返回按钮事件
            fullscreenSelectorBack.addEventListener('click', closeFullscreenSelector);
            
            // 生成练习等级选择内容
            function generateProgressionLevelContent() {
                const levelSelect = document.getElementById('progressionLevel');
                const currentValue = levelSelect.value;

                const levels = {
                    'chord_single_notes': [
                        { value: 'single-root', text: '1', desc: 'root' },
                        { value: 'single-3', text: '3', desc: 'third' },
                        { value: 'single-5', text: '5', desc: 'fifth' },
                        { value: 'single-7', text: '7', desc: 'seventh' }
                    ],
                    'chord_double_notes': [
                        { value: 'double-root-3', text: '1,3', desc: 'root_third' },
                        { value: 'double-root-5', text: '1,5', desc: 'root_fifth' },
                        { value: 'double-root-7', text: '1,7', desc: 'root_seventh' },
                        { value: 'double-3-5', text: '3,5', desc: 'third_fifth' },
                        { value: 'double-3-7', text: '3,7', desc: 'third_seventh' }
                    ],
                    'chord_triple_notes': [
                        { value: 'triple-root-3-5', text: '1,3,5', desc: 'root_third_fifth' },
                        { value: 'triple-3-5-7', text: '3,5,7', desc: 'third_fifth_seventh' },
                        { value: 'triple-random-inversion', text: '1,3,5随机转位', desc: 'random_inversions_135' }
                    ],
                    'chord_quad_notes': [
                        { value: 'quad-root-3-5-7', text: '1,3,5,7', desc: 'root_third_fifth_seventh' },
                        { value: 'quad-3-5-7-root', text: '3,5,7,1', desc: 'first_inversion' },
                        { value: 'quad-5-7-root-3', text: '5,7,1,3', desc: 'second_inversion' },
                        { value: 'quad-7-root-3-5', text: '7,1,3,5', desc: 'third_inversion' },
                        { value: 'quad-random-inversion', text: '1,3,5,7随机转位', desc: 'random_inversions_1357' },
                        { value: 'quad-root-3-5-7-root', text: '1,3,5,7,1', desc: 'with_octave_root' }
                    ],
                    'chord_all_notes': [
                        { value: 'all-notes', text: '全部', desc: 'all_notes' }
                    ],
                    'melodic_structure_r_to_5th': [
                        { value: 'melodic-r-3', text: '旋律结构1', desc: 'root_to_third' },
                        { value: 'melodic-r-5', text: '旋律结构2', desc: 'root_to_fifth' },
                        { value: 'melodic-3-5', text: '旋律结构3', desc: 'third_to_fifth' },
                        { value: 'melodic-r-3-5', text: '旋律结构4', desc: 'root_third_fifth_line' },
                        { value: 'melodic-random-inversions', text: '旋律结构5-随机转位', desc: 'random_inversions' }
                    ],
                    'melodic_structure_5th_to_9th': [
                        { value: 'melodic-5-7', text: '5→7', desc: 'fifth_to_seventh' },
                        { value: 'melodic-7-9', text: '7→9', desc: 'seventh_to_ninth' },
                        { value: 'melodic-5-9', text: '5→9', desc: 'fifth_to_ninth' },
                        { value: 'melodic-5-7-9', text: '5→7→9', desc: 'fifth_seventh_ninth_line' }
                    ],
                    'voice_led_structure': [
                        { value: 'voice-led-stepwise', text: '级进连接', desc: 'stepwise_voice_leading' },
                        { value: 'voice-led-common', text: '共同音保持', desc: 'common_tone_voice_leading' },
                        { value: 'voice-led-contrary', text: '反向进行', desc: 'contrary_motion_voice_leading' },
                        { value: 'voice-led-parallel', text: '平行进行', desc: 'parallel_motion_voice_leading' }
                    ],
                    'suspension_structure': [
                        { value: 'sus4-sus2', text: 'Sus4→Sus2', desc: 'sus4_to_sus2' },
                        { value: 'sus4-resolve', text: 'Sus4→3', desc: 'sus4_to_third' },
                        { value: 'sus2-resolve', text: 'Sus2→3', desc: 'sus2_to_third' },
                        { value: 'sus-resolve-chain', text: '挂留解决链', desc: 'suspension_resolution_chain' }
                    ],
                    'chord_scale_structure': [
                        { value: 'chord-scale-triadic', text: '三和弦音阶', desc: 'triadic_chord_scales' },
                        { value: 'chord-scale-seventh', text: '七和弦音阶', desc: 'seventh_chord_scales' },
                        { value: 'chord-scale-extended', text: '扩展和弦音阶', desc: 'extended_chord_scales' },
                        { value: 'chord-scale-modal', text: '调式和弦音阶', desc: 'modal_chord_scales' }
                    ],
                    'passing_tone_structure': [
                        { value: 'passing-diatonic', text: '自然经过音', desc: 'diatonic_passing_tones' },
                        { value: 'passing-chromatic', text: '半音经过音', desc: 'chromatic_passing_tones' },
                        { value: 'passing-enclosure', text: '包围音', desc: 'enclosure_passing_tones' },
                        { value: 'passing-appoggiatura', text: '装饰音', desc: 'appoggiatura_passing_tones' }
                    ]
                };

                let html = '<div class="selector-grid">';

                for (const [groupName, items] of Object.entries(levels)) {
                    html += `<div class="selector-group-title" data-i18n-key="${groupName}">● ${window.t ? window.t(groupName) : groupName}</div>`;
                    html += '<div class="selector-group">';
                    items.forEach(item => {
                        const isActive = item.value === currentValue ? 'active' : '';
                        const translatedText = item.text.includes('随机转位') ? (window.t && window.getCurrentLanguage() === 'en' ? item.text.replace('随机转位', 'Random Inversions') : item.text) : item.text;

                        // 检查是否是旋律结构相关的分组
                        const isMelodicStructureGroup = groupName.includes('melodic_structure') ||
                                                   groupName.includes('voice_led_structure') ||
                                                   groupName.includes('suspension_structure') ||
                                                   groupName.includes('chord_scale_structure') ||
                                                   groupName.includes('passing_tone_structure');

                        if (isMelodicStructureGroup) {
                            html += `
                                <div class="selector-item ${isActive}" data-value="${item.value}">
                                    <div class="selector-item-title">${translatedText}</div>
                                    <div class="info-icon" data-info="${item.desc}" title="点击查看说明">ℹ️</div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="selector-item ${isActive}" data-value="${item.value}">
                                    <div class="selector-item-title">${translatedText}</div>
                                    <div class="selector-item-desc" data-i18n-key="${item.desc}">${window.t ? window.t(item.desc) : item.desc}</div>
                                </div>
                            `;
                        }
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;

                // 使用通用的事件绑定函数
                bindSelectorItemClickEvents();

                // 绑定info图标点击事件 - 使用简单方案
                const infoIcons = fullscreenSelectorContent.querySelectorAll('.info-icon');
                infoIcons.forEach(icon => {
                    // 设置原生tooltip（最简单的方案）
                    const descKey = icon.getAttribute('data-info');
                    showNativeTooltip(icon, descKey);

                    // 点击使用方案2：在按钮下方展开说明
                    icon.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const descKey = this.getAttribute('data-info');
                        const buttonText = this.previousElementSibling.textContent;

                        // 方案2：展开说明
                        toggleDescription(this, descKey);

                        // 或者使用方案3：在顶部显示（取消下面的注释，注释上面的方案2）
                        // showTopDescription(descKey, buttonText);
                    });
                });

                // 滚动到当前选中的项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }

            // 监听语言变化事件，更新当前显示的选择器内容
            window.addEventListener('languageChanged', function(event) {
                if (currentSelectorType && fullscreenSelector.classList.contains('active')) {
                    // 更新标题
                    const titleKey = currentSelectorType === 'progressionLevel' ? 'progression_level' :
                                   currentSelectorType === 'jazzStandard' ? 'select_tune' :
                                   currentSelectorType === 'progressionKey' ? 'select_key' : '';
                    if (titleKey && window.t) {
                        fullscreenSelectorTitle.textContent = window.t(titleKey);
                    }

                    // 重新生成当前选择器内容以更新语言
                    if (currentSelectorType === 'progressionLevel') {
                        generateProgressionLevelContent();
                    } else if (currentSelectorType === 'jazzStandard') {
                        generateJazzStandardContent();
                    } else if (currentSelectorType === 'progressionKey') {
                        generateProgressionKeyContent();
                    }
                    // 重新绑定点击事件
                    bindSelectorItemClickEvents();

                    // 重新绑定info图标点击事件 - 使用简单方案
                    const infoIcons = fullscreenSelectorContent.querySelectorAll('.info-icon');
                    infoIcons.forEach(icon => {
                        // 设置原生tooltip
                        const descKey = icon.getAttribute('data-info');
                        showNativeTooltip(icon, descKey);

                        // 点击事件
                        icon.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();

                            const descKey = this.getAttribute('data-info');
                            const buttonText = this.previousElementSibling.textContent;

                            // 方案2：展开说明
                            toggleDescription(this, descKey);

                            // 或者使用方案3：在顶部显示
                            // showTopDescription(descKey, buttonText);
                        });
                    });
                }
            });

            // 绑定选择器项目点击事件的通用函数
            function bindSelectorItemClickEvents() {
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.replaceWith(item.cloneNode(true)); // 移除旧的事件监听器
                });

                const newItems = fullscreenSelectorContent.querySelectorAll('.selector-item');
                newItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;

                        if (currentSelectorType === 'progressionLevel') {
                            const levelSelect = document.getElementById('progressionLevel');
                            levelSelect.value = value;

                            // 更新自定义下拉框显示
                            const customDropdown = document.getElementById('progressionLevelDropdown');
                            if (customDropdown) {
                                const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                                if (trigger) {
                                    trigger.textContent = text;
                                }

                                // 更新active状态
                                const allItems = customDropdown.querySelectorAll('.dropdown-item');
                                allItems.forEach(item => item.classList.remove('active'));
                                const activeItem = customDropdown.querySelector(`.dropdown-item[data-value="${value}"]`);
                                if (activeItem) {
                                    activeItem.classList.add('active');
                                }
                            }

                            // 触发change事件
                            levelSelect.dispatchEvent(new Event('change'));
                        }

                        if (currentCallback) {
                            currentCallback(value, text);
                        }

                        closeFullscreenSelector();
                    });
                });
            }

            // 生成乐曲选择内容
            function generateJazzStandardContent() {
                const jazzStandardSelect = document.getElementById('jazzStandard');
                const currentValue = jazzStandardSelect.value;
                
                // 按字母分组的歌曲
                const groups = {};
                const options = jazzStandardSelect.querySelectorAll('option');
                
                let currentGroup = '';
                options.forEach(option => {
                    const parent = option.parentElement;
                    if (parent.tagName === 'OPTGROUP') {
                        currentGroup = parent.label;
                        if (!groups[currentGroup]) {
                            groups[currentGroup] = [];
                        }
                        groups[currentGroup].push({
                            value: option.value,
                            text: option.textContent
                        });
                    }
                });
                
                // 添加搜索框
                let html = `
                    <div class="selector-search-box">
                        <input type="text" 
                               id="songSearchInput" 
                               class="selector-search-input" 
                               placeholder="搜索歌曲名..." data-i18n-key="search_song_placeholder" 
                               autocomplete="off">
                        <span class="selector-search-icon">🔍</span>
                    </div>
                    <div class="selector-list" id="songListContainer">
                `;
                
                for (const [groupName, songs] of Object.entries(groups)) {
                    html += `<div class="selector-group-title" data-group="${groupName}">● ${groupName}</div>`;
                    songs.forEach(song => {
                        const isActive = song.value === currentValue ? 'active' : '';
                        html += `
                            <div class="selector-list-item ${isActive}" data-value="${song.value}" data-song-name="${song.text}" data-group="${groupName}">
                                <div class="selector-list-item-name">${song.text}</div>
                                <div class="selector-list-item-info">
                                    <div class="selector-list-item-badge">${groupName}</div>
                                    <span class="selector-info-icon" data-song-info="${song.value}">ℹ️</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-list-item');
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        // 如果点击的是信息图标，不执行选择操作
                        if (e.target.classList.contains('selector-info-icon')) {
                            return;
                        }
                        
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-list-item-name').textContent;
                        
                        // 更新原生select
                        jazzStandardSelect.value = value;
                        
                        // 更新自定义下拉框显示（如果存在）
                        const customDropdown = document.getElementById('jazzStandardDropdown');
                        if (customDropdown) {
                            const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                            if (trigger) {
                                trigger.textContent = text;
                            }
                        }
                        
                        // 触发change事件
                        jazzStandardSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // 绑定信息图标点击事件
                const infoIcons = fullscreenSelectorContent.querySelectorAll('.selector-info-icon');
                infoIcons.forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const songName = this.dataset.songInfo;
                        
                        // 调用显示歌曲信息的函数
                        if (typeof window.showSongInfo === 'function') {
                            window.showSongInfo(songName);
                        }
                    });
                });
                
                // 搜索功能
                const searchInput = document.getElementById('songSearchInput');
                if (searchInput) {
                    searchInput.focus(); // 自动聚焦搜索框
                    
                    searchInput.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        const allItems = fullscreenSelectorContent.querySelectorAll('.selector-list-item');
                        const allGroupTitles = fullscreenSelectorContent.querySelectorAll('.selector-group-title');
                        
                        if (!searchTerm) {
                            // 清空搜索时显示所有项目
                            allItems.forEach(item => item.style.display = '');
                            allGroupTitles.forEach(title => title.style.display = '');
                        } else {
                            // 搜索匹配
                            const visibleGroups = new Set();
                            
                            allItems.forEach(item => {
                                const songName = item.dataset.songName.toLowerCase();
                                if (songName.includes(searchTerm)) {
                                    item.style.display = '';
                                    visibleGroups.add(item.dataset.group);
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                            
                            // 只显示有歌曲的分组标题
                            allGroupTitles.forEach(title => {
                                if (visibleGroups.has(title.dataset.group)) {
                                    title.style.display = '';
                                } else {
                                    title.style.display = 'none';
                                }
                            });
                        }
                    });
                }
                
                // 滚动到当前选中的项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-list-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // 生成调性选择内容
            function generateProgressionKeyContent() {
                const keySelect = document.getElementById('progressionKey');
                const currentValue = keySelect.value;
                
                const keys = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                
                // 获取当前选中乐曲的原调
                const jazzStandardSelect = document.getElementById('jazzStandard');
                const selectedSong = jazzStandardSelect.value;
                
                // 查找原调
                let originalKey = 'C';
                if (typeof jazzStandards !== 'undefined') {
                    for (const letter in jazzStandards) {
                        if (jazzStandards[letter][selectedSong]) {
                            originalKey = jazzStandards[letter][selectedSong].key;
                            break;
                        }
                    }
                }
                
                let html = '<div class="selector-grid">';
                
                keys.forEach(key => {
                    const isActive = key === currentValue ? 'active' : '';
                    const isOriginal = key === originalKey;
                    const displayText = isOriginal ? `${key} 默认` : key;
                    const desc = isOriginal ? '歌曲原调' : '移调';
                    
                    html += `
                        <div class="selector-item ${isActive}" data-value="${key}">
                            <div class="selector-item-title">${displayText}</div>
                            <div class="selector-item-desc">${desc}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        // 更新原生select
                        keySelect.value = value;
                        
                        // 更新自定义下拉框显示
                        const customDropdown = document.getElementById('progressionKeyDropdown');
                        if (customDropdown) {
                            const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                            if (trigger) {
                                trigger.textContent = text;
                            }
                        }
                        
                        // 触发change事件
                        keySelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // 滚动到当前选中的项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // 生成根音选择内容（通用）
            function generateRootNoteContent(selectId) {
                let currentValue;
                
                // 对于自定义和弦弹窗，使用当前选择的根音值
                if (selectId === 'customChordRoot') {
                    currentValue = window.currentChordRoot;
                } else {
                const rootNoteSelect = document.getElementById(selectId);
                    currentValue = rootNoteSelect ? rootNoteSelect.value : 'C';
                }
                
                const notes = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                
                let html = '<div class="selector-grid">';
                
                notes.forEach(note => {
                    const isActive = note === currentValue ? 'active' : '';
                    html += `
                        <div class="selector-item ${isActive}" data-value="${note}">
                            <div class="selector-item-title">${note}</div>
                            <div class="selector-item-desc" data-i18n-key="key_desc">调性</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        rootNoteSelect.value = value;
                        rootNoteSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, value);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // 滚动到当前选中项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // 生成音阶类型选择内容
            // 生成音阶类型选择内容（多选模式）
            function generateScaleTypeContent() {
                // 获取当前已选中的调式
                const currentSelectedScales = window.ScaleTypeManager ?
                    Array.from(window.ScaleTypeManager.selectedScales) : ['major'];

                // 添加控制按钮到header
                const fullscreenSelectorHeader = document.querySelector('.fullscreen-selector-header');
                const originalButtons = fullscreenSelectorHeader.innerHTML;

                // 添加控制按钮
                fullscreenSelectorHeader.innerHTML = `
                    <button class="fullscreen-selector-back" id="fullscreenSelectorBack">
                        <span>←</span>
                        <span data-i18n-key="btn_back">返回</span>
                    </button>
                    <h2 class="fullscreen-selector-title" id="fullscreenSelectorTitle">选择调式</h2>
                    <div class="scale-controls" style="margin-left: auto; display: flex; gap: 8px;">
                        <button class="scale-control-btn" id="selectAllScales" data-i18n-key="select_all">全选</button>
                        <button class="scale-control-btn" id="deselectAllScales" data-i18n-key="deselect_all">全不选</button>
                        <button class="scale-control-btn" id="randomSelectScales" data-i18n-key="random_select">随机选择</button>
                    </div>
                `;

                // 使用window.scaleTypes对象组织音阶类型数据
                const scaleGroups = {
                    '基本调式': [
                        { value: 'major', title: 'Major', desc: '1 2 3 4 5 6 7' },
                        { value: 'minor', title: 'Minor', desc: '1 2 ♭3 4 5 ♭6 ♭7' }
                    ],
                    '教会调式 (Church Modes)': [
                        { value: 'ionian', title: 'Ionian', desc: '1 2 3 4 5 6 7' },
                        { value: 'dorian', title: 'Dorian', desc: '1 2 ♭3 4 5 6 ♭7' },
                        { value: 'phrygian', title: 'Phrygian', desc: '1 ♭2 ♭3 4 5 ♭6 ♭7' },
                        { value: 'lydian', title: 'Lydian', desc: '1 2 3 ♯4 5 6 7' },
                        { value: 'mixolydian', title: 'Mixolydian', desc: '1 2 3 4 5 6 ♭7' },
                        { value: 'aeolian', title: 'Aeolian', desc: '1 2 ♭3 4 5 ♭6 ♭7' },
                        { value: 'locrian', title: 'Locrian', desc: '1 ♭2 ♭3 4 ♭5 ♭6 ♭7' }
                    ],
                    '和声小调系列': [
                        { value: 'harmonicMinor', title: 'Harmonic Minor', desc: '1 2 ♭3 4 5 ♭6 7' },
                        { value: 'dorianSharp2', title: 'Dorian ♯2', desc: '1 ♯2 3 4 5 6 ♭7' },
                        { value: 'phrygianMajor', title: 'Phrygian Major', desc: '1 ♭2 3 4 5 ♭6 ♭7' },
                        { value: 'lydianSharp2', title: 'Lydian ♯2', desc: '1 ♯2 3 ♯4 5 6 7' },
                        { value: 'mixolydianFlat6', title: 'Mixolydian ♭6', desc: '1 2 3 4 5 ♭6 ♭7' },
                        { value: 'lydianFlat2', title: 'Lydian ♭2', desc: '1 ♭2 3 ♯4 5 6 7' },
                        { value: 'superLocrianDiminished', title: 'Super Locrian Dim', desc: '1 ♭2 ♭3 ♭4 ♭5 ♭6 6' }
                    ],
                    '旋律小调系列': [
                        { value: 'melodicMinor', title: 'Melodic Minor', desc: '1 2 ♭3 4 5 6 7' },
                        { value: 'melodicMinorDescending', title: 'Melodic Minor Desc', desc: '1 ♭7 ♭6 5 4 ♭3 2 1' },
                        { value: 'dorianFlat2', title: 'Dorian ♭2', desc: '1 ♭2 ♭3 4 5 6 ♭7' },
                        { value: 'lydianAugmented', title: 'Lydian Augmented', desc: '1 2 3 ♯4 ♯5 6 7' },
                        { value: 'lydianFlat7', title: 'Lydian ♭7', desc: '1 2 3 ♯4 5 6 ♭7' },
                        { value: 'aeolianFlat5', title: 'Aeolian ♭5', desc: '1 2 ♭3 4 ♭5 ♭6 ♭7' },
                        { value: 'superLocrian', title: 'Super Locrian', desc: '1 ♭2 ♭3 ♭4 ♭5 ♭6 ♭7' }
                    ],
                    '五声音阶': [
                        { value: 'majorPentatonic', title: 'Major Pentatonic', desc: '1 2 3 5 6' },
                        { value: 'minorPentatonic', title: 'Minor Pentatonic', desc: '1 ♭3 4 5 ♭7' },
                        { value: 'dorianPentatonic', title: 'Dorian Pentatonic', desc: '1 2 ♭3 5 6' },
                        { value: 'phrygianPentatonic', title: 'Phrygian Pentatonic', desc: '1 ♭2 4 5 ♭6' },
                        { value: 'mixolydianPentatonic', title: 'Mixolydian Pentatonic', desc: '1 2 3 5 ♭7' }
                    ],
                    '布鲁斯音阶': [
                        { value: 'blues', title: 'Blues', desc: '1 ♭3 4 ♯4 5 ♭7' },
                        { value: 'majorBlues', title: 'Major Blues', desc: '1 2 ♭3 3 5 6' }
                    ],
                    '特殊音阶': [
                        { value: 'wholeTone', title: 'Whole Tone', desc: '1 2 3 ♯4 ♯5 ♯6' },
                        { value: 'diminished', title: 'Diminished HW', desc: '1 ♭2 ♭3 3 ♯4 5 6 ♭7' },
                        { value: 'diminishedWhole', title: 'Diminished WH', desc: '1 2 ♭3 ♯4 ♯5 6 7' },
                        { value: 'arabic', title: 'Arabic', desc: '1 ♭2 3 4 5 ♭6 ♭7' },
                        { value: 'gypsy', title: 'Gypsy', desc: '1 ♭2 3 4 5 ♭6 7' },
                        { value: 'japanese', title: 'Japanese', desc: '1 ♭2 4 5 ♭6' },
                        { value: 'egyptian', title: 'Egyptian', desc: '1 2 4 5 ♭7' },
                        { value: 'hungarian', title: 'Hungarian', desc: '1 ♯2 3 ♯4 5 ♭6 7' },
                        { value: 'persian', title: 'Persian', desc: '1 ♭2 3 4 ♭5 ♭6 7' },
                        { value: 'byzantine', title: 'Byzantine', desc: '1 ♭2 3 4 5 ♭6 7' },
                        { value: 'enigmatic', title: 'Enigmatic', desc: '1 ♭2 3 ♯4 ♯5 ♯6 7' },
                        { value: 'neapolitan', title: 'Neapolitan', desc: '1 ♭2 ♭3 4 5 ♭6 7' },
                        { value: 'spanish', title: 'Spanish', desc: '1 ♭2 3 4 5 ♭6 ♭7' }
                    ]
                };

                let html = '<div class="selector-grid">';

                for (const [groupName, scales] of Object.entries(scaleGroups)) {
                    html += `<div class="selector-group-title">● ${groupName}</div>`;
                    html += '<div class="selector-group">';
                    scales.forEach(scale => {
                        const isActive = currentSelectedScales.includes(scale.value) ? 'active' : '';
                        html += `
                            <div class="selector-item ${isActive}" data-value="${scale.value}">
                                <div class="selector-item-title">${scale.title}</div>
                                <div class="selector-item-desc">${scale.desc}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;

                // 绑定控制按钮事件
                const allScales = [];
                for (const scales of Object.values(scaleGroups)) {
                    allScales.push(...scales.map(s => s.value));
                }

                document.getElementById('selectAllScales').addEventListener('click', () => {
                    const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                    items.forEach(item => item.classList.add('active'));
                    if (window.ScaleTypeManager) {
                        window.ScaleTypeManager.selectedScales.clear();
                        allScales.forEach(scale => window.ScaleTypeManager.selectedScales.add(scale));
                        window.ScaleTypeManager.updateHiddenSelect();
                        window.ScaleTypeManager.updateDisplayText();
                        window.ScaleTypeManager.updateArpeggioButtons();
                    }
                });

                document.getElementById('deselectAllScales').addEventListener('click', () => {
                    const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                    items.forEach(item => item.classList.remove('active'));
                    if (window.ScaleTypeManager) {
                        window.ScaleTypeManager.selectedScales.clear();
                        window.ScaleTypeManager.updateHiddenSelect();
                        window.ScaleTypeManager.updateDisplayText();
                        window.ScaleTypeManager.updateArpeggioButtons();
                    }
                });

                document.getElementById('randomSelectScales').addEventListener('click', () => {
                    const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                    items.forEach(item => item.classList.remove('active'));

                    // 随机选择3-8个调式
                    const randomCount = Math.floor(Math.random() * 6) + 3;
                    const shuffled = [...allScales].sort(() => Math.random() - 0.5);
                    const selected = shuffled.slice(0, randomCount);

                    items.forEach(item => {
                        if (selected.includes(item.dataset.value)) {
                            item.classList.add('active');
                        }
                    });

                    if (window.ScaleTypeManager) {
                        window.ScaleTypeManager.selectedScales.clear();
                        selected.forEach(scale => window.ScaleTypeManager.selectedScales.add(scale));
                        window.ScaleTypeManager.updateHiddenSelect();
                        window.ScaleTypeManager.updateDisplayText();
                        window.ScaleTypeManager.updateArpeggioButtons();
                    }
                });

                // 绑定调式选择点击事件（多选模式）
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;

                        // 切换选中状态
                        this.classList.toggle('active');

                        // 更新ScaleTypeManager的状态
                        if (window.ScaleTypeManager) {
                            if (this.classList.contains('active')) {
                                window.ScaleTypeManager.selectedScales.add(value);
                            } else {
                                window.ScaleTypeManager.selectedScales.delete(value);
                            }
                            window.ScaleTypeManager.updateHiddenSelect();
                            window.ScaleTypeManager.updateDisplayText();
                            window.ScaleTypeManager.updateArpeggioButtons();
                        }
                    });
                });

                // 滚动到第一个选中项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);

                // 返回时恢复原始header
                const originalBackHandler = fullscreenSelectorBack.onclick;
                const newBackHandler = function() {
                    // 恢复原始header内容
                    fullscreenSelectorHeader.innerHTML = originalButtons;
                    // 重新绑定返回按钮
                    const backBtn = fullscreenSelectorHeader.querySelector('.fullscreen-selector-back');
                    if (backBtn) {
                        backBtn.addEventListener('click', originalBackHandler);
                    }
                    // 关闭选择器
                    closeFullscreenSelector();
                };

                // 重新绑定返回按钮
                const backBtn = fullscreenSelectorHeader.querySelector('.fullscreen-selector-back');
                if (backBtn) {
                    backBtn.addEventListener('click', newBackHandler);
                }
            }
            
            // 生成和弦类型选择内容
            function generateChordTypeContent() {
                // 对于自定义和弦弹窗，使用当前选择的和弦类型值
                const currentValue = window.currentChordType;
                
                const chordTypes = {
                    '基础和弦': [
                        { value: 'major', text: '大三和弦' },
                        { value: 'minor', text: '小三和弦' },
                        { value: 'diminished', text: '减三和弦' },
                        { value: 'augmented', text: '增三和弦' }
                    ],
                    '六和弦': [
                        { value: 'major6', text: '大六和弦' },
                        { value: 'minor6', text: '小六和弦' }
                    ],
                    '七和弦': [
                        { value: 'dominant7', text: '属七和弦' },
                        { value: 'major7', text: '大七和弦' },
                        { value: 'minor7', text: '小七和弦' },
                        { value: 'minor7b5', text: '半减七和弦' },
                        { value: 'diminished7', text: '减七和弦' }
                    ],
                    '扩展和弦': [
                        { value: 'dominant9', text: '属九和弦' },
                        { value: 'major9', text: '大九和弦' },
                        { value: 'minor9', text: '小九和弦' },
                        { value: 'dominant7sharp9', text: '属7♯9和弦' },
                        { value: 'dominant7flat9', text: '属7♭9和弦' },
                        { value: 'dominant11', text: '属11和弦' },
                        { value: 'minor11', text: '小11和弦' },
                        { value: 'dominant7sharp11', text: '属7♯11和弦' },
                        { value: 'dominant13', text: '属13和弦' },
                        { value: 'minor13', text: '小13和弦' }
                    ],
                    '挂留和弦': [
                        { value: 'sus2', text: '挂二和弦' },
                        { value: 'sus4', text: '挂四和弦' }
                    ],
                    '加音和弦': [
                        { value: 'add9', text: '加九和弦' },
                        { value: 'madd9', text: '小加九和弦' },
                        { value: '6add9', text: '六加九和弦' },
                        { value: 'm6add9', text: '小六加九和弦' }
                    ]
                };
                
                let html = '<div class="selector-grid">';
                
                for (const [groupName, chords] of Object.entries(chordTypes)) {
                    html += `<div class="selector-group-title">● ${groupName}</div>`;
                    html += '<div class="selector-group">';
                    chords.forEach(chord => {
                        const isActive = chord.value === currentValue ? 'active' : '';
                        html += `
                            <div class="selector-item ${isActive}" data-value="${chord.value}">
                                <div class="selector-item-title">${chord.text}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        chordTypeSelect.value = value;
                        chordTypeSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // 滚动到当前选中项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }

            // 生成转位选择内容
            function generateCustomChordBassContent() {
                const currentValue = window.currentChordBass;
                
                const bassOptions = [
                    { value: 'root', text: '根音', desc: '原位和弦' },
                    { value: '3rd', text: '三音', desc: '第一转位' },
                    { value: '5th', text: '五音', desc: '第二转位' },
                    { value: '7th', text: '七音', desc: '第三转位' }
                ];

                let html = '<div class="selector-grid">';

                bassOptions.forEach(option => {
                    const isActive = option.value === currentValue ? 'active' : '';

                    html += `
                        <div class="selector-item ${isActive}" data-value="${option.value}">
                            <div class="selector-item-title">${option.text}</div>
                            <div class="selector-item-desc">${window.t ? window.t(option.desc) : option.desc}</div>
                        </div>
                    `;
                });

                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;

                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
            }
            
            // 生成找音练习时间选择内容
            function generatePitchFindingTimeContent() {
                const timeSelect = document.getElementById('pitchFindingTime');
                const currentValue = timeSelect.value;
                
                const times = [
                    { value: '1', text: '1分钟', desc: '快速练习' },
                    { value: '2', text: '2分钟', desc: '短时练习' },
                    { value: '3', text: '3分钟', desc: '常规练习' },
                    { value: '5', text: '5分钟', desc: '标准练习' },
                    { value: '10', text: '10分钟', desc: '深度练习' },
                    { value: '15', text: '15分钟', desc: '强化练习' },
                    { value: '30', text: '30分钟', desc: '专业练习' }
                ];
                
                let html = '<div class="selector-grid">';
                
                times.forEach(time => {
                    const isActive = time.value === currentValue ? 'active' : '';
                    html += `
                        <div class="selector-item ${isActive}" data-value="${time.value}">
                            <div class="selector-item-title">${time.text}</div>
                            <div class="selector-item-desc">${time.desc}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        timeSelect.value = value;
                        timeSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // 滚动到当前选中项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // 生成根音选择内容（音程练习）
            function generateRootNoteSelectContent() {
                const rootNoteSelect = document.getElementById('rootNoteSelect');
                const currentValue = rootNoteSelect.value;
                
                const notes = [
                    { value: 'random', text: '随机', desc: '随机根音' },
                    { value: 'C', text: 'C', desc: '' },
                    { value: 'C♯', text: 'C♯', desc: '' },
                    { value: 'D♭', text: 'D♭', desc: '' },
                    { value: 'D', text: 'D', desc: '' },
                    { value: 'D♯', text: 'D♯', desc: '' },
                    { value: 'E♭', text: 'E♭', desc: '' },
                    { value: 'E', text: 'E', desc: '' },
                    { value: 'F', text: 'F', desc: '' },
                    { value: 'F♯', text: 'F♯', desc: '' },
                    { value: 'G♭', text: 'G♭', desc: '' },
                    { value: 'G', text: 'G', desc: '' },
                    { value: 'G♯', text: 'G♯', desc: '' },
                    { value: 'A♭', text: 'A♭', desc: '' },
                    { value: 'A', text: 'A', desc: '' },
                    { value: 'A♯', text: 'A♯', desc: '' },
                    { value: 'B♭', text: 'B♭', desc: '' },
                    { value: 'B', text: 'B', desc: '' }
                ];
                
                let html = '<div class="selector-grid">';
                
                notes.forEach(note => {
                    const isActive = note.value === currentValue ? 'active' : '';
                    html += `
                        <div class="selector-item ${isActive}" data-value="${note.value}">
                            <div class="selector-item-title">${note.text}</div>
                            ${note.desc ? `<div class="selector-item-desc">${note.desc}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // 绑定点击事件
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        rootNoteSelect.value = value;
                        rootNoteSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // 滚动到当前选中项
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // 为select添加点击覆盖层的通用函数
            function addSelectOverlay(selectId, type, title) {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const wrapper = select.parentElement;
                if (!wrapper) return;
                
                // 检查是否已经添加过覆盖层
                if (wrapper.querySelector('.select-overlay')) return;
                
                const overlay = document.createElement('div');
                overlay.className = 'select-overlay';
                overlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    cursor: pointer;
                    z-index: 1;
                `;
                
                wrapper.style.position = 'relative';
                wrapper.appendChild(overlay);
                
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openFullscreenSelector(type, title, null, selectId);
                });
            }
            
            // 修改现有下拉框的点击事件
            document.addEventListener('DOMContentLoaded', function() {
                // 初始化自定义和弦弹窗
                initCustomChordsDialog();
                // 练习等级下拉框
                const progressionLevelDropdown = document.getElementById('progressionLevelDropdown');
                if (progressionLevelDropdown) {
                    const trigger = progressionLevelDropdown.querySelector('.dropdown-trigger');
                    if (trigger) {
                        // 移除原有事件，添加新事件
                        const newTrigger = trigger.cloneNode(true);
                        trigger.parentNode.replaceChild(newTrigger, trigger);
                        
                        newTrigger.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenSelector('progressionLevel', '练习等级', null);
                        });
                    }
                }
                
                // 乐曲下拉框
                const jazzStandardDropdown = document.getElementById('jazzStandardDropdown');
                if (jazzStandardDropdown) {
                    const trigger = jazzStandardDropdown.querySelector('.dropdown-trigger');
                    if (trigger) {
                        // 移除原有事件，添加新事件
                        const newTrigger = trigger.cloneNode(true);
                        trigger.parentNode.replaceChild(newTrigger, trigger);
                        
                        newTrigger.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenSelector('jazzStandard', '选择乐曲', null);
                        });
                    }
                }
                
                // 调性下拉框
                const progressionKeyDropdown = document.getElementById('progressionKeyDropdown');
                if (progressionKeyDropdown) {
                    const trigger = progressionKeyDropdown.querySelector('.dropdown-trigger');
                    if (trigger) {
                        // 移除原有事件，添加新事件
                        const newTrigger = trigger.cloneNode(true);
                        trigger.parentNode.replaceChild(newTrigger, trigger);
                        
                        newTrigger.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenSelector('progressionKey', '选择调性', null);
                        });
                    }
                }
                
                // 音阶设置 - 根音选择
                addSelectOverlay('rootNote', 'rootNote', '选择调性');

                // 音阶设置 - 音阶类型选择 - 已在ScaleTypeManager中处理全屏选择器
                
                // 和弦设置 - 和弦根音选择
                addSelectOverlay('chordRootNote', 'chordRootNote', '选择和弦根音');
                
                // 找音练习 - 练习时间
                addSelectOverlay('pitchFindingTime', 'pitchFindingTime', '选择练习时间');
                
                // 找音练习 - 根音设置
                addSelectOverlay('rootNoteSelect', 'rootNoteSelect', '选择根音');
            });
        })();
    </script>
    
    <script>
        // 测试自定义下拉列表初始化（已移除重复调用）
        console.log('页面加载完成，自定义下拉列表应该已经初始化');
    </script>


  </body>
</html>
