<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰ä»–æŒ‡æ¿è§†è§‰åŒ–ç»ƒä¹ å·¥å…·</title>
    <!-- ml5.jsåº“ - ç”¨äºCREPEéŸ³é«˜æ£€æµ‹ç®—æ³• -->
    <script src="js/ml5.min.js"></script>
    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="styles/main.css">
    <style>
        /* ä¿ç•™å°‘é‡ä»…åœ¨æ­¤é¡µé¢éœ€è¦çš„ç‰¹å®šæ ·å¼ */
        /* æƒé™æŒ‡å¯¼æ¨¡æ€æ¡†æ ·å¼ */
        .permission-guidance {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 40, 50, 0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            width: 80%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .permission-guidance h3 {
            margin-bottom: 15px;
            color: #3a9fc4;
        }

        .permission-guidance ol {
            margin-left: 20px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .permission-guidance button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        #refresh-page {
            background: #3a9fc4;
        }

        #dismiss-guidance {
            background: #6c757d;
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
            color: #e0e0e0;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(40, 40, 50, 0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
            padding-bottom: 15px;
        }

        h1 {
            color: #3a9fc4;
            margin-top: 40px;
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .instructions {
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .settings-panel {
            background: linear-gradient(to right, rgba(51, 51, 51, 0.8), rgba(60, 60, 70, 0.8));
            border-radius: 12px;
            padding: 0;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .settings-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 50, 0.8);
        }

        .settings-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .settings-tab.active {
            color: #3a9fc4;
            border-bottom: 2px solid #3a9fc4;
            background: rgba(128, 128, 128, 0.2);
        }

        .settings-content {
            margin-top: 20px;
            padding: 12px;
        }

        .settings-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #3a9fc4;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .settings-section-title i {
            margin-right: 10px;
            font-size: 20px;
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .settings-label {
            font-size: 14px;
            color: #e0e0e0;
            margin-bottom: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-label .info {
            color: #888;
            font-size: 14px;
        }

        .select-wrapper {
            position: relative;
            width: 100%;
        }

        .select-wrapper::after {
            content: "â–¼";
            font-size: 10px;
            color: #808080;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #fff;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            transition: all 0.2s;
        }

        select:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .switch-label {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #3a9fc4;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .chord-type-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(min-content, 1fr));
            gap: 8px;
            width: 100%;
        }


        .chord-type-btn {
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 0;
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .chord-type-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chord-type-btn.active {
            background-color: rgba(58, 159, 196, 0.2);
            color: #3a9fc4;
            border-color: #3a9fc4;
        }

        .order-btn-container {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .order-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-btn.active {
            background-color: rgba(58, 159, 196, 0.2);
            color: #3a9fc4;
            border-color: #3a9fc4;
        }

        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(to right, #4fc3f7, #29b6f6);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            flex: 1;
            max-width: 280px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .btn:disabled {
            background: linear-gradient(to right, #555, #666);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .chord-type-container {
                grid-template-columns: repeat(4, 1fr);
            }

            .settings-row {
                flex-direction: row;
                align-items: center;
            }

            .settings-label {
                min-width: 100px;
                margin-bottom: 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 24px;
            }

            .btn {
                padding: 16px 24px;
                font-size: 16px;
            }

            .settings-section-title {
                font-size: 16px;
            }

            .settings-tab {
                padding: 14px 12px;
                font-size: 14px;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.1s ease;
        }

        #practiceScreen.metronome-active {
            /* èŠ‚æ‹å™¨æ¿€æ´»çŠ¶æ€çš„åŸºç¡€æ ·å¼ */
            transition: background-color 0.1s ease;
        }



        .exercise-container {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.95), rgba(71, 85, 105, 0.95));
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }
        
        .song-title-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 100%;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.1);
        }
        
        .song-title {
            font-size: 28px;
            font-weight: bold;
            color: #60a5fa;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            letter-spacing: 0.5px;
        }

        .scale-info {
            margin-bottom: 24px;
        }

        .target-interval {
            font-size: 36px;
            font-weight: 700;
            color: #38bdf8;
            margin: 12px 0;
            text-shadow: 0 4px 8px rgba(56, 189, 248, 0.3);
            letter-spacing: -0.5px;
        }

        .sequence-display {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 0px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sequence-title {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .sequence-items {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 0;
            margin: 10px auto;
            width: 100%;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #ff8a00;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            background: rgba(51, 65, 85, 0.9);
            min-width: 36px;
            height: 36px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 0 1 auto;
        }

        .sequence-item.played {
            color: #64748b !important;
            background: rgba(30, 41, 59, 0.6) !important;
            box-shadow: none !important;
            border-color: rgba(100, 116, 139, 0.3);
            transform: scale(0.95);
        }

        .sequence-item.current {
            color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
        }

        .next-exercise {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            width: 100%;
            max-width: 600px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .next-label {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .next-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .next-content {
            font-size: 16px;
            color: #ff8a00;
            font-weight: 600;
            text-align: center;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-recording {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-weight: 600;
            color: #ff8a00;
        }

        .pitch-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .pitch-display.in-tune {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .pitch-display.out-of-tune {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .confidence-bar {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: #38bdf8;
            border-radius: 2px;
            transition: width 0.2s ease;
        }



        .device-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .gain-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .gain-control input {
            flex: 1;
        }

        .gain-value {
            min-width: 40px;
            text-align: right;
        }

        .usb-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #22c55e;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes metronomeFlash {
            0% {
                background-color: rgba(58, 159, 196, 0);
            }

            50% {
                background-color: rgba(58, 159, 196, 0.3);
            }

            100% {
                background-color: rgba(58, 159, 196, 0);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes metronomeFlash {
            0% {
                background-color: rgba(58, 159, 196, 0);
            }

            50% {
                background-color: rgba(58, 159, 196, 0.3);
            }

            100% {
                background-color: rgba(58, 159, 196, 0);
            }
        }

        .metronome-flash {
            animation: metronomeFlash 0.2s ease;
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.3s ease;
        }

        #practiceScreen.metronome-flash {
            background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            transition: background-color 0.1s ease;
        }

        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜... */

        @keyframes metronomeFlash {
            0% {
                background: linear-gradient(135deg, #0f172a, #1e293b);
            }

            20% {
                background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            }

            100% {
                background: linear-gradient(135deg, #0f172a, #1e293b);
            }
        }

        .metronome-flash {
            animation: metronomeFlash 0.3s ease;
        }
        
        /* æ‰‹æœºæ¨ªå±é€‚é… - è°ƒæ•´sequence-itemå­—ä½“å¤§å° */
        @media (max-height: 480px) and (orientation: landscape) {
            .sequence-item {
                font-size: 25px;
            }
            
            /* è¿›ä¸€æ­¥å‹ç¼©é¡µé¢å…ƒç´ ä¸Šä¸‹çš„margin */
            #practiceScreen {
                padding: 8px;
            }
            
            .exercise-container {
                padding: 16px 12px; /* å¢åŠ ä¸Šä¸‹paddingä½¿å†…å®¹æ›´èˆ’å±• */
                margin-bottom: 8px;
            }
            
            .scale-info {
                margin-bottom: 12px; /* å¢åŠ åº•éƒ¨margin */
            }
            
            .target-interval {
                font-size: 24px;
                margin: 10px 0; /* å¢åŠ ä¸Šä¸‹margin */
            }
            
            .sequence-display {
                padding: 12px 8px; /* å¢åŠ ä¸Šä¸‹padding */
                margin: 12px 0; /* å¢åŠ ä¸Šä¸‹margin */
            }
            
            .sequence-item {
                font-size: 25px;
                min-width: 30px;
                height: 34px;
                padding: 6px;
                margin: 14px; /* å¢åŠ å…ƒç´ é—´margin */
            }
            
            .next-exercise {
                margin: 12px 0; /* å¢åŠ ä¸Šä¸‹margin */
                padding: 12px 8px; /* å¢åŠ ä¸Šä¸‹padding */
            }
            
            .song-title-display {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .song-title {
                font-size: 22px;
            }
            
            .next-label {
                font-size: 12px;
                margin-bottom: 6px; /* å¢åŠ åº•éƒ¨margin */
            }
            
            .next-content {
                font-size: 14px;
            }
            
            /* æ¨ªå±æ¨¡å¼ä¸‹éšè—header */
            .header {
                display: none;
            }
            
            /* æ‰‹æœºæ¨¡å¼ä¸‹éšè—å¿«æ·é”®æç¤º */
            .shortcut-hint {
                display: none;
            }
        }
        
        /* æ‰‹æœºæ¨¡å¼ä¸‹éšè—å¿«æ·é”®æç¤ºï¼ˆè¦†ç›–æ‰€æœ‰æ‰‹æœºå°ºå¯¸ï¼‰ */
        @media (max-width: 768px) {
            .shortcut-hint {
                display: none !important;
            }
        }
        
        /* æ‰‹æœºæ¨¡å¼ä¸‹éšè—headerï¼ˆè¦†ç›–æ‰€æœ‰æ‰‹æœºå°ºå¯¸ï¼‰
        @media (max-width: 768px) {
            .header {
                display: none !important;
            }
        } */
        
        /* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(40, 40, 50, 0.95);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #aaa;
        }
        
        .nav-item.active {
            color: #3a9fc4;
        }
        
        /* é™ä½è½¬æ¢æŒ‰é’®çš„äº®åº¦ */
        .nav-item[data-tab="progression"] {
            color: #888;
        }
        
        .nav-item[data-tab="progression"].active {
            color: #2a7f94; /* è°ƒä½äº®åº¦çš„é¢œè‰² */
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* è°ƒæ•´ä¸»å®¹å™¨çš„åº•éƒ¨è¾¹è·ï¼Œä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        .container {
            margin-bottom: 60px;
        }
    </style>
</head>

<body>
    <!-- å…¶ä»–HTMLå†…å®¹ä¿æŒä¸å˜... -->
    <div class="status-indicator status-ready" id="statusIndicator">å‡†å¤‡å°±ç»ª</div>

    <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
    <div class="shortcut-hint" id="shortcutHint">
        æŒ‰ <span class="shortcut-key">ESC</span> è¿”å›ä¸»èœå•
    </div>

    <!-- å®æ—¶éŸ³é«˜æ˜¾ç¤º -->
    <div class="pitch-display" id="pitchDisplay" style="display: none;">
        <div>éŸ³é«˜: --</div>
        <div>éŸ³åˆ†å·®: 0</div>
        <div class="confidence-bar">
            <div class="confidence-fill" style="width: 0%"></div>
        </div>
    </div>

    <div class="container" id="mainScreen">
        <div class="header">
            <h1>ğŸ¸ å‰ä»–éŸ³é˜¶ä¸å’Œå¼¦ç»ƒä¹ å·¥å…· - æ”¯æŒUSBå£°å¡</h1>
            <div class="instructions">
                æ”¯æŒå‰ä»–é€šè¿‡USBå£°å¡è¾“å…¥è¿›è¡ŒéŸ³é«˜æ£€æµ‹ã€‚è¿æ¥æ‚¨çš„USBéŸ³é¢‘æ¥å£åï¼Œé€‰æ‹©å¯¹åº”çš„è®¾å¤‡å³å¯å¼€å§‹ç»ƒä¹ ã€‚
            </div>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <!-- è®¾ç½®å†…å®¹åŒºåŸŸ -->
            <div class="settings-content">


                <!-- å’Œå¼¦è®¾ç½® -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> å’Œå¼¦è®¾ç½®
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            æ ¹éŸ³
                            <span class="info">é€‰æ‹©å’Œå¼¦çš„æ ¹éŸ³</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="Dâ™­">Dâ™­</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="Eâ™­">Eâ™­</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="Gâ™­">Gâ™­</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="Aâ™­">Aâ™­</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="Bâ™­">Bâ™­</option>
                                <option value="B">B</option>
                                <option value="random" selected>éšæœºæ ¹éŸ³</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            å’Œå¼¦ç±»å‹
                            <span class="info">é€‰æ‹©è¦ç»ƒä¹ çš„å’Œå¼¦ç±»å‹</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">dim</div>
                            <div class="chord-type-btn" data-value="augmented">aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7â™­5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7â™¯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7â™­9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7â™¯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                            ç‚¹å‡»é€‰æ‹©è¦ç»ƒä¹ çš„å’Œå¼¦ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            é¡ºåº
                            <span class="info">é€‰æ‹©å’Œå¼¦éŸ³ç¬¦çš„æ¼”å¥é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">ä¸Šè¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="reverse">ä¸‹è¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="random">éšæœº</div>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œæ§ä»¶ -->
                    <div class="settings-row">
                        <div class="settings-label">
                            è‡ªå®šä¹‰å’Œå¼¦:
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="useCustomChords">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div id="customChordsControls" style="display: none; margin-top: 10px;">
                        <style>
        /* é‡ç½®è®¾ç½®æŒ‰é’®æ‚¬åœæ•ˆæœ */
        #resetSettingsBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #f87171, #ef4444) !important;
        }

        #resetSettingsBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* å…¶ä»–ç°æœ‰æ ·å¼ */
                            .custom-chord-add {
                                display: flex;
                                gap: 8px;
                                margin-bottom: 12px;
                            }

                            .custom-chord-add select {
                                width: 120px;
                                padding: 8px;
                                background: #2c2c3c;
                                border: 1px solid #555;
                                border-radius: 8px;
                                color: #fff;
                            }

                            .custom-chord-add button {
                                padding: 8px 12px;
                                background: linear-gradient(to right, #4fc3f7, #29b6f6);
                                border: none;
                                border-radius: 8px;
                                color: white;
                                cursor: pointer;
                            }

                            .custom-chord-list {
                                background: rgba(30, 41, 59, 0.5);
                                padding: 12px;
                                border-radius: 8px;
                                margin-top: 8px;
                            }

                            .custom-chord-actions {
                                display: flex;
                                gap: 8px;
                                margin-top: 12px;
                            }

                            .custom-chord-actions {
                                display: flex;
                                gap: 8px;
                                margin-top: 12px;
                            }

                            .custom-chord-actions button {
                                flex: 1;
                                padding: 8px;
                                background: #2c2c3c;
                                border: 1px solid #555;
                                border-radius: 6px;
                                color: #aaa;
                                cursor: pointer;
                                min-width: 40px;
                            }

                            .custom-chord-actions button:hover {
                                background: rgba(58, 159, 196, 0.2);
                                color: #3a9fc4;
                                border-color: #3a9fc4;
                            }

                            #customChordSequence {
                                display: flex;
                                flex-wrap: wrap;
                                gap: 6px;
                                margin-top: 8px;
                            }


                            .chord-item {
                            display: inline-block;
                            margin: 5px;
                            padding: 5px 10px;
                            background: rgba(58, 159, 196, 0.2);
                            border-radius: 4px;
                            }

                            /* .chord-item {
                                display: flex;
                                justify-content: space-between;
                                padding: 6px 8px;
                                background: rgba(51, 65, 85, 0.7);
                                border-radius: 4px;
                                min-width: 60px;
                                max-width: 100px;
                                flex: 1 0 auto;
                            } */

                            .remove-chord {
                                background: transparent;
                                border: none;
                                color: #ff6b6b;
                                cursor: pointer;
                                font-weight: bold;
                            }

                            .sequence-dialog {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: rgba(40, 40, 50, 0.95);
                                padding: 20px;
                                border-radius: 12px;
                                z-index: 2000;
                                width: 80%;
                                max-width: 400px;
                                backdrop-filter: blur(10px);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                            }

                            .sequence-item-dialog {
                                padding: 10px;
                                margin: 8px 0;
                                background: rgba(51, 65, 85, 0.7);
                                border-radius: 8px;
                                cursor: pointer;
                            }

                            .sequence-item-dialog:hover {
                                background: rgba(58, 159, 196, 0.3);
                            }
                        </style>
                        <div class="custom-chord-add">
                            <select id="customChordRoot">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="B">B</option>
                            </select>
                            <select id="customChordType">
                                <option value="major">å¤§ä¸‰å’Œå¼¦</option>
                                <option value="minor">å°ä¸‰å’Œå¼¦</option>
                                <option value="diminished">å‡ä¸‰å’Œå¼¦</option>
                                <option value="augmented">å¢ä¸‰å’Œå¼¦</option>
                                <option value="major6">å¤§å…­å’Œå¼¦</option>
                                <option value="minor6">å°å…­å’Œå¼¦</option>
                                <option value="dominant7">å±ä¸ƒå’Œå¼¦</option>
                                <option value="major7">å¤§ä¸ƒå’Œå¼¦</option>
                                <option value="minor7">å°ä¸ƒå’Œå¼¦</option>
                                <option value="minor7b5">åŠå‡ä¸ƒå’Œå¼¦</option>
                                <option value="diminished7">å‡ä¸ƒå’Œå¼¦</option>
                                <option value="dominant9">å±ä¹å’Œå¼¦</option>
                                <option value="major9">å¤§ä¹å’Œå¼¦</option>
                                <option value="minor9">å°ä¹å’Œå¼¦</option>
                                <option value="dominant7sharp9">å±7â™¯9å’Œå¼¦</option>
                                <option value="dominant7flat9">å±7â™­9å’Œå¼¦</option>
                                <option value="dominant11">å±11å’Œå¼¦</option>
                                <option value="minor11">å°11å’Œå¼¦</option>
                                <option value="dominant7sharp11">å±7â™¯11å’Œå¼¦</option>
                                <option value="dominant13">å±13å’Œå¼¦</option>
                                <option value="minor13">å°13å’Œå¼¦</option>
                                <option value="sus2">æŒ‚äºŒå’Œå¼¦</option>
                                <option value="sus4">æŒ‚å››å’Œå¼¦</option>
                                <option value="add9">åŠ ä¹å’Œå¼¦</option>
                                <option value="madd9">å°åŠ ä¹å’Œå¼¦</option>
                                <option value="6add9">å…­åŠ ä¹å’Œå¼¦</option>
                                <option value="m6add9">å°å…­åŠ ä¹å’Œå¼¦</option>
                            </select>
                            <button id="addCustomChord">æ·»åŠ å’Œå¼¦</button>
                        </div>

                        <div class="custom-chord-list">
                            <div class="settings-label">è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ:</div>
                            <div class="sequence-name-input" style="margin-bottom: 8px;">
                                <input type="text" id="sequenceName" placeholder="è¯·è¾“å…¥æ­Œæ›²åï¼ˆå¯é€‰ï¼‰"
                                    style="width: 100%; height:25px;margin-top: 8px; padding: 4px; border: none; border-radius: 4px; background-color: rgba(255, 255, 255, 0.1); color: white;" />
                            </div>
                            <div id="customChordSequence"></div>
                            <div class="custom-chord-actions">
                                <button id="clearCustomChords">æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ</button>
                                <button id="saveCustomChords">ä¿å­˜å’Œå¼¦è¿›è¡Œåˆ°æœ¬åœ°</button>
                                <button id="loadLocalChords">åŠ è½½æœ¬åœ°å’Œå¼¦è¿›è¡Œ</button>
                                <button id="loadSequence">åŠ è½½åºåˆ—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å’Œå¼¦è½¬æ¢è®¾ç½® -->
                <div class="settings-section progression-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> è½¬æ¢è®¾ç½®
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            ç»ƒä¹ ç­‰çº§
                            <span class="info">é€‰æ‹©å’Œå¼¦å¤æ‚åº¦</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="progressionLevel">
                                <optgroup label="å•å’Œå¼¦éŸ³">
                                    <option value="single-root">1</option>
                                    <option value="single-3">3</option>
                                    <option value="single-5">5</option>
                                    <option value="single-7">7</option>
                                </optgroup>
                                <optgroup label="åŒå’Œå¼¦éŸ³">
                                    <option value="double-root-3">1,3</option>
                                    <option value="double-root-5">1,5</option>
                                    <option value="double-root-7">1,7</option>
                                    <option value="double-3-5">3,5</option>
                                    <option value="double-3-7">3,7</option>
                                </optgroup>
                                <optgroup label="ä¸‰å’Œå¼¦éŸ³">
                                    <option value="triple-root-3-5" selected>1,3,5</option>
                                    <option value="triple-3-5-7">3,5,7</option>
                                    <option value="triple-random-inversion">1,3,5éšæœºè½¬ä½</option>
                                </optgroup>
                                <optgroup label="å››å’Œå¼¦éŸ³">
                                    <option value="quad-root-3-5-7">1,3,5,7</option>
                                    <option value="quad-3-5-7-root">3,5,7,1</option>
                                    <option value="quad-5-7-root-3">5,7,1,3</option>
                                    <option value="quad-7-root-3-5">7,1,3,5</option>
                                    <option value="quad-random-inversion">1,3,5,7éšæœºè½¬ä½</option>
                                    <option value="quad-root-3-5-7-root">1,3,5,7,1</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            å’Œå¼¦è½¬æ¢
                            <span class="info">é€‰æ‹©ç»å…¸çˆµå£«ä¹æ­Œæ›²</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="jazzStandard">
                                
                                <optgroup label="5">
                                    <option value="500 Miles High">500 Miles High</option>
                                </optgroup>
                                <optgroup label="A">
                                    <option value="All The Things You Are">All The Things You Are</option>
                                    <option value="Autumn Leaves">Autumn Leaves</option>
                                    <option value="All Of Me">All Of Me</option>
                                    <option value="A Night In Tunisia">A Night In Tunisia</option>
                                    <option value="All of You">All of You</option>
                                    <option value="Alone Together">Alone Together</option>
                                    <option value="Ambleside">Ambleside</option>
                                    <option value="Anthropology">Anthropology</option>
                                    <option value="Ask Me Now">Ask Me Now</option>
                                </optgroup>
                                <optgroup label="B">
                                    <option value="Blue Moon">Blue Moon</option>
                                    <option value="Body And Soul">Body And Soul</option>
                                    <option value="Bye Bye Blackbird">Bye Bye Blackbird</option>
                                    <option value="Beautiful Love">Beautiful Love</option>
                                    <option value="Blue Bossa">Blue Bossa</option>
                                    <option value="Blue in Green">Blue in Green</option>
                                    <option value="Blues for Alice">Blues for Alice</option>
                                </optgroup>
                                <optgroup label="C">
                                    <option value="Cherokee">Cherokee</option>
                                    <option value="Come Rain Or Come Shine">Come Rain Or Come Shine</option>
                                    <option value="Confirmation">Confirmation</option>
                                    <option value="Coral">Coral</option>
                                    <option value="Corcovado">Corcovado</option>
                                    <option value="Countdown">Countdown</option>
                                </optgroup>
                                <optgroup label="D">
                                    <option value="Days Of Wine And Roses">Days Of Wine And Roses</option>
                                    <option value="Donna Lee">Donna Lee</option>
                                    <option value="Doxy">Doxy</option>
                                    <option value="Dream A Little Dream">Dream A Little Dream</option>
                                </optgroup>
                                <optgroup label="F">
                                    <option value="Fall">Fall</option>
                                    <option value="Falling Grace">Falling Grace</option>
                                    <option value="Fly Me To The Moon">Fly Me To The Moon</option>
                                    <option value="Four">Four</option>
                                    <option value="Footprints">Footprints</option>
                                </optgroup>
                                <optgroup label="G">
                                    <option value="Giant Steps">Giant Steps</option>
                                    <option value="Georgia On My Mind">Georgia On My Mind</option>
                                    <option value="Girl From Ipanema">Girl From Ipanema</option>
                                </optgroup>
                                <optgroup label="H">
                                    <option value="Have You Met Miss Jones">Have You Met Miss Jones</option>
                                    <option value="Here's That Rainy Day">Here's That Rainy Day</option>
                                    <option value="How High The Moon">How High The Moon</option>
                                </optgroup>
                                <optgroup label="I">
                                    <option value="I Got Rhythm">I Got Rhythm</option>
                                    <option value="I Can't Get Started">I Can't Get Started</option>
                                    <option value="In A Sentimental Mood">In A Sentimental Mood</option>
                                    <option value="Infant Eyes">Infant Eyes</option>
                                    <option value="Inner Urge">Inner Urge</option>
                                </optgroup>
                                <optgroup label="J">
                                    <option value="Just Friends">Just Friends</option>
                                    <option value="Joy Spring">Joy Spring</option>
                                    <option value="Jordu">Jordu</option>
                                </optgroup>
                                <optgroup label="L">
                                    <option value="Lady Bird">Lady Bird</option>
                                    <option value="Love For Sale">Love For Sale</option>
                                    <option value="Lover Man">Lover Man</option>
                                </optgroup>
                                <optgroup label="M">
                                    <option value="Misty">Misty</option>
                                    <option value="My Funny Valentine">My Funny Valentine</option>
                                    <option value="Maiden Voyage">Maiden Voyage</option>
                                </optgroup>
                                <optgroup label="N">
                                    <option value="Night And Day">Night And Day</option>
                                    <option value="Nardis">Nardis</option>
                                    <option value="Night Train">Night Train</option>
                                </optgroup>
                                <optgroup label="O">
                                    <option value="Oleo">Oleo</option>
                                </optgroup>
                                <optgroup label="S">
                                    <option value="Someday My Prince Will Come">Someday My Prince Will Come</option>
                                    <option value="Spain">Spain</option>
                                    <option value="Stella By Starlight">Stella By Starlight</option>
                                    <option value="Summertime">Summertime</option>
                                    <option value="Solar">Solar</option>
                                </optgroup>
                                <optgroup label="T">
                                    <option value="Take Five">Take Five</option>
                                    <option value="Take the A-Train">Take the A-Train</option>
                                    <option value="The Girl From Ipanema">The Girl From Ipanema</option>
                                    <option value="There Will Never Be Another You">There Will Never Be Another You</option>
                                    <option value="The Way You Look Tonight">The Way You Look Tonight</option>
                                    <option value="Time Remembered">Time Remembered</option>
                                </optgroup>
                                <optgroup label="V">
                                    <option value="Very Early">Very Early</option>
                                    <option value="Virgo">Virgo</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            é¡ºåº
                            <span class="info">é€‰æ‹©å’Œå¼¦è¿›è¡Œçš„æ¼”å¥é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn progression-order-btn active" data-value="ordered">é¡ºåº</div>
                            <div class="order-btn progression-order-btn" data-value="reverse">å€’åº</div>
                            <div class="order-btn progression-order-btn" data-value="random">éšæœº</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            é‡å¤ç»ƒä¹ 
                            <span class="info">å¼€å¯åå¯¹æ­Œæ›²è¿›è¡Œé‡å¤ç»ƒä¹ </span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="enableRepeat">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            è°ƒ
                            <span class="info">é€‰æ‹©ç»ƒä¹ çš„è°ƒæ€§</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="progressionKey">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="Dâ™­">Dâ™­</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="Eâ™­">Eâ™­</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="Gâ™­">Gâ™­</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="Aâ™­">Aâ™­</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="Bâ™­">Bâ™­</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- è®¾ç½® -->
                <div class="settings-section device-settings" style="display:none;">
                    <div class="settings-section-title">
                        <i>ğŸ¤</i> éŸ³é¢‘è¾“å…¥è®¾ç½®
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            éŸ³é¢‘è¾“å…¥è®¾å¤‡
                            <span class="info">é€‰æ‹©å‰ä»–è¿æ¥çš„å£°å¡è®¾å¤‡</span>
                        </div>

                    </div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <select id="audioInputDevice" style="width: 70%; padding: 8px; border-radius: 4px;"></select>
                        <button class="btn" id="refreshDevicesBtn"
                            style="width: 25%; padding: 8px; font-size: 14px; margin-left: 10px;">åˆ·æ–°è®¾å¤‡åˆ—è¡¨</button>
                    </div>

                    <div class="device-info" id="deviceInfo">
                        æ£€æµ‹åˆ°è®¾å¤‡åï¼Œè¯·é€‰æ‹©æ‚¨çš„USBéŸ³é¢‘æ¥å£
                    </div>
                    <div class="settings-row" style="margin-top: 12px;">
                        <div class="settings-label">
                            è¾“å…¥å¢ç›Š
                            <span class="info">è°ƒèŠ‚è¾“å…¥éŸ³é‡å¤§å°</span>
                        </div>
                        <div class="gain-control">
                            <input type="range" id="inputGain" min="0" max="200" value="100">
                            <span class="gain-value" id="inputGainValue">100%</span>
                        </div>
                    </div>

                    <div class="settings-row" style="margin-top: 12px;">
                        <div class="settings-label">
                            éŸ³é«˜æ£€æµ‹æ•æ„Ÿåº¦
                            <span class="info">è°ƒèŠ‚éŸ³é«˜è¯†åˆ«çš„æ•æ„Ÿç¨‹åº¦ï¼ˆ0.1-1.0ï¼‰</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 100%;">
                            <input type="range" id="sensitivity" min="0.1" max="1.0" step="0.1" value="0.5"
                                style="flex: 1;">
                            <span id="sensitivityValue"
                                style="min-width: 40px; text-align: right; font-size: 14px;">0.5</span>
                        </div>
                    </div>

                    <div class="settings-row" style="margin-bottom: 12px;">
                        <div class="settings-label">
                            ç½®ä¿¡åº¦é˜ˆå€¼
                            <span class="info">éŸ³é«˜è¯†åˆ«çš„å¯ä¿¡åº¦è¦æ±‚ï¼ˆ0.3-0.9ï¼‰</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 100%;">
                            <input type="range" id="confidenceThreshold" min="0.3" max="0.9" step="0.1" value="0.6"
                                style="flex: 1;">
                            <span id="confidenceThresholdValue"
                                style="min-width: 40px; text-align: right; font-size: 14px;">0.6</span>
                        </div>
                    </div>

                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>âš™ï¸</i> ç»ƒä¹ è®¾ç½®
                    </div>
                    
                    <!-- å†·å´æ—¶é—´è®¾ç½® -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">éº¦å…‹é£å†·å´æ—¶é—´</span>
                            <label class="switch">
                                <input type="checkbox" id="enableCooldown" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">æ—¶é—´:</span>
                            <input type="range" id="cooldownDuration" min="200" max="3000" step="100" value="600"
                                style="width: 65%; margin-right: 3px;">
                            <span id="cooldownDurationValue"
                                style="min-width: 50px; text-align: right; font-size: 14px;">600ms</span>
                        </div>
                    </div>

                    <!-- å›ºå®šå»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜è®¾ç½® -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜</span>
                            <label class="switch">
                                <input type="checkbox" id="enableFixedDelay">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">æ—¶é—´:</span>
                            <input type="range" id="fixedDelayDuration" min="500" max="2000" step="100" value="800"
                                style="width: 65%; margin-right: 3px;">
                            <span id="fixedDelayDurationValue"
                                style="min-width: 50px; text-align: right; font-size: 14px;">800ms</span>
                        </div>
                    </div>



                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>ğŸ¯</i> èŠ‚æ‹å™¨è®¾ç½®
                    </div>
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">å¯ç”¨èŠ‚æ‹å™¨</span>
                            <label class="switch">
                                <input type="checkbox" id="metronomeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">é€Ÿåº¦:</span>
                            <input type="range" id="metronomeTempo" min="20" max="120" step="1" value="40"
                                style="width: 65%; margin-right: 3px;">
                            <span id="metronomeTempoValue"
                                style="min-width: 25px; text-align: right; font-size: 14px;">40</span>
                        </div>
                    </div>
                    
                    <!-- èŠ‚æ‹å™¨é€‰é¡¹ -->
                    <div style="display: flex; gap: 15px; margin-bottom: 12px; margin-left: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="metronomeFlashToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label" style="font-size: 14px;">èƒŒæ™¯é—ªå…‰</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="metronomeSoundToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label" style="font-size: 14px;">å£°éŸ³èŠ‚æ‹</span>
                        </div>
                    </div>
                    
                    <!-- è®¾ç½®ç®¡ç† -->
                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>ğŸ˜</i> è®¾ç½®ç®¡ç†
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button id="resetSettingsBtn" 
                            style="flex: 1; padding: 12px; background: linear-gradient(to right, #ef4444, #dc2626); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.2s; font-size: 14px;">
                            é‡ç½®æ‰€æœ‰è®¾ç½®
                        </button>
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                        ç‚¹å‡»é‡ç½®æŒ‰é’®å°†æ¢å¤æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼
                    </div>
                </div>

                <!-- éŸ³é˜¶è®¾ç½® - åªåœ¨éŸ³é˜¶ç»ƒä¹ æ ‡ç­¾é¡µæ˜¾ç¤º -->
                <div class="settings-section scale-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>ğŸµ</i> éŸ³é˜¶è®¾ç½®
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            è°ƒ
                            <span class="info">é€‰æ‹©è°ƒ</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="rootNote">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="Dâ™­">Dâ™­</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="Eâ™­">Eâ™­</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="Gâ™­">Gâ™­</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="Aâ™­">Aâ™­</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="Bâ™­">Bâ™­</option>
                                <option value="B">B</option>
                                <option value="random" selected>éšæœº</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            è°ƒå¼
                            <span class="info">é€‰æ‹©éŸ³é˜¶è°ƒå¼</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="scaleType">
                                <optgroup label="åŸºæœ¬è°ƒå¼">
                                    <option value="major">Major</option>
                                    <option value="minor">Minor</option>
                                </optgroup>
                                
                                <optgroup label="æ•™ä¼šè°ƒå¼ (Church Modes)">
                                    <option value="ionian">Ionian - 1 2 3 4 5 6 7</option>
                                    <option value="dorian">Dorian - 1 2 â™­3 4 5 6 â™­7</option>
                                    <option value="phrygian">Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7</option>
                                    <option value="lydian">Lydian - 1 2 3 â™¯4 5 6 7</option>
                                    <option value="mixolydian">Mixolydian - 1 2 3 4 5 6 â™­7</option>
                                    <option value="aeolian">Aeolian - 1 2 â™­3 4 5 â™­6 â™­7</option>
                                    <option value="locrian">Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7</option>
                                </optgroup>
                                
                                <optgroup label="å’Œå£°å°è°ƒç³»åˆ—">
                                    <option value="harmonicMinor">Harmonic Minor - 1 2 â™­3 4 5 â™­6 7</option>
                                    <option value="dorianSharp2">Dorian â™¯2 - 1 â™¯2 â™­3 4 5 6 â™­7</option>
                                    <option value="phrygianMajor">Phrygian Major - 1 â™­2 3 4 5 â™­6 â™­7</option>
                                    <option value="lydianSharp2">Lydian â™¯2 - 1 â™¯2 3 â™¯4 5 6 7</option>
                                    <option value="mixolydianFlat6">Mixolydian â™­6 - 1 2 3 4 5 â™­6 â™­7</option>
                                    <option value="lydianFlat2">Lydian â™­2 - 1 â™­2 3 â™¯4 5 6 7</option>
                                    <option value="superLocrianDiminished">Super Locrian Diminished - 1 â™­2 â™­3 â™­4 â™­5 â™­6 6</option>
                                </optgroup>
                                
                                <optgroup label="æ—‹å¾‹å°è°ƒç³»åˆ—">
                                    <option value="melodicMinor">Melodic Minor - 1 2 â™­3 4 5 6 7</option>
                                    <option value="dorianFlat2">Dorian â™­2 - 1 â™­2 â™­3 4 5 6 â™­7</option>
                                    <option value="lydianAugmented">Lydian Augmented - 1 2 3 â™¯4 â™¯5 6 7</option>
                                    <option value="lydianFlat7">Lydian â™­7 - 1 2 3 â™¯4 5 6 â™­7</option>
                                    <option value="aeolianFlat5">Aeolian â™­5 - 1 2 â™­3 4 â™­5 â™­6 â™­7</option>
                                    <option value="superLocrian">Super Locrian - 1 â™­2 â™­3 â™­4 â™­5 â™­6 â™­7</option>
                                </optgroup>
                                
                                <optgroup label="äº”å£°éŸ³é˜¶">
                                    <option value="majorPentatonic">Major Pentatonic - 1 2 3 5 6</option>
                                    <option value="minorPentatonic">Minor Pentatonic - 1 â™­3 4 5 â™­7</option>
                                    <option value="dorianPentatonic">Dorian Pentatonic - 1 2 â™­3 5 6</option>
                                    <option value="phrygianPentatonic">Phrygian Pentatonic - 1 â™­2 4 5 â™­6</option>
                                    <option value="mixolydianPentatonic">Mixolydian Pentatonic - 1 2 3 5 â™­7</option>
                                </optgroup>
                                
                                <optgroup label="å¸ƒé²æ–¯éŸ³é˜¶">
                                    <option value="blues">Blues - 1 â™­3 4 â™¯4 5 â™­7</option>
                                    <option value="majorBlues">Major Blues - 1 2 â™­3 3 5 6</option>
                                </optgroup>
                                
                                <optgroup label="ç‰¹æ®ŠéŸ³é˜¶">
                                    <option value="wholeTone">Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6</option>
                                    <option value="diminished">Diminished (Half-Whole) - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7</option>
                                    <option value="diminishedWhole">Diminished (Whole-Half) - 1 2 â™­3 4 â™¯4 â™¯5 6 7</option>
                                    <option value="chromatic">Chromatic - 1 â™­2 2 â™­3 3 4 â™¯4 5 â™­6 6 â™­7 7</option>
                                </optgroup>
                                
                                <optgroup label="å¼‚å›½é£æ ¼">
                                    <option value="arabic">Arabic - 1 â™­2 3 4 5 â™­6 â™­7</option>
                                    <option value="gypsy">Gypsy - 1 â™­2 3 4 5 â™­6 7</option>
                                    <option value="japanese">Japanese - 1 â™­2 4 5 â™­6</option>
                                    <option value="egyptian">Egyptian - 1 2 4 5 â™­7</option>
                                    <option value="hungarian">Hungarian - 1 â™¯2 â™­3 â™¯4 5 â™­6 7</option>
                                    <option value="persian">Persian - 1 â™­2 3 4 â™­5 â™­6 7</option>
                                    <option value="byzantine">Byzantine - 1 â™­2 3 4 5 â™­6 7</option>
                                    <option value="enigmatic">Enigmatic - 1 â™­2 3 â™¯4 â™¯5 â™¯6 7</option>
                                    <option value="neapolitan">Neapolitan - 1 â™­2 â™­3 4 5 â™­6 7</option>
                                    <option value="spanish">Spanish - 1 â™­2 3 4 5 â™­6 â™­7</option>
                                </optgroup>
                                
                                <option value="random" selected>éšæœºè°ƒå¼</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            æ–¹å‘
                            <span class="info">é€‰æ‹©éŸ³é˜¶æ–¹å‘</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-order-btn active" data-value="ordered">ä¸Šè¡Œ</div>
                            <div class="order-btn scale-order-btn" data-value="reverse">ä¸‹è¡Œ</div>
                            <div class="order-btn scale-order-btn" data-value="random">éšæœº</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            ç»ƒä¹ åºåˆ—
                            <span class="info">é€‰æ‹©ç»ƒä¹ åºåˆ—æ¨¡å¼</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-arpeggio-btn active" data-value="1to1">1â†’1</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="3to3" id="arpeggio-3-btn">3â†’3</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="5to5" id="arpeggio-5-btn">5â†’5</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="7to7" id="arpeggio-7-btn">7â†’7</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="random-arpeggio">éšæœº</div>
                        </div>
                    </div>

                    <script>
                    // ç›´æ¥åœ¨é¡µé¢ä¸­å®šä¹‰scaleTypeså¯¹è±¡ï¼Œé¿å…æ¨¡å—å¯¼å…¥é—®é¢˜
                    window.scaleTypes = {
                        // å¤§è°ƒç³»åˆ—
                        'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'minor': { name: 'Minor', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                        
                        // æ•™ä¼šè°ƒå¼ (Church Modes)
                        'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'dorian': { name: 'Dorian - 1 2 â™­3 4 5 6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', '6', 'â™­7'] },
                        'phrygian': { name: 'Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                        'lydian': { name: 'Lydian - 1 2 3 â™¯4 5 6 7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', '7'] },
                        'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 â™­7', intervals: ['1', '2', '3', '4', '5', '6', 'â™­7'] },
                        'aeolian': { name: 'Aeolian - 1 2 â™­3 4 5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                        'locrian': { name: 'Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                        
                        // å’Œå£°å°è°ƒç³»åˆ—
                        'harmonicMinor': { name: 'Harmonic Minor - 1 2 â™­3 4 5 â™­6 7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', '7'] },
                        'dorianSharp2': { name: 'Dorian â™¯2 - 1 â™¯2 â™­3 4 5 6 â™­7', intervals: ['1', 'â™¯2', 'â™­3', '4', '5', '6', 'â™­7'] },
                        'phrygianMajor': { name: 'Phrygian Major - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                        'lydianSharp2': { name: 'Lydian â™¯2 - 1 â™¯2 3 â™¯4 5 6 7', intervals: ['1', 'â™¯2', '3', 'â™¯4', '5', '6', '7'] },
                        'mixolydianFlat6': { name: 'Mixolydian â™­6 - 1 2 3 4 5 â™­6 â™­7', intervals: ['1', '2', '3', '4', '5', 'â™­6', 'â™­7'] },
                        'lydianFlat2': { name: 'Lydian â™­2 - 1 â™­2 3 â™¯4 5 6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', '5', '6', '7'] },
                        'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 â™­2 â™­3 â™­4 â™­5 â™­6 6', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', '6'] },
                        
                        // æ—‹å¾‹å°è°ƒç³»åˆ—
                        'melodicMinor': { name: 'Melodic Minor - 1 2 â™­3 4 5 6 7', intervals: ['1', '2', 'â™­3', '4', '5', '6', '7'] },
                        'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 â™­7 â™­6 5 4 â™­3 2 1', intervals: ['1', 'â™­7', 'â™­6', '5', '4', 'â™­3', '2', '1'] },
                        'dorianFlat2': { name: 'Dorian â™­2 - 1 â™­2 â™­3 4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', '6', 'â™­7'] },
                        'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 â™¯4 â™¯5 6 7', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', '6', '7'] },
                        'lydianFlat7': { name: 'Lydian â™­7 - 1 2 3 â™¯4 5 6 â™­7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', 'â™­7'] },
                        'aeolianFlat5': { name: 'Aeolian â™­5 - 1 2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                        'superLocrian': { name: 'Super Locrian - 1 â™­2 â™­3 â™­4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', 'â™­7'] },
                        
                        // äº”å£°éŸ³é˜¶ç³»åˆ—
                        'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                        'minorPentatonic': { name: 'Minor Pentatonic - 1 â™­3 4 5 â™­7', intervals: ['1', 'â™­3', '4', '5', 'â™­7'] },
                        'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 â™­3 5 6', intervals: ['1', '2', 'â™­3', '5', '6'] },
                        'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                        'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 â™­7', intervals: ['1', '2', '3', '5', 'â™­7'] },
                        
                        // å¸ƒé²æ–¯éŸ³é˜¶ç³»åˆ—
                        'blues': { name: 'Blues - 1 â™­3 4 â™¯4 5 â™­7', intervals: ['1', 'â™­3', '4', 'â™¯4', '5', 'â™­7'] },
                        'majorBlues': { name: 'Major Blues - 1 2 â™­3 3 5 6', intervals: ['1', '2', 'â™­3', '3', '5', '6'] },
                        
                        // å…¶ä»–å¸¸è§éŸ³é˜¶
                        'wholeTone': { name: 'Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', 'â™¯6'] },
                        'diminished': { name: 'Diminished (Half-Whole) - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '3', 'â™¯4', '5', '6', 'â™­7'] },
                        'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 â™­3 4 â™¯4 â™¯5 6 7', intervals: ['1', '2', 'â™­3', '4', 'â™¯4', 'â™¯5', '6', '7'] },
                        'chromatic': { name: 'Chromatic - 1 â™­2 2 â™­3 3 4 â™¯4 5 â™­6 6 â™­7 7', intervals: ['1', 'â™­2', '2', 'â™­3', '3', '4', 'â™¯4', '5', 'â™­6', '6', 'â™­7', '7'] },
                        
                        // å¼‚å›½é£æ ¼éŸ³é˜¶
                        'arabic': { name: 'Arabic - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                        'gypsy': { name: 'Gypsy - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                        'japanese': { name: 'Japanese - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                        'egyptian': { name: 'Egyptian - 1 2 4 5 â™­7', intervals: ['1', '2', '4', '5', 'â™­7'] },
                        'hungarian': { name: 'Hungarian - 1 â™¯2 â™­3 â™¯4 5 â™­6 7', intervals: ['1', 'â™¯2', 'â™­3', 'â™¯4', '5', 'â™­6', '7'] },
                        'persian': { name: 'Persian - 1 â™­2 3 4 â™­5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', 'â™­5', 'â™­6', '7'] },
                        'byzantine': { name: 'Byzantine - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                        'enigmatic': { name: 'Enigmatic - 1 â™­2 3 â™¯4 â™¯5 â™¯6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', 'â™¯5', 'â™¯6', '7'] },
                        'neapolitan': { name: 'Neapolitan - 1 â™­2 â™­3 4 5 â™­6 7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', '7'] },
                        'spanish': { name: 'Spanish - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] }
                    };
                    </script>
                    
                    <script>
                    // è°ƒè¯•ï¼šç¡®è®¤DOMå…ƒç´ 
                    console.log('å¼€å§‹è®¾ç½®éŸ³é˜¶ç±»å‹ç›‘å¬å™¨');
                    
                    // ç«‹å³æµ‹è¯•window.scaleTypesæ˜¯å¦å¯ç”¨
                    console.log('window.scaleTypeså¯¹è±¡å­˜åœ¨:', window.scaleTypes !== undefined);
                    if (window.scaleTypes) {
                        console.log('Phrygian Majorè°ƒå¼å­˜åœ¨:', window.scaleTypes['phrygianMajor'] !== undefined);
                        if (window.scaleTypes['phrygianMajor']) {
                            console.log('Phrygian MajoréŸ³ç¨‹:', window.scaleTypes['phrygianMajor'].intervals);
                        }
                    }
                    
                    // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                    const scaleTypeElement = document.getElementById('scaleType');
                    console.log('scaleTypeå…ƒç´ :', scaleTypeElement);
                    
                    if (scaleTypeElement) {
                        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
                        scaleTypeElement.removeEventListener('change', updateArpeggioButtons);
                        // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                        scaleTypeElement.addEventListener('change', updateArpeggioButtons);
                        console.log('éŸ³é˜¶ç±»å‹å˜åŒ–ç›‘å¬å™¨å·²ç»‘å®š');
                    }
                    
                    // åˆå§‹åŠ è½½æ—¶æ›´æ–°æŒ‰é’®æ–‡æœ¬å’ŒçŠ¶æ€
                    function updateArpeggioButtons() {
                        console.log('updateArpeggioButtonså‡½æ•°è¢«è°ƒç”¨');
                        
                        const scaleType = document.getElementById('scaleType').value;
                        console.log('å½“å‰é€‰æ‹©çš„è°ƒå¼:', scaleType);
                        
                        // è·å–éŸ³é˜¶ç±»å‹å¯¹åº”çš„éŸ³ç¨‹æ•°ç»„
                        let intervals = [];
                        if (window.scaleTypes && window.scaleTypes[scaleType] && window.scaleTypes[scaleType].intervals) {
                            intervals = window.scaleTypes[scaleType].intervals;
                            console.log('è·å–åˆ°çš„éŸ³ç¨‹æ•°ç»„:', intervals);
                        } else {
                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°scaleTypeså¯¹è±¡æˆ–å¯¹åº”çš„éŸ³é˜¶ï¼Œä½¿ç”¨é»˜è®¤çš„å¤§è°ƒéŸ³é˜¶
                            intervals = ['1', '2', '3', '4', '5', '6', '7'];
                            console.log('ä½¿ç”¨é»˜è®¤å¤§è°ƒéŸ³é˜¶:', intervals);
                        }
                        
                        // è·å–3éŸ³ã€5éŸ³ã€7éŸ³çš„éŸ³ç¨‹ï¼ˆä¼˜å…ˆæŸ¥æ‰¾å®é™…å­˜åœ¨çš„å˜éŸ³è®°å·ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŸ¥æ‰¾æœ€è¿‘çš„éŸ³ç¨‹ï¼‰
                        const thirdInterval = findNearestIntervalInScale(intervals, '3');
                        const fifthInterval = findNearestIntervalInScale(intervals, '5');
                        const seventhInterval = findNearestIntervalInScale(intervals, '7');
                        
                        console.log('è®¡ç®—å¾—åˆ°çš„éŸ³ç¨‹:', {thirdInterval, fifthInterval, seventhInterval});
                        
                        // æ›´æ–°é¢„å®šä¹‰æŒ‰é’®æ–‡æœ¬å’Œç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
                        const arpeggio3Btn = document.getElementById('arpeggio-3-btn');
                        const arpeggio5Btn = document.getElementById('arpeggio-5-btn');
                        const arpeggio7Btn = document.getElementById('arpeggio-7-btn');
                        const randomArpeggioBtn = document.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');
                        
                        console.log('æ‰¾åˆ°çš„æŒ‰é’®å…ƒç´ :', {
                            arpeggio3Btn: arpeggio3Btn !== null,
                            arpeggio5Btn: arpeggio5Btn !== null,
                            arpeggio7Btn: arpeggio7Btn !== null,
                            randomArpeggioBtn: randomArpeggioBtn !== null
                        });
                        
                        if (arpeggio3Btn) {
                            console.log('æ›´æ–°3éŸ³æŒ‰é’®å‰:', arpeggio3Btn.textContent, 'data-value:', arpeggio3Btn.getAttribute('data-value'));
                            arpeggio3Btn.textContent = `${thirdInterval}â†’${thirdInterval}`;
                            arpeggio3Btn.setAttribute('data-value', `${thirdInterval}to${thirdInterval}`);
                            arpeggio3Btn.style.pointerEvents = 'auto';
                            arpeggio3Btn.style.opacity = '1';
                            console.log('æ›´æ–°3éŸ³æŒ‰é’®å:', arpeggio3Btn.textContent, 'data-value:', arpeggio3Btn.getAttribute('data-value'));
                        }
                        
                        if (arpeggio5Btn) {
                            console.log('æ›´æ–°5éŸ³æŒ‰é’®å‰:', arpeggio5Btn.textContent, 'data-value:', arpeggio5Btn.getAttribute('data-value'));
                            arpeggio5Btn.textContent = `${fifthInterval}â†’${fifthInterval}`;
                            arpeggio5Btn.setAttribute('data-value', `${fifthInterval}to${fifthInterval}`);
                            arpeggio5Btn.style.pointerEvents = 'auto';
                            arpeggio5Btn.style.opacity = '1';
                            console.log('æ›´æ–°5éŸ³æŒ‰é’®å:', arpeggio5Btn.textContent, 'data-value:', arpeggio5Btn.getAttribute('data-value'));
                        }
                        
                        if (arpeggio7Btn) {
                            console.log('æ›´æ–°7éŸ³æŒ‰é’®å‰:', arpeggio7Btn.textContent, 'data-value:', arpeggio7Btn.getAttribute('data-value'));
                            arpeggio7Btn.textContent = `${seventhInterval}â†’${seventhInterval}`;
                            arpeggio7Btn.setAttribute('data-value', `${seventhInterval}to${seventhInterval}`);
                            arpeggio7Btn.style.pointerEvents = 'auto';
                            arpeggio7Btn.style.opacity = '1';
                            console.log('æ›´æ–°7éŸ³æŒ‰é’®å:', arpeggio7Btn.textContent, 'data-value:', arpeggio7Btn.getAttribute('data-value'));
                        }
                        
                        if (randomArpeggioBtn) {
                            randomArpeggioBtn.style.pointerEvents = 'auto';
                            randomArpeggioBtn.style.opacity = '1';
                        }
                        
                        // åŠ¨æ€åˆ›å»ºé¢å¤–çš„æŒ‰é’®æ¥æ˜¾ç¤ºéŸ³é˜¶ä¸­å…¶ä»–å¯ç”¨çš„éŸ³ç¨‹
                        const container = document.querySelector('.order-btn-container'); // ç»ƒä¹ åºåˆ—æŒ‰é’®å®¹å™¨
                        if (container) {
                            // æŸ¥æ‰¾ç°æœ‰çš„åŠ¨æ€æŒ‰é’®å¹¶ç§»é™¤
                            const existingDynamicButtons = container.querySelectorAll('.scale-arpeggio-btn.dynamic');
                            existingDynamicButtons.forEach(btn => btn.remove());
                            
                            // åªåœ¨éŸ³é˜¶ç»ƒä¹ æ¨¡å¼ä¸‹åˆ›å»ºåŠ¨æ€æŒ‰é’®ï¼Œå’Œå¼¦ç»ƒä¹ æ¨¡å¼ä¸‹ä¸åˆ›å»º
                            const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                            if (activeTab === 'scale') {
                                // ä¸ºéŸ³é˜¶ä¸­æ¯ä¸ªç‹¬ç‰¹çš„éŸ³ç¨‹åˆ›å»ºæŒ‰é’®ï¼ˆé™¤äº†1ã€3ã€5ã€7ï¼Œå› ä¸ºå®ƒä»¬å·²ç»æœ‰é¢„å®šä¹‰æŒ‰é’®äº†ï¼‰
                                const uniqueIntervals = [...new Set(intervals)];
                                const predefinedIntervals = ['1', '3', '5', '7'];
                                
                                uniqueIntervals.forEach(interval => {
                                    // æå–æ•°å­—éƒ¨åˆ†
                                    const intervalNumber = interval.replace(/[^0-9]/g, '');
                                    
                                    // è·³è¿‡é¢„å®šä¹‰çš„éŸ³ç¨‹
                                    if (predefinedIntervals.includes(intervalNumber)) {
                                        return;
                                    }
                                    
                                    // åˆ›å»ºæŒ‰é’®
                                    const btn = document.createElement('div');
                                    btn.className = 'order-btn scale-arpeggio-btn dynamic';
                                    btn.setAttribute('data-value', `${interval}to${interval}`);
                                    btn.textContent = `${interval}â†’${interval}`;
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.opacity = '1';
                                    
                                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                    btn.addEventListener('click', function() {
                                        // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeçŠ¶æ€
                                        const allButtons = container.querySelectorAll('.scale-arpeggio-btn');
                                        allButtons.forEach(b => b.classList.remove('active'));
                                        // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                                        this.classList.add('active');
                                    });
                                    
                                    // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œæ”¾åœ¨éšæœºæŒ‰é’®ä¹‹å‰
                                    const randomBtn = container.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');
                                    if (randomBtn) {
                                        container.insertBefore(btn, randomBtn);
                                    } else {
                                        container.appendChild(btn);
                                    }
                                });
                            }
                        }
                    }
                    
                    // é¡µé¢åŠ è½½å®Œæˆåç«‹å³è°ƒç”¨ä¸€æ¬¡ï¼Œç¡®ä¿åˆå§‹åŒ–æ˜¾ç¤ºæ­£ç¡®
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œè°ƒç”¨updateArpeggioButtons');
                        updateArpeggioButtons();
                    });
                    
                    // ä¸ºäº†æµ‹è¯•ï¼Œæ·»åŠ ä¸€ä¸ªå…¨å±€å‡½æ•°å¯ä»¥æ‰‹åŠ¨è°ƒç”¨
                    window.testUpdateArpeggio = function() {
                        console.log('æ‰‹åŠ¨è°ƒç”¨æµ‹è¯•å‡½æ•°');
                        updateArpeggioButtons();
                    };
                    
                    // æŸ¥æ‰¾æŒ‡å®šåº¦æ•°çš„éŸ³ç¨‹ï¼ˆä¼˜å…ˆæŸ¥æ‰¾åŒ…å«è¯¥åº¦æ•°çš„éŸ³ç¨‹ï¼Œå¦‚3åº¦ä¼˜å…ˆæ‰¾b3ã€3ã€#3ï¼‰
                    function getScaleDegreeByPosition(intervals, degree) {
                        // å°†åº¦æ•°è½¬æ¢ä¸ºå­—ç¬¦ä¸²å½¢å¼
                        const degreeStr = degree.toString();
                        
                        // ä¼˜å…ˆæŸ¥æ‰¾åŒ…å«è¯¥åº¦æ•°çš„éŸ³ç¨‹ï¼ˆå¦‚3åº¦ä¼˜å…ˆæ‰¾b3ã€3ã€#3ç­‰ï¼‰
                        for (let i = 0; i < intervals.length; i++) {
                            // æ£€æŸ¥éŸ³ç¨‹æ˜¯å¦ä»¥b+åº¦æ•°ã€#/â™¯+åº¦æ•°æˆ–åº¦æ•°å¼€å¤´
                            if (intervals[i].includes(degreeStr)) {
                                return intervals[i];
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ…å«è¯¥åº¦æ•°çš„éŸ³ç¨‹ï¼Œåˆ™å›é€€åˆ°æŒ‰ä½ç½®æŸ¥æ‰¾
                        const validDegree = (degree - 1) % intervals.length;
                        return intervals[validDegree];
                    }
                    
                    // æŸ¥æ‰¾éŸ³é˜¶ä¸­ç¬¬ä¸€ä¸ªå‡ºç°çš„æŒ‡å®šéŸ³ç¨‹ï¼ˆå¦‚'3', 'â™­3', 'â™¯3'ç­‰ï¼‰
                    function findFirstIntervalOfType(intervals, degree) {
                        // ç‰¹æ®Šå¤„ç†ï¼šå¯¹äºblueséŸ³é˜¶ç­‰ç‰¹æ®ŠéŸ³é˜¶ï¼Œä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”åº¦æ•°çš„å˜éŸ³è®°å·ç‰ˆæœ¬
                        // ä¾‹å¦‚ï¼Œå¯¹äºblueséŸ³é˜¶ï¼Œ3åº¦å¯èƒ½æ˜¯â™­3ï¼Œ4åº¦å¯èƒ½æ˜¯â™­4ï¼Œ7åº¦å¯èƒ½æ˜¯â™­7
                        if (degree === '3') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === 'â™­3') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '4') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === 'â™­4') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '7') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === 'â™­7') {
                                    return intervals[i];
                                }
                            }
                        }
                        
                        // æ£€æŸ¥éŸ³é˜¶ä¸­æ˜¯å¦åŒ…å«è¯¥åº¦æ•°çš„ä»»ä½•å˜ä½“
                        // ä¾‹å¦‚ï¼Œå¯¹äº3åº¦ï¼ŒæŸ¥æ‰¾b3ã€3ã€#3ç­‰
                        for (let i = 0; i < intervals.length; i++) {
                            // æå–æ•°å­—éƒ¨åˆ†ï¼ˆç§»é™¤å˜éŸ³è®°å·ï¼‰
                            const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                            if (intervalNumber === degree) {
                                return intervals[i];
                            }
                        }
                        
                        // å¦‚æœæ²¡æ‰¾åˆ°è¯¥åº¦æ•°çš„éŸ³ç¨‹ï¼Œè¿”å›null
                        return null;
                    }
                    
                    // å½“éŸ³é˜¶ä¸­ç¼ºå°‘ç‰¹å®šéŸ³ç¨‹æ—¶ï¼ŒæŸ¥æ‰¾éŸ³é˜¶ä¸­å®é™…å­˜åœ¨çš„æœ€è¿‘éŸ³ç¨‹
                    function findNearestIntervalInScale(intervals, degree) {
                        // é¦–å…ˆå°è¯•æŸ¥æ‰¾æŒ‡å®šåº¦æ•°çš„éŸ³ç¨‹
                        const foundInterval = findFirstIntervalOfType(intervals, degree);
                        if (foundInterval) {
                            return foundInterval;
                        }
                        
                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ ¹æ®éŸ³ç¨‹ç±»å‹é€‰æ‹©æœ€è¿‘çš„æ›¿ä»£éŸ³ç¨‹
                        switch (degree) {
                            case '3':
                                // 3éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾4éŸ³ï¼ˆä¼˜å…ˆï¼‰æˆ–2éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '2') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '5':
                                // 5éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾4éŸ³æˆ–6éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '6':
                                // 6éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾7éŸ³ï¼ˆä¼˜å…ˆï¼‰æˆ–5éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '7') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '5') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '7':
                                // 7éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾6éŸ³ï¼ˆä¼˜å…ˆï¼‰æˆ–1éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                // æŸ¥æ‰¾æ ¹éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '1') {
                                        return intervals[i];
                                    }
                                }
                                break;
                        }
                        
                        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œè¿”å›éŸ³é˜¶ä¸­çš„ç¬¬ä¸€ä¸ªéŸ³ç¨‹ä½œä¸ºé»˜è®¤å€¼
                        return intervals.length > 0 ? intervals[0] : '1';
                    }
                    
                    // æŸ¥æ‰¾éŸ³é˜¶ä¸­æŒ‡å®šéŸ³ç¨‹çš„å®Œæ•´å½¢å¼ï¼ˆåŒ…æ‹¬å˜éŸ³è®°å·ï¼‰
                    function findCompleteIntervalInScale(intervals, interval) {
                        // ç›´æ¥æŸ¥æ‰¾å®Œå…¨åŒ¹é…çš„éŸ³ç¨‹ï¼ˆåŒ…æ‹¬å˜éŸ³è®°å·ï¼‰
                        for (let i = 0; i < intervals.length; i++) {
                            if (intervals[i] === interval) {
                                return intervals[i];
                            }
                        }
                        
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„ï¼Œå°è¯•æŸ¥æ‰¾æ•°å­—éƒ¨åˆ†åŒ¹é…çš„
                        const intervalNumber = interval.replace(/[^0-9]/g, '');
                        for (let i = 0; i < intervals.length; i++) {
                            const currentIntervalNumber = intervals[i].replace(/[^0-9]/g, '');
                            if (currentIntervalNumber === intervalNumber) {
                                return intervals[i];
                            }
                        }
                        
                        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œè¿”å›null
                        return null;
                    }
                    
                    // é¡µé¢åŠ è½½å®Œæˆåæ›´æ–°æŒ‰é’®æ–‡æœ¬
                    document.addEventListener('DOMContentLoaded', function() {
                        updateArpeggioButtons();
                    });
                    </script>
                </div>

                <!-- å’Œå¼¦è®¾ç½® -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> å’Œå¼¦è®¾ç½®
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            æ ¹éŸ³
                            <span class="info">é€‰æ‹©å’Œå¼¦çš„æ ¹éŸ³</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="Câ™¯">Câ™¯</option>
                                <option value="Dâ™­">Dâ™­</option>
                                <option value="D">D</option>
                                <option value="Dâ™¯">Dâ™¯</option>
                                <option value="Eâ™­">Eâ™­</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="Fâ™¯">Fâ™¯</option>
                                <option value="Gâ™­">Gâ™­</option>
                                <option value="G">G</option>
                                <option value="Gâ™¯">Gâ™¯</option>
                                <option value="Aâ™­">Aâ™­</option>
                                <option value="A">A</option>
                                <option value="Aâ™¯">Aâ™¯</option>
                                <option value="Bâ™­">Bâ™­</option>
                                <option value="B">B</option>
                                <option value="random" selected>éšæœºæ ¹éŸ³</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            å’Œå¼¦ç±»å‹
                            <span class="info">é€‰æ‹©è¦ç»ƒä¹ çš„å’Œå¼¦ç±»å‹</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">dim</div>
                            <div class="chord-type-btn" data-value="augmented">aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7â™­5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7â™¯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7â™­9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7â™¯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                            ç‚¹å‡»é€‰æ‹©è¦ç»ƒä¹ çš„å’Œå¼¦ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            é¡ºåº
                            <span class="info">é€‰æ‹©å’Œå¼¦éŸ³ç¬¦çš„æ¼”å¥é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">ä¸Šè¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="reverse">ä¸‹è¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="random">éšæœº</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">å¼€å§‹ç»ƒä¹ </button>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="scale">
            <div class="nav-icon">ğŸµ</div>
            <div class="nav-label">éŸ³é˜¶ç»ƒä¹ </div>
        </div>
        <div class="nav-item" data-tab="chord">
            <div class="nav-icon">ğŸ¶</div>
            <div class="nav-label">å’Œå¼¦ç»ƒä¹ </div>
        </div>
        <div class="nav-item" data-tab="progression">
            <div class="nav-icon">ğŸ”„</div>
            <div class="nav-label">å’Œå¼¦è½¬æ¢</div>
        </div>
        <div class="nav-item" data-tab="device">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-label">è®¾ç½®</div>
        </div>
    </div>

    <!-- ç»ƒä¹ æ¨¡å¼å…¨å±é¡µé¢ -->
    <div id="practiceScreen">
        <!-- ä¹æ›²åæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="song-title-display" id="songTitleDisplay" style="display: none;">
            <div class="song-title" id="songTitle"></div>
        </div>
        
        <div class="exercise-container">
            <div class="scale-info">
                <div class="target-interval" id="targetInterval">C Major</div>
            </div>

            <div class="sequence-display">

                <div class="sequence-items" id="sequenceDisplay"></div>
            </div>
        </div>

        <div class="next-exercise">
            <div class="next-content-wrapper">
                <div class="next-label">ä¸‹ä¸€ä¸ª:</div>
                <div class="next-content" id="nextExercise">-</div>
            </div>
        </div>
    </div>

    <script>
        // PitchFinderåº“å†…è”ä»£ç  - ç›´æ¥åµŒå…¥å¢å¼ºç‰ˆYINç®—æ³•å®ç°
        (function (global) {
            // PitchFinderä¸»å¯¹è±¡
            var Pitchfinder = {};

            // å¢å¼ºç‰ˆYINç®—æ³•å®ç°
            Pitchfinder.YIN = function (config) {
                config = config || {};
                var threshold = config.threshold || 0.15;
                var probabilityCliff = config.probabilityCliff || 0.1;

                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);

                    // æ­¥éª¤1: å·®åˆ†å‡½æ•°
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }

                    // æ­¥éª¤2: ç´¯ç§¯å¹³å‡å½’ä¸€åŒ–
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }

                    // æ­¥éª¤3: é˜ˆå€¼æ£€æµ‹
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }

                    if (tauEstimate === -1) return null;

                    // æ­¥éª¤4: æŠ›ç‰©çº¿æ’å€¼æé«˜ç²¾åº¦
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }

                    const frequency = 48000 / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));

                    if (probability < probabilityCliff) return null;

                    return { frequency, probability };
                };
            };

            // å°†PitchFinderæš´éœ²ç»™å…¨å±€
            global.Pitchfinder = Pitchfinder;
        })(window);

        document.addEventListener('DOMContentLoaded', function () {
            // å‰ä»–æ ‡å‡†è°ƒå¼¦
            const standardTuning = ['E', 'B', 'G', 'D', 'A', 'E'];

            // æ‰€æœ‰å¯èƒ½çš„éŸ³çº§
            const intervals = ['1', 'â™­2', '2', 'â™­3', '3', '4', 'â™¯4', '5', 'â™­6', '6', 'â™­7', '7'];

            // éŸ³çº§åˆ°åŠéŸ³è·ç¦»çš„æ˜ å°„
            const intervalToSemitones = {
                '1': 0,
                'â™­2': 1,
                '2': 2,
                'â™­3': 3,
                '3': 4,
                'â™­4': 4,
                '4': 5,
                'â™¯4': 6,
                'â™­5': 6,
                '5': 7,
                'â™­6': 8,
                '6': 9,
                'â™­7': 10,
                '7': 11
            };

            // éŸ³ååˆ°åŠéŸ³æ•°çš„æ˜ å°„ï¼ˆC = 0ï¼‰
            const noteToSemitones = {
                'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4,
                'F': 5, 'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8,
                'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
            };

            // éŸ³é˜¶ç±»å‹å®šä¹‰
            const scaleTypes = {
                // åŸºæœ¬è°ƒå¼
                'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'minor': { name: 'Minor', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                
                // æ•™ä¼šè°ƒå¼ (Church Modes)
                'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'dorian': { name: 'Dorian - 1 2 â™­3 4 5 6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', '6', 'â™­7'] },
                'phrygian': { name: 'Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                'lydian': { name: 'Lydian - 1 2 3 â™¯4 5 6 7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', '7'] },
                'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 â™­7', intervals: ['1', '2', '3', '4', '5', '6', 'â™­7'] },
                'aeolian': { name: 'Aeolian - 1 2 â™­3 4 5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                'locrian': { name: 'Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                
                // å’Œå£°å°è°ƒç³»åˆ—
                'harmonicMinor': { name: 'Harmonic Minor - 1 2 â™­3 4 5 â™­6 7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', '7'] },
                'dorianSharp2': { name: 'Dorian â™¯2 - 1 â™¯2 â™­3 4 5 6 â™­7', intervals: ['1', 'â™¯2', 'â™­3', '4', '5', '6', 'â™­7'] },
                'phrygianMajor': { name: 'Phrygian Major - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                'lydianSharp2': { name: 'Lydian â™¯2 - 1 â™¯2 3 â™¯4 5 6 7', intervals: ['1', 'â™¯2', '3', 'â™¯4', '5', '6', '7'] },
                'mixolydianFlat6': { name: 'Mixolydian â™­6 - 1 2 3 4 5 â™­6 â™­7', intervals: ['1', '2', '3', '4', '5', 'â™­6', 'â™­7'] },
                'lydianFlat2': { name: 'Lydian â™­2 - 1 â™­2 3 â™¯4 5 6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', '5', '6', '7'] },
                'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 â™­2 â™­3 â™­4 â™­5 â™­6 6', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', '6'] },
                
                // æ—‹å¾‹å°è°ƒç³»åˆ—
                'melodicMinor': { name: 'Melodic Minor - 1 2 â™­3 4 5 6 7', intervals: ['1', '2', 'â™­3', '4', '5', '6', '7'] },
                'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 â™­7 â™­6 5 4 â™­3 2 1', intervals: ['1', 'â™­7', 'â™­6', '5', '4', 'â™­3', '2', '1'] },
                'dorianFlat2': { name: 'Dorian â™­2 - 1 â™­2 â™­3 4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', '6', 'â™­7'] },
                'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 â™¯4 â™¯5 6 7', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', '6', '7'] },
                'lydianFlat7': { name: 'Lydian â™­7 - 1 2 3 â™¯4 5 6 â™­7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', 'â™­7'] },
                'aeolianFlat5': { name: 'Aeolian â™­5 - 1 2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                'superLocrian': { name: 'Super Locrian - 1 â™­2 â™­3 â™­4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', 'â™­7'] },
                
                // äº”å£°éŸ³é˜¶ç³»åˆ—
                'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                'minorPentatonic': { name: 'Minor Pentatonic - 1 â™­3 4 5 â™­7', intervals: ['1', 'â™­3', '4', '5', 'â™­7'] },
                'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 â™­3 5 6', intervals: ['1', '2', 'â™­3', '5', '6'] },
                'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 â™­7', intervals: ['1', '2', '3', '5', 'â™­7'] },
                
                // å¸ƒé²æ–¯éŸ³é˜¶ç³»åˆ—
                'blues': { name: 'Blues - 1 â™­3 4 â™¯4 5 â™­7', intervals: ['1', 'â™­3', '4', 'â™¯4', '5', 'â™­7'] },
                'majorBlues': { name: 'Major Blues - 1 2 â™­3 3 5 6', intervals: ['1', '2', 'â™­3', '3', '5', '6'] },
                
                // å…¶ä»–å¸¸è§éŸ³é˜¶
                'wholeTone': { name: 'Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', 'â™¯6'] },
                'diminished': { name: 'Diminished (Half-Whole) - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '3', 'â™¯4', '5', '6', 'â™­7'] },
                'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 â™­3 4 â™¯4 â™¯5 6 7', intervals: ['1', '2', 'â™­3', '4', 'â™¯4', 'â™¯5', '6', '7'] },
                'chromatic': { name: 'Chromatic - 1 â™­2 2 â™­3 3 4 â™¯4 5 â™­6 6 â™­7 7', intervals: ['1', 'â™­2', '2', 'â™­3', '3', '4', 'â™¯4', '5', 'â™­6', '6', 'â™­7', '7'] },
                
                // å¼‚å›½é£æ ¼éŸ³é˜¶
                'arabic': { name: 'Arabic - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                'gypsy': { name: 'Gypsy - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                'japanese': { name: 'Japanese - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                'egyptian': { name: 'Egyptian - 1 2 4 5 â™­7', intervals: ['1', '2', '4', '5', 'â™­7'] },
                'hungarian': { name: 'Hungarian - 1 â™¯2 â™­3 â™¯4 5 â™­6 7', intervals: ['1', 'â™¯2', 'â™­3', 'â™¯4', '5', 'â™­6', '7'] },
                'persian': { name: 'Persian - 1 â™­2 3 4 â™­5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', 'â™­5', 'â™­6', '7'] },
                'byzantine': { name: 'Byzantine - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                'enigmatic': { name: 'Enigmatic - 1 â™­2 3 â™¯4 â™¯5 â™¯6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', 'â™¯5', 'â™¯6', '7'] },
                'neapolitan': { name: 'Neapolitan - 1 â™­2 â™­3 4 5 â™­6 7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', '7'] },
                'spanish': { name: 'Spanish - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] }
            };

            // å’Œå¼¦ç±»å‹å®šä¹‰
            const chordTypes = {
                // åŸºç¡€ä¸‰å’Œå¼¦
                'major': { name: 'å¤§ä¸‰å’Œå¼¦', intervals: ['1', '3', '5'] },
                'minor': { name: 'å°ä¸‰å’Œå¼¦', intervals: ['1', 'â™­3', '5'] },
                'diminished': { name: 'å‡ä¸‰å’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5'] },
                'augmented': { name: 'å¢ä¸‰å’Œå¼¦', intervals: ['1', '3', 'â™¯5'] },
                
                // å…­å’Œå¼¦
                'major6': { name: 'å¤§å…­å’Œå¼¦', intervals: ['1', '3', '5', '6'] },
                'minor6': { name: 'å°å…­å’Œå¼¦', intervals: ['1', 'â™­3', '5', '6'] },
                
                // ä¸ƒå’Œå¼¦
                'dominant7': { name: 'å±ä¸ƒå’Œå¼¦', intervals: ['1', '3', '5', 'â™­7'] },
                'major7': { name: 'å¤§ä¸ƒå’Œå¼¦', intervals: ['1', '3', '5', '7'] },
                'minor7': { name: 'å°ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7'] },
                'minor7b5': { name: 'åŠå‡ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5', 'â™­7'] },
                'diminished7': { name: 'å‡ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5', '6'] },
                
                // ä¹å’Œå¼¦
                'dominant9': { name: 'å±ä¹å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '2'] },
                'major9': { name: 'å¤§ä¹å’Œå¼¦', intervals: ['1', '3', '5', '7', '2'] },
                'minor9': { name: 'å°ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '2'] },
                'dominant7sharp9': { name: 'å±7â™¯9å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™¯2'] },
                'dominant7flat9': { name: 'å±7â™­9å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™­2'] },
                
                // åä¸€å’Œå¼¦
                'dominant11': { name: 'å±11å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '2', '4'] },
                'minor11': { name: 'å°11å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '2', '4'] },
                'dominant7sharp11': { name: 'å±7â™¯11å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™¯4'] },
                
                // åä¸‰å’Œå¼¦
                'dominant13': { name: 'å±13å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '2', '6'] },
                'minor13': { name: 'å°13å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '2', '6'] },
                
                // æŒ‚ç•™å’Œå¼¦
                'sus2': { name: 'æŒ‚äºŒå’Œå¼¦', intervals: ['1', '2', '5'] },
                'sus4': { name: 'æŒ‚å››å’Œå¼¦', intervals: ['1', '4', '5'] },
                
                // åŠ éŸ³å’Œå¼¦
                'add9': { name: 'åŠ ä¹å’Œå¼¦', intervals: ['1', '3', '5', '2'] },
                'madd9': { name: 'å°åŠ ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', '2'] },
                '6add9': { name: 'å…­åŠ ä¹å’Œå¼¦', intervals: ['1', '3', '5', '6', '2'] },
                'm6add9': { name: 'å°å…­åŠ ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', '6', '2'] }
            };

            // ç»å…¸çˆµå£«ä¹æ­Œæ›²å’Œå¼¦è¿›è¡Œï¼ˆåŸºäºéŸ³çº§å‚¨å­˜ï¼‰
            const jazzStandards = {
                '5': {
                    '500 Miles High': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'V7sus4', 'IM7', 'V7sus4', 'IVM7', 'IVM7', 'IM7', 'IM7']
                    }
                },
                'A': {
                    'All The Things You Are': {
                        key: 'C',
                        chords: ['VIIm7â™­5', 'III7', 'VIm7', 'II7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Autumn Leaves': {
                        key: 'G',
                        chords: ['IVm7', 'bVII7', 'bIIIM7', 'bVIM7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    },
                    'All Of Me': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'IVM7', 'IIIm7â™­5', 'VI7']
                    },
                    'A Night In Tunisia': {
                        key: 'D',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'Im7', 'bIIM7']
                    },
                    'All of You': {
                        key: 'C',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Alone Together': {
                        key: 'G',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'bVI7', 'bIIM7', 'IIm7â™­5', 'V7', 'Im7']
                    },
                    'Ambleside': {
                        key: 'C',
                        chords: ['IM7', 'V7sus4', 'IM7', 'IVM7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Anthropology': {
                        key: 'Bâ™­',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Ask Me Now': {
                        key: 'F',
                        chords: ['IM7', 'bII7', 'IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'IM7']
                    }
                },
                'B': {
                    'Blue Moon': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Body And Soul': {
                        key: 'Dâ™­',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'bVIIM7', 'Vm7', 'II7', 'V7']
                    },
                    'Bye Bye Blackbird': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'II7', 'VIIm7', 'III7', 'VIm7', 'IIm7']
                    },
                    'Beautiful Love': {
                        key: 'G',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'Im7', 'IVm7', 'bVII7', 'bIIIM7', 'bIIIM7']
                    },
                    'Blue Bossa': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'bVIIM7', 'bVIIM7']
                    },
                    'Blue in Green': {
                        key: 'C',
                        chords: ['IM7', 'bVII7', 'bIIIM7', 'bVIM7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    },
                    'Blues for Alice': {
                        key: 'F',
                        chords: ['I7', 'VI7', 'II7', 'V7', 'III7', 'VI7', 'II7', 'V7']
                    }
                },
                'C': {
                    'Cherokee': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Come Rain Or Come Shine': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Confirmation': {
                        key: 'F',
                        chords: ['IM7', 'bVII7', 'IIIm7â™­5', 'VI7', 'IIm7', 'V7', 'IIIm7â™­5', 'VI7']
                    },
                    'Coral': {
                        key: 'G',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Corcovado': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7']
                    },
                    'Countdown': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'bIII7', 'bVIM7', 'bII7', 'VM7', 'I7', 'IVM7', 'bVII7']
                    }
                },
                'D': {
                    'Days Of Wine And Roses': {
                        key: 'F',
                        chords: ['IM7', 'IV7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Donna Lee': {
                        key: 'Aâ™­',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Doxy': {
                        key: 'Bâ™­',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7']
                    },
                    'Dream A Little Dream': {
                        key: 'C',
                        chords: ['IM7', 'bIIIdim7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'F': {
                    'Fall': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    },
                    'Falling Grace': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Fly Me To The Moon': {
                        key: 'C',
                        chords: ['VIm7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7']
                    },
                    'Four': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Footprints': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IVm7', 'IVm7', 'Im7', 'Im7']
                    }
                },
                'G': {
                    'Giant Steps': {
                        key: 'B',
                        chords: ['IM7', 'bIII7', 'bVIM7', 'bI7', 'bIVM7', 'bVIIm7', 'bIII7', 'bVIM7']
                    },
                    'Georgia On My Mind': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Girl From Ipanema': {
                        key: 'F',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'IIIm7â™­5', 'VI7', 'IIm7', 'IIm7']
                    }
                },
                'H': {
                    'Have You Met Miss Jones': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Here\'s That Rainy Day': {
                        key: 'G',
                        chords: ['bI7', 'IVm7', 'bVII7', 'bIIIM7', 'bVIM7', 'IIm7â™­5', 'V7', 'Im7']
                    },
                    'How High The Moon': {
                        key: 'G',
                        chords: ['IM7', 'Im7', 'IV7', 'bVIIM7', 'bVIIM7', 'IIIm7â™­5', 'VI7', 'IIm7']
                    }
                },
                'I': {
                    'I Got Rhythm': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'I Can\'t Get Started': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'VI7', 'IIm7', 'V7']
                    },
                    'In A Sentimental Mood': {
                        key: 'D',
                        chords: ['Im7', 'IV7', 'IIm7â™­5', 'V7', 'Im7', 'IV7', 'bVIIM7', 'bVIIM7']
                    },
                    'Infant Eyes': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7']
                    },
                    'Inner Urge': {
                        key: 'Aâ™­',
                        chords: ['IM7', 'bII7', 'IM7', 'bII7', 'IVM7', 'bV7', 'IM7', 'IM7']
                    }
                },
                'J': {
                    'Just Friends': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIM7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Joy Spring': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Jordu': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'bVIIM7', 'bIIIM7', 'VIm7â™­5', 'II7', 'Vm7', 'IIm7']
                    }
                },
                'L': {
                    'Lady Bird': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IVm7â™­5', 'bVII7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Love For Sale': {
                        key: 'G',
                        chords: ['Im7', 'IV7', 'Im7', 'IV7', 'bVIIM7', 'Vm7', 'Im7', 'IV7']
                    },
                    'Lover Man': {
                        key: 'Aâ™­',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    }
                },
                'M': {
                    'Misty': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'Vm7', 'I7', 'IVM7', 'IVm7', 'bVII7', 'IM7', 'VIm7']
                    },
                    'My Funny Valentine': {
                        key: 'C',
                        chords: ['Im7', 'IV7', 'bVIIM7', 'bIIIM7', 'VIm7â™­5', 'II7', 'Vm7', 'I7']
                    },
                    'Maiden Voyage': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IIm7', 'V7', 'bIIIm7', 'bVI7', 'bIIM7', 'bIIM7']
                    }
                },
                'N': {
                    'Night And Day': {
                        key: 'C',
                        chords: ['IM7', 'IIm7', 'IIIm7', 'IIm7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Nardis': {
                        key: 'E',
                        chords: ['Im7', 'bIIM7', 'Im7', 'bIIM7', 'Im7', 'bIIM7', 'Im7', 'Im7']
                    },
                    'Night Train': {
                        key: 'G',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'V7']
                    }
                },
                'O': {
                    'Oleo': {
                        key: 'Bâ™­',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'S': {
                    'Someday My Prince Will Come': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'IV7', 'VIIm7â™­5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Spain': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7', 'VIm7']
                    },
                    'Stella By Starlight': {
                        key: 'D',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'bVI7', 'bIIIM7', 'IIm7â™­5', 'V7', 'Im7']
                    },
                    'Summertime': {
                        key: 'A',
                        chords: ['Im7', 'V7', 'Im7', 'V7', 'IVm7', 'bVII7', 'bIIIM7', 'bVIM7']
                    },
                    'Solar': {
                        key: 'C',
                        chords: ['Im7', 'IV7', 'bVIIM7', 'bIIIM7', 'VIm7â™­5', 'II7', 'Vm7', 'I7']
                    }
                },
                'T': {
                    'Take Five': {
                        key: 'Eâ™­m',
                        chords: ['Im7', 'IV7', 'bVIIM7', 'bIIIM7', 'IIm7', 'V7', 'Im7', 'Im7']
                    },
                    'Take the A-Train': {
                        key: 'C',
                        chords: ['IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'The Girl From Ipanema': {
                        key: 'F',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'IIIm7â™­5', 'VI7', 'IIm7', 'IIm7']
                    },
                    'There Will Never Be Another You': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IM7', 'IIIm7', 'VI7']
                    },
                    'The Way You Look Tonight': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'IV7', 'IM7', 'VIm7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Time Remembered': {
                        key: 'F',
                        chords: ['IM7', 'bVII7', 'IM7', 'bVII7', 'IVM7', 'bVII7', 'IM7', 'IM7']
                    }
                },
                'V': {
                    'Very Early': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Virgo': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    }
                }
            };

            // å…ƒç´ å¼•ç”¨
            const mainScreen = document.getElementById('mainScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const targetIntervalEl = document.getElementById('targetInterval');
            const sequenceDisplayEl = document.getElementById('sequenceDisplay');
            const nextExerciseEl = document.getElementById('nextExercise');
            const startBtn = document.getElementById('startBtn');
            const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
            const rootNoteEl = document.getElementById('rootNote');
            const scaleTypeEl = document.getElementById('scaleType');
            const chordRootNoteEl = document.getElementById('chordRootNote');
            const audioInputDeviceEl = document.getElementById('audioInputDevice');
            const inputGainEl = document.getElementById('inputGain');
            const inputGainValueEl = document.getElementById('inputGainValue');
            const deviceInfoEl = document.getElementById('deviceInfo');
            const statusIndicator = document.getElementById('statusIndicator');
            const shortcutHint = document.getElementById('shortcutHint');
            const metronomeToggleEl = document.getElementById('metronomeToggle');
            const metronomeTempoEl = document.getElementById('metronomeTempo');
            const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
            const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
            const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
            const deviceSettings = document.querySelector('.device-settings');

            // é€‰é¡¹å¡å…ƒç´ 
            // const settingsTabs = document.querySelectorAll('.settings-tab'); // å·²ç§»é™¤é¡¶éƒ¨é€‰é¡¹å¡
            const scaleSettings = document.querySelector('.scale-settings');
            const chordSettings = document.querySelector('.chord-settings');
            const progressionSettings = document.querySelector('.progression-settings');

            // å’Œå¼¦ç±»å‹æŒ‰é’®
            const chordTypeBtns = document.querySelectorAll('.chord-type-btn');

            // éŸ³é¢‘è®¾å¤‡ç®¡ç†
            let audioDevices = [];
            let selectedDeviceId = 'default';
            let inputGain = 1.0;
            let gainNode = null;

            // å±å¹•å”¤é†’é”å˜é‡
            let wakeLock = null;

            // éŸ³é¢‘åˆ†æå˜é‡
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let javascriptNode = null;
            let isRecording = false;
            let mediaStream = null;

            // ç»ƒä¹ çŠ¶æ€
            let state = {
                score: 0,
                correctCount: 0,
                totalCount: 0,
                accuracy: 0,
                rootNote: '',
                scaleType: '',
                chordType: '',
                currentIntervals: [],
                currentSequence: [],
                currentStep: 0,
                correctPositions: [],
                isCoolingDown: false,
                cooldownTimeout: null,
                cooldownDuration: 600, // å†·å´æœŸæŒç»­æ—¶é—´(æ¯«ç§’)
                enableCooldown: true, // æ˜¯å¦å¯ç”¨å†·å´æ—¶é—´
                enableFixedDelay: false, // æ˜¯å¦å¯ç”¨å›ºå®šå»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜
                fixedDelayDuration: 800, // å›ºå®šå»¶è¿Ÿæ—¶é—´(æ¯«ç§’)
                isAnswered: false,
                timeoutId: null,
                maxFret: 12,
                previousMaxFret: 12,
                isRecording: false,
                sensitivity: 0.5,
                confidenceThreshold: 0.5,
                noiseLevel: 0.001,
                minVolume: 0.001,
                microphoneInitialized: false,
                pitchBuffer: [],
                bufferSize: 3,
                zeroCrossingThreshold: 0.1,
                harmonicWeights: [1.0, 0.8, 0.6],
                nextExerciseInfo: '',
                nextExerciseIntervals: [],
                metronomeEnabled: document.getElementById('metronomeToggle').checked,
                metronomeTempo: parseInt(document.getElementById('metronomeTempo').value),
                metronomeFlashEnabled: document.getElementById('metronomeFlashToggle').checked,
                metronomeSoundEnabled: document.getElementById('metronomeSoundToggle').checked,
                metronomeInterval: null,
                // å’Œå¼¦è½¬æ¢ç»ƒä¹ çŠ¶æ€
                isInProgressionSession: false // æ˜¯å¦åœ¨ç»ƒä¹ ä¼šè¯ä¸­
            };

            // åˆå§‹åŒ–ç»ƒä¹ è®¾ç½®
            const cooldownDurationEl = document.getElementById('cooldownDuration');
            if (cooldownDurationEl) {
                state.cooldownDuration = parseInt(cooldownDurationEl.value);
            }

            const enableCooldownEl = document.getElementById('enableCooldown');
            if (enableCooldownEl) {
                state.enableCooldown = enableCooldownEl.checked;
            }

            const enableFixedDelayEl = document.getElementById('enableFixedDelay');
            if (enableFixedDelayEl) {
                state.enableFixedDelay = enableFixedDelayEl.checked;
            }

            const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
            if (fixedDelayDurationEl) {
                state.fixedDelayDuration = parseInt(fixedDelayDurationEl.value);
            }

            // åˆå§‹åŒ–éŸ³é«˜æ£€æµ‹è®¾ç½®
            const sensitivityEl = document.getElementById('sensitivity');
            if (sensitivityEl) {
                state.sensitivity = parseFloat(sensitivityEl.value);
            }

            const confidenceThresholdEl = document.getElementById('confidenceThreshold');
            if (confidenceThresholdEl) {
                state.confidenceThreshold = parseFloat(confidenceThresholdEl.value);
            }
            
            // åœ¨åˆå§‹åŒ–å®ŒæˆååŠ è½½ä¿å­˜çš„è®¾ç½®ï¼ˆè¿™æ ·å¯ä»¥è¦†ç›–é»˜è®¤å€¼ï¼‰
            setTimeout(() => {
                loadSettings();
            }, 100);

            // è®¾ç½®ç®¡ç†åŠŸèƒ½
            function saveSettings() {
                const settings = {
                    // ç»ƒä¹ è®¾ç½®
                    enableCooldown: state.enableCooldown,
                    cooldownDuration: state.cooldownDuration,
                    enableFixedDelay: state.enableFixedDelay,
                    fixedDelayDuration: state.fixedDelayDuration,
                    
                    // éŸ³é«˜æ£€æµ‹è®¾ç½®
                    sensitivity: state.sensitivity,
                    confidenceThreshold: state.confidenceThreshold,
                    noiseLevel: state.noiseLevel,
                    minVolume: state.minVolume,
                    
                    // èŠ‚æ‹å™¨è®¾ç½®
                    metronomeEnabled: state.metronomeEnabled,
                    metronomeTempo: state.metronomeTempo,
                    metronomeFlashEnabled: state.metronomeFlashEnabled,
                    metronomeSoundEnabled: state.metronomeSoundEnabled,
                    
                    // éŸ³é¢‘è®¾ç½®
                    selectedDeviceId: selectedDeviceId,
                    inputGain: inputGain,
                    
                    // ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç”¨äºå…¼å®¹æ€§æ£€æŸ¥ï¼‰
                    version: '1.0'
                };
                
                try {
                    localStorage.setItem('guitarPracticeSettings', JSON.stringify(settings));
                    console.log('è®¾ç½®å·²ä¿å­˜');
                } catch (error) {
                    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                }
            }
            
            function loadSettings() {
                try {
                    const savedSettings = localStorage.getItem('guitarPracticeSettings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        
                        // æ›´æ–°stateå¯¹è±¡
                        if (settings.enableCooldown !== undefined) state.enableCooldown = settings.enableCooldown;
                        if (settings.cooldownDuration !== undefined) state.cooldownDuration = settings.cooldownDuration;
                        if (settings.enableFixedDelay !== undefined) state.enableFixedDelay = settings.enableFixedDelay;
                        if (settings.fixedDelayDuration !== undefined) state.fixedDelayDuration = settings.fixedDelayDuration;
                        if (settings.sensitivity !== undefined) state.sensitivity = settings.sensitivity;
                        if (settings.confidenceThreshold !== undefined) state.confidenceThreshold = settings.confidenceThreshold;
                        if (settings.noiseLevel !== undefined) state.noiseLevel = settings.noiseLevel;
                        if (settings.minVolume !== undefined) state.minVolume = settings.minVolume;
                        if (settings.metronomeEnabled !== undefined) state.metronomeEnabled = settings.metronomeEnabled;
                        if (settings.metronomeTempo !== undefined) state.metronomeTempo = settings.metronomeTempo;
                        if (settings.metronomeFlashEnabled !== undefined) state.metronomeFlashEnabled = settings.metronomeFlashEnabled;
                        if (settings.metronomeSoundEnabled !== undefined) state.metronomeSoundEnabled = settings.metronomeSoundEnabled;
                        if (settings.selectedDeviceId !== undefined) selectedDeviceId = settings.selectedDeviceId;
                        if (settings.inputGain !== undefined) inputGain = settings.inputGain;
                        
                        // æ›´æ–°ç•Œé¢å…ƒç´ 
                        updateUIFromSettings();
                        
                        console.log('è®¾ç½®å·²åŠ è½½');
                        return true;
                    }
                } catch (error) {
                    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                }
                return false;
            }
            
            function updateUIFromSettings() {
                // æ›´æ–°ç»ƒä¹ è®¾ç½®
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.checked = state.enableCooldown;
                }
                
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.value = state.cooldownDuration;
                    cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                }
                
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.checked = state.enableFixedDelay;
                }
                
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.value = state.fixedDelayDuration;
                    fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                }
                
                // æ›´æ–°éŸ³é«˜æ£€æµ‹è®¾ç½®
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.value = state.sensitivity;
                    sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                }
                
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.value = state.confidenceThreshold;
                    confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                }
                
                // æ›´æ–°èŠ‚æ‹å™¨è®¾ç½®
                const metronomeToggleEl = document.getElementById('metronomeToggle');
                if (metronomeToggleEl) {
                    metronomeToggleEl.checked = state.metronomeEnabled;
                }
                
                const metronomeTempoEl = document.getElementById('metronomeTempo');
                const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
                if (metronomeTempoEl && metronomeTempoValueEl) {
                    metronomeTempoEl.value = state.metronomeTempo;
                    metronomeTempoValueEl.textContent = state.metronomeTempo;
                }
                
                // æ›´æ–°èŠ‚æ‹å™¨é€‰é¡¹è®¾ç½®
                const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
                if (metronomeFlashToggleEl) {
                    metronomeFlashToggleEl.checked = state.metronomeFlashEnabled;
                }
                
                const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
                if (metronomeSoundToggleEl) {
                    metronomeSoundToggleEl.checked = state.metronomeSoundEnabled;
                }
                
                // æ›´æ–°éŸ³é¢‘è®¾ç½®
                const audioInputDeviceEl = document.getElementById('audioInputDevice');
                if (audioInputDeviceEl && selectedDeviceId) {
                    // ç­‰å¾…è®¾å¤‡åˆ—è¡¨æ›´æ–°å®Œæˆåå†è®¾ç½®é€‰ä¸­é¡¹
                    setTimeout(() => {
                        audioInputDeviceEl.value = selectedDeviceId;
                    }, 100);
                }
                
                const inputGainEl = document.getElementById('inputGain');
                const inputGainValueEl = document.getElementById('inputGainValue');
                if (inputGainEl && inputGainValueEl) {
                    inputGainEl.value = inputGain * 100;
                    inputGainValueEl.textContent = Math.round(inputGain * 100) + '%';
                }
            }
            
            function resetSettings() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤åˆ°é»˜è®¤å€¼ã€‚')) {
                    try {
                        localStorage.removeItem('guitarPracticeSettings');
                        
                        // é‡ç½®ä¸ºé»˜è®¤å€¼
                        state.enableCooldown = true;
                        state.cooldownDuration = 600;
                        state.enableFixedDelay = false;
                        state.fixedDelayDuration = 800;
                        state.sensitivity = 0.5;
                        state.confidenceThreshold = 0.5;
                        state.noiseLevel = 0.001;
                        state.minVolume = 0.001;
                        state.metronomeEnabled = false;
                        state.metronomeTempo = 40;
                        state.metronomeFlashEnabled = true;
                        state.metronomeSoundEnabled = true;
                        selectedDeviceId = 'default';
                        inputGain = 1.0;
                        
                        updateUIFromSettings();
                        
                        alert('è®¾ç½®å·²é‡ç½®ä¸ºé»˜è®¤å€¼');
                        console.log('è®¾ç½®å·²é‡ç½®');
                    } catch (error) {
                        console.error('é‡ç½®è®¾ç½®å¤±è´¥:', error);
                    }
                }
            }
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('å±å¹•å”¤é†’é”å·²æ¿€æ´»');

                        wakeLock.addEventListener('release', () => {
                            console.log('å±å¹•å”¤é†’é”å·²é‡Šæ”¾');
                        });
                    }
                } catch (err) {
                    console.error(`æ— æ³•è·å–å±å¹•å”¤é†’é”: ${err.message}`);
                }
            }

            // é‡Šæ”¾å±å¹•å”¤é†’é”
            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }

            // è·å–éŸ³é¢‘è®¾å¤‡åˆ—è¡¨
            async function getAudioDevices() {
                try {
                    // è¯·æ±‚æƒé™ä»¥è·å–è®¾å¤‡æ ‡ç­¾
                    await navigator.mediaDevices.getUserMedia({ audio: true });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    audioDevices = devices.filter(device => device.kind === 'audioinput');

                    updateAudioDeviceSelector();
                    checkForAudioInterfaces();
                    
                    // ä¿å­˜è®¾ç½®ä»¥ç¡®ä¿è®¾å¤‡é€‰æ‹©è¢«è®°ä½
                    saveSettings();
                } catch (error) {
                    console.error('è·å–éŸ³é¢‘è®¾å¤‡å¤±è´¥:', error);
                    deviceInfoEl.textContent = "æ— æ³•è·å–éŸ³é¢‘è®¾å¤‡åˆ—è¡¨ï¼Œè¯·ç¡®ä¿å·²æˆäºˆéº¦å…‹é£æƒé™";
                }
            }

            // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
            function updateAudioDeviceSelector() {
                const selector = document.getElementById('audioInputDevice');
                selector.innerHTML = '<option value="default">é»˜è®¤è®¾å¤‡</option>';

                // è®¾å¤‡åç§°æ˜ å°„è¡¨
                const deviceNameMap = {
                    'Speakerphone': 'éº¦å…‹é£',
                    'Headset earpiece': 'USBéŸ³é¢‘'
                };

                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // åº”ç”¨è®¾å¤‡åç§°æ˜ å°„
                    let displayName = device.label || `éŸ³é¢‘è®¾å¤‡ ${selector.options.length}`;
                    if (deviceNameMap[displayName]) {
                        displayName = deviceNameMap[displayName];
                    }
                    
                    option.textContent = displayName;
                    selector.appendChild(option);
                });

                // æ¢å¤ä¹‹å‰ä¿å­˜çš„è®¾å¤‡é€‰æ‹©
                if (selectedDeviceId && selectedDeviceId !== 'default') {
                    selector.value = selectedDeviceId;
                }

                if (audioDevices.length > 0) {
                    deviceInfoEl.textContent = `æ£€æµ‹åˆ° ${audioDevices.length} ä¸ªéŸ³é¢‘è¾“å…¥è®¾å¤‡`;
                } else {
                    deviceInfoEl.textContent = "æœªæ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥è®¾å¤‡";
                }
            }

            // æ£€æµ‹æ˜¯å¦æœ‰ä¸“ä¸šéŸ³é¢‘è®¾å¤‡
            function checkForAudioInterfaces() {
                const hasProfessionalDevices = audioDevices.some(device =>
                    device.label.toLowerCase().includes('interface') ||
                    device.label.toLowerCase().includes('usb') ||
                    device.label.toLowerCase().includes('focusrite') ||
                    device.label.toLowerCase().includes('scarlett') ||
                    device.label.toLowerCase().includes('presonus') ||
                    device.label.toLowerCase().includes('behringer') ||
                    device.label.toLowerCase().includes('steinberg') ||
                    device.label.toLowerCase().includes('zoom') ||
                    device.label.toLowerCase().includes('boss') ||
                    device.label.toLowerCase().includes('line6')
                );

                if (hasProfessionalDevices) {
                    showAudioInterfaceTip();
                }
            }

            function showAudioInterfaceTip() {
                const tip = document.createElement('div');
                tip.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    background: rgba(56, 189, 248, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 1002;
                    max-width: 250px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                tip.innerHTML = `
                    <strong><span class="usb-indicator"></span> USBå£°å¡å·²æ£€æµ‹</strong><br>
                    å»ºè®®é€‰æ‹©æ‚¨çš„éŸ³é¢‘æ¥å£è®¾å¤‡ä»¥è·å¾—æœ€ä½³æ•ˆæœ
                `;
                document.body.appendChild(tip);

                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.parentNode.removeChild(tip);
                    }
                }, 5000);
            }

            // ä½¿ç”¨æŒ‡å®šè®¾å¤‡é‡æ–°å¯åŠ¨éŸ³é¢‘
            async function restartAudioWithNewDevice() {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 100));
                startRecording();
            }

            // å¯åŠ¨éº¦å…‹é£å½•éŸ³ - æ”¯æŒè®¾å¤‡é€‰æ‹©
            async function startRecording() {
                if (isRecording) return;

                try {
                    const constraints = {
                        audio: {
                            deviceId: selectedDeviceId !== 'default' ?
                                { exact: selectedDeviceId } : undefined,
                            sampleRate: 48000,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            latency: 0.01
                        }
                    };

                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 48000,
                            latencyHint: 'interactive'
                        });
                    }

                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 4096;

                    // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ç”¨äºéŸ³é‡æ§åˆ¶
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = inputGain;

                    javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                    javascriptNode.onaudioprocess = processAudio;

                    microphone = audioContext.createMediaStreamSource(mediaStream);

                    // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹ï¼šéº¦å…‹é£ -> å¢ç›Š -> åˆ†æå™¨ -> å¤„ç†èŠ‚ç‚¹ -> è¾“å‡º
                    microphone.connect(gainNode);
                    gainNode.connect(analyser);
                    analyser.connect(javascriptNode);
                    javascriptNode.connect(audioContext.destination);

                    isRecording = true;
                    state.microphoneInitialized = true;
                    updateStatusIndicator('å½•éŸ³ä¸­...', 'recording');

                    console.log('éŸ³é¢‘è¾“å…¥å·²å¯åŠ¨ï¼Œè®¾å¤‡:',
                        selectedDeviceId === 'default' ? 'é»˜è®¤è®¾å¤‡' :
                            audioDevices.find(d => d.deviceId === selectedDeviceId)?.label);

                } catch (e) {
                    console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                    updateStatusIndicator('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥', 'error');

                    // å°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®
                    if (e.name === 'OverconstrainedError') {
                        console.log('å°è¯•ä½¿ç”¨å…¼å®¹çš„éŸ³é¢‘è®¾ç½®...');
                        try {
                            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            initializeBasicAudio();
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨éŸ³é¢‘åˆå§‹åŒ–ä¹Ÿå¤±è´¥:', fallbackError);
                        }
                    }
                }
            }

            // ç®€åŒ–çš„éŸ³é¢‘åˆå§‹åŒ–ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
            function initializeBasicAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
                javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                javascriptNode.onaudioprocess = processAudio;

                microphone = audioContext.createMediaStreamSource(mediaStream);
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                isRecording = true;
                state.microphoneInitialized = true;
                updateStatusIndicator('å½•éŸ³ä¸­(å…¼å®¹æ¨¡å¼)', 'recording');
            }

            // åœæ­¢éº¦å…‹é£å½•éŸ³
            function stopRecording() {
                if (!isRecording) return;

                if (javascriptNode) {
                    javascriptNode.disconnect();
                }
                if (analyser) {
                    analyser.disconnect();
                }
                if (microphone) {
                    microphone.disconnect();
                }
                if (gainNode) {
                    gainNode.disconnect();
                }

                isRecording = false;
            }

            // å®Œå…¨å…³é—­éº¦å…‹é£ï¼ˆé€€å‡ºåº”ç”¨æ—¶ä½¿ç”¨ï¼‰
            function closeMicrophone() {
                stopRecording();

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                state.microphoneInitialized = false;
            }

            // è¾…åŠ©å‡½æ•°å’Œç±»
            class MedianFilter {
                constructor(size) {
                    this.size = Math.max(1, size | 0);
                    this.buffer = [];
                }
                push(val) {
                    this.buffer.push(val == null ? null : val);
                    if (this.buffer.length > this.size) this.buffer.shift();
                    const arr = this.buffer.filter(v => v != null);
                    if (arr.length === 0) return null;
                    const sorted = arr.slice().sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    if (sorted.length % 2 === 1) return sorted[mid];
                    return (sorted[mid - 1] + sorted[mid]) / 2;
                }
            }

            function ema(prev, current, alpha) {
                if (prev == null) return current;
                return alpha * current + (1 - alpha) * prev;
            }

            function applyHannWindow(buf) {
                const N = buf.length;
                for (let i = 0; i < N; i++) {
                    const w = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (N - 1)));
                    buf[i] *= w;
                }
            }

            function rms(buf) {
                let sum = 0;
                for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
                return Math.sqrt(sum / buf.length);
            }

            function downsampleBuffer(buffer, originalRate, targetRate) {
                if (targetRate >= originalRate) return buffer.slice(0);
                const ratio = originalRate / targetRate;
                const newLength = Math.floor(buffer.length / ratio);
                const out = new Float32Array(newLength);
                for (let i = 0; i < newLength; i++) {
                    const start = Math.floor(i * ratio);
                    const end = Math.floor((i + 1) * ratio);
                    let sum = 0;
                    for (let j = start; j < end && j < buffer.length; j++) sum += buffer[j];
                    out[i] = sum / Math.max(1, end - start);
                }
                return out;
            }

            function YINDetectorFactory(sampleRate, config) {
                config = config || {};
                const threshold = config.threshold || 0.15;
                const probabilityCliff = config.probabilityCliff || 0.1;
                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }
                    if (tauEstimate === -1) return null;
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }
                    const frequency = sampleRate / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));
                    if (probability < probabilityCliff) return null;
                    return { frequency, probability };
                };
            }

            // å¢å¼ºç‰ˆéŸ³é«˜æ£€æµ‹å™¨
            class EnhancedPitchDetector {
                constructor() {
                    this.bufferSize = 8; // å¢åŠ ç¼“å†²åŒºå¤§å°ï¼Œæé«˜ç¨³å®šæ€§
                    this.pitchBuffer = [];
                    this.lastStablePitch = null;
                    this.stabilityCounter = 0;
                    this.frequencyBias = { // é’ˆå¯¹ç‰¹å®šé¢‘ç‡èŒƒå›´çš„åå·®æ ¡æ­£
                        'F': 1.02,  // è½»å¾®æå‡FåŒºåŸŸçš„æ£€æµ‹å€¼
                        'Fâ™¯': 0.98  // è½»å¾®é™ä½Fâ™¯åŒºåŸŸçš„æ£€æµ‹å€¼
                    };
                }

                detect(float32AudioBuffer, sampleRate) {
                    // ä½¿ç”¨YINç®—æ³•ä½œä¸ºåŸºç¡€ï¼Œä½†é™ä½é˜ˆå€¼æé«˜çµæ•åº¦
                    const yinPitch = Pitchfinder.YIN({ threshold: 0.08 })(float32AudioBuffer);

                    // ä½¿ç”¨å¢å¼ºçš„è‡ªç›¸å…³æ£€æµ‹
                    const autocorrPitch = this.autocorrelationDetect(float32AudioBuffer, sampleRate);

                    // ç»“åˆä¸¤ç§ç®—æ³•ç»“æœï¼Œå¹¶åº”ç”¨é¢‘ç‡åå·®æ ¡æ­£
                    let finalPitch = this.combineResults(yinPitch, autocorrPitch, sampleRate);

                    // åº”ç”¨æ›´ä¸¥æ ¼çš„æ»¤æ³¢å’Œç¼“å†²
                    finalPitch = this.applyFilter(finalPitch);

                    // åº”ç”¨é¢‘ç‡åå·®æ ¡æ­£
                    finalPitch = this.applyFrequencyBias(finalPitch);

                    return finalPitch;
                }

                autocorrelationDetect(buffer, sampleRate) {
                    // å¢å¼ºç‰ˆè‡ªç›¸å…³ç®—æ³•ï¼Œç‰¹åˆ«ä¼˜åŒ–ä¸­é¢‘åŒºåŸŸæ£€æµ‹
                    const maxLag = Math.floor(sampleRate / 65);
                    const minLag = Math.floor(sampleRate / 1000);

                    let bestLag = 0;
                    let bestCorrelation = -1;

                    // ä½¿ç”¨åŠ æƒçª—å£å¢å¼ºFå’ŒFâ™¯åŒºåŸŸçš„æ£€æµ‹
                    const fFreq = 349.23;
                    const fSharpFreq = 369.99;
                    const fLag = Math.floor(sampleRate / fFreq);
                    const fSharpLag = Math.floor(sampleRate / fSharpFreq);

                    for (let lag = minLag; lag <= maxLag; lag++) {
                        let correlation = 0;

                        for (let i = 0; i < buffer.length - lag; i++) {
                            correlation += buffer[i] * buffer[i + lag];
                        }

                        correlation /= (buffer.length - lag);

                        // åº”ç”¨æ±‰å®çª—å‡å°‘è¾¹ç•Œæ•ˆåº”
                        const window = 0.5 * (1 - Math.cos(2 * Math.PI * lag / maxLag));
                        correlation *= window;

                        // å¯¹Få’ŒFâ™¯åŒºåŸŸåº”ç”¨é¢å¤–æƒé‡
                        if (Math.abs(lag - fLag) < 10 || Math.abs(lag - fSharpLag) < 10) {
                            correlation *= 1.2; // å¢å¼ºè¿™äº›åŒºåŸŸçš„ç›¸å…³æ€§
                        }

                        if (correlation > bestCorrelation) {
                            bestCorrelation = correlation;
                            bestLag = lag;
                        }
                    }

                    return bestLag > 0 ? sampleRate / bestLag : null;
                }

                combineResults(yinPitch, autocorrPitch, sampleRate) {
                    if (!yinPitch || yinPitch <= 0) return autocorrPitch;
                    if (!autocorrPitch || autocorrPitch <= 0) return yinPitch;

                    const ratio = yinPitch / autocorrPitch;

                    // æ›´ä¸¥æ ¼çš„ä¸€è‡´æ€§æ£€æŸ¥
                    if (ratio > 0.9 && ratio < 1.1) {
                        // å¦‚æœä¸¤ç§ç®—æ³•ç»“æœæ¥è¿‘ï¼Œå–åŠ æƒå¹³å‡
                        return (yinPitch * 0.6 + autocorrPitch * 0.4);
                    }

                    // å¦åˆ™é€‰æ‹©ç½®ä¿¡åº¦æ›´é«˜çš„ç»“æœ
                    const yinConfidence = this.calculateConfidence(yinPitch, sampleRate);
                    const autocorrConfidence = this.calculateConfidence(autocorrPitch, sampleRate);

                    return yinConfidence > autocorrConfidence ? yinPitch : autocorrPitch;
                }

                applyFilter(pitch) {
                    if (!pitch || pitch <= 0) return null;

                    this.pitchBuffer.push(pitch);
                    if (this.pitchBuffer.length > this.bufferSize) {
                        this.pitchBuffer.shift();
                    }

                    // ä½¿ç”¨ä¸­ä½æ•°æ»¤æ³¢è€Œä¸æ˜¯å¹³å‡å€¼ï¼Œæ›´èƒ½æŠµæŠ—å¼‚å¸¸å€¼
                    const sorted = [...this.pitchBuffer].sort((a, b) => a - b);
                    const medianPitch = sorted[Math.floor(sorted.length / 2)];

                    // å¢å¼ºç¨³å®šæ€§æ£€æµ‹
                    if (this.lastStablePitch) {
                        const ratio = medianPitch / this.lastStablePitch;
                        if (ratio > 0.97 && ratio < 1.03) { // æ›´ä¸¥æ ¼çš„ç¨³å®šæ€§æ ‡å‡†
                            this.stabilityCounter++;
                        } else {
                            this.stabilityCounter = 0;
                        }
                    }

                    if (this.stabilityCounter >= 4) { // éœ€è¦æ›´å¤šçš„è¿ç»­ç¨³å®šæ ·æœ¬
                        this.lastStablePitch = medianPitch;
                    }

                    return this.lastStablePitch || medianPitch;
                }

                applyFrequencyBias(pitch) {
                    if (!pitch) return null;

                    // å°†é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦
                    const note = this.frequencyToNoteName(pitch);

                    // åº”ç”¨ç‰¹å®šéŸ³ç¬¦çš„é¢‘ç‡åå·®æ ¡æ­£
                    if (note && this.frequencyBias[note.name]) {
                        return pitch * this.frequencyBias[note.name];
                    }

                    return pitch;
                }

                frequencyToNoteName(frequency) {
                    const A4 = 440;
                    const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];

                    const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                    const noteIndex = Math.round(noteNum) % 12;
                    const octave = Math.floor(noteNum / 12) - 1;

                    return {
                        name: noteNames[noteIndex],
                        octave: octave
                    };
                }

                calculateConfidence(pitch, sampleRate) {
                    // å¢å¼ºçš„ç½®ä¿¡åº¦è®¡ç®—ï¼Œç‰¹åˆ«å…³æ³¨Få’ŒFâ™¯åŒºåŸŸ
                    if (pitch < 65 || pitch > 1000) return 0;

                    // Få’ŒFâ™¯çš„é¢‘ç‡èŒƒå›´
                    const isInFRange = pitch >= 340 && pitch <= 380;

                    // å¯¹Få’ŒFâ™¯åŒºåŸŸç»™äºˆæ›´é«˜çš„åŸºç¡€ç½®ä¿¡åº¦
                    let confidence = isInFRange ? 1.2 : 1.0;

                    // æ ¹æ®é¢‘ç‡èŒƒå›´è°ƒæ•´ç½®ä¿¡åº¦
                    if (pitch < 100) confidence *= 0.8;
                    else if (pitch > 800) confidence *= 0.8;

                    return Math.min(1.0, confidence);
                }
            }

            // éŸ³é«˜æ£€æµ‹è¾…åŠ©å˜é‡
            const medianFilter = new MedianFilter(5);
            let smoothedFreq = null;

            // é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦åç§°å’Œå…«åº¦
            function freqToNoteInfo(freq) {
                if (!freq || freq <= 0) return null;
                const A4 = 440;
                const noteNumber = 12 * (Math.log(freq / A4) / Math.log(2)) + 69;
                const rounded = Math.round(noteNumber);
                const noteIndex = (rounded + 120) % 12;
                const octave = Math.floor(rounded / 12) - 1;
                const name = NOTE_NAMES[noteIndex] + octave;
                const cents = Math.round((noteNumber - rounded) * 100);
                return { name, cents, midi: rounded };
            }

            // å¢å¼ºä½é¢‘æ£€æµ‹çš„éŸ³é¢‘å¤„ç†å‡½æ•°
            // ä¿®æ”¹processAudioå‡½æ•°ï¼Œåœ¨å†·å´æœŸå†…ä¸å¤„ç†éŸ³é¢‘
            function processAudio(event) {
                if (!isRecording || state.isAnswered || (state.enableCooldown && state.isCoolingDown)) return;

                const inputData = event.inputBuffer.getChannelData(0);
                const sampleRate = audioContext.sampleRate;

                // åŠ¨æ€è°ƒæ•´YINç®—æ³•å‚æ•° - ä½é¢‘ä½¿ç”¨æ›´é«˜çµæ•åº¦
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110; // A2ä»¥ä¸‹è§†ä¸ºä½é¢‘
                });

                const yinParams = isLowFrequencyTarget ?
                    { threshold: 0.05, probabilityCliff: 0.05 } : // ä½é¢‘å‚æ•°
                    { threshold: 0.1, probabilityCliff: 0.1 };   // å¸¸è§„å‚æ•°

                const yinResult = Pitchfinder.YIN(yinParams)(inputData);

                if (!yinResult || !yinResult.frequency) return;

                // åŠ¨æ€èƒ½é‡æ£€æµ‹ - ä½é¢‘ä½¿ç”¨æ›´ä½é˜ˆå€¼
                const energy = rms(inputData);
                const energyThreshold = yinResult.frequency < 110 ? 0.001 : 0.002;
                if (energy < energyThreshold) return;

                // è°æ³¢å¢å¼ºå¤„ç† - ç‰¹åˆ«é’ˆå¯¹ä½é¢‘
                let detectedFreq = yinResult.frequency;
                if (detectedFreq < 110) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŸºé¢‘çš„è°æ³¢
                    const possibleFundamental = detectedFreq / 2;
                    const fundamentalResult = Pitchfinder.YIN(yinParams)(inputData);
                    if (fundamentalResult && fundamentalResult.frequency &&
                        Math.abs(fundamentalResult.frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }

                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // ä¼˜åŒ–éŸ³é«˜åŒ¹é…ç®—æ³•
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // åŠ¨æ€è°ƒæ•´åŒ¹é…é˜ˆå€¼ - ä½é¢‘æ›´å®½æ¾ï¼Œå¹¶ä¸”åŸºäºæ•æ„Ÿåº¦è®¾ç½®
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                
                // æ ¹æ®æ•æ„Ÿåº¦è°ƒæ•´é˜ˆå€¼ - æ•æ„Ÿåº¦è¶Šé«˜ï¼Œé˜ˆå€¼è¶Šå°
                const threshold = baseThreshold * (2 - state.sensitivity);

                if (adjustedCents <= threshold && yinResult.probability > state.confidenceThreshold) {
                    handleCorrectAnswer();
                }

                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }


            // åº”ç”¨é«˜é€šæ»¤æ³¢å™¨
            function applyHighPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = RC / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = alpha * (y + buffer[i] - buffer[i - 1]);
                    buffer[i] = y;
                }
            }

            // åº”ç”¨ä½é€šæ»¤æ³¢å™¨
            function applyLowPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = dt / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = y + alpha * (buffer[i] - y);
                    buffer[i] = y;
                }
            }

            // è®¡ç®—ä¿¡å·å¼ºåº¦ä½œä¸ºç½®ä¿¡åº¦çš„ä¼°è®¡
            function calculateSignalStrength(buffer) {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += Math.abs(buffer[i]);
                }
                const average = sum / buffer.length;
                return Math.min(1.0, average * 10);
            }

            // é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦åç§°å’Œå…«åº¦
            function frequencyToNoteName(frequency) {
                const A4 = 440;
                const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];

                const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                const noteIndex = Math.round(noteNum) % 12;
                const octave = Math.floor(noteNum / 12) - 1;

                return {
                    name: noteNames[noteIndex],
                    octave: octave
                };
            }

            // æ£€æŸ¥æ£€æµ‹åˆ°çš„éŸ³é«˜æ˜¯å¦åŒ¹é…å½“å‰æ­¥éª¤çš„ç›®æ ‡éŸ³é«˜
            function checkPitchMatch(detectedPitch, confidence) {
                if (state.isAnswered || confidence < state.confidenceThreshold) return;

                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;

                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                const cents = 1200 * Math.log2(detectedPitch / targetFrequency);

                updatePitchDisplay(detectedPitch, cents, confidence);

                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // å¯¹Få’ŒFâ™¯éŸ³ç¬¦ä½¿ç”¨æ›´å®½æ¾çš„åŒ¹é…æ ‡å‡†ï¼ŒåŒæ—¶è€ƒè™‘æ•æ„Ÿåº¦è®¾ç½®
                const detectedNote = frequencyToNoteName(detectedPitch);
                let baseCentsThreshold = 20; // é»˜è®¤éŸ³åˆ†å·®é˜ˆå€¼

                // æ£€æŸ¥ç›®æ ‡éŸ³ç¬¦æ˜¯å¦ä¸ºFæˆ–Fâ™¯
                const targetNote = frequencyToNoteName(targetFrequency);
                if (targetNote.name === 'F' || targetNote.name === 'Fâ™¯') {
                    baseCentsThreshold = 35; // å¯¹Få’ŒFâ™¯ä½¿ç”¨æ›´å®½æ¾çš„é˜ˆå€¼
                }

                // å¦‚æœæ£€æµ‹åˆ°çš„éŸ³ç¬¦æ˜¯Fæˆ–Fâ™¯ï¼Œä¹Ÿä½¿ç”¨æ›´å®½æ¾çš„é˜ˆå€¼
                if (detectedNote.name === 'F' || detectedNote.name === 'Fâ™¯') {
                    baseCentsThreshold = Math.max(baseCentsThreshold, 35);
                }

                // æ ¹æ®æ•æ„Ÿåº¦è°ƒæ•´é˜ˆå€¼
                const centsThreshold = baseCentsThreshold * (2 - state.sensitivity);

                if (adjustedCents <= centsThreshold) {
                    handleCorrectAnswer();
                }
            }

            // æ›´æ–°å®æ—¶éŸ³é«˜æ˜¾ç¤º
            function updatePitchDisplay(frequency, cents, confidence) {
                const pitchDisplay = document.getElementById('pitchDisplay');
                if (!pitchDisplay) return;

                const note = frequencyToNoteName(frequency);
                const centsMod = cents % 1200;
                const adjustedCents = centsMod > 600 ? centsMod - 1200 : centsMod;
                const roundedFreq = Math.round(frequency);
                const roundedCents = Math.round(adjustedCents);
                const confidencePercent = Math.round(confidence * 100);

                if (!pitchDisplay._cache) {
                    pitchDisplay._cache = {
                        note: '',
                        octave: '',
                        freq: 0,
                        cents: 0,
                        confidence: 0,
                        inTune: false
                    };
                }

                const cache = pitchDisplay._cache;
                const inTune = Math.abs(adjustedCents) <= 20;

                if (cache.note !== note.name ||
                    cache.octave !== note.octave ||
                    cache.freq !== roundedFreq ||
                    cache.cents !== roundedCents ||
                    cache.confidence !== confidencePercent ||
                    cache.inTune !== inTune) {

                    cache.note = note.name;
                    cache.octave = note.octave;
                    cache.freq = roundedFreq;
                    cache.cents = roundedCents;
                    cache.confidence = confidencePercent;
                    cache.inTune = inTune;

                    const children = pitchDisplay.children;

                    if (children.length < 3) {
                        pitchDisplay.innerHTML = `
                            <div>éŸ³é«˜: ${note.name}${note.octave} (${roundedFreq}Hz)</div>
                            <div>éŸ³åˆ†å·®: ${adjustedCents > 0 ? '+' : ''}${roundedCents}</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        `;
                    } else {
                        children[0].textContent = `éŸ³é«˜: ${note.name}${note.octave} (${roundedFreq}Hz)`;
                        children[1].textContent = `éŸ³åˆ†å·®: ${adjustedCents > 0 ? '+' : ''}${roundedCents}`;
                        children[2].querySelector('.confidence-fill').style.width = `${confidencePercent}%`;
                    }

                    pitchDisplay.classList.toggle('in-tune', inTune);
                    pitchDisplay.classList.toggle('out-of-tune', !inTune);
                }
            }

            // ä¼˜åŒ–åçš„æ­£ç¡®ç­”æ¡ˆå¤„ç†
            function handleCorrectAnswer() {
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;

                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }

                requestAnimationFrame(() => {
                    if (state.currentStep >= state.currentSequence.length) {
                        state.isAnswered = true;

                        // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦è¿›å…¥å†·å´æœŸ
                        if (state.enableCooldown) {
                            state.isCoolingDown = true;
                            if (state.cooldownTimeout) {
                                clearTimeout(state.cooldownTimeout);
                            }
                            state.cooldownTimeout = setTimeout(() => {
                                state.isCoolingDown = false;
                            }, state.cooldownDuration);
                        }

                        // æ ¹æ®è®¾ç½®å†³å®šå»¶è¿Ÿæ—¶é—´
                        let delayTime = 0; // é»˜è®¤æ— å»¶è¿Ÿ
                        if (state.enableFixedDelay) {
                            delayTime = state.fixedDelayDuration;
                        }

                        // å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜ï¼Œç»™ç”¨æˆ·åœæ­¢å¼¹å¥çš„æ—¶é—´
                        setTimeout(() => {
                            generateExercise();
                        }, delayTime);
                    } else {
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                    }
                });
            }

            // é¢„ç”Ÿæˆä¸‹ä¸€ä¸ªç»ƒä¹ 
            function generateNextExercise() {
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;

                if (activeTab === 'scale') {
                    let rootNote = rootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }

                    let scaleType = scaleTypeEl.value;
                    if (scaleType === 'random') {
                        const types = Object.keys(scaleTypes);
                        scaleType = types[Math.floor(Math.random() * types.length)];
                    }

                    // è·å–æ–¹å‘
                    const activeOrderBtn = document.querySelector('.scale-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                    // è·å–æ—‹å¾‹æ¨¡è¿›ç±»å‹
                    const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                    let arpeggioType = '1to1';
                    
                    for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                      if (arpeggioTypeButtons[i].classList.contains('active')) {
                        arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                        break;
                      }
                    }

                    // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒï¼šæ ¹æ®æ–¹å‘é€‰æ‹©ä¸Šè¡Œæˆ–ä¸‹è¡Œå½¢å¼
                    let intervals;
                    let isMelodicMinorDescending = false;
                    if (scaleType === 'melodicMinor' && order === 'reverse') {
                        // ä¸‹è¡Œæ—‹å¾‹å°è°ƒ
                        intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                        isMelodicMinorDescending = true;
                    } else {
                        // é»˜è®¤ä½¿ç”¨ä¸Šè¡Œå½¢å¼
                        intervals = [...scaleTypes[scaleType].intervals];
                    }
                    state.currentIntervals = intervals;
                    let startEndInterval = '1'; // é»˜è®¤ä½¿ç”¨1ä½œä¸ºé¦–å°¾éŸ³
                    
                    // æ ¹æ®ç»ƒä¹ åºåˆ—ç±»å‹ç¡®å®šé¦–å°¾éŸ³
                    if (arpeggioType === 'random-arpeggio') {
                        // éšæœºé€‰æ‹©1ã€3ã€5ã€7éŸ³ä½œä¸ºé¦–å°¾éŸ³ï¼Œä½†åªåŒ…å«éŸ³é˜¶ä¸­å®é™…å­˜åœ¨çš„éŸ³ç¨‹
                        const availableChordTones = [];
                        const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                        if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                        const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                        if (fifthInterval) availableChordTones.push(fifthInterval);
                        const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                        if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                        
                        // å¦‚æœæœ‰å¯ç”¨çš„3/5/7åº¦éŸ³ç¨‹ï¼Œåˆ™ä»ä¸­éšæœºé€‰æ‹©
                        if (availableChordTones.length > 0) {
                            startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                        } else {
                            startEndInterval = '1'; // å›é€€åˆ°æ ¹éŸ³
                        }
                    } else if (arpeggioType === '3to3') {
                        // ä½¿ç”¨3éŸ³ä½œä¸ºé¦–å°¾éŸ³
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    } else if (arpeggioType === '5to5') {
                        // ä½¿ç”¨5éŸ³ä½œä¸ºé¦–å°¾éŸ³
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    } else if (arpeggioType === '7to7') {
                        // ä½¿ç”¨7éŸ³ä½œä¸ºé¦–å°¾éŸ³
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                        // å¤„ç†å…¶ä»–ç‰¹å®šéŸ³ç¨‹ä½œä¸ºé¦–å°¾éŸ³çš„æƒ…å†µï¼ˆå¦‚â™¯6â†’â™¯6ï¼‰
                        // arpeggioTypeæ ¼å¼ä¸º"xtox"ï¼Œæå–xéƒ¨åˆ†
                        const match = arpeggioType.match(/^(.+)to\1$/);
                        if (match) {
                            const intervalType = match[1];
                            console.log('å¤„ç†ç‰¹å®šéŸ³ç¨‹:', intervalType, 'åœ¨éŸ³é˜¶ä¸­:', state.currentIntervals);
                            // æŸ¥æ‰¾éŸ³é˜¶ä¸­å¯¹åº”çš„éŸ³ç¨‹
                            const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                            console.log('æ‰¾åˆ°çš„å®Œæ•´éŸ³ç¨‹:', completeInterval);
                            if (completeInterval) {
                                startEndInterval = completeInterval;
                            } else {
                                const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                                console.log('æ‰¾åˆ°çš„æœ€è¿‘éŸ³ç¨‹:', nearestInterval);
                                startEndInterval = nearestInterval || intervalType;
                            }
                            console.log('æœ€ç»ˆé¦–å°¾éŸ³:', startEndInterval);
                        }
                    }

                    // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒä¸‹è¡Œï¼šç›´æ¥ä½¿ç”¨é¢„å®šä¹‰çš„åºåˆ—ï¼Œä¸è¿›è¡Œé¢å¤–å¤„ç†
                    if (!isMelodicMinorDescending) {
                        if (order === 'reverse') {
                            // å€’åºæ¨¡å¼
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åå€’åºï¼Œæœ€åæ·»åŠ é¦–å°¾éŸ³
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                    const middleIntervals = state.currentIntervals.slice(1).reverse();
                                    state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // ä¿æŒåŸæœ‰çš„å€’åºé€»è¾‘
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else if (order === 'random') {
                            // éšæœºæ¨¡å¼
                            if (arpeggioType === 'random-arpeggio') {
                                // å¯¹äºéšæœºå’Œå¼¦ç±»å‹ï¼Œæ•´ä¸ªåºåˆ—éƒ½åº”è¯¥åªåŒ…å«å’Œå¼¦éŸ³ï¼ˆ1ã€3ã€5ã€7åº¦éŸ³ç¨‹ï¼‰
                                // æ”¶é›†æ‰€æœ‰å®é™…å­˜åœ¨çš„3/5/7åº¦éŸ³ç¨‹
                                const availableChordTones = [];
                                const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                                if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                                const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                                if (fifthInterval) availableChordTones.push(fifthInterval);
                                const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                                if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                                
                                // å¦‚æœæ‰¾ä¸åˆ°è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œå›é€€åˆ°ä½¿ç”¨é¦–å°¾éŸ³
                                if (availableChordTones.length > 0) {
                                    // éšæœºæ‰“ä¹±å’Œå¼¦éŸ³
                                    const shuffledChordTones = [...availableChordTones];
                                    for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                    }
                                    
                                    // ä»æ‰¾åˆ°çš„å’Œå¼¦éŸ³ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸ºé¦–å°¾éŸ³
                                    startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                    
                                    // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿åŒ…å«é¦–å°¾éŸ³
                                    state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                                } else {
                                    // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œä½¿ç”¨æ ¹éŸ³ä½œä¸ºæ•´ä¸ªåºåˆ—
                                    state.currentIntervals = ['1', '1'];
                                }
                            } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                                // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // æå–é™¤äº†é¦–å°¾éŸ³ä¹‹å¤–çš„æ‰€æœ‰éŸ³
                                    const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                    
                                    // éšæœºæ‰“ä¹±
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    
                                    // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿é¦–å°¾éƒ½æ˜¯æŒ‡å®šçš„éŸ³
                                    state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                    const otherIntervals = state.currentIntervals.slice(1);
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // ä¿æŒåŸæœ‰çš„éšæœºé€»è¾‘
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // é¡ºåºæ¨¡å¼
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åæ·»åŠ é¦–å°¾éŸ³
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                    state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                                }
                            } else {
                                // ä¿æŒåŸæœ‰çš„é¡ºåºé€»è¾‘
                                state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                            }
                        }
                    }

                    state.nextExerciseInfo = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                    // ä¿®å¤ï¼šä½¿ç”¨å¤„ç†åçš„state.currentIntervalsè€Œä¸æ˜¯åŸå§‹çš„intervals
                    state.nextExerciseIntervals = [...state.currentIntervals];
                } else if (activeTab === 'progression') {
                    // å’Œå¼¦è½¬æ¢ç»ƒä¹ é¢„ç”Ÿæˆä¸‹ä¸€é¢˜ï¼ˆä½¿ç”¨å·²å­˜å‚¨çš„å’Œå¼¦è¿›è¡Œå’Œç´¢å¼•ï¼‰
                    if (state.progressionChords && state.progressionIndex !== undefined) {
                        const chords = state.progressionChords;
                        const enableRepeatEl = document.getElementById('enableRepeat');
                        const progressionLevelEl = document.getElementById('progressionLevel');
                        
                        // è·å–ä¸‹ä¸€ä¸ªå’Œå¼¦çš„ç´¢å¼•
                        let nextIndex = state.progressionIndex;
                        
                        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå’Œå¼¦æ•°é‡
                        if (nextIndex >= chords.length) {
                            const isRepeatEnabled = enableRepeatEl.checked;
                            if (isRepeatEnabled) {
                                nextIndex = 0; // é‡æ–°å¼€å§‹
                            } else {
                                state.nextExerciseInfo = 'ç»ƒä¹ å®Œæˆ';
                                state.nextExerciseIntervals = [];
                                return;
                            }
                        }
                        
                        if (nextIndex < chords.length) {
                            const nextChord = chords[nextIndex];
                            const level = progressionLevelEl.value;
                            let intervals = getIntervalsForLevel(level);
                            
                            state.nextExerciseInfo = nextChord; // åªæ˜¾ç¤ºå’Œå¼¦å
                            state.nextExerciseIntervals = intervals;
                        }
                    }
                } else {
                    // å’Œå¼¦ç»ƒä¹ é¢„ç”Ÿæˆä¸‹ä¸€é¢˜
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼ï¼Œç›´æ¥ä»è‡ªå®šä¹‰å’Œå¼¦åºåˆ—ä¸­è·å–ä¸‹ä¸€ä¸ªå’Œå¼¦
                    if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            return { root, type };
                        });

                        const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                        const nextIndex = (currentIndex + 1) % chords.length;
                        const nextChord = chords[nextIndex];

                        state.nextExerciseInfo = formatChordSymbol(nextChord.root, nextChord.type);                        state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    } else {
                        // å¸¸è§„å’Œå¼¦æ¨¡å¼ - å®æ—¶è·å–å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹
                        let rootNote = chordRootNoteEl.value;
                        if (rootNote === 'random') {
                            const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                            rootNote = notes[Math.floor(Math.random() * notes.length)];
                        }

                        // å®æ—¶è·å–å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
                        const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                        let chordType = 'major';
                        if (activeChordTypes.length > 0) {
                            const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                            chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                        } else {
                            // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œä¸ç”Ÿæˆé»˜è®¤å’Œå¼¦ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç©ºå€¼
                            console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œæ— æ³•ç”Ÿæˆç»ƒä¹ ');
                            return; // ä¸ç”Ÿæˆç»ƒä¹ 
                        }

                        const activeOrderBtn = document.querySelector('.chord-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                        let intervals = [...chordTypes[chordType].intervals];
                        if (order === 'reverse') {
                            // ä¸‹è¡Œæ¨¡å¼ï¼šå€’åºæ’åˆ—
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }

                        const chordSymbol = formatChordSymbol(rootNote, chordType);
                        state.nextExerciseInfo = chordSymbol;
                        state.nextExerciseIntervals = intervals;
                    }
                }

                updateNextExerciseDisplay();
            }
            function requestRecordPermission() {
                // ä½¿ç”¨æ ‡å‡†Web APIè¯·æ±‚åª’ä½“æƒé™
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            // ç”¨æˆ·å·²æˆæƒï¼Œå¯ä»¥å¼€å§‹å½•éŸ³
                            console.log('å½•éŸ³æƒé™å·²è·å–');
                            // è°ƒç”¨ä½ çš„å¼€å§‹å½•éŸ³é€»è¾‘
                            // startRecording();
                            
                            // åœæ­¢ä¸´æ—¶æµï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨æ£€æŸ¥æƒé™
                            stream.getTracks().forEach(track => track.stop());
                        })
                        .catch(function(err) {
                            console.error('è·å–å½•éŸ³æƒé™å¤±è´¥:', err);
                            if (err.name === 'NotAllowedError') {
                                console.log('ç”¨æˆ·æ‹’ç»æˆæƒ');
                            } else if (err.name === 'NotFoundError') {
                                console.log('æœªæ‰¾åˆ°å½•éŸ³è®¾å¤‡');
                            } else {
                                console.log('æƒé™ç”³è¯·é”™è¯¯');
                            }
                        });
                } else {
                    console.warn('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡API');
                }
            }
            // æ›´æ–°ä¸‹ä¸€ä¸ªç»ƒä¹ æ˜¾ç¤º
            function updateNextExerciseDisplay() {
                if (state.nextExerciseInfo) {
                    // æ£€æŸ¥æ˜¯å¦ä¸ºdiminishedéŸ³é˜¶ç±»å‹ï¼Œå¦‚æœæ˜¯åˆ™ä¸æ˜¾ç¤ºéŸ³çº§ä¿¡æ¯
                    const isDiminishedScale = state.nextExerciseInfo && 
                        (state.nextExerciseInfo.includes('Diminished') || 
                         state.nextExerciseInfo.includes('å‡') && state.nextExerciseInfo.includes('éŸ³é˜¶'));
                    
                    if (state.nextExerciseIntervals && state.nextExerciseIntervals.length > 0 && !isDiminishedScale) {
                        nextExerciseEl.innerHTML = `${state.nextExerciseInfo}<br><span style="font-size: 14px; color: #94a3b8;">${state.nextExerciseIntervals.join(' ')}</span>`;
                    } else {
                        nextExerciseEl.innerHTML = state.nextExerciseInfo;
                    }
                } else {
                    nextExerciseEl.innerHTML = '-';
                }
            }

            // ä¼˜åŒ–åçš„ç»ƒä¹ ç”Ÿæˆå‡½æ•°
            // ä¿®æ”¹generateExerciseå‡½æ•°ï¼Œé‡ç½®å†·å´æœŸçŠ¶æ€
            function generateExercise() {
                // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œç¡®ä¿ä»å½“å‰è®¾ç½®ç”Ÿæˆ
                state.nextExerciseInfo = '';
                state.nextExerciseIntervals = [];
                state.chordType = ''; // æ¸…é™¤ä¹‹å‰çš„å’Œå¼¦ç±»å‹
                
                // è·å–å½“å‰æ´»åŠ¨æ ‡ç­¾é¡µ
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                
                // åªåœ¨å’Œå¼¦è½¬æ¢ç»ƒä¹ æ—¶æ˜¾ç¤ºä¹æ›²åï¼Œå…¶ä»–æƒ…å†µä¸‹éšè—
                if (activeTab === 'progression') {
                    songTitleDisplayEl.style.display = 'block';
                } else {
                    songTitleDisplayEl.style.display = 'none';
                }
                
                state.pitchBuffer = [];
                state.isAnswered = false;
                state.currentStep = 0;

                // é‡ç½®å†·å´æœŸçŠ¶æ€
                if (state.enableCooldown) {
                    state.isCoolingDown = false;
                    if (state.cooldownTimeout) {
                        clearTimeout(state.cooldownTimeout);
                        state.cooldownTimeout = null;
                    }
                }

                // ä½¿ç”¨é¢„åŠ è½½çš„ç»ƒä¹ æ•°æ®
                if (state.nextExerciseInfo && state.nextExerciseIntervals.length > 0) {
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;

                    if (activeTab === 'scale') {
                        const parts = state.nextExerciseInfo.split(' ');
                        state.rootNote = parts[0];
                        state.scaleType = Object.keys(scaleTypes).find(key => scaleTypes[key].name === parts[1]);
                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    } else if (activeTab === 'progression') {
                        // å’Œå¼¦è½¬æ¢ç»ƒä¹ 
                        const { root, type } = parseChordSymbol(state.nextExerciseInfo);
                        state.rootNote = root;
                        state.chordType = type;

                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    } else {
                        // å’Œå¼¦ç»ƒä¹ 
                        // å¦‚æœæ˜¯è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼ï¼Œç›´æ¥ä»è‡ªå®šä¹‰å’Œå¼¦åºåˆ—ä¸­è·å–å½“å‰å’Œå¼¦
                        if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                            const chordItems = customChordSequence.querySelectorAll('.chord-item');
                            const chords = Array.from(chordItems).map(item => {
                                const root = item.querySelector('.remove-chord').dataset.root;
                                const type = item.querySelector('.remove-chord').dataset.type;
                                return { root, type };
                            });

                            const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                            const chord = chords[currentIndex];

                            state.rootNote = chord.root;
                            state.chordType = chord.type;
                            state.currentIntervals = [...state.nextExerciseIntervals];
                            targetIntervalEl.textContent = state.nextExerciseInfo;
                        } else {
                            const chordMatch = state.nextExerciseInfo.match(/([A-G][â™¯â™­]?)(.*)/);
                            state.rootNote = chordMatch[1];

                            const chordSymbol = chordMatch[2];
                            state.chordType = chordSymbol === '' ? 'major' :
                                chordSymbol === 'm' ? 'minor' :
                                    chordSymbol === '7' ? 'dominant7' :
                                        chordSymbol === 'maj7' ? 'major7' :
                                            chordSymbol === 'm7' ? 'minor7' :
                                                chordSymbol === 'sus2' ? 'sus2' : 'sus4';

                            state.currentIntervals = [...state.nextExerciseIntervals];
                            targetIntervalEl.textContent = state.nextExerciseInfo;
                        }
                    }

                    displaySequence();

                    // ç«‹å³é¢„åŠ è½½ä¸‹ä¸€é¢˜
                    generateNextExercise();
                } else {
                    // é¦–æ¬¡åŠ è½½æ—¶ç”Ÿæˆä¸¤é¢˜
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                    if (activeTab === 'scale') {
                        generateScaleExercise();
                    } else if (activeTab === 'chord') {
                        generateChordExercise();
                    } else if (activeTab === 'progression') {
                        generateProgressionExercise();
                    }

                    // ç«‹å³é¢„åŠ è½½ä¸‹ä¸€é¢˜ï¼ˆå¦‚æœåœ¨generateChordExerciseä¸­æ²¡æœ‰è°ƒç”¨ï¼‰
                    if (!state.nextExerciseInfo) {
                        generateNextExercise();
                    }
                }
            }

            // ç”ŸæˆéŸ³é˜¶ç»ƒä¹ 
            function generateScaleExercise() {
                let rootNote = rootNoteEl.value;
                if (rootNote === 'random') {
                    const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                    rootNote = notes[Math.floor(Math.random() * notes.length)];
                }
                state.rootNote = rootNote;

                let scaleType = scaleTypeEl.value;
                if (scaleType === 'random') {
                    const types = Object.keys(scaleTypes);
                    scaleType = types[Math.floor(Math.random() * types.length)];
                }
                state.scaleType = scaleType;

                // è·å–ç»ƒä¹ åºåˆ—ç±»å‹
                const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                let arpeggioType = '1to1';
                
                for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                  if (arpeggioTypeButtons[i].classList.contains('active')) {
                    arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                    break;
                  }
                }
                
                console.log('å½“å‰é€‰æ‹©çš„ç»ƒä¹ åºåˆ—ç±»å‹:', arpeggioType);

                // è·å–æ–¹å‘
                const activeScaleOrderBtn = document.querySelector('.scale-order-btn.active');
                const order = activeScaleOrderBtn ? activeScaleOrderBtn.dataset.value : 'ordered';

                // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒï¼šæ ¹æ®æ–¹å‘é€‰æ‹©ä¸Šè¡Œæˆ–ä¸‹è¡Œå½¢å¼
                let intervals;
                let isMelodicMinorDescending = false;
                if (scaleType === 'melodicMinor' && order === 'reverse') {
                    // ä¸‹è¡Œæ—‹å¾‹å°è°ƒ
                    intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                    isMelodicMinorDescending = true;
                } else {
                    // é»˜è®¤ä½¿ç”¨ä¸Šè¡Œå½¢å¼
                    intervals = [...scaleTypes[scaleType].intervals];
                }
                state.currentIntervals = intervals;
                let startEndInterval = '1'; // é»˜è®¤ä½¿ç”¨1ä½œä¸ºé¦–å°¾éŸ³
                
                // æ ¹æ®ç»ƒä¹ åºåˆ—ç±»å‹ç¡®å®šé¦–å°¾éŸ³
                if (arpeggioType === 'random-arpeggio') {
                    // éšæœºé€‰æ‹©1ã€3ã€5ã€7éŸ³ä½œä¸ºé¦–å°¾éŸ³ï¼Œä½†åªåŒ…å«éŸ³é˜¶ä¸­å®é™…å­˜åœ¨çš„éŸ³ç¨‹
                    const availableChordTones = [];
                    const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                    const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    if (fifthInterval) availableChordTones.push(fifthInterval);
                    const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                    
                    // å¦‚æœæœ‰å¯ç”¨çš„3/5/7åº¦éŸ³ç¨‹ï¼Œåˆ™ä»ä¸­éšæœºé€‰æ‹©
                    if (availableChordTones.length > 0) {
                        startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                    } else {
                        startEndInterval = '1'; // å›é€€åˆ°æ ¹éŸ³
                    }
                } else if (arpeggioType === '3to3') {
                    // ä½¿ç”¨3éŸ³ä½œä¸ºé¦–å°¾éŸ³
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                } else if (arpeggioType === '5to5') {
                    // ä½¿ç”¨5éŸ³ä½œä¸ºé¦–å°¾éŸ³
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                } else if (arpeggioType === '7to7') {
                    // ä½¿ç”¨7éŸ³ä½œä¸ºé¦–å°¾éŸ³
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                    // å¤„ç†å…¶ä»–ç‰¹å®šéŸ³ç¨‹ä½œä¸ºé¦–å°¾éŸ³çš„æƒ…å†µï¼ˆå¦‚â™¯6â†’â™¯6ï¼‰
                    // arpeggioTypeæ ¼å¼ä¸º"xtox"ï¼Œæå–xéƒ¨åˆ†
                    const match = arpeggioType.match(/^(.+)to\1$/);
                    if (match) {
                        const intervalType = match[1];
                        console.log('å¤„ç†ç‰¹å®šéŸ³ç¨‹:', intervalType, 'åœ¨éŸ³é˜¶ä¸­:', state.currentIntervals);
                        // æŸ¥æ‰¾éŸ³é˜¶ä¸­å¯¹åº”çš„éŸ³ç¨‹
                        const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                        console.log('æ‰¾åˆ°çš„å®Œæ•´éŸ³ç¨‹:', completeInterval);
                        if (completeInterval) {
                            startEndInterval = completeInterval;
                        } else {
                            const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                            console.log('æ‰¾åˆ°çš„æœ€è¿‘éŸ³ç¨‹:', nearestInterval);
                            startEndInterval = nearestInterval || intervalType;
                        }
                        console.log('æœ€ç»ˆé¦–å°¾éŸ³:', startEndInterval);
                    }
                }

                // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒä¸‹è¡Œï¼šç›´æ¥ä½¿ç”¨é¢„å®šä¹‰çš„åºåˆ—ï¼Œä¸è¿›è¡Œé¢å¤–å¤„ç†
                if (!isMelodicMinorDescending) {
                    if (order === 'reverse') {
                        // å€’åºæ¨¡å¼
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åå€’åºï¼Œæœ€åæ·»åŠ é¦–å°¾éŸ³
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // ä¿æŒåŸæœ‰çš„å€’åºé€»è¾‘
                            const middleIntervals = state.currentIntervals.slice(1).reverse();
                            state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                        }
                    } else if (order === 'random') {
                        // éšæœºæ¨¡å¼
                        if (arpeggioType === 'random-arpeggio') {
                            // å¯¹äºéšæœºå’Œå¼¦ç±»å‹ï¼Œæ•´ä¸ªåºåˆ—éƒ½åº”è¯¥åªåŒ…å«å’Œå¼¦éŸ³ï¼ˆ1ã€3ã€5ã€7åº¦éŸ³ç¨‹ï¼‰
                            // æ”¶é›†æ‰€æœ‰å®é™…å­˜åœ¨çš„3/5/7åº¦éŸ³ç¨‹
                            const availableChordTones = [];
                            const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                            if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                            const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                            if (fifthInterval) availableChordTones.push(fifthInterval);
                            const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                            if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                            
                            // å¦‚æœæ‰¾ä¸åˆ°è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œå›é€€åˆ°ä½¿ç”¨é¦–å°¾éŸ³
                            if (availableChordTones.length > 0) {
                                // éšæœºæ‰“ä¹±å’Œå¼¦éŸ³
                                const shuffledChordTones = [...availableChordTones];
                                for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                }
                                
                                // ä»æ‰¾åˆ°çš„å’Œå¼¦éŸ³ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸ºé¦–å°¾éŸ³
                                startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                
                                // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿åŒ…å«é¦–å°¾éŸ³
                                state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                            } else {
                                // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œä½¿ç”¨æ ¹éŸ³ä½œä¸ºæ•´ä¸ªåºåˆ—
                                state.currentIntervals = ['1', '1'];
                            }
                        } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                            // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // æå–é™¤äº†é¦–å°¾éŸ³ä¹‹å¤–çš„æ‰€æœ‰éŸ³
                                const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                
                                // éšæœºæ‰“ä¹±
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                
                                // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿é¦–å°¾éƒ½æ˜¯æŒ‡å®šçš„éŸ³
                                state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // ä¿æŒåŸæœ‰çš„éšæœºé€»è¾‘
                            const otherIntervals = state.currentIntervals.slice(1);
                            for (let i = otherIntervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                            }
                            state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                        }
                    } else {
                        // é¡ºåºæ¨¡å¼
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åæ·»åŠ é¦–å°¾éŸ³
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                            }
                        } else {
                            // ä¿æŒåŸæœ‰çš„é¡ºåºé€»è¾‘
                            state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                        }
                    }
                }

                targetIntervalEl.textContent = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                displaySequence();
            }

            // ç”Ÿæˆå’Œå¼¦ç»ƒä¹ 
            function generateChordExercise() {
                try {
                    // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œç¡®ä¿ä»å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹ç”Ÿæˆ
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // æ¸…é™¤ä¹‹å‰çš„å’Œå¼¦ç±»å‹
                    
                    if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        // ä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            return { root, type };
                        });

                        // æŒ‰é¡ºåºç»ƒä¹ è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                        const currentChordIndex = state.customChordIndex || 0;
                        const chord = chords[currentChordIndex];

                        state.rootNote = chord.root;
                        state.chordType = chord.type;
                        
                        // æ£€æŸ¥å’Œå¼¦ç±»å‹æ˜¯å¦å­˜åœ¨
                        if (!chordTypes[state.chordType]) {
                            throw new Error(`æœªçŸ¥çš„å’Œå¼¦ç±»å‹: ${state.chordType}`);
                        }
                        
                        state.currentIntervals = [...chordTypes[state.chordType].intervals];

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // ä¸‹è¡Œæ¨¡å¼ï¼šå€’åºæ’åˆ—
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    const chordSymbol = formatChordSymbol(state.rootNote, state.chordType);
                    targetIntervalEl.textContent = chordSymbol;
                    displaySequence();

                    // è®¾ç½®ä¸‹ä¸€ä¸ªå’Œå¼¦ä¸ºåºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª
                    const nextIndex = (currentChordIndex + 1) % chords.length;
                    state.customChordIndex = nextIndex;
                    const nextChord = chords[nextIndex];

                    state.nextExerciseInfo = formatChordSymbol(nextChord.root, nextChord.type);                    state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    updateNextExerciseDisplay();
                } else {
                    // ä½¿ç”¨åŸå§‹å’Œå¼¦ç”Ÿæˆé€»è¾‘
                    state.customChordIndex = null;
                    originalGenerateChordExercise();
                }
                } catch (error) {
                    console.error('ç”Ÿæˆå’Œå¼¦ç»ƒä¹ å¤±è´¥:', error);
                    updateStatusIndicator('å’Œå¼¦ç»ƒä¹ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                    // å›é€€åˆ°é»˜è®¤å’Œå¼¦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // æ˜¾ç¤ºéŸ³é˜¶/å’Œå¼¦åºåˆ—
            function displaySequence() {
                const fragment = document.createDocumentFragment();
                state.currentSequence = [];

                state.currentIntervals.forEach((interval, index) => {
                    const span = document.createElement('div');
                    span.className = 'sequence-item';
                    if (index === 0) span.classList.add('current');
                    span.textContent = interval;
                    span.dataset.index = index;
                    fragment.appendChild(span);
                    state.currentSequence.push(interval);
                });

                sequenceDisplayEl.innerHTML = '';
                sequenceDisplayEl.appendChild(fragment);
            }

            // å¯åŠ¨èŠ‚æ‹å™¨
            function startMetronome() {
                if (state.metronomeInterval) {
                    stopMetronome();
                }

                if (!state.metronomeEnabled) return;

                const beatInterval = 60000 / state.metronomeTempo;

                document.documentElement.style.setProperty('--metronome-speed', `${beatInterval}ms`);

                if (practiceScreen.style.display === 'flex') {
                    practiceScreen.classList.add('metronome-active');
                }

                state.metronomeInterval = setInterval(() => {
                    // èƒŒæ™¯é—ªå…‰æ•ˆæœ
                    if (state.metronomeFlashEnabled) {
                        practiceScreen.classList.add('metronome-flash');
                        setTimeout(() => {
                            practiceScreen.classList.remove('metronome-flash');
                        }, 300);
                    }

                    // æ’­æ”¾èŠ‚æ‹å™¨å£°éŸ³
                    if (state.metronomeSoundEnabled && audioContext) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 892; //è¿œç¦»ä¸€èˆ¬ä¹éŸ³ï¼Œé¿å…å¹²æ‰°
                        gainNode.gain.value = 0.1;
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.05);
                    }
                }, beatInterval);
            }

            // åœæ­¢èŠ‚æ‹å™¨
            function stopMetronome() {
                if (state.metronomeInterval) {
                    clearInterval(state.metronomeInterval);
                    state.metronomeInterval = null;
                }

                practiceScreen.classList.remove('metronome-active');
                practiceScreen.classList.remove('metronome-flash');
            }

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            function initEventListeners() {
                // éŸ³é¢‘è®¾å¤‡é€‰æ‹©äº‹ä»¶
                audioInputDeviceEl.addEventListener('change', function () {
                    selectedDeviceId = this.value;
                    if (isRecording) {
                        restartAudioWithNewDevice();
                    }
                    // ä¿å­˜è®¾ç½®
                    saveSettings();
                    console.log('éŸ³é¢‘è®¾å¤‡å·²ä¿å­˜åˆ°localStorage:', selectedDeviceId);
                });

                // è¾“å…¥å¢ç›Šæ§åˆ¶
                inputGainEl.addEventListener('input', function () {
                    inputGain = this.value / 100;
                    inputGainValueEl.textContent = this.value + '%';

                    if (gainNode) {
                        gainNode.gain.value = inputGain;
                    }
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                refreshDevicesBtn.addEventListener('click', function () {
                    getAudioDevices();
                    updateStatusIndicator('æ­£åœ¨åˆ·æ–°è®¾å¤‡åˆ—è¡¨...', 'ready');
                    setTimeout(() => {
                        updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                    }, 1000);
                });

                // æ­Œæ›²é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
                const jazzStandardEl = document.getElementById('jazzStandard');
                if (jazzStandardEl) {
                    jazzStandardEl.addEventListener('change', function() {
                        const selectedSong = this.value;
                        if (selectedSong) {
                            updateKeySelector(selectedSong);
                        }
                    });
                }

                // èŠ‚æ‹å™¨å¼€å…³äº‹ä»¶
                metronomeToggleEl.addEventListener('change', function () {
                    state.metronomeEnabled = this.checked;
                    if (state.metronomeEnabled && practiceScreen.style.display === 'flex') {
                        startMetronome();
                    } else {
                        stopMetronome();
                    }
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // èŠ‚æ‹å™¨é€Ÿåº¦æ»‘å—äº‹ä»¶
                metronomeTempoEl.addEventListener('input', function () {
                    state.metronomeTempo = parseInt(this.value);
                    metronomeTempoValueEl.textContent = state.metronomeTempo;

                    if (state.metronomeEnabled && state.metronomeInterval) {
                        startMetronome();
                    }
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // èŠ‚æ‹å™¨èƒŒæ™¯é—ªå…‰å¼€å…³äº‹ä»¶
                metronomeFlashToggleEl.addEventListener('change', function () {
                    state.metronomeFlashEnabled = this.checked;
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // èŠ‚æ‹å™¨å£°éŸ³å¼€å…³äº‹ä»¶
                metronomeSoundToggleEl.addEventListener('change', function () {
                    state.metronomeSoundEnabled = this.checked;
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // å†·å´æ—¶é—´å¼€å…³äº‹ä»¶
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.addEventListener('change', function () {
                        state.enableCooldown = this.checked;
                        console.log('å†·å´æ—¶é—´åŠŸèƒ½:', this.checked ? 'å·²å¯ç”¨' : 'å·²å…³é—­');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // å†·å´æ—¶é—´æ»‘å—äº‹ä»¶
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.addEventListener('input', function () {
                        state.cooldownDuration = parseInt(this.value);
                        cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                        console.log('å†·å´æ—¶é—´è®¾ç½®ä¸º:', state.cooldownDuration + 'ms');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // å›ºå®šå»¶è¿Ÿç”Ÿæˆå¼€å…³äº‹ä»¶
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.addEventListener('change', function () {
                        state.enableFixedDelay = this.checked;
                        console.log('å›ºå®šå»¶è¿Ÿç”ŸæˆåŠŸèƒ½:', this.checked ? 'å·²å¯ç”¨' : 'å·²å…³é—­');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // å›ºå®šå»¶è¿Ÿæ—¶é—´æ»‘å—äº‹ä»¶
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.addEventListener('input', function () {
                        state.fixedDelayDuration = parseInt(this.value);
                        fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                        console.log('å›ºå®šå»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º:', state.fixedDelayDuration + 'ms');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // éŸ³é«˜æ£€æµ‹æ•æ„Ÿåº¦æ»‘å—äº‹ä»¶
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.addEventListener('input', function () {
                        state.sensitivity = parseFloat(this.value);
                        sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                        console.log('éŸ³é«˜æ£€æµ‹æ•æ„Ÿåº¦è®¾ç½®ä¸º:', state.sensitivity);
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—äº‹ä»¶
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.addEventListener('input', function () {
                        state.confidenceThreshold = parseFloat(this.value);
                        confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                        console.log('ç½®ä¿¡åº¦é˜ˆå€¼è®¾ç½®ä¸º:', state.confidenceThreshold);
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }
                
                // é‡ç½®è®¾ç½®æŒ‰é’®äº‹ä»¶
                const resetSettingsBtn = document.getElementById('resetSettingsBtn');
                if (resetSettingsBtn) {
                    resetSettingsBtn.addEventListener('click', function () {
                        resetSettings();
                    });
                }

                // å¼€å§‹ç»ƒä¹ æŒ‰é’®
                startBtn.addEventListener('click', function () {
                    console.log('å¼€å§‹ç»ƒä¹ æŒ‰é’®è¢«ç‚¹å‡»');
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                    console.log('å½“å‰é€‰æ‹©çš„æ ‡ç­¾é¡µ:', activeTab);
                    
                    // éªŒè¯å’Œå¼¦è®¾ç½®
                    if (activeTab === 'chord') {
                        const useCustomChords = document.getElementById('useCustomChords');
                        if (!useCustomChords.checked) {
                            const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                            if (activeChordTypes.length === 0) {
                                alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªå’Œå¼¦ç±»å‹ï¼');
                                return;
                            }
                        } else {
                            const customChordItems = document.querySelectorAll('#customChordSequence .chord-item');
                            if (customChordItems.length === 0) {
                                alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªè‡ªå®šä¹‰å’Œå¼¦ï¼');
                                return;
                            }
                        }
                    }
                    
                    updateStatusIndicator('æ­£åœ¨å¯åŠ¨éº¦å…‹é£...', 'recording');

                    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒgetUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('æµè§ˆå™¨ä¸æ”¯æŒgetUserMedia');
                        updateStatusIndicator('æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®', 'error');
                        return;
                    }
                    
                    console.log('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function (stream) {
                            console.log('éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼ŒéŸ³é¢‘æµ:', stream);
                            mediaStream = stream;

                            mainScreen.style.display = 'none';
                            practiceScreen.style.display = 'flex';
                            document.getElementById('pitchDisplay').style.display = 'block';

                            requestWakeLock();

                            state.nextExerciseInfo = '';
                            state.nextExerciseIntervals = [];

                            console.log('å¼€å§‹ç”Ÿæˆç»ƒä¹ ...');
                            generateExercise();

                            console.log('å¼€å§‹å½•éŸ³...');
                            startRecording();

                            state.metronomeEnabled = document.getElementById('metronomeToggle').checked;
                            state.metronomeTempo = parseInt(document.getElementById('metronomeTempo').value);
                            state.metronomeFlashEnabled = document.getElementById('metronomeFlashToggle').checked;
                            state.metronomeSoundEnabled = document.getElementById('metronomeSoundToggle').checked;

                            if (state.metronomeEnabled) {
                                startMetronome();
                                practiceScreen.classList.add('metronome-active');
                            }
                        })
                        .catch(function (err) {
                            console.error('éº¦å…‹é£è·å–å¤±è´¥:', err);
                            console.error('é”™è¯¯ç±»å‹:', err.name);
                            console.error('é”™è¯¯ä¿¡æ¯:', err.message);

                            updateStatusIndicator('æœªè·å–å½•éŸ³æƒé™', 'error');

                            const errorMessage = document.createElement('div');
                            errorMessage.style.position = 'fixed';
                            errorMessage.style.top = '50%';
                            errorMessage.style.left = '50%';
                            errorMessage.style.transform = 'translate(-50%, -50%)';
                            errorMessage.style.background = 'rgba(239, 68, 68, 0.9)';
                            errorMessage.style.color = 'white';
                            errorMessage.style.padding = '20px';
                            errorMessage.style.borderRadius = '10px';
                            errorMessage.style.zIndex = '2000';
                            errorMessage.style.maxWidth = '80%';
                            errorMessage.style.textAlign = 'center';
                            errorMessage.innerHTML = `
                                <h3 style="margin-bottom: 10px; font-size: 18px;">éº¦å…‹é£æƒé™è¢«æ‹’ç»</h3>
                                <p style="margin-bottom: 15px;">æ­¤åº”ç”¨éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½æ£€æµ‹éŸ³é«˜ã€‚</p>
                                <p>è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
                                <ol style="text-align: left; margin: 15px 0; padding-left: 20px;">
                                    <li>ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å®š/ä¿¡æ¯å›¾æ ‡</li>
                                    <li>åœ¨å¼¹å‡ºçš„èœå•ä¸­æ‰¾åˆ°"éº¦å…‹é£"é€‰é¡¹</li>
                                    <li>å°†å…¶è®¾ç½®ä¸º"å…è®¸"</li>
                                    <li>åˆ·æ–°é¡µé¢åé‡è¯•</li>
                                </ol>
                                <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                    <button id="refreshPage" style="padding: 8px 16px; background: #3a9fc4; border: none; border-radius: 5px; color: white; cursor: pointer;">åˆ·æ–°é¡µé¢</button>
                                    <button id="returnToMain" style="padding: 8px 16px; background: #6c757d; border: none; border-radius: 5px; color: white; cursor: pointer;">è¿”å›ä¸»èœå•</button>
                                </div>
                            `;
                            document.body.appendChild(errorMessage);

                            document.getElementById('refreshPage').addEventListener('click', function() {
                                location.reload();
                            });
                            
                            document.getElementById('returnToMain').addEventListener('click', function () {
                                document.body.removeChild(errorMessage);
                                updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                            });
                        });
                });

                // åº•éƒ¨å¯¼èˆªæ åˆ‡æ¢
                const bottomNavItems = document.querySelectorAll('.nav-item');
                bottomNavItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const tabName = this.dataset.tab;

                        // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„activeçŠ¶æ€
                        bottomNavItems.forEach(navItem => navItem.classList.remove('active'));
                        // ä¸ºå½“å‰ç‚¹å‡»çš„å¯¼èˆªé¡¹æ·»åŠ activeçŠ¶æ€
                        this.classList.add('active');

                        // é»˜è®¤éšè—æ‰€æœ‰è®¾ç½®åŒºåŸŸ
                        scaleSettings.style.display = 'none';
                        chordSettings.style.display = 'none';
                        progressionSettings.style.display = 'none';
                        deviceSettings.style.display = 'none';

                        // æ ¹æ®æ ‡ç­¾é¡µæ˜¾ç¤ºå¯¹åº”è®¾ç½®
                        if (tabName === 'scale') {
                            scaleSettings.style.display = 'block';
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤º
                            updateArpeggioButtons();
                        } else if (tabName === 'chord') {
                            chordSettings.style.display = 'block';
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿ç§»é™¤åŠ¨æ€æŒ‰é’®
                            updateArpeggioButtons();
                        } else if (tabName === 'progression') {
                            progressionSettings.style.display = 'block';
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿ç§»é™¤åŠ¨æ€æŒ‰é’®
                            updateArpeggioButtons();
                        } else if (tabName === 'device') {
                            deviceSettings.style.display = 'block';
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿ç§»é™¤åŠ¨æ€æŒ‰é’®
                            updateArpeggioButtons();
                        }
                        
                        // æ§åˆ¶å¼€å§‹ç»ƒä¹ æŒ‰é’®çš„æ˜¾ç¤º
                        const controls = document.querySelector('.controls');
                        if (controls) {
                            // åœ¨è®¾ç½®æ ‡ç­¾é¡µä¸­éšè—å¼€å§‹ç»ƒä¹ æŒ‰é’®
                            if (tabName === 'device') {
                                controls.style.display = 'none';
                            } else {
                                controls.style.display = 'flex';
                            }
                        }
                    });
                });

                // åˆå§‹åŒ–æ˜¾ç¤ºéŸ³é˜¶è®¾ç½®ï¼ˆå¦‚æœæ˜¯éŸ³é˜¶ç»ƒä¹ æ ‡ç­¾é¡µï¼‰
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                if (activeTab === 'scale') {
                    scaleSettings.style.display = 'block';
                }
                
                // åˆå§‹åŒ–æ—¶æ ¹æ®é»˜è®¤é€‰ä¸­çš„æ ‡ç­¾é¡µæ¥æ§åˆ¶æŒ‰é’®çš„æ˜¾ç¤º
                const controls = document.querySelector('.controls');
                if (controls) {
                    // åœ¨è®¾ç½®æ ‡ç­¾é¡µä¸­éšè—å¼€å§‹ç»ƒä¹ æŒ‰é’®
                    if (activeTab === 'device') {
                        controls.style.display = 'none';
                    } else {
                        controls.style.display = 'flex';
                    }
                }

                // å’Œå¼¦ç±»å‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                chordTypeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                    });
                });

                // éŸ³é˜¶é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const scaleOrderBtns = document.querySelectorAll('.scale-order-btn');
                scaleOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // ç»ƒä¹ åºåˆ—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const scaleArpeggioBtns = document.querySelectorAll('.scale-arpeggio-btn');
                scaleArpeggioBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleArpeggioBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // å½“æŒ‰é’®è¢«ç‚¹å‡»æ—¶ï¼Œæ›´æ–°æŒ‰é’®æ˜¾ç¤ºä»¥åæ˜ å½“å‰éŸ³é˜¶
                        updateArpeggioButtons();
                    });
                });

                // å’Œå¼¦é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const chordOrderBtns = document.querySelectorAll('.chord-order-btn');
                chordOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        chordOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // å’Œå¼¦è½¬æ¢é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const progressionOrderBtns = document.querySelectorAll('.progression-order-btn');
                progressionOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        progressionOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // ç‚¹å‡»ç»ƒä¹ å±å¹•è¿”å›ä¸»é¡µé¢
                // ä¿®æ”¹ç»ƒä¹ å±å¹•ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿é€€å‡ºæ—¶é‡ç½®å†·å´æœŸ
                practiceScreen.addEventListener('click', function () {
                    updateStatusIndicator('æ­£åœ¨åœæ­¢å½•éŸ³...', 'ready');

                    // é‡ç½®å’Œå¼¦è½¬æ¢ç»ƒä¹ çš„ä¼šè¯çŠ¶æ€
                    state.isInProgressionSession = false;

                    // åªæœ‰åœ¨å¯ç”¨å†·å´æ—¶é—´æ—¶æ‰é‡ç½®å†·å´æœŸçŠ¶æ€
                    if (state.enableCooldown) {
                        state.isCoolingDown = false;
                        if (state.cooldownTimeout) {
                            clearTimeout(state.cooldownTimeout);
                            state.cooldownTimeout = null;
                        }
                    }

                    setTimeout(() => {
                        stopRecording();
                        stopMetronome();
                        //releaseWakeLock();

                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';

                        updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                    }, 300);
                });
                // é¡µé¢å…³é—­æ—¶å®Œå…¨å…³é—­éº¦å…‹é£
                window.addEventListener('beforeunload', function () {
                    closeMicrophone();
                });
            }

            // åˆå§‹åŒ–åº”ç”¨
            function initApp() {
                if (typeof Pitchfinder === 'undefined') {
                    console.error('PitchFinderåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    alert('éŸ³é«˜æ£€æµ‹åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢');
                } else {
                    console.log('PitchFinderåº“åŠ è½½æˆåŠŸ');
                }

                // è·å–éŸ³é¢‘è®¾å¤‡åˆ—è¡¨
                getAudioDevices();

                initEventListeners();
                initKeyboardShortcuts();
                requestRecordPermission();
            }

            // åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && practiceScreen.style.display === 'flex') {
                        practiceScreen.click();
                    }

                    if (e.key === ' ' && practiceScreen.style.display === 'flex') {
                        generateExercise();
                    }
                });
            }

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            function updateStatusIndicator(status, type = 'ready') {
                statusIndicator.textContent = status;
                statusIndicator.className = `status-indicator status-${type}`;
            }

            // è‡ªå®šä¹‰å’Œå¼¦åŠŸèƒ½
            const useCustomChords = document.getElementById('useCustomChords');
            const customChordsControls = document.getElementById('customChordsControls');
            const customChordRoot = document.getElementById('customChordRoot');
            const customChordType = document.getElementById('customChordType');
            const addCustomChord = document.getElementById('addCustomChord');
            const customChordSequence = document.getElementById('customChordSequence');
            const clearCustomChords = document.getElementById('clearCustomChords');
            const saveCustomChords = document.getElementById('saveCustomChords');
            const loadCustomChords = document.getElementById('loadCustomChords');
            const sequenceName = document.getElementById('sequenceName');

            // è‡ªå®šä¹‰å’Œå¼¦å¼€å…³æ§åˆ¶
            useCustomChords.addEventListener('change', function () {
                customChordsControls.style.display = this.checked ? 'block' : 'none';
            });

            // æ·»åŠ è‡ªå®šä¹‰å’Œå¼¦
            addCustomChord.addEventListener('click', function () {
                const root = customChordRoot.value;
                const type = customChordType.value;
                const chordName = `${root}${type === 'major' ? '' : type === 'minor' ? 'm' : type === 'dominant7' ? '7' : type === 'major7' ? 'maj7' : type === 'minor7' ? 'm7' : type === 'sus2' ? 'sus2' : 'sus4'}`;

                const chordItem = document.createElement('div');
                chordItem.className = 'chord-item';
                chordItem.innerHTML = `
                    <span class="chord-name">${chordName}</span>
                    <button class="remove-chord" data-root="${root}" data-type="${type}">Ã—</button>
                `;

                customChordSequence.appendChild(chordItem);

                // æ·»åŠ åˆ é™¤äº‹ä»¶
                chordItem.querySelector('.remove-chord').addEventListener('click', function () {
                    chordItem.remove();
                });
            });

            // æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦åºåˆ—
            clearCustomChords.addEventListener('click', function () {
                customChordSequence.innerHTML = '<div class="empty-sequence">æš‚æ— å’Œå¼¦ï¼Œè¯·æ·»åŠ </div>';
            });

            // ä¿å­˜å’Œå¼¦åºåˆ—åˆ°æœ¬åœ°å­˜å‚¨
            saveCustomChords.addEventListener('click', function () {
                const chords = [];
                const chordElements = customChordSequence.querySelectorAll('.chord-item');

                chordElements.forEach(el => {
                    const root = el.querySelector('.remove-chord').dataset.root;
                    const type = el.querySelector('.remove-chord').dataset.type;
                    chords.push({ root, type });
                });

                const name = sequenceName.value || 'æœªå‘½ååºåˆ—';
                const songData = {
                    name,
                    chords,
                    timestamp: new Date().toISOString()
                };

                // åˆ›å»ºæ–‡ä»¶ä¿å­˜å¯¹è¯æ¡†
                const jsonStr = JSON.stringify([songData], null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${name.replace(/[\/\\?%*:|"<>]/g, '')}_å’Œå¼¦åºåˆ—.json`;
                document.body.appendChild(a);
                a.click();

                // æ¸…ç†
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const sequences = JSON.parse(localStorage.getItem('customChordSequences') || '[]');
                sequences.push(songData);
                localStorage.setItem('customChordSequences', JSON.stringify(sequences));
            });

            // åŠ è½½æœ¬åœ°å’Œå¼¦è¿›è¡Œ
            // åŠ è½½æœ¬åœ°å’Œå¼¦è¿›è¡Œ
            document.getElementById('loadLocalChords').addEventListener('click', function () {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';

                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = JSON.parse(e.target.result);

                            // å¤„ç†å¤šé¦–æ­Œæ›²æ ¼å¼ï¼ˆæ•°ç»„å½¢å¼ï¼‰
                            if (Array.isArray(data)) {
                                if (data.length === 0) {
                                    alert('æ–‡ä»¶ä¸ºç©ºï¼Œæ²¡æœ‰å¯åŠ è½½çš„æ­Œæ›²');
                                } else if (data.length === 1) {
                                    loadAndStartPractice(data[0]);
                                } else {
                                    showSongSelectionDialog(data);
                                }
                            }
                            // å¤„ç†å•é¦–æ­Œæ›²æ ¼å¼ï¼ˆå¯¹è±¡å½¢å¼ï¼‰
                            else if (data && Array.isArray(data.chords)) {
                                loadAndStartPractice(data);
                            } else {
                                alert('æ— æ•ˆçš„å’Œå¼¦è¿›è¡Œæ–‡ä»¶æ ¼å¼');
                            }
                        } catch (err) {
                            alert('è§£ææ–‡ä»¶å¤±è´¥: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                });

                fileInput.click();

                function loadAndStartPractice(songData) {
                    customChordSequence.innerHTML = '';
                    sequenceName.value = songData.name || 'æœªå‘½ååºåˆ—';

                    songData.chords.forEach(chord => {
                        const chordName = `${chord.root}${chord.type === 'major' ? '' :
                            chord.type === 'minor' ? 'm' :
                                chord.type === 'dominant7' ? '7' :
                                    chord.type === 'major7' ? 'maj7' :
                                        chord.type === 'minor7' ? 'm7' :
                                            chord.type === 'sus2' ? 'sus2' : 'sus4'}`;

                        const chordItem = document.createElement('div');
                        chordItem.className = 'chord-item';
                        chordItem.innerHTML = `
                    <span class="chord-name">${chordName}</span>
                    <button class="remove-chord" data-root="${chord.root}" data-type="${chord.type}">Ã—</button>
                `;

                        customChordSequence.appendChild(chordItem);

                        chordItem.querySelector('.remove-chord').addEventListener('click', function () {
                            chordItem.remove();
                        });
                    });

                    // ç¡®ä¿è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼å¼€å¯
                    useCustomChords.checked = true;
                    customChordsControls.style.display = 'block';

                    // é‡ç½®è‡ªå®šä¹‰å’Œå¼¦ç´¢å¼•
                    state.customChordIndex = 0;

                    // é¢„åŠ è½½ç¬¬ä¸€ä¸ªå’Œå¼¦
                    const firstChord = songData.chords[0];
                    state.nextExerciseInfo = `${firstChord.root}${firstChord.type === 'major' ? '' :
                        firstChord.type === 'minor' ? 'm' :
                            firstChord.type === 'dominant7' ? '7' :
                                firstChord.type === 'major7' ? 'maj7' :
                                    firstChord.type === 'minor7' ? 'm7' :
                                        firstChord.type === 'sus2' ? 'sus2' : 'sus4'}`;
                    state.nextExerciseIntervals = [...chordTypes[firstChord.type].intervals];

                    // è‡ªåŠ¨å¼€å§‹ç»ƒä¹ 
                    setTimeout(() => {
                        mainScreen.style.display = 'none';
                        practiceScreen.style.display = 'flex';
                        document.getElementById('pitchDisplay').style.display = 'block';
                        requestWakeLock();
                        generateExercise();
                        startRecording();

                        // å¯ç”¨èŠ‚æ‹å™¨ï¼ˆå¦‚æœå·²é€‰ä¸­ï¼‰
                        if (metronomeToggleEl.checked) {
                            startMetronome();
                        }
                    }, 300);
                }

                function showSongSelectionDialog(songs) {
                    const dialog = document.createElement('div');
                    dialog.className = 'sequence-dialog';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '500px';
                    dialog.innerHTML = `
                        <h3 style="margin-bottom: 15px; color: #3a9fc4;">é€‰æ‹©è¦åŠ è½½çš„æ­Œæ›²</h3>
                        <select id="songSelector" style="width: 100%; padding: 10px; margin-bottom: 15px; 
                         background: #2c2c3c; color: white; border: 1px solid #555; border-radius: 6px;">
                         ${songs.map(song => `
                        <option value="${songs.indexOf(song)}">
                        ${song.name || 'æœªå‘½å'} (${song.chords.map(chord => {
                        let suffix = '';
                        switch (chord.type) {
                            case 'major': suffix = ''; break;
                            case 'minor': suffix = 'm'; break;
                            case 'dominant7': suffix = '7'; break;
                            case 'major7': suffix = 'maj7'; break;
                            case 'minor7': suffix = 'm7'; break;
                            case 'sus2': suffix = 'sus2'; break;
                            case 'sus4': suffix = 'sus4'; break;
                            default: suffix = '';
                        }
                        return `${chord.root}${suffix}`;
                    }).join(' ')})
                        </option>
                            `).join('')}
                        </select>
                        <div style="display: flex; gap: 10px;">
                            <button id="confirmLoad" style="flex: 1; padding: 10px; background: #3a9fc4; 
                                border: none; border-radius: 6px; color: white; cursor: pointer;">
                                åŠ è½½å¹¶å¼€å§‹ç»ƒä¹ 
                            </button>
                            <button id="cancelLoad" style="flex: 1; padding: 10px; background: #555; 
                                border: none; border-radius: 6px; color: white; cursor: pointer;">
                                å–æ¶ˆ
                            </button>
                        </div>
                    `;

                    document.body.appendChild(dialog);

                    document.getElementById('confirmLoad').addEventListener('click', function () {
                        const selectedIndex = document.getElementById('songSelector').value;
                        loadAndStartPractice(songs[selectedIndex]);
                        document.body.removeChild(dialog);
                    });

                    document.getElementById('cancelLoad').addEventListener('click', function () {
                        document.body.removeChild(dialog);
                    });
                }
            });


            // åŠ è½½å½“å‰è‡ªå®šä¹‰å’Œå¼¦åºåˆ—å¹¶å¼€å§‹ç»ƒä¹ 
            document.getElementById('loadSequence').addEventListener('click', function () {
                const chordItems = customChordSequence.querySelectorAll('.chord-item');
                if (chordItems.length === 0) {
                    alert('è¯·å…ˆæ·»åŠ è‡ªå®šä¹‰å’Œå¼¦');
                    return;
                }

                // ç¡®ä¿è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼å¼€å¯
                useCustomChords.checked = true;
                customChordsControls.style.display = 'block';

                // é‡ç½®è‡ªå®šä¹‰å’Œå¼¦ç´¢å¼•
                state.customChordIndex = 0;

                // è‡ªåŠ¨å¼€å§‹ç»ƒä¹ 
                setTimeout(() => {
                    mainScreen.style.display = 'none';
                    practiceScreen.style.display = 'flex';
                    document.getElementById('pitchDisplay').style.display = 'block';
                    requestWakeLock();
                    generateExercise();
                    startRecording();

                    // å¯ç”¨èŠ‚æ‹å™¨ï¼ˆå¦‚æœå·²é€‰ä¸­ï¼‰
                    if (metronomeToggleEl.checked) {
                        startMetronome();
                    }
                }, 300);
            });

            // ä¿®æ”¹generateChordExerciseå‡½æ•°ä»¥æ”¯æŒè‡ªå®šä¹‰å’Œå¼¦
            function originalGenerateChordExercise() {
                try {
                    // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œç¡®ä¿ä»å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹ç”Ÿæˆ
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // æ¸…é™¤ä¹‹å‰çš„å’Œå¼¦ç±»å‹
                    
                    let rootNote = chordRootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    state.rootNote = rootNote;

                    const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                    let chordType = 'major';
                    if (activeChordTypes.length > 0) {
                        const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                        chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                    } else {
                        // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œä¸ç”Ÿæˆé»˜è®¤å’Œå¼¦ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç©ºå€¼
                        console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œæ— æ³•ç”Ÿæˆä¸‹ä¸€é¢˜');
                        return; // ä¸ç”Ÿæˆä¸‹ä¸€é¢˜
                    }
                    state.chordType = chordType;

                    // æ£€æŸ¥å’Œå¼¦ç±»å‹æ˜¯å¦å­˜åœ¨
                    if (!chordTypes[chordType]) {
                        throw new Error(`æœªçŸ¥çš„å’Œå¼¦ç±»å‹: ${chordType}`);
                    }

                    state.currentIntervals = [...chordTypes[chordType].intervals];

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // ä¸‹è¡Œæ¨¡å¼ï¼šå€’åºæ’åˆ—
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    const chordSymbol = formatChordSymbol(rootNote, chordType);
                    targetIntervalEl.textContent = chordSymbol;
                    displaySequence();
                    
                    // é¢„ç”Ÿæˆä¸‹ä¸€é¢˜
                    generateNextExercise();
                } catch (error) {
                    console.error('ç”Ÿæˆå’Œå¼¦ç»ƒä¹ å¤±è´¥:', error);
                    updateStatusIndicator('å’Œå¼¦ç»ƒä¹ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                    // å›é€€åˆ°é»˜è®¤å’Œå¼¦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // ç”Ÿæˆå’Œå¼¦è½¬æ¢ç»ƒä¹ 
            function generateProgressionExercise() {
                const jazzStandardEl = document.getElementById('jazzStandard');
                const progressionKeyEl = document.getElementById('progressionKey');
                const progressionLevelEl = document.getElementById('progressionLevel');
                const enableRepeatEl = document.getElementById('enableRepeat');
                const songTitleEl = document.getElementById('songTitle');
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                
                const selectedSong = jazzStandardEl.value;
                if (!selectedSong) {
                    alert('è¯·é€‰æ‹©ä¸€é¦–æ­Œæ›²');
                    return;
                }

                // æ˜¾ç¤ºä¹æ›²å
                songTitleEl.textContent = selectedSong;
                songTitleDisplayEl.style.display = 'block';

                // è·å–æ­Œæ›²å’Œå¼¦è¿›è¡Œæ•°æ®
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][selectedSong]) {
                        songData = jazzStandards[letter][selectedSong];
                        break;
                    }
                }

                if (!songData) {
                    alert('æ‰¾ä¸åˆ°æ­Œæ›²å’Œå¼¦è¿›è¡Œ');
                    return;
                }

                // è·å–åŸè°ƒå’ŒéŸ³çº§å’Œå¼¦è¿›è¡Œ
                const originalKey = songData.key;
                const degreeChords = [...songData.chords];
                
                // è°ƒæ€§è½¬æ¢
                let chords = [];
                const selectedKey = progressionKeyEl.value;
                
                // ç§»è°ƒåˆ°ç›®æ ‡è°ƒ
                chords = degreeChords.map(degreeChord => 
                    transposeChordFromDegree(degreeChord, originalKey, selectedKey)
                );

                
                // æ˜¾ç¤ºè°ƒæ€§è½¬æ¢ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
                const keyInfo = selectedKey === originalKey ? 
                    `åŸè°ƒï¼š${originalKey}` : 
                    `${originalKey} â†’ ${selectedKey}`;
                console.log(`æ­Œæ›²ï¼š${selectedSong}`);
                console.log(`è°ƒæ€§è½¬æ¢ï¼š${keyInfo}`);
                console.log(`éŸ³çº§å’Œå¼¦ï¼š`, degreeChords);
                console.log(`è½¬æ¢åå’Œå¼¦ï¼š`, chords);

                // åº”ç”¨å’Œå¼¦è¿›è¡Œçš„é¡ºåºè®¾ç½®ï¼ˆé¡ºåºæŒ‰é’®æ§åˆ¶æ•´ä¸ªå’Œå¼¦è¿›è¡Œçš„é¡ºåºï¼‰
                const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                
                if (order === 'reverse') {
                    chords = chords.reverse();
                } else if (order === 'random') {
                    // æ‰“ä¹±å’Œå¼¦é¡ºåº
                    for (let i = chords.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [chords[i], chords[j]] = [chords[j], chords[i]];
                    }
                }

                // åˆå§‹åŒ–æˆ–é‡ç½®å’Œå¼¦è¿›è¡Œç´¢å¼•ï¼ˆå½“æ­Œæ›²æˆ–è®¾ç½®æ”¹å˜æ—¶ï¼‰
                const currentOrderBtn = document.querySelector('.progression-order-btn.active');
                const currentOrder = currentOrderBtn ? currentOrderBtn.dataset.value : 'ordered';
                const currentKey = progressionKeyEl.value;
                const currentLevel = progressionLevelEl.value;
                
                // åªæœ‰åœ¨æ­Œæ›²ã€é¡ºåºã€è°ƒæ€§æˆ–ç­‰çº§æ”¹å˜æ—¶æ‰é‡ç½®ï¼Œå¦åˆ™ä¿æŒå½“å‰è¿›åº¦
                if (!state.progressionChords || 
                    state.progressionSong !== selectedSong ||
                    state.progressionOrder !== currentOrder ||
                    state.progressionKey !== currentKey ||
                    state.progressionLevel !== currentLevel) {
                    
                    state.progressionChords = chords;
                    state.progressionSong = selectedSong;
                    state.progressionOrder = currentOrder;
                    state.progressionKey = currentKey;
                    state.progressionLevel = currentLevel;
                    state.progressionIndex = 0; // é‡æ–°å¼€å§‹
                }
                
                // æ¯æ¬¡å¼€å§‹æ–°çš„ç»ƒä¹ ä¼šè¯æ—¶ï¼Œéƒ½ä»ç¬¬ä¸€ä¸ªå’Œå¼¦å¼€å§‹
                if (!state.isInProgressionSession) {
                    state.progressionIndex = 0;
                    state.isInProgressionSession = true;
                }

                // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰å’Œå¼¦
                if (state.progressionIndex >= chords.length) {
                    const isRepeatEnabled = enableRepeatEl.checked;
                    if (isRepeatEnabled) {
                        state.progressionIndex = 0; // é‡æ–°å¼€å§‹
                    } else {
                        // ç›´æ¥é€€å‡ºç»ƒä¹ ç•Œé¢ï¼Œä¸å¼¹å‡ºæç¤ºçª—å£
                        stopRecording();
                        stopMetronome();
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        updateStatusIndicator('ç»ƒä¹ å·²å®Œæˆ', 'ready');
                        
                        // é‡ç½®å’Œå¼¦è½¬æ¢ç»ƒä¹ çš„ä¼šè¯çŠ¶æ€
                        state.isInProgressionSession = false;
                        return;
                    }
                }

                const currentChord = chords[state.progressionIndex];
                const { root, type } = parseChordSymbol(currentChord);

                state.rootNote = root;
                state.chordType = type;

                // æ ¹æ®ç»ƒä¹ ç­‰çº§ç”ŸæˆéŸ³ç¨‹
                const level = progressionLevelEl.value;
                let intervals = getIntervalsForLevel(level);

                state.currentIntervals = intervals;
                targetIntervalEl.textContent = currentChord; // åªæ˜¾ç¤ºå’Œå¼¦åï¼Œä¸æ˜¾ç¤ºæ­Œæ›²å
                displaySequence();

                // å‡†å¤‡ä¸‹ä¸€ä¸ªå’Œå¼¦ï¼ˆä¿æŒç›¸åŒçš„é¡ºåºï¼‰
                const nextIndex = (state.progressionIndex + 1) % chords.length;
                const isRepeatEnabled = enableRepeatEl.checked;
                
                if (isRepeatEnabled || nextIndex !== 0) {
                    const nextChord = chords[nextIndex];
                    state.nextExerciseInfo = nextChord; // åªæ˜¾ç¤ºå’Œå¼¦å
                    
                    // ä¸ºä¸‹ä¸€ä¸ªå’Œå¼¦ç”ŸæˆéŸ³ç¨‹
                    state.nextExerciseIntervals = getIntervalsForLevel(level);
                } else {
                    state.nextExerciseInfo = 'ç»ƒä¹ å®Œæˆ';
                    state.nextExerciseIntervals = [];
                }
                
                // æ›´æ–°ä¸‹ä¸€é¢˜æ˜¾ç¤º
                updateNextExerciseDisplay();

                // æ›´æ–°ç´¢å¼•å‡†å¤‡ä¸‹ä¸€é¢˜
                state.progressionIndex++;
            }
            
            // æ ¹æ®ç»ƒä¹ ç­‰çº§è·å–å¯¹åº”çš„éŸ³ç¨‹
            function getIntervalsForLevel(level) {
                let intervals = [];
                
                switch (level) {
                    // å•å’Œå¼¦éŸ³
                    case 'single-root':
                        intervals = ['1'];
                        break;
                    case 'single-3':
                        intervals = ['3'];
                        break;
                    case 'single-5':
                        intervals = ['5'];
                        break;
                    case 'single-7':
                        intervals = ['7'];
                        break;
                    
                    // åŒå’Œå¼¦éŸ³
                    case 'double-root-3':
                        intervals = ['1', '3'];
                        break;
                    case 'double-root-5':
                        intervals = ['1', '5'];
                        break;
                    case 'double-root-7':
                        intervals = ['1', '7'];
                        break;
                    case 'double-3-5':
                        intervals = ['3', '5'];
                        break;
                    case 'double-3-7':
                        intervals = ['3', '7'];
                        break;
                    case 'double-5-7':
                        intervals = ['5', '7'];
                        break;
                    
                    // ä¸‰å’Œå¼¦éŸ³
                    case 'triple-root-3-5':
                        intervals = ['1', '3', '5'];
                        break;
                    case 'triple-3-5-7':
                        intervals = ['3', '5', '7'];
                        break;
                    case 'triple-random-inversion':
                        // 1,3,5éšæœºè½¬ä½
                        const tripleInversions = [
                            ['1', '3', '5'], // åŸä½
                            ['3', '5', '1'], // ç¬¬ä¸€è½¬ä½  
                            ['5', '1', '3']  // ç¬¬äºŒè½¬ä½
                        ];
                        intervals = tripleInversions[Math.floor(Math.random() * tripleInversions.length)];
                        break;
                    
                    // å››å’Œå¼¦éŸ³
                    case 'quad-root-3-5-7':
                        intervals = ['1', '3', '5', '7'];
                        break;
                    case 'quad-3-5-7-root':
                        intervals = ['3', '5', '7', '1'];
                        break;
                    case 'quad-5-7-root-3':
                        intervals = ['5', '7', '1', '3'];
                        break;
                    case 'quad-7-root-3-5':
                        intervals = ['7', '1', '3', '5'];
                        break;
                    case 'quad-random-inversion':
                        // 1,3,5,7éšæœºè½¬ä½
                        const quadInversions = [
                            ['1', '3', '5', '7'], // åŸä½
                            ['3', '5', '7', '1'], // ç¬¬ä¸€è½¬ä½
                            ['5', '7', '1', '3'], // ç¬¬äºŒè½¬ä½
                            ['7', '1', '3', '5']  // ç¬¬ä¸‰è½¬ä½
                        ];
                        intervals = quadInversions[Math.floor(Math.random() * quadInversions.length)];
                        break;
                    case 'quad-root-3-5-7-root':
                        intervals = ['1', '3', '5', '7', '1'];
                        break;
                    
                    default:
                        intervals = ['1', '3', '5'];
                }
                
                return intervals;
            }
            
            // è·å–å’Œå¼¦çš„ç‰¹å®šéŸ³çº§å¯¹åº”çš„éŸ³ç¬¦
            function getChordTone(root, chordType, interval) {
                const noteIndex = notes.indexOf(root);
                if (noteIndex === -1) return null;
                
                let semitones = 0;
                
                // æ ¹æ®éŸ³çº§å’Œå’Œå¼¦ç±»å‹è®¡ç®—åŠéŸ³æ•°
                switch (interval) {
                    case '1':
                        semitones = 0; // æ ¹éŸ³
                        break;
                    case '3':
                        // ä¸‰éŸ³ï¼šå¤§ä¸‰åº¦æˆ–å°ä¸‰åº¦
                        if (chordType === 'minor' || chordType === 'minor7' || chordType === 'minor6' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 3; // å°ä¸‰åº¦
                        } else {
                            semitones = 4; // å¤§ä¸‰åº¦
                        }
                        break;
                    case '5':
                        // äº”éŸ³ï¼šçº¯äº”åº¦æˆ–å‡äº”åº¦
                        if (chordType === 'minor7b5') {
                            semitones = 6; // å‡äº”åº¦
                        } else {
                            semitones = 7; // çº¯äº”åº¦
                        }
                        break;
                    case '7':
                        // ä¸ƒéŸ³ï¼šå¤§ä¸ƒåº¦æˆ–å°ä¸ƒåº¦
                        if (chordType === 'major7' || chordType === 'major9') {
                            semitones = 11; // å¤§ä¸ƒåº¦
                        } else if (chordType === 'dominant7' || chordType === 'minor7' || chordType === 'dominant9' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 10; // å°ä¸ƒåº¦
                        } else {
                            semitones = 11; // é»˜è®¤å¤§ä¸ƒåº¦
                        }
                        break;
                    default:
                        semitones = 0;
                }
                
                const targetIndex = (noteIndex + semitones) % 12;
                return notes[targetIndex];
            }


            // è§£æå’Œå¼¦ç¬¦å·
            function parseChordSymbol(chordSymbol) {
                // ç®€åŒ–çš„å’Œå¼¦è§£æï¼Œæ”¯æŒå¸¸è§çš„çˆµå£«å’Œå¼¦
                const match = chordSymbol.match(/^([A-G][â™¯â™­]?)(.*)$/);
                if (!match) return { root: 'C', type: 'major' };
                
                const root = match[1]; // ä¿æŒåŸå§‹ç¬¦å·
                const suffix = match[2];
                
                let type = 'major';
                if (suffix === 'm' || suffix === 'min') {
                    type = 'minor';
                } else if (suffix === '7') {
                    type = 'dominant7';
                } else if (suffix === 'maj7' || suffix === 'M7') {
                    type = 'major7';
                } else if (suffix === 'm7') {
                    type = 'minor7';
                } else if (suffix === 'm7â™­5') {
                    type = 'minor7b5';
                } else if (suffix === '6') {
                    type = 'major6';
                } else if (suffix === 'm6') {
                    type = 'minor6';
                } else if (suffix === '9') {
                    type = 'dominant9';
                } else if (suffix === 'maj9' || suffix === 'M9') {
                    type = 'major9';
                } else if (suffix === 'm9') {
                    type = 'minor9';
                } else if (suffix === 'sus2') {
                    type = 'sus2';
                } else if (suffix === 'sus4') {
                    type = 'sus4';
                }
                
                return { root, type };
            }

            // æå–éŸ³é˜¶åç§°ï¼ˆä¸åŒ…å«ç»“æ„ä¿¡æ¯ï¼‰
            function getScaleDisplayName(scaleName) {
                // ä»å®Œæ•´åç§°ä¸­æå–éŸ³é˜¶åç§°ï¼Œç§»é™¤ç»“æ„éƒ¨åˆ†
                // ä¾‹å¦‚ï¼š"Major" -> "Major"
                // ä¾‹å¦‚ï¼š"Dorian - 1 2 â™­3 4 5 6 â™­7" -> "Dorian"
                
                let displayName = scaleName;
                
                // ç§»é™¤æ‹¬å·éƒ¨åˆ†ï¼Œå¦‚ (Ionian)
                displayName = displayName.replace(/\s*\([^)]*\)\s*/g, '');
                
                // ç§»é™¤ç ´æŠ˜å·åŠå…¶åé¢çš„æ‰€æœ‰å†…å®¹ï¼ˆéŸ³ç¨‹ç»“æ„ï¼‰
                const dashIndex = displayName.indexOf(' - ');
                if (dashIndex !== -1) {
                    displayName = displayName.substring(0, dashIndex);
                }
                
                return displayName.trim();
            }

            // æ ¼å¼åŒ–å’Œå¼¦ç¬¦å·
            function formatChordSymbol(rootNote, chordType) {
                const suffixMap = {
                    // åŸºç¡€ä¸‰å’Œå¼¦
                    'major': '',
                    'minor': 'm',
                    'diminished': 'dim',
                    'augmented': 'aug',
                    
                    // å…­å’Œå¼¦
                    'major6': '6',
                    'minor6': 'm6',
                    
                    // ä¸ƒå’Œå¼¦
                    'dominant7': '7',
                    'major7': 'maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7â™­5',
                    'diminished7': 'dim7',
                    
                    // ä¹å’Œå¼¦
                    'dominant9': '9',
                    'major9': 'maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7â™¯9',
                    'dominant7flat9': '7â™­9',
                    
                    // åä¸€å’Œå¼¦
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7â™¯11',
                    
                    // åä¸‰å’Œå¼¦
                    'dominant13': '13',
                    'minor13': 'm13',
                    
                    // æŒ‚ç•™å’Œå¼¦
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    
                    // åŠ éŸ³å’Œå¼¦
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                return `${rootNote}${suffixMap[chordType] || ''}`;
            }

            // è§£æå’Œå¼¦ç¬¦å·
            function parseChordSymbol(chordSymbol) {
                const match = chordSymbol.match(/^([A-G][\u266f\u266d]?)(.*)$/);
                if (!match) {
                    return { root: 'C', type: 'major' };
                }
                
                const root = match[1];
                const suffix = match[2];
                
                // åˆ›å»ºåç¼€åˆ°å’Œå¼¦ç±»å‹çš„æ˜ å°„
                const typeMap = {
                    '': 'major',
                    'm': 'minor',
                    'dim': 'diminished',
                    'aug': 'augmented',
                    '6': 'major6',
                    'm6': 'minor6',
                    '7': 'dominant7',
                    'maj7': 'major7',
                    'm7': 'minor7',
                    'm7â™­5': 'minor7b5',
                    'dim7': 'diminished7',
                    '9': 'dominant9',
                    'maj9': 'major9',
                    'm9': 'minor9',
                    '7â™¯9': 'dominant7sharp9',
                    '7â™­9': 'dominant7flat9',
                    '11': 'dominant11',
                    'm11': 'minor11',
                    '7â™¯11': 'dominant7sharp11',
                    '13': 'dominant13',
                    'm13': 'minor13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                const type = typeMap[suffix] || 'major';
                return { root, type };
            }

            // æ›´æ–°è°ƒæ€§é€‰æ‹©å™¨ï¼Œè®¾ç½®æ­Œæ›²çš„åŸè°ƒä¸ºé»˜è®¤é€‰é¡¹
            function updateKeySelector(songName) {
                const progressionKeyEl = document.getElementById('progressionKey');
                
                // è·å–æ­Œæ›²æ•°æ®
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][songName]) {
                        songData = jazzStandards[letter][songName];
                        break;
                    }
                }
                
                if (!songData) return;
                
                const originalKey = songData.key;
                
                // é‡æ–°ç”Ÿæˆé€‰é¡¹åˆ—è¡¨
                const allKeys = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                
                progressionKeyEl.innerHTML = '';
                
                allKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    
                    if (key === originalKey) {
                        option.textContent = `${key} é»˜è®¤`;
                        option.selected = true;
                    } else {
                        option.textContent = key;
                    }
                    
                    progressionKeyEl.appendChild(option);
                });
            }
            
            // å¤§è°ƒéŸ³é˜¶çš„éŸ³çº§å¯¹åº”å…³ç³»
            const majorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5, 
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // å°è°ƒéŸ³é˜¶çš„éŸ³çº§å¯¹åº”å…³ç³»ï¼ˆä»¥è‡ªç„¶å°è°ƒä¸ºåŸºç¡€ï¼‰
            const minorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5,
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // åäºŒå¹³å‡å¾‹éŸ³åæ•°ç»„
            const chromaticNotes = ['C', 'Câ™¯', 'D', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'G', 'Aâ™­', 'A', 'Bâ™­', 'B'];
            const chromaticNotesFlat = ['C', 'Dâ™­', 'D', 'Eâ™­', 'E', 'F', 'Gâ™­', 'G', 'Aâ™­', 'A', 'Bâ™­', 'B'];
            
            // éŸ³ååˆ°æ•°å­—çš„æ˜ å°„
            const noteToNumber = {
                'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4, 'F': 5,
                'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8, 'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
            };
            
            // æ ¹æ®è°ƒæ€§é€‰æ‹©åˆé€‚çš„éŸ³åæ•°ç»„ï¼ˆä¼˜å…ˆä½¿ç”¨å‡å·æˆ–é™å·ï¼‰
            function getNotesForKey(key) {
                // å‡å·è°ƒï¼šG, D, A, E, B, Fâ™¯, Câ™¯
                const sharpKeys = ['G', 'D', 'A', 'E', 'B', 'Fâ™¯', 'Câ™¯'];
                // é™å·è°ƒï¼šF, Bâ™­, Eâ™­, Aâ™­, Dâ™­, Gâ™­, Câ™­
                const flatKeys = ['F', 'Bâ™­', 'Eâ™­', 'Aâ™­', 'Dâ™­', 'Gâ™­', 'Câ™­'];
                
                if (sharpKeys.includes(key)) {
                    return chromaticNotes; // ä½¿ç”¨å‡å·
                } else {
                    return chromaticNotesFlat; // ä½¿ç”¨é™å·
                }
            }
            
            // è§£æç½—é©¬æ•°å­—çº§æ•°
            function parseRomanNumeral(roman) {
                // åŒ¹é…ç½—é©¬æ•°å­—éƒ¨åˆ†ï¼ˆåŒ…æ‹¬å¯èƒ½çš„é™å·å‰ç¼€ï¼‰
                const match = roman.match(/^(b?)([IVX]+|[ivx]+)/); 
                if (!match) {
                    console.warn(`Cannot parse roman numeral: ${roman}`);
                    return { degree: 'I', isMinor: false, suffix: '' };
                }
                
                const flatPrefix = match[1]; // 'b' æˆ–ç©ºå­—ç¬¦ä¸²
                const romanPart = match[2];
                const suffix = roman.replace(match[0], ''); // ç§»é™¤ç½—é©¬æ•°å­—éƒ¨åˆ†åçš„éƒ¨åˆ†
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºå°å†™ï¼ˆå°è°ƒï¼‰
                const isMinor = /[ivx]/.test(romanPart);
                const upperRoman = flatPrefix + romanPart.toUpperCase();
                
                return {
                    degree: upperRoman,
                    isMinor: isMinor,
                    suffix: suffix
                };
            }
            
            // å°†éŸ³çº§è½¬æ¢ä¸ºå…·ä½“çš„éŸ³å
            function degreeToNote(degree, keyRoot, keyMode = 'major') {
                const keyRootNumber = noteToNumber[keyRoot];
                const scaleDegrees = keyMode === 'major' ? majorScaleDegrees : minorScaleDegrees;
                
                if (!(degree in scaleDegrees)) {
                    console.warn(`Unknown degree: ${degree}`);
                    return keyRoot;
                }
                
                const semitones = scaleDegrees[degree];
                const resultNumber = (keyRootNumber + semitones) % 12;
                
                const notesArray = getNotesForKey(keyRoot);
                return notesArray[resultNumber];
            }
            
            // å°†åŸºäºéŸ³çº§çš„å’Œå¼¦è½¬æ¢ä¸ºå…·ä½“è°ƒæ€§çš„å’Œå¼¦
            function transposeChordFromDegree(degreeChord, originalKey, targetKey) {
                const parsed = parseRomanNumeral(degreeChord);
                const targetNote = degreeToNote(parsed.degree, targetKey, 'major');
                
                // æ„å»ºå’Œå¼¦ç¬¦å·
                let chordSymbol = targetNote;
                
                // æ·»åŠ å’Œå¼¦ç±»å‹
                if (parsed.isMinor) {
                    chordSymbol += 'm';
                }
                
                // æ·»åŠ å…¶ä»–åç¼€
                chordSymbol += parsed.suffix;
                
                // å¤„ç†ç‰¹æ®Šç¬¦å·æ›¿æ¢
                chordSymbol = chordSymbol.replace('M7', 'maj7').replace('M', 'maj');
                
                return chordSymbol;
            }

            // å¯åŠ¨åº”ç”¨
            initApp();
        });
    </script>
</body>

</html>