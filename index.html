<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>吉他指板视觉化练习工具</title>
    <!-- ml5.js库 - 用于CREPE音高检测算法 -->
    <script src="js/ml5.min.js"></script>
    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="styles/main.css">
    <style>
        /* 保留少量仅在此页面需要的特定样式 */
        /* 权限指导模态框样式 */
        .permission-guidance {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 40, 50, 0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            width: 80%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .permission-guidance h3 {
            margin-bottom: 15px;
            color: #3a9fc4;
        }

        .permission-guidance ol {
            margin-left: 20px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .permission-guidance button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        #refresh-page {
            background: #3a9fc4;
        }

        #dismiss-guidance {
            background: #6c757d;
        }


        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
            color: #e0e0e0;
            padding: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            width: 100%;
            background-color: rgba(40, 40, 50, 0.9);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 152, 0, 0.3);
            padding-bottom: 15px;
        }

        h1 {
            color: #3a9fc4;
            margin-top: 40px;
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .instructions {
            color: #b0b0b0;
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .settings-panel {
            background: linear-gradient(to right, rgba(51, 51, 51, 0.8), rgba(60, 60, 70, 0.8));
            border-radius: 12px;
            padding: 0;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .settings-tabs {
            display: flex;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(40, 40, 50, 0.8);
        }

        .settings-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 14px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .settings-tab.active {
            color: #3a9fc4;
            border-bottom: 2px solid #3a9fc4;
            background: rgba(128, 128, 128, 0.2);
        }

        .settings-content {
            margin-top: 20px;
            padding: 12px;
        }

        .settings-section {
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #3a9fc4;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }

        .settings-section-title i {
            margin-right: 10px;
            font-size: 20px;
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .settings-label {
            font-size: 14px;
            color: #e0e0e0;
            margin-bottom: 6px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .settings-label .info {
            color: #888;
            font-size: 14px;
        }

        .select-wrapper {
            position: relative;
            width: 100%;
        }

        .select-wrapper::after {
            content: "▼";
            font-size: 10px;
            color: #808080;
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #fff;
            font-size: 14px;
            appearance: none;
            -webkit-appearance: none;
            outline: none;
            transition: all 0.2s;
        }

        select:focus {
            border-color: #ffffff;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        .switch-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .switch-label {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #3a9fc4;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }

        .chord-type-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(min-content, 1fr));
            gap: 8px;
            width: 100%;
        }


        .chord-type-btn {
            padding: 8px 6px;
            border-radius: 6px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 0;
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .chord-type-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .chord-type-btn.active {
            background-color: rgba(58, 159, 196, 0.2);
            color: #3a9fc4;
            border-color: #3a9fc4;
        }

        .order-btn-container {
            display: flex;
            gap: 8px;
            width: 100%;
        }

        .order-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 8px;
            border: 1px solid #555;
            background-color: #2c2c3c;
            color: #aaa;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-btn.active {
            background-color: rgba(58, 159, 196, 0.2);
            color: #3a9fc4;
            border-color: #3a9fc4;
        }

        .btn {
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            background: linear-gradient(to right, #4fc3f7, #29b6f6);
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            flex: 1;
            max-width: 280px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
        }

        .btn:disabled {
            background: linear-gradient(to right, #555, #666);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .chord-type-container {
                grid-template-columns: repeat(4, 1fr);
            }

            .settings-row {
                flex-direction: row;
                align-items: center;
            }

            .settings-label {
                min-width: 100px;
                margin-bottom: 0;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 24px;
            }

            .btn {
                padding: 16px 24px;
                font-size: 16px;
            }

            .settings-section-title {
                font-size: 16px;
            }

            .settings-tab {
                padding: 14px 12px;
                font-size: 14px;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.1s ease;
        }

        #practiceScreen.metronome-active {
            /* 节拍器激活状态的基础样式 */
            transition: background-color 0.1s ease;
        }



        .exercise-container {
            background: linear-gradient(135deg, rgba(51, 65, 85, 0.95), rgba(71, 85, 105, 0.95));
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }
        
        .song-title-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 100%;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.1);
        }
        
        .song-title {
            font-size: 28px;
            font-weight: bold;
            color: #60a5fa;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            letter-spacing: 0.5px;
        }

        .scale-info {
            margin-bottom: 24px;
        }

        .target-interval {
            font-size: 36px;
            font-weight: 700;
            color: #38bdf8;
            margin: 12px 0;
            text-shadow: 0 4px 8px rgba(56, 189, 248, 0.3);
            letter-spacing: -0.5px;
        }

        .sequence-display {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 0px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sequence-title {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .sequence-items {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px 0;
            margin: 10px auto;
            width: 100%;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            font-weight: 700;
            color: #ff8a00;
            transition: all 0.3s ease;
            padding: 8px;
            border-radius: 6px;
            background: rgba(51, 65, 85, 0.9);
            min-width: 36px;
            height: 36px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 0 1 auto;
        }

        .sequence-item.played {
            color: #64748b !important;
            background: rgba(30, 41, 59, 0.6) !important;
            box-shadow: none !important;
            border-color: rgba(100, 116, 139, 0.3);
            transform: scale(0.95);
        }

        .sequence-item.current {
            color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
        }

        .next-exercise {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            width: 100%;
            max-width: 600px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .next-label {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .next-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .next-content {
            font-size: 16px;
            color: #ff8a00;
            font-weight: 600;
            text-align: center;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-recording {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-weight: 600;
            color: #ff8a00;
        }

        .pitch-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .pitch-display.in-tune {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .pitch-display.out-of-tune {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .confidence-bar {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: #38bdf8;
            border-radius: 2px;
            transition: width 0.2s ease;
        }



        .device-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .gain-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .gain-control input {
            flex: 1;
        }

        .gain-value {
            min-width: 40px;
            text-align: right;
        }

        .usb-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #22c55e;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes metronomeFlash {
            0% {
                background-color: rgba(58, 159, 196, 0);
            }

            50% {
                background-color: rgba(58, 159, 196, 0.3);
            }

            100% {
                background-color: rgba(58, 159, 196, 0);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes metronomeFlash {
            0% {
                background-color: rgba(58, 159, 196, 0);
            }

            50% {
                background-color: rgba(58, 159, 196, 0.3);
            }

            100% {
                background-color: rgba(58, 159, 196, 0);
            }
        }

        .metronome-flash {
            animation: metronomeFlash 0.2s ease;
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.3s ease;
        }

        #practiceScreen.metronome-flash {
            background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            transition: background-color 0.1s ease;
        }

        /* 其他样式保持不变... */

        @keyframes metronomeFlash {
            0% {
                background: linear-gradient(135deg, #0f172a, #1e293b);
            }

            20% {
                background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            }

            100% {
                background: linear-gradient(135deg, #0f172a, #1e293b);
            }
        }

        .metronome-flash {
            animation: metronomeFlash 0.3s ease;
        }
        
        /* 手机横屏适配 - 调整sequence-item字体大小 */
        @media (max-height: 480px) and (orientation: landscape) {
            .sequence-item {
                font-size: 25px;
            }
            
            /* 进一步压缩页面元素上下的margin */
            #practiceScreen {
                padding: 8px;
            }
            
            .exercise-container {
                padding: 16px 12px; /* 增加上下padding使内容更舒展 */
                margin-bottom: 8px;
            }
            
            .scale-info {
                margin-bottom: 12px; /* 增加底部margin */
            }
            
            .target-interval {
                font-size: 24px;
                margin: 10px 0; /* 增加上下margin */
            }
            
            .sequence-display {
                padding: 12px 8px; /* 增加上下padding */
                margin: 12px 0; /* 增加上下margin */
            }
            
            .sequence-item {
                font-size: 25px;
                min-width: 30px;
                height: 34px;
                padding: 6px;
                margin: 14px; /* 增加元素间margin */
            }
            
            .next-exercise {
                margin: 12px 0; /* 增加上下margin */
                padding: 12px 8px; /* 增加上下padding */
            }
            
            .song-title-display {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .song-title {
                font-size: 22px;
            }
            
            .next-label {
                font-size: 12px;
                margin-bottom: 6px; /* 增加底部margin */
            }
            
            .next-content {
                font-size: 14px;
            }
            
            /* 横屏模式下隐藏header */
            .header {
                display: none;
            }
            
            /* 手机模式下隐藏快捷键提示 */
            .shortcut-hint {
                display: none;
            }
        }
        
        /* 手机模式下隐藏快捷键提示（覆盖所有手机尺寸） */
        @media (max-width: 768px) {
            .shortcut-hint {
                display: none !important;
            }
        }
        
        /* 手机模式下隐藏header（覆盖所有手机尺寸）
        @media (max-width: 768px) {
            .header {
                display: none !important;
            }
        } */
        
        /* 底部导航栏样式 */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(40, 40, 50, 0.95);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #aaa;
        }
        
        .nav-item.active {
            color: #3a9fc4;
        }
        
        /* 降低转换按钮的亮度 */
        .nav-item[data-tab="progression"] {
            color: #888;
        }
        
        .nav-item[data-tab="progression"].active {
            color: #2a7f94; /* 调低亮度的颜色 */
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* 调整主容器的底部边距，为底部导航栏留出空间 */
        .container {
            margin-bottom: 60px;
        }
    </style>
</head>

<body>
    <!-- 其他HTML内容保持不变... -->
    <div class="status-indicator status-ready" id="statusIndicator">准备就绪</div>

    <!-- 键盘快捷键提示 -->
    <div class="shortcut-hint" id="shortcutHint">
        按 <span class="shortcut-key">ESC</span> 返回主菜单
    </div>

    <!-- 实时音高显示 -->
    <div class="pitch-display" id="pitchDisplay" style="display: none;">
        <div>音高: --</div>
        <div>音分差: 0</div>
        <div class="confidence-bar">
            <div class="confidence-fill" style="width: 0%"></div>
        </div>
    </div>

    <div class="container" id="mainScreen">
        <div class="header">
            <h1>🎸 吉他音阶与和弦练习工具 - 支持USB声卡</h1>
            <div class="instructions">
                支持吉他通过USB声卡输入进行音高检测。连接您的USB音频接口后，选择对应的设备即可开始练习。
            </div>
        </div>

        <!-- 设置面板 -->
        <div class="settings-panel">
            <!-- 设置内容区域 -->
            <div class="settings-content">


                <!-- 和弦设置 -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>🎶</i> 和弦设置
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            根音
                            <span class="info">选择和弦的根音</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="C♯">C♯</option>
                                <option value="D♭">D♭</option>
                                <option value="D">D</option>
                                <option value="D♯">D♯</option>
                                <option value="E♭">E♭</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F♯">F♯</option>
                                <option value="G♭">G♭</option>
                                <option value="G">G</option>
                                <option value="G♯">G♯</option>
                                <option value="A♭">A♭</option>
                                <option value="A">A</option>
                                <option value="A♯">A♯</option>
                                <option value="B♭">B♭</option>
                                <option value="B">B</option>
                                <option value="random" selected>随机根音</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            和弦类型
                            <span class="info">选择要练习的和弦类型</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">dim</div>
                            <div class="chord-type-btn" data-value="augmented">aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7♭5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7♯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7♭9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7♯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                            点击选择要练习的和弦类型（可多选）
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            顺序
                            <span class="info">选择和弦音符的演奏顺序</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">上行</div>
                            <div class="order-btn chord-order-btn" data-value="reverse">下行</div>
                            <div class="order-btn chord-order-btn" data-value="random">随机</div>
                        </div>
                    </div>

                    <!-- 自定义和弦进行控件 -->
                    <div class="settings-row">
                        <div class="settings-label">
                            自定义和弦:
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="useCustomChords">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div id="customChordsControls" style="display: none; margin-top: 10px;">
                        <style>
        /* 重置设置按钮悬停效果 */
        #resetSettingsBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(to right, #f87171, #ef4444) !important;
        }

        #resetSettingsBtn:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* 其他现有样式 */
                            .custom-chord-add {
                                display: flex;
                                gap: 8px;
                                margin-bottom: 12px;
                            }

                            .custom-chord-add select {
                                width: 120px;
                                padding: 8px;
                                background: #2c2c3c;
                                border: 1px solid #555;
                                border-radius: 8px;
                                color: #fff;
                            }

                            .custom-chord-add button {
                                padding: 8px 12px;
                                background: linear-gradient(to right, #4fc3f7, #29b6f6);
                                border: none;
                                border-radius: 8px;
                                color: white;
                                cursor: pointer;
                            }

                            .custom-chord-list {
                                background: rgba(30, 41, 59, 0.5);
                                padding: 12px;
                                border-radius: 8px;
                                margin-top: 8px;
                            }

                            .custom-chord-actions {
                                display: flex;
                                gap: 8px;
                                margin-top: 12px;
                            }

                            .custom-chord-actions {
                                display: flex;
                                gap: 8px;
                                margin-top: 12px;
                            }

                            .custom-chord-actions button {
                                flex: 1;
                                padding: 8px;
                                background: #2c2c3c;
                                border: 1px solid #555;
                                border-radius: 6px;
                                color: #aaa;
                                cursor: pointer;
                                min-width: 40px;
                            }

                            .custom-chord-actions button:hover {
                                background: rgba(58, 159, 196, 0.2);
                                color: #3a9fc4;
                                border-color: #3a9fc4;
                            }

                            #customChordSequence {
                                display: flex;
                                flex-wrap: wrap;
                                gap: 6px;
                                margin-top: 8px;
                            }


                            .chord-item {
                            display: inline-block;
                            margin: 5px;
                            padding: 5px 10px;
                            background: rgba(58, 159, 196, 0.2);
                            border-radius: 4px;
                            }

                            /* .chord-item {
                                display: flex;
                                justify-content: space-between;
                                padding: 6px 8px;
                                background: rgba(51, 65, 85, 0.7);
                                border-radius: 4px;
                                min-width: 60px;
                                max-width: 100px;
                                flex: 1 0 auto;
                            } */

                            .remove-chord {
                                background: transparent;
                                border: none;
                                color: #ff6b6b;
                                cursor: pointer;
                                font-weight: bold;
                            }

                            .sequence-dialog {
                                position: fixed;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                background: rgba(40, 40, 50, 0.95);
                                padding: 20px;
                                border-radius: 12px;
                                z-index: 2000;
                                width: 80%;
                                max-width: 400px;
                                backdrop-filter: blur(10px);
                                border: 1px solid rgba(255, 255, 255, 0.1);
                            }

                            .sequence-item-dialog {
                                padding: 10px;
                                margin: 8px 0;
                                background: rgba(51, 65, 85, 0.7);
                                border-radius: 8px;
                                cursor: pointer;
                            }

                            .sequence-item-dialog:hover {
                                background: rgba(58, 159, 196, 0.3);
                            }
                        </style>
                        <div class="custom-chord-add">
                            <select id="customChordRoot">
                                <option value="C">C</option>
                                <option value="C♯">C♯</option>
                                <option value="D">D</option>
                                <option value="D♯">D♯</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F♯">F♯</option>
                                <option value="G">G</option>
                                <option value="G♯">G♯</option>
                                <option value="A">A</option>
                                <option value="A♯">A♯</option>
                                <option value="B">B</option>
                            </select>
                            <select id="customChordType">
                                <option value="major">大三和弦</option>
                                <option value="minor">小三和弦</option>
                                <option value="diminished">减三和弦</option>
                                <option value="augmented">增三和弦</option>
                                <option value="major6">大六和弦</option>
                                <option value="minor6">小六和弦</option>
                                <option value="dominant7">属七和弦</option>
                                <option value="major7">大七和弦</option>
                                <option value="minor7">小七和弦</option>
                                <option value="minor7b5">半减七和弦</option>
                                <option value="diminished7">减七和弦</option>
                                <option value="dominant9">属九和弦</option>
                                <option value="major9">大九和弦</option>
                                <option value="minor9">小九和弦</option>
                                <option value="dominant7sharp9">属7♯9和弦</option>
                                <option value="dominant7flat9">属7♭9和弦</option>
                                <option value="dominant11">属11和弦</option>
                                <option value="minor11">小11和弦</option>
                                <option value="dominant7sharp11">属7♯11和弦</option>
                                <option value="dominant13">属13和弦</option>
                                <option value="minor13">小13和弦</option>
                                <option value="sus2">挂二和弦</option>
                                <option value="sus4">挂四和弦</option>
                                <option value="add9">加九和弦</option>
                                <option value="madd9">小加九和弦</option>
                                <option value="6add9">六加九和弦</option>
                                <option value="m6add9">小六加九和弦</option>
                            </select>
                            <button id="addCustomChord">添加和弦</button>
                        </div>

                        <div class="custom-chord-list">
                            <div class="settings-label">自定义和弦进行:</div>
                            <div class="sequence-name-input" style="margin-bottom: 8px;">
                                <input type="text" id="sequenceName" placeholder="请输入歌曲名（可选）"
                                    style="width: 100%; height:25px;margin-top: 8px; padding: 4px; border: none; border-radius: 4px; background-color: rgba(255, 255, 255, 0.1); color: white;" />
                            </div>
                            <div id="customChordSequence"></div>
                            <div class="custom-chord-actions">
                                <button id="clearCustomChords">清空自定义和弦进行</button>
                                <button id="saveCustomChords">保存和弦进行到本地</button>
                                <button id="loadLocalChords">加载本地和弦进行</button>
                                <button id="loadSequence">加载序列</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 和弦转换设置 -->
                <div class="settings-section progression-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>🎶</i> 转换设置
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            练习等级
                            <span class="info">选择和弦复杂度</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="progressionLevel">
                                <optgroup label="单和弦音">
                                    <option value="single-root">1</option>
                                    <option value="single-3">3</option>
                                    <option value="single-5">5</option>
                                    <option value="single-7">7</option>
                                </optgroup>
                                <optgroup label="双和弦音">
                                    <option value="double-root-3">1,3</option>
                                    <option value="double-root-5">1,5</option>
                                    <option value="double-root-7">1,7</option>
                                    <option value="double-3-5">3,5</option>
                                    <option value="double-3-7">3,7</option>
                                </optgroup>
                                <optgroup label="三和弦音">
                                    <option value="triple-root-3-5" selected>1,3,5</option>
                                    <option value="triple-3-5-7">3,5,7</option>
                                    <option value="triple-random-inversion">1,3,5随机转位</option>
                                </optgroup>
                                <optgroup label="四和弦音">
                                    <option value="quad-root-3-5-7">1,3,5,7</option>
                                    <option value="quad-3-5-7-root">3,5,7,1</option>
                                    <option value="quad-5-7-root-3">5,7,1,3</option>
                                    <option value="quad-7-root-3-5">7,1,3,5</option>
                                    <option value="quad-random-inversion">1,3,5,7随机转位</option>
                                    <option value="quad-root-3-5-7-root">1,3,5,7,1</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            和弦转换
                            <span class="info">选择经典爵士乐歌曲</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="jazzStandard">
                                
                                <optgroup label="5">
                                    <option value="500 Miles High">500 Miles High</option>
                                </optgroup>
                                <optgroup label="A">
                                    <option value="All The Things You Are">All The Things You Are</option>
                                    <option value="Autumn Leaves">Autumn Leaves</option>
                                    <option value="All Of Me">All Of Me</option>
                                    <option value="A Night In Tunisia">A Night In Tunisia</option>
                                    <option value="All of You">All of You</option>
                                    <option value="Alone Together">Alone Together</option>
                                    <option value="Ambleside">Ambleside</option>
                                    <option value="Anthropology">Anthropology</option>
                                    <option value="Ask Me Now">Ask Me Now</option>
                                </optgroup>
                                <optgroup label="B">
                                    <option value="Blue Moon">Blue Moon</option>
                                    <option value="Body And Soul">Body And Soul</option>
                                    <option value="Bye Bye Blackbird">Bye Bye Blackbird</option>
                                    <option value="Beautiful Love">Beautiful Love</option>
                                    <option value="Blue Bossa">Blue Bossa</option>
                                    <option value="Blue in Green">Blue in Green</option>
                                    <option value="Blues for Alice">Blues for Alice</option>
                                </optgroup>
                                <optgroup label="C">
                                    <option value="Cherokee">Cherokee</option>
                                    <option value="Come Rain Or Come Shine">Come Rain Or Come Shine</option>
                                    <option value="Confirmation">Confirmation</option>
                                    <option value="Coral">Coral</option>
                                    <option value="Corcovado">Corcovado</option>
                                    <option value="Countdown">Countdown</option>
                                </optgroup>
                                <optgroup label="D">
                                    <option value="Days Of Wine And Roses">Days Of Wine And Roses</option>
                                    <option value="Donna Lee">Donna Lee</option>
                                    <option value="Doxy">Doxy</option>
                                    <option value="Dream A Little Dream">Dream A Little Dream</option>
                                </optgroup>
                                <optgroup label="F">
                                    <option value="Fall">Fall</option>
                                    <option value="Falling Grace">Falling Grace</option>
                                    <option value="Fly Me To The Moon">Fly Me To The Moon</option>
                                    <option value="Four">Four</option>
                                    <option value="Footprints">Footprints</option>
                                </optgroup>
                                <optgroup label="G">
                                    <option value="Giant Steps">Giant Steps</option>
                                    <option value="Georgia On My Mind">Georgia On My Mind</option>
                                    <option value="Girl From Ipanema">Girl From Ipanema</option>
                                </optgroup>
                                <optgroup label="H">
                                    <option value="Have You Met Miss Jones">Have You Met Miss Jones</option>
                                    <option value="Here's That Rainy Day">Here's That Rainy Day</option>
                                    <option value="How High The Moon">How High The Moon</option>
                                </optgroup>
                                <optgroup label="I">
                                    <option value="I Got Rhythm">I Got Rhythm</option>
                                    <option value="I Can't Get Started">I Can't Get Started</option>
                                    <option value="In A Sentimental Mood">In A Sentimental Mood</option>
                                    <option value="Infant Eyes">Infant Eyes</option>
                                    <option value="Inner Urge">Inner Urge</option>
                                </optgroup>
                                <optgroup label="J">
                                    <option value="Just Friends">Just Friends</option>
                                    <option value="Joy Spring">Joy Spring</option>
                                    <option value="Jordu">Jordu</option>
                                </optgroup>
                                <optgroup label="L">
                                    <option value="Lady Bird">Lady Bird</option>
                                    <option value="Love For Sale">Love For Sale</option>
                                    <option value="Lover Man">Lover Man</option>
                                </optgroup>
                                <optgroup label="M">
                                    <option value="Misty">Misty</option>
                                    <option value="My Funny Valentine">My Funny Valentine</option>
                                    <option value="Maiden Voyage">Maiden Voyage</option>
                                </optgroup>
                                <optgroup label="N">
                                    <option value="Night And Day">Night And Day</option>
                                    <option value="Nardis">Nardis</option>
                                    <option value="Night Train">Night Train</option>
                                </optgroup>
                                <optgroup label="O">
                                    <option value="Oleo">Oleo</option>
                                </optgroup>
                                <optgroup label="S">
                                    <option value="Someday My Prince Will Come">Someday My Prince Will Come</option>
                                    <option value="Spain">Spain</option>
                                    <option value="Stella By Starlight">Stella By Starlight</option>
                                    <option value="Summertime">Summertime</option>
                                    <option value="Solar">Solar</option>
                                </optgroup>
                                <optgroup label="T">
                                    <option value="Take Five">Take Five</option>
                                    <option value="Take the A-Train">Take the A-Train</option>
                                    <option value="The Girl From Ipanema">The Girl From Ipanema</option>
                                    <option value="There Will Never Be Another You">There Will Never Be Another You</option>
                                    <option value="The Way You Look Tonight">The Way You Look Tonight</option>
                                    <option value="Time Remembered">Time Remembered</option>
                                </optgroup>
                                <optgroup label="V">
                                    <option value="Very Early">Very Early</option>
                                    <option value="Virgo">Virgo</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            顺序
                            <span class="info">选择和弦进行的演奏顺序</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn progression-order-btn active" data-value="ordered">顺序</div>
                            <div class="order-btn progression-order-btn" data-value="reverse">倒序</div>
                            <div class="order-btn progression-order-btn" data-value="random">随机</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            重复练习
                            <span class="info">开启后对歌曲进行重复练习</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="enableRepeat">
                            <span class="slider round"></span>
                        </label>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            调
                            <span class="info">选择练习的调性</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="progressionKey">
                                <option value="C">C</option>
                                <option value="C♯">C♯</option>
                                <option value="D♭">D♭</option>
                                <option value="D">D</option>
                                <option value="D♯">D♯</option>
                                <option value="E♭">E♭</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F♯">F♯</option>
                                <option value="G♭">G♭</option>
                                <option value="G">G</option>
                                <option value="G♯">G♯</option>
                                <option value="A♭">A♭</option>
                                <option value="A">A</option>
                                <option value="A♯">A♯</option>
                                <option value="B♭">B♭</option>
                                <option value="B">B</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- 设置 -->
                <div class="settings-section device-settings" style="display:none;">
                    <div class="settings-section-title">
                        <i>🎤</i> 音频输入设置
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            音频输入设备
                            <span class="info">选择吉他连接的声卡设备</span>
                        </div>

                    </div>
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <select id="audioInputDevice" style="width: 70%; padding: 8px; border-radius: 4px;"></select>
                        <button class="btn" id="refreshDevicesBtn"
                            style="width: 25%; padding: 8px; font-size: 14px; margin-left: 10px;">刷新设备列表</button>
                    </div>

                    <div class="device-info" id="deviceInfo">
                        检测到设备后，请选择您的USB音频接口
                    </div>
                    <div class="settings-row" style="margin-top: 12px;">
                        <div class="settings-label">
                            输入增益
                            <span class="info">调节输入音量大小</span>
                        </div>
                        <div class="gain-control">
                            <input type="range" id="inputGain" min="0" max="200" value="100">
                            <span class="gain-value" id="inputGainValue">100%</span>
                        </div>
                    </div>

                    <div class="settings-row" style="margin-top: 12px;">
                        <div class="settings-label">
                            音高检测敏感度
                            <span class="info">调节音高识别的敏感程度（0.1-1.0）</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 100%;">
                            <input type="range" id="sensitivity" min="0.1" max="1.0" step="0.1" value="0.5"
                                style="flex: 1;">
                            <span id="sensitivityValue"
                                style="min-width: 40px; text-align: right; font-size: 14px;">0.5</span>
                        </div>
                    </div>

                    <div class="settings-row" style="margin-bottom: 12px;">
                        <div class="settings-label">
                            置信度阈值
                            <span class="info">音高识别的可信度要求（0.3-0.9）</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 100%;">
                            <input type="range" id="confidenceThreshold" min="0.3" max="0.9" step="0.1" value="0.6"
                                style="flex: 1;">
                            <span id="confidenceThresholdValue"
                                style="min-width: 40px; text-align: right; font-size: 14px;">0.6</span>
                        </div>
                    </div>

                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>⚙️</i> 练习设置
                    </div>
                    
                    <!-- 冷却时间设置 -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">麦克风冷却时间</span>
                            <label class="switch">
                                <input type="checkbox" id="enableCooldown" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">时间:</span>
                            <input type="range" id="cooldownDuration" min="200" max="3000" step="100" value="600"
                                style="width: 65%; margin-right: 3px;">
                            <span id="cooldownDurationValue"
                                style="min-width: 50px; text-align: right; font-size: 14px;">600ms</span>
                        </div>
                    </div>

                    <!-- 固定延迟生成下一题设置 -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">延迟生成下一题</span>
                            <label class="switch">
                                <input type="checkbox" id="enableFixedDelay">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">时间:</span>
                            <input type="range" id="fixedDelayDuration" min="500" max="2000" step="100" value="800"
                                style="width: 65%; margin-right: 3px;">
                            <span id="fixedDelayDurationValue"
                                style="min-width: 50px; text-align: right; font-size: 14px;">800ms</span>
                        </div>
                    </div>



                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>🎯</i> 节拍器设置
                    </div>
                    <div
                        style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="switch-label">启用节拍器</span>
                            <label class="switch">
                                <input type="checkbox" id="metronomeToggle">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 5px; width: 60%; margin-left: auto;">
                            <span style="white-space: nowrap; font-size: 14px;">速度:</span>
                            <input type="range" id="metronomeTempo" min="20" max="120" step="1" value="40"
                                style="width: 65%; margin-right: 3px;">
                            <span id="metronomeTempoValue"
                                style="min-width: 25px; text-align: right; font-size: 14px;">40</span>
                        </div>
                    </div>
                    
                    <!-- 节拍器选项 -->
                    <div style="display: flex; gap: 15px; margin-bottom: 12px; margin-left: 20px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="metronomeFlashToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label" style="font-size: 14px;">背景闪光</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label class="switch">
                                <input type="checkbox" id="metronomeSoundToggle" checked>
                                <span class="slider"></span>
                            </label>
                            <span class="switch-label" style="font-size: 14px;">声音节拍</span>
                        </div>
                    </div>
                    
                    <!-- 设置管理 -->
                    <div class="settings-section-title" style="margin-top: 20px;">
                        <i>😎</i> 设置管理
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 12px;">
                        <button id="resetSettingsBtn" 
                            style="flex: 1; padding: 12px; background: linear-gradient(to right, #ef4444, #dc2626); border: none; border-radius: 8px; color: white; cursor: pointer; font-weight: 500; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); transition: all 0.2s; font-size: 14px;">
                            重置所有设置
                        </button>
                    </div>
                    <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                        点击重置按钮将恢复所有设置为默认值
                    </div>
                </div>

                <!-- 音阶设置 - 只在音阶练习标签页显示 -->
                <div class="settings-section scale-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>🎵</i> 音阶设置
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            调
                            <span class="info">选择调</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="rootNote">
                                <option value="C">C</option>
                                <option value="C♯">C♯</option>
                                <option value="D♭">D♭</option>
                                <option value="D">D</option>
                                <option value="D♯">D♯</option>
                                <option value="E♭">E♭</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F♯">F♯</option>
                                <option value="G♭">G♭</option>
                                <option value="G">G</option>
                                <option value="G♯">G♯</option>
                                <option value="A♭">A♭</option>
                                <option value="A">A</option>
                                <option value="A♯">A♯</option>
                                <option value="B♭">B♭</option>
                                <option value="B">B</option>
                                <option value="random" selected>随机</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            调式
                            <span class="info">选择音阶调式</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="scaleType">
                                <optgroup label="基本调式">
                                    <option value="major">Major</option>
                                    <option value="minor">Minor</option>
                                </optgroup>
                                
                                <optgroup label="教会调式 (Church Modes)">
                                    <option value="ionian">Ionian - 1 2 3 4 5 6 7</option>
                                    <option value="dorian">Dorian - 1 2 ♭3 4 5 6 ♭7</option>
                                    <option value="phrygian">Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7</option>
                                    <option value="lydian">Lydian - 1 2 3 ♯4 5 6 7</option>
                                    <option value="mixolydian">Mixolydian - 1 2 3 4 5 6 ♭7</option>
                                    <option value="aeolian">Aeolian - 1 2 ♭3 4 5 ♭6 ♭7</option>
                                    <option value="locrian">Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7</option>
                                </optgroup>
                                
                                <optgroup label="和声小调系列">
                                    <option value="harmonicMinor">Harmonic Minor - 1 2 ♭3 4 5 ♭6 7</option>
                                    <option value="dorianSharp2">Dorian ♯2 - 1 ♯2 ♭3 4 5 6 ♭7</option>
                                    <option value="phrygianMajor">Phrygian Major - 1 ♭2 3 4 5 ♭6 ♭7</option>
                                    <option value="lydianSharp2">Lydian ♯2 - 1 ♯2 3 ♯4 5 6 7</option>
                                    <option value="mixolydianFlat6">Mixolydian ♭6 - 1 2 3 4 5 ♭6 ♭7</option>
                                    <option value="lydianFlat2">Lydian ♭2 - 1 ♭2 3 ♯4 5 6 7</option>
                                    <option value="superLocrianDiminished">Super Locrian Diminished - 1 ♭2 ♭3 ♭4 ♭5 ♭6 6</option>
                                </optgroup>
                                
                                <optgroup label="旋律小调系列">
                                    <option value="melodicMinor">Melodic Minor - 1 2 ♭3 4 5 6 7</option>
                                    <option value="dorianFlat2">Dorian ♭2 - 1 ♭2 ♭3 4 5 6 ♭7</option>
                                    <option value="lydianAugmented">Lydian Augmented - 1 2 3 ♯4 ♯5 6 7</option>
                                    <option value="lydianFlat7">Lydian ♭7 - 1 2 3 ♯4 5 6 ♭7</option>
                                    <option value="aeolianFlat5">Aeolian ♭5 - 1 2 ♭3 4 ♭5 ♭6 ♭7</option>
                                    <option value="superLocrian">Super Locrian - 1 ♭2 ♭3 ♭4 ♭5 ♭6 ♭7</option>
                                </optgroup>
                                
                                <optgroup label="五声音阶">
                                    <option value="majorPentatonic">Major Pentatonic - 1 2 3 5 6</option>
                                    <option value="minorPentatonic">Minor Pentatonic - 1 ♭3 4 5 ♭7</option>
                                    <option value="dorianPentatonic">Dorian Pentatonic - 1 2 ♭3 5 6</option>
                                    <option value="phrygianPentatonic">Phrygian Pentatonic - 1 ♭2 4 5 ♭6</option>
                                    <option value="mixolydianPentatonic">Mixolydian Pentatonic - 1 2 3 5 ♭7</option>
                                </optgroup>
                                
                                <optgroup label="布鲁斯音阶">
                                    <option value="blues">Blues - 1 ♭3 4 ♯4 5 ♭7</option>
                                    <option value="majorBlues">Major Blues - 1 2 ♭3 3 5 6</option>
                                </optgroup>
                                
                                <optgroup label="特殊音阶">
                                    <option value="wholeTone">Whole Tone - 1 2 3 ♯4 ♯5 ♯6</option>
                                    <option value="diminished">Diminished (Half-Whole) - 1 ♭2 ♭3 3 ♯4 5 6 ♭7</option>
                                    <option value="diminishedWhole">Diminished (Whole-Half) - 1 2 ♭3 4 ♯4 ♯5 6 7</option>
                                    <option value="chromatic">Chromatic - 1 ♭2 2 ♭3 3 4 ♯4 5 ♭6 6 ♭7 7</option>
                                </optgroup>
                                
                                <optgroup label="异国风格">
                                    <option value="arabic">Arabic - 1 ♭2 3 4 5 ♭6 ♭7</option>
                                    <option value="gypsy">Gypsy - 1 ♭2 3 4 5 ♭6 7</option>
                                    <option value="japanese">Japanese - 1 ♭2 4 5 ♭6</option>
                                    <option value="egyptian">Egyptian - 1 2 4 5 ♭7</option>
                                    <option value="hungarian">Hungarian - 1 ♯2 ♭3 ♯4 5 ♭6 7</option>
                                    <option value="persian">Persian - 1 ♭2 3 4 ♭5 ♭6 7</option>
                                    <option value="byzantine">Byzantine - 1 ♭2 3 4 5 ♭6 7</option>
                                    <option value="enigmatic">Enigmatic - 1 ♭2 3 ♯4 ♯5 ♯6 7</option>
                                    <option value="neapolitan">Neapolitan - 1 ♭2 ♭3 4 5 ♭6 7</option>
                                    <option value="spanish">Spanish - 1 ♭2 3 4 5 ♭6 ♭7</option>
                                </optgroup>
                                
                                <option value="random" selected>随机调式</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            方向
                            <span class="info">选择音阶方向</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-order-btn active" data-value="ordered">上行</div>
                            <div class="order-btn scale-order-btn" data-value="reverse">下行</div>
                            <div class="order-btn scale-order-btn" data-value="random">随机</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            练习序列
                            <span class="info">选择练习序列模式</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-arpeggio-btn active" data-value="1to1">1→1</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="3to3" id="arpeggio-3-btn">3→3</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="5to5" id="arpeggio-5-btn">5→5</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="7to7" id="arpeggio-7-btn">7→7</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="random-arpeggio">随机</div>
                        </div>
                    </div>

                    <script>
                    // 直接在页面中定义scaleTypes对象，避免模块导入问题
                    window.scaleTypes = {
                        // 大调系列
                        'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'minor': { name: 'Minor', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                        
                        // 教会调式 (Church Modes)
                        'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'dorian': { name: 'Dorian - 1 2 ♭3 4 5 6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '6', '♭7'] },
                        'phrygian': { name: 'Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '♭7'] },
                        'lydian': { name: 'Lydian - 1 2 3 ♯4 5 6 7', intervals: ['1', '2', '3', '♯4', '5', '6', '7'] },
                        'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 ♭7', intervals: ['1', '2', '3', '4', '5', '6', '♭7'] },
                        'aeolian': { name: 'Aeolian - 1 2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                        'locrian': { name: 'Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '♭5', '♭6', '♭7'] },
                        
                        // 和声小调系列
                        'harmonicMinor': { name: 'Harmonic Minor - 1 2 ♭3 4 5 ♭6 7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '7'] },
                        'dorianSharp2': { name: 'Dorian ♯2 - 1 ♯2 ♭3 4 5 6 ♭7', intervals: ['1', '♯2', '♭3', '4', '5', '6', '♭7'] },
                        'phrygianMajor': { name: 'Phrygian Major - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                        'lydianSharp2': { name: 'Lydian ♯2 - 1 ♯2 3 ♯4 5 6 7', intervals: ['1', '♯2', '3', '♯4', '5', '6', '7'] },
                        'mixolydianFlat6': { name: 'Mixolydian ♭6 - 1 2 3 4 5 ♭6 ♭7', intervals: ['1', '2', '3', '4', '5', '♭6', '♭7'] },
                        'lydianFlat2': { name: 'Lydian ♭2 - 1 ♭2 3 ♯4 5 6 7', intervals: ['1', '♭2', '3', '♯4', '5', '6', '7'] },
                        'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 ♭2 ♭3 ♭4 ♭5 ♭6 6', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '6'] },
                        
                        // 旋律小调系列
                        'melodicMinor': { name: 'Melodic Minor - 1 2 ♭3 4 5 6 7', intervals: ['1', '2', '♭3', '4', '5', '6', '7'] },
                        'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 ♭7 ♭6 5 4 ♭3 2 1', intervals: ['1', '♭7', '♭6', '5', '4', '♭3', '2', '1'] },
                        'dorianFlat2': { name: 'Dorian ♭2 - 1 ♭2 ♭3 4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '6', '♭7'] },
                        'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 ♯4 ♯5 6 7', intervals: ['1', '2', '3', '♯4', '♯5', '6', '7'] },
                        'lydianFlat7': { name: 'Lydian ♭7 - 1 2 3 ♯4 5 6 ♭7', intervals: ['1', '2', '3', '♯4', '5', '6', '♭7'] },
                        'aeolianFlat5': { name: 'Aeolian ♭5 - 1 2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '♭5', '♭6', '♭7'] },
                        'superLocrian': { name: 'Super Locrian - 1 ♭2 ♭3 ♭4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '♭7'] },
                        
                        // 五声音阶系列
                        'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                        'minorPentatonic': { name: 'Minor Pentatonic - 1 ♭3 4 5 ♭7', intervals: ['1', '♭3', '4', '5', '♭7'] },
                        'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 ♭3 5 6', intervals: ['1', '2', '♭3', '5', '6'] },
                        'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                        'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 ♭7', intervals: ['1', '2', '3', '5', '♭7'] },
                        
                        // 布鲁斯音阶系列
                        'blues': { name: 'Blues - 1 ♭3 4 ♯4 5 ♭7', intervals: ['1', '♭3', '4', '♯4', '5', '♭7'] },
                        'majorBlues': { name: 'Major Blues - 1 2 ♭3 3 5 6', intervals: ['1', '2', '♭3', '3', '5', '6'] },
                        
                        // 其他常见音阶
                        'wholeTone': { name: 'Whole Tone - 1 2 3 ♯4 ♯5 ♯6', intervals: ['1', '2', '3', '♯4', '♯5', '♯6'] },
                        'diminished': { name: 'Diminished (Half-Whole) - 1 ♭2 ♭3 3 ♯4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '3', '♯4', '5', '6', '♭7'] },
                        'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 ♭3 4 ♯4 ♯5 6 7', intervals: ['1', '2', '♭3', '4', '♯4', '♯5', '6', '7'] },
                        'chromatic': { name: 'Chromatic - 1 ♭2 2 ♭3 3 4 ♯4 5 ♭6 6 ♭7 7', intervals: ['1', '♭2', '2', '♭3', '3', '4', '♯4', '5', '♭6', '6', '♭7', '7'] },
                        
                        // 异国风格音阶
                        'arabic': { name: 'Arabic - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                        'gypsy': { name: 'Gypsy - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                        'japanese': { name: 'Japanese - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                        'egyptian': { name: 'Egyptian - 1 2 4 5 ♭7', intervals: ['1', '2', '4', '5', '♭7'] },
                        'hungarian': { name: 'Hungarian - 1 ♯2 ♭3 ♯4 5 ♭6 7', intervals: ['1', '♯2', '♭3', '♯4', '5', '♭6', '7'] },
                        'persian': { name: 'Persian - 1 ♭2 3 4 ♭5 ♭6 7', intervals: ['1', '♭2', '3', '4', '♭5', '♭6', '7'] },
                        'byzantine': { name: 'Byzantine - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                        'enigmatic': { name: 'Enigmatic - 1 ♭2 3 ♯4 ♯5 ♯6 7', intervals: ['1', '♭2', '3', '♯4', '♯5', '♯6', '7'] },
                        'neapolitan': { name: 'Neapolitan - 1 ♭2 ♭3 4 5 ♭6 7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '7'] },
                        'spanish': { name: 'Spanish - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] }
                    };
                    </script>
                    
                    <script>
                    // 调试：确认DOM元素
                    console.log('开始设置音阶类型监听器');
                    
                    // 立即测试window.scaleTypes是否可用
                    console.log('window.scaleTypes对象存在:', window.scaleTypes !== undefined);
                    if (window.scaleTypes) {
                        console.log('Phrygian Major调式存在:', window.scaleTypes['phrygianMajor'] !== undefined);
                        if (window.scaleTypes['phrygianMajor']) {
                            console.log('Phrygian Major音程:', window.scaleTypes['phrygianMajor'].intervals);
                        }
                    }
                    
                    // 重新绑定事件监听器
                    const scaleTypeElement = document.getElementById('scaleType');
                    console.log('scaleType元素:', scaleTypeElement);
                    
                    if (scaleTypeElement) {
                        // 移除可能存在的旧监听器
                        scaleTypeElement.removeEventListener('change', updateArpeggioButtons);
                        // 添加新的监听器
                        scaleTypeElement.addEventListener('change', updateArpeggioButtons);
                        console.log('音阶类型变化监听器已绑定');
                    }
                    
                    // 初始加载时更新按钮文本和状态
                    function updateArpeggioButtons() {
                        console.log('updateArpeggioButtons函数被调用');
                        
                        const scaleType = document.getElementById('scaleType').value;
                        console.log('当前选择的调式:', scaleType);
                        
                        // 获取音阶类型对应的音程数组
                        let intervals = [];
                        if (window.scaleTypes && window.scaleTypes[scaleType] && window.scaleTypes[scaleType].intervals) {
                            intervals = window.scaleTypes[scaleType].intervals;
                            console.log('获取到的音程数组:', intervals);
                        } else {
                            // 如果没有找到scaleTypes对象或对应的音阶，使用默认的大调音阶
                            intervals = ['1', '2', '3', '4', '5', '6', '7'];
                            console.log('使用默认大调音阶:', intervals);
                        }
                        
                        // 获取3音、5音、7音的音程（优先查找实际存在的变音记号版本，如果没有则查找最近的音程）
                        const thirdInterval = findNearestIntervalInScale(intervals, '3');
                        const fifthInterval = findNearestIntervalInScale(intervals, '5');
                        const seventhInterval = findNearestIntervalInScale(intervals, '7');
                        
                        console.log('计算得到的音程:', {thirdInterval, fifthInterval, seventhInterval});
                        
                        // 更新预定义按钮文本和确保按钮可点击
                        const arpeggio3Btn = document.getElementById('arpeggio-3-btn');
                        const arpeggio5Btn = document.getElementById('arpeggio-5-btn');
                        const arpeggio7Btn = document.getElementById('arpeggio-7-btn');
                        const randomArpeggioBtn = document.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');
                        
                        console.log('找到的按钮元素:', {
                            arpeggio3Btn: arpeggio3Btn !== null,
                            arpeggio5Btn: arpeggio5Btn !== null,
                            arpeggio7Btn: arpeggio7Btn !== null,
                            randomArpeggioBtn: randomArpeggioBtn !== null
                        });
                        
                        if (arpeggio3Btn) {
                            console.log('更新3音按钮前:', arpeggio3Btn.textContent, 'data-value:', arpeggio3Btn.getAttribute('data-value'));
                            arpeggio3Btn.textContent = `${thirdInterval}→${thirdInterval}`;
                            arpeggio3Btn.setAttribute('data-value', `${thirdInterval}to${thirdInterval}`);
                            arpeggio3Btn.style.pointerEvents = 'auto';
                            arpeggio3Btn.style.opacity = '1';
                            console.log('更新3音按钮后:', arpeggio3Btn.textContent, 'data-value:', arpeggio3Btn.getAttribute('data-value'));
                        }
                        
                        if (arpeggio5Btn) {
                            console.log('更新5音按钮前:', arpeggio5Btn.textContent, 'data-value:', arpeggio5Btn.getAttribute('data-value'));
                            arpeggio5Btn.textContent = `${fifthInterval}→${fifthInterval}`;
                            arpeggio5Btn.setAttribute('data-value', `${fifthInterval}to${fifthInterval}`);
                            arpeggio5Btn.style.pointerEvents = 'auto';
                            arpeggio5Btn.style.opacity = '1';
                            console.log('更新5音按钮后:', arpeggio5Btn.textContent, 'data-value:', arpeggio5Btn.getAttribute('data-value'));
                        }
                        
                        if (arpeggio7Btn) {
                            console.log('更新7音按钮前:', arpeggio7Btn.textContent, 'data-value:', arpeggio7Btn.getAttribute('data-value'));
                            arpeggio7Btn.textContent = `${seventhInterval}→${seventhInterval}`;
                            arpeggio7Btn.setAttribute('data-value', `${seventhInterval}to${seventhInterval}`);
                            arpeggio7Btn.style.pointerEvents = 'auto';
                            arpeggio7Btn.style.opacity = '1';
                            console.log('更新7音按钮后:', arpeggio7Btn.textContent, 'data-value:', arpeggio7Btn.getAttribute('data-value'));
                        }
                        
                        if (randomArpeggioBtn) {
                            randomArpeggioBtn.style.pointerEvents = 'auto';
                            randomArpeggioBtn.style.opacity = '1';
                        }
                        
                        // 动态创建额外的按钮来显示音阶中其他可用的音程
                        const container = document.querySelector('.order-btn-container'); // 练习序列按钮容器
                        if (container) {
                            // 查找现有的动态按钮并移除
                            const existingDynamicButtons = container.querySelectorAll('.scale-arpeggio-btn.dynamic');
                            existingDynamicButtons.forEach(btn => btn.remove());
                            
                            // 只在音阶练习模式下创建动态按钮，和弦练习模式下不创建
                            const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                            if (activeTab === 'scale') {
                                // 为音阶中每个独特的音程创建按钮（除了1、3、5、7，因为它们已经有预定义按钮了）
                                const uniqueIntervals = [...new Set(intervals)];
                                const predefinedIntervals = ['1', '3', '5', '7'];
                                
                                uniqueIntervals.forEach(interval => {
                                    // 提取数字部分
                                    const intervalNumber = interval.replace(/[^0-9]/g, '');
                                    
                                    // 跳过预定义的音程
                                    if (predefinedIntervals.includes(intervalNumber)) {
                                        return;
                                    }
                                    
                                    // 创建按钮
                                    const btn = document.createElement('div');
                                    btn.className = 'order-btn scale-arpeggio-btn dynamic';
                                    btn.setAttribute('data-value', `${interval}to${interval}`);
                                    btn.textContent = `${interval}→${interval}`;
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.opacity = '1';
                                    
                                    // 添加点击事件
                                    btn.addEventListener('click', function() {
                                        // 移除其他按钮的active状态
                                        const allButtons = container.querySelectorAll('.scale-arpeggio-btn');
                                        allButtons.forEach(b => b.classList.remove('active'));
                                        // 添加当前按钮的active状态
                                        this.classList.add('active');
                                    });
                                    
                                    // 将按钮添加到容器中，放在随机按钮之前
                                    const randomBtn = container.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');
                                    if (randomBtn) {
                                        container.insertBefore(btn, randomBtn);
                                    } else {
                                        container.appendChild(btn);
                                    }
                                });
                            }
                        }
                    }
                    
                    // 页面加载完成后立即调用一次，确保初始化显示正确
                    document.addEventListener('DOMContentLoaded', function() {
                        console.log('DOMContentLoaded事件触发，调用updateArpeggioButtons');
                        updateArpeggioButtons();
                    });
                    
                    // 为了测试，添加一个全局函数可以手动调用
                    window.testUpdateArpeggio = function() {
                        console.log('手动调用测试函数');
                        updateArpeggioButtons();
                    };
                    
                    // 查找指定度数的音程（优先查找包含该度数的音程，如3度优先找b3、3、#3）
                    function getScaleDegreeByPosition(intervals, degree) {
                        // 将度数转换为字符串形式
                        const degreeStr = degree.toString();
                        
                        // 优先查找包含该度数的音程（如3度优先找b3、3、#3等）
                        for (let i = 0; i < intervals.length; i++) {
                            // 检查音程是否以b+度数、#/♯+度数或度数开头
                            if (intervals[i].includes(degreeStr)) {
                                return intervals[i];
                            }
                        }
                        
                        // 如果没有找到包含该度数的音程，则回退到按位置查找
                        const validDegree = (degree - 1) % intervals.length;
                        return intervals[validDegree];
                    }
                    
                    // 查找音阶中第一个出现的指定音程（如'3', '♭3', '♯3'等）
                    function findFirstIntervalOfType(intervals, degree) {
                        // 特殊处理：对于blues音阶等特殊音阶，优先检查是否有对应度数的变音记号版本
                        // 例如，对于blues音阶，3度可能是♭3，4度可能是♭4，7度可能是♭7
                        if (degree === '3') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === '♭3') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '4') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === '♭4') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '7') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === '♭7') {
                                    return intervals[i];
                                }
                            }
                        }
                        
                        // 检查音阶中是否包含该度数的任何变体
                        // 例如，对于3度，查找b3、3、#3等
                        for (let i = 0; i < intervals.length; i++) {
                            // 提取数字部分（移除变音记号）
                            const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                            if (intervalNumber === degree) {
                                return intervals[i];
                            }
                        }
                        
                        // 如果没找到该度数的音程，返回null
                        return null;
                    }
                    
                    // 当音阶中缺少特定音程时，查找音阶中实际存在的最近音程
                    function findNearestIntervalInScale(intervals, degree) {
                        // 首先尝试查找指定度数的音程
                        const foundInterval = findFirstIntervalOfType(intervals, degree);
                        if (foundInterval) {
                            return foundInterval;
                        }
                        
                        // 如果没找到，根据音程类型选择最近的替代音程
                        switch (degree) {
                            case '3':
                                // 3音缺失时，查找4音（优先）或2音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '2') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '5':
                                // 5音缺失时，查找4音或6音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '6':
                                // 6音缺失时，查找7音（优先）或5音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '7') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '5') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '7':
                                // 7音缺失时，查找6音（优先）或1音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                // 查找根音
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '1') {
                                        return intervals[i];
                                    }
                                }
                                break;
                        }
                        
                        // 如果还是没找到，返回音阶中的第一个音程作为默认值
                        return intervals.length > 0 ? intervals[0] : '1';
                    }
                    
                    // 查找音阶中指定音程的完整形式（包括变音记号）
                    function findCompleteIntervalInScale(intervals, interval) {
                        // 直接查找完全匹配的音程（包括变音记号）
                        for (let i = 0; i < intervals.length; i++) {
                            if (intervals[i] === interval) {
                                return intervals[i];
                            }
                        }
                        
                        // 如果没有找到完全匹配的，尝试查找数字部分匹配的
                        const intervalNumber = interval.replace(/[^0-9]/g, '');
                        for (let i = 0; i < intervals.length; i++) {
                            const currentIntervalNumber = intervals[i].replace(/[^0-9]/g, '');
                            if (currentIntervalNumber === intervalNumber) {
                                return intervals[i];
                            }
                        }
                        
                        // 如果还是没找到，返回null
                        return null;
                    }
                    
                    // 页面加载完成后更新按钮文本
                    document.addEventListener('DOMContentLoaded', function() {
                        updateArpeggioButtons();
                    });
                    </script>
                </div>

                <!-- 和弦设置 -->
                <div class="settings-section chord-settings" style="display: none;">
                    <div class="settings-section-title">
                        <i>🎶</i> 和弦设置
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            根音
                            <span class="info">选择和弦的根音</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C">C</option>
                                <option value="C♯">C♯</option>
                                <option value="D♭">D♭</option>
                                <option value="D">D</option>
                                <option value="D♯">D♯</option>
                                <option value="E♭">E♭</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="F♯">F♯</option>
                                <option value="G♭">G♭</option>
                                <option value="G">G</option>
                                <option value="G♯">G♯</option>
                                <option value="A♭">A♭</option>
                                <option value="A">A</option>
                                <option value="A♯">A♯</option>
                                <option value="B♭">B♭</option>
                                <option value="B">B</option>
                                <option value="random" selected>随机根音</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            和弦类型
                            <span class="info">选择要练习的和弦类型</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">dim</div>
                            <div class="chord-type-btn" data-value="augmented">aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7♭5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7♯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7♭9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7♯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>
                        <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                            点击选择要练习的和弦类型（可多选）
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            顺序
                            <span class="info">选择和弦音符的演奏顺序</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered">上行</div>
                            <div class="order-btn chord-order-btn" data-value="reverse">下行</div>
                            <div class="order-btn chord-order-btn" data-value="random">随机</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" id="startBtn">开始练习</button>
        </div>
    </div>

    <!-- 底部导航栏 -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="scale">
            <div class="nav-icon">🎵</div>
            <div class="nav-label">音阶练习</div>
        </div>
        <div class="nav-item" data-tab="chord">
            <div class="nav-icon">🎶</div>
            <div class="nav-label">和弦练习</div>
        </div>
        <div class="nav-item" data-tab="progression">
            <div class="nav-icon">🔄</div>
            <div class="nav-label">和弦转换</div>
        </div>
        <div class="nav-item" data-tab="device">
            <div class="nav-icon">⚙️</div>
            <div class="nav-label">设置</div>
        </div>
    </div>

    <!-- 练习模式全屏页面 -->
    <div id="practiceScreen">
        <!-- 乐曲名显示区域 -->
        <div class="song-title-display" id="songTitleDisplay" style="display: none;">
            <div class="song-title" id="songTitle"></div>
        </div>
        
        <div class="exercise-container">
            <div class="scale-info">
                <div class="target-interval" id="targetInterval">C Major</div>
            </div>

            <div class="sequence-display">

                <div class="sequence-items" id="sequenceDisplay"></div>
            </div>
        </div>

        <div class="next-exercise">
            <div class="next-content-wrapper">
                <div class="next-label">下一个:</div>
                <div class="next-content" id="nextExercise">-</div>
            </div>
        </div>
    </div>

    <script>
        // PitchFinder库内联代码 - 直接嵌入增强版YIN算法实现
        (function (global) {
            // PitchFinder主对象
            var Pitchfinder = {};

            // 增强版YIN算法实现
            Pitchfinder.YIN = function (config) {
                config = config || {};
                var threshold = config.threshold || 0.15;
                var probabilityCliff = config.probabilityCliff || 0.1;

                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);

                    // 步骤1: 差分函数
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }

                    // 步骤2: 累积平均归一化
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }

                    // 步骤3: 阈值检测
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }

                    if (tauEstimate === -1) return null;

                    // 步骤4: 抛物线插值提高精度
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }

                    const frequency = 48000 / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));

                    if (probability < probabilityCliff) return null;

                    return { frequency, probability };
                };
            };

            // 将PitchFinder暴露给全局
            global.Pitchfinder = Pitchfinder;
        })(window);

        document.addEventListener('DOMContentLoaded', function () {
            // 吉他标准调弦
            const standardTuning = ['E', 'B', 'G', 'D', 'A', 'E'];

            // 所有可能的音级
            const intervals = ['1', '♭2', '2', '♭3', '3', '4', '♯4', '5', '♭6', '6', '♭7', '7'];

            // 音级到半音距离的映射
            const intervalToSemitones = {
                '1': 0,
                '♭2': 1,
                '2': 2,
                '♭3': 3,
                '3': 4,
                '♭4': 4,
                '4': 5,
                '♯4': 6,
                '♭5': 6,
                '5': 7,
                '♭6': 8,
                '6': 9,
                '♭7': 10,
                '7': 11
            };

            // 音名到半音数的映射（C = 0）
            const noteToSemitones = {
                'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4,
                'F': 5, 'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8,
                'A': 9, 'A♯': 10, 'B♭': 10, 'B': 11
            };

            // 音阶类型定义
            const scaleTypes = {
                // 基本调式
                'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'minor': { name: 'Minor', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                
                // 教会调式 (Church Modes)
                'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'dorian': { name: 'Dorian - 1 2 ♭3 4 5 6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '6', '♭7'] },
                'phrygian': { name: 'Phrygian - 1 ♭2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '♭7'] },
                'lydian': { name: 'Lydian - 1 2 3 ♯4 5 6 7', intervals: ['1', '2', '3', '♯4', '5', '6', '7'] },
                'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 ♭7', intervals: ['1', '2', '3', '4', '5', '6', '♭7'] },
                'aeolian': { name: 'Aeolian - 1 2 ♭3 4 5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '♭7'] },
                'locrian': { name: 'Locrian - 1 ♭2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '4', '♭5', '♭6', '♭7'] },
                
                // 和声小调系列
                'harmonicMinor': { name: 'Harmonic Minor - 1 2 ♭3 4 5 ♭6 7', intervals: ['1', '2', '♭3', '4', '5', '♭6', '7'] },
                'dorianSharp2': { name: 'Dorian ♯2 - 1 ♯2 ♭3 4 5 6 ♭7', intervals: ['1', '♯2', '♭3', '4', '5', '6', '♭7'] },
                'phrygianMajor': { name: 'Phrygian Major - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                'lydianSharp2': { name: 'Lydian ♯2 - 1 ♯2 3 ♯4 5 6 7', intervals: ['1', '♯2', '3', '♯4', '5', '6', '7'] },
                'mixolydianFlat6': { name: 'Mixolydian ♭6 - 1 2 3 4 5 ♭6 ♭7', intervals: ['1', '2', '3', '4', '5', '♭6', '♭7'] },
                'lydianFlat2': { name: 'Lydian ♭2 - 1 ♭2 3 ♯4 5 6 7', intervals: ['1', '♭2', '3', '♯4', '5', '6', '7'] },
                'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 ♭2 ♭3 ♭4 ♭5 ♭6 6', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '6'] },
                
                // 旋律小调系列
                'melodicMinor': { name: 'Melodic Minor - 1 2 ♭3 4 5 6 7', intervals: ['1', '2', '♭3', '4', '5', '6', '7'] },
                'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 ♭7 ♭6 5 4 ♭3 2 1', intervals: ['1', '♭7', '♭6', '5', '4', '♭3', '2', '1'] },
                'dorianFlat2': { name: 'Dorian ♭2 - 1 ♭2 ♭3 4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '4', '5', '6', '♭7'] },
                'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 ♯4 ♯5 6 7', intervals: ['1', '2', '3', '♯4', '♯5', '6', '7'] },
                'lydianFlat7': { name: 'Lydian ♭7 - 1 2 3 ♯4 5 6 ♭7', intervals: ['1', '2', '3', '♯4', '5', '6', '♭7'] },
                'aeolianFlat5': { name: 'Aeolian ♭5 - 1 2 ♭3 4 ♭5 ♭6 ♭7', intervals: ['1', '2', '♭3', '4', '♭5', '♭6', '♭7'] },
                'superLocrian': { name: 'Super Locrian - 1 ♭2 ♭3 ♭4 ♭5 ♭6 ♭7', intervals: ['1', '♭2', '♭3', '♭4', '♭5', '♭6', '♭7'] },
                
                // 五声音阶系列
                'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                'minorPentatonic': { name: 'Minor Pentatonic - 1 ♭3 4 5 ♭7', intervals: ['1', '♭3', '4', '5', '♭7'] },
                'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 ♭3 5 6', intervals: ['1', '2', '♭3', '5', '6'] },
                'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 ♭7', intervals: ['1', '2', '3', '5', '♭7'] },
                
                // 布鲁斯音阶系列
                'blues': { name: 'Blues - 1 ♭3 4 ♯4 5 ♭7', intervals: ['1', '♭3', '4', '♯4', '5', '♭7'] },
                'majorBlues': { name: 'Major Blues - 1 2 ♭3 3 5 6', intervals: ['1', '2', '♭3', '3', '5', '6'] },
                
                // 其他常见音阶
                'wholeTone': { name: 'Whole Tone - 1 2 3 ♯4 ♯5 ♯6', intervals: ['1', '2', '3', '♯4', '♯5', '♯6'] },
                'diminished': { name: 'Diminished (Half-Whole) - 1 ♭2 ♭3 3 ♯4 5 6 ♭7', intervals: ['1', '♭2', '♭3', '3', '♯4', '5', '6', '♭7'] },
                'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 ♭3 4 ♯4 ♯5 6 7', intervals: ['1', '2', '♭3', '4', '♯4', '♯5', '6', '7'] },
                'chromatic': { name: 'Chromatic - 1 ♭2 2 ♭3 3 4 ♯4 5 ♭6 6 ♭7 7', intervals: ['1', '♭2', '2', '♭3', '3', '4', '♯4', '5', '♭6', '6', '♭7', '7'] },
                
                // 异国风格音阶
                'arabic': { name: 'Arabic - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] },
                'gypsy': { name: 'Gypsy - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                'japanese': { name: 'Japanese - 1 ♭2 4 5 ♭6', intervals: ['1', '♭2', '4', '5', '♭6'] },
                'egyptian': { name: 'Egyptian - 1 2 4 5 ♭7', intervals: ['1', '2', '4', '5', '♭7'] },
                'hungarian': { name: 'Hungarian - 1 ♯2 ♭3 ♯4 5 ♭6 7', intervals: ['1', '♯2', '♭3', '♯4', '5', '♭6', '7'] },
                'persian': { name: 'Persian - 1 ♭2 3 4 ♭5 ♭6 7', intervals: ['1', '♭2', '3', '4', '♭5', '♭6', '7'] },
                'byzantine': { name: 'Byzantine - 1 ♭2 3 4 5 ♭6 7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '7'] },
                'enigmatic': { name: 'Enigmatic - 1 ♭2 3 ♯4 ♯5 ♯6 7', intervals: ['1', '♭2', '3', '♯4', '♯5', '♯6', '7'] },
                'neapolitan': { name: 'Neapolitan - 1 ♭2 ♭3 4 5 ♭6 7', intervals: ['1', '♭2', '♭3', '4', '5', '♭6', '7'] },
                'spanish': { name: 'Spanish - 1 ♭2 3 4 5 ♭6 ♭7', intervals: ['1', '♭2', '3', '4', '5', '♭6', '♭7'] }
            };

            // 和弦类型定义
            const chordTypes = {
                // 基础三和弦
                'major': { name: '大三和弦', intervals: ['1', '3', '5'] },
                'minor': { name: '小三和弦', intervals: ['1', '♭3', '5'] },
                'diminished': { name: '减三和弦', intervals: ['1', '♭3', '♭5'] },
                'augmented': { name: '增三和弦', intervals: ['1', '3', '♯5'] },
                
                // 六和弦
                'major6': { name: '大六和弦', intervals: ['1', '3', '5', '6'] },
                'minor6': { name: '小六和弦', intervals: ['1', '♭3', '5', '6'] },
                
                // 七和弦
                'dominant7': { name: '属七和弦', intervals: ['1', '3', '5', '♭7'] },
                'major7': { name: '大七和弦', intervals: ['1', '3', '5', '7'] },
                'minor7': { name: '小七和弦', intervals: ['1', '♭3', '5', '♭7'] },
                'minor7b5': { name: '半减七和弦', intervals: ['1', '♭3', '♭5', '♭7'] },
                'diminished7': { name: '减七和弦', intervals: ['1', '♭3', '♭5', '6'] },
                
                // 九和弦
                'dominant9': { name: '属九和弦', intervals: ['1', '3', '5', '♭7', '2'] },
                'major9': { name: '大九和弦', intervals: ['1', '3', '5', '7', '2'] },
                'minor9': { name: '小九和弦', intervals: ['1', '♭3', '5', '♭7', '2'] },
                'dominant7sharp9': { name: '属7♯9和弦', intervals: ['1', '3', '5', '♭7', '♯2'] },
                'dominant7flat9': { name: '属7♭9和弦', intervals: ['1', '3', '5', '♭7', '♭2'] },
                
                // 十一和弦
                'dominant11': { name: '属11和弦', intervals: ['1', '3', '5', '♭7', '2', '4'] },
                'minor11': { name: '小11和弦', intervals: ['1', '♭3', '5', '♭7', '2', '4'] },
                'dominant7sharp11': { name: '属7♯11和弦', intervals: ['1', '3', '5', '♭7', '♯4'] },
                
                // 十三和弦
                'dominant13': { name: '属13和弦', intervals: ['1', '3', '5', '♭7', '2', '6'] },
                'minor13': { name: '小13和弦', intervals: ['1', '♭3', '5', '♭7', '2', '6'] },
                
                // 挂留和弦
                'sus2': { name: '挂二和弦', intervals: ['1', '2', '5'] },
                'sus4': { name: '挂四和弦', intervals: ['1', '4', '5'] },
                
                // 加音和弦
                'add9': { name: '加九和弦', intervals: ['1', '3', '5', '2'] },
                'madd9': { name: '小加九和弦', intervals: ['1', '♭3', '5', '2'] },
                '6add9': { name: '六加九和弦', intervals: ['1', '3', '5', '6', '2'] },
                'm6add9': { name: '小六加九和弦', intervals: ['1', '♭3', '5', '6', '2'] }
            };

            // 经典爵士乐歌曲和弦进行（基于音级储存）
            const jazzStandards = {
                '5': {
                    '500 Miles High': {
                        key: 'E♭',
                        chords: ['IM7', 'V7sus4', 'IM7', 'V7sus4', 'IVM7', 'IVM7', 'IM7', 'IM7']
                    }
                },
                'A': {
                    'All The Things You Are': {
                        key: 'C',
                        chords: ['VIIm7♭5', 'III7', 'VIm7', 'II7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Autumn Leaves': {
                        key: 'G',
                        chords: ['IVm7', 'bVII7', 'bIIIM7', 'bVIM7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    },
                    'All Of Me': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'IVM7', 'IIIm7♭5', 'VI7']
                    },
                    'A Night In Tunisia': {
                        key: 'D',
                        chords: ['IIm7♭5', 'V7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'Im7', 'bIIM7']
                    },
                    'All of You': {
                        key: 'C',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Alone Together': {
                        key: 'G',
                        chords: ['IIm7♭5', 'V7', 'Im7', 'bVI7', 'bIIM7', 'IIm7♭5', 'V7', 'Im7']
                    },
                    'Ambleside': {
                        key: 'C',
                        chords: ['IM7', 'V7sus4', 'IM7', 'IVM7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Anthropology': {
                        key: 'B♭',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Ask Me Now': {
                        key: 'F',
                        chords: ['IM7', 'bII7', 'IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'IM7']
                    }
                },
                'B': {
                    'Blue Moon': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Body And Soul': {
                        key: 'D♭',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'bVIIM7', 'Vm7', 'II7', 'V7']
                    },
                    'Bye Bye Blackbird': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'II7', 'VIIm7', 'III7', 'VIm7', 'IIm7']
                    },
                    'Beautiful Love': {
                        key: 'G',
                        chords: ['IIm7♭5', 'V7', 'Im7', 'Im7', 'IVm7', 'bVII7', 'bIIIM7', 'bIIIM7']
                    },
                    'Blue Bossa': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'bVIIM7', 'bVIIM7']
                    },
                    'Blue in Green': {
                        key: 'C',
                        chords: ['IM7', 'bVII7', 'bIIIM7', 'bVIM7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    },
                    'Blues for Alice': {
                        key: 'F',
                        chords: ['I7', 'VI7', 'II7', 'V7', 'III7', 'VI7', 'II7', 'V7']
                    }
                },
                'C': {
                    'Cherokee': {
                        key: 'B♭',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Come Rain Or Come Shine': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Confirmation': {
                        key: 'F',
                        chords: ['IM7', 'bVII7', 'IIIm7♭5', 'VI7', 'IIm7', 'V7', 'IIIm7♭5', 'VI7']
                    },
                    'Coral': {
                        key: 'G',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Corcovado': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7']
                    },
                    'Countdown': {
                        key: 'E♭',
                        chords: ['IM7', 'bIII7', 'bVIM7', 'bII7', 'VM7', 'I7', 'IVM7', 'bVII7']
                    }
                },
                'D': {
                    'Days Of Wine And Roses': {
                        key: 'F',
                        chords: ['IM7', 'IV7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Donna Lee': {
                        key: 'A♭',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Doxy': {
                        key: 'B♭',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7']
                    },
                    'Dream A Little Dream': {
                        key: 'C',
                        chords: ['IM7', 'bIIIdim7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'F': {
                    'Fall': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    },
                    'Falling Grace': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Fly Me To The Moon': {
                        key: 'C',
                        chords: ['VIm7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7']
                    },
                    'Four': {
                        key: 'E♭',
                        chords: ['IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Footprints': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IVm7', 'IVm7', 'Im7', 'Im7']
                    }
                },
                'G': {
                    'Giant Steps': {
                        key: 'B',
                        chords: ['IM7', 'bIII7', 'bVIM7', 'bI7', 'bIVM7', 'bVIIm7', 'bIII7', 'bVIM7']
                    },
                    'Georgia On My Mind': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Girl From Ipanema': {
                        key: 'F',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'IIIm7♭5', 'VI7', 'IIm7', 'IIm7']
                    }
                },
                'H': {
                    'Have You Met Miss Jones': {
                        key: 'B♭',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Here\'s That Rainy Day': {
                        key: 'G',
                        chords: ['bI7', 'IVm7', 'bVII7', 'bIIIM7', 'bVIM7', 'IIm7♭5', 'V7', 'Im7']
                    },
                    'How High The Moon': {
                        key: 'G',
                        chords: ['IM7', 'Im7', 'IV7', 'bVIIM7', 'bVIIM7', 'IIIm7♭5', 'VI7', 'IIm7']
                    }
                },
                'I': {
                    'I Got Rhythm': {
                        key: 'B♭',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'I Can\'t Get Started': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'VI7', 'IIm7', 'V7']
                    },
                    'In A Sentimental Mood': {
                        key: 'D',
                        chords: ['Im7', 'IV7', 'IIm7♭5', 'V7', 'Im7', 'IV7', 'bVIIM7', 'bVIIM7']
                    },
                    'Infant Eyes': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7']
                    },
                    'Inner Urge': {
                        key: 'A♭',
                        chords: ['IM7', 'bII7', 'IM7', 'bII7', 'IVM7', 'bV7', 'IM7', 'IM7']
                    }
                },
                'J': {
                    'Just Friends': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIM7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Joy Spring': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Jordu': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'bVIIM7', 'bIIIM7', 'VIm7♭5', 'II7', 'Vm7', 'IIm7']
                    }
                },
                'L': {
                    'Lady Bird': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IVm7♭5', 'bVII7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Love For Sale': {
                        key: 'G',
                        chords: ['Im7', 'IV7', 'Im7', 'IV7', 'bVIIM7', 'Vm7', 'Im7', 'IV7']
                    },
                    'Lover Man': {
                        key: 'A♭',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    }
                },
                'M': {
                    'Misty': {
                        key: 'E♭',
                        chords: ['IM7', 'Vm7', 'I7', 'IVM7', 'IVm7', 'bVII7', 'IM7', 'VIm7']
                    },
                    'My Funny Valentine': {
                        key: 'C',
                        chords: ['Im7', 'IV7', 'bVIIM7', 'bIIIM7', 'VIm7♭5', 'II7', 'Vm7', 'I7']
                    },
                    'Maiden Voyage': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IIm7', 'V7', 'bIIIm7', 'bVI7', 'bIIM7', 'bIIM7']
                    }
                },
                'N': {
                    'Night And Day': {
                        key: 'C',
                        chords: ['IM7', 'IIm7', 'IIIm7', 'IIm7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Nardis': {
                        key: 'E',
                        chords: ['Im7', 'bIIM7', 'Im7', 'bIIM7', 'Im7', 'bIIM7', 'Im7', 'Im7']
                    },
                    'Night Train': {
                        key: 'G',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'V7']
                    }
                },
                'O': {
                    'Oleo': {
                        key: 'B♭',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'S': {
                    'Someday My Prince Will Come': {
                        key: 'B♭',
                        chords: ['IM7', 'IV7', 'VIIm7♭5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Spain': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7', 'VIm7']
                    },
                    'Stella By Starlight': {
                        key: 'D',
                        chords: ['IIm7♭5', 'V7', 'Im7', 'bVI7', 'bIIIM7', 'IIm7♭5', 'V7', 'Im7']
                    },
                    'Summertime': {
                        key: 'A',
                        chords: ['Im7', 'V7', 'Im7', 'V7', 'IVm7', 'bVII7', 'bIIIM7', 'bVIM7']
                    },
                    'Solar': {
                        key: 'C',
                        chords: ['Im7', 'IV7', 'bVIIM7', 'bIIIM7', 'VIm7♭5', 'II7', 'Vm7', 'I7']
                    }
                },
                'T': {
                    'Take Five': {
                        key: 'E♭m',
                        chords: ['Im7', 'IV7', 'bVIIM7', 'bIIIM7', 'IIm7', 'V7', 'Im7', 'Im7']
                    },
                    'Take the A-Train': {
                        key: 'C',
                        chords: ['IM7', 'IVM7', 'VIIm7♭5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'The Girl From Ipanema': {
                        key: 'F',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'IIIm7♭5', 'VI7', 'IIm7', 'IIm7']
                    },
                    'There Will Never Be Another You': {
                        key: 'E♭',
                        chords: ['IM7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IM7', 'IIIm7', 'VI7']
                    },
                    'The Way You Look Tonight': {
                        key: 'E♭',
                        chords: ['IM7', 'IV7', 'IM7', 'VIm7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Time Remembered': {
                        key: 'F',
                        chords: ['IM7', 'bVII7', 'IM7', 'bVII7', 'IVM7', 'bVII7', 'IM7', 'IM7']
                    }
                },
                'V': {
                    'Very Early': {
                        key: 'E♭',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Virgo': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7♭5', 'V7', 'Im7', 'Im7']
                    }
                }
            };

            // 元素引用
            const mainScreen = document.getElementById('mainScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const targetIntervalEl = document.getElementById('targetInterval');
            const sequenceDisplayEl = document.getElementById('sequenceDisplay');
            const nextExerciseEl = document.getElementById('nextExercise');
            const startBtn = document.getElementById('startBtn');
            const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
            const rootNoteEl = document.getElementById('rootNote');
            const scaleTypeEl = document.getElementById('scaleType');
            const chordRootNoteEl = document.getElementById('chordRootNote');
            const audioInputDeviceEl = document.getElementById('audioInputDevice');
            const inputGainEl = document.getElementById('inputGain');
            const inputGainValueEl = document.getElementById('inputGainValue');
            const deviceInfoEl = document.getElementById('deviceInfo');
            const statusIndicator = document.getElementById('statusIndicator');
            const shortcutHint = document.getElementById('shortcutHint');
            const metronomeToggleEl = document.getElementById('metronomeToggle');
            const metronomeTempoEl = document.getElementById('metronomeTempo');
            const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
            const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
            const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
            const deviceSettings = document.querySelector('.device-settings');

            // 选项卡元素
            // const settingsTabs = document.querySelectorAll('.settings-tab'); // 已移除顶部选项卡
            const scaleSettings = document.querySelector('.scale-settings');
            const chordSettings = document.querySelector('.chord-settings');
            const progressionSettings = document.querySelector('.progression-settings');

            // 和弦类型按钮
            const chordTypeBtns = document.querySelectorAll('.chord-type-btn');

            // 音频设备管理
            let audioDevices = [];
            let selectedDeviceId = 'default';
            let inputGain = 1.0;
            let gainNode = null;

            // 屏幕唤醒锁变量
            let wakeLock = null;

            // 音频分析变量
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let javascriptNode = null;
            let isRecording = false;
            let mediaStream = null;

            // 练习状态
            let state = {
                score: 0,
                correctCount: 0,
                totalCount: 0,
                accuracy: 0,
                rootNote: '',
                scaleType: '',
                chordType: '',
                currentIntervals: [],
                currentSequence: [],
                currentStep: 0,
                correctPositions: [],
                isCoolingDown: false,
                cooldownTimeout: null,
                cooldownDuration: 600, // 冷却期持续时间(毫秒)
                enableCooldown: true, // 是否启用冷却时间
                enableFixedDelay: false, // 是否启用固定延迟生成下一题
                fixedDelayDuration: 800, // 固定延迟时间(毫秒)
                isAnswered: false,
                timeoutId: null,
                maxFret: 12,
                previousMaxFret: 12,
                isRecording: false,
                sensitivity: 0.5,
                confidenceThreshold: 0.5,
                noiseLevel: 0.001,
                minVolume: 0.001,
                microphoneInitialized: false,
                pitchBuffer: [],
                bufferSize: 3,
                zeroCrossingThreshold: 0.1,
                harmonicWeights: [1.0, 0.8, 0.6],
                nextExerciseInfo: '',
                nextExerciseIntervals: [],
                metronomeEnabled: document.getElementById('metronomeToggle').checked,
                metronomeTempo: parseInt(document.getElementById('metronomeTempo').value),
                metronomeFlashEnabled: document.getElementById('metronomeFlashToggle').checked,
                metronomeSoundEnabled: document.getElementById('metronomeSoundToggle').checked,
                metronomeInterval: null,
                // 和弦转换练习状态
                isInProgressionSession: false // 是否在练习会话中
            };

            // 初始化练习设置
            const cooldownDurationEl = document.getElementById('cooldownDuration');
            if (cooldownDurationEl) {
                state.cooldownDuration = parseInt(cooldownDurationEl.value);
            }

            const enableCooldownEl = document.getElementById('enableCooldown');
            if (enableCooldownEl) {
                state.enableCooldown = enableCooldownEl.checked;
            }

            const enableFixedDelayEl = document.getElementById('enableFixedDelay');
            if (enableFixedDelayEl) {
                state.enableFixedDelay = enableFixedDelayEl.checked;
            }

            const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
            if (fixedDelayDurationEl) {
                state.fixedDelayDuration = parseInt(fixedDelayDurationEl.value);
            }

            // 初始化音高检测设置
            const sensitivityEl = document.getElementById('sensitivity');
            if (sensitivityEl) {
                state.sensitivity = parseFloat(sensitivityEl.value);
            }

            const confidenceThresholdEl = document.getElementById('confidenceThreshold');
            if (confidenceThresholdEl) {
                state.confidenceThreshold = parseFloat(confidenceThresholdEl.value);
            }
            
            // 在初始化完成后加载保存的设置（这样可以覆盖默认值）
            setTimeout(() => {
                loadSettings();
            }, 100);

            // 设置管理功能
            function saveSettings() {
                const settings = {
                    // 练习设置
                    enableCooldown: state.enableCooldown,
                    cooldownDuration: state.cooldownDuration,
                    enableFixedDelay: state.enableFixedDelay,
                    fixedDelayDuration: state.fixedDelayDuration,
                    
                    // 音高检测设置
                    sensitivity: state.sensitivity,
                    confidenceThreshold: state.confidenceThreshold,
                    noiseLevel: state.noiseLevel,
                    minVolume: state.minVolume,
                    
                    // 节拍器设置
                    metronomeEnabled: state.metronomeEnabled,
                    metronomeTempo: state.metronomeTempo,
                    metronomeFlashEnabled: state.metronomeFlashEnabled,
                    metronomeSoundEnabled: state.metronomeSoundEnabled,
                    
                    // 音频设置
                    selectedDeviceId: selectedDeviceId,
                    inputGain: inputGain,
                    
                    // 版本信息（用于兼容性检查）
                    version: '1.0'
                };
                
                try {
                    localStorage.setItem('guitarPracticeSettings', JSON.stringify(settings));
                    console.log('设置已保存');
                } catch (error) {
                    console.error('保存设置失败:', error);
                }
            }
            
            function loadSettings() {
                try {
                    const savedSettings = localStorage.getItem('guitarPracticeSettings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        
                        // 更新state对象
                        if (settings.enableCooldown !== undefined) state.enableCooldown = settings.enableCooldown;
                        if (settings.cooldownDuration !== undefined) state.cooldownDuration = settings.cooldownDuration;
                        if (settings.enableFixedDelay !== undefined) state.enableFixedDelay = settings.enableFixedDelay;
                        if (settings.fixedDelayDuration !== undefined) state.fixedDelayDuration = settings.fixedDelayDuration;
                        if (settings.sensitivity !== undefined) state.sensitivity = settings.sensitivity;
                        if (settings.confidenceThreshold !== undefined) state.confidenceThreshold = settings.confidenceThreshold;
                        if (settings.noiseLevel !== undefined) state.noiseLevel = settings.noiseLevel;
                        if (settings.minVolume !== undefined) state.minVolume = settings.minVolume;
                        if (settings.metronomeEnabled !== undefined) state.metronomeEnabled = settings.metronomeEnabled;
                        if (settings.metronomeTempo !== undefined) state.metronomeTempo = settings.metronomeTempo;
                        if (settings.metronomeFlashEnabled !== undefined) state.metronomeFlashEnabled = settings.metronomeFlashEnabled;
                        if (settings.metronomeSoundEnabled !== undefined) state.metronomeSoundEnabled = settings.metronomeSoundEnabled;
                        if (settings.selectedDeviceId !== undefined) selectedDeviceId = settings.selectedDeviceId;
                        if (settings.inputGain !== undefined) inputGain = settings.inputGain;
                        
                        // 更新界面元素
                        updateUIFromSettings();
                        
                        console.log('设置已加载');
                        return true;
                    }
                } catch (error) {
                    console.error('加载设置失败:', error);
                }
                return false;
            }
            
            function updateUIFromSettings() {
                // 更新练习设置
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.checked = state.enableCooldown;
                }
                
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.value = state.cooldownDuration;
                    cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                }
                
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.checked = state.enableFixedDelay;
                }
                
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.value = state.fixedDelayDuration;
                    fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                }
                
                // 更新音高检测设置
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.value = state.sensitivity;
                    sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                }
                
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.value = state.confidenceThreshold;
                    confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                }
                
                // 更新节拍器设置
                const metronomeToggleEl = document.getElementById('metronomeToggle');
                if (metronomeToggleEl) {
                    metronomeToggleEl.checked = state.metronomeEnabled;
                }
                
                const metronomeTempoEl = document.getElementById('metronomeTempo');
                const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
                if (metronomeTempoEl && metronomeTempoValueEl) {
                    metronomeTempoEl.value = state.metronomeTempo;
                    metronomeTempoValueEl.textContent = state.metronomeTempo;
                }
                
                // 更新节拍器选项设置
                const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
                if (metronomeFlashToggleEl) {
                    metronomeFlashToggleEl.checked = state.metronomeFlashEnabled;
                }
                
                const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
                if (metronomeSoundToggleEl) {
                    metronomeSoundToggleEl.checked = state.metronomeSoundEnabled;
                }
                
                // 更新音频设置
                const audioInputDeviceEl = document.getElementById('audioInputDevice');
                if (audioInputDeviceEl && selectedDeviceId) {
                    // 等待设备列表更新完成后再设置选中项
                    setTimeout(() => {
                        audioInputDeviceEl.value = selectedDeviceId;
                    }, 100);
                }
                
                const inputGainEl = document.getElementById('inputGain');
                const inputGainValueEl = document.getElementById('inputGainValue');
                if (inputGainEl && inputGainValueEl) {
                    inputGainEl.value = inputGain * 100;
                    inputGainValueEl.textContent = Math.round(inputGain * 100) + '%';
                }
            }
            
            function resetSettings() {
                if (confirm('确定要重置所有设置吗？这将恢复到默认值。')) {
                    try {
                        localStorage.removeItem('guitarPracticeSettings');
                        
                        // 重置为默认值
                        state.enableCooldown = true;
                        state.cooldownDuration = 600;
                        state.enableFixedDelay = false;
                        state.fixedDelayDuration = 800;
                        state.sensitivity = 0.5;
                        state.confidenceThreshold = 0.5;
                        state.noiseLevel = 0.001;
                        state.minVolume = 0.001;
                        state.metronomeEnabled = false;
                        state.metronomeTempo = 40;
                        state.metronomeFlashEnabled = true;
                        state.metronomeSoundEnabled = true;
                        selectedDeviceId = 'default';
                        inputGain = 1.0;
                        
                        updateUIFromSettings();
                        
                        alert('设置已重置为默认值');
                        console.log('设置已重置');
                    } catch (error) {
                        console.error('重置设置失败:', error);
                    }
                }
            }
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('屏幕唤醒锁已激活');

                        wakeLock.addEventListener('release', () => {
                            console.log('屏幕唤醒锁已释放');
                        });
                    }
                } catch (err) {
                    console.error(`无法获取屏幕唤醒锁: ${err.message}`);
                }
            }

            // 释放屏幕唤醒锁
            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }

            // 获取音频设备列表
            async function getAudioDevices() {
                try {
                    // 请求权限以获取设备标签
                    await navigator.mediaDevices.getUserMedia({ audio: true });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    audioDevices = devices.filter(device => device.kind === 'audioinput');

                    updateAudioDeviceSelector();
                    checkForAudioInterfaces();
                    
                    // 保存设置以确保设备选择被记住
                    saveSettings();
                } catch (error) {
                    console.error('获取音频设备失败:', error);
                    deviceInfoEl.textContent = "无法获取音频设备列表，请确保已授予麦克风权限";
                }
            }

            // 更新设备选择器
            function updateAudioDeviceSelector() {
                const selector = document.getElementById('audioInputDevice');
                selector.innerHTML = '<option value="default">默认设备</option>';

                // 设备名称映射表
                const deviceNameMap = {
                    'Speakerphone': '麦克风',
                    'Headset earpiece': 'USB音频'
                };

                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // 应用设备名称映射
                    let displayName = device.label || `音频设备 ${selector.options.length}`;
                    if (deviceNameMap[displayName]) {
                        displayName = deviceNameMap[displayName];
                    }
                    
                    option.textContent = displayName;
                    selector.appendChild(option);
                });

                // 恢复之前保存的设备选择
                if (selectedDeviceId && selectedDeviceId !== 'default') {
                    selector.value = selectedDeviceId;
                }

                if (audioDevices.length > 0) {
                    deviceInfoEl.textContent = `检测到 ${audioDevices.length} 个音频输入设备`;
                } else {
                    deviceInfoEl.textContent = "未检测到音频输入设备";
                }
            }

            // 检测是否有专业音频设备
            function checkForAudioInterfaces() {
                const hasProfessionalDevices = audioDevices.some(device =>
                    device.label.toLowerCase().includes('interface') ||
                    device.label.toLowerCase().includes('usb') ||
                    device.label.toLowerCase().includes('focusrite') ||
                    device.label.toLowerCase().includes('scarlett') ||
                    device.label.toLowerCase().includes('presonus') ||
                    device.label.toLowerCase().includes('behringer') ||
                    device.label.toLowerCase().includes('steinberg') ||
                    device.label.toLowerCase().includes('zoom') ||
                    device.label.toLowerCase().includes('boss') ||
                    device.label.toLowerCase().includes('line6')
                );

                if (hasProfessionalDevices) {
                    showAudioInterfaceTip();
                }
            }

            function showAudioInterfaceTip() {
                const tip = document.createElement('div');
                tip.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    background: rgba(56, 189, 248, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 1002;
                    max-width: 250px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                tip.innerHTML = `
                    <strong><span class="usb-indicator"></span> USB声卡已检测</strong><br>
                    建议选择您的音频接口设备以获得最佳效果
                `;
                document.body.appendChild(tip);

                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.parentNode.removeChild(tip);
                    }
                }, 5000);
            }

            // 使用指定设备重新启动音频
            async function restartAudioWithNewDevice() {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 100));
                startRecording();
            }

            // 启动麦克风录音 - 支持设备选择
            async function startRecording() {
                if (isRecording) return;

                try {
                    const constraints = {
                        audio: {
                            deviceId: selectedDeviceId !== 'default' ?
                                { exact: selectedDeviceId } : undefined,
                            sampleRate: 48000,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            latency: 0.01
                        }
                    };

                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 48000,
                            latencyHint: 'interactive'
                        });
                    }

                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 4096;

                    // 创建增益节点用于音量控制
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = inputGain;

                    javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                    javascriptNode.onaudioprocess = processAudio;

                    microphone = audioContext.createMediaStreamSource(mediaStream);

                    // 连接音频节点：麦克风 -> 增益 -> 分析器 -> 处理节点 -> 输出
                    microphone.connect(gainNode);
                    gainNode.connect(analyser);
                    analyser.connect(javascriptNode);
                    javascriptNode.connect(audioContext.destination);

                    isRecording = true;
                    state.microphoneInitialized = true;
                    updateStatusIndicator('录音中...', 'recording');

                    console.log('音频输入已启动，设备:',
                        selectedDeviceId === 'default' ? '默认设备' :
                            audioDevices.find(d => d.deviceId === selectedDeviceId)?.label);

                } catch (e) {
                    console.error('音频初始化失败:', e);
                    updateStatusIndicator('音频初始化失败', 'error');

                    // 尝试使用默认设置
                    if (e.name === 'OverconstrainedError') {
                        console.log('尝试使用兼容的音频设置...');
                        try {
                            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            initializeBasicAudio();
                        } catch (fallbackError) {
                            console.error('备用音频初始化也失败:', fallbackError);
                        }
                    }
                }
            }

            // 简化的音频初始化（兼容模式）
            function initializeBasicAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
                javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                javascriptNode.onaudioprocess = processAudio;

                microphone = audioContext.createMediaStreamSource(mediaStream);
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                isRecording = true;
                state.microphoneInitialized = true;
                updateStatusIndicator('录音中(兼容模式)', 'recording');
            }

            // 停止麦克风录音
            function stopRecording() {
                if (!isRecording) return;

                if (javascriptNode) {
                    javascriptNode.disconnect();
                }
                if (analyser) {
                    analyser.disconnect();
                }
                if (microphone) {
                    microphone.disconnect();
                }
                if (gainNode) {
                    gainNode.disconnect();
                }

                isRecording = false;
            }

            // 完全关闭麦克风（退出应用时使用）
            function closeMicrophone() {
                stopRecording();

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                state.microphoneInitialized = false;
            }

            // 辅助函数和类
            class MedianFilter {
                constructor(size) {
                    this.size = Math.max(1, size | 0);
                    this.buffer = [];
                }
                push(val) {
                    this.buffer.push(val == null ? null : val);
                    if (this.buffer.length > this.size) this.buffer.shift();
                    const arr = this.buffer.filter(v => v != null);
                    if (arr.length === 0) return null;
                    const sorted = arr.slice().sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    if (sorted.length % 2 === 1) return sorted[mid];
                    return (sorted[mid - 1] + sorted[mid]) / 2;
                }
            }

            function ema(prev, current, alpha) {
                if (prev == null) return current;
                return alpha * current + (1 - alpha) * prev;
            }

            function applyHannWindow(buf) {
                const N = buf.length;
                for (let i = 0; i < N; i++) {
                    const w = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (N - 1)));
                    buf[i] *= w;
                }
            }

            function rms(buf) {
                let sum = 0;
                for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
                return Math.sqrt(sum / buf.length);
            }

            function downsampleBuffer(buffer, originalRate, targetRate) {
                if (targetRate >= originalRate) return buffer.slice(0);
                const ratio = originalRate / targetRate;
                const newLength = Math.floor(buffer.length / ratio);
                const out = new Float32Array(newLength);
                for (let i = 0; i < newLength; i++) {
                    const start = Math.floor(i * ratio);
                    const end = Math.floor((i + 1) * ratio);
                    let sum = 0;
                    for (let j = start; j < end && j < buffer.length; j++) sum += buffer[j];
                    out[i] = sum / Math.max(1, end - start);
                }
                return out;
            }

            function YINDetectorFactory(sampleRate, config) {
                config = config || {};
                const threshold = config.threshold || 0.15;
                const probabilityCliff = config.probabilityCliff || 0.1;
                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }
                    if (tauEstimate === -1) return null;
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }
                    const frequency = sampleRate / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));
                    if (probability < probabilityCliff) return null;
                    return { frequency, probability };
                };
            }

            // 增强版音高检测器
            class EnhancedPitchDetector {
                constructor() {
                    this.bufferSize = 8; // 增加缓冲区大小，提高稳定性
                    this.pitchBuffer = [];
                    this.lastStablePitch = null;
                    this.stabilityCounter = 0;
                    this.frequencyBias = { // 针对特定频率范围的偏差校正
                        'F': 1.02,  // 轻微提升F区域的检测值
                        'F♯': 0.98  // 轻微降低F♯区域的检测值
                    };
                }

                detect(float32AudioBuffer, sampleRate) {
                    // 使用YIN算法作为基础，但降低阈值提高灵敏度
                    const yinPitch = Pitchfinder.YIN({ threshold: 0.08 })(float32AudioBuffer);

                    // 使用增强的自相关检测
                    const autocorrPitch = this.autocorrelationDetect(float32AudioBuffer, sampleRate);

                    // 结合两种算法结果，并应用频率偏差校正
                    let finalPitch = this.combineResults(yinPitch, autocorrPitch, sampleRate);

                    // 应用更严格的滤波和缓冲
                    finalPitch = this.applyFilter(finalPitch);

                    // 应用频率偏差校正
                    finalPitch = this.applyFrequencyBias(finalPitch);

                    return finalPitch;
                }

                autocorrelationDetect(buffer, sampleRate) {
                    // 增强版自相关算法，特别优化中频区域检测
                    const maxLag = Math.floor(sampleRate / 65);
                    const minLag = Math.floor(sampleRate / 1000);

                    let bestLag = 0;
                    let bestCorrelation = -1;

                    // 使用加权窗口增强F和F♯区域的检测
                    const fFreq = 349.23;
                    const fSharpFreq = 369.99;
                    const fLag = Math.floor(sampleRate / fFreq);
                    const fSharpLag = Math.floor(sampleRate / fSharpFreq);

                    for (let lag = minLag; lag <= maxLag; lag++) {
                        let correlation = 0;

                        for (let i = 0; i < buffer.length - lag; i++) {
                            correlation += buffer[i] * buffer[i + lag];
                        }

                        correlation /= (buffer.length - lag);

                        // 应用汉宁窗减少边界效应
                        const window = 0.5 * (1 - Math.cos(2 * Math.PI * lag / maxLag));
                        correlation *= window;

                        // 对F和F♯区域应用额外权重
                        if (Math.abs(lag - fLag) < 10 || Math.abs(lag - fSharpLag) < 10) {
                            correlation *= 1.2; // 增强这些区域的相关性
                        }

                        if (correlation > bestCorrelation) {
                            bestCorrelation = correlation;
                            bestLag = lag;
                        }
                    }

                    return bestLag > 0 ? sampleRate / bestLag : null;
                }

                combineResults(yinPitch, autocorrPitch, sampleRate) {
                    if (!yinPitch || yinPitch <= 0) return autocorrPitch;
                    if (!autocorrPitch || autocorrPitch <= 0) return yinPitch;

                    const ratio = yinPitch / autocorrPitch;

                    // 更严格的一致性检查
                    if (ratio > 0.9 && ratio < 1.1) {
                        // 如果两种算法结果接近，取加权平均
                        return (yinPitch * 0.6 + autocorrPitch * 0.4);
                    }

                    // 否则选择置信度更高的结果
                    const yinConfidence = this.calculateConfidence(yinPitch, sampleRate);
                    const autocorrConfidence = this.calculateConfidence(autocorrPitch, sampleRate);

                    return yinConfidence > autocorrConfidence ? yinPitch : autocorrPitch;
                }

                applyFilter(pitch) {
                    if (!pitch || pitch <= 0) return null;

                    this.pitchBuffer.push(pitch);
                    if (this.pitchBuffer.length > this.bufferSize) {
                        this.pitchBuffer.shift();
                    }

                    // 使用中位数滤波而不是平均值，更能抵抗异常值
                    const sorted = [...this.pitchBuffer].sort((a, b) => a - b);
                    const medianPitch = sorted[Math.floor(sorted.length / 2)];

                    // 增强稳定性检测
                    if (this.lastStablePitch) {
                        const ratio = medianPitch / this.lastStablePitch;
                        if (ratio > 0.97 && ratio < 1.03) { // 更严格的稳定性标准
                            this.stabilityCounter++;
                        } else {
                            this.stabilityCounter = 0;
                        }
                    }

                    if (this.stabilityCounter >= 4) { // 需要更多的连续稳定样本
                        this.lastStablePitch = medianPitch;
                    }

                    return this.lastStablePitch || medianPitch;
                }

                applyFrequencyBias(pitch) {
                    if (!pitch) return null;

                    // 将频率转换为音符
                    const note = this.frequencyToNoteName(pitch);

                    // 应用特定音符的频率偏差校正
                    if (note && this.frequencyBias[note.name]) {
                        return pitch * this.frequencyBias[note.name];
                    }

                    return pitch;
                }

                frequencyToNoteName(frequency) {
                    const A4 = 440;
                    const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];

                    const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                    const noteIndex = Math.round(noteNum) % 12;
                    const octave = Math.floor(noteNum / 12) - 1;

                    return {
                        name: noteNames[noteIndex],
                        octave: octave
                    };
                }

                calculateConfidence(pitch, sampleRate) {
                    // 增强的置信度计算，特别关注F和F♯区域
                    if (pitch < 65 || pitch > 1000) return 0;

                    // F和F♯的频率范围
                    const isInFRange = pitch >= 340 && pitch <= 380;

                    // 对F和F♯区域给予更高的基础置信度
                    let confidence = isInFRange ? 1.2 : 1.0;

                    // 根据频率范围调整置信度
                    if (pitch < 100) confidence *= 0.8;
                    else if (pitch > 800) confidence *= 0.8;

                    return Math.min(1.0, confidence);
                }
            }

            // 音高检测辅助变量
            const medianFilter = new MedianFilter(5);
            let smoothedFreq = null;

            // 频率转换为音符名称和八度
            function freqToNoteInfo(freq) {
                if (!freq || freq <= 0) return null;
                const A4 = 440;
                const noteNumber = 12 * (Math.log(freq / A4) / Math.log(2)) + 69;
                const rounded = Math.round(noteNumber);
                const noteIndex = (rounded + 120) % 12;
                const octave = Math.floor(rounded / 12) - 1;
                const name = NOTE_NAMES[noteIndex] + octave;
                const cents = Math.round((noteNumber - rounded) * 100);
                return { name, cents, midi: rounded };
            }

            // 增强低频检测的音频处理函数
            // 修改processAudio函数，在冷却期内不处理音频
            function processAudio(event) {
                if (!isRecording || state.isAnswered || (state.enableCooldown && state.isCoolingDown)) return;

                const inputData = event.inputBuffer.getChannelData(0);
                const sampleRate = audioContext.sampleRate;

                // 动态调整YIN算法参数 - 低频使用更高灵敏度
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110; // A2以下视为低频
                });

                const yinParams = isLowFrequencyTarget ?
                    { threshold: 0.05, probabilityCliff: 0.05 } : // 低频参数
                    { threshold: 0.1, probabilityCliff: 0.1 };   // 常规参数

                const yinResult = Pitchfinder.YIN(yinParams)(inputData);

                if (!yinResult || !yinResult.frequency) return;

                // 动态能量检测 - 低频使用更低阈值
                const energy = rms(inputData);
                const energyThreshold = yinResult.frequency < 110 ? 0.001 : 0.002;
                if (energy < energyThreshold) return;

                // 谐波增强处理 - 特别针对低频
                let detectedFreq = yinResult.frequency;
                if (detectedFreq < 110) {
                    // 检查是否是基频的谐波
                    const possibleFundamental = detectedFreq / 2;
                    const fundamentalResult = Pitchfinder.YIN(yinParams)(inputData);
                    if (fundamentalResult && fundamentalResult.frequency &&
                        Math.abs(fundamentalResult.frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }

                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // 优化音高匹配算法
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // 动态调整匹配阈值 - 低频更宽松，并且基于敏感度设置
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                
                // 根据敏感度调整阈值 - 敏感度越高，阈值越小
                const threshold = baseThreshold * (2 - state.sensitivity);

                if (adjustedCents <= threshold && yinResult.probability > state.confidenceThreshold) {
                    handleCorrectAnswer();
                }

                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }


            // 应用高通滤波器
            function applyHighPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = RC / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = alpha * (y + buffer[i] - buffer[i - 1]);
                    buffer[i] = y;
                }
            }

            // 应用低通滤波器
            function applyLowPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = dt / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = y + alpha * (buffer[i] - y);
                    buffer[i] = y;
                }
            }

            // 计算信号强度作为置信度的估计
            function calculateSignalStrength(buffer) {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += Math.abs(buffer[i]);
                }
                const average = sum / buffer.length;
                return Math.min(1.0, average * 10);
            }

            // 频率转换为音符名称和八度
            function frequencyToNoteName(frequency) {
                const A4 = 440;
                const noteNames = ['C', 'C♯', 'D', 'D♯', 'E', 'F', 'F♯', 'G', 'G♯', 'A', 'A♯', 'B'];

                const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                const noteIndex = Math.round(noteNum) % 12;
                const octave = Math.floor(noteNum / 12) - 1;

                return {
                    name: noteNames[noteIndex],
                    octave: octave
                };
            }

            // 检查检测到的音高是否匹配当前步骤的目标音高
            function checkPitchMatch(detectedPitch, confidence) {
                if (state.isAnswered || confidence < state.confidenceThreshold) return;

                const currentInterval = state.currentSequence[state.currentStep];
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;

                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                const cents = 1200 * Math.log2(detectedPitch / targetFrequency);

                updatePitchDisplay(detectedPitch, cents, confidence);

                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // 对F和F♯音符使用更宽松的匹配标准，同时考虑敏感度设置
                const detectedNote = frequencyToNoteName(detectedPitch);
                let baseCentsThreshold = 20; // 默认音分差阈值

                // 检查目标音符是否为F或F♯
                const targetNote = frequencyToNoteName(targetFrequency);
                if (targetNote.name === 'F' || targetNote.name === 'F♯') {
                    baseCentsThreshold = 35; // 对F和F♯使用更宽松的阈值
                }

                // 如果检测到的音符是F或F♯，也使用更宽松的阈值
                if (detectedNote.name === 'F' || detectedNote.name === 'F♯') {
                    baseCentsThreshold = Math.max(baseCentsThreshold, 35);
                }

                // 根据敏感度调整阈值
                const centsThreshold = baseCentsThreshold * (2 - state.sensitivity);

                if (adjustedCents <= centsThreshold) {
                    handleCorrectAnswer();
                }
            }

            // 更新实时音高显示
            function updatePitchDisplay(frequency, cents, confidence) {
                const pitchDisplay = document.getElementById('pitchDisplay');
                if (!pitchDisplay) return;

                const note = frequencyToNoteName(frequency);
                const centsMod = cents % 1200;
                const adjustedCents = centsMod > 600 ? centsMod - 1200 : centsMod;
                const roundedFreq = Math.round(frequency);
                const roundedCents = Math.round(adjustedCents);
                const confidencePercent = Math.round(confidence * 100);

                if (!pitchDisplay._cache) {
                    pitchDisplay._cache = {
                        note: '',
                        octave: '',
                        freq: 0,
                        cents: 0,
                        confidence: 0,
                        inTune: false
                    };
                }

                const cache = pitchDisplay._cache;
                const inTune = Math.abs(adjustedCents) <= 20;

                if (cache.note !== note.name ||
                    cache.octave !== note.octave ||
                    cache.freq !== roundedFreq ||
                    cache.cents !== roundedCents ||
                    cache.confidence !== confidencePercent ||
                    cache.inTune !== inTune) {

                    cache.note = note.name;
                    cache.octave = note.octave;
                    cache.freq = roundedFreq;
                    cache.cents = roundedCents;
                    cache.confidence = confidencePercent;
                    cache.inTune = inTune;

                    const children = pitchDisplay.children;

                    if (children.length < 3) {
                        pitchDisplay.innerHTML = `
                            <div>音高: ${note.name}${note.octave} (${roundedFreq}Hz)</div>
                            <div>音分差: ${adjustedCents > 0 ? '+' : ''}${roundedCents}</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        `;
                    } else {
                        children[0].textContent = `音高: ${note.name}${note.octave} (${roundedFreq}Hz)`;
                        children[1].textContent = `音分差: ${adjustedCents > 0 ? '+' : ''}${roundedCents}`;
                        children[2].querySelector('.confidence-fill').style.width = `${confidencePercent}%`;
                    }

                    pitchDisplay.classList.toggle('in-tune', inTune);
                    pitchDisplay.classList.toggle('out-of-tune', !inTune);
                }
            }

            // 优化后的正确答案处理
            function handleCorrectAnswer() {
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;

                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }

                requestAnimationFrame(() => {
                    if (state.currentStep >= state.currentSequence.length) {
                        state.isAnswered = true;

                        // 根据设置决定是否进入冷却期
                        if (state.enableCooldown) {
                            state.isCoolingDown = true;
                            if (state.cooldownTimeout) {
                                clearTimeout(state.cooldownTimeout);
                            }
                            state.cooldownTimeout = setTimeout(() => {
                                state.isCoolingDown = false;
                            }, state.cooldownDuration);
                        }

                        // 根据设置决定延迟时间
                        let delayTime = 0; // 默认无延迟
                        if (state.enableFixedDelay) {
                            delayTime = state.fixedDelayDuration;
                        }

                        // 延迟生成下一题，给用户停止弹奏的时间
                        setTimeout(() => {
                            generateExercise();
                        }, delayTime);
                    } else {
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                    }
                });
            }

            // 预生成下一个练习
            function generateNextExercise() {
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;

                if (activeTab === 'scale') {
                    let rootNote = rootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }

                    let scaleType = scaleTypeEl.value;
                    if (scaleType === 'random') {
                        const types = Object.keys(scaleTypes);
                        scaleType = types[Math.floor(Math.random() * types.length)];
                    }

                    // 获取方向
                    const activeOrderBtn = document.querySelector('.scale-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                    // 获取旋律模进类型
                    const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                    let arpeggioType = '1to1';
                    
                    for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                      if (arpeggioTypeButtons[i].classList.contains('active')) {
                        arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                        break;
                      }
                    }

                    // 特殊处理旋律小调：根据方向选择上行或下行形式
                    let intervals;
                    let isMelodicMinorDescending = false;
                    if (scaleType === 'melodicMinor' && order === 'reverse') {
                        // 下行旋律小调
                        intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                        isMelodicMinorDescending = true;
                    } else {
                        // 默认使用上行形式
                        intervals = [...scaleTypes[scaleType].intervals];
                    }
                    state.currentIntervals = intervals;
                    let startEndInterval = '1'; // 默认使用1作为首尾音
                    
                    // 根据练习序列类型确定首尾音
                    if (arpeggioType === 'random-arpeggio') {
                        // 随机选择1、3、5、7音作为首尾音，但只包含音阶中实际存在的音程
                        const availableChordTones = [];
                        const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                        if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                        const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                        if (fifthInterval) availableChordTones.push(fifthInterval);
                        const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                        if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                        
                        // 如果有可用的3/5/7度音程，则从中随机选择
                        if (availableChordTones.length > 0) {
                            startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                        } else {
                            startEndInterval = '1'; // 回退到根音
                        }
                    } else if (arpeggioType === '3to3') {
                        // 使用3音作为首尾音
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    } else if (arpeggioType === '5to5') {
                        // 使用5音作为首尾音
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    } else if (arpeggioType === '7to7') {
                        // 使用7音作为首尾音
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                        // 处理其他特定音程作为首尾音的情况（如♯6→♯6）
                        // arpeggioType格式为"xtox"，提取x部分
                        const match = arpeggioType.match(/^(.+)to\1$/);
                        if (match) {
                            const intervalType = match[1];
                            console.log('处理特定音程:', intervalType, '在音阶中:', state.currentIntervals);
                            // 查找音阶中对应的音程
                            const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                            console.log('找到的完整音程:', completeInterval);
                            if (completeInterval) {
                                startEndInterval = completeInterval;
                            } else {
                                const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                                console.log('找到的最近音程:', nearestInterval);
                                startEndInterval = nearestInterval || intervalType;
                            }
                            console.log('最终首尾音:', startEndInterval);
                        }
                    }

                    // 特殊处理旋律小调下行：直接使用预定义的序列，不进行额外处理
                    if (!isMelodicMinorDescending) {
                        if (order === 'reverse') {
                            // 倒序模式
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // 找到首尾音在原始音阶中的位置
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // 提取从首尾音开始的所有音，然后倒序，最后添加首尾音
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                    const middleIntervals = state.currentIntervals.slice(1).reverse();
                                    state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // 保持原有的倒序逻辑
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else if (order === 'random') {
                            // 随机模式
                            if (arpeggioType === 'random-arpeggio') {
                                // 对于随机和弦类型，整个序列都应该只包含和弦音（1、3、5、7度音程）
                                // 收集所有实际存在的3/5/7度音程
                                const availableChordTones = [];
                                const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                                if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                                const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                                if (fifthInterval) availableChordTones.push(fifthInterval);
                                const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                                if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                                
                                // 如果找不到足够的和弦音，回退到使用首尾音
                                if (availableChordTones.length > 0) {
                                    // 随机打乱和弦音
                                    const shuffledChordTones = [...availableChordTones];
                                    for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                    }
                                    
                                    // 从找到的和弦音中随机选择一个作为首尾音
                                    startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                    
                                    // 构建新序列，确保包含首尾音
                                    state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                                } else {
                                    // 如果没有足够的和弦音，使用根音作为整个序列
                                    state.currentIntervals = ['1', '1'];
                                }
                            } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                                // 找到首尾音在原始音阶中的位置
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // 提取除了首尾音之外的所有音
                                    const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                    
                                    // 随机打乱
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    
                                    // 构建新序列，确保首尾都是指定的音
                                    state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                                } else {
                                    // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                    const otherIntervals = state.currentIntervals.slice(1);
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // 保持原有的随机逻辑
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // 顺序模式
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // 找到首尾音在原始音阶中的位置
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // 提取从首尾音开始的所有音，然后添加首尾音
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                    state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                                }
                            } else {
                                // 保持原有的顺序逻辑
                                state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                            }
                        }
                    }

                    state.nextExerciseInfo = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                    // 修复：使用处理后的state.currentIntervals而不是原始的intervals
                    state.nextExerciseIntervals = [...state.currentIntervals];
                } else if (activeTab === 'progression') {
                    // 和弦转换练习预生成下一题（使用已存储的和弦进行和索引）
                    if (state.progressionChords && state.progressionIndex !== undefined) {
                        const chords = state.progressionChords;
                        const enableRepeatEl = document.getElementById('enableRepeat');
                        const progressionLevelEl = document.getElementById('progressionLevel');
                        
                        // 获取下一个和弦的索引
                        let nextIndex = state.progressionIndex;
                        
                        // 检查是否超出和弦数量
                        if (nextIndex >= chords.length) {
                            const isRepeatEnabled = enableRepeatEl.checked;
                            if (isRepeatEnabled) {
                                nextIndex = 0; // 重新开始
                            } else {
                                state.nextExerciseInfo = '练习完成';
                                state.nextExerciseIntervals = [];
                                return;
                            }
                        }
                        
                        if (nextIndex < chords.length) {
                            const nextChord = chords[nextIndex];
                            const level = progressionLevelEl.value;
                            let intervals = getIntervalsForLevel(level);
                            
                            state.nextExerciseInfo = nextChord; // 只显示和弦名
                            state.nextExerciseIntervals = intervals;
                        }
                    }
                } else {
                    // 和弦练习预生成下一题
                    // 如果是自定义和弦模式，直接从自定义和弦序列中获取下一个和弦
                    if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            return { root, type };
                        });

                        const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                        const nextIndex = (currentIndex + 1) % chords.length;
                        const nextChord = chords[nextIndex];

                        state.nextExerciseInfo = formatChordSymbol(nextChord.root, nextChord.type);                        state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    } else {
                        // 常规和弦模式 - 实时获取当前选中的和弦类型
                        let rootNote = chordRootNoteEl.value;
                        if (rootNote === 'random') {
                            const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                            rootNote = notes[Math.floor(Math.random() * notes.length)];
                        }

                        // 实时获取当前选中的和弦类型（不使用缓存）
                        const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                        let chordType = 'major';
                        if (activeChordTypes.length > 0) {
                            const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                            chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                        } else {
                            // 如果没有选中任何和弦类型，不生成默认和弦，而是直接返回空值
                            console.warn('没有选中任何和弦类型，无法生成练习');
                            return; // 不生成练习
                        }

                        const activeOrderBtn = document.querySelector('.chord-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                        let intervals = [...chordTypes[chordType].intervals];
                        if (order === 'reverse') {
                            // 下行模式：倒序排列
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }

                        const chordSymbol = formatChordSymbol(rootNote, chordType);
                        state.nextExerciseInfo = chordSymbol;
                        state.nextExerciseIntervals = intervals;
                    }
                }

                updateNextExerciseDisplay();
            }
            function requestRecordPermission() {
                // 使用标准Web API请求媒体权限
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            // 用户已授权，可以开始录音
                            console.log('录音权限已获取');
                            // 调用你的开始录音逻辑
                            // startRecording();
                            
                            // 停止临时流，因为我们只是在检查权限
                            stream.getTracks().forEach(track => track.stop());
                        })
                        .catch(function(err) {
                            console.error('获取录音权限失败:', err);
                            if (err.name === 'NotAllowedError') {
                                console.log('用户拒绝授权');
                            } else if (err.name === 'NotFoundError') {
                                console.log('未找到录音设备');
                            } else {
                                console.log('权限申请错误');
                            }
                        });
                } else {
                    console.warn('当前浏览器不支持媒体设备API');
                }
            }
            // 更新下一个练习显示
            function updateNextExerciseDisplay() {
                if (state.nextExerciseInfo) {
                    // 检查是否为diminished音阶类型，如果是则不显示音级信息
                    const isDiminishedScale = state.nextExerciseInfo && 
                        (state.nextExerciseInfo.includes('Diminished') || 
                         state.nextExerciseInfo.includes('减') && state.nextExerciseInfo.includes('音阶'));
                    
                    if (state.nextExerciseIntervals && state.nextExerciseIntervals.length > 0 && !isDiminishedScale) {
                        nextExerciseEl.innerHTML = `${state.nextExerciseInfo}<br><span style="font-size: 14px; color: #94a3b8;">${state.nextExerciseIntervals.join(' ')}</span>`;
                    } else {
                        nextExerciseEl.innerHTML = state.nextExerciseInfo;
                    }
                } else {
                    nextExerciseEl.innerHTML = '-';
                }
            }

            // 优化后的练习生成函数
            // 修改generateExercise函数，重置冷却期状态
            function generateExercise() {
                // 清除之前的状态信息，确保从当前设置生成
                state.nextExerciseInfo = '';
                state.nextExerciseIntervals = [];
                state.chordType = ''; // 清除之前的和弦类型
                
                // 获取当前活动标签页
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                
                // 只在和弦转换练习时显示乐曲名，其他情况下隐藏
                if (activeTab === 'progression') {
                    songTitleDisplayEl.style.display = 'block';
                } else {
                    songTitleDisplayEl.style.display = 'none';
                }
                
                state.pitchBuffer = [];
                state.isAnswered = false;
                state.currentStep = 0;

                // 重置冷却期状态
                if (state.enableCooldown) {
                    state.isCoolingDown = false;
                    if (state.cooldownTimeout) {
                        clearTimeout(state.cooldownTimeout);
                        state.cooldownTimeout = null;
                    }
                }

                // 使用预加载的练习数据
                if (state.nextExerciseInfo && state.nextExerciseIntervals.length > 0) {
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;

                    if (activeTab === 'scale') {
                        const parts = state.nextExerciseInfo.split(' ');
                        state.rootNote = parts[0];
                        state.scaleType = Object.keys(scaleTypes).find(key => scaleTypes[key].name === parts[1]);
                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    } else if (activeTab === 'progression') {
                        // 和弦转换练习
                        const { root, type } = parseChordSymbol(state.nextExerciseInfo);
                        state.rootNote = root;
                        state.chordType = type;

                        state.currentIntervals = [...state.nextExerciseIntervals];
                        targetIntervalEl.textContent = state.nextExerciseInfo;
                    } else {
                        // 和弦练习
                        // 如果是自定义和弦模式，直接从自定义和弦序列中获取当前和弦
                        if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                            const chordItems = customChordSequence.querySelectorAll('.chord-item');
                            const chords = Array.from(chordItems).map(item => {
                                const root = item.querySelector('.remove-chord').dataset.root;
                                const type = item.querySelector('.remove-chord').dataset.type;
                                return { root, type };
                            });

                            const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                            const chord = chords[currentIndex];

                            state.rootNote = chord.root;
                            state.chordType = chord.type;
                            state.currentIntervals = [...state.nextExerciseIntervals];
                            targetIntervalEl.textContent = state.nextExerciseInfo;
                        } else {
                            const chordMatch = state.nextExerciseInfo.match(/([A-G][♯♭]?)(.*)/);
                            state.rootNote = chordMatch[1];

                            const chordSymbol = chordMatch[2];
                            state.chordType = chordSymbol === '' ? 'major' :
                                chordSymbol === 'm' ? 'minor' :
                                    chordSymbol === '7' ? 'dominant7' :
                                        chordSymbol === 'maj7' ? 'major7' :
                                            chordSymbol === 'm7' ? 'minor7' :
                                                chordSymbol === 'sus2' ? 'sus2' : 'sus4';

                            state.currentIntervals = [...state.nextExerciseIntervals];
                            targetIntervalEl.textContent = state.nextExerciseInfo;
                        }
                    }

                    displaySequence();

                    // 立即预加载下一题
                    generateNextExercise();
                } else {
                    // 首次加载时生成两题
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                    if (activeTab === 'scale') {
                        generateScaleExercise();
                    } else if (activeTab === 'chord') {
                        generateChordExercise();
                    } else if (activeTab === 'progression') {
                        generateProgressionExercise();
                    }

                    // 立即预加载下一题（如果在generateChordExercise中没有调用）
                    if (!state.nextExerciseInfo) {
                        generateNextExercise();
                    }
                }
            }

            // 生成音阶练习
            function generateScaleExercise() {
                let rootNote = rootNoteEl.value;
                if (rootNote === 'random') {
                    const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                    rootNote = notes[Math.floor(Math.random() * notes.length)];
                }
                state.rootNote = rootNote;

                let scaleType = scaleTypeEl.value;
                if (scaleType === 'random') {
                    const types = Object.keys(scaleTypes);
                    scaleType = types[Math.floor(Math.random() * types.length)];
                }
                state.scaleType = scaleType;

                // 获取练习序列类型
                const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                let arpeggioType = '1to1';
                
                for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                  if (arpeggioTypeButtons[i].classList.contains('active')) {
                    arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                    break;
                  }
                }
                
                console.log('当前选择的练习序列类型:', arpeggioType);

                // 获取方向
                const activeScaleOrderBtn = document.querySelector('.scale-order-btn.active');
                const order = activeScaleOrderBtn ? activeScaleOrderBtn.dataset.value : 'ordered';

                // 特殊处理旋律小调：根据方向选择上行或下行形式
                let intervals;
                let isMelodicMinorDescending = false;
                if (scaleType === 'melodicMinor' && order === 'reverse') {
                    // 下行旋律小调
                    intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                    isMelodicMinorDescending = true;
                } else {
                    // 默认使用上行形式
                    intervals = [...scaleTypes[scaleType].intervals];
                }
                state.currentIntervals = intervals;
                let startEndInterval = '1'; // 默认使用1作为首尾音
                
                // 根据练习序列类型确定首尾音
                if (arpeggioType === 'random-arpeggio') {
                    // 随机选择1、3、5、7音作为首尾音，但只包含音阶中实际存在的音程
                    const availableChordTones = [];
                    const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                    const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    if (fifthInterval) availableChordTones.push(fifthInterval);
                    const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                    
                    // 如果有可用的3/5/7度音程，则从中随机选择
                    if (availableChordTones.length > 0) {
                        startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                    } else {
                        startEndInterval = '1'; // 回退到根音
                    }
                } else if (arpeggioType === '3to3') {
                    // 使用3音作为首尾音
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                } else if (arpeggioType === '5to5') {
                    // 使用5音作为首尾音
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                } else if (arpeggioType === '7to7') {
                    // 使用7音作为首尾音
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                    // 处理其他特定音程作为首尾音的情况（如♯6→♯6）
                    // arpeggioType格式为"xtox"，提取x部分
                    const match = arpeggioType.match(/^(.+)to\1$/);
                    if (match) {
                        const intervalType = match[1];
                        console.log('处理特定音程:', intervalType, '在音阶中:', state.currentIntervals);
                        // 查找音阶中对应的音程
                        const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                        console.log('找到的完整音程:', completeInterval);
                        if (completeInterval) {
                            startEndInterval = completeInterval;
                        } else {
                            const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                            console.log('找到的最近音程:', nearestInterval);
                            startEndInterval = nearestInterval || intervalType;
                        }
                        console.log('最终首尾音:', startEndInterval);
                    }
                }

                // 特殊处理旋律小调下行：直接使用预定义的序列，不进行额外处理
                if (!isMelodicMinorDescending) {
                    if (order === 'reverse') {
                        // 倒序模式
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // 找到首尾音在原始音阶中的位置
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // 提取从首尾音开始的所有音，然后倒序，最后添加首尾音
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // 保持原有的倒序逻辑
                            const middleIntervals = state.currentIntervals.slice(1).reverse();
                            state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                        }
                    } else if (order === 'random') {
                        // 随机模式
                        if (arpeggioType === 'random-arpeggio') {
                            // 对于随机和弦类型，整个序列都应该只包含和弦音（1、3、5、7度音程）
                            // 收集所有实际存在的3/5/7度音程
                            const availableChordTones = [];
                            const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                            if (thirdInterval) availableChordTones.push(thirdInterval); // 添加找到的3度音（可能是♭3, 3, ♯3等）
                            const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                            if (fifthInterval) availableChordTones.push(fifthInterval);
                            const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                            if (seventhInterval) availableChordTones.push(seventhInterval); // 添加找到的7度音（可能是♭7, 7, ♯7等）
                            
                            // 如果找不到足够的和弦音，回退到使用首尾音
                            if (availableChordTones.length > 0) {
                                // 随机打乱和弦音
                                const shuffledChordTones = [...availableChordTones];
                                for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                }
                                
                                // 从找到的和弦音中随机选择一个作为首尾音
                                startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                
                                // 构建新序列，确保包含首尾音
                                state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                            } else {
                                // 如果没有足够的和弦音，使用根音作为整个序列
                                state.currentIntervals = ['1', '1'];
                            }
                        } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                            // 找到首尾音在原始音阶中的位置
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // 提取除了首尾音之外的所有音
                                const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                
                                // 随机打乱
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                
                                // 构建新序列，确保首尾都是指定的音
                                state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                            } else {
                                // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // 保持原有的随机逻辑
                            const otherIntervals = state.currentIntervals.slice(1);
                            for (let i = otherIntervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                            }
                            state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                        }
                    } else {
                        // 顺序模式
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // 找到首尾音在原始音阶中的位置
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // 提取从首尾音开始的所有音，然后添加首尾音
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // 如果找不到首尾音（这种情况不应该发生），使用默认行为
                                state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                            }
                        } else {
                            // 保持原有的顺序逻辑
                            state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                        }
                    }
                }

                targetIntervalEl.textContent = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                displaySequence();
            }

            // 生成和弦练习
            function generateChordExercise() {
                try {
                    // 清除之前的状态信息，确保从当前选中的和弦类型生成
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // 清除之前的和弦类型
                    
                    if (useCustomChords.checked && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        // 使用自定义和弦序列
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            return { root, type };
                        });

                        // 按顺序练习自定义和弦序列
                        const currentChordIndex = state.customChordIndex || 0;
                        const chord = chords[currentChordIndex];

                        state.rootNote = chord.root;
                        state.chordType = chord.type;
                        
                        // 检查和弦类型是否存在
                        if (!chordTypes[state.chordType]) {
                            throw new Error(`未知的和弦类型: ${state.chordType}`);
                        }
                        
                        state.currentIntervals = [...chordTypes[state.chordType].intervals];

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // 下行模式：倒序排列
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    const chordSymbol = formatChordSymbol(state.rootNote, state.chordType);
                    targetIntervalEl.textContent = chordSymbol;
                    displaySequence();

                    // 设置下一个和弦为序列中的下一个
                    const nextIndex = (currentChordIndex + 1) % chords.length;
                    state.customChordIndex = nextIndex;
                    const nextChord = chords[nextIndex];

                    state.nextExerciseInfo = formatChordSymbol(nextChord.root, nextChord.type);                    state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    updateNextExerciseDisplay();
                } else {
                    // 使用原始和弦生成逻辑
                    state.customChordIndex = null;
                    originalGenerateChordExercise();
                }
                } catch (error) {
                    console.error('生成和弦练习失败:', error);
                    updateStatusIndicator('和弦练习生成失败: ' + error.message, 'error');
                    // 回退到默认和弦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // 显示音阶/和弦序列
            function displaySequence() {
                const fragment = document.createDocumentFragment();
                state.currentSequence = [];

                state.currentIntervals.forEach((interval, index) => {
                    const span = document.createElement('div');
                    span.className = 'sequence-item';
                    if (index === 0) span.classList.add('current');
                    span.textContent = interval;
                    span.dataset.index = index;
                    fragment.appendChild(span);
                    state.currentSequence.push(interval);
                });

                sequenceDisplayEl.innerHTML = '';
                sequenceDisplayEl.appendChild(fragment);
            }

            // 启动节拍器
            function startMetronome() {
                if (state.metronomeInterval) {
                    stopMetronome();
                }

                if (!state.metronomeEnabled) return;

                const beatInterval = 60000 / state.metronomeTempo;

                document.documentElement.style.setProperty('--metronome-speed', `${beatInterval}ms`);

                if (practiceScreen.style.display === 'flex') {
                    practiceScreen.classList.add('metronome-active');
                }

                state.metronomeInterval = setInterval(() => {
                    // 背景闪光效果
                    if (state.metronomeFlashEnabled) {
                        practiceScreen.classList.add('metronome-flash');
                        setTimeout(() => {
                            practiceScreen.classList.remove('metronome-flash');
                        }, 300);
                    }

                    // 播放节拍器声音
                    if (state.metronomeSoundEnabled && audioContext) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 892; //远离一般乐音，避免干扰
                        gainNode.gain.value = 0.1;
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.05);
                    }
                }, beatInterval);
            }

            // 停止节拍器
            function stopMetronome() {
                if (state.metronomeInterval) {
                    clearInterval(state.metronomeInterval);
                    state.metronomeInterval = null;
                }

                practiceScreen.classList.remove('metronome-active');
                practiceScreen.classList.remove('metronome-flash');
            }

            // 初始化事件监听器
            function initEventListeners() {
                // 音频设备选择事件
                audioInputDeviceEl.addEventListener('change', function () {
                    selectedDeviceId = this.value;
                    if (isRecording) {
                        restartAudioWithNewDevice();
                    }
                    // 保存设置
                    saveSettings();
                    console.log('音频设备已保存到localStorage:', selectedDeviceId);
                });

                // 输入增益控制
                inputGainEl.addEventListener('input', function () {
                    inputGain = this.value / 100;
                    inputGainValueEl.textContent = this.value + '%';

                    if (gainNode) {
                        gainNode.gain.value = inputGain;
                    }
                    saveSettings(); // 保存设置
                });

                // 刷新设备列表
                refreshDevicesBtn.addEventListener('click', function () {
                    getAudioDevices();
                    updateStatusIndicator('正在刷新设备列表...', 'ready');
                    setTimeout(() => {
                        updateStatusIndicator('准备就绪', 'ready');
                    }, 1000);
                });

                // 歌曲选择事件监听器
                const jazzStandardEl = document.getElementById('jazzStandard');
                if (jazzStandardEl) {
                    jazzStandardEl.addEventListener('change', function() {
                        const selectedSong = this.value;
                        if (selectedSong) {
                            updateKeySelector(selectedSong);
                        }
                    });
                }

                // 节拍器开关事件
                metronomeToggleEl.addEventListener('change', function () {
                    state.metronomeEnabled = this.checked;
                    if (state.metronomeEnabled && practiceScreen.style.display === 'flex') {
                        startMetronome();
                    } else {
                        stopMetronome();
                    }
                    saveSettings(); // 保存设置
                });

                // 节拍器速度滑块事件
                metronomeTempoEl.addEventListener('input', function () {
                    state.metronomeTempo = parseInt(this.value);
                    metronomeTempoValueEl.textContent = state.metronomeTempo;

                    if (state.metronomeEnabled && state.metronomeInterval) {
                        startMetronome();
                    }
                    saveSettings(); // 保存设置
                });

                // 节拍器背景闪光开关事件
                metronomeFlashToggleEl.addEventListener('change', function () {
                    state.metronomeFlashEnabled = this.checked;
                    saveSettings(); // 保存设置
                });

                // 节拍器声音开关事件
                metronomeSoundToggleEl.addEventListener('change', function () {
                    state.metronomeSoundEnabled = this.checked;
                    saveSettings(); // 保存设置
                });

                // 冷却时间开关事件
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.addEventListener('change', function () {
                        state.enableCooldown = this.checked;
                        console.log('冷却时间功能:', this.checked ? '已启用' : '已关闭');
                        saveSettings(); // 保存设置
                    });
                }

                // 冷却时间滑块事件
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.addEventListener('input', function () {
                        state.cooldownDuration = parseInt(this.value);
                        cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                        console.log('冷却时间设置为:', state.cooldownDuration + 'ms');
                        saveSettings(); // 保存设置
                    });
                }

                // 固定延迟生成开关事件
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.addEventListener('change', function () {
                        state.enableFixedDelay = this.checked;
                        console.log('固定延迟生成功能:', this.checked ? '已启用' : '已关闭');
                        saveSettings(); // 保存设置
                    });
                }

                // 固定延迟时间滑块事件
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.addEventListener('input', function () {
                        state.fixedDelayDuration = parseInt(this.value);
                        fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                        console.log('固定延迟时间设置为:', state.fixedDelayDuration + 'ms');
                        saveSettings(); // 保存设置
                    });
                }

                // 音高检测敏感度滑块事件
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.addEventListener('input', function () {
                        state.sensitivity = parseFloat(this.value);
                        sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                        console.log('音高检测敏感度设置为:', state.sensitivity);
                        saveSettings(); // 保存设置
                    });
                }

                // 置信度阈值滑块事件
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.addEventListener('input', function () {
                        state.confidenceThreshold = parseFloat(this.value);
                        confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                        console.log('置信度阈值设置为:', state.confidenceThreshold);
                        saveSettings(); // 保存设置
                    });
                }
                
                // 重置设置按钮事件
                const resetSettingsBtn = document.getElementById('resetSettingsBtn');
                if (resetSettingsBtn) {
                    resetSettingsBtn.addEventListener('click', function () {
                        resetSettings();
                    });
                }

                // 开始练习按钮
                startBtn.addEventListener('click', function () {
                    console.log('开始练习按钮被点击');
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                    console.log('当前选择的标签页:', activeTab);
                    
                    // 验证和弦设置
                    if (activeTab === 'chord') {
                        const useCustomChords = document.getElementById('useCustomChords');
                        if (!useCustomChords.checked) {
                            const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                            if (activeChordTypes.length === 0) {
                                alert('请先选择至少一个和弦类型！');
                                return;
                            }
                        } else {
                            const customChordItems = document.querySelectorAll('#customChordSequence .chord-item');
                            if (customChordItems.length === 0) {
                                alert('请先添加至少一个自定义和弦！');
                                return;
                            }
                        }
                    }
                    
                    updateStatusIndicator('正在启动麦克风...', 'recording');

                    // 检查浏览器是否支持getUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('浏览器不支持getUserMedia');
                        updateStatusIndicator('浏览器不支持麦克风访问', 'error');
                        return;
                    }
                    
                    console.log('正在请求麦克风权限...');
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function (stream) {
                            console.log('麦克风权限获取成功，音频流:', stream);
                            mediaStream = stream;

                            mainScreen.style.display = 'none';
                            practiceScreen.style.display = 'flex';
                            document.getElementById('pitchDisplay').style.display = 'block';

                            requestWakeLock();

                            state.nextExerciseInfo = '';
                            state.nextExerciseIntervals = [];

                            console.log('开始生成练习...');
                            generateExercise();

                            console.log('开始录音...');
                            startRecording();

                            state.metronomeEnabled = document.getElementById('metronomeToggle').checked;
                            state.metronomeTempo = parseInt(document.getElementById('metronomeTempo').value);
                            state.metronomeFlashEnabled = document.getElementById('metronomeFlashToggle').checked;
                            state.metronomeSoundEnabled = document.getElementById('metronomeSoundToggle').checked;

                            if (state.metronomeEnabled) {
                                startMetronome();
                                practiceScreen.classList.add('metronome-active');
                            }
                        })
                        .catch(function (err) {
                            console.error('麦克风获取失败:', err);
                            console.error('错误类型:', err.name);
                            console.error('错误信息:', err.message);

                            updateStatusIndicator('未获取录音权限', 'error');

                            const errorMessage = document.createElement('div');
                            errorMessage.style.position = 'fixed';
                            errorMessage.style.top = '50%';
                            errorMessage.style.left = '50%';
                            errorMessage.style.transform = 'translate(-50%, -50%)';
                            errorMessage.style.background = 'rgba(239, 68, 68, 0.9)';
                            errorMessage.style.color = 'white';
                            errorMessage.style.padding = '20px';
                            errorMessage.style.borderRadius = '10px';
                            errorMessage.style.zIndex = '2000';
                            errorMessage.style.maxWidth = '80%';
                            errorMessage.style.textAlign = 'center';
                            errorMessage.innerHTML = `
                                <h3 style="margin-bottom: 10px; font-size: 18px;">麦克风权限被拒绝</h3>
                                <p style="margin-bottom: 15px;">此应用需要麦克风权限才能检测音高。</p>
                                <p>请按照以下步骤操作：</p>
                                <ol style="text-align: left; margin: 15px 0; padding-left: 20px;">
                                    <li>点击浏览器地址栏左侧的锁定/信息图标</li>
                                    <li>在弹出的菜单中找到"麦克风"选项</li>
                                    <li>将其设置为"允许"</li>
                                    <li>刷新页面后重试</li>
                                </ol>
                                <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                    <button id="refreshPage" style="padding: 8px 16px; background: #3a9fc4; border: none; border-radius: 5px; color: white; cursor: pointer;">刷新页面</button>
                                    <button id="returnToMain" style="padding: 8px 16px; background: #6c757d; border: none; border-radius: 5px; color: white; cursor: pointer;">返回主菜单</button>
                                </div>
                            `;
                            document.body.appendChild(errorMessage);

                            document.getElementById('refreshPage').addEventListener('click', function() {
                                location.reload();
                            });
                            
                            document.getElementById('returnToMain').addEventListener('click', function () {
                                document.body.removeChild(errorMessage);
                                updateStatusIndicator('准备就绪', 'ready');
                            });
                        });
                });

                // 底部导航栏切换
                const bottomNavItems = document.querySelectorAll('.nav-item');
                bottomNavItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const tabName = this.dataset.tab;

                        // 移除所有导航项的active状态
                        bottomNavItems.forEach(navItem => navItem.classList.remove('active'));
                        // 为当前点击的导航项添加active状态
                        this.classList.add('active');

                        // 默认隐藏所有设置区域
                        scaleSettings.style.display = 'none';
                        chordSettings.style.display = 'none';
                        progressionSettings.style.display = 'none';
                        deviceSettings.style.display = 'none';

                        // 根据标签页显示对应设置
                        if (tabName === 'scale') {
                            scaleSettings.style.display = 'block';
                            // 更新音阶练习按钮显示
                            updateArpeggioButtons();
                        } else if (tabName === 'chord') {
                            chordSettings.style.display = 'block';
                            // 更新音阶练习按钮显示，确保移除动态按钮
                            updateArpeggioButtons();
                        } else if (tabName === 'progression') {
                            progressionSettings.style.display = 'block';
                            // 更新音阶练习按钮显示，确保移除动态按钮
                            updateArpeggioButtons();
                        } else if (tabName === 'device') {
                            deviceSettings.style.display = 'block';
                            // 更新音阶练习按钮显示，确保移除动态按钮
                            updateArpeggioButtons();
                        }
                        
                        // 控制开始练习按钮的显示
                        const controls = document.querySelector('.controls');
                        if (controls) {
                            // 在设置标签页中隐藏开始练习按钮
                            if (tabName === 'device') {
                                controls.style.display = 'none';
                            } else {
                                controls.style.display = 'flex';
                            }
                        }
                    });
                });

                // 初始化显示音阶设置（如果是音阶练习标签页）
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                if (activeTab === 'scale') {
                    scaleSettings.style.display = 'block';
                }
                
                // 初始化时根据默认选中的标签页来控制按钮的显示
                const controls = document.querySelector('.controls');
                if (controls) {
                    // 在设置标签页中隐藏开始练习按钮
                    if (activeTab === 'device') {
                        controls.style.display = 'none';
                    } else {
                        controls.style.display = 'flex';
                    }
                }

                // 和弦类型按钮点击事件
                chordTypeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                    });
                });

                // 音阶顺序按钮点击事件
                const scaleOrderBtns = document.querySelectorAll('.scale-order-btn');
                scaleOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // 练习序列按钮点击事件
                const scaleArpeggioBtns = document.querySelectorAll('.scale-arpeggio-btn');
                scaleArpeggioBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleArpeggioBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // 当按钮被点击时，更新按钮显示以反映当前音阶
                        updateArpeggioButtons();
                    });
                });

                // 和弦顺序按钮点击事件
                const chordOrderBtns = document.querySelectorAll('.chord-order-btn');
                chordOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        chordOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // 和弦转换顺序按钮点击事件
                const progressionOrderBtns = document.querySelectorAll('.progression-order-btn');
                progressionOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        progressionOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // 点击练习屏幕返回主页面
                // 修改练习屏幕点击事件，确保退出时重置冷却期
                practiceScreen.addEventListener('click', function () {
                    updateStatusIndicator('正在停止录音...', 'ready');

                    // 重置和弦转换练习的会话状态
                    state.isInProgressionSession = false;

                    // 只有在启用冷却时间时才重置冷却期状态
                    if (state.enableCooldown) {
                        state.isCoolingDown = false;
                        if (state.cooldownTimeout) {
                            clearTimeout(state.cooldownTimeout);
                            state.cooldownTimeout = null;
                        }
                    }

                    setTimeout(() => {
                        stopRecording();
                        stopMetronome();
                        //releaseWakeLock();

                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';

                        updateStatusIndicator('准备就绪', 'ready');
                    }, 300);
                });
                // 页面关闭时完全关闭麦克风
                window.addEventListener('beforeunload', function () {
                    closeMicrophone();
                });
            }

            // 初始化应用
            function initApp() {
                if (typeof Pitchfinder === 'undefined') {
                    console.error('PitchFinder库加载失败，请检查网络连接');
                    alert('音高检测库加载失败，请检查网络连接后刷新页面');
                } else {
                    console.log('PitchFinder库加载成功');
                }

                // 获取音频设备列表
                getAudioDevices();

                initEventListeners();
                initKeyboardShortcuts();
                requestRecordPermission();
            }

            // 初始化键盘快捷键
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && practiceScreen.style.display === 'flex') {
                        practiceScreen.click();
                    }

                    if (e.key === ' ' && practiceScreen.style.display === 'flex') {
                        generateExercise();
                    }
                });
            }

            // 更新状态指示器
            function updateStatusIndicator(status, type = 'ready') {
                statusIndicator.textContent = status;
                statusIndicator.className = `status-indicator status-${type}`;
            }

            // 自定义和弦功能
            const useCustomChords = document.getElementById('useCustomChords');
            const customChordsControls = document.getElementById('customChordsControls');
            const customChordRoot = document.getElementById('customChordRoot');
            const customChordType = document.getElementById('customChordType');
            const addCustomChord = document.getElementById('addCustomChord');
            const customChordSequence = document.getElementById('customChordSequence');
            const clearCustomChords = document.getElementById('clearCustomChords');
            const saveCustomChords = document.getElementById('saveCustomChords');
            const loadCustomChords = document.getElementById('loadCustomChords');
            const sequenceName = document.getElementById('sequenceName');

            // 自定义和弦开关控制
            useCustomChords.addEventListener('change', function () {
                customChordsControls.style.display = this.checked ? 'block' : 'none';
            });

            // 添加自定义和弦
            addCustomChord.addEventListener('click', function () {
                const root = customChordRoot.value;
                const type = customChordType.value;
                const chordName = `${root}${type === 'major' ? '' : type === 'minor' ? 'm' : type === 'dominant7' ? '7' : type === 'major7' ? 'maj7' : type === 'minor7' ? 'm7' : type === 'sus2' ? 'sus2' : 'sus4'}`;

                const chordItem = document.createElement('div');
                chordItem.className = 'chord-item';
                chordItem.innerHTML = `
                    <span class="chord-name">${chordName}</span>
                    <button class="remove-chord" data-root="${root}" data-type="${type}">×</button>
                `;

                customChordSequence.appendChild(chordItem);

                // 添加删除事件
                chordItem.querySelector('.remove-chord').addEventListener('click', function () {
                    chordItem.remove();
                });
            });

            // 清空自定义和弦序列
            clearCustomChords.addEventListener('click', function () {
                customChordSequence.innerHTML = '<div class="empty-sequence">暂无和弦，请添加</div>';
            });

            // 保存和弦序列到本地存储
            saveCustomChords.addEventListener('click', function () {
                const chords = [];
                const chordElements = customChordSequence.querySelectorAll('.chord-item');

                chordElements.forEach(el => {
                    const root = el.querySelector('.remove-chord').dataset.root;
                    const type = el.querySelector('.remove-chord').dataset.type;
                    chords.push({ root, type });
                });

                const name = sequenceName.value || '未命名序列';
                const songData = {
                    name,
                    chords,
                    timestamp: new Date().toISOString()
                };

                // 创建文件保存对话框
                const jsonStr = JSON.stringify([songData], null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download = `${name.replace(/[\/\\?%*:|"<>]/g, '')}_和弦序列.json`;
                document.body.appendChild(a);
                a.click();

                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);

                // 同时保存到本地存储
                const sequences = JSON.parse(localStorage.getItem('customChordSequences') || '[]');
                sequences.push(songData);
                localStorage.setItem('customChordSequences', JSON.stringify(sequences));
            });

            // 加载本地和弦进行
            // 加载本地和弦进行
            document.getElementById('loadLocalChords').addEventListener('click', function () {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.json';

                fileInput.addEventListener('change', function (e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = function (e) {
                        try {
                            const data = JSON.parse(e.target.result);

                            // 处理多首歌曲格式（数组形式）
                            if (Array.isArray(data)) {
                                if (data.length === 0) {
                                    alert('文件为空，没有可加载的歌曲');
                                } else if (data.length === 1) {
                                    loadAndStartPractice(data[0]);
                                } else {
                                    showSongSelectionDialog(data);
                                }
                            }
                            // 处理单首歌曲格式（对象形式）
                            else if (data && Array.isArray(data.chords)) {
                                loadAndStartPractice(data);
                            } else {
                                alert('无效的和弦进行文件格式');
                            }
                        } catch (err) {
                            alert('解析文件失败: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                });

                fileInput.click();

                function loadAndStartPractice(songData) {
                    customChordSequence.innerHTML = '';
                    sequenceName.value = songData.name || '未命名序列';

                    songData.chords.forEach(chord => {
                        const chordName = `${chord.root}${chord.type === 'major' ? '' :
                            chord.type === 'minor' ? 'm' :
                                chord.type === 'dominant7' ? '7' :
                                    chord.type === 'major7' ? 'maj7' :
                                        chord.type === 'minor7' ? 'm7' :
                                            chord.type === 'sus2' ? 'sus2' : 'sus4'}`;

                        const chordItem = document.createElement('div');
                        chordItem.className = 'chord-item';
                        chordItem.innerHTML = `
                    <span class="chord-name">${chordName}</span>
                    <button class="remove-chord" data-root="${chord.root}" data-type="${chord.type}">×</button>
                `;

                        customChordSequence.appendChild(chordItem);

                        chordItem.querySelector('.remove-chord').addEventListener('click', function () {
                            chordItem.remove();
                        });
                    });

                    // 确保自定义和弦模式开启
                    useCustomChords.checked = true;
                    customChordsControls.style.display = 'block';

                    // 重置自定义和弦索引
                    state.customChordIndex = 0;

                    // 预加载第一个和弦
                    const firstChord = songData.chords[0];
                    state.nextExerciseInfo = `${firstChord.root}${firstChord.type === 'major' ? '' :
                        firstChord.type === 'minor' ? 'm' :
                            firstChord.type === 'dominant7' ? '7' :
                                firstChord.type === 'major7' ? 'maj7' :
                                    firstChord.type === 'minor7' ? 'm7' :
                                        firstChord.type === 'sus2' ? 'sus2' : 'sus4'}`;
                    state.nextExerciseIntervals = [...chordTypes[firstChord.type].intervals];

                    // 自动开始练习
                    setTimeout(() => {
                        mainScreen.style.display = 'none';
                        practiceScreen.style.display = 'flex';
                        document.getElementById('pitchDisplay').style.display = 'block';
                        requestWakeLock();
                        generateExercise();
                        startRecording();

                        // 启用节拍器（如果已选中）
                        if (metronomeToggleEl.checked) {
                            startMetronome();
                        }
                    }, 300);
                }

                function showSongSelectionDialog(songs) {
                    const dialog = document.createElement('div');
                    dialog.className = 'sequence-dialog';
                    dialog.style.width = '80%';
                    dialog.style.maxWidth = '500px';
                    dialog.innerHTML = `
                        <h3 style="margin-bottom: 15px; color: #3a9fc4;">选择要加载的歌曲</h3>
                        <select id="songSelector" style="width: 100%; padding: 10px; margin-bottom: 15px; 
                         background: #2c2c3c; color: white; border: 1px solid #555; border-radius: 6px;">
                         ${songs.map(song => `
                        <option value="${songs.indexOf(song)}">
                        ${song.name || '未命名'} (${song.chords.map(chord => {
                        let suffix = '';
                        switch (chord.type) {
                            case 'major': suffix = ''; break;
                            case 'minor': suffix = 'm'; break;
                            case 'dominant7': suffix = '7'; break;
                            case 'major7': suffix = 'maj7'; break;
                            case 'minor7': suffix = 'm7'; break;
                            case 'sus2': suffix = 'sus2'; break;
                            case 'sus4': suffix = 'sus4'; break;
                            default: suffix = '';
                        }
                        return `${chord.root}${suffix}`;
                    }).join(' ')})
                        </option>
                            `).join('')}
                        </select>
                        <div style="display: flex; gap: 10px;">
                            <button id="confirmLoad" style="flex: 1; padding: 10px; background: #3a9fc4; 
                                border: none; border-radius: 6px; color: white; cursor: pointer;">
                                加载并开始练习
                            </button>
                            <button id="cancelLoad" style="flex: 1; padding: 10px; background: #555; 
                                border: none; border-radius: 6px; color: white; cursor: pointer;">
                                取消
                            </button>
                        </div>
                    `;

                    document.body.appendChild(dialog);

                    document.getElementById('confirmLoad').addEventListener('click', function () {
                        const selectedIndex = document.getElementById('songSelector').value;
                        loadAndStartPractice(songs[selectedIndex]);
                        document.body.removeChild(dialog);
                    });

                    document.getElementById('cancelLoad').addEventListener('click', function () {
                        document.body.removeChild(dialog);
                    });
                }
            });


            // 加载当前自定义和弦序列并开始练习
            document.getElementById('loadSequence').addEventListener('click', function () {
                const chordItems = customChordSequence.querySelectorAll('.chord-item');
                if (chordItems.length === 0) {
                    alert('请先添加自定义和弦');
                    return;
                }

                // 确保自定义和弦模式开启
                useCustomChords.checked = true;
                customChordsControls.style.display = 'block';

                // 重置自定义和弦索引
                state.customChordIndex = 0;

                // 自动开始练习
                setTimeout(() => {
                    mainScreen.style.display = 'none';
                    practiceScreen.style.display = 'flex';
                    document.getElementById('pitchDisplay').style.display = 'block';
                    requestWakeLock();
                    generateExercise();
                    startRecording();

                    // 启用节拍器（如果已选中）
                    if (metronomeToggleEl.checked) {
                        startMetronome();
                    }
                }, 300);
            });

            // 修改generateChordExercise函数以支持自定义和弦
            function originalGenerateChordExercise() {
                try {
                    // 清除之前的状态信息，确保从当前选中的和弦类型生成
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // 清除之前的和弦类型
                    
                    let rootNote = chordRootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    state.rootNote = rootNote;

                    const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                    let chordType = 'major';
                    if (activeChordTypes.length > 0) {
                        const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                        chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                    } else {
                        // 如果没有选中任何和弦类型，不生成默认和弦，而是直接返回空值
                        console.warn('没有选中任何和弦类型，无法生成下一题');
                        return; // 不生成下一题
                    }
                    state.chordType = chordType;

                    // 检查和弦类型是否存在
                    if (!chordTypes[chordType]) {
                        throw new Error(`未知的和弦类型: ${chordType}`);
                    }

                    state.currentIntervals = [...chordTypes[chordType].intervals];

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // 下行模式：倒序排列
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    const chordSymbol = formatChordSymbol(rootNote, chordType);
                    targetIntervalEl.textContent = chordSymbol;
                    displaySequence();
                    
                    // 预生成下一题
                    generateNextExercise();
                } catch (error) {
                    console.error('生成和弦练习失败:', error);
                    updateStatusIndicator('和弦练习生成失败: ' + error.message, 'error');
                    // 回退到默认和弦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // 生成和弦转换练习
            function generateProgressionExercise() {
                const jazzStandardEl = document.getElementById('jazzStandard');
                const progressionKeyEl = document.getElementById('progressionKey');
                const progressionLevelEl = document.getElementById('progressionLevel');
                const enableRepeatEl = document.getElementById('enableRepeat');
                const songTitleEl = document.getElementById('songTitle');
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                
                const selectedSong = jazzStandardEl.value;
                if (!selectedSong) {
                    alert('请选择一首歌曲');
                    return;
                }

                // 显示乐曲名
                songTitleEl.textContent = selectedSong;
                songTitleDisplayEl.style.display = 'block';

                // 获取歌曲和弦进行数据
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][selectedSong]) {
                        songData = jazzStandards[letter][selectedSong];
                        break;
                    }
                }

                if (!songData) {
                    alert('找不到歌曲和弦进行');
                    return;
                }

                // 获取原调和音级和弦进行
                const originalKey = songData.key;
                const degreeChords = [...songData.chords];
                
                // 调性转换
                let chords = [];
                const selectedKey = progressionKeyEl.value;
                
                // 移调到目标调
                chords = degreeChords.map(degreeChord => 
                    transposeChordFromDegree(degreeChord, originalKey, selectedKey)
                );

                
                // 显示调性转换信息（调试用）
                const keyInfo = selectedKey === originalKey ? 
                    `原调：${originalKey}` : 
                    `${originalKey} → ${selectedKey}`;
                console.log(`歌曲：${selectedSong}`);
                console.log(`调性转换：${keyInfo}`);
                console.log(`音级和弦：`, degreeChords);
                console.log(`转换后和弦：`, chords);

                // 应用和弦进行的顺序设置（顺序按钮控制整个和弦进行的顺序）
                const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                
                if (order === 'reverse') {
                    chords = chords.reverse();
                } else if (order === 'random') {
                    // 打乱和弦顺序
                    for (let i = chords.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [chords[i], chords[j]] = [chords[j], chords[i]];
                    }
                }

                // 初始化或重置和弦进行索引（当歌曲或设置改变时）
                const currentOrderBtn = document.querySelector('.progression-order-btn.active');
                const currentOrder = currentOrderBtn ? currentOrderBtn.dataset.value : 'ordered';
                const currentKey = progressionKeyEl.value;
                const currentLevel = progressionLevelEl.value;
                
                // 只有在歌曲、顺序、调性或等级改变时才重置，否则保持当前进度
                if (!state.progressionChords || 
                    state.progressionSong !== selectedSong ||
                    state.progressionOrder !== currentOrder ||
                    state.progressionKey !== currentKey ||
                    state.progressionLevel !== currentLevel) {
                    
                    state.progressionChords = chords;
                    state.progressionSong = selectedSong;
                    state.progressionOrder = currentOrder;
                    state.progressionKey = currentKey;
                    state.progressionLevel = currentLevel;
                    state.progressionIndex = 0; // 重新开始
                }
                
                // 每次开始新的练习会话时，都从第一个和弦开始
                if (!state.isInProgressionSession) {
                    state.progressionIndex = 0;
                    state.isInProgressionSession = true;
                }

                // 检查是否已完成所有和弦
                if (state.progressionIndex >= chords.length) {
                    const isRepeatEnabled = enableRepeatEl.checked;
                    if (isRepeatEnabled) {
                        state.progressionIndex = 0; // 重新开始
                    } else {
                        // 直接退出练习界面，不弹出提示窗口
                        stopRecording();
                        stopMetronome();
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        updateStatusIndicator('练习已完成', 'ready');
                        
                        // 重置和弦转换练习的会话状态
                        state.isInProgressionSession = false;
                        return;
                    }
                }

                const currentChord = chords[state.progressionIndex];
                const { root, type } = parseChordSymbol(currentChord);

                state.rootNote = root;
                state.chordType = type;

                // 根据练习等级生成音程
                const level = progressionLevelEl.value;
                let intervals = getIntervalsForLevel(level);

                state.currentIntervals = intervals;
                targetIntervalEl.textContent = currentChord; // 只显示和弦名，不显示歌曲名
                displaySequence();

                // 准备下一个和弦（保持相同的顺序）
                const nextIndex = (state.progressionIndex + 1) % chords.length;
                const isRepeatEnabled = enableRepeatEl.checked;
                
                if (isRepeatEnabled || nextIndex !== 0) {
                    const nextChord = chords[nextIndex];
                    state.nextExerciseInfo = nextChord; // 只显示和弦名
                    
                    // 为下一个和弦生成音程
                    state.nextExerciseIntervals = getIntervalsForLevel(level);
                } else {
                    state.nextExerciseInfo = '练习完成';
                    state.nextExerciseIntervals = [];
                }
                
                // 更新下一题显示
                updateNextExerciseDisplay();

                // 更新索引准备下一题
                state.progressionIndex++;
            }
            
            // 根据练习等级获取对应的音程
            function getIntervalsForLevel(level) {
                let intervals = [];
                
                switch (level) {
                    // 单和弦音
                    case 'single-root':
                        intervals = ['1'];
                        break;
                    case 'single-3':
                        intervals = ['3'];
                        break;
                    case 'single-5':
                        intervals = ['5'];
                        break;
                    case 'single-7':
                        intervals = ['7'];
                        break;
                    
                    // 双和弦音
                    case 'double-root-3':
                        intervals = ['1', '3'];
                        break;
                    case 'double-root-5':
                        intervals = ['1', '5'];
                        break;
                    case 'double-root-7':
                        intervals = ['1', '7'];
                        break;
                    case 'double-3-5':
                        intervals = ['3', '5'];
                        break;
                    case 'double-3-7':
                        intervals = ['3', '7'];
                        break;
                    case 'double-5-7':
                        intervals = ['5', '7'];
                        break;
                    
                    // 三和弦音
                    case 'triple-root-3-5':
                        intervals = ['1', '3', '5'];
                        break;
                    case 'triple-3-5-7':
                        intervals = ['3', '5', '7'];
                        break;
                    case 'triple-random-inversion':
                        // 1,3,5随机转位
                        const tripleInversions = [
                            ['1', '3', '5'], // 原位
                            ['3', '5', '1'], // 第一转位  
                            ['5', '1', '3']  // 第二转位
                        ];
                        intervals = tripleInversions[Math.floor(Math.random() * tripleInversions.length)];
                        break;
                    
                    // 四和弦音
                    case 'quad-root-3-5-7':
                        intervals = ['1', '3', '5', '7'];
                        break;
                    case 'quad-3-5-7-root':
                        intervals = ['3', '5', '7', '1'];
                        break;
                    case 'quad-5-7-root-3':
                        intervals = ['5', '7', '1', '3'];
                        break;
                    case 'quad-7-root-3-5':
                        intervals = ['7', '1', '3', '5'];
                        break;
                    case 'quad-random-inversion':
                        // 1,3,5,7随机转位
                        const quadInversions = [
                            ['1', '3', '5', '7'], // 原位
                            ['3', '5', '7', '1'], // 第一转位
                            ['5', '7', '1', '3'], // 第二转位
                            ['7', '1', '3', '5']  // 第三转位
                        ];
                        intervals = quadInversions[Math.floor(Math.random() * quadInversions.length)];
                        break;
                    case 'quad-root-3-5-7-root':
                        intervals = ['1', '3', '5', '7', '1'];
                        break;
                    
                    default:
                        intervals = ['1', '3', '5'];
                }
                
                return intervals;
            }
            
            // 获取和弦的特定音级对应的音符
            function getChordTone(root, chordType, interval) {
                const noteIndex = notes.indexOf(root);
                if (noteIndex === -1) return null;
                
                let semitones = 0;
                
                // 根据音级和和弦类型计算半音数
                switch (interval) {
                    case '1':
                        semitones = 0; // 根音
                        break;
                    case '3':
                        // 三音：大三度或小三度
                        if (chordType === 'minor' || chordType === 'minor7' || chordType === 'minor6' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 3; // 小三度
                        } else {
                            semitones = 4; // 大三度
                        }
                        break;
                    case '5':
                        // 五音：纯五度或减五度
                        if (chordType === 'minor7b5') {
                            semitones = 6; // 减五度
                        } else {
                            semitones = 7; // 纯五度
                        }
                        break;
                    case '7':
                        // 七音：大七度或小七度
                        if (chordType === 'major7' || chordType === 'major9') {
                            semitones = 11; // 大七度
                        } else if (chordType === 'dominant7' || chordType === 'minor7' || chordType === 'dominant9' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 10; // 小七度
                        } else {
                            semitones = 11; // 默认大七度
                        }
                        break;
                    default:
                        semitones = 0;
                }
                
                const targetIndex = (noteIndex + semitones) % 12;
                return notes[targetIndex];
            }


            // 解析和弦符号
            function parseChordSymbol(chordSymbol) {
                // 简化的和弦解析，支持常见的爵士和弦
                const match = chordSymbol.match(/^([A-G][♯♭]?)(.*)$/);
                if (!match) return { root: 'C', type: 'major' };
                
                const root = match[1]; // 保持原始符号
                const suffix = match[2];
                
                let type = 'major';
                if (suffix === 'm' || suffix === 'min') {
                    type = 'minor';
                } else if (suffix === '7') {
                    type = 'dominant7';
                } else if (suffix === 'maj7' || suffix === 'M7') {
                    type = 'major7';
                } else if (suffix === 'm7') {
                    type = 'minor7';
                } else if (suffix === 'm7♭5') {
                    type = 'minor7b5';
                } else if (suffix === '6') {
                    type = 'major6';
                } else if (suffix === 'm6') {
                    type = 'minor6';
                } else if (suffix === '9') {
                    type = 'dominant9';
                } else if (suffix === 'maj9' || suffix === 'M9') {
                    type = 'major9';
                } else if (suffix === 'm9') {
                    type = 'minor9';
                } else if (suffix === 'sus2') {
                    type = 'sus2';
                } else if (suffix === 'sus4') {
                    type = 'sus4';
                }
                
                return { root, type };
            }

            // 提取音阶名称（不包含结构信息）
            function getScaleDisplayName(scaleName) {
                // 从完整名称中提取音阶名称，移除结构部分
                // 例如："Major" -> "Major"
                // 例如："Dorian - 1 2 ♭3 4 5 6 ♭7" -> "Dorian"
                
                let displayName = scaleName;
                
                // 移除括号部分，如 (Ionian)
                displayName = displayName.replace(/\s*\([^)]*\)\s*/g, '');
                
                // 移除破折号及其后面的所有内容（音程结构）
                const dashIndex = displayName.indexOf(' - ');
                if (dashIndex !== -1) {
                    displayName = displayName.substring(0, dashIndex);
                }
                
                return displayName.trim();
            }

            // 格式化和弦符号
            function formatChordSymbol(rootNote, chordType) {
                const suffixMap = {
                    // 基础三和弦
                    'major': '',
                    'minor': 'm',
                    'diminished': 'dim',
                    'augmented': 'aug',
                    
                    // 六和弦
                    'major6': '6',
                    'minor6': 'm6',
                    
                    // 七和弦
                    'dominant7': '7',
                    'major7': 'maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7♭5',
                    'diminished7': 'dim7',
                    
                    // 九和弦
                    'dominant9': '9',
                    'major9': 'maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7♯9',
                    'dominant7flat9': '7♭9',
                    
                    // 十一和弦
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7♯11',
                    
                    // 十三和弦
                    'dominant13': '13',
                    'minor13': 'm13',
                    
                    // 挂留和弦
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    
                    // 加音和弦
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                return `${rootNote}${suffixMap[chordType] || ''}`;
            }

            // 解析和弦符号
            function parseChordSymbol(chordSymbol) {
                const match = chordSymbol.match(/^([A-G][\u266f\u266d]?)(.*)$/);
                if (!match) {
                    return { root: 'C', type: 'major' };
                }
                
                const root = match[1];
                const suffix = match[2];
                
                // 创建后缀到和弦类型的映射
                const typeMap = {
                    '': 'major',
                    'm': 'minor',
                    'dim': 'diminished',
                    'aug': 'augmented',
                    '6': 'major6',
                    'm6': 'minor6',
                    '7': 'dominant7',
                    'maj7': 'major7',
                    'm7': 'minor7',
                    'm7♭5': 'minor7b5',
                    'dim7': 'diminished7',
                    '9': 'dominant9',
                    'maj9': 'major9',
                    'm9': 'minor9',
                    '7♯9': 'dominant7sharp9',
                    '7♭9': 'dominant7flat9',
                    '11': 'dominant11',
                    'm11': 'minor11',
                    '7♯11': 'dominant7sharp11',
                    '13': 'dominant13',
                    'm13': 'minor13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                const type = typeMap[suffix] || 'major';
                return { root, type };
            }

            // 更新调性选择器，设置歌曲的原调为默认选项
            function updateKeySelector(songName) {
                const progressionKeyEl = document.getElementById('progressionKey');
                
                // 获取歌曲数据
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][songName]) {
                        songData = jazzStandards[letter][songName];
                        break;
                    }
                }
                
                if (!songData) return;
                
                const originalKey = songData.key;
                
                // 重新生成选项列表
                const allKeys = ['C', 'C♯', 'D♭', 'D', 'D♯', 'E♭', 'E', 'F', 'F♯', 'G♭', 'G', 'G♯', 'A♭', 'A', 'A♯', 'B♭', 'B'];
                
                progressionKeyEl.innerHTML = '';
                
                allKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    
                    if (key === originalKey) {
                        option.textContent = `${key} 默认`;
                        option.selected = true;
                    } else {
                        option.textContent = key;
                    }
                    
                    progressionKeyEl.appendChild(option);
                });
            }
            
            // 大调音阶的音级对应关系
            const majorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5, 
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // 小调音阶的音级对应关系（以自然小调为基础）
            const minorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5,
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // 十二平均律音名数组
            const chromaticNotes = ['C', 'C♯', 'D', 'E♭', 'E', 'F', 'F♯', 'G', 'A♭', 'A', 'B♭', 'B'];
            const chromaticNotesFlat = ['C', 'D♭', 'D', 'E♭', 'E', 'F', 'G♭', 'G', 'A♭', 'A', 'B♭', 'B'];
            
            // 音名到数字的映射
            const noteToNumber = {
                'C': 0, 'C♯': 1, 'D♭': 1, 'D': 2, 'D♯': 3, 'E♭': 3, 'E': 4, 'F': 5,
                'F♯': 6, 'G♭': 6, 'G': 7, 'G♯': 8, 'A♭': 8, 'A': 9, 'A♯': 10, 'B♭': 10, 'B': 11
            };
            
            // 根据调性选择合适的音名数组（优先使用升号或降号）
            function getNotesForKey(key) {
                // 升号调：G, D, A, E, B, F♯, C♯
                const sharpKeys = ['G', 'D', 'A', 'E', 'B', 'F♯', 'C♯'];
                // 降号调：F, B♭, E♭, A♭, D♭, G♭, C♭
                const flatKeys = ['F', 'B♭', 'E♭', 'A♭', 'D♭', 'G♭', 'C♭'];
                
                if (sharpKeys.includes(key)) {
                    return chromaticNotes; // 使用升号
                } else {
                    return chromaticNotesFlat; // 使用降号
                }
            }
            
            // 解析罗马数字级数
            function parseRomanNumeral(roman) {
                // 匹配罗马数字部分（包括可能的降号前缀）
                const match = roman.match(/^(b?)([IVX]+|[ivx]+)/); 
                if (!match) {
                    console.warn(`Cannot parse roman numeral: ${roman}`);
                    return { degree: 'I', isMinor: false, suffix: '' };
                }
                
                const flatPrefix = match[1]; // 'b' 或空字符串
                const romanPart = match[2];
                const suffix = roman.replace(match[0], ''); // 移除罗马数字部分后的部分
                
                // 判断是否为小写（小调）
                const isMinor = /[ivx]/.test(romanPart);
                const upperRoman = flatPrefix + romanPart.toUpperCase();
                
                return {
                    degree: upperRoman,
                    isMinor: isMinor,
                    suffix: suffix
                };
            }
            
            // 将音级转换为具体的音名
            function degreeToNote(degree, keyRoot, keyMode = 'major') {
                const keyRootNumber = noteToNumber[keyRoot];
                const scaleDegrees = keyMode === 'major' ? majorScaleDegrees : minorScaleDegrees;
                
                if (!(degree in scaleDegrees)) {
                    console.warn(`Unknown degree: ${degree}`);
                    return keyRoot;
                }
                
                const semitones = scaleDegrees[degree];
                const resultNumber = (keyRootNumber + semitones) % 12;
                
                const notesArray = getNotesForKey(keyRoot);
                return notesArray[resultNumber];
            }
            
            // 将基于音级的和弦转换为具体调性的和弦
            function transposeChordFromDegree(degreeChord, originalKey, targetKey) {
                const parsed = parseRomanNumeral(degreeChord);
                const targetNote = degreeToNote(parsed.degree, targetKey, 'major');
                
                // 构建和弦符号
                let chordSymbol = targetNote;
                
                // 添加和弦类型
                if (parsed.isMinor) {
                    chordSymbol += 'm';
                }
                
                // 添加其他后缀
                chordSymbol += parsed.suffix;
                
                // 处理特殊符号替换
                chordSymbol = chordSymbol.replace('M7', 'maj7').replace('M', 'maj');
                
                return chordSymbol;
            }

            // 启动应用
            initApp();
        });
    </script>
</body>

</html>