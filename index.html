<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="msapplication-navbutton-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title data-i18n-key="page_title">ğŸ¸ å‰ä»–ç»ƒä¹ å·¥å…· v0.361</title>
    <!-- ml5.jsåº“ - ç”¨äºCREPEéŸ³é«˜æ£€æµ‹ç®—æ³• -->
    <script src="js/ml5.min.js"></script>

    
    <!-- å¼•å…¥å¤–éƒ¨CSSæ–‡ä»¶ -->
    <link rel="stylesheet" href="styles/main.css">
    
    <!-- å†…è”i18næ ¸å¿ƒåŠŸèƒ½ -->
    <script>
        // å†…è”i18næ ¸å¿ƒåŠŸèƒ½
        (function() {
            
            // å®šä¹‰è¯­è¨€æ•°æ®
            const translations = {
                'zh-CN': {
                    'app_title': 'ğŸ¸ å‰ä»–æŒ‡æ¿è§†è§‰åŒ–ç»ƒä¹ å·¥å…·',
                 
                    'page_title': 'å‰ä»–æŒ‡æ¿è§†è§‰åŒ–ç»ƒä¹ å·¥å…·',
                    'btn_start': 'å¼€å§‹ç»ƒä¹ ',
                    'status_ready': 'å‡†å¤‡å°±ç»ª',
                    'lang_zh': 'ä¸­æ–‡',
                    'lang_en': 'English',
                    'nav_scale': 'éŸ³é˜¶ç»ƒä¹ ',
                    'nav_chord': 'å’Œå¼¦ç»ƒä¹ ',
                    'nav_progression': 'å’Œå¼¦è¿›è¡Œ',
                    'nav_pitch_finding': 'éŸ³ç¨‹ç»ƒä¹ ',
                    'settings_pitch_finding': 'éŸ³ç¨‹ç»ƒä¹ è®¾ç½®',
                    'nav_settings': 'è®¾ç½®',
                    'settings_scale': 'éŸ³é˜¶ç»ƒä¹ é€‰é¡¹',
                    'settings_chord': 'å’Œå¼¦ç»ƒä¹ é€‰é¡¹',
                    'settings_device': 'è®¾å¤‡è®¾ç½®',
                    'settings_general': 'é€šç”¨è®¾ç½®',
                    'general_language': 'è¯­è¨€è®¾ç½®',
                    'interface_language': 'ç•Œé¢è¯­è¨€',
                    'test_language_switch': 'æµ‹è¯•è¯­è¨€åˆ‡æ¢',
                    
                    // å¿«æ·é”®æç¤º
                    'shortcut_hint': 'æŒ‰ ESC è¿”å›ä¸»èœå•',
                    
                    // éŸ³é«˜æ˜¾ç¤º
                    'pitch_display': 'éŸ³é«˜',
                    'cents_display': 'éŸ³åˆ†å·®',
                    
                    // å’Œå¼¦è®¾ç½®
                    'chord_root_note': 'æ ¹éŸ³',
                    'chord_root_note_hint': 'é€‰æ‹©å’Œå¼¦çš„æ ¹éŸ³',
                    'chord_type': 'å’Œå¼¦ç±»å‹',
                    'chord_type_hint': 'é€‰æ‹©è¦ç»ƒä¹ çš„å’Œå¼¦ç±»å‹',
                    'chord_order': 'é¡ºåº',
                    'chord_order_hint': 'é€‰æ‹©å’Œå¼¦éŸ³ç¬¦çš„æ¼”å¥é¡ºåº',
                    'chord_custom': 'è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ',
                    
                    // å’Œå¼¦è½¬ä½è®¾ç½®
                    'chord_bass_note': 'ä½éŸ³éŸ³ç¬¦',
                    'chord_bass_root': 'æ ¹éŸ³',
                    'chord_bass_3rd': 'ä¸‰éŸ³',
                    'chord_bass_5th': 'äº”éŸ³',
                    'chord_bass_7th': 'ä¸ƒéŸ³',
                    'chord_bass_random': 'éšæœº',

                    
                    // é¡ºåºæŒ‰é’®
                    'order_ascending': 'ä¸Šè¡Œ',
                    'order_descending': 'ä¸‹è¡Œ',
                    'order_random': 'éšæœº',
                    
                    // å’Œå¼¦ç±»å‹
                    'chord_major': 'å¤§ä¸‰å’Œå¼¦',
                    'chord_minor': 'å°ä¸‰å’Œå¼¦',
                    'chord_dim': 'å‡ä¸‰å’Œå¼¦',
                    'chord_aug': 'å¢ä¸‰å’Œå¼¦',
                    'chord_6': 'å¤§å…­å’Œå¼¦',
                    'chord_m6': 'å°å…­å’Œå¼¦',
                    'chord_7': 'å±ä¸ƒå’Œå¼¦',
                    'chord_maj7': 'å¤§ä¸ƒå’Œå¼¦',
                    'chord_m7': 'å°ä¸ƒå’Œå¼¦',
                    'chord_m7b5': 'åŠå‡ä¸ƒå’Œå¼¦',
                    'chord_dim7': 'å‡ä¸ƒå’Œå¼¦',
                    'chord_9': 'å±ä¹å’Œå¼¦',
                    'chord_maj9': 'å¤§ä¹å’Œå¼¦',
                    'chord_m9': 'å°ä¹å’Œå¼¦',
                    'chord_7sharp9': 'å±7â™¯9å’Œå¼¦',
                    'chord_7flat9': 'å±7â™­9å’Œå¼¦',
                    'chord_11': 'å±åä¸€å’Œå¼¦',
                    'chord_m11': 'å°åä¸€å’Œå¼¦',
                    'chord_7sharp11': 'å±7â™¯11å’Œå¼¦',
                    'chord_13': 'å±åä¸‰å’Œå¼¦',
                    'chord_m13': 'å°åä¸‰å’Œå¼¦',
                    'chord_sus2': 'æŒ‚äºŒå’Œå¼¦',
                    'chord_sus4': 'æŒ‚å››å’Œå¼¦',
                    'chord_add9': 'åŠ ä¹å’Œå¼¦',
                    'chord_madd9': 'å°åŠ ä¹å’Œå¼¦',
                    'chord_6add9': 'å…­åŠ ä¹å’Œå¼¦',
                    'chord_m6add9': 'å°å…­åŠ ä¹å’Œå¼¦',
                    
                    // éšæœºé€‰é¡¹
                    'random': 'éšæœº',
                    'random_root': 'éšæœºæ ¹éŸ³',
                    'random_chord': 'éšæœºå’Œå¼¦',
                    
                    // é€‰æ‹©å™¨é¡µé¢
                    'search_song_placeholder': 'æœç´¢æ­Œæ›²å...',
                    'select_song': 'é€‰æ‹©ä¹æ›²',
                    'practice_level': 'ç»ƒä¹ ç­‰çº§',
                    'select_key': 'é€‰æ‹©è°ƒæ€§',
                    'key_desc': 'è°ƒæ€§',
                    
                    // ç»ƒä¹ ç­‰çº§é€‰é¡¹
                    'single_chord_notes': 'å•å’Œå¼¦éŸ³',
                    'double_chord_notes': 'åŒå’Œå¼¦éŸ³',
                    'triple_chord_notes': 'ä¸‰å’Œå¼¦éŸ³',
                    'quad_chord_notes': 'å››å’Œå¼¦éŸ³',
                    'all_chord_notes': 'å…¨éƒ¨å’Œå¼¦éŸ³',

                    // éŸ³ç¨‹æè¿°
                    'root_note': 'R',
                    'third_note': '3rd',
                    'fifth_note': '5th',
                    'seventh_note': '7th',
                    'root': 'æ ¹éŸ³',
                    'third': 'ä¸‰éŸ³',
                    'fifth': 'äº”éŸ³',
                    'seventh': 'ä¸ƒéŸ³',
                    'root_third': 'R,3rd',
                    'root_fifth': 'R,5th',
                    'root_seventh': 'R,7th',
                    'third_fifth': '3rd,5th',
                    'third_seventh': '3rd,7th',
                    'root_third_fifth': 'åŸä½ä¸‰å’Œå¼¦',
                    'third_fifth_seventh': '3rd,5th,7th',
                    'random_inversion': 'éšæœºè½¬ä½',
                    'root_third_fifth_seventh': 'åŸä½ä¸ƒå’Œå¼¦',
                    'first_inversion': 'ç¬¬ä¸€è½¬ä½',
                    'second_inversion': 'ç¬¬äºŒè½¬ä½',
                    'third_inversion': 'ç¬¬ä¸‰è½¬ä½',
                    'with_octave_root': 'å«é«˜å…«åº¦æ ¹éŸ³',
                    'all_notes': 'å…¨éƒ¨éŸ³',
                    'all_chord_notes_desc': 'å’Œå¼¦æ‰€æœ‰éŸ³ç¬¦',

                    // æ–°å¢é€‰é¡¹æè¿°ç¿»è¯‘
                    'root_to_third': '1,2,3,5 on major/dominant chords\n1,3,4,5 on minor chords\n1,2,4,5 on sus chords\n1,2,3,5 on diminished chords\n(No altered 5ths on dominant chords)',
                    'root_to_fifth': 'æ ¹éŸ³åˆ°äº”éŸ³çš„æ—‹å¾‹çº¿',
                    'third_to_fifth': 'ä¸‰éŸ³åˆ°äº”éŸ³çš„æ—‹å¾‹çº¿',
                    'root_third_fifth_line': 'æ ¹éŸ³ä¸‰éŸ³äº”éŸ³è¿æ¥çº¿',
                    'random_inversions': 'éšæœºè½¬ä½è¿›è¡Œ',
                    'fifth_to_seventh': 'äº”éŸ³åˆ°ä¸ƒéŸ³çš„æ—‹å¾‹çº¿',
                    'seventh_to_ninth': 'ä¸ƒéŸ³åˆ°ä¹éŸ³çš„æ—‹å¾‹çº¿',
                    'fifth_to_ninth': 'äº”éŸ³åˆ°ä¹éŸ³çš„æ—‹å¾‹çº¿',
                    'fifth_seventh_ninth_line': 'äº”éŸ³ä¸ƒéŸ³ä¹éŸ³è¿æ¥çº¿',
                    'stepwise_voice_leading': 'çº§è¿›å¼çš„å£°éƒ¨è¿›è¡Œ',
                    'common_tone_voice_leading': 'ä¿æŒå…±åŒéŸ³çš„å£°éƒ¨è¿›è¡Œ',
                    'contrary_motion_voice_leading': 'åå‘å£°éƒ¨è¿›è¡Œ',
                    'parallel_motion_voice_leading': 'å¹³è¡Œå£°éƒ¨è¿›è¡Œ',
                    'sus4_to_sus2': 'Sus4æŒ‚ç•™åˆ°Sus2æŒ‚ç•™',
                    'sus4_to_third': 'Sus4æŒ‚ç•™è§£å†³åˆ°ä¸‰éŸ³',
                    'sus2_to_third': 'Sus2æŒ‚ç•™è§£å†³åˆ°ä¸‰éŸ³',
                    'suspension_resolution_chain': 'æŒ‚ç•™è§£å†³é“¾æ¡',
                    'triadic_chord_scales': 'åŸºäºä¸‰å’Œå¼¦çš„å’Œå¼¦éŸ³é˜¶',
                    'seventh_chord_scales': 'åŸºäºä¸ƒå’Œå¼¦çš„å’Œå¼¦éŸ³é˜¶',
                    'extended_chord_scales': 'åŸºäºæ‰©å±•å’Œå¼¦çš„å’Œå¼¦éŸ³é˜¶',
                    'modal_chord_scales': 'è°ƒå¼å’Œå¼¦éŸ³é˜¶',
                    'diatonic_passing_tones': 'è‡ªç„¶éŸ³é˜¶ç»è¿‡éŸ³',
                    'chromatic_passing_tones': 'åŠéŸ³ç»è¿‡éŸ³',
                    'enclosure_passing_tones': 'åŒ…å›´éŸ³ç»è¿‡æŠ€å·§',
                    'appoggiatura_passing_tones': 'è£…é¥°éŸ³ç»è¿‡æŠ€å·§',
                    'random_scale': 'éšæœºè°ƒå¼',
                    
                    // è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œé¡µé¢
                    'custom_chord_title': 'è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ',
                    'custom_chord_root': 'æ ¹éŸ³',
                    'custom_chord_type': 'å’Œå¼¦ç±»å‹',
                    'custom_chord_inversion': 'è½¬ä½',
                    'custom_chord_bass_root': 'æ ¹éŸ³',
                    'custom_chord_bass_3rd': 'ä¸‰éŸ³',
                    'custom_chord_bass_5th': 'äº”éŸ³',
                    'custom_chord_bass_7th': 'ä¸ƒéŸ³',
                    'custom_chord_add': 'æ·»åŠ å’Œå¼¦',
                    'custom_chord_sequence_name': 'è¾“å…¥æ­Œæ›²åç§°...',
                    'custom_chord_clear': 'æ¸…ç©º',
                    'custom_chord_save': 'ä¿å­˜',
                    'custom_chord_load': 'åŠ è½½',
                    'custom_chord_load_practice': 'åŠ è½½ç»ƒä¹ ',
                    'btn_custom_chords': 'è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ',
                    
                    // éŸ³é˜¶è®¾ç½®
                    'scale_key': 'è°ƒ',
                    'scale_mode': 'è°ƒå¼',
                    'scale_direction': 'æ–¹å‘',
                    'scale_practice_sequence': 'ç»ƒä¹ åºåˆ—',
                    'scale_order': 'æ¼”å¥é¡ºåº',
                    
                    // è®¾å¤‡è®¾ç½®
                    'device_audio_input': 'éŸ³é¢‘è¾“å…¥è®¾å¤‡',
                    'device_gain': 'è¾“å…¥å¢ç›Š',
                    'device_metronome': 'èŠ‚æ‹å™¨',
                    'device_tempo': 'é€Ÿåº¦',
                    'device_sensitivity': 'çµæ•åº¦',
                    'device_cooldown': 'å†·å´æ—¶é—´',
                    'device_confidence': 'ç½®ä¿¡åº¦é˜ˆå€¼',
                    'device_noise': 'å™ªéŸ³ç­‰çº§',
                    'device_volume': 'æœ€å°éŸ³é‡',
                    'device_buffer': 'ç¼“å†²åŒºå¤§å°',
                    'device_harmonic': 'è°æ³¢æƒé‡',
                    'device_zero_crossing': 'é›¶äº¤å‰é˜ˆå€¼',
                    
                    // é€šç”¨è®¾ç½®
                    'general_language': 'è¯­è¨€è®¾ç½®',
                    'interface_language': 'ç•Œé¢è¯­è¨€',
                    
                    // æŒ‰é’®å’Œæ“ä½œ
                    'btn_save': 'ä¿å­˜è®¾ç½®',
                    'btn_reset': 'é‡ç½®è®¾ç½®',
                    'btn_refresh': 'åˆ·æ–°è®¾å¤‡åˆ—è¡¨',
                    'btn_back': 'è¿”å›ä¸»èœå•',
                    'btn_cancel': 'å–æ¶ˆ',
                    'btn_confirm': 'ç¡®è®¤',

                    // è°ƒå¼é€‰æ‹©æ§åˆ¶æŒ‰é’®
                    'select_all': 'å…¨é€‰',
                    'deselect_all': 'å…¨ä¸é€‰',
                    'random_select': 'éšæœºé€‰æ‹©',
                    'btn_delete': 'åˆ é™¤',
                    'btn_edit': 'ç¼–è¾‘',
                    'btn_add': 'æ·»åŠ ',
                    'btn_clear': 'æ¸…ç©º',
                    
                    // çŠ¶æ€ä¿¡æ¯
                    'status_recording': 'å½•éŸ³ä¸­',
                    'status_processing': 'å¤„ç†ä¸­',
                    'status_error': 'é”™è¯¯',
                    'status_success': 'æˆåŠŸ',
                    
                    // é”™è¯¯ä¿¡æ¯
                    'error_no_audio_support': 'æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘API',
                    'error_microphone_permission': 'æ— æ³•è·å–éº¦å…‹é£æƒé™',
                    'error_audio_device': 'éŸ³é¢‘è®¾å¤‡åˆå§‹åŒ–å¤±è´¥',
                    'error_pitch_detection': 'éŸ³é«˜æ£€æµ‹å¤±è´¥',
                    
                    // æç¤ºä¿¡æ¯
                    'hint_select_device': 'è¯·é€‰æ‹©éŸ³é¢‘è¾“å…¥è®¾å¤‡',
                    'hint_connect_guitar': 'è¯·è¿æ¥æ‚¨çš„å‰ä»–',
                    'hint_start_practice': 'ç‚¹å‡»å¼€å§‹ç»ƒä¹ æŒ‰é’®å¼€å§‹',
                    'hint_select_chord_type': 'è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªå’Œå¼¦ç±»å‹',
                    'hint_select_scale': 'è¯·é€‰æ‹©éŸ³é˜¶ç±»å‹',
                    'device_count_detected': '{count} ä¸ªéŸ³é¢‘è¾“å…¥è®¾å¤‡',
                    'device_count_none': 'æœªæ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥è®¾å¤‡',
                    'default_device': 'é»˜è®¤è®¾å¤‡',
                    'audio_device': 'éŸ³é¢‘è®¾å¤‡',
                    'key_c_default': 'C é»˜è®¤',
                    
                    // CAGEDç»ƒä¹ è®¾ç½®
                    'caged_practice': 'CAGEDç»ƒä¹ ',
                    'caged_practice_hint': 'åŸºäºCAGEDç³»ç»Ÿçš„éŸ³é˜¶å’Œå’Œå¼¦ç»ƒä¹ ',
                    'caged_practice_mode': 'CAGEDç»ƒä¹ æ¨¡å¼',
                    'caged_shape': 'CAGEDå½¢çŠ¶',
                    'caged_shape_hint': 'é€‰æ‹©è¦ç»ƒä¹ çš„CAGEDå½¢çŠ¶',
                    'caged_key': 'è°ƒæ€§',
                    'caged_key_hint': 'é€‰æ‹©ç»ƒä¹ è°ƒæ€§',
                    'caged_mode': 'ç»ƒä¹ æ¨¡å¼',
                    'caged_mode_hint': 'é€‰æ‹©CAGEDç»ƒä¹ æ¨¡å¼',
                    'caged_shape_connection': 'å½¢çŠ¶è¿æ¥',
                    'caged_random_shapes': 'éšæœºå½¢çŠ¶',
                    'caged_show_fretboard': 'æ˜¾ç¤ºæŒ‡æ¿',
                    'caged_show_fingering': 'æ˜¾ç¤ºæŒ‡æ³•',
                    'caged_show_scale': 'æ˜¾ç¤ºéŸ³é˜¶',
                    'caged_chord_practice': 'CAGEDå’Œå¼¦ç»ƒä¹ ',
                    'caged_show_chord': 'æ˜¾ç¤ºå’Œå¼¦',
                    'caged_c_shape': 'Cå½¢çŠ¶',
                    'caged_a_shape': 'Aå½¢çŠ¶',
                    'caged_g_shape': 'Gå½¢çŠ¶',
                    'caged_e_shape': 'Eå½¢çŠ¶',
                    'caged_d_shape': 'Då½¢çŠ¶',
                    'midi_support': 'MIDIè®¾å¤‡æ”¯æŒ',
                    'midi_support_hint': 'è¿æ¥MIDIé”®ç›˜æˆ–æ§åˆ¶å™¨è¿›è¡Œç»ƒä¹ ',
                    'midi_device_connected': 'MIDIè®¾å¤‡å·²è¿æ¥',
                    'midi_device_disconnected': 'MIDIè®¾å¤‡æœªè¿æ¥',
                    'midi_device_detected': 'æ£€æµ‹åˆ° {count} ä¸ªMIDIè®¾å¤‡',
                    'midi_device_none': 'æœªæ£€æµ‹åˆ°MIDIè®¾å¤‡',

                    // æ­Œæ›²ä¿¡æ¯ç›¸å…³
                    'basic_info': 'åŸºæœ¬ä¿¡æ¯',
                    'song_composer': 'ä½œæ›²å®¶:',
                    'song_year': 'å¹´ä»£:',
                    'song_style': 'é£æ ¼:',
                    'song_tempo': 'é€Ÿåº¦:',
                    'song_key': 'åŸè°ƒ:',
                    'song_description': 'æ›²ç›®ä»‹ç»',
                    'select_this_song': 'é€‰æ‹©æ­¤æ›²ç›®',
                    'unknown': 'æœªçŸ¥',
                    'jazz_standard': 'çˆµå£«æ ‡å‡†æ›²',
                    'chord_progression': 'å’Œå¼¦è¿›è¡Œ',

                    // å’Œå¼¦ç»ƒä¹ åˆ†ç»„
                    'chord_single_notes': 'å•å’Œå¼¦éŸ³',
                    'chord_double_notes': 'åŒå’Œå¼¦éŸ³',
                    'chord_triple_notes': 'ä¸‰å’Œå¼¦éŸ³',
                    'chord_quad_notes': 'å››å’Œå¼¦éŸ³',
                    'chord_all_notes': 'å…¨éƒ¨å’Œå¼¦éŸ³',

                    // æ–°å¢ç»ƒä¹ åˆ†ç»„
                    'melodic_structure_r_to_5th': 'æ—‹å¾‹ç»“æ„ - Râ†’5th',
                    'melodic_structure_5th_to_9th': 'æ—‹å¾‹ç»“æ„ - 5thâ†’9th',
                    'voice_led_structure': 'Voice Ledç»“æ„',
                    'suspension_structure': 'æŒ‚ç•™ç»“æ„',
                    'chord_scale_structure': 'å’Œå¼¦éŸ³é˜¶',
                    'passing_tone_structure': 'ç»è¿‡éŸ³åˆ†ç»„',

                    // é”®ç›˜æ“ä½œæç¤º
                    'keyboard_hide': 'éšè—',
                    'keyboard_show': 'æ˜¾ç¤º',
                    'keyboard_space': 'ç©ºæ ¼',
                    'keyboard_next': 'ä¸‹ä¸€ä¸ª',

                    // éº¦å…‹é£æƒé™ç›¸å…³
                    'mic_permission_denied': 'éº¦å…‹é£æƒé™è¢«æ‹’ç»',
                    'mic_permission_needed': 'æ­¤åº”ç”¨éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½æ£€æµ‹éŸ³é«˜ã€‚',
                    'mic_permission_steps': 'è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š',
                    'mic_step_1': 'ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å®š/ä¿¡æ¯å›¾æ ‡',
                    'mic_step_2': 'åœ¨å¼¹å‡ºçš„èœå•ä¸­æ‰¾åˆ°"éº¦å…‹é£"é€‰é¡¹',
                    'mic_step_3': 'å°†å…¶è®¾ç½®ä¸º"å…è®¸"',
                    'mic_step_4': 'åˆ·æ–°é¡µé¢åé‡è¯•',
                    'refresh_page': 'åˆ·æ–°é¡µé¢',
                    'return_to_main': 'è¿”å›ä¸»èœå•',

                    // ç»ƒä¹ ç›¸å…³
                    'practice_scale': 'éŸ³é˜¶ç»ƒä¹ ',
                    'practice_chord': 'å’Œå¼¦ç»ƒä¹ ',
                    'practice_progression': 'å’Œå¼¦è¿›è¡Œç»ƒä¹ ',
                    'practice_arpeggio': 'ç¶éŸ³ç»ƒä¹ ',
                    'practice_interval': 'éŸ³ç¨‹ç»ƒä¹ ',
                    
                    // éŸ³é˜¶ç±»å‹
                    'scale_major': 'å¤§è°ƒ',
                    'scale_minor': 'å°è°ƒ',
                    'scale_dorian': 'å¤šåˆ©äºš',
                    'scale_phrygian': 'å¼—é‡Œå‡ äºš',
                    'scale_lydian': 'åˆ©åº•äºš',
                    'scale_mixolydian': 'æ··åˆåˆ©åº•äºš',
                    'scale_locrian': 'æ´›å…‹é‡Œäºš',
                    'scale_harmonic_minor': 'å’Œå£°å°è°ƒ',
                    'scale_melodic_minor': 'æ—‹å¾‹å°è°ƒ',
                    'scale_pentatonic_major': 'å¤§è°ƒäº”å£°éŸ³é˜¶',
                    'scale_pentatonic_minor': 'å°è°ƒäº”å£°éŸ³é˜¶',
                    'scale_blues': 'è“è°ƒéŸ³é˜¶',
                    
                    // å’Œå¼¦è½¬æ¢è®¾ç½®
                    'progression_settings': 'è½¬æ¢è®¾ç½®',
                    'progression_level': 'ç»ƒä¹ ç­‰çº§',
                    'progression_level_hint': 'é€‰æ‹©å’Œå¼¦å¤æ‚åº¦',
                    'single_chord_notes': 'å•å’Œå¼¦éŸ³',
                    'double_chord_notes': 'åŒå’Œå¼¦éŸ³',
                    'triple_chord_notes': 'ä¸‰å’Œå¼¦éŸ³',
                    'quad_chord_notes': 'å››å’Œå¼¦éŸ³',
                    'progression_key': 'ä¹æ›²',
                    'progression_key_hint': 'é€‰æ‹©ä¹æ›²',
                    'progression_tunes': 'ä¹æ›²',
                    'progression_tunes_hint': 'é€‰æ‹©ç»ƒä¹ ä¹æ›²',
                    'progression_style': 'é£æ ¼',
                    'progression_style_hint': 'é€‰æ‹©ç»ƒä¹ é£æ ¼',
                    'progression_tempo': 'é€Ÿåº¦',
                    'progression_tempo_hint': 'è®¾ç½®ç»ƒä¹ é€Ÿåº¦',
                    'progression_difficulty': 'éš¾åº¦',
                    'progression_difficulty_hint': 'é€‰æ‹©ç»ƒä¹ éš¾åº¦',
                    
                    // éŸ³é˜¶è®¾ç½®è¯¦ç»†
                    'scale_root_note': 'è°ƒ',
                    'scale_root_note_hint': 'é€‰æ‹©è°ƒ',
                    'scale_type': 'è°ƒå¼',
                    'scale_type_hint': 'é€‰æ‹©è°ƒå¼',
                    'scale_direction_hint': 'é€‰æ‹©æ¼”å¥æ–¹å‘',
                    'scale_practice_sequence_hint': 'é€‰æ‹©ç»ƒä¹ åºåˆ—',
                    'scale_arpeggio': 'ç¶éŸ³',
                    'scale_arpeggio_hint': 'é€‰æ‹©ç¶éŸ³ç±»å‹',
                    'scale_interval': 'éŸ³ç¨‹',
                    'scale_interval_hint': 'é€‰æ‹©éŸ³ç¨‹ç»ƒä¹ ',
                    'scale_random': 'éšæœº',
                    'scale_random_hint': 'éšæœºç”Ÿæˆç»ƒä¹ ',
                    
                    // è®¾å¤‡è®¾ç½®è¯¦ç»†
                    'device_audio_input_hint': 'é€‰æ‹©éŸ³é¢‘è¾“å…¥è®¾å¤‡',
                    'device_gain_hint': 'è°ƒæ•´è¾“å…¥å¢ç›Š',
                    'device_metronome_hint': 'å¯ç”¨èŠ‚æ‹å™¨',
                    'device_tempo_hint': 'è®¾ç½®èŠ‚æ‹å™¨é€Ÿåº¦',
                    'device_sensitivity_hint': 'è°ƒæ•´éŸ³é«˜æ£€æµ‹çµæ•åº¦',
                    'device_cooldown_hint': 'è®¾ç½®å†·å´æ—¶é—´',
                    'device_confidence_hint': 'è®¾ç½®ç½®ä¿¡åº¦é˜ˆå€¼',
                    'device_noise_hint': 'è®¾ç½®å™ªéŸ³ç­‰çº§',
                    'device_volume_hint': 'è®¾ç½®æœ€å°éŸ³é‡',
                    'device_buffer_hint': 'è®¾ç½®ç¼“å†²åŒºå¤§å°',
                    'device_harmonic_hint': 'è®¾ç½®è°æ³¢æƒé‡',
                    'device_zero_crossing_hint': 'è®¾ç½®é›¶äº¤å‰é˜ˆå€¼',
                    
                    // é€šç”¨è®¾ç½®è¯¦ç»†
                    'general_language_hint': 'é€‰æ‹©ç•Œé¢è¯­è¨€',
                    'interface_language_hint': 'é€‰æ‹©ç•Œé¢è¯­è¨€',
                    'general_theme': 'ä¸»é¢˜',
                    'general_theme_hint': 'é€‰æ‹©ç•Œé¢ä¸»é¢˜',
                    'theme_dark': 'æ·±è‰²ä¸»é¢˜',
                    'theme_light': 'æµ…è‰²ä¸»é¢˜',
                    'theme_auto': 'è·Ÿéšç³»ç»Ÿ',
                    'general_sound': 'å£°éŸ³',
                    'general_sound_hint': 'è®¾ç½®å£°éŸ³é€‰é¡¹',
                    'general_display': 'æ˜¾ç¤º',
                    'general_display_hint': 'è®¾ç½®æ˜¾ç¤ºé€‰é¡¹',
                    'general_advanced': 'é«˜çº§',
                    'general_advanced_hint': 'é«˜çº§è®¾ç½®é€‰é¡¹',
                    
                    // éŸ³é˜¶è®¾ç½®optgroupæ ‡ç­¾
                    'basic_modes': 'åŸºæœ¬è°ƒå¼',
                    'church_modes': 'æ•™ä¼šè°ƒå¼ (Church Modes)',
                    'harmonic_minor_series': 'å’Œå£°å°è°ƒç³»åˆ—',
                    'melodic_minor_series': 'æ—‹å¾‹å°è°ƒç³»åˆ—',
                    'pentatonic_scales': 'äº”å£°éŸ³é˜¶',
                    'blues_scales': 'å¸ƒé²æ–¯éŸ³é˜¶',
                    'special_scales': 'ç‰¹æ®ŠéŸ³é˜¶',
                    'exotic_scales': 'å¼‚å›½é£æ ¼',
                    
                    // å’Œå¼¦è½¬æ¢è®¾ç½®optgroupæ ‡ç­¾
                    'single_chord_notes': 'å•å’Œå¼¦éŸ³',
                    'double_chord_notes': 'åŒå’Œå¼¦éŸ³',
                    'triple_chord_notes': 'ä¸‰å’Œå¼¦éŸ³',
                    'quad_chord_notes': 'å››å’Œå¼¦éŸ³',
                    
                    // å’Œå¼¦è½¬æ¢è®¾ç½®é€‰é¡¹
                    'single_chord_tones': 'å•å’Œå¼¦éŸ³',
                    'two_chord_tones': 'åŒå’Œå¼¦éŸ³',
                    'three_chord_tones': 'ä¸‰å’Œå¼¦éŸ³',
                    'four_chord_tones': 'å››å’Œå¼¦éŸ³',
                    'random_inversions_135': '135éšæœºè½¬ä½',
                    'random_inversions_1357': '1357éšæœºè½¬ä½',
                    'all_chord_tones': 'å…¨éƒ¨å’Œå¼¦éŸ³',
                    'all': 'å…¨éƒ¨',
                    
                    // æ‰¾éŸ³ç»ƒä¹ è®¾ç½®
                    'pitch_finding_practice_time': 'ç»ƒä¹ æ—¶é—´',
                    'pitch_finding_practice_time_hint': 'é€‰æ‹©ç»ƒä¹ æ—¶é•¿',
                    'pitch_finding_show_fretboard': 'æ˜¾ç¤ºæŒ‡æ¿',
                    'pitch_finding_show_fretboard_hint': 'æ£€æµ‹åˆ°æ­£ç¡®éŸ³é«˜æ—¶åœ¨æŒ‡æ¿ä¸Šæ˜¾ç¤ºä½ç½®',
                    'fretboard_keyboard_hint': 'ğŸ’¡ â†“éšè— â†‘æ˜¾ç¤º ç©ºæ ¼ä¸‹ä¸€ä¸ª',
                    'pitch_finding_fretboard_range': 'æŒ‡æ¿é•¿åº¦',
                    'pitch_finding_fretboard_range_hint': 'é€‰æ‹©æŒ‡æ¿æ˜¾ç¤ºèŒƒå›´',
                    'pitch_finding_12_frets': '12å“',
                    'pitch_finding_15_frets': '15å“',
                    'pitch_finding_18_frets': '18å“',
                    'pitch_finding_24_frets': '24å“',
                    'pitch_finding_current_note': 'å½“å‰éŸ³ç¬¦',
                    'pitch_finding_time_remaining': 'å‰©ä½™æ—¶é—´',
                    'pitch_finding_practice_complete': 'ç»ƒä¹ å®Œæˆ',
                    'pitch_finding_next_interval': 'ä¸‹ä¸€é¢˜é—´éš”',
                    'pitch_finding_next_interval_hint': 'ç­”å¯¹åè‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜çš„æ—¶é—´é—´éš”',
                    'pitch_finding_no_auto': 'æ‰‹åŠ¨',
                    'pitch_finding_2_seconds': '2ç§’',
                    'pitch_finding_3_seconds': '3ç§’',
                    'pitch_finding_5_seconds': '5ç§’',
                    'pitch_finding_1_minute': '1åˆ†é’Ÿ',
                    'pitch_finding_2_minutes': '2åˆ†é’Ÿ',
                    'pitch_finding_3_minutes': '3åˆ†é’Ÿ',
                    'pitch_finding_5_minutes': '5åˆ†é’Ÿ',
                    'pitch_finding_10_minutes': '10åˆ†é’Ÿ',
                    'pitch_finding_15_minutes': '15åˆ†é’Ÿ',
                    'pitch_finding_30_minutes': '30åˆ†é’Ÿ',
                    'pitch_finding_next_question': 'ä¸‹ä¸€é¢˜',
                    'practice_mode': 'ç»ƒä¹ æ¨¡å¼',
                    'practice_mode_hint': 'é€‰æ‹©ç»ƒä¹ ç±»å‹',
                    'note_interval_practice': 'éŸ³ç¨‹ç»ƒä¹ ',
                    'single_note_practice': 'æ‰¾éŸ³ç»ƒä¹ ',
                    'interval_selection': 'é€‰æ‹©éŸ³ç¨‹',
                    'interval_selection_hint': 'é€‰æ‹©è¦ç»ƒä¹ çš„éŸ³ç¨‹',
                    'root_note_setting': 'è®¾ç½®æ ¹éŸ³',
                    'root_note_setting_hint': 'é€‰æ‹©æ ¹éŸ³æˆ–éšæœº',
                    'find_root_first': 'å…ˆæ‰¾æ ¹éŸ³',
                    'find_root_first_hint': 'å¼€å¯åå…ˆç»ƒä¹ æ ¹éŸ³ï¼Œå†ç»ƒä¹ éŸ³ç¨‹',
                    'start_practice': 'å¼€å§‹ç»ƒä¹ ',
                    
                    // è®¾å¤‡è®¾ç½®å…¶ä»–æ ‡ç­¾
                    'practice_settings': 'ç»ƒä¹ è®¾ç½®',
                    'metronome_settings': 'èŠ‚æ‹å™¨è®¾ç½®',
                    'time_label': 'æ—¶é—´',
                    'fixed_delay_generation': 'å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜',
                    'background_flash': 'èƒŒæ™¯é—ªå…‰',
                    
                    // é€šç”¨è®¾ç½®å…¶ä»–æ ‡ç­¾
                    'settings_management': 'è®¾ç½®ç®¡ç†',
                    'reset_settings_hint': 'ç‚¹å‡»é‡ç½®æŒ‰é’®å°†æ¢å¤æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼',
                    'chord_name_display': 'å’Œå¼¦åæ˜¾ç¤º',
                    'chord_name_display_hint': 'é€‰æ‹©å’Œå¼¦åç§°çš„æ˜¾ç¤ºæ–¹å¼',
                    'chord_name_english': 'è‹±æ–‡å',
                    'chord_name_symbols': 'ç¬¦å·å',
                    
                    // é—æ¼çš„ç¿»è¯‘é”®
                    'sound_metronome': 'å£°éŸ³èŠ‚æ‹',
                    'custom_chord_progression': 'è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ',
                    'song_name_placeholder': 'è¯·è¾“å…¥æ­Œæ›²åï¼ˆå¯é€‰ï¼‰',
                    'btn_clear_custom_chords': 'æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ',
                    'btn_save_custom_chords': 'ä¿å­˜å’Œå¼¦è¿›è¡Œåˆ°æœ¬åœ°',
                    'btn_load_local_chords': 'åŠ è½½æœ¬åœ°å’Œå¼¦è¿›è¡Œ',
                    'btn_load_sequence': 'åŠ è½½åºåˆ—',
                    'btn_add_chord': 'æ·»åŠ å’Œå¼¦',
                    'progression_order': 'é¡ºåº',
                    'progression_order_hint': 'é€‰æ‹©å’Œå¼¦è¿›è¡Œçš„æ¼”å¥é¡ºåº',
                    'progression_repeat': 'é‡å¤ç»ƒä¹ ',
                    'progression_repeat_hint': 'å¼€å¯åå¯¹æ­Œæ›²è¿›è¡Œé‡å¤ç»ƒä¹ ',
                    'progression_key_label': 'è°ƒ',
                    'progression_key_hint': 'é€‰æ‹©ç»ƒä¹ çš„è°ƒæ€§',
                    'order_ordered': 'é¡ºåº',
                    'order_reverse': 'å€’åº',
                    
                    // MIDIè®¾å¤‡
                    'midi_support': 'MIDIè®¾å¤‡æ”¯æŒ',
                    'midi_support_hint': 'è¿æ¥MIDIé”®ç›˜æˆ–æ§åˆ¶å™¨è¿›è¡Œç»ƒä¹ ',
                    'midi_enable': 'MIDIè®¾å¤‡'
                },
                'en': {
                    'app_title': 'ğŸ¸ Fretboard Master',
                   
                    'page_title': 'Fretboard Master',
                    'btn_start': 'Start Practice',
                    'status_ready': 'Ready',
                    'lang_zh': 'ä¸­æ–‡',
                    'lang_en': 'English',
                    'nav_scale': 'Scale',
                    'nav_chord': 'Chord',
                    'nav_progression': 'Changes',
                    'nav_pitch_finding': 'Note&Interval',
                    'settings_pitch_finding': 'Note&Interval Settings',
                    'nav_settings': 'Settings',
                    'settings_scale': 'Scale Practice Options',
                    'settings_chord': 'Chord Practice Options',
                    'settings_device': 'Device Settings',
                    'settings_general': 'General Settings',
                    'general_language': 'Language Settings',
                    'interface_language': 'Interface Language',
                    'test_language_switch': 'Test Language Switch',
                    
                    // å¿«æ·é”®æç¤º
                    'shortcut_hint': 'Press ESC to return to main menu',
                    
                    // éŸ³é«˜æ˜¾ç¤º
                    'pitch_display': 'Pitch',
                    'cents_display': 'Cents',
                    
                    // å’Œå¼¦è®¾ç½®
                    'chord_root_note': 'Root Note',
                    'chord_root_note_hint': 'Select chord root note',
                    'chord_type': 'Chord Type',
                    'chord_type_hint': 'Select chord types to practice',
                    'chord_order': 'Order',
                    'chord_order_hint': 'Select chord note playing order',
                    'chord_custom': 'Custom Chords',
                    
                    // å’Œå¼¦è½¬ä½è®¾ç½®
                    'chord_bass_note': 'Bass Note',
                    'chord_bass_root': 'Root',
                    'chord_bass_3rd': '3rd',
                    'chord_bass_5th': '5th',
                    'chord_bass_7th': '7th',
                    'chord_bass_random': 'Random',

                    
                    // é¡ºåºæŒ‰é’®
                    'order_ascending': 'Ascending',
                    'order_descending': 'Descending',
                    'order_random': 'Random',
                    
                    // å’Œå¼¦ç±»å‹
                    'chord_major': 'Major',
                    'chord_minor': 'Minor',
                    'chord_dim': 'Dim',
                    'chord_aug': 'Aug',
                    'chord_6': '6',
                    'chord_m6': 'm6',
                    'chord_7': '7',
                    'chord_maj7': 'Maj7',
                    'chord_m7': 'm7',
                    'chord_m7b5': 'm7â™­5',
                    'chord_dim7': 'dim7',
                    'chord_9': '9',
                    'chord_maj9': 'Maj9',
                    'chord_m9': 'm9',
                    'chord_7sharp9': '7â™¯9',
                    'chord_7flat9': '7â™­9',
                    'chord_11': '11',
                    'chord_m11': 'm11',
                    'chord_7sharp11': '7â™¯11',
                    'chord_13': '13',
                    'chord_m13': 'm13',
                    'chord_sus2': 'sus2',
                    'chord_sus4': 'sus4',
                    'chord_add9': 'add9',
                    'chord_madd9': 'madd9',
                    'chord_6add9': '6add9',
                    'chord_m6add9': 'm6add9',
                    'chord_diminished7': 'Diminished 7',
                    'chord_dominant9': 'Dominant 9',
                    'chord_major9': 'Major 9',
                    'chord_minor9': 'Minor 9',
                    'chord_dominant7sharp9': 'Dominant 7â™¯9',
                    'chord_sus2': 'Sus2',
                    'chord_sus4': 'Sus4',
                    'chord_add9': 'Add9',
                    'chord_madd9': 'mAdd9',
                    'chord_6add9': '6Add9',
                    'chord_m6add9': 'm6Add9',
                    
                    // éšæœºé€‰é¡¹
                    'random': 'Random',
                    'random_root': 'Random Root',
                    'random_chord': 'Random Chord',
                    
                    // é€‰æ‹©å™¨é¡µé¢
                    'search_song_placeholder': 'Search song name...',
                    'select_song': 'Select Song',
                    'practice_level': 'Level',
                    'select_key': 'Select Key',
                    'key_desc': 'Key',
                    
                    // ç»ƒä¹ ç­‰çº§é€‰é¡¹
                    'single_chord_notes': 'Single Chord Notes',
                    'double_chord_notes': 'Double Chord Notes',
                    'triple_chord_notes': 'Triple Chord Notes',
                    'quad_chord_notes': 'Quad Chord Notes',
                    'all_chord_notes': 'All Chord Notes',

                    // éŸ³ç¨‹æè¿°
                    'root_note': 'R',
                    'third_note': '3rd',
                    'fifth_note': '5th',
                    'seventh_note': '7th',
                    'root': 'Root',
                    'third': '3rd',
                    'fifth': '5th',
                    'seventh': '7th',
                    'root_third': 'R,3rd',
                    'root_fifth': 'R,5th',
                    'root_seventh': 'R,7th',
                    'third_fifth': '3rd,5th',
                    'third_seventh': '3rd,7th',
                    'root_third_fifth': 'Root Position Triad',
                    'third_fifth_seventh': '3rd,5th,7th',
                    'random_inversion': 'Random Inversion',
                    'root_third_fifth_seventh': 'Root Position 7th',
                    'first_inversion': '1st Inversion',
                    'second_inversion': '2nd Inversion',
                    'third_inversion': '3rd Inversion',
                    'with_octave_root': 'With Octave Root',
                    'all_notes': 'All Notes',
                    'all_chord_notes_desc': 'All chord notes',

                    // New option descriptions
                    'root_to_third': 'Melodic line from root to third',
                    'root_to_fifth': 'Melodic line from root to fifth',
                    'third_to_fifth': 'Melodic line from third to fifth',
                    'root_third_fifth_line': 'Root-third-fifth connection line',
                    'random_inversions': 'Random inversions progression',
                    'fifth_to_seventh': 'Melodic line from fifth to seventh',
                    'seventh_to_ninth': 'Melodic line from seventh to ninth',
                    'fifth_to_ninth': 'Melodic line from fifth to ninth',
                    'fifth_seventh_ninth_line': 'Fifth-seventh-ninth connection line',
                    'stepwise_voice_leading': 'Stepwise voice leading',
                    'common_tone_voice_leading': 'Common tone voice leading',
                    'contrary_motion_voice_leading': 'Contrary motion voice leading',
                    'parallel_motion_voice_leading': 'Parallel motion voice leading',
                    'sus4_to_sus2': 'Sus4 suspension to Sus2 suspension',
                    'sus4_to_third': 'Sus4 suspension resolves to third',
                    'sus2_to_third': 'Sus2 suspension resolves to third',
                    'suspension_resolution_chain': 'Suspension resolution chain',
                    'triadic_chord_scales': 'Triad-based chord scales',
                    'seventh_chord_scales': 'Seventh chord-based scales',
                    'extended_chord_scales': 'Extended chord-based scales',
                    'modal_chord_scales': 'Modal chord scales',
                    'diatonic_passing_tones': 'Diatonic passing tones',
                    'chromatic_passing_tones': 'Chromatic passing tones',
                    'enclosure_passing_tones': 'Enclosure passing techniques',
                    'appoggiatura_passing_tones': 'Appoggiatura passing techniques',
                    'random_scale': 'Random Mode',
                    
                    // è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œé¡µé¢
                    'custom_chord_title': 'Custom Chord Progression',
                    'custom_chord_root': 'Root Note',
                    'custom_chord_type': 'Chord Type',
                    'custom_chord_inversion': 'Inversion',
                    'custom_chord_bass_root': 'Root',
                    'custom_chord_bass_3rd': '3rd',
                    'custom_chord_bass_5th': '5th',
                    'custom_chord_bass_7th': '7th',
                    'custom_chord_add': 'Add Chord',
                    'custom_chord_sequence_name': 'Enter song name...',
                    'custom_chord_clear': 'Clear',
                    'custom_chord_save': 'Save',
                    'custom_chord_load': 'Load',
                    'custom_chord_load_practice': 'Load Practice',
                    'btn_custom_chords': 'Custom Chord Progression',
                    
                    // éŸ³é˜¶è®¾ç½®
                    'scale_key': 'Key',
                    'scale_mode': 'Mode',
                    'scale_direction': 'Direction',
                    'scale_practice_sequence': 'Practice Sequence',
                    'scale_order': 'Playing Order',
                    
                    // è®¾å¤‡è®¾ç½®
                    'device_audio_input': 'Audio Input Device',
                    'device_gain': 'Input Gain',
                    'device_metronome': 'Metronome',
                    'device_tempo': 'Tempo',
                    'device_sensitivity': 'Sensitivity',
                    'device_cooldown': 'Cooldown Time',
                    'device_confidence': 'Confidence Threshold',
                    'device_noise': 'Noise Level',
                    'device_volume': 'Minimum Volume',
                    'device_buffer': 'Buffer Size',
                    'device_harmonic': 'Harmonic Weights',
                    'device_zero_crossing': 'Zero Crossing Threshold',
                    
                    // é€šç”¨è®¾ç½®
                    'general_language': 'Language Settings',
                    'interface_language': 'Interface Language',
                    
                    // æŒ‰é’®å’Œæ“ä½œ
                    'btn_save': 'Save Settings',
                    'btn_reset': 'Reset Settings',
                    'btn_refresh': 'Refresh Device List',
                    'btn_back': 'Back to Main Menu',
                    'btn_cancel': 'Cancel',
                    'btn_confirm': 'Confirm',

                    // è°ƒå¼é€‰æ‹©æ§åˆ¶æŒ‰é’®
                    'select_all': 'Select All',
                    'deselect_all': 'Deselect All',
                    'random_select': 'Random Select',
                    'btn_delete': 'Delete',
                    'btn_edit': 'Edit',
                    'btn_add': 'Add',
                    'btn_clear': 'Clear',
                    
                    // çŠ¶æ€ä¿¡æ¯
                    'status_recording': 'Recording',
                    'status_processing': 'Processing',
                    'status_error': 'Error',
                    'status_success': 'Success',
                    
                    // é”™è¯¯ä¿¡æ¯
                    'error_no_audio_support': 'Your browser does not support audio API',
                    'error_microphone_permission': 'Cannot get microphone permission',
                    'error_audio_device': 'Audio device initialization failed',
                    'error_pitch_detection': 'Pitch detection failed',
                    
                    // æç¤ºä¿¡æ¯
                    'hint_select_device': 'Please select an audio input device',
                    'hint_connect_guitar': 'Please connect your guitar',
                    'hint_start_practice': 'Click start practice button to begin',
                    'hint_select_chord_type': 'Please select at least one chord type',
                    'hint_select_scale': 'Please select a scale type',
                    
                    // ç»ƒä¹ ç›¸å…³
                    'practice_scale': 'Scale Practice',
                    'practice_chord': 'Chord Practice',
                    'practice_progression': 'Changes Practice',
                    'practice_arpeggio': 'Arpeggio Practice',
                    'practice_interval': 'Interval Practice',
                    
                    // éŸ³é˜¶ç±»å‹
                    'scale_major': 'Major',
                    'scale_minor': 'Minor',
                    'scale_dorian': 'Dorian',
                    'scale_phrygian': 'Phrygian',
                    'scale_lydian': 'Lydian',
                    'scale_mixolydian': 'Mixolydian',
                    'scale_locrian': 'Locrian',
                    'scale_harmonic_minor': 'Harmonic Minor',
                    'scale_melodic_minor': 'Melodic Minor',
                    'scale_pentatonic_major': 'Major Pentatonic',
                    'scale_pentatonic_minor': 'Minor Pentatonic',
                    'scale_blues': 'Blues Scale',
                    
                    // å’Œå¼¦è½¬æ¢è®¾ç½®
                    'progression_settings': 'Progression Settings',
                    'progression_level': 'Practice Level',
                    'progression_level_hint': 'Select chord complexity',
                    'single_chord_notes': 'Single Chord Notes',
                    'double_chord_notes': 'Double Chord Notes',
                    'triple_chord_notes': 'Triple Chord Notes',
                    'quad_chord_notes': 'Quad Chord Notes',
                    'progression_key': 'Tunes',
                    'progression_key_hint': 'Select a Tune',
                    'progression_tunes': 'Tunes',
                    'progression_tunes_hint': 'Select practice tunes',
                    'progression_style': 'Style',
                    'progression_style_hint': 'Select practice style',
                    'progression_tempo': 'Tempo',
                    'progression_tempo_hint': 'Set practice tempo',
                    'progression_difficulty': 'Difficulty',
                    'progression_difficulty_hint': 'Select practice difficulty',
                    
                    // éŸ³é˜¶è®¾ç½®è¯¦ç»†
                    'scale_root_note': 'Key',
                    'scale_root_note_hint': 'Select key',
                    'scale_type': 'Mode',
                    'scale_type_hint': 'Select mode',
                    'scale_direction_hint': 'Select playing direction',
                    'scale_practice_sequence_hint': 'Select practice sequence',
                    'scale_arpeggio': 'Arpeggio',
                    'scale_arpeggio_hint': 'Select arpeggio type',
                    'scale_interval': 'Interval',
                    'scale_interval_hint': 'Select interval practice',
                    'scale_random': 'Random',
                    'scale_random_hint': 'Generate random practice',
                    
                    // è®¾å¤‡è®¾ç½®è¯¦ç»†
                    'device_audio_input_hint': 'Select audio input device',
                    'device_gain_hint': 'Adjust input gain',
                    'device_metronome_hint': 'Enable metronome',
                    'device_tempo_hint': 'Set metronome tempo',
                    'device_sensitivity_hint': 'Adjust pitch detection sensitivity',
                    'device_cooldown_hint': 'Set cooldown time',
                    'device_confidence_hint': 'Set confidence threshold',
                    'device_noise_hint': 'Set noise level',
                    'device_volume_hint': 'Set minimum volume',
                    'device_buffer_hint': 'Set buffer size',
                    'device_harmonic_hint': 'Set harmonic weights',
                    'device_zero_crossing_hint': 'Set zero crossing threshold',
                    
                    // é€šç”¨è®¾ç½®è¯¦ç»†
                    'general_language_hint': 'Select interface language',
                    'interface_language_hint': 'Select interface language',
                    'general_theme': 'Theme',
                    'general_theme_hint': 'Select interface theme',
                    'theme_dark': 'Dark Theme',
                    'theme_light': 'Light Theme',
                    'theme_auto': 'Follow System',
                    'general_sound': 'Sound',
                    'general_sound_hint': 'Set sound options',
                    'general_display': 'Display',
                    'general_display_hint': 'Set display options',
                    'general_advanced': 'Advanced',
                    'general_advanced_hint': 'Advanced settings options',
                    
                    // éŸ³é˜¶è®¾ç½®optgroupæ ‡ç­¾
                    'basic_modes': 'Basic Modes',
                    'church_modes': 'Church Modes',
                    'harmonic_minor_series': 'Harmonic Minor Series',
                    'melodic_minor_series': 'Melodic Minor Series',
                    'pentatonic_scales': 'Pentatonic Scales',
                    'blues_scales': 'Blues Scales',
                    'special_scales': 'Special Scales',
                    'exotic_scales': 'Exotic Scales',
                    
                    // å’Œå¼¦è½¬æ¢è®¾ç½®optgroupæ ‡ç­¾
                    'single_chord_notes': 'Single Chord Notes',
                    'double_chord_notes': 'Double Chord Notes',
                    'triple_chord_notes': 'Triple Chord Notes',
                    'quad_chord_notes': 'Quad Chord Notes',
                    
                    // å’Œå¼¦è½¬æ¢è®¾ç½®é€‰é¡¹
                    'single_chord_tones': 'Single Chord Tones',
                    'two_chord_tones': 'Two Chord Tones',
                    'three_chord_tones': 'Three Chord Tones',
                    'four_chord_tones': 'Four Chord Tones',
                    'random_inversions_135': '1,3,5 Random Inversions',
                    'random_inversions_1357': '1357 Random Inversions',
                    'all_chord_tones': 'All Chord Tones',
                    'all': 'All',
                    
                    // æ‰¾éŸ³ç»ƒä¹ è®¾ç½®
                    'pitch_finding_practice_time': 'Practice Time',
                    'pitch_finding_practice_time_hint': 'Select practice duration',
                    'pitch_finding_show_fretboard': 'Show Fretboard',
                    'pitch_finding_show_fretboard_hint': 'Display note positions on fretboard when correct pitch is detected',
                    'fretboard_keyboard_hint': 'ğŸ’¡ â†“Hide â†‘Show Space Next',
                    'pitch_finding_fretboard_range': 'Fretboard Range',
                    'pitch_finding_fretboard_range_hint': 'Select fretboard display range',
                    'pitch_finding_12_frets': '12 Frets',
                    'pitch_finding_15_frets': '15 Frets',
                    'pitch_finding_18_frets': '18 Frets',
                    'pitch_finding_24_frets': '24 Frets',
                    'pitch_finding_current_note': 'Current Note',
                    'pitch_finding_time_remaining': 'Time Remaining',
                    'pitch_finding_practice_complete': 'Practice Complete',
                    'pitch_finding_next_interval': 'Next Question Interval',
                    'pitch_finding_next_interval_hint': 'Time interval before automatically moving to next question after correct answer',
                    'pitch_finding_no_auto': 'Manual',
                    'pitch_finding_2_seconds': '2 Seconds',
                    'pitch_finding_3_seconds': '3 Seconds',
                    'pitch_finding_5_seconds': '5 Seconds',
                    'pitch_finding_1_minute': '1 Minute',
                    'pitch_finding_2_minutes': '2 Minutes',
                    'pitch_finding_3_minutes': '3 Minutes',
                    'pitch_finding_5_minutes': '5 Minutes',
                    'pitch_finding_10_minutes': '10 Minutes',
                    'pitch_finding_15_minutes': '15 Minutes',
                    'pitch_finding_30_minutes': '30 Minutes',
                    'pitch_finding_next_question': 'Next',
                    'practice_mode': 'Practice Mode',
                    'practice_mode_hint': 'Select practice type',
                    'note_interval_practice': 'Interval Practice',
                    'single_note_practice': 'Single Note Practice',
                    'interval_selection': 'Select Intervals',
                    'interval_selection_hint': 'Select intervals to practice',
                    'root_note_setting': 'Root Note Setting',
                    'root_note_setting_hint': 'Choose root note or random',
                    'find_root_first': 'Find Root First',
                    'find_root_first_hint': 'Practice root note first, then intervals',
                    'start_practice': 'Start Practice',
                    
                    // è®¾å¤‡è®¾ç½®å…¶ä»–æ ‡ç­¾
                    'practice_settings': 'Practice Settings',
                    'metronome_settings': 'Metronome Settings',
                    'time_label': 'Time',
                    'fixed_delay_generation': 'Fixed Delay Generation',
                    'background_flash': 'Background Flash',
                    
                    // é€šç”¨è®¾ç½®å…¶ä»–æ ‡ç­¾
                    'settings_management': 'Settings Management',
                    'reset_settings_hint': 'Click reset button to restore all settings to default values',
                    'chord_name_display': 'Chord Name Display',
                    'chord_name_display_hint': 'Select chord name display format',
                    'chord_name_english': 'English',
                    'chord_name_symbols': 'Symbols',
                    
                    // é—æ¼çš„ç¿»è¯‘é”®
                    'sound_metronome': 'Sound Metronome',
                    'custom_chord_progression': 'Custom Changes',
                    'song_name_placeholder': 'Enter song name (optional)',
                    'btn_clear_custom_chords': 'Clear Custom Changes',
                    'btn_save_custom_chords': 'Save Changes to Local',
                    'btn_load_local_chords': 'Load Local Changes',
                    'btn_load_sequence': 'Load Sequence',
                    'btn_add_chord': 'Add Chord',
                    'progression_order': 'Order',
                    'progression_order_hint': 'Select chord progression playing order',
                    'progression_repeat': 'Repeat Practice',
                    'progression_repeat_hint': 'Enable to repeat the song for practice',
                    'progression_key_label': 'Key',
                    'progression_key_hint': 'Select practice key',
                    'order_ordered': 'Ordered',
                    'order_reverse': 'Reverse',
                    'device_count_detected': '{count} Audio Input Devices',
                    'device_count_none': 'No Audio Input Devices Detected',
                    'default_device': 'Default Device',
                    'audio_device': 'Audio Device',
                    'key_c_default': 'C Default',
                    
                    // CAGED Practice Settings
                    'caged_practice': 'CAGED Practice',
                    'caged_practice_hint': 'Scale and chord practice based on CAGED system',
                    'caged_practice_mode': 'CAGED Practice Mode',
                    'caged_shape': 'CAGED Shape',
                    'caged_shape_hint': 'Select CAGED shape to practice',
                    'caged_key': 'Key',
                    'caged_key_hint': 'Select practice key',
                    'caged_mode': 'Practice Mode',
                    'caged_mode_hint': 'Select CAGED practice mode',
                    'caged_shape_connection': 'Shape Connection',
                    'caged_random_shapes': 'Random Shapes',
                    'caged_show_fretboard': 'Show Fretboard',
                    'caged_show_fingering': 'Show Fingering',
                    'caged_show_scale': 'Show Scale',
                    'caged_c_shape': 'C Shape',
                    'caged_a_shape': 'A Shape',
                    'caged_g_shape': 'G Shape',
                    'caged_e_shape': 'E Shape',
                    'caged_d_shape': 'D Shape',
                    'midi_support': 'MIDI Device Support',
                    'midi_support_hint': 'Connect MIDI keyboard or controller for practice',
                    'midi_enable': 'MIDI Device',
                    'midi_device_connected': 'MIDI device connected',
                    'midi_device_disconnected': 'MIDI device disconnected',
                    'midi_device_detected': 'Detected {count} MIDI devices',
                    'midi_device_none': 'No MIDI devices detected',

                    // æ­Œæ›²ä¿¡æ¯ç›¸å…³
                    'basic_info': 'Basic Information',
                    'song_composer': 'Composer:',
                    'song_year': 'Year:',
                    'song_style': 'Style:',
                    'song_tempo': 'Tempo:',
                    'song_key': 'Original Key:',
                    'song_description': 'Song Description',
                    'select_this_song': 'Select This Song',
                    'unknown': 'Unknown',
                    'jazz_standard': 'Jazz Standard',
                    'chord_progression': 'Chord Progression',

                    // å’Œå¼¦ç»ƒä¹ åˆ†ç»„
                    'chord_single_notes': 'Single Chord Notes',
                    'chord_double_notes': 'Double Chord Notes',
                    'chord_triple_notes': 'Triple Chord Notes',
                    'chord_quad_notes': 'Quad Chord Notes',
                    'chord_all_notes': 'All Chord Notes',

                    // New practice groups
                    'melodic_structure_r_to_5th': 'Melodic Structure - Râ†’5th',
                    'melodic_structure_5th_to_9th': 'Melodic Structure - 5thâ†’9th',
                    'voice_led_structure': 'Voice Leading Structure',
                    'suspension_structure': 'Suspension Structure',
                    'chord_scale_structure': 'Chord Scale Structure',
                    'passing_tone_structure': 'Passing Tones Structure',

                    // é”®ç›˜æ“ä½œæç¤º
                    'keyboard_hide': 'Hide',
                    'keyboard_show': 'Show',
                    'keyboard_space': 'Space',
                    'keyboard_next': 'Next',

                    // éº¦å…‹é£æƒé™ç›¸å…³
                    'mic_permission_denied': 'Microphone Permission Denied',
                    'mic_permission_needed': 'This app needs microphone permission to detect pitch.',
                    'mic_permission_steps': 'Please follow these steps:',
                    'mic_step_1': 'Click the lock/info icon on the left side of the browser address bar',
                    'mic_step_2': 'Find "Microphone" option in the popup menu',
                    'mic_step_3': 'Set it to "Allow"',
                    'mic_step_4': 'Refresh the page and try again',
                    'refresh_page': 'Refresh Page',
                    'return_to_main': 'Return to Main Menu'
                }
            };
            
            // CAGEDç³»ç»Ÿæ•°æ®ç»“æ„
            const cagedSystem = {
                shapes: {
                    'C': {
                        name: 'C Shape',
                        rootString: 5,
                        rootFret: 3,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 5, fret: 3, finger: 1, interval: '1' }, // C
                            { string: 4, fret: 2, finger: 2, interval: '2' }, // D
                            { string: 3, fret: 0, finger: 1, interval: '3' }, // E
                            { string: 2, fret: 1, finger: 2, interval: '4' }, // F
                            { string: 1, fret: 0, finger: 1, interval: '5' }, // G
                            { string: 0, fret: 1, finger: 2, interval: '6' }  // A
                        ]
                    },
                    'A': {
                        name: 'A Shape',
                        rootString: 5,
                        rootFret: 5,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 5, fret: 5, finger: 1, interval: '1' }, // A
                            { string: 4, fret: 5, finger: 1, interval: '2' }, // B
                            { string: 3, fret: 5, finger: 1, interval: '3' }, // C
                            { string: 2, fret: 5, finger: 1, interval: '4' }, // D
                            { string: 1, fret: 5, finger: 1, interval: '5' }, // E
                            { string: 0, fret: 5, finger: 1, interval: '6' }  // F
                        ]
                    },
                    'G': {
                        name: 'G Shape',
                        rootString: 6,
                        rootFret: 3,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 6, fret: 3, finger: 1, interval: '1' }, // G
                            { string: 5, fret: 0, finger: 1, interval: '2' }, // A
                            { string: 4, fret: 0, finger: 1, interval: '3' }, // B
                            { string: 3, fret: 0, finger: 1, interval: '4' }, // C
                            { string: 2, fret: 0, finger: 1, interval: '5' }, // D
                            { string: 1, fret: 0, finger: 1, interval: '6' }  // E
                        ]
                    },
                    'E': {
                        name: 'E Shape',
                        rootString: 6,
                        rootFret: 0,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 6, fret: 0, finger: 1, interval: '1' }, // E
                            { string: 5, fret: 0, finger: 1, interval: '2' }, // F
                            { string: 4, fret: 2, finger: 2, interval: '3' }, // G
                            { string: 3, fret: 2, finger: 2, interval: '4' }, // A
                            { string: 2, fret: 2, finger: 2, interval: '5' }, // B
                            { string: 1, fret: 0, finger: 1, interval: '6' }  // C
                        ]
                    },
                    'D': {
                        name: 'D Shape',
                        rootString: 4,
                        rootFret: 0,
                        intervals: ['1', '2', '3', '4', '5', '6', '7'],
                        positions: [
                            { string: 4, fret: 0, finger: 1, interval: '1' }, // D
                            { string: 3, fret: 2, finger: 2, interval: '2' }, // E
                            { string: 2, fret: 2, finger: 2, interval: '3' }, // F
                            { string: 1, fret: 0, finger: 1, interval: '4' }, // G
                            { string: 0, fret: 0, finger: 1, interval: '5' }, // A
                            { string: 0, fret: 2, finger: 2, interval: '6' }  // B
                        ]
                    }
                },
                keys: ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'],
                practiceTypes: ['scale', 'chord'],
                modes: ['single', 'connection', 'random']
            };

            // CAGEDç»ƒä¹ çŠ¶æ€
            let cagedState = {
                enabled: false,
                practiceType: 'scale', // å›ºå®šä¸ºéŸ³é˜¶ç»ƒä¹ 
                selectedShapes: ['C', 'A', 'G', 'E', 'D'], // é»˜è®¤å…¨éƒ¨é€‰ä¸­
                currentKey: 'C',
                practiceMode: 'connection', // é»˜è®¤ä¸ºå½¢çŠ¶è¿æ¥
                currentShape: 'C',
                currentExercise: null,
                currentScaleType: null, // å½“å‰ç»ƒä¹ çš„éŸ³é˜¶ç±»å‹ï¼ˆç”¨äºä¿æŒä¸€è‡´æ€§ï¼‰
                currentRootNote: null, // å½“å‰ç»ƒä¹ çš„æ ¹éŸ³ï¼ˆç”¨äºä¿æŒä¸€è‡´æ€§ï¼‰
                isManualSwitch: false, // æ ‡è®°æ˜¯å¦ä¸ºæ‰‹åŠ¨åˆ‡æ¢å½¢çŠ¶
                completedShapesInCurrentRound: [], // å½“å‰è½®æ¬¡ä¸­å·²å®Œæˆçš„å½¢çŠ¶
                isNewRound: true // æ ‡è®°æ˜¯å¦å¼€å§‹æ–°ä¸€è½®ç»ƒä¹ 
            };

            // CAGEDå’Œå¼¦ç»ƒä¹ çŠ¶æ€
            let cagedChordState = {
                enabled: false,
                practiceType: 'chord', // å›ºå®šä¸ºå’Œå¼¦ç»ƒä¹ 
                selectedShapes: ['C', 'A', 'G', 'E', 'D'], // é»˜è®¤å…¨éƒ¨é€‰ä¸­
                currentKey: 'C',
                practiceMode: 'connection', // é»˜è®¤ä¸ºå½¢çŠ¶è¿æ¥
                currentShape: 'C',
                currentExercise: null,
                currentChordType: null, // å½“å‰ç»ƒä¹ çš„å’Œå¼¦ç±»å‹ï¼ˆç”¨äºä¿æŒä¸€è‡´æ€§ï¼‰
                currentRootNote: null, // å½“å‰ç»ƒä¹ çš„æ ¹éŸ³ï¼ˆç”¨äºä¿æŒä¸€è‡´æ€§ï¼‰
                isManualSwitch: false, // æ ‡è®°æ˜¯å¦ä¸ºæ‰‹åŠ¨åˆ‡æ¢å½¢çŠ¶
                completedShapesInCurrentRound: [], // å½“å‰è½®æ¬¡ä¸­å·²å®Œæˆçš„å½¢çŠ¶
                isNewRound: true // æ ‡è®°æ˜¯å¦å¼€å§‹æ–°ä¸€è½®ç»ƒä¹ 
            };
            
            // å°†cagedStateã€cagedSystemã€cagedChordStateæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.cagedState = cagedState;
            window.cagedSystem = cagedSystem;
            window.cagedChordState = cagedChordState;

            // MIDIè®¾å¤‡çŠ¶æ€
            let midiState = {
                enabled: false,
                devices: [],
                currentDevice: null,
                midiAccess: null,
                lastNote: null,
                lastVelocity: 0,
                lastTimestamp: 0,
                errorCount: 0,
                maxErrors: 5,
                isConnected: false
            };
            
            // å°†midiStateæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.midiState = midiState;

            // MIDIè®¾å¤‡æ£€æµ‹å’Œå¤„ç†
            async function initializeMIDI() {
                try {
                    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒWeb MIDI API
                    if (!navigator.requestMIDIAccess) {
                        console.log('æµè§ˆå™¨ä¸æ”¯æŒWeb MIDI API');
                        updateMIDIStatus('æµè§ˆå™¨ä¸æ”¯æŒMIDIåŠŸèƒ½', false);
                        return false;
                    }

                    // è¯·æ±‚MIDIè®¿é—®æƒé™
                    const midiAccess = await navigator.requestMIDIAccess({ sysex: false });
                    window.midiState.midiAccess = midiAccess;
                    window.midiState.errorCount = 0; // é‡ç½®é”™è¯¯è®¡æ•°

                    // ç›‘å¬MIDIè®¾å¤‡è¿æ¥/æ–­å¼€
                    midiAccess.onstatechange = handleMIDIStateChange;

                    // è·å–å·²è¿æ¥çš„è®¾å¤‡
                    updateMIDIDevices();

                    console.log('MIDIåˆå§‹åŒ–æˆåŠŸ');
                    return true;
                } catch (error) {
                    console.error('MIDIåˆå§‹åŒ–å¤±è´¥:', error);
                    window.midiState.errorCount++;

                    let errorMessage = 'MIDIåˆå§‹åŒ–å¤±è´¥';
                    if (error.name === 'SecurityError') {
                        errorMessage = 'MIDIæƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®';
                    } else if (error.name === 'AbortError') {
                        errorMessage = 'MIDIè®¾å¤‡è®¿é—®è¢«ä¸­æ–­';
                    } else if (error.name === 'InvalidStateError') {
                        errorMessage = 'MIDIè®¾å¤‡çŠ¶æ€æ— æ•ˆ';
                    }

                    updateMIDIStatus(errorMessage, false);

                    // å°è¯•è‡ªåŠ¨é‡è¿
                    if (window.midiState.errorCount < window.midiState.maxErrors) {
                        console.log(`å°è¯•é‡æ–°è¿æ¥MIDIè®¾å¤‡ (${window.midiState.errorCount}/${window.midiState.maxErrors})`);
                        setTimeout(() => {
                            if (window.midiState.enabled) {
                                initializeMIDI();
                            }
                        }, 2000 * window.midiState.errorCount); // é€’å¢å»¶è¿Ÿ
                    }

                    return false;
                }
            }

            // å°†MIDIå‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.initializeMIDI = initializeMIDI;

            // å¤„ç†MIDIè®¾å¤‡çŠ¶æ€å˜åŒ–
            function handleMIDIStateChange(event) {
                console.log('MIDIè®¾å¤‡çŠ¶æ€å˜åŒ–:', event.port.name, event.port.state);
                updateMIDIDevices();
            }

            // æ›´æ–°MIDIè®¾å¤‡åˆ—è¡¨
            function updateMIDIDevices() {
                if (!window.midiState.midiAccess) return;

                const devices = [];
                let connectedCount = 0;

                for (const input of window.midiState.midiAccess.inputs.values()) {
                    if (input.state === 'connected') {
                        const device = {
                            id: input.id,
                            name: input.name,
                            manufacturer: input.manufacturer,
                            state: input.state,
                            connection: input.connection,
                            input: input
                        };
                        devices.push(device);
                        connectedCount++;
                    }
                }

                window.midiState.devices = devices;
                window.midiState.isConnected = connectedCount > 0;

                displayMIDIDevices();
                updateMIDIConnectionStatus(connectedCount);
            }

            // æ›´æ–°MIDIè¿æ¥çŠ¶æ€
            function updateMIDIConnectionStatus(connectedCount) {
                const deviceStatus = document.getElementById('midiDeviceStatus');
                if (!deviceStatus) return;

                if (connectedCount > 0) {
                    deviceStatus.textContent = `å·²è¿æ¥ ${connectedCount} ä¸ªMIDIè®¾å¤‡`;
                    deviceStatus.className = 'midi-device-status connected';
                } else {
                    deviceStatus.textContent = 'æœªæ£€æµ‹åˆ°MIDIè®¾å¤‡';
                    deviceStatus.className = 'midi-device-status disconnected';
                }
            }

            // æ˜¾ç¤ºMIDIè®¾å¤‡ä¿¡æ¯
            function displayMIDIDevices() {
                const deviceInfo = document.getElementById('midiDeviceInfo');
                const deviceStatus = document.getElementById('midiDeviceStatus');
                const deviceList = document.getElementById('midiDeviceList');
                
                if (!deviceInfo || !deviceStatus || !deviceList) return;
                
                if (window.midiState.devices.length > 0) {
                    deviceStatus.textContent = `æ£€æµ‹åˆ° ${window.midiState.devices.length} ä¸ªMIDIè®¾å¤‡`;
                    deviceInfo.style.display = 'block';
                    
                    // æ˜¾ç¤ºè®¾å¤‡åˆ—è¡¨
                    deviceList.innerHTML = '';
                    window.midiState.devices.forEach(device => {
                        const deviceItem = document.createElement('div');
                        deviceItem.className = 'midi-device-item';
                        deviceItem.textContent = `${device.name} (${device.manufacturer})`;
                        deviceList.appendChild(deviceItem);
                    });
                } else {
                    deviceStatus.textContent = 'æœªæ£€æµ‹åˆ°MIDIè®¾å¤‡';
                    deviceInfo.style.display = 'none';
                }
            }

            // æ›´æ–°MIDIçŠ¶æ€æ˜¾ç¤º
            function updateMIDIStatus(message, connected) {
                const deviceStatus = document.getElementById('midiDeviceStatus');
                if (deviceStatus) {
                    deviceStatus.textContent = message;
                    deviceStatus.style.color = connected ? '#10b981' : '#ef4444';
                }
            }

            // å¤„ç†MIDIè¾“å…¥
            function handleMIDIInput(event) {
                if (!window.midiState.enabled) return;

                // å¤„ç†æ‰€æœ‰MIDIé€šé“çš„Note Onäº‹ä»¶
                const command = event.data[0] & 0xF0; // æå–å‘½ä»¤éƒ¨åˆ†
                const noteNumber = event.data[1];
                const velocity = event.data[2];

                // åªå¤„ç†Note Onæ¶ˆæ¯ (0x90)
                if (command === 0x90 && velocity > 0) {
                    // è®¾ç½®æœ€å°åŠ›åº¦é˜ˆå€¼ï¼Œé¿å…è¯¯è§¦å‘
                    const minVelocity = 10; // æœ€å°åŠ›åº¦é˜ˆå€¼
                    if (velocity < minVelocity) return;

                    // å°†MIDIéŸ³ç¬¦å·è½¬æ¢ä¸ºéŸ³ç¬¦åç§°
                    const noteName = midiToNoteName(noteNumber);

                    console.log('MIDIè¾“å…¥:', noteName, 'åŠ›åº¦:', velocity);

                    // æ›´æ–°MIDIçŠ¶æ€
                    window.midiState.lastNote = noteName;
                    window.midiState.lastVelocity = velocity;
                    window.midiState.lastTimestamp = Date.now();

                    // æ˜¾ç¤ºMIDIè¾“å…¥åé¦ˆ
                    showMIDIInputFeedback(noteName, velocity);

                    // å¤„ç†éŸ³ç¬¦æ£€æµ‹
                    processMIDINote(noteName);
                }
            }

            // æ˜¾ç¤ºMIDIè¾“å…¥åé¦ˆ
            function showMIDIInputFeedback(noteName, velocity) {
                // åˆ›å»ºæˆ–æ›´æ–°MIDIåé¦ˆæ˜¾ç¤ºå…ƒç´ 
                let feedbackEl = document.getElementById('midiInputFeedback');
                if (!feedbackEl) {
                    feedbackEl = document.createElement('div');
                    feedbackEl.id = 'midiInputFeedback';
                    feedbackEl.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: rgba(58, 159, 196, 0.9);
                        color: white;
                        padding: 10px 15px;
                        border-radius: 8px;
                        font-size: 18px;
                        font-weight: bold;
                        z-index: 10001;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                    `;
                    document.body.appendChild(feedbackEl);
                }

                // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                const noteWithoutOctave = noteName.replace(/\d+$/, '');
                feedbackEl.textContent = `â™ª ${noteWithoutOctave}`;

                // æ ¹æ®åŠ›åº¦è°ƒæ•´é€æ˜åº¦å’Œå¤§å°
                const opacity = Math.min(1, 0.5 + (velocity / 127) * 0.5);
                const scale = 1 + (velocity / 127) * 0.2;
                feedbackEl.style.opacity = opacity;
                feedbackEl.style.transform = `scale(${scale})`;

                // çŸ­æš‚æ˜¾ç¤ºåæ·¡å‡º
                feedbackEl.style.display = 'block';
                clearTimeout(window.midiState.feedbackTimeout);
                window.midiState.feedbackTimeout = setTimeout(() => {
                    feedbackEl.style.opacity = '0';
                    setTimeout(() => {
                        feedbackEl.style.display = 'none';
                    }, 300);
                }, 800);
            }

            // MIDIéŸ³ç¬¦å·è½¬æ¢ä¸ºéŸ³ç¬¦åç§°
            function midiToNoteName(midiNumber) {
                const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                const octave = Math.floor(midiNumber / 12) - 1;
                const noteIndex = midiNumber % 12;
                return noteNames[noteIndex] + octave;
            }

            // åˆ¤æ–­ä¸¤ä¸ªéŸ³ç¬¦æ˜¯å¦ç­‰ä»·ï¼ˆè€ƒè™‘å‡å·å’Œé™å·ï¼‰
            function isEquivalentNote(note1, note2) {
                if (note1 === note2) return true;

                // å®šä¹‰ç­‰ä»·çš„éŸ³ç¬¦å¯¹
                const equivalentPairs = [
                    ['Câ™¯', 'Dâ™­'], ['Dâ™¯', 'Eâ™­'], ['Fâ™¯', 'Gâ™­'],
                    ['Gâ™¯', 'Aâ™­'], ['Aâ™¯', 'Bâ™­']
                ];

                for (const pair of equivalentPairs) {
                    if ((note1 === pair[0] && note2 === pair[1]) ||
                        (note1 === pair[1] && note2 === pair[0])) {
                        return true;
                    }
                }

                return false;
            }

            // éŸ³çº§åˆ°åŠéŸ³æ•°çš„æ˜ å°„
            const intervalToSemitones = {
                '1': 0, 'â™­2': 1, '2': 2, 'â™¯2': 3, 'â™­3': 3, '3': 4, '4': 5,
                'â™¯4': 6, 'â™­5': 6, '5': 7, 'â™¯5': 8, 'â™­6': 8, '6': 9, 'â™¯6': 10,
                'â™­7': 10, '7': 11, 'â™­â™­7': 10,
                // å¤åˆéŸ³ç¨‹æ˜ å°„ï¼ˆ9=2, 11=4, 13=6ï¼‰
                'â™­9': 1, '9': 2, 'â™¯9': 3,
                '11': 4, 'â™¯11': 6,
                'â™­13': 8, '13': 9
            };

            // éŸ³ç¬¦åˆ°åŠéŸ³æ•°çš„æ˜ å°„
            const noteToSemitones = {
                'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4,
                'F': 5, 'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8,
                'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
            };

            // åŠéŸ³æ•°åˆ°éŸ³ç¬¦çš„æ˜ å°„
            const semitonesToNoteName = {
                0: 'C', 1: 'Câ™¯', 2: 'D', 3: 'Dâ™¯', 4: 'E', 5: 'F',
                6: 'Fâ™¯', 7: 'G', 8: 'Gâ™¯', 9: 'A', 10: 'Aâ™¯', 11: 'B'
            };

            // æ›´æ–°æ­£ç¡®ç­”æ¡ˆæ˜¾ç¤º
            function updateCorrectAnswerDisplay() {
                // è¿™ä¸ªå‡½æ•°åº”è¯¥å·²ç»åœ¨åŸä»£ç ä¸­å®šä¹‰
                if (typeof window.updateCorrectAnswerDisplay === 'function') {
                    window.updateCorrectAnswerDisplay();
                }
            }

            // å¤„ç†MIDIéŸ³ç¬¦æ£€æµ‹
            function processMIDINote(noteName) {
                // æå–éŸ³ç¬¦åç§°ï¼ˆå»æ‰å…«åº¦ï¼‰
                const note = noteName.replace(/\d+$/, '');

                console.log('MIDIè·¯ç”±å¤„ç†: éŸ³ç¬¦=' + note +
                    ', pitchFindingMode=' + (window.state ? window.state.pitchFindingMode : 'undefined') +
                    ', currentIntervalExercise=' + (window.state && window.state.currentIntervalExercise ? 'true' : 'false') +
                    ', currentSequence=' + (window.state && window.state.currentSequence ? `[${window.state.currentSequence.join(', ')}]` : 'undefined') +
                    ', currentNote=' + (window.state ? window.state.currentNote : 'undefined'));

                // æ ¹æ®å½“å‰ç»ƒä¹ æ¨¡å¼å¤„ç†éŸ³ç¬¦ - ä¸processAudioç›¸åŒçš„è·¯ç”±é€»è¾‘
                if (window.cagedState && window.cagedState.enabled && window.cagedState.practiceMode) {
                    console.log('MIDIè·¯ç”±: è½¬åˆ°CAGEDç»ƒä¹ å¤„ç†');
                    processCagedMIDINote(note);
                } else if (window.state && window.state.pitchFindingMode) {
                    // æ‰¾éŸ³ç»ƒä¹ æ¨¡å¼ï¼ˆä¼˜å…ˆçº§é«˜äºéŸ³ç¨‹ç»ƒä¹ ï¼‰
                    console.log('MIDIè·¯ç”±: è½¬åˆ°æ‰¾éŸ³ç»ƒä¹ å¤„ç†');
                    processPitchFindingMIDINote(note);
                } else if (window.state && window.state.currentIntervalExercise) {
                    // éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                    console.log('MIDIè·¯ç”±: è½¬åˆ°éŸ³ç¨‹ç»ƒä¹ å¤„ç†');
                    processIntervalExerciseMIDINote(note);
                } else if (window.state && window.state.currentSequence && window.state.currentSequence.length > 0) {
                    // åºåˆ—ç»ƒä¹ æ¨¡å¼ - æ˜ç¡®æ£€æŸ¥åºåˆ—ç»ƒä¹ çŠ¶æ€
                    console.log('MIDIè·¯ç”±: è½¬åˆ°åºåˆ—ç»ƒä¹ å¤„ç†');
                    processSequenceMIDINote(note);
                } else if (window.state && window.state.currentNote) {
                    // å¸¸è§„éŸ³é«˜ç»ƒä¹ æ¨¡å¼
                    console.log('MIDIè·¯ç”±: è½¬åˆ°å¸¸è§„éŸ³é«˜ç»ƒä¹ å¤„ç†');
                    processPitchFindingMIDINote(note);
                } else {
                    // å…¶ä»–æ¨¡å¼
                    console.log('MIDIè·¯ç”±: è½¬åˆ°å…¶ä»–æ¨¡å¼å¤„ç†');
                    processRegularMIDINote(note);
                }
            }

            // CAGEDç»ƒä¹ çš„MIDIå¤„ç†
            function processCagedMIDINote(note) {
                const currentShape = window.cagedSystem.shapes[window.cagedState.currentShape];
                const rootNote = window.cagedState.currentKey;
                
                if (checkCagedMatch(note, rootNote, currentShape)) {
                    handleCagedCorrect();
                }
            }

            // æ‰¾éŸ³ç»ƒä¹ çš„MIDIå¤„ç†
            function processPitchFindingMIDINote(note) {
                console.log('æ‰¾éŸ³ç»ƒä¹ MIDIå¤„ç†:', note);
                if (!window.state) return;

                const targetNote = window.state.currentNote;
                if (!targetNote) return;

                console.log('ç›®æ ‡éŸ³ç¬¦:', targetNote, 'æ‰¾éŸ³æ¨¡å¼:', window.state.pitchFindingMode);

                // æ£€æŸ¥æ˜¯å¦åœ¨æ‰¾éŸ³ç»ƒä¹ æ¨¡å¼ä¸”å·²ç»ç­”å¯¹äº†
                if (window.state.pitchFindingAnswered) return;

                // æ£€æŸ¥æ˜¯å¦åœ¨å¸¸è§„ç»ƒä¹ æ¨¡å¼ä¸”å·²ç»ç­”å¯¹äº†
                if (window.state.isAnswered) return;

                if (isEquivalentNote(note, targetNote)) {
                    console.log(`æ‰¾éŸ³ç»ƒä¹ : éŸ³ç¬¦ ${note} åŒ¹é…ç›®æ ‡éŸ³ç¬¦ ${targetNote}`);
                    if (window.state.pitchFindingMode) {
                        // æ‰¾éŸ³ç»ƒä¹ æ¨¡å¼ï¼šç›´æ¥è°ƒç”¨ä¸»è¦çš„handlePitchFindingCorrectå‡½æ•°
                        console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: è°ƒç”¨handlePitchFindingCorrect');
                        if (typeof handlePitchFindingCorrect === 'function') {
                            handlePitchFindingCorrect();
                        } else if (typeof window.handlePitchFindingCorrect === 'function') {
                            window.handlePitchFindingCorrect();
                        } else {
                            console.error('æ‰¾éŸ³ç»ƒä¹ MIDI: handlePitchFindingCorrectå‡½æ•°ä¸å¯ç”¨');
                        }
                    } else {
                        // å¸¸è§„ç»ƒä¹ æ¨¡å¼ï¼šæ‰§è¡Œæœ¬åœ°ç‰ˆæœ¬çš„handleCorrectAnsweré€»è¾‘
                        console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: æ‰§è¡Œæœ¬åœ°handleCorrectAnswer');
                        if (window.state) {
                            window.state.correctCount++;
                            window.state.currentStep++;
                            const justDone = window.state.currentStep - 1;

                            const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                            if (el) {
                                el.classList.remove('current');
                                el.classList.add('played');
                                console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: å·²æ ‡è®°éŸ³çº§ä¸ºå·²æ’­æ”¾', justDone);
                            }

                            // æ£€æŸ¥æ˜¯å¦å®Œæˆæ•´ä¸ªåºåˆ—
                            if (window.state.currentStep >= window.state.currentSequence.length) {
                                window.state.isAnswered = true;
                                console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: åºåˆ—å®Œæˆ');

                                // å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜
                                setTimeout(() => {
                                    console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: å°è¯•ç”Ÿæˆä¸‹ä¸€é¢˜');

                                    // é‡ç½®å¿…è¦çš„çŠ¶æ€ä»¥ä¾¿ç”Ÿæˆæ–°é¢˜ç›®
                                    if (window.state) {
                                        window.state.isAnswered = false;
                                        window.state.currentStep = 0;
                                        console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: å·²é‡ç½®çŠ¶æ€');
                                    }

                                    try {
                                        if (typeof window.generateExercise === 'function') {
                                            window.generateExercise();
                                        } else if (typeof generateExercise === 'function') {
                                            generateExercise();
                                        } else {
                                            console.error('æ‰¾éŸ³ç»ƒä¹ MIDI: generateExerciseå‡½æ•°ä¸å¯ç”¨');
                                            // å°è¯•æ‰‹åŠ¨è§¦å‘å¼€å§‹æŒ‰é’®
                                            const startBtn = document.getElementById('startBtn');
                                            if (startBtn && !window.state.isRecording) {
                                                console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: å°è¯•ç‚¹å‡»å¼€å§‹æŒ‰é’®');
                                                startBtn.click();
                                            }
                                        }
                                    } catch (error) {
                                        console.error('æ‰¾éŸ³ç»ƒä¹ MIDI: ç”Ÿæˆä¸‹ä¸€é¢˜æ—¶å‡ºé”™:', error);
                                    }
                                }, 1000);
                            } else {
                                // æ ‡è®°ä¸‹ä¸€ä¸ªéŸ³çº§ä¸ºå½“å‰
                                const next = document.querySelector(`.sequence-item[data-index="${window.state.currentStep}"]`);
                                if (next) {
                                    next.classList.add('current');
                                    console.log('æ‰¾éŸ³ç»ƒä¹ MIDI: å·²æ ‡è®°ä¸‹ä¸€ä¸ªéŸ³çº§ä¸ºå½“å‰', window.state.currentStep);
                                }
                            }
                        }
                    }
                }
            }

            // å¸¸è§„ç»ƒä¹ çš„MIDIå¤„ç†
            function processRegularMIDINote(note) {
                // æ£€æŸ¥æ˜¯å¦åœ¨éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                if (window.state && window.state.currentIntervalExercise) {
                    processIntervalExerciseMIDINote(note);
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦åœ¨å¸¸è§„éŸ³é«˜ç»ƒä¹ æ¨¡å¼
                if (window.state && window.state.currentNote) {
                    processPitchDetectionMIDINote(note);
                    return;
                }

                // æ£€æŸ¥æ˜¯å¦åœ¨è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼
                if (window.state && window.state.isCustomChordMode) {
                    processCustomChordMIDINote(note);
                    return;
                }

        
                console.log('å¸¸è§„ç»ƒä¹ MIDIéŸ³ç¬¦:', note);
            }

            // éŸ³ç¨‹ç»ƒä¹ çš„MIDIå¤„ç†
            function processIntervalExerciseMIDINote(note) {
                console.log('éŸ³ç¨‹ç»ƒä¹ MIDIå¤„ç†:', note);
                if (!window.state || !window.state.currentIntervalExercise) return;

                const exercise = window.state.currentIntervalExercise;
                if (!exercise || exercise.answered) return;

                // æ£€æŸ¥å¼¹å¯¹çš„éŸ³ç¬¦æ˜¯å“ªä¸ªéŸ³ç¨‹
                const intervals = exercise.currentInterval.split(' ');
                const rootNote = exercise.rootNote;

                console.log('æ£€æŸ¥éŸ³ç¨‹:', intervals, 'æ ¹éŸ³:', rootNote);

                for (const interval of intervals) {
                    if (exercise.completedIntervals && exercise.completedIntervals.includes(interval)) {
                        continue; // è·³è¿‡å·²ç»å®Œæˆçš„éŸ³ç¨‹
                    }

                    const intervalNoteValue = noteToSemitones[rootNote] + intervalToSemitones[interval];
                    const intervalNoteName = semitonesToNoteName[intervalNoteValue % 12];

                    console.log(`éŸ³ç¨‹ ${interval}: æœŸæœ›éŸ³ç¬¦ ${intervalNoteName}, æ”¶åˆ°éŸ³ç¬¦ ${note}`);

                    if (isEquivalentNote(note, intervalNoteName)) {
                        console.log(`éŸ³ç¨‹ç»ƒä¹ : éŸ³ç¬¦ ${note} åŒ¹é…éŸ³ç¨‹ ${interval}`);

                        // æ‰§è¡Œæœ¬åœ°ç‰ˆæœ¬çš„handleIntervalPartialCorrecté€»è¾‘
                        if (window.state.currentIntervalExercise) {
                            const exercise = window.state.currentIntervalExercise;

                            // åˆå§‹åŒ–å·²å®Œæˆçš„éŸ³ç¨‹æ•°ç»„
                            if (!exercise.completedIntervals) {
                                exercise.completedIntervals = [];
                            }

                            // æ£€æŸ¥è¿™ä¸ªéŸ³ç¨‹æ˜¯å¦å·²ç»å¼¹å¯¹è¿‡äº†
                            if (exercise.completedIntervals.includes(interval)) {
                                console.log(`éŸ³ç¨‹ ${interval} å·²ç»å¼¹å¯¹è¿‡äº†ï¼Œå¿½ç•¥é‡å¤`);
                                return;
                            }

                            // æ·»åŠ åˆ°å·²å®Œæˆåˆ—è¡¨
                            exercise.completedIntervals.push(interval);
                            console.log(`éŸ³ç¨‹ç»ƒä¹ : éŸ³ç¨‹ ${interval} å·²æ ‡è®°ä¸ºå®Œæˆ`, exercise.completedIntervals);

                            // æ›´æ–°æ˜¾ç¤ºï¼Œå°†å¼¹å¯¹çš„éŸ³ç¨‹å˜ç°
                            const intervalDisplay = document.getElementById('intervalExerciseDisplay');
                            if (intervalDisplay) {
                                // æŸ¥æ‰¾å½“å‰é¢˜ç›®æ˜¾ç¤ºå…ƒç´ å¹¶æ›´æ–°
                                const currentInterval = intervalDisplay.querySelector('.current-interval');
                                if (currentInterval) {
                                    const intervalSpans = currentInterval.querySelectorAll('span');
                                    intervalSpans.forEach(span => {
                                        if (span.textContent.trim() === interval) {
                                            span.style.opacity = '0.3';
                                            span.style.textDecoration = 'line-through';
                                        }
                                    });
                                }
                            }

                            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰éŸ³ç¨‹éƒ½å¼¹å¯¹äº†
                            const intervals = exercise.currentInterval.split(' ');
                            if (exercise.completedIntervals.length >= intervals.length) {
                                console.log('éŸ³ç¨‹ç»ƒä¹ : æ‰€æœ‰éŸ³ç¨‹éƒ½å¼¹å¯¹äº†ï¼Œå®Œæˆé¢˜ç›®');
                                exercise.answered = true;

                                // æ˜¾ç¤ºå®Œæˆæç¤º
                                const statusIndicator = document.getElementById('statusIndicator');
                                if (statusIndicator) {
                                    statusIndicator.textContent = 'éŸ³ç¨‹ç»ƒä¹ å®Œæˆï¼';
                                    statusIndicator.className = 'status-indicator success';
                                    setTimeout(() => {
                                        if (window.isRecording) {
                                            statusIndicator.textContent = 'å½•éŸ³ä¸­...';
                                            statusIndicator.className = 'status-indicator recording';
                                        }
                                    }, 1500);
                                }

                                // è·å–ä¸‹ä¸€é¢˜é—´éš”æ—¶é—´è®¾ç½®
                                const intervalSecondsSelect = document.getElementById('intervalSeconds');
                                let delayTime = 2000; // é»˜è®¤2ç§’

                                if (intervalSecondsSelect) {
                                    const intervalSeconds = parseInt(intervalSecondsSelect.value);
                                    if (intervalSeconds === 0) {
                                        delayTime = 0; // æ‰‹åŠ¨æ¨¡å¼
                                    } else {
                                        delayTime = intervalSeconds * 1000;
                                    }
                                }

                                // æ£€æŸ¥æŒ‡æ¿æ˜¯å¦éšè—ï¼Œéšè—åˆ™ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
                                const fretboardContainer = document.getElementById('fretboardContainer');
                                const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';

                                if (!isFretboardVisible) {
                                    delayTime = 100; // éšè—æŒ‡æ¿æ—¶å¿«é€Ÿè¿›å…¥ä¸‹ä¸€é¢˜
                                } else if (delayTime === 0) {
                                    // æ‰‹åŠ¨æ¨¡å¼ä¸”æ˜¾ç¤ºæŒ‡æ¿ï¼Œä¸è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜
                                    console.log('éŸ³ç¨‹ç»ƒä¹ MIDI: æ‰‹åŠ¨æ¨¡å¼ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨è¿›å…¥ä¸‹ä¸€é¢˜');
                                    return;
                                }

                                // è®¾ç½®å®šæ—¶å™¨è¿›å…¥ä¸‹ä¸€é¢˜
                                if (window.state.intervalNextTimeout) {
                                    clearTimeout(window.state.intervalNextTimeout);
                                }

                                window.state.intervalNextTimeout = setTimeout(() => {
                                    if (typeof generateNextIntervalExercise === 'function') {
                                        generateNextIntervalExercise();
                                    } else if (typeof window.generateNextIntervalExercise === 'function') {
                                        window.generateNextIntervalExercise();
                                    } else {
                                        console.error('éŸ³ç¨‹ç»ƒä¹ MIDI: generateNextIntervalExerciseå‡½æ•°ä¸å¯ç”¨');
                                    }
                                }, delayTime);
                            }
                        }
                        break;
                    }
                }
            }

            // éŸ³é«˜æ£€æµ‹ç»ƒä¹ çš„MIDIå¤„ç†
            function processPitchDetectionMIDINote(note) {
                if (!window.state || !window.state.currentNote || window.state.isAnswered) return;

                const targetNote = window.state.currentNote;
                if (isEquivalentNote(note, targetNote)) {
                    console.log('éŸ³é«˜æ£€æµ‹MIDI: éŸ³ç¬¦åŒ¹é…ï¼Œæ‰§è¡Œæœ¬åœ°handleCorrectAnswer');

                    // æ‰§è¡Œæœ¬åœ°ç‰ˆæœ¬çš„handleCorrectAnsweré€»è¾‘
                    if (window.state && window.state.currentSequence && window.state.currentSequence.length > 0) {
                        window.state.correctCount++;
                        window.state.currentStep++;
                        const justDone = window.state.currentStep - 1;

                        const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                        if (el) {
                            el.classList.remove('current');
                            el.classList.add('played');
                            console.log('éŸ³é«˜æ£€æµ‹MIDI: å·²æ ‡è®°éŸ³çº§ä¸ºå·²æ’­æ”¾', justDone);
                        }

                        // æ£€æŸ¥æ˜¯å¦å®Œæˆæ•´ä¸ªåºåˆ—
                        if (window.state.currentStep >= window.state.currentSequence.length) {
                            window.state.isAnswered = true;
                            console.log('éŸ³é«˜æ£€æµ‹MIDI: åºåˆ—å®Œæˆ');

                            // å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜
                            setTimeout(() => {
                                console.log('éŸ³é«˜æ£€æµ‹MIDI: å°è¯•ç”Ÿæˆä¸‹ä¸€é¢˜');

                                // é‡ç½®å¿…è¦çš„çŠ¶æ€ä»¥ä¾¿ç”Ÿæˆæ–°é¢˜ç›®
                                if (window.state) {
                                    window.state.isAnswered = false;
                                    window.state.currentStep = 0;
                                    console.log('éŸ³é«˜æ£€æµ‹MIDI: å·²é‡ç½®çŠ¶æ€');
                                }

                                try {
                                    if (typeof window.generateExercise === 'function') {
                                        window.generateExercise();
                                    } else if (typeof generateExercise === 'function') {
                                        generateExercise();
                                    } else {
                                        console.error('éŸ³é«˜æ£€æµ‹MIDI: generateExerciseå‡½æ•°ä¸å¯ç”¨');
                                        // å°è¯•æ‰‹åŠ¨è§¦å‘å¼€å§‹æŒ‰é’®
                                        const startBtn = document.getElementById('startBtn');
                                        if (startBtn && !window.state.isRecording) {
                                            console.log('éŸ³é«˜æ£€æµ‹MIDI: å°è¯•ç‚¹å‡»å¼€å§‹æŒ‰é’®');
                                            startBtn.click();
                                        }
                                    }
                                } catch (error) {
                                    console.error('éŸ³é«˜æ£€æµ‹MIDI: ç”Ÿæˆä¸‹ä¸€é¢˜æ—¶å‡ºé”™:', error);
                                }
                            }, 1000);
                        } else {
                            // æ ‡è®°ä¸‹ä¸€ä¸ªéŸ³çº§ä¸ºå½“å‰
                            const next = document.querySelector(`.sequence-item[data-index="${window.state.currentStep}"]`);
                            if (next) {
                                next.classList.add('current');
                                console.log('éŸ³é«˜æ£€æµ‹MIDI: å·²æ ‡è®°ä¸‹ä¸€ä¸ªéŸ³çº§ä¸ºå½“å‰', window.state.currentStep);
                            }
                        }
                    }
                }
            }

            // è‡ªå®šä¹‰å’Œå¼¦ç»ƒä¹ çš„MIDIå¤„ç†
            function processCustomChordMIDINote(note) {
                if (!window.state || !window.state.isCustomChordMode) return;

                // è¿™é‡Œå¯ä»¥æ·»åŠ è‡ªå®šä¹‰å’Œå¼¦ç»ƒä¹ çš„MIDIå¤„ç†é€»è¾‘
                console.log('è‡ªå®šä¹‰å’Œå¼¦ç»ƒä¹ MIDIéŸ³ç¬¦:', note);
            }

            // åºåˆ—ç»ƒä¹ çš„MIDIå¤„ç†
            function processSequenceMIDINote(note) {
                if (!window.state || !window.state.currentSequence || window.state.isAnswered ||
                    (window.state.enableCooldown && window.state.isCoolingDown)) return;

                if (window.state.currentStep >= window.state.currentSequence.length) return;

                const currentInterval = window.state.currentSequence[window.state.currentStep];
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error('åºåˆ—ç»ƒä¹ MIDIå¤„ç†: æœªçŸ¥çš„éŸ³çº§', currentInterval);
                    return;
                }

                // è®¡ç®—å½“å‰æ­¥éª¤çš„ç›®æ ‡éŸ³ç¬¦
                const rootValue = noteToSemitones[window.state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetNote = semitonesToNoteName[targetSemitone];

                console.log(`åºåˆ—ç»ƒä¹ MIDI: å½“å‰éŸ³çº§=${currentInterval}, ç›®æ ‡éŸ³ç¬¦=${targetNote}, æ”¶åˆ°éŸ³ç¬¦=${note}`);

                if (isEquivalentNote(note, targetNote)) {
                    console.log('åºåˆ—ç»ƒä¹ MIDI: éŸ³ç¬¦åŒ¹é…ï¼Œæ‰§è¡Œæœ¬åœ°handleCorrectAnswer');

                    // æ‰§è¡Œæœ¬åœ°ç‰ˆæœ¬çš„handleCorrectAnsweré€»è¾‘
                    if (window.state) {
                        window.state.correctCount++;
                        window.state.currentStep++;
                        const justDone = window.state.currentStep - 1;

                        const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                        if (el) {
                            el.classList.remove('current');
                            el.classList.add('played');
                            console.log('åºåˆ—ç»ƒä¹ MIDI: å·²æ ‡è®°éŸ³çº§ä¸ºå·²æ’­æ”¾', justDone);
                        }

                        // æ£€æŸ¥æ˜¯å¦å®Œæˆæ•´ä¸ªåºåˆ—
                        if (window.state.currentStep >= window.state.currentSequence.length) {
                            window.state.isAnswered = true;
                            console.log('åºåˆ—ç»ƒä¹ MIDI: åºåˆ—å®Œæˆ');

                            // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦è¿›å…¥å†·å´æœŸ
                            if (window.state.enableCooldown) {
                                window.state.isCoolingDown = true;
                                if (window.state.cooldownTimeout) {
                                    clearTimeout(window.state.cooldownTimeout);
                                }
                                window.state.cooldownTimeout = setTimeout(() => {
                                    window.state.isCoolingDown = false;
                                }, window.state.cooldownDuration);
                            }

                            // æ ¹æ®è®¾ç½®å†³å®šå»¶è¿Ÿæ—¶é—´
                            let delayTime = 0; // é»˜è®¤æ— å»¶è¿Ÿ
                            if (window.state.enableFixedDelay) {
                                delayTime = window.state.fixedDelayDuration;
                            }

                            // å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜
                            setTimeout(() => {
                                console.log('åºåˆ—ç»ƒä¹ MIDI: å°è¯•ç”Ÿæˆä¸‹ä¸€é¢˜');

                                // é‡ç½®å¿…è¦çš„çŠ¶æ€ä»¥ä¾¿ç”Ÿæˆæ–°é¢˜ç›®
                                if (window.state) {
                                    window.state.isAnswered = false;
                                    window.state.currentStep = 0;
                                    console.log('åºåˆ—ç»ƒä¹ MIDI: å·²é‡ç½®çŠ¶æ€');
                                }

                                try {
                                    if (typeof window.generateExercise === 'function') {
                                        window.generateExercise();
                                    } else if (typeof generateExercise === 'function') {
                                        generateExercise();
                                    } else {
                                        console.error('åºåˆ—ç»ƒä¹ MIDI: generateExerciseå‡½æ•°ä¸å¯ç”¨');
                                        // å°è¯•æ‰‹åŠ¨è§¦å‘å¼€å§‹æŒ‰é’®
                                        const startBtn = document.getElementById('startBtn');
                                        if (startBtn && !window.state.isRecording) {
                                            console.log('åºåˆ—ç»ƒä¹ MIDI: å°è¯•ç‚¹å‡»å¼€å§‹æŒ‰é’®');
                                            startBtn.click();
                                        }
                                    }
                                } catch (error) {
                                    console.error('åºåˆ—ç»ƒä¹ MIDI: ç”Ÿæˆä¸‹ä¸€é¢˜æ—¶å‡ºé”™:', error);
                                }
                            }, delayTime);
                        } else {
                            // æ ‡è®°ä¸‹ä¸€ä¸ªéŸ³çº§ä¸ºå½“å‰
                            const next = document.querySelector(`.sequence-item[data-index="${window.state.currentStep}"]`);
                            if (next) {
                                next.classList.add('current');
                                console.log('åºåˆ—ç»ƒä¹ MIDI: å·²æ ‡è®°ä¸‹ä¸€ä¸ªéŸ³çº§ä¸ºå½“å‰', window.state.currentStep);
                            }
                        }
                    }
                }
            }

            // è·å–å½“å‰éŸ³ç¨‹ç»ƒä¹ çš„ç›®æ ‡éŸ³ç¬¦
            function getCurrentIntervalTargetNote() {
                if (!window.state || !window.state.intervalState) return null;

                const intervalState = window.state.intervalState;
                const rootNote = intervalState.rootNote;
                const interval = intervalState.currentInterval;

                if (!rootNote || !interval) return null;

                // è®¡ç®—ç›®æ ‡éŸ³ç¬¦
                const rootValue = noteToSemitones[rootNote];
                const intervalSemitones = intervalToSemitones[interval];
                const targetSemitone = (rootValue + intervalSemitones) % 12;

                return semitonesToNoteName(targetSemitone);
            }

            // è¿æ¥MIDIè®¾å¤‡
            function connectMIDIDevices() {
                if (!window.midiState.midiAccess) return;

                let connectedCount = 0;

                // è¿æ¥æ‰€æœ‰è¾“å…¥è®¾å¤‡
                for (const input of window.midiState.midiAccess.inputs.values()) {
                    if (input.state === 'connected') {
                        try {
                            input.onmidimessage = handleMIDIInput;
                            connectedCount++;
                            console.log('å·²è¿æ¥MIDIè®¾å¤‡:', input.name, 'ID:', input.id);
                        } catch (error) {
                            console.error('è¿æ¥MIDIè®¾å¤‡å¤±è´¥:', input.name, error);
                        }
                    }
                }

                window.midiState.isConnected = connectedCount > 0;
                console.log(`æˆåŠŸè¿æ¥ ${connectedCount} ä¸ªMIDIè®¾å¤‡`);

                // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
                updateMIDIConnectionStatus(connectedCount);
            }

            // æ–­å¼€MIDIè®¾å¤‡
            function disconnectMIDIDevices() {
                if (!window.midiState.midiAccess) return;
                
                // æ–­å¼€æ‰€æœ‰è¾“å…¥è®¾å¤‡
                for (const input of window.midiState.midiAccess.inputs.values()) {
                    input.onmidimessage = null;
                    console.log('å·²æ–­å¼€MIDIè®¾å¤‡:', input.name);
                }
            }

            // å°†MIDIè®¾å¤‡è¿æ¥å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.connectMIDIDevices = connectMIDIDevices;
            window.disconnectMIDIDevices = disconnectMIDIDevices;
            function positionDropdown(menu, trigger) {
                const rect = trigger.getBoundingClientRect();
                menu.style.top = (rect.bottom + window.scrollY + 4) + 'px';
                menu.style.left = (rect.left + window.scrollX) + 'px';
                menu.style.minWidth = rect.width + 'px';
            }
                        // åˆå§‹åŒ–ä¹æ›²ä¸‹æ‹‰æ¡†åŠŸèƒ½
            window.initJazzStandardDropdown = function() {
                console.log('åˆå§‹åŒ–ä¹æ›²ä¸‹æ‹‰åˆ—è¡¨...');
                const dropdown = document.getElementById('jazzStandardDropdown');
                
                if (!dropdown) {
                    console.error('æ‰¾ä¸åˆ°jazzStandardDropdownå…ƒç´ ');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
                if (dropdown.dataset.initialized === 'true') {
                    console.log('ä¹æ›²ä¸‹æ‹‰åˆ—è¡¨å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡');
                    return;
                }
                
                const trigger = dropdown.querySelector('.dropdown-trigger');
                const menu = dropdown.querySelector('.dropdown-menu');
                const nativeSelect = document.getElementById('jazzStandard');
                
                // åŠ¨æ€ç”Ÿæˆæ­Œæ›²åˆ—è¡¨
                const jazzStandardsData = window.jazzStandards || jazzStandards;
                console.log('å¼€å§‹ç”Ÿæˆæ­Œæ›²åˆ—è¡¨ï¼ŒjazzStandardså¯¹è±¡:', jazzStandardsData);
                
                // æ¸…ç©ºç°æœ‰å†…å®¹
                menu.innerHTML = '';
                
                // æŒ‰å­—æ¯é¡ºåºç”Ÿæˆåˆ†ç»„
                const letters = Object.keys(jazzStandardsData).sort();
                console.log('æ‰¾åˆ°åˆ†ç»„:', letters);
                
                letters.forEach(letter => {
                    const group = jazzStandardsData[letter];
                    const songs = Object.keys(group).sort();
                    
                    if (songs.length > 0) {
                        // åˆ›å»ºåˆ†ç»„
                        const groupLi = document.createElement('li');
                        groupLi.className = 'dropdown-group';
                        
                        const groupHeader = document.createElement('div');
                        groupHeader.className = 'group-header';
                        groupHeader.textContent = letter;
                        groupLi.appendChild(groupHeader);
                        
                        const groupItems = document.createElement('ul');
                        groupItems.className = 'group-items';
                        
                        // æ·»åŠ æ­Œæ›²
                        songs.forEach(songName => {
                            const songLi = document.createElement('li');
                            songLi.className = 'dropdown-item';
                            songLi.setAttribute('data-value', songName);
                            
                            const itemText = document.createElement('span');
                            itemText.className = 'item-text';
                            itemText.textContent = songName;
                            songLi.appendChild(itemText);
                            
                            const infoIcon = document.createElement('span');
                            infoIcon.className = 'info-icon';
                            infoIcon.setAttribute('data-info', songName);
                            infoIcon.textContent = 'â„¹ï¸';
                            songLi.appendChild(infoIcon);
                            
                            groupItems.appendChild(songLi);
                        });
                        
                        groupLi.appendChild(groupItems);
                        menu.appendChild(groupLi);
                    }
                });
                
                // é‡æ–°è·å–åŠ¨æ€ç”Ÿæˆçš„å…ƒç´ 
                const items = dropdown.querySelectorAll('.dropdown-item');
                const infoIcons = dropdown.querySelectorAll('.info-icon');
                
                console.log('åŠ¨æ€ç”Ÿæˆå®Œæˆï¼Œæ‰¾åˆ°ä¹æ›²å…ƒç´ :', {
                    dropdown: !!dropdown,
                    trigger: !!trigger,
                    menu: !!menu,
                    items: items.length,
                    infoIcons: infoIcons.length,
                    nativeSelect: !!nativeSelect
                });
                
                // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                dropdown.dataset.initialized = 'true';

                // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º/éšè—
                trigger.addEventListener('click', function(e) {
                    console.log('ä¹æ›²ä¸‹æ‹‰åˆ—è¡¨è§¦å‘å™¨è¢«ç‚¹å‡»');
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = menu.classList.contains('show');
                    console.log('å½“å‰çŠ¶æ€:', isOpen ? 'æ‰“å¼€' : 'å…³é—­');
                    
                    if (isOpen) {
                        closeJazzDropdown();
                    } else {
                        openJazzDropdown();
                    }
                });

                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        closeJazzDropdown();
                    }
                });

                // é€‰æ‹©é€‰é¡¹
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»çš„æ˜¯ä¿¡æ¯å›¾æ ‡
                        if (e.target.classList.contains('info-icon') || e.target.closest('.info-icon')) {
                            return;
                        }
                        
                        e.stopPropagation();
                        const value = this.dataset.value;
                        const text = this.querySelector('.item-text').textContent;
                        
                        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                        dropdown.querySelector('.dropdown-text').textContent = text;
                        
                        // æ›´æ–°åŸç”Ÿselectçš„å€¼
                        nativeSelect.value = value;
                        
                        // è§¦å‘changeäº‹ä»¶
                        const changeEvent = new Event('change', { bubbles: true });
                        nativeSelect.dispatchEvent(changeEvent);
                        
                        // å…³é—­ä¸‹æ‹‰èœå•
                        closeJazzDropdown();
                        
                        console.log('é€‰æ‹©äº†ä¹æ›²:', value);
                    });
                });

                // ä¿¡æ¯å›¾æ ‡ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨äº‹ä»¶å§”æ‰˜
                
                // ç›´æ¥ä¸ºæ¯ä¸ªä¿¡æ¯å›¾æ ‡ç»‘å®šç‚¹å‡»äº‹ä»¶
                infoIcons.forEach((icon, index) => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        e.stopImmediatePropagation(); // é˜»æ­¢äº‹ä»¶è¿›ä¸€æ­¥ä¼ æ’­
                        const songName = this.dataset.info;
                        showSongInfo(songName);
                    });
                });
                
                // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                menu.addEventListener('click', function(e) {
                    if (e.target.classList.contains('info-icon')) {
                        e.stopPropagation();
                        e.preventDefault();
                        const songName = e.target.dataset.info;
                        showSongInfo(songName);
                        return;
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†åŒ…å«info-iconçš„å…ƒç´ 
                    const infoIcon = e.target.closest('.info-icon');
                    if (infoIcon) {
                        e.stopPropagation();
                        e.preventDefault();
                        const songName = infoIcon.dataset.info;
                        showSongInfo(songName);
                        return;
                    }
                });

                function openJazzDropdown() {
                    positionDropdown(menu, trigger);
                    menu.classList.add('show');
                    trigger.classList.add('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = 'â–²';
                    
                    // åŠ¨æ€è®¡ç®—ä½ç½®ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡
                    const rect = trigger.getBoundingClientRect();
                    const menuHeight = menu.offsetHeight || 300;
                    const viewportHeight = window.innerHeight;
                    
                    // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿï¼Œå‘ä¸Šå±•å¼€
                    if (rect.bottom + menuHeight > viewportHeight) {
                        menu.style.top = (rect.top - menuHeight) + 'px';
                    } else {
                        menu.style.top = rect.bottom + 'px';
                    }
                    
                    menu.style.left = rect.left + 'px';
                    menu.style.width = rect.width + 'px';
                }

                function closeJazzDropdown() {
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = 'â–¼';
                }

                // æ˜¾ç¤ºæ­Œæ›²ä¿¡æ¯å¼¹çª—
                window.showSongInfo = function(songName) {
                    console.log('=== showSongInfo å‡½æ•°è¢«è°ƒç”¨ ===');
                    console.log('æ­Œæ›²åç§°:', songName);
                    
                    // ç¡®ä¿å¯ä»¥è®¿é—®jazzStandardså¯¹è±¡
                    const jazzStandardsData = window.jazzStandards || jazzStandards;
                    console.log('jazzStandards å¯¹è±¡:', jazzStandardsData);
                    
                    // è·å–æ­Œæ›²æ•°æ®
                    let songData = null;
                    for (const letter in jazzStandardsData) {
                        if (jazzStandardsData[letter][songName]) {
                            songData = jazzStandardsData[letter][songName];
                            break;
                        }
                    }
                    
                    if (!songData) {
                        console.error('æ‰¾ä¸åˆ°æ­Œæ›²æ•°æ®:', songName);
                        alert('æ‰¾ä¸åˆ°æ­Œæ›²ä¿¡æ¯ï¼š' + songName);
                        return;
                    }
                    
                    console.log('æ‰¾åˆ°æ­Œæ›²æ•°æ®:', songData);
                    
                    // åˆ›å»ºå¼¹çª—
                    const modal = document.createElement('div');
                    modal.className = 'song-info-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.8);
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        z-index: 10001;
                    `;
                    
                    const content = document.createElement('div');
                    content.style.cssText = `
                        background: linear-gradient(135deg, #1e293b, #334155);
                        border-radius: 16px;
                        padding: 24px;
                        max-width: 500px;
                        width: 90%;
                        color: #e2e8f0;
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
                        border: 1px solid rgba(255, 255, 255, 0.1);
                    `;
                    
                    // æ„å»ºå’Œå¼¦è¿›è¡Œæ˜¾ç¤º
                    let chordsDisplay;
                    if (songName.includes('ç»ƒä¹ ') && songName.includes('ä¸ªè°ƒ')) {
                        // ç»ƒä¹ æ›²ç›®ï¼šæ˜¾ç¤ºè¯¦ç»†çš„å’Œå¼¦å¾ªç¯ä¿¡æ¯
                        const circleOfFifthsReverse = ['A', 'D', 'G', 'C', 'F', 'Bâ™­', 'Eâ™­', 'Aâ™­', 'Dâ™­', 'Gâ™­', 'B', 'E'];

                        if (songName.includes('Maj7') && !songName.includes('#11') && !songName.includes('#5')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}Maj7`).join(' â†’ ');
                        } else if (songName.includes('Min7') && !songName.includes('b5') && !songName.includes('Maj7')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m7`).join(' â†’ ');
                        } else if (songName.includes('Sus4b9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}sus4(b9)`).join(' â†’ ');
                        } else if (songName.includes('Maj7#11')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}Maj7(#11)`).join(' â†’ ');
                        } else if (songName.includes('7sus4') && !songName.includes('b9') && !songName.includes('13')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}7sus4`).join(' â†’ ');
                        } else if (songName.includes('Dom7')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}7`).join(' â†’ ');
                        } else if (songName.includes('Min7b5') && !songName.includes('â™®9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m7(b5)`).join(' â†’ ');
                        } else if (songName.includes('MinMaj7')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m(Maj7)`).join(' â†’ ');
                        } else if (songName.includes('13sus4b9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}13sus4(b9)`).join(' â†’ ');
                        } else if (songName.includes('Maj7#5')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}Maj7(#5)`).join(' â†’ ');
                        } else if (songName.includes('7#11') && !songName.includes('13')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}7(#11)`).join(' â†’ ');
                        } else if (songName.includes('Min7b5â™®9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}m7(b5,â™®9)`).join(' â†’ ');
                        } else if (songName.includes('13b9')) {
                            chordsDisplay = circleOfFifthsReverse.map(key => `${key}13(b9)`).join(' â†’ ');
                        }
                    } else {
                        // æ™®é€šæ­Œæ›²ï¼šæ˜¾ç¤ºæ ‡å‡†å’Œå¼¦è¿›è¡Œ
                        chordsDisplay = songData.chords.join(' - ');
                    }

                    // è·å–æ­Œæ›²ä¿¡æ¯ï¼Œæä¾›é»˜è®¤å€¼
                    const info = songData.info || {
                        composer: 'æœªçŸ¥',
                        year: 'æœªçŸ¥',
                        style: 'çˆµå£«æ ‡å‡†æ›²',
                        tempo: 'Medium',
                        description: 'ç»å…¸çˆµå£«æ ‡å‡†æ›²ï¼Œé€‚åˆå’Œå¼¦è¿›è¡Œç»ƒä¹ ã€‚'
                    };
                    
                    content.innerHTML = `
                        <div class="song-info-header">
                            <h2 class="song-info-title">${songName}</h2>
                            <button class="close-btn">Ã—</button>
                        </div>

                        <div class="song-info-section">
                            <h3 class="song-info-subtitle" data-i18n-key="basic_info">åŸºæœ¬ä¿¡æ¯</h3>
                            <div class="song-info-content">
                                <p><strong data-i18n-key="song_composer">ä½œæ›²å®¶:</strong> ${info.composer || 'æœªçŸ¥'}</p>
                                <p><strong data-i18n-key="song_year">å¹´ä»£:</strong> ${info.year || 'æœªçŸ¥'}</p>
                                <p><strong data-i18n-key="song_style">é£æ ¼:</strong> ${info.style || 'çˆµå£«æ ‡å‡†æ›²'}</p>
                                <p><strong data-i18n-key="song_tempo">é€Ÿåº¦:</strong> ${info.tempo || 'Medium'}</p>
                                <p><strong data-i18n-key="song_key">åŸè°ƒ:</strong> ${songData.key}</p>
                            </div>
                        </div>

                        <div class="song-info-section">
                            <h3 class="song-info-subtitle" data-i18n-key="chord_progression">å’Œå¼¦è¿›è¡Œ</h3>
                            <div class="song-info-content song-chord-progression">
                                ${chordsDisplay}
                            </div>
                        </div>
                        
                        ${info.description ? `
                        <div class="song-info-section">
                            <h3 class="song-info-subtitle" data-i18n-key="song_description">æ›²ç›®ä»‹ç»</h3>
                            <div class="song-info-content">
                                ${info.description}
                            </div>
                        </div>
                        ` : ''}

                        ${info.details ? `
                        <div class="song-info-section">
                            <h3 class="song-info-subtitle">ç»ƒä¹ è¯´æ˜</h3>
                            <div class="song-info-content">
                                ${info.details}
                            </div>
                        </div>
                        ` : ''}

                        <div class="song-info-footer">
                            <button class="select-song-btn" data-i18n-key="select_this_song">
                                é€‰æ‹©æ­¤æ›²ç›®
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(content);
                    document.body.appendChild(modal);
                    
                    // å…³é—­æŒ‰é’®äº‹ä»¶
                    content.querySelector('.close-btn').addEventListener('click', function() {
                        document.body.removeChild(modal);
                    });
                    
                    // é€‰æ‹©æ›²ç›®æŒ‰é’®äº‹ä»¶
                    content.querySelector('.select-song-btn').addEventListener('click', function() {
                        // æ›´æ–°ä¸‹æ‹‰æ¡†æ˜¾ç¤º
                        const jazzStandardDropdown = document.getElementById('jazzStandardDropdown');
                        const jazzStandardSelect = document.getElementById('jazzStandard');
                        
                        if (jazzStandardDropdown) {
                            jazzStandardDropdown.querySelector('.dropdown-text').textContent = songName;
                        }
                        
                        if (jazzStandardSelect) {
                            jazzStandardSelect.value = songName;
                            // è§¦å‘changeäº‹ä»¶
                            const changeEvent = new Event('change', { bubbles: true });
                            jazzStandardSelect.dispatchEvent(changeEvent);
                        }
                        
                        // å…³é—­å¼¹çª—
                        document.body.removeChild(modal);
                        
                        // å¦‚æœæ˜¯åœ¨å…¨å±é€‰æ‹©å™¨ä¸­æ‰“å¼€çš„ï¼Œä¹Ÿå…³é—­å…¨å±é€‰æ‹©å™¨
                        const fullscreenSelector = document.getElementById('fullscreenSelector');
                        if (fullscreenSelector && fullscreenSelector.classList.contains('active')) {
                            fullscreenSelector.classList.remove('active');
                        }
                        
                        console.log('ä»ä¿¡æ¯å¼¹çª—é€‰æ‹©äº†ä¹æ›²:', songName);
                    });
                    
                    // ç‚¹å‡»èƒŒæ™¯å…³é—­
                    modal.addEventListener('click', function(e) {
                        if (e.target === modal) {
                            document.body.removeChild(modal);
                        }
                    });
                }
                
                // æµ‹è¯•å‡½æ•° - å¯ä»¥åœ¨æ§åˆ¶å°è°ƒç”¨
                window.testShowSongInfo = function(songName) {
                    console.log('æµ‹è¯•æ˜¾ç¤ºæ­Œæ›²ä¿¡æ¯:', songName || 'All Of Me');
                    if (typeof window.showSongInfo === 'function') {
                        window.showSongInfo(songName || 'All Of Me');
                    }
                };
            };
            
            // è‡ªå®šä¹‰å’Œå¼¦å¼¹çª—ç›¸å…³å˜é‡ - ç§»åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.customChordSequence = [];
            window.currentChordRoot = 'C';
            window.currentChordType = 'major';
            window.currentChordBass = 'root';

            // åˆå§‹åŒ–è‡ªå®šä¹‰å’Œå¼¦å¼¹çª—
            window.initCustomChordsDialog = function() {
                const openBtn = document.getElementById('openCustomChordsDialog');
                const dialog = document.getElementById('customChordsDialog');
                const closeBtn = document.getElementById('closeCustomChordsDialog');
                const addChordBtn = document.getElementById('addCustomChord');
                const clearBtn = document.getElementById('clearCustomChords');
                const saveBtn = document.getElementById('saveCustomChords');
                const loadBtn = document.getElementById('loadLocalChords');
                const loadPracticeBtn = document.getElementById('loadPracticeBtn');

                // æ‰“å¼€å¼¹çª—
                openBtn.addEventListener('click', () => {
                    dialog.classList.add('active');
                    updateChordSequenceDisplay();
                });

                // å…³é—­å¼¹çª—
                closeBtn.addEventListener('click', () => {
                    dialog.classList.remove('active');
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.classList.remove('active');
                    }
                });

                // æ ¹éŸ³é€‰æ‹©
                const rootNoteGrid = document.getElementById('rootNoteGrid');
                rootNoteGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('note-btn')) {
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        rootNoteGrid.querySelectorAll('.note-btn').forEach(btn => btn.classList.remove('active'));
                        // æ·»åŠ activeç±»åˆ°ç‚¹å‡»çš„æŒ‰é’®
                        e.target.classList.add('active');
                        // æ›´æ–°å½“å‰é€‰æ‹©çš„æ ¹éŸ³
                        window.currentChordRoot = e.target.dataset.note;
                    }
                });

                // å’Œå¼¦ç±»å‹é€‰æ‹©
                const chordTypeGrid = document.getElementById('chordTypeGrid');
                chordTypeGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('custom-chord-type-btn')) {
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        chordTypeGrid.querySelectorAll('.custom-chord-type-btn').forEach(btn => btn.classList.remove('active'));
                        // æ·»åŠ activeç±»åˆ°ç‚¹å‡»çš„æŒ‰é’®
                        e.target.classList.add('active');
                        // æ›´æ–°å½“å‰é€‰æ‹©çš„å’Œå¼¦ç±»å‹
                        window.currentChordType = e.target.dataset.type;
                    }
                });

                // è½¬ä½é€‰æ‹©
                const bassGrid = document.getElementById('bassGrid');
                bassGrid.addEventListener('click', (e) => {
                    if (e.target.classList.contains('bass-btn')) {
                        // ç§»é™¤æ‰€æœ‰activeç±»
                        bassGrid.querySelectorAll('.bass-btn').forEach(btn => btn.classList.remove('active'));
                        // æ·»åŠ activeç±»åˆ°ç‚¹å‡»çš„æŒ‰é’®
                        e.target.classList.add('active');
                        // æ›´æ–°å½“å‰é€‰æ‹©çš„è½¬ä½
                        window.currentChordBass = e.target.dataset.bass;
                    }
                });

                // æ·»åŠ å’Œå¼¦
                addChordBtn.addEventListener('click', () => {
                    const chord = {
                        root: window.currentChordRoot,
                        type: window.currentChordType,
                        bass: window.currentChordBass
                    };
                    window.customChordSequence.push(chord);
                    updateChordSequenceDisplay();
                });

                // æ¸…ç©ºåºåˆ—
                clearBtn.addEventListener('click', () => {
                    window.customChordSequence = [];
                    updateChordSequenceDisplay();
                });

                // ä¿å­˜åºåˆ—
                saveBtn.addEventListener('click', () => {
                    const sequenceName = document.getElementById('sequenceName').value || 'æœªå‘½ååºåˆ—';
                    const data = {
                        name: sequenceName,
                        sequence: window.customChordSequence
                    };
                    localStorage.setItem('customChordSequence', JSON.stringify(data));
                    alert('å’Œå¼¦è¿›è¡Œå·²ä¿å­˜åˆ°æœ¬åœ°ï¼');
                });

                // åŠ è½½åºåˆ—
                loadBtn.addEventListener('click', () => {
                    const saved = localStorage.getItem('customChordSequence');
                    if (saved) {
                        try {
                            const data = JSON.parse(saved);
                            window.customChordSequence = data.sequence || [];
                            document.getElementById('sequenceName').value = data.name || '';
                            updateChordSequenceDisplay();
                            alert('å’Œå¼¦è¿›è¡Œå·²åŠ è½½ï¼');
                        } catch (e) {
                            alert('åŠ è½½å¤±è´¥ï¼šæ•°æ®æ ¼å¼é”™è¯¯ï¼');
                        }
                    } else {
                        alert('æ²¡æœ‰æ‰¾åˆ°ä¿å­˜çš„å’Œå¼¦è¿›è¡Œï¼');
                    }
                });

                // åŠ è½½ç»ƒä¹ 
                loadPracticeBtn.addEventListener('click', () => {
                    if (window.customChordSequence && window.customChordSequence.length > 0) {
                        // å…³é—­è‡ªå®šä¹‰å’Œå¼¦å¼¹çª—
                        dialog.style.display = 'none';
                        
                        // æ¸…ç©ºæ­Œæ›²ç›¸å…³çŠ¶æ€ï¼Œç¡®ä¿ä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦
                        const jazzStandardEl = document.getElementById('jazzStandard');
                        if (jazzStandardEl) {
                            jazzStandardEl.value = '';
                        }
                        
                        // åˆ‡æ¢åˆ°å’Œå¼¦è¿›è¡Œç»ƒä¹ é¡µé¢
                        document.querySelector('.nav-item[data-tab="progression"]').click();
                        
                        // ç­‰å¾…é¡µé¢åˆ‡æ¢å®Œæˆåå†è®¾ç½®é€‰é¡¹
                        setTimeout(() => {
                            // è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼å·²é€šè¿‡ state.isCustomChordMode ç®¡ç†
                            
                            // è®¾ç½®è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼çŠ¶æ€
                            state.isCustomChordMode = true;
                            
                            // æ›´æ–°å’Œå¼¦è¿›è¡Œæ˜¾ç¤º
                            updateCustomChordProgressionDisplay();
                            
                            // ç›´æ¥å¼€å§‹ç»ƒä¹ 
                            setTimeout(() => {
                                const startBtn = document.getElementById('startBtn');
                                if (startBtn) {
                                    startBtn.click();
                                }
                            }, 200);
                        }, 100);
                    } else {
                        alert('è¯·å…ˆæ·»åŠ å’Œå¼¦åˆ°åºåˆ—ä¸­ï¼');
                    }
                });
            }

            // æ›´æ–°å’Œå¼¦åºåˆ—æ˜¾ç¤º
            function updateChordSequenceDisplay() {
                const container = document.getElementById('customChordSequence');
                container.innerHTML = '';

                if (window.customChordSequence.length === 0) {
                    container.innerHTML = '<div class="chord-sequence-empty">ç‚¹å‡»"æ·»åŠ å’Œå¼¦"å¼€å§‹åˆ›å»ºå’Œå¼¦è¿›è¡Œ</div>';
                    return;
                }

                window.customChordSequence.forEach((chord, index) => {
                    const chordElement = document.createElement('div');
                    chordElement.className = 'chord-item';
                    chordElement.innerHTML = `
                        <span>${formatChordDisplay(chord)}</span>
                        <button class="remove-chord" onclick="removeChord(${index})">Ã—</button>
                    `;
                    container.appendChild(chordElement);
                });
            }

            // æ›´æ–°è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œæ˜¾ç¤º
            function updateCustomChordProgressionDisplay() {
                const progressionDisplay = document.getElementById('customChordProgression');
                if (progressionDisplay && window.customChordSequence && window.customChordSequence.length > 0) {
                    progressionDisplay.innerHTML = window.customChordSequence.map(chord => formatChordDisplay(chord)).join(' - ');
                }
            }

            // è·å–éŸ³åä»æ ¹éŸ³å’ŒéŸ³çº§
            function getBassNoteName(rootNote, bassType, chordType) {
                const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];

                // æ‰¾åˆ°æ ¹éŸ³åœ¨éŸ³é˜¶ä¸­çš„ç´¢å¼•
                let rootIndex = noteNames.indexOf(rootNote);
                if (rootIndex === -1) {
                    // å¤„ç†é™å·æƒ…å†µ
                    const flatToSharp = {
                        'Dâ™­': 'Câ™¯', 'Eâ™­': 'Dâ™¯', 'Gâ™­': 'Fâ™¯', 'Aâ™­': 'Gâ™¯', 'Bâ™­': 'Aâ™¯'
                    };
                    rootIndex = noteNames.indexOf(flatToSharp[rootNote] || rootNote);
                }

                if (rootIndex === -1) return rootNote; // å¦‚æœæ‰¾ä¸åˆ°ï¼Œè¿”å›åŸæ ¹éŸ³

                // éŸ³çº§é—´éš”æ˜ å°„ï¼ˆåŠéŸ³æ•°ï¼‰
                let semitones = 0;
                switch (bassType) {
                    case 'root':
                        semitones = 0;
                        break;
                    case '3rd':
                        // æ ¹æ®å’Œå¼¦ç±»å‹å†³å®šä¸‰åº¦
                        if (chordType === 'minor' || chordType === 'minor6' || chordType === 'minor7' ||
                            chordType === 'minor9' || chordType === 'minor11' || chordType === 'minor13' ||
                            chordType === 'madd9' || chordType === 'm6add9') {
                            semitones = 3; // å°ä¸‰åº¦
                        } else {
                            semitones = 4; // å¤§ä¸‰åº¦
                        }
                        break;
                    case '5th':
                        // å‡å’Œå¼¦çš„å‡äº”åº¦
                        if (chordType === 'diminished' || chordType === 'diminished7' || chordType === 'minor7b5') {
                            semitones = 6; // å‡äº”åº¦
                        } else {
                            semitones = 7; // çº¯äº”åº¦
                        }
                        break;
                    case '7th':
                        // å„ç§ä¸ƒåº¦
                        if (chordType === 'major7' || chordType === 'major9' || chordType === 'major6' || chordType === '6add9') {
                            semitones = 11; // å¤§ä¸ƒåº¦
                        } else if (chordType === 'dominant7' || chordType === 'dominant9' || chordType === 'dominant11' ||
                                  chordType === 'dominant13' || chordType === 'dominant7sharp9' || chordType === 'dominant7flat9' ||
                                  chordType === 'dominant7sharp11') {
                            semitones = 10; // å°ä¸ƒåº¦
                        } else if (chordType === 'diminished7') {
                            semitones = 9; // å‡ä¸ƒåº¦
                        } else if (chordType === 'minor7' || chordType === 'minor9' || chordType === 'minor11' ||
                                  chordType === 'minor13' || chordType === 'madd9' || chordType === 'm6add9') {
                            semitones = 10; // å°ä¸ƒåº¦
                        } else {
                            semitones = 11; // é»˜è®¤å¤§ä¸ƒåº¦
                        }
                        break;
                }

                const bassIndex = (rootIndex + semitones) % 12;
                return noteNames[bassIndex];
            }

            // æ ¼å¼åŒ–å’Œå¼¦æ˜¾ç¤º
            function formatChordDisplay(chord) {
                const typeMap = {
                    'major': '',
                    'minor': 'm',
                    'diminished': 'dim',
                    'augmented': 'aug',
                    'major6': '6',
                    'minor6': 'm6',
                    'dominant7': '7',
                    'major7': 'maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7â™­5',
                    'diminished7': 'dim7',
                    'dominant9': '9',
                    'major9': 'maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7â™¯9',
                    'dominant7flat9': '7â™­9',
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7â™¯11',
                    'dominant13': '13',
                    'minor13': 'm13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };

                let chordText = chord.root + (typeMap[chord.type] || '');

                if (chord.bass !== 'root') {
                    const bassNoteName = getBassNoteName(chord.root, chord.bass, chord.type);
                    chordText += `/${bassNoteName}`;
                }

                return chordText;
            }

            // ç§»é™¤å’Œå¼¦
            function removeChord(index) {
                window.customChordSequence.splice(index, 1);
                updateChordSequenceDisplay();
            }
            
            // åˆå§‹åŒ–è°ƒæ€§ä¸‹æ‹‰æ¡†åŠŸèƒ½
            window.initProgressionKeyDropdown = function() {
                console.log('åˆå§‹åŒ–è°ƒæ€§ä¸‹æ‹‰åˆ—è¡¨...');
                const dropdown = document.getElementById('progressionKeyDropdown');
                
                if (!dropdown) {
                    console.error('æ‰¾ä¸åˆ°progressionKeyDropdownå…ƒç´ ');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
                if (dropdown.dataset.initialized === 'true') {
                    console.log('è°ƒæ€§ä¸‹æ‹‰åˆ—è¡¨å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡');
                    return;
                }
                
                const trigger = dropdown.querySelector('.dropdown-trigger');
                const menu = dropdown.querySelector('.dropdown-menu');
                const nativeSelect = document.getElementById('progressionKey');
                
                if (!trigger || !menu || !nativeSelect) {
                    console.error('è°ƒæ€§ä¸‹æ‹‰åˆ—è¡¨ç¼ºå°‘å¿…è¦å…ƒç´ ');
                    return;
                }
                
                // ç”Ÿæˆè°ƒæ€§åˆ—è¡¨
                const allKeys = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                menu.innerHTML = '';
                
                console.log('å¼€å§‹ç”Ÿæˆè°ƒæ€§é€‰é¡¹ï¼Œæ€»æ•°:', allKeys.length);
                
                allKeys.forEach(key => {
                    const keyLi = document.createElement('li');
                    keyLi.className = 'dropdown-item';
                    keyLi.setAttribute('data-value', key);
                    
                    const itemText = document.createElement('span');
                    itemText.className = 'item-text';
                    itemText.textContent = key;
                    keyLi.appendChild(itemText);
                    
                    menu.appendChild(keyLi);
                });
                
                // é‡æ–°æŸ¥è¯¢åŠ¨æ€ç”Ÿæˆçš„å…ƒç´ 
                const items = dropdown.querySelectorAll('.dropdown-item');
                console.log('è°ƒæ€§é€‰é¡¹ç”Ÿæˆå®Œæˆï¼Œå®é™…ç”Ÿæˆæ•°é‡:', items.length);
                
                // ç‚¹å‡»è§¦å‘å™¨æ‰“å¼€/å…³é—­ä¸‹æ‹‰èœå•
                trigger.addEventListener('click', function(e) {
                    console.log('è°ƒæ€§ä¸‹æ‹‰æ¡†è§¦å‘å™¨è¢«ç‚¹å‡»');
                    e.stopPropagation();
                    if (menu.classList.contains('show')) {
                        console.log('èœå•å½“å‰æ˜¾ç¤ºï¼Œå‡†å¤‡å…³é—­');
                        closeKeyDropdown();
                    } else {
                        console.log('èœå•å½“å‰éšè—ï¼Œå‡†å¤‡æ‰“å¼€');
                        openKeyDropdown();
                    }
                });
                
                // ç‚¹å‡»é€‰é¡¹
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const value = this.dataset.value;
                        const text = this.querySelector('.item-text').textContent;
                        
                        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                        trigger.querySelector('.dropdown-text').textContent = text;
                        
                        // æ›´æ–°åŸç”Ÿselectçš„å€¼
                        nativeSelect.value = value;
                        
                        // è§¦å‘changeäº‹ä»¶
                        const changeEvent = new Event('change', { bubbles: true });
                        nativeSelect.dispatchEvent(changeEvent);
                        
                        closeKeyDropdown();
                    });
                });
                
                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
                document.addEventListener('click', function(e) {
                    if (!dropdown.contains(e.target)) {
                        closeKeyDropdown();
                    }
                });
                
                function openKeyDropdown() {
                    positionDropdown(menu, trigger);
                    console.log('æ‰“å¼€è°ƒæ€§ä¸‹æ‹‰èœå•');
                    menu.classList.add('show');
                    trigger.classList.add('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = 'â–²';
                    
                    // åŠ¨æ€è®¡ç®—ä½ç½®ï¼Œç¡®ä¿ä¸è¢«é®æŒ¡
                    const rect = trigger.getBoundingClientRect();
                    const menuHeight = menu.offsetHeight || 200;
                    const viewportHeight = window.innerHeight;
                    
                    console.log('è°ƒæ€§ä¸‹æ‹‰èœå•å®šä½ä¿¡æ¯:', {
                        triggerRect: rect,
                        menuHeight: menuHeight,
                        viewportHeight: viewportHeight
                    });
                    
                    // è®¡ç®—å¯ç”¨ç©ºé—´å¹¶é€‰æ‹©æœ€ä½³å±•å¼€æ–¹å‘
                    const spaceBelow = viewportHeight - rect.bottom;
                    const spaceAbove = rect.top;
                    
                    console.log('ç©ºé—´è®¡ç®—:', {
                        spaceBelow: spaceBelow,
                        spaceAbove: spaceAbove,
                        menuHeight: menuHeight,
                        needsUpward: spaceBelow < menuHeight && spaceAbove > spaceBelow
                    });
                    
                    // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸å¤Ÿä¸”ä¸Šæ–¹ç©ºé—´æ›´å¤§ï¼Œå‘ä¸Šå±•å¼€
                    if (spaceBelow < menuHeight && spaceAbove > spaceBelow) {
                        const topPosition = Math.max(10, rect.top - menuHeight);
                        menu.style.top = topPosition + 'px';
                        console.log('å‘ä¸Šå±•å¼€ï¼Œtop:', topPosition);
                    } else {
                        // å‘ä¸‹å±•å¼€ï¼Œä½†ç¡®ä¿ä¸è¶…å‡ºè§†å£
                        const topPosition = Math.min(rect.bottom, viewportHeight - menuHeight - 10);
                        menu.style.top = Math.max(10, topPosition) + 'px';
                        console.log('å‘ä¸‹å±•å¼€ï¼Œtop:', Math.max(10, topPosition));
                    }
                    
                    menu.style.left = rect.left + 'px';
                    menu.style.width = rect.width + 'px';
                    
                    // è®¡ç®—åˆé€‚çš„æœ€å¤§é«˜åº¦ï¼Œç¡®ä¿ä¸è¶…å‡ºè§†å£
                    let maxHeight;
                    if (spaceBelow < menuHeight && spaceAbove > spaceBelow) {
                        // å‘ä¸Šå±•å¼€æ—¶ï¼Œé™åˆ¶é«˜åº¦ä¸ºä¸Šæ–¹å¯ç”¨ç©ºé—´
                        maxHeight = Math.min(300, spaceAbove - 20);
                    } else {
                        // å‘ä¸‹å±•å¼€æ—¶ï¼Œé™åˆ¶é«˜åº¦ä¸ºä¸‹æ–¹å¯ç”¨ç©ºé—´
                        maxHeight = Math.min(300, spaceBelow - 20);
                    }
                    
                    // ç¡®ä¿æœ€å°é«˜åº¦ï¼Œé¿å…è¿‡å°
                    maxHeight = Math.max(100, maxHeight);
                    menu.style.maxHeight = maxHeight + 'px';
                    
                    console.log('é«˜åº¦è®¾ç½®:', {
                        calculatedMaxHeight: maxHeight,
                        spaceBelow: spaceBelow,
                        spaceAbove: spaceAbove,
                        originalMenuHeight: menuHeight
                    });
                    
                    console.log('è°ƒæ€§ä¸‹æ‹‰èœå•æœ€ç»ˆæ ·å¼:', {
                        top: menu.style.top,
                        left: menu.style.left,
                        width: menu.style.width,
                        display: getComputedStyle(menu).display,
                        zIndex: getComputedStyle(menu).zIndex
                    });
                }
                
                function closeKeyDropdown() {
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                    dropdown.querySelector('.dropdown-arrow').textContent = 'â–¼';
                }
                
                // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                dropdown.dataset.initialized = 'true';
                console.log('è°ƒæ€§ä¸‹æ‹‰åˆ—è¡¨åˆå§‹åŒ–å®Œæˆ');
                
                // æµ‹è¯•å‡½æ•° - å¯ä»¥åœ¨æ§åˆ¶å°è°ƒç”¨
                window.testProgressionKeyDropdown = function() {
                    console.log('=== æµ‹è¯•è°ƒæ€§ä¸‹æ‹‰æ¡† ===');
                    console.log('ä¸‹æ‹‰æ¡†å…ƒç´ :', dropdown);
                    console.log('è§¦å‘å™¨å…ƒç´ :', trigger);
                    console.log('èœå•å…ƒç´ :', menu);
                    console.log('èœå•é¡¹æ•°é‡:', items.length);
                    console.log('èœå•å½“å‰æ˜¾ç¤ºçŠ¶æ€:', menu.classList.contains('show'));
                    
                    const computedStyle = getComputedStyle(menu);
                    console.log('èœå•è®¡ç®—æ ·å¼:', {
                        display: computedStyle.display,
                        position: computedStyle.position,
                        zIndex: computedStyle.zIndex,
                        top: computedStyle.top,
                        left: computedStyle.left,
                        maxHeight: computedStyle.maxHeight,
                        overflowY: computedStyle.overflowY,
                        overflowX: computedStyle.overflowX
                    });
                    
                    // å¼ºåˆ¶æ‰“å¼€èœå•è¿›è¡Œæµ‹è¯•
                    menu.classList.add('show');
                    console.log('å¼ºåˆ¶æ·»åŠ showç±»åçš„æ˜¾ç¤ºçŠ¶æ€:', getComputedStyle(menu).display);
                    
                    // æ£€æŸ¥æ»šåŠ¨çŠ¶æ€
                    setTimeout(() => {
                        console.log('æ»šåŠ¨çŠ¶æ€æ£€æŸ¥:', {
                            scrollHeight: menu.scrollHeight,
                            clientHeight: menu.clientHeight,
                            offsetHeight: menu.offsetHeight,
                            needsScroll: menu.scrollHeight > menu.clientHeight
                        });
                    }, 100);
                };
            };

            // è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨åŠŸèƒ½
            window.initCustomDropdown = function() {
                console.log('åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨...');
                const dropdown = document.getElementById('progressionLevelDropdown');
                
                if (!dropdown) {
                    console.error('æ‰¾ä¸åˆ°progressionLevelDropdownå…ƒç´ ');
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡
                if (dropdown.dataset.initialized === 'true') {
                    console.log('è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨å·²ç»åˆå§‹åŒ–è¿‡ï¼Œè·³è¿‡');
                    return;
                }
                
                const trigger = dropdown.querySelector('.dropdown-trigger');
                const menu = dropdown.querySelector('.dropdown-menu');
                const items = dropdown.querySelectorAll('.dropdown-item');
                const infoIcons = dropdown.querySelectorAll('.info-icon');
                const nativeSelect = document.getElementById('progressionLevel');
                
                console.log('æ‰¾åˆ°å…ƒç´ :', {
                    dropdown: !!dropdown,
                    trigger: !!trigger,
                    menu: !!menu,
                    items: items.length,
                    infoIcons: infoIcons.length,
                    nativeSelect: !!nativeSelect
                });
                
                // æ ‡è®°ä¸ºå·²åˆå§‹åŒ–
                dropdown.dataset.initialized = 'true';

                // åˆ‡æ¢ä¸‹æ‹‰èœå•æ˜¾ç¤º/éšè—
                trigger.addEventListener('click', function(e) {
                    console.log('ä¸‹æ‹‰åˆ—è¡¨è§¦å‘å™¨è¢«ç‚¹å‡»');
                    e.stopPropagation();
                    e.preventDefault();
                    const isOpen = menu.classList.contains('show');
                    console.log('å½“å‰çŠ¶æ€:', isOpen ? 'æ‰“å¼€' : 'å…³é—­');
                    
                    if (isOpen) {
                        closeDropdown();
                    } else {
                        openDropdown();
                    }
                });

                // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå• - ä½¿ç”¨å»¶è¿Ÿæ‰§è¡Œé¿å…ç«‹å³å…³é—­
                document.addEventListener('click', function(e) {
                    // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ä¸triggerç‚¹å‡»å†²çª
                    setTimeout(() => {
                        if (!dropdown.contains(e.target) && menu.classList.contains('show')) {
                            closeDropdown();
                        }
                    }, 10);
                });

                // é€‰æ‹©é€‰é¡¹
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const value = this.dataset.value;
                        const text = this.querySelector('.item-text').textContent;
                        
                        // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                        trigger.querySelector('.dropdown-text').textContent = text;
                        
                        // æ›´æ–°æ´»åŠ¨çŠ¶æ€
                        items.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        
                        // åŒæ­¥åŸç”Ÿselect
                        nativeSelect.value = value;
                        
                        // å…³é—­ä¸‹æ‹‰èœå•
                        closeDropdown();
                        
                        // è§¦å‘changeäº‹ä»¶
                        nativeSelect.dispatchEvent(new Event('change'));
                    });
                });

                // ä¿¡æ¯å›¾æ ‡ç‚¹å‡»äº‹ä»¶
                infoIcons.forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const infoKey = this.dataset.info;
                        showInfoModal(infoKey);
                    });
                });

                function openDropdown() {
                    positionDropdown(menu, trigger);
                    console.log('æ‰“å¼€ä¸‹æ‹‰èœå•');
                    menu.classList.add('show');
                    trigger.classList.add('active');
                    
                    // è®¡ç®—ä¸‹æ‹‰èœå•çš„ä½ç½®ï¼ˆå› ä¸ºä½¿ç”¨fixedå®šä½ï¼‰
                    const triggerRect = trigger.getBoundingClientRect();
                    menu.style.top = (triggerRect.bottom + 4) + 'px';
                    menu.style.left = triggerRect.left + 'px';
                    menu.style.width = triggerRect.width + 'px';  // è®¾ç½®å®½åº¦ä¸è§¦å‘å™¨ä¸€è‡´
                }

                function closeDropdown() {
                    console.log('å…³é—­ä¸‹æ‹‰èœå•');
                    menu.classList.remove('show');
                    trigger.classList.remove('active');
                }
            }

            // ä¿¡æ¯æ¨¡æ€æ¡†æ•°æ®
            const infoModalData = {
                // å•å’Œå¼¦éŸ³ç»ƒä¹ 
                'single-root-info': {
                    title: 'å•éŸ³ç»ƒä¹  - æ ¹éŸ³ (1)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>åªç»ƒä¹ å’Œå¼¦çš„æ ¹éŸ³ï¼Œè¿™æ˜¯æœ€åŸºç¡€çš„ç»ƒä¹ æ¨¡å¼ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>åˆå­¦è€…ç†Ÿæ‚‰å’Œå¼¦æ ¹éŸ³</li>
                            <li>å»ºç«‹éŸ³é«˜è®°å¿†</li>
                            <li>åŸºç¡€éŸ³å‡†è®­ç»ƒ</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>å»ºè®®å…ˆæŒæ¡æ ¹éŸ³çš„éŸ³é«˜ï¼Œå†é€æ­¥å­¦ä¹ å…¶ä»–éŸ³ç¨‹ã€‚</p>
                    `
                },
                'single-3-info': {
                    title: 'å•éŸ³ç»ƒä¹  - ä¸‰éŸ³ (3)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>åªç»ƒä¹ å’Œå¼¦çš„ä¸‰éŸ³ï¼ŒåŒºåˆ†å¤§ä¸‰åº¦å’Œå°ä¸‰åº¦ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>å­¦ä¹ å’Œå¼¦è‰²å½©</li>
                            <li>åŒºåˆ†å¤§è°ƒå’Œå°è°ƒ</li>
                            <li>éŸ³ç¨‹è¯†åˆ«è®­ç»ƒ</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>æ³¨æ„å¤§ä¸‰åº¦å’Œå°ä¸‰åº¦çš„éŸ³é«˜å·®å¼‚ï¼Œè¿™æ˜¯å’Œå¼¦æ€§è´¨çš„å…³é”®ã€‚</p>
                    `
                },
                'single-5-info': {
                    title: 'å•éŸ³ç»ƒä¹  - äº”éŸ³ (5)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>åªç»ƒä¹ å’Œå¼¦çš„äº”éŸ³ï¼Œå»ºç«‹çº¯äº”åº¦éŸ³ç¨‹æ¦‚å¿µã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>éŸ³ç¨‹åŸºç¡€è®­ç»ƒ</li>
                            <li>å’Œå£°ç¨³å®šæ€§ç»ƒä¹ </li>
                            <li>éŸ³å‡†ç²¾ç¡®åº¦æå‡</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>äº”éŸ³æ˜¯å’Œå¼¦ä¸­æœ€ç¨³å®šçš„éŸ³ç¨‹ï¼Œé€‚åˆå»ºç«‹éŸ³é«˜åŸºå‡†ã€‚</p>
                    `
                },
                'single-7-info': {
                    title: 'å•éŸ³ç»ƒä¹  - ä¸ƒéŸ³ (7)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>åªç»ƒä¹ å’Œå¼¦çš„ä¸ƒéŸ³ï¼Œå­¦ä¹ ä¸ƒåº¦éŸ³ç¨‹ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦åŸºç¡€è®­ç»ƒ</li>
                            <li>å¤æ‚éŸ³ç¨‹ç»ƒä¹ </li>
                            <li>çˆµå£«å’Œå£°å…¥é—¨</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>ä¸ƒéŸ³æ˜¯ä¸ƒå’Œå¼¦çš„ç‰¹å¾éŸ³ï¼Œéœ€è¦é‡ç‚¹æŒæ¡å…¶éŸ³é«˜ã€‚</p>
                    `
                },
                
                // åŒå’Œå¼¦éŸ³ç»ƒä¹ 
                'double-root-3-info': {
                    title: 'åŒéŸ³ç»ƒä¹  - æ ¹éŸ³+ä¸‰éŸ³ (1,3)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ æ ¹éŸ³å’Œä¸‰éŸ³çš„ç»„åˆï¼Œå»ºç«‹ä¸‰åº¦éŸ³ç¨‹æ¦‚å¿µã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸‰åº¦éŸ³ç¨‹è®­ç»ƒ</li>
                            <li>å’Œå¼¦è‰²å½©è¯†åˆ«</li>
                            <li>å’Œå£°åŸºç¡€å»ºç«‹</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>è¿™æ˜¯å’Œå¼¦çš„æ ¸å¿ƒéŸ³ç¨‹ï¼Œå»ºè®®é‡ç‚¹ç»ƒä¹ ã€‚</p>
                    `
                },
                'double-root-5-info': {
                    title: 'åŒéŸ³ç»ƒä¹  - æ ¹éŸ³+äº”éŸ³ (1,5)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ æ ¹éŸ³å’Œäº”éŸ³çš„ç»„åˆï¼Œå»ºç«‹çº¯äº”åº¦éŸ³ç¨‹æ¦‚å¿µã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>çº¯äº”åº¦éŸ³ç¨‹è®­ç»ƒ</li>
                            <li>å’Œå£°ç¨³å®šæ€§ç»ƒä¹ </li>
                            <li>éŸ³ç¨‹åŸºç¡€å»ºç«‹</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>çº¯äº”åº¦æ˜¯æœ€ç¨³å®šçš„éŸ³ç¨‹ï¼Œé€‚åˆå»ºç«‹å’Œå£°åŸºç¡€ã€‚</p>
                    `
                },
                'double-root-7-info': {
                    title: 'åŒéŸ³ç»ƒä¹  - æ ¹éŸ³+ä¸ƒéŸ³ (1,7)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ æ ¹éŸ³å’Œä¸ƒéŸ³çš„ç»„åˆï¼Œå»ºç«‹ä¸ƒåº¦éŸ³ç¨‹æ¦‚å¿µã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒåº¦éŸ³ç¨‹è®­ç»ƒ</li>
                            <li>ä¸ƒå’Œå¼¦åŸºç¡€ç»ƒä¹ </li>
                            <li>å¤æ‚å’Œå£°å…¥é—¨</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>ä¸ƒåº¦éŸ³ç¨‹æ˜¯ä¸ƒå’Œå¼¦çš„ç‰¹å¾ï¼Œéœ€è¦é‡ç‚¹æŒæ¡ã€‚</p>
                    `
                },
                'double-3-5-info': {
                    title: 'åŒéŸ³ç»ƒä¹  - ä¸‰éŸ³+äº”éŸ³ (3,5)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸‰éŸ³å’Œäº”éŸ³çš„ç»„åˆï¼Œå»ºç«‹å°ä¸‰åº¦éŸ³ç¨‹æ¦‚å¿µã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>å°ä¸‰åº¦éŸ³ç¨‹è®­ç»ƒ</li>
                            <li>å’Œå¼¦å†…éƒ¨éŸ³ç¨‹ç»ƒä¹ </li>
                            <li>å’Œå£°è‰²å½©è¯†åˆ«</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>å°ä¸‰åº¦æ˜¯é‡è¦çš„å’Œå£°éŸ³ç¨‹ï¼Œéœ€è¦ç†Ÿç»ƒæŒæ¡ã€‚</p>
                    `
                },
                'double-3-7-info': {
                    title: 'åŒéŸ³ç»ƒä¹  - ä¸‰éŸ³+ä¸ƒéŸ³ (3,7)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸‰éŸ³å’Œä¸ƒéŸ³çš„ç»„åˆï¼Œå»ºç«‹äº”åº¦éŸ³ç¨‹æ¦‚å¿µã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>äº”åº¦éŸ³ç¨‹è®­ç»ƒ</li>
                            <li>ä¸ƒå’Œå¼¦å†…éƒ¨ç»ƒä¹ </li>
                            <li>å¤æ‚å’Œå£°è®­ç»ƒ</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>äº”åº¦éŸ³ç¨‹åœ¨ä¸ƒå’Œå¼¦ä¸­å¾ˆé‡è¦ï¼Œéœ€è¦é‡ç‚¹ç»ƒä¹ ã€‚</p>
                    `
                },
                
                // ä¸‰å’Œå¼¦éŸ³ç»ƒä¹ 
                'triple-root-3-5-info': {
                    title: 'ä¸‰å’Œå¼¦ç»ƒä¹  - æ ¹éŸ³+ä¸‰éŸ³+äº”éŸ³ (1,3,5)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ å®Œæ•´çš„ä¸‰å’Œå¼¦ï¼ŒåŒ…å«æ ¹éŸ³ã€ä¸‰éŸ³å’Œäº”éŸ³ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>æ ‡å‡†ä¸‰å’Œå¼¦ç»ƒä¹ </li>
                            <li>å’Œå¼¦æŒ‡æ³•è®­ç»ƒ</li>
                            <li>å’Œå£°åŸºç¡€å»ºç«‹</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>è¿™æ˜¯æœ€å¸¸ç”¨çš„å’Œå¼¦ç»ƒä¹ æ¨¡å¼ï¼Œå»ºè®®é‡ç‚¹æŒæ¡ã€‚</p>
                    `
                },
                'triple-3-5-7-info': {
                    title: 'ä¸‰å’Œå¼¦ç»ƒä¹  - ä¸‰éŸ³+äº”éŸ³+ä¸ƒéŸ³ (3,5,7)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸‰éŸ³ã€äº”éŸ³å’Œä¸ƒéŸ³çš„ç»„åˆï¼Œå»ºç«‹ä¸ƒå’Œå¼¦å†…éƒ¨éŸ³ç¨‹ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦å†…éƒ¨ç»ƒä¹ </li>
                            <li>å¤æ‚éŸ³ç¨‹è®­ç»ƒ</li>
                            <li>çˆµå£«å’Œå£°ç»ƒä¹ </li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>è¿™ç§ç»„åˆé€‚åˆé«˜çº§ç»ƒä¹ ï¼Œéœ€è¦æ‰å®çš„åŸºç¡€ã€‚</p>
                    `
                },
                'triple-random-inversion-info': {
                    title: 'ä¸‰å’Œå¼¦ç»ƒä¹  - éšæœºè½¬ä½ (1,3,5éšæœºè½¬ä½)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>éšæœºç»ƒä¹ ä¸‰å’Œå¼¦çš„ä¸åŒè½¬ä½å½¢å¼ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>å’Œå¼¦è½¬ä½è®­ç»ƒ</li>
                            <li>çµæ´»æ€§å’Œå£°ç»ƒä¹ </li>
                            <li>é«˜çº§å’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>è½¬ä½ç»ƒä¹ èƒ½æé«˜å’Œå£°çš„çµæ´»æ€§ï¼Œé€‚åˆè¿›é˜¶å­¦ä¹ ã€‚</p>
                    `
                },
                
                // å››å’Œå¼¦éŸ³ç»ƒä¹ 
                'quad-root-3-5-7-info': {
                    title: 'ä¸ƒå’Œå¼¦ç»ƒä¹  - æ ¹éŸ³+ä¸‰éŸ³+äº”éŸ³+ä¸ƒéŸ³ (1,3,5,7)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ å®Œæ•´çš„ä¸ƒå’Œå¼¦ï¼ŒåŒ…å«æ ¹éŸ³ã€ä¸‰éŸ³ã€äº”éŸ³å’Œä¸ƒéŸ³ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>é«˜çº§å’Œå¼¦ç»ƒä¹ </li>
                            <li>çˆµå£«å’Œå£°è®­ç»ƒ</li>
                            <li>å¤æ‚å’Œå¼¦æŒæ¡</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>ä¸ƒå’Œå¼¦æ¯”ä¸‰å’Œå¼¦æ›´å¤æ‚ï¼Œå»ºè®®å…ˆæŒæ¡ä¸‰å’Œå¼¦å†å­¦ä¹ ã€‚</p>
                    `
                },
                'quad-3-5-7-root-info': {
                    title: 'ä¸ƒå’Œå¼¦ç»ƒä¹  - ä¸‰éŸ³+äº”éŸ³+ä¸ƒéŸ³+æ ¹éŸ³ (3,5,7,1)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸ƒå’Œå¼¦çš„ç¬¬ä¸€è½¬ä½ï¼Œæ ¹éŸ³åœ¨æœ€é«˜éŸ³ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦è½¬ä½ç»ƒä¹ </li>
                            <li>å’Œå£°è¿æ¥è®­ç»ƒ</li>
                            <li>é«˜çº§å’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>è½¬ä½ç»ƒä¹ èƒ½æé«˜å’Œå£°çš„æµç•…æ€§ï¼Œé€‚åˆé«˜çº§ç»ƒä¹ ã€‚</p>
                    `
                },
                'quad-5-7-root-3-info': {
                    title: 'ä¸ƒå’Œå¼¦ç»ƒä¹  - äº”éŸ³+ä¸ƒéŸ³+æ ¹éŸ³+ä¸‰éŸ³ (5,7,1,3)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸ƒå’Œå¼¦çš„ç¬¬äºŒè½¬ä½ï¼Œä¸‰éŸ³åœ¨æœ€é«˜éŸ³ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦ç¬¬äºŒè½¬ä½ç»ƒä¹ </li>
                            <li>å¤æ‚å’Œå£°è¿æ¥</li>
                            <li>é«˜çº§å’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>ç¬¬äºŒè½¬ä½ç»ƒä¹ èƒ½æé«˜å’Œå£°çš„å¤šæ ·æ€§ï¼Œé€‚åˆä¸“ä¸šç»ƒä¹ ã€‚</p>
                    `
                },
                'quad-7-root-3-5-info': {
                    title: 'ä¸ƒå’Œå¼¦ç»ƒä¹  - ä¸ƒéŸ³+æ ¹éŸ³+ä¸‰éŸ³+äº”éŸ³ (7,1,3,5)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸ƒå’Œå¼¦çš„ç¬¬ä¸‰è½¬ä½ï¼Œäº”éŸ³åœ¨æœ€é«˜éŸ³ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦ç¬¬ä¸‰è½¬ä½ç»ƒä¹ </li>
                            <li>ä¸“ä¸šå’Œå£°è®­ç»ƒ</li>
                            <li>å¤æ‚å’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>ç¬¬ä¸‰è½¬ä½æ˜¯æœ€å¤æ‚çš„è½¬ä½ï¼Œéœ€è¦æ‰å®çš„åŸºç¡€ã€‚</p>
                    `
                },
                'quad-random-inversion-info': {
                    title: 'ä¸ƒå’Œå¼¦ç»ƒä¹  - éšæœºè½¬ä½ (1,3,5,7éšæœºè½¬ä½)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>éšæœºç»ƒä¹ ä¸ƒå’Œå¼¦çš„ä¸åŒè½¬ä½å½¢å¼ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦è½¬ä½è®­ç»ƒ</li>
                            <li>çµæ´»æ€§å’Œå£°ç»ƒä¹ </li>
                            <li>ä¸“ä¸šå’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>éšæœºè½¬ä½ç»ƒä¹ èƒ½æé«˜å’Œå£°çš„åº”å˜èƒ½åŠ›ï¼Œé€‚åˆä¸“ä¸šå­¦ä¹ ã€‚</p>
                    `
                },
                'quad-root-3-5-7-root-info': {
                    title: 'ä¸ƒå’Œå¼¦ç»ƒä¹  - æ‰©å±•ç»ƒä¹  (1,3,5,7,1)',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ ä¸ƒå’Œå¼¦çš„æ‰©å±•å½¢å¼ï¼ŒåŒ…å«é‡å¤çš„æ ¹éŸ³ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>ä¸ƒå’Œå¼¦æ‰©å±•ç»ƒä¹ </li>
                            <li>å¤æ‚å’Œå£°è®­ç»ƒ</li>
                            <li>ä¸“ä¸šå’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>æ‰©å±•ç»ƒä¹ èƒ½æé«˜å’Œå£°çš„ä¸°å¯Œæ€§ï¼Œé€‚åˆé«˜çº§ç»ƒä¹ ã€‚</p>
                    `
                },
                
                // å…¨éƒ¨å’Œå¼¦éŸ³ç»ƒä¹ 
                'all-notes-info': {
                    title: 'å…¨éƒ¨å’Œå¼¦éŸ³ç»ƒä¹ ',
                    content: `
                        <h3>ç»ƒä¹ å†…å®¹</h3>
                        <p>ç»ƒä¹ å’Œå¼¦çš„æ‰€æœ‰éŸ³ï¼ŒåŒ…æ‹¬æ ¹éŸ³ã€ä¸‰éŸ³ã€äº”éŸ³ã€ä¸ƒéŸ³ç­‰ã€‚</p>
                        
                        <h3>é€‚ç”¨åœºæ™¯</h3>
                        <ul>
                            <li>å®Œæ•´å’Œå¼¦ç»ƒä¹ </li>
                            <li>ç»¼åˆå’Œå£°è®­ç»ƒ</li>
                            <li>ä¸“ä¸šå’Œå£°æŠ€å·§</li>
                        </ul>
                        
                        <h3>ç»ƒä¹ å»ºè®®</h3>
                        <p>å…¨éƒ¨éŸ³ç»ƒä¹ æ˜¯æœ€å…¨é¢çš„ç»ƒä¹ æ¨¡å¼ï¼Œé€‚åˆé«˜çº§å­¦ä¹ è€…ã€‚</p>
                    `
                }
            };

            // æ˜¾ç¤ºä¿¡æ¯æ¨¡æ€æ¡†
            function showInfoModal(infoKey) {
                const data = infoModalData[infoKey];
                if (!data) return;

                // åˆ›å»ºæ¨¡æ€æ¡†
                const modal = document.createElement('div');
                modal.className = 'info-modal';
                modal.innerHTML = `
                    <div class="info-modal-content">
                        <div class="info-modal-header">
                            <h2 class="info-modal-title">${data.title}</h2>
                            <button class="info-modal-close">&times;</button>
                        </div>
                        <div class="info-modal-body">
                            ${data.content}
                        </div>
                    </div>
                `;

                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(modal);

                // å…³é—­æŒ‰é’®äº‹ä»¶
                const closeBtn = modal.querySelector('.info-modal-close');
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        document.body.removeChild(modal);
                    }
                });

                // ESCé”®å…³é—­
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        document.body.removeChild(modal);
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            }
            
            // å½“å‰è¯­è¨€
            let currentLanguage = 'zh-CN';
            
            // åˆå§‹åŒ–è¯­è¨€è®¾ç½®
            function initLanguage() {
                const savedLanguage = localStorage.getItem('appLanguage');
                if (savedLanguage && (savedLanguage === 'zh-CN' || savedLanguage === 'en')) {
                    currentLanguage = savedLanguage;
                } else {
                    currentLanguage = 'zh-CN';
                    localStorage.setItem('appLanguage', currentLanguage);
                }
            }
            
            // è·å–ç¿»è¯‘æ–‡æœ¬
            function t(key) {
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    return translations[currentLanguage][key];
                }
                return translations['en'][key] || key;
            }
            
            // åˆ‡æ¢è¯­è¨€
            function switchLanguage(lang) {
                if (lang === 'zh-CN' || lang === 'en') {
                    currentLanguage = lang;
                    localStorage.setItem('appLanguage', lang);
                    window.dispatchEvent(new CustomEvent('languageChanged', { detail: lang }));
                    return true;
                }
                return false;
            }
            
            // è·å–å½“å‰è¯­è¨€
            function getCurrentLanguage() {
                return currentLanguage;
            }
            
            // è·å–æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
            function getSupportedLanguages() {
                return [
                    { code: 'zh-CN', name: 'ä¸­æ–‡' },
                    { code: 'en', name: 'English' }
                ];
            }
            
            // åˆå§‹åŒ–
            initLanguage();
            
            // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.t = t;
            window.switchLanguage = switchLanguage;
            window.getCurrentLanguage = getCurrentLanguage;
            window.getSupportedLanguages = getSupportedLanguages;
            
        })();
    </script>
    <style>
        /* ä¿ç•™å°‘é‡ä»…åœ¨æ­¤é¡µé¢éœ€è¦çš„ç‰¹å®šæ ·å¼ */
        /* æƒé™æŒ‡å¯¼æ¨¡æ€æ¡†æ ·å¼ */
        .permission-guidance {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(40, 40, 50, 0.95);
            padding: 20px;
            border-radius: 12px;
            z-index: 2000;
            width: 80%;
            max-width: 400px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
        }

        .permission-guidance h3 {
            margin-bottom: 15px;
            color: #3a9fc4;
        }

        .permission-guidance ol {
            margin-left: 20px;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .permission-guidance button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
        }

        #refresh-page {
            background: #3a9fc4;
        }

        #dismiss-guidance {
            background: #6c757d;
        }









        /* .btn å’Œ .controls æ ·å¼å·²åœ¨ styles/main.css ä¸­å®šä¹‰ */

        @media (min-width: 768px) {
            .chord-type-container {
                grid-template-columns: repeat(6, 1fr);
            }

            .settings-row {
                flex-direction: row;
                align-items: center;
            }

            .settings-label {
                min-width: 100px;
                margin-bottom: 0;
            }
        }

        @media (min-width: 1024px) {
            .chord-type-container {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        @media (min-width: 1440px) {
            .chord-type-container {
                grid-template-columns: repeat(10, 1fr);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 16px;
            }

            h1 {
                font-size: 24px;
            }

            /* .btn å“åº”å¼æ ·å¼å·²åœ¨ styles/main.css ä¸­å®šä¹‰ */

            .settings-section-title {
                font-size: 16px;
            }

            .settings-tab {
                padding: 14px 12px;
                font-size: 14px;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.1s ease;
        }

        #practiceScreen.metronome-active {
            /* èŠ‚æ‹å™¨æ¿€æ´»çŠ¶æ€çš„åŸºç¡€æ ·å¼ */
            transition: background-color 0.1s ease;
        }



        .exercise-container {
            background:rgb(51 65 85 / 74%);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 10px;
            text-align: center;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 600px;
            backdrop-filter: blur(10px);
        }
        
        .song-title-display {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 15px;
            border: 1px solid rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(10px);
            max-width: 600px;
            width: 100%;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.1);
        }
        
        .song-title {
            font-size: 28px;
            font-weight: bold;
            color: #60a5fa;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            margin: 0;
            letter-spacing: 0.5px;
        }

        .scale-info {
            margin-bottom: 24px;
        }

        .target-interval {
            font-size: 36px;
            font-weight: 700;
            color: #38bdf8;
            margin: 12px 0;
            text-shadow: 0 4px 8px rgba(56, 189, 248, 0.3);
            letter-spacing: -0.5px;
        }

        .sequence-display {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 0px;
            margin-top: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .sequence-title {
            font-size: 16px;
            color: #94a3b8;
            margin-bottom: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .sequence-items {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            margin: 15px auto;
            width: 100%;
            max-width: 100%;
        }

        .sequence-item {
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            color: #ff8a00;
            transition: all 0.3s ease;
            padding: 8px 10px;
            border-radius: 6px;
            background: rgba(51, 65, 85, 0.9);
            min-width: 36px;
            max-width: 150px;
            min-height: 36px;
            height: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            flex: 0 0 auto;
            word-wrap: break-word;
            word-break: break-word;
            white-space: normal;
            line-height: 1.2;
        }

        .sequence-item.played {
            color: #64748b !important;
            background: rgba(30, 41, 59, 0.6) !important;
            box-shadow: none !important;
            border-color: rgba(100, 116, 139, 0.3);
            transform: scale(0.95);
        }

        .sequence-item.current {
            color: #38bdf8;
            background: rgba(56, 189, 248, 0.15);
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            border-color: rgba(56, 189, 248, 0.3);
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }

            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(56, 189, 248, 0.4);
            }
        }

        .next-exercise {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            width: 100%;
            max-width: 600px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            padding: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .next-label {
            font-size: 14px;
            color: #94a3b8;
            white-space: nowrap;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .next-content-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .next-content {
            font-size: 16px;
            color: #ff8a00;
            font-weight: 600;
            text-align: center;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-recording {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .status-ready {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.8);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .shortcut-key {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            margin: 0 4px;
            font-weight: 600;
            color: #ff8a00;
        }

        .pitch-display {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 23, 42, 0.8);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            color: #94a3b8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .pitch-display.in-tune {
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
        }

        .pitch-display.out-of-tune {
            border-color: rgba(239, 68, 68, 0.5);
        }

        .confidence-bar {
            margin-top: 8px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: #38bdf8;
            border-radius: 2px;
            transition: width 0.2s ease;
        }



        .device-info {
            font-size: 12px;
            color: #94a3b8;
            margin-top: 4px;
        }

        .gain-control {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }

        .gain-control input {
            flex: 1;
        }

        .gain-value {
            min-width: 40px;
            text-align: right;
        }

        .usb-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #22c55e;
            margin-right: 5px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        #practiceScreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 24px;
            backdrop-filter: blur(10px);
            transition: background-color 0.3s ease;
        }

        #practiceScreen.metronome-flash {
            background: linear-gradient(135deg, #1e3a5f, #2d4a7a);
            transition: background-color 0.1s ease;
        }

        /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜... */

        .metronome-flash {
            animation: metronomeFlash 0.3s ease;
        }
        
        /* æ‰‹æœºæ¨ªå±é€‚é… - è°ƒæ•´sequence-itemå­—ä½“å¤§å° */
        @media (max-height: 480px) and (orientation: landscape) {
            .sequence-item {
                font-size: 25px;
            }
            
            /* è¿›ä¸€æ­¥å‹ç¼©é¡µé¢å…ƒç´ ä¸Šä¸‹çš„margin */
            #practiceScreen {
                padding: 8px;
            }
            
            .exercise-container {
                padding: 16px 12px; /* å¢åŠ ä¸Šä¸‹paddingä½¿å†…å®¹æ›´èˆ’å±• */
                margin-bottom: 8px;
            }
            
            .scale-info {
                margin-bottom: 12px; /* å¢åŠ åº•éƒ¨margin */
            }
            
            .target-interval {
                font-size: 24px;
                margin: 10px 0; /* å¢åŠ ä¸Šä¸‹margin */
            }
            
            .sequence-display {
                padding: 12px 8px; /* å¢åŠ ä¸Šä¸‹padding */
                margin: 12px 0; /* å¢åŠ ä¸Šä¸‹margin */
            }
            
            .sequence-item {
                font-size: 22px;
                /* min-width: 30px; */
                min-height: 34px;
                height: auto;
                padding: 6px;

            }
            
            .next-exercise {
                margin: 12px 0; /* å¢åŠ ä¸Šä¸‹margin */
                padding: 12px 8px; /* å¢åŠ ä¸Šä¸‹padding */
            }
            
            .song-title-display {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .song-title {
                font-size: 22px;
            }
            
            .next-label {
                font-size: 12px;
                margin-bottom: 6px; /* å¢åŠ åº•éƒ¨margin */
            }
            
            .next-content {
                font-size: 14px;
            }
            
            /* æ¨ªå±æ¨¡å¼ä¸‹éšè—header */
            .header {
                display: none;
            }
            
            /* æ‰‹æœºæ¨¡å¼ä¸‹éšè—å¿«æ·é”®æç¤º */
            .shortcut-hint {
                display: none;
            }
        }
        
        /* æ‰‹æœºæ¨¡å¼ä¸‹éšè—å¿«æ·é”®æç¤ºï¼ˆè¦†ç›–æ‰€æœ‰æ‰‹æœºå°ºå¯¸ï¼‰ */
        @media (max-width: 768px) {
            .shortcut-hint {
                display: none !important;
            }
        }
        
        /* æ‰‹æœºæ¨¡å¼ä¸‹éšè—headerï¼ˆè¦†ç›–æ‰€æœ‰æ‰‹æœºå°ºå¯¸ï¼‰
        @media (max-width: 768px) {
            .header {
                display: none !important;
            }
        } */
        
        /* åº•éƒ¨å¯¼èˆªæ æ ·å¼ */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: rgba(40, 40, 50, 0.95);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }
        
        .nav-item {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            color: #aaa;
        }
        
        .nav-item.active {
            color: #3a9fc4;
        }
        
        /* é™ä½è½¬æ¢æŒ‰é’®çš„äº®åº¦ */
        .nav-item[data-tab="progression"] {
            color: #888;
        }
        
        .nav-item[data-tab="progression"].active {
            color: #2a7f94; /* è°ƒä½äº®åº¦çš„é¢œè‰² */
        }
        
        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 12px;
        }
        
        /* è°ƒæ•´ä¸»å®¹å™¨çš„åº•éƒ¨è¾¹è·ï¼Œä¸ºåº•éƒ¨å¯¼èˆªæ ç•™å‡ºç©ºé—´ */
        .container {
            margin-bottom: 60px;
        }

        /* CAGEDæ»‘å—æ ·å¼ */
        .caged-slider-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 12px;
        }

        .caged-slider-input {
            display: none;
        }

        .caged-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 116, 139, 0.5);
        }

        .caged-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #64748b;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .caged-slider-input:checked + .caged-slider {
            background: rgba(58, 159, 196, 0.3);
            border-color: #3a9fc4;
        }

        .caged-slider-input:checked + .caged-slider::before {
            transform: translateX(26px);
            background: #3a9fc4;
            box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
        }

        .caged-slider-text {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
        }

        .caged-slider-container:hover .caged-slider {
            border-color: rgba(58, 159, 196, 0.7);
        }

        .caged-slider-container:hover .caged-slider::before {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* MIDIæ»‘å—æ ·å¼ */
        .midi-slider-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
            gap: 12px;
        }

        .midi-slider-input {
            display: none;
        }

        .midi-slider {
            position: relative;
            width: 50px;
            height: 24px;
            background: rgba(100, 116, 139, 0.3);
            border-radius: 12px;
            transition: all 0.3s ease;
            border: 1px solid rgba(100, 116, 139, 0.5);
        }

        .midi-slider::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: #64748b;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .midi-slider-input:checked + .midi-slider {
            background: rgba(58, 159, 196, 0.3);
            border-color: #3a9fc4;
        }

        .midi-slider-input:checked + .midi-slider::before {
            transform: translateX(26px);
            background: #3a9fc4;
            box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
        }

        .midi-slider-text {
            color: #e2e8f0;
            font-size: 14px;
            font-weight: 500;
        }

        .midi-slider-container:hover .midi-slider {
            border-color: rgba(58, 159, 196, 0.7);
        }

        .midi-slider-container:hover .midi-slider::before {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* MIDIè®¾å¤‡è¿æ¥çŠ¶æ€æ ·å¼ */
        .midi-device-status.connected {
            color: #4ade80;
            font-weight: bold;
        }

        .midi-device-status.disconnected {
            color: #f87171;
        }

        /* å…¨å±é€‰æ‹©å™¨æ ·å¼ */
        .fullscreen-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2a 0%, #2c2c3c 100%);
            z-index: 10000;
            overflow: hidden;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
        }

        .fullscreen-selector.active {
            display: flex;
        }

        .fullscreen-selector-header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .fullscreen-selector-back {
            background: rgba(58, 159, 196, 0.2);
            border: 1px solid rgba(58, 159, 196, 0.4);
            color: #3a9fc4;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .fullscreen-selector-back:hover {
            background: rgba(58, 159, 196, 0.3);
            border-color: #3a9fc4;
            transform: translateX(-2px);
        }

        .fullscreen-selector-back:active {
            transform: translateX(-4px);
        }

        .fullscreen-selector-title {
            margin: 0;
            font-size: 24px;
            color: #3a9fc4;
            font-weight: 600;
        }

        .fullscreen-selector-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* é€‰æ‹©é¡¹ç½‘æ ¼å¸ƒå±€ */
        .selector-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            max-width: 1000px;
            margin: 0 auto;
        }

        /* é€‰æ‹©é¡¹å¡ç‰‡ */
        .selector-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .selector-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(58, 159, 196, 0) 0%, rgba(58, 159, 196, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .selector-item:hover {
            border-color: #3a9fc4;
            background: rgba(58, 159, 196, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(58, 159, 196, 0.2);
        }

        .selector-item:hover::before {
            opacity: 1;
        }

        .selector-item.active {
            background: rgba(58, 159, 196, 0.2);
            border-color: #3a9fc4;
            box-shadow: 0 0 20px rgba(58, 159, 196, 0.4);
        }

        .selector-item-title {
            font-size: 15px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 4px;
        }

        .selector-item-desc {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.3;
        }

        /* åˆ†ç»„æ ‡é¢˜ */
        .selector-group-title {
            grid-column: 1 / -1;
            font-size: 14px;
            color: #3a9fc4;
            font-weight: 600;
            margin: 12px 0 8px 0;
            padding: 8px 12px;
            background: rgba(58, 159, 196, 0.1);
            border-left: 3px solid #3a9fc4;
            border-radius: 6px;
        }

        .selector-group-title:first-child {
            margin-top: 0;
        }
        
        /* åˆ†ç»„å®¹å™¨ */
        .selector-group {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        /* æœç´¢æ¡†æ ·å¼ */
        .selector-search-box {
            position: relative;
            max-width: 600px;
            margin: 0 auto 20px auto;
        }

        .selector-search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            font-size: 16px;
            border: 2px solid rgba(58, 159, 196, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            outline: none;
            transition: all 0.3s ease;
        }

        .selector-search-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .selector-search-input:focus {
            border-color: #3a9fc4;
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 0 15px rgba(58, 159, 196, 0.3);
        }

        .selector-search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 20px;
            pointer-events: none;
            opacity: 0.6;
        }

        /* åˆ—è¡¨å¸ƒå±€ï¼ˆç”¨äºä¹æ›²é€‰æ‹©ï¼‰ */
        .selector-list {
            max-width: 800px;
            margin: 0 auto;
        }

        .selector-list-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .selector-list-item:hover {
            border-color: #3a9fc4;
            background: rgba(58, 159, 196, 0.1);
            transform: translateX(5px);
        }

        .selector-list-item.active {
            background: rgba(58, 159, 196, 0.2);
            border-color: #3a9fc4;
        }

        .selector-list-item-name {
            font-size: 16px;
            color: #fff;
            font-weight: 500;
        }

        .selector-list-item-badge {
            background: rgba(58, 159, 196, 0.3);
            color: #3a9fc4;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .selector-list-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .selector-info-icon {
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            transition: all 0.3s ease;
            opacity: 0.7;
        }

        .selector-info-icon:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .selector-grid {
                grid-template-columns: 1fr;
            }

            .fullscreen-selector-title {
                font-size: 20px;
            }

            .fullscreen-selector-back {
                padding: 6px 12px;
                font-size: 14px;
            }
        }

    /* è‡ªå®šä¹‰å’Œå¼¦å¼¹çª—æ ·å¼ */
    .custom-chord-btn {
        padding: 13px 20px;
        border: 2px solid rgba(58, 159, 196, 0.5);
        border-radius: 12px;
        background: transparent;
        color: #3a9fc4;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        letter-spacing: 0.5px;
        width: auto;
        /* min-width: 200px; */
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .custom-chord-btn:hover {
        background: rgba(58, 159, 196, 0.15);
        border-color: #3a9fc4;
        color: #ffffff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(58, 159, 196, 0.3);
    }

    .custom-chord-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(58, 159, 196, 0.2);
    }

    .custom-chords-dialog {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a2a 0%, #2c2c3c 100%);
        z-index: 10000;
        overflow: hidden;
        display: none; /* é»˜è®¤éšè— */
        flex-direction: column;
    }

    .custom-chords-dialog.active {
        display: flex;
    }

    .custom-chords-dialog-content {
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }

    .custom-chords-dialog-header {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px 20px;
        display: flex;
        align-items: center;
        gap: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .custom-chords-dialog-header h3 {
        margin: 0;
        font-size: 24px;
        color: #3a9fc4;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .close-dialog-btn {
        background: rgba(58, 159, 196, 0.2);
        border: 1px solid rgba(58, 159, 196, 0.4);
        color: #3a9fc4;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .close-dialog-btn:hover {
        background: rgba(58, 159, 196, 0.3);
        border-color: #3a9fc4;
        transform: translateX(-2px);
    }

    .close-dialog-btn:active {
        transform: translateX(-4px);
    }

    .custom-chords-dialog-body {
        flex: 1;
        overflow-y: auto;
        padding: 10px 20px;
        display: flex;
        flex-direction: column;
    }

    .selection-section {
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(30, 41, 59, 0.3);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .selection-section h4 {
        margin: 0 0 15px 0;
        color: #3a9fc4;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .note-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
        gap: 8px;
    }

    .note-btn {
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        color: #e2e8f0;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .note-btn:hover {
        background: rgba(58, 159, 196, 0.2);
        border-color: #3a9fc4;
        color: #3a9fc4;
    }

    .note-btn.active {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c);
        border-color: #3a9fc4;
        color: white;
        box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
    }

    .chord-type-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 8px;
    }

    .custom-chord-type-btn {
        background: rgba(51, 65, 85, 0.95) !important;
        border: 1px solid rgba(255, 255, 255, 0.3) !important;
        border-radius: 6px;
        padding: 8px 12px;
        color: #ffffff !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .custom-chord-type-btn:hover {
        background: rgba(58, 159, 196, 0.3) !important;
        border-color: #3a9fc4 !important;
        color: #ffffff !important;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.7);
    }

    .custom-chord-type-btn.active {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c) !important;
        border-color: #3a9fc4 !important;
        color: #ffffff !important;
        box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
    }

    .bass-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
    }

    .bass-btn {
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 12px 16px;
        color: #e2e8f0;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
    }

    .bass-btn:hover {
        background: rgba(58, 159, 196, 0.2);
        border-color: #3a9fc4;
        color: #3a9fc4;
    }

    .bass-btn.active {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c);
        border-color: #3a9fc4;
        color: white;
        box-shadow: 0 2px 8px rgba(58, 159, 196, 0.3);
    }

    .add-chord-section {
        text-align: center;
        margin: 20px 0;
    }

    .add-chord-btn {
        background: linear-gradient(135deg, #10b981, #059669);
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        color: white;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        height: fit-content;
    }

    .add-chord-btn:hover {
        background: linear-gradient(135deg, #34d399, #10b981);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .chord-sequence-area {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sequence-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 15px;
        flex-wrap: wrap;
    }

    .sequence-name-input {
        flex: 1;
        min-width: 200px;
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 12px 16px;
        color: #e2e8f0;
        font-size: 14px;
    }

    .sequence-name-input::placeholder {
        color: #94a3b8;
    }

    .sequence-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .action-btn {
        background: rgba(51, 65, 85, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        color: #94a3b8;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .action-btn:hover {
        background: rgba(58, 159, 196, 0.2);
        border-color: #3a9fc4;
        color: #3a9fc4;
    }

    .chord-sequence-display {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        min-height: 40px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
        border: 1px dashed rgba(255, 255, 255, 0.1);
    }

    .chord-item {
        background: linear-gradient(135deg, #3a9fc4, #2d7a9c);
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chord-item:hover {
        background: linear-gradient(135deg, #4fc3f7, #3a9fc4);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(58, 159, 196, 0.3);
    }

    .remove-chord {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 16px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .remove-chord:hover {
        background: rgba(255, 255, 255, 0.2);
        color: #ff6b6b;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
        .custom-chords-dialog-header h3 {
            font-size: 20px;
        }
        
        .close-dialog-btn {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .selection-section {
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .note-grid {
            grid-template-columns: repeat(auto-fit, minmax(45px, 1fr));
            gap: 8px;
        }
        
        .note-btn {
            padding: 8px 10px;
            font-size: 13px;
        }
        
        .chord-type-grid {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }
        
        .custom-chord-type-btn {
            padding: 6px 8px;
            font-size: 11px;
            min-height: 32px;
            color: #ffffff !important;
            background: rgba(51, 65, 85, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        .bass-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .bass-btn {
            padding: 12px 16px;
            font-size: 14px;
        }
        
        .sequence-header {
            flex-direction: column;
            align-items: stretch;
        }
        
        .sequence-actions {
            justify-content: center;
            }
        }

        /* CAGEDå½¢çŠ¶æ˜¾ç¤ºåŒºåŸŸ */
        .caged-shape-display {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid var(--border-glass);
            border-radius: var(--radius-medium);
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* CAGEDå½¢çŠ¶æŒ‰é’®å®¹å™¨ */
        .caged-shape-buttons {
            display: flex;
            flex-direction: row;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
        }

      </style>
</head>

<body>
    <!-- å…¨å±å¼¹å‡ºé€‰æ‹©é¡µé¢ -->
    <div class="fullscreen-selector" id="fullscreenSelector">
        <div class="fullscreen-selector-header">
            <button class="fullscreen-selector-back" id="fullscreenSelectorBack">
                <span>â†</span>
                <span data-i18n-key="btn_back">è¿”å›</span>
            </button>
            <h2 class="fullscreen-selector-title" id="fullscreenSelectorTitle">é€‰æ‹©</h2>
        </div>
        <div class="fullscreen-selector-content" id="fullscreenSelectorContent">
            <!-- å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å’Œå¼¦å¼¹çª— -->
    <div id="customChordsDialog" class="custom-chords-dialog">
        <div class="custom-chords-dialog-content">
            <div class="custom-chords-dialog-header">
                <button class="close-dialog-btn" id="closeCustomChordsDialog">
                    <span>â†</span>
                    <span>è¿”å›</span>
                </button>
                <h3><i>ğŸµ</i> <span data-i18n-key="custom_chord_title">è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ</span></h3>
            </div>
            
            <div class="custom-chords-dialog-body">
                <!-- æ ¹éŸ³é€‰æ‹©åŒºåŸŸ -->
                <div class="selection-section">
                    <h4 data-i18n-key="custom_chord_root">æ ¹éŸ³</h4>
                    <div class="note-grid" id="rootNoteGrid">
                        <button class="note-btn active" data-note="C">C</button>
                        <button class="note-btn" data-note="Câ™¯">Câ™¯</button>
                        <button class="note-btn" data-note="Dâ™­">Dâ™­</button>
                        <button class="note-btn" data-note="D">D</button>
                        <button class="note-btn" data-note="Dâ™¯">Dâ™¯</button>
                        <button class="note-btn" data-note="Eâ™­">Eâ™­</button>
                        <button class="note-btn" data-note="E">E</button>
                        <button class="note-btn" data-note="F">F</button>
                        <button class="note-btn" data-note="Fâ™¯">Fâ™¯</button>
                        <button class="note-btn" data-note="Gâ™­">Gâ™­</button>
                        <button class="note-btn" data-note="G">G</button>
                        <button class="note-btn" data-note="Gâ™¯">Gâ™¯</button>
                        <button class="note-btn" data-note="Aâ™­">Aâ™­</button>
                        <button class="note-btn" data-note="A">A</button>
                        <button class="note-btn" data-note="Aâ™¯">Aâ™¯</button>
                        <button class="note-btn" data-note="Bâ™­">Bâ™­</button>
                        <button class="note-btn" data-note="B">B</button>
                    </div>
                </div>

                <!-- å’Œå¼¦ç±»å‹é€‰æ‹©åŒºåŸŸ -->
                <div class="selection-section">
                    <h4 data-i18n-key="custom_chord_type">å’Œå¼¦ç±»å‹</h4>
                    <div class="chord-type-grid" id="chordTypeGrid">
                        <button class="custom-chord-type-btn active" data-type="major">Major</button>
                        <button class="custom-chord-type-btn" data-type="minor">Minor</button>
                        <button class="custom-chord-type-btn" data-type="diminished">Dim</button>
                        <button class="custom-chord-type-btn" data-type="augmented">Aug</button>
                        <button class="custom-chord-type-btn" data-type="major6">6</button>
                        <button class="custom-chord-type-btn" data-type="minor6">m6</button>
                        <button class="custom-chord-type-btn" data-type="dominant7">7</button>
                        <button class="custom-chord-type-btn" data-type="major7">Maj7</button>
                        <button class="custom-chord-type-btn" data-type="minor7">m7</button>
                        <button class="custom-chord-type-btn" data-type="minor7b5">m7â™­5</button>
                        <button class="custom-chord-type-btn" data-type="diminished7">dim7</button>
                        <button class="custom-chord-type-btn" data-type="dominant9">9</button>
                        <button class="custom-chord-type-btn" data-type="major9">Maj9</button>
                        <button class="custom-chord-type-btn" data-type="minor9">m9</button>
                        <button class="custom-chord-type-btn" data-type="dominant7sharp9">7â™¯9</button>
                        <button class="custom-chord-type-btn" data-type="dominant7flat9">7â™­9</button>
                        <button class="custom-chord-type-btn" data-type="dominant11">11</button>
                        <button class="custom-chord-type-btn" data-type="minor11">m11</button>
                        <button class="custom-chord-type-btn" data-type="dominant7sharp11">7â™¯11</button>
                        <button class="custom-chord-type-btn" data-type="dominant13">13</button>
                        <button class="custom-chord-type-btn" data-type="minor13">m13</button>
                        <button class="custom-chord-type-btn" data-type="sus2">sus2</button>
                        <button class="custom-chord-type-btn" data-type="sus4">sus4</button>
                        <button class="custom-chord-type-btn" data-type="add9">add9</button>
                        <button class="custom-chord-type-btn" data-type="madd9">madd9</button>
                        <button class="custom-chord-type-btn" data-type="6add9">6add9</button>
                        <button class="custom-chord-type-btn" data-type="m6add9">m6add9</button>
                    </div>
                </div>

                <!-- è½¬ä½é€‰æ‹©åŒºåŸŸ -->
                <div class="selection-section">
                    <h4 data-i18n-key="custom_chord_inversion">è½¬ä½</h4>
                    <div class="bass-grid" id="bassGrid">
                        <button class="bass-btn active" data-bass="root" data-i18n-key="custom_chord_bass_root">æ ¹éŸ³</button>
                        <button class="bass-btn" data-bass="3rd" data-i18n-key="custom_chord_bass_3rd">ä¸‰éŸ³</button>
                        <button class="bass-btn" data-bass="5th" data-i18n-key="custom_chord_bass_5th">äº”éŸ³</button>
                        <button class="bass-btn" data-bass="7th" data-i18n-key="custom_chord_bass_7th">ä¸ƒéŸ³</button>
                    </div>
                </div>

                <!-- æ·»åŠ å’Œå¼¦æŒ‰é’® -->
                <div class="add-chord-section">
                    <button class="add-chord-btn" id="addCustomChord">
                        <i>â•</i> <span data-i18n-key="custom_chord_add">æ·»åŠ å’Œå¼¦</span>
                    </button>
                </div>
                
                <!-- å’Œå¼¦åºåˆ—æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="chord-sequence-area">
                    <div class="sequence-header">
                        <input type="text" id="sequenceName" placeholder="è¾“å…¥æ­Œæ›²åç§°..." class="sequence-name-input" data-i18n-key="custom_chord_sequence_name" />
                        <div class="sequence-actions">
                            <button class="action-btn" id="clearCustomChords" data-i18n-key="custom_chord_clear">æ¸…ç©º</button>
                            <button class="action-btn" id="saveCustomChords" data-i18n-key="custom_chord_save">ä¿å­˜</button>
                            <button class="action-btn" id="loadLocalChords" data-i18n-key="custom_chord_load">åŠ è½½</button>
                            <button class="action-btn load-practice-btn" id="loadPracticeBtn" data-i18n-key="custom_chord_load_practice">åŠ è½½ç»ƒä¹ </button>
                        </div>
                    </div>
                    
                    <div id="customChordSequence" class="chord-sequence-display"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…¶ä»–HTMLå†…å®¹ä¿æŒä¸å˜... -->
    <div class="status-indicator status-ready" id="statusIndicator" data-i18n-key="status_ready">å‡†å¤‡å°±ç»ª</div>

    <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
    <div class="shortcut-hint" id="shortcutHint">
        <span data-i18n-key="shortcut_hint">æŒ‰ <span class="shortcut-key">ESC</span> è¿”å›ä¸»èœå•</span>
    </div>

    <!-- å®æ—¶éŸ³é«˜æ˜¾ç¤º -->
    <div class="pitch-display hidden" id="pitchDisplay">
        <div><span data-i18n-key="pitch_display">éŸ³é«˜</span>: --</div>
        <div><span data-i18n-key="cents_display">éŸ³åˆ†å·®</span>: 0</div>
        <div class="confidence-bar">
            <div class="confidence-fill confidence-fill-zero"></div>
        </div>
    </div>

    <div class="container" id="mainScreen">
        <div class="header">
            <h1 data-i18n-key="app_title">ğŸ¸ å‰ä»–æŒ‡æ¿è§†è§‰åŒ–ç»ƒä¹ å·¥å…·</h1>

        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <!-- è®¾ç½®å†…å®¹åŒºåŸŸ -->
            <div class="settings-content">

                <!-- CAGEDå’Œå¼¦ç»ƒä¹ è®¾ç½® - ç‹¬ç«‹è®¾ç½®é¢æ¿ -->
                <div class="settings-section caged-chord-settings-section hidden">
                    <div class="settings-section-title">
                        <i>ğŸ¸</i> <span data-i18n-key="caged_chord_practice">CAGEDå’Œå¼¦ç»ƒä¹ </span>
                    </div>

                    <!-- CAGEDå’Œå¼¦ç»ƒä¹ æ¨¡å¼é€‰æ‹© -->
                    <div class="settings-row">
                        <div class="caged-toggle-container">
                            <label class="caged-slider-container">
                                <input type="checkbox" id="cagedChordModeToggle" class="caged-slider-input">
                                <span class="caged-slider"></span>
                                <span class="caged-slider-text" data-i18n-key="caged_chord_practice">CAGEDå’Œå¼¦ç»ƒä¹ </span>
                            </label>
                        </div>
                    </div>

                    <!-- CAGEDå’Œå¼¦è®¾ç½®é€‰é¡¹ -->
                    <div id="cagedChordSettings" class="caged-settings hidden">
                        <!-- CAGEDå½¢çŠ¶é€‰æ‹© -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_shape">CAGEDå½¢çŠ¶</span>
                            </div>
                            <div class="caged-shape-container">
                                <div class="caged-shape-btn order-btn active" data-shape="C" data-i18n-key="caged_c_shape">Cå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="A" data-i18n-key="caged_a_shape">Aå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="G" data-i18n-key="caged_g_shape">Gå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="E" data-i18n-key="caged_e_shape">Eå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="D" data-i18n-key="caged_d_shape">Då½¢çŠ¶</div>
                            </div>
                        </div>

                        <!-- CAGEDå’Œå¼¦ç»ƒä¹ æ¨¡å¼ -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_mode">ç»ƒä¹ æ¨¡å¼</span>
                            </div>
                            <div class="order-btn-container">
                                <div class="order-btn caged-chord-mode-btn active" data-mode="connection" data-i18n-key="caged_shape_connection">å½¢çŠ¶è¿æ¥</div>
                                <div class="order-btn caged-chord-mode-btn" data-mode="random" data-i18n-key="caged_random_shapes">éšæœºå½¢çŠ¶</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- å’Œå¼¦è®¾ç½® -->
                <div class="settings-section chord-settings hidden">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> <span data-i18n-key="settings_chord">å’Œå¼¦è®¾ç½®</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_root_note">æ ¹éŸ³</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNote">
                                <option value="C" >C</option>
                                <option value="Câ™¯" >Câ™¯</option>
                                <option value="Dâ™­" >Dâ™­</option>
                                <option value="D" >D</option>
                                <option value="Dâ™¯" >Dâ™¯</option>
                                <option value="Eâ™­" >Eâ™­</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="Fâ™¯" >Fâ™¯</option>
                                <option value="Gâ™­" >Gâ™­</option>
                                <option value="G" >G</option>
                                <option value="Gâ™¯" >Gâ™¯</option>
                                <option value="Aâ™­" >Aâ™­</option>
                                <option value="A" >A</option>
                                <option value="Aâ™¯" >Aâ™¯</option>
                                <option value="Bâ™­" >Bâ™­</option>
                                <option value="B" >B</option>
                                <option value="random" selected data-i18n-key="random_root" >éšæœºæ ¹éŸ³</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_type">å’Œå¼¦ç±»å‹</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">Dim</div>
                            <div class="chord-type-btn" data-value="augmented">Aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7â™­5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7â™¯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7â™­9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7â™¯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>

                    </div>

                    <!-- ä½éŸ³éŸ³ç¬¦é€‰æ‹© -->
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_bass_note">ä½éŸ³éŸ³ç¬¦</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordBassNote">
                                <option value="root" data-i18n-key="chord_bass_root">æ ¹éŸ³</option>
                                <option value="3rd" data-i18n-key="chord_bass_3rd">ä¸‰éŸ³</option>
                                <option value="5th" data-i18n-key="chord_bass_5th">äº”éŸ³</option>
                                <option value="7th" data-i18n-key="chord_bass_7th">ä¸ƒéŸ³</option>
                                <option value="random" data-i18n-key="chord_bass_random">éšæœº</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_order">é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered" data-i18n-key="order_ascending">ä¸Šè¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="reverse" data-i18n-key="order_descending">ä¸‹è¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="random" data-i18n-key="order_random">éšæœº</div>
                        </div>
                    </div>


                </div>

                <!-- å’Œå¼¦è½¬æ¢è®¾ç½® -->
                <div class="settings-section progression-settings hidden">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> <span data-i18n-key="progression_settings">è½¬æ¢è®¾ç½®</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_level">ç»ƒä¹ ç­‰çº§</span>
                        </div>
                        <!-- éšè—çš„åŸç”Ÿselect -->
                        <select id="progressionLevel" class="hidden">
                            <option value="single-root">1</option>
                            <option value="single-3">3</option>
                            <option value="single-5">5</option>
                            <option value="single-7">7</option>
                            <option value="double-root-3">1,3</option>
                            <option value="double-root-5">1,5</option>
                            <option value="double-root-7">1,7</option>
                            <option value="double-3-5">3,5</option>
                            <option value="double-3-7">3,7</option>
                            <option value="triple-root-3-5" selected>1,3,5</option>
                            <option value="triple-3-5-7">3,5,7</option>
                            <option value="triple-random-inversion">1,3,5éšæœºè½¬ä½</option>
                            <option value="quad-root-3-5-7">1,3,5,7</option>
                            <option value="quad-3-5-7-root">3,5,7,1</option>
                            <option value="quad-5-7-root-3">5,7,1,3</option>
                            <option value="quad-7-root-3-5">7,1,3,5</option>
                            <option value="quad-random-inversion">1,3,5,7éšæœºè½¬ä½</option>
                            <option value="quad-root-3-5-7-root">1,3,5,7,1</option>
                            <option value="all-notes">å…¨éƒ¨</option>
                        </select>

                        <!-- è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨ -->
                        <div class="custom-dropdown" id="progressionLevelDropdown">
                            <div class="dropdown-trigger">
                                <span class="dropdown-text">1,3,5</span>
                                <span class="dropdown-arrow">â–¼</span>
                            </div>
                            <ul class="dropdown-menu">
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_single_notes">å•å’Œå¼¦éŸ³</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="single-root">
                                            <span class="item-text">1</span>
                                            <span class="info-icon" data-info="single-root-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="single-3">
                                            <span class="item-text">3</span>
                                            <span class="info-icon" data-info="single-3-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="single-5">
                                            <span class="item-text">5</span>
                                            <span class="info-icon" data-info="single-5-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="single-7">
                                            <span class="item-text">7</span>
                                            <span class="info-icon" data-info="single-7-info">â„¹ï¸</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_double_notes">åŒå’Œå¼¦éŸ³</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="double-root-3">
                                            <span class="item-text">1,3</span>
                                            <span class="info-icon" data-info="double-root-3-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-root-5">
                                            <span class="item-text">1,5</span>
                                            <span class="info-icon" data-info="double-root-5-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-root-7">
                                            <span class="item-text">1,7</span>
                                            <span class="info-icon" data-info="double-root-7-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-3-5">
                                            <span class="item-text">3,5</span>
                                            <span class="info-icon" data-info="double-3-5-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="double-3-7">
                                            <span class="item-text">3,7</span>
                                            <span class="info-icon" data-info="double-3-7-info">â„¹ï¸</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_triple_notes">ä¸‰å’Œå¼¦éŸ³</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item active" data-value="triple-root-3-5">
                                            <span class="item-text">1,3,5</span>
                                            <span class="info-icon" data-info="triple-root-3-5-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="triple-3-5-7">
                                            <span class="item-text">3,5,7</span>
                                            <span class="info-icon" data-info="triple-3-5-7-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="triple-random-inversion">
                                            <span class="item-text">1,3,5éšæœºè½¬ä½</span>
                                            <span class="info-icon" data-info="triple-random-inversion-info">â„¹ï¸</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_quad_notes">å››å’Œå¼¦éŸ³</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="quad-root-3-5-7">
                                            <span class="item-text">1,3,5,7</span>
                                            <span class="info-icon" data-info="quad-root-3-5-7-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-3-5-7-root">
                                            <span class="item-text">3,5,7,1</span>
                                            <span class="info-icon" data-info="quad-3-5-7-root-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-5-7-root-3">
                                            <span class="item-text">5,7,1,3</span>
                                            <span class="info-icon" data-info="quad-5-7-root-3-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-7-root-3-5">
                                            <span class="item-text">7,1,3,5</span>
                                            <span class="info-icon" data-info="quad-7-root-3-5-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-random-inversion">
                                            <span class="item-text">1,3,5,7éšæœºè½¬ä½</span>
                                            <span class="info-icon" data-info="quad-random-inversion-info">â„¹ï¸</span>
                                        </li>
                                        <li class="dropdown-item" data-value="quad-root-3-5-7-root">
                                            <span class="item-text">1,3,5,7,1</span>
                                            <span class="info-icon" data-info="quad-root-3-5-7-root-info">â„¹ï¸</span>
                                        </li>
                                    </ul>
                                </li>
                                <li class="dropdown-group">
                                    <div class="group-header" data-i18n-key="chord_all_notes">å…¨éƒ¨å’Œå¼¦éŸ³</div>
                                    <ul class="group-items">
                                        <li class="dropdown-item" data-value="all-notes">
                                            <span class="item-text">å…¨éƒ¨</span>
                                            <span class="info-icon" data-info="all-notes-info">â„¹ï¸</span>
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_tunes">ä¹æ›²</span>
                        </div>
                        <div class="select-wrapper">
                            <!-- éšè—çš„åŸç”Ÿselect -->
                            <select id="jazzStandard" class="hidden">
                                
                                <optgroup label="5" >
                                    <option value="500 Miles High" >500 Miles High</option>
                                </optgroup>
                                <optgroup label="A" >
                                    <option value="All The Things You Are" >All The Things You Are</option>
                                    <option value="Autumn Leaves" >Autumn Leaves</option>
                                    <option value="All Of Me"  selected>All Of Me</option>
                                    <option value="A Night In Tunisia" >A Night In Tunisia</option>
                                    <option value="All of You" >All of You</option>
                                    <option value="Alone Together" >Alone Together</option>
                                    <option value="Ambleside" >Ambleside</option>
                                    <option value="Anthropology" >Anthropology</option>
                                    <option value="Ask Me Now" >Ask Me Now</option>
                                </optgroup>
                                <optgroup label="B" >
                                    <option value="Blue Moon" >Blue Moon</option>
                                    <option value="Body And Soul" >Body And Soul</option>
                                    <option value="Bye Bye Blackbird" >Bye Bye Blackbird</option>
                                    <option value="Beautiful Love" >Beautiful Love</option>
                                    <option value="Blue Bossa" >Blue Bossa</option>
                                    <option value="Blue in Green" >Blue in Green</option>
                                    <option value="Blues for Alice" >Blues for Alice</option>
                                </optgroup>
                                <optgroup label="C" >
                                    <option value="Cherokee" >Cherokee</option>
                                    <option value="Come Rain Or Come Shine" >Come Rain Or Come Shine</option>
                                    <option value="Confirmation" >Confirmation</option>
                                    <option value="Coral" >Coral</option>
                                    <option value="Corcovado" >Corcovado</option>
                                    <option value="Countdown" >Countdown</option>
                                </optgroup>
                                <optgroup label="D" >
                                    <option value="Days Of Wine And Roses" >Days Of Wine And Roses</option>
                                    <option value="Donna Lee" >Donna Lee</option>
                                    <option value="Doxy" >Doxy</option>
                                    <option value="Dream A Little Dream" >Dream A Little Dream</option>
                                </optgroup>
                                <optgroup label="F" >
                                    <option value="Fall" >Fall</option>
                                    <option value="Falling Grace" >Falling Grace</option>
                                    <option value="Fly Me To The Moon" >Fly Me To The Moon</option>
                                    <option value="Four" >Four</option>
                                    <option value="Footprints" >Footprints</option>
                                </optgroup>
                                <optgroup label="G" >
                                    <option value="Giant Steps" >Giant Steps</option>
                                    <option value="Georgia On My Mind" >Georgia On My Mind</option>
                                    <option value="Girl From Ipanema" >Girl From Ipanema</option>
                                </optgroup>
                                <optgroup label="H" >
                                    <option value="Have You Met Miss Jones" >Have You Met Miss Jones</option>
                                    <option value="Here's That Rainy Day" >Here's That Rainy Day</option>
                                    <option value="How High The Moon" >How High The Moon</option>
                                </optgroup>
                                <optgroup label="I" >
                                    <option value="I Got Rhythm" >I Got Rhythm</option>
                                    <option value="I Can't Get Started" >I Can't Get Started</option>
                                    <option value="In A Sentimental Mood" >In A Sentimental Mood</option>
                                    <option value="Infant Eyes" >Infant Eyes</option>
                                    <option value="Inner Urge" >Inner Urge</option>
                                </optgroup>
                                <optgroup label="J" >
                                    <option value="Just Friends" >Just Friends</option>
                                    <option value="Joy Spring" >Joy Spring</option>
                                    <option value="Jordu" >Jordu</option>
                                </optgroup>
                                <optgroup label="L" >
                                    <option value="Lady Bird" >Lady Bird</option>
                                    <option value="Love For Sale" >Love For Sale</option>
                                    <option value="Lover Man" >Lover Man</option>
                                </optgroup>
                                <optgroup label="M" >
                                    <option value="Misty" >Misty</option>
                                    <option value="My Funny Valentine" >My Funny Valentine</option>
                                    <option value="Maiden Voyage" >Maiden Voyage</option>
                                </optgroup>
                                <optgroup label="N" >
                                    <option value="Night And Day" >Night And Day</option>
                                    <option value="Nardis" >Nardis</option>
                                    <option value="Night Train" >Night Train</option>
                                </optgroup>
                                <optgroup label="O" >
                                    <option value="Oleo" >Oleo</option>
                                </optgroup>
                                <optgroup label="S" >
                                    <option value="Someday My Prince Will Come" >Someday My Prince Will Come</option>
                                    <option value="Spain" >Spain</option>
                                    <option value="Stella By Starlight" >Stella By Starlight</option>
                                    <option value="Summertime" >Summertime</option>
                                    <option value="Solar" >Solar</option>
                                </optgroup>
                                <optgroup label="T" >
                                    <option value="Take Five" >Take Five</option>
                                    <option value="Take the A-Train" >Take the A-Train</option>
                                    <option value="There Will Never Be Another You" >There Will Never Be Another You</option>
                                    <option value="The Way You Look Tonight" >The Way You Look Tonight</option>
                                    <option value="Time Remembered" >Time Remembered</option>
                                </optgroup>
                                <optgroup label="V" >
                                    <option value="Very Early" >Very Early</option>
                                    <option value="Virgo" >Virgo</option>
                                </optgroup>
                                <optgroup label="ç»ƒä¹ " >
                                    <option value="ç»ƒä¹ 1 - Maj7å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 1 - Maj7å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 2 - Min7å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 2 - Min7å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 3 - Sus4b9å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 3 - Sus4b9å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 4 - Maj7#11å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 4 - Maj7#11å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 5 - 7sus4å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 5 - 7sus4å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 5a - Dom7å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 5a - Dom7å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 6 - Min7b5å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 6 - Min7b5å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 7 - MinMaj7å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 7 - MinMaj7å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 8 - 13sus4b9å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 8 - 13sus4b9å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 9 - Maj7#5å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 9 - Maj7#5å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 10 - 7#11å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 10 - 7#11å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 11 - Min7b5â™®9å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 11 - Min7b5â™®9å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                    <option value="ç»ƒä¹ 12 - 13b9å’Œå¼¦(12ä¸ªè°ƒ)" >ç»ƒä¹ 12 - 13b9å’Œå¼¦(12ä¸ªè°ƒ)</option>
                                </optgroup>
                            </select>
                            
                            <!-- è‡ªå®šä¹‰ä¹æ›²ä¸‹æ‹‰åˆ—è¡¨ - å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                            <div class="custom-dropdown" id="jazzStandardDropdown">
                                <div class="dropdown-trigger">
                                    <span class="dropdown-text">All Of Me</span>
                                    <span class="dropdown-arrow">â–¼</span>
                        </div>
                                <ul class="dropdown-menu">
                                    <!-- æ­Œæ›²åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </ul>
                        </div>
                    </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_key_label">è°ƒ</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="progressionKey" class="hidden">
                                <option value="C" >C</option>
                                <option value="Câ™¯" >Câ™¯</option>
                                <option value="Dâ™­" >Dâ™­</option>
                                <option value="D" >D</option>
                                <option value="Dâ™¯" >Dâ™¯</option>
                                <option value="Eâ™­" >Eâ™­</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="Fâ™¯" >Fâ™¯</option>
                                <option value="Gâ™­" >Gâ™­</option>
                                <option value="G" >G</option>
                                <option value="Gâ™¯" >Gâ™¯</option>
                                <option value="Aâ™­" >Aâ™­</option>
                                <option value="A" >A</option>
                                <option value="Aâ™¯" >Aâ™¯</option>
                                <option value="Bâ™­" >Bâ™­</option>
                                <option value="B" >B</option>
                            </select>
                            
                            <!-- è‡ªå®šä¹‰è°ƒæ€§ä¸‹æ‹‰åˆ—è¡¨ -->
                            <div class="custom-dropdown" id="progressionKeyDropdown">
                                <div class="dropdown-trigger">
                                    <span class="dropdown-text" data-i18n-key="key_c_default">C é»˜è®¤</span>
                                    <span class="dropdown-arrow">â–¼</span>
                        </div>
                                <ul class="dropdown-menu">
                                    <!-- è°ƒæ€§åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_order">é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn progression-order-btn active" data-value="ordered" data-i18n-key="order_ordered">é¡ºåº</div>
                            <div class="order-btn progression-order-btn" data-value="reverse" data-i18n-key="order_reverse">å€’åº</div>
                            <div class="order-btn progression-order-btn" data-value="random" data-i18n-key="order_random">éšæœº</div>
                    </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="progression_repeat">é‡å¤ç»ƒä¹ </span>
                        </div>
                        <label class="midi-slider-container">
                            <input type="checkbox" id="enableRepeat" class="midi-slider-input">
                            <span class="midi-slider"></span>
                        </label>
                    </div>

                    <!-- è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œæ§ä»¶ -->
                    <div class="settings-section-title settings-section-spacing">
                        <i>ğŸµ</i> <span data-i18n-key="custom_chord_progression">è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ</span>
                    </div>
                    
                    
                    <div class="settings-row">

                        <button id="openCustomChordsDialog" class="custom-chord-btn" data-i18n-key="btn_custom_chords">
                            <i>ğŸµ</i> è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ
                        </button>
                    </div>

                </div>

                <!-- æ‰¾éŸ³ç»ƒä¹ è®¾ç½® -->
                <div class="settings-section pitch-finding-settings hidden">
                    <div class="settings-section-title">
                        <i>ğŸ“</i> <span data-i18n-key="settings_pitch_finding">éŸ³ç¨‹ç»ƒä¹ è®¾ç½®</span>
                    </div>

                    <!-- ç»ƒä¹ æ¨¡å¼é€‰æ‹© -->
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="practice_mode">ç»ƒä¹ æ¨¡å¼</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn practice-mode-btn active" data-mode="single" data-i18n-key="single_note_practice">æ‰¾éŸ³ç»ƒä¹ </div>
                            <div class="order-btn practice-mode-btn" data-mode="interval" data-i18n-key="note_interval_practice">éŸ³ç¨‹ç»ƒä¹ </div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_practice_time">ç»ƒä¹ æ—¶é—´</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="pitchFindingTime">
                                <option value="1"  data-i18n-key="pitch_finding_1_minute">1åˆ†é’Ÿ</option>
                                <option value="2"  data-i18n-key="pitch_finding_2_minutes">2åˆ†é’Ÿ</option>
                                <option value="3"  data-i18n-key="pitch_finding_3_minutes">3åˆ†é’Ÿ</option>
                                <option value="5" selected  data-i18n-key="pitch_finding_5_minutes">5åˆ†é’Ÿ</option>
                                <option value="10"  data-i18n-key="pitch_finding_10_minutes">10åˆ†é’Ÿ</option>
                                <option value="15"  data-i18n-key="pitch_finding_15_minutes">15åˆ†é’Ÿ</option>
                                <option value="30"  data-i18n-key="pitch_finding_30_minutes">30åˆ†é’Ÿ</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_show_fretboard">æ˜¾ç¤ºæŒ‡æ¿</span>
                        </div>
                        <div class="settings-control-group">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="showFretboard" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                        </label>
                            <div class="keyboard-hint-inline">
                                <span class="hint-text-inline" data-i18n-key="fretboard_keyboard_hint">
                                    ğŸ’¡ <kbd>â†“</kbd><span data-i18n-key="keyboard_hide">éšè—</span> <kbd>â†‘</kbd><span data-i18n-key="keyboard_show">æ˜¾ç¤º</span> <kbd><span data-i18n-key="keyboard_space">ç©ºæ ¼</span></kbd><span data-i18n-key="keyboard_next">ä¸‹ä¸€ä¸ª</span>
                                </span>
                            </div>
                        </div>
                    </div>


                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_fretboard_range">æŒ‡æ¿é•¿åº¦</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn pitch-finding-range-btn active" data-value="12" data-i18n-key="pitch_finding_12_frets">12å“</div>
                            <div class="order-btn pitch-finding-range-btn" data-value="15" data-i18n-key="pitch_finding_15_frets">15å“</div>
                            <div class="order-btn pitch-finding-range-btn" data-value="18" data-i18n-key="pitch_finding_18_frets">18å“</div>
                            <div class="order-btn pitch-finding-range-btn" data-value="24" data-i18n-key="pitch_finding_24_frets">24å“</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="pitch_finding_next_interval">ä¸‹ä¸€é¢˜é—´éš”</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn pitch-finding-interval-btn" data-value="0" data-i18n-key="pitch_finding_no_auto">ä¸è‡ªåŠ¨</div>
                            <div class="order-btn pitch-finding-interval-btn active" data-value="2" data-i18n-key="pitch_finding_2_seconds">2ç§’</div>
                            <div class="order-btn pitch-finding-interval-btn" data-value="3" data-i18n-key="pitch_finding_3_seconds">3ç§’</div>
                            <div class="order-btn pitch-finding-interval-btn" data-value="5" data-i18n-key="pitch_finding_5_seconds">5ç§’</div>
                        </div>
                    </div>

                    <!-- éŸ³ç¨‹ç»ƒä¹ è®¾ç½® -->
                    <div id="intervalSettings" class="interval-settings hidden">
                        <!-- éŸ³ç¨‹é€‰æ‹© -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="interval_selection">é€‰æ‹©éŸ³ç¨‹</span>
                            </div>
                            <div class="interval-grid">
                                <div class="interval-btn" data-interval="â™­2">â™­2</div>
                                <div class="interval-btn" data-interval="2">2</div>
                                <div class="interval-btn" data-interval="â™¯2">â™¯2</div>
                                <div class="interval-btn" data-interval="â™­3">â™­3</div>
                                <div class="interval-btn" data-interval="3">3</div>
                                <div class="interval-btn" data-interval="4">4</div>
                                <div class="interval-btn" data-interval="â™¯4">â™¯4</div>
                                <div class="interval-btn" data-interval="â™­5">â™­5</div>
                                <div class="interval-btn" data-interval="5">5</div>
                                <div class="interval-btn" data-interval="â™¯5">â™¯5</div>
                                <div class="interval-btn" data-interval="â™­6">â™­6</div>
                                <div class="interval-btn" data-interval="6">6</div>
                                <div class="interval-btn" data-interval="â™¯6">â™¯6</div>
                                <div class="interval-btn" data-interval="â™­7">â™­7</div>
                                <div class="interval-btn" data-interval="7">7</div>
                                <div class="interval-btn" data-interval="â™­â™­7">â™­â™­7</div>
                                <div class="interval-btn" data-interval="â™­9">â™­9</div>
                                <div class="interval-btn" data-interval="9">9</div>
                                <div class="interval-btn" data-interval="â™¯9">â™¯9</div>
                                <div class="interval-btn" data-interval="11">11</div>
                                <div class="interval-btn" data-interval="â™¯11">â™¯11</div>
                                <div class="interval-btn" data-interval="â™­13">â™­13</div>
                                <div class="interval-btn" data-interval="13">13</div>
                            </div>
                        </div>

                        <!-- æ ¹éŸ³è®¾ç½® -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="root_note_setting">è®¾ç½®æ ¹éŸ³</span>
                            </div>
                            <div class="select-wrapper">
                                <select id="rootNoteSelect" class="custom-select">
                                    <option value="random" data-i18n-key="random">éšæœº</option>
                                    <option value="C">C</option>
                                    <option value="Câ™¯">Câ™¯</option>
                                    <option value="Dâ™­">Dâ™­</option>
                                    <option value="D">D</option>
                                    <option value="Dâ™¯">Dâ™¯</option>
                                    <option value="Eâ™­">Eâ™­</option>
                                    <option value="E">E</option>
                                    <option value="F">F</option>
                                    <option value="Fâ™¯">Fâ™¯</option>
                                    <option value="Gâ™­">Gâ™­</option>
                                    <option value="G">G</option>
                                    <option value="Gâ™¯">Gâ™¯</option>
                                    <option value="Aâ™­">Aâ™­</option>
                                    <option value="A">A</option>
                                    <option value="Aâ™¯">Aâ™¯</option>
                                    <option value="Bâ™­">Bâ™­</option>
                                    <option value="B">B</option>
                                </select>
                            </div>
                        </div>

                        <!-- å…ˆæ‰¾æ ¹éŸ³å¼€å…³ -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="find_root_first">å…ˆæ‰¾æ ¹éŸ³</span>
                            </div>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="findRootFirst" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                    </div>

                </div>

                <!-- è®¾ç½® -->
                <div class="settings-section device-settings hidden">
                    <div class="settings-section-title">
                        <i>ğŸ¤</i> <span data-i18n-key="settings_device">éŸ³é¢‘è¾“å…¥è®¾ç½®</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="device_audio_input">éŸ³é¢‘è¾“å…¥è®¾å¤‡</span>
                        </div>

                    </div>
                    <div
                        class="device-settings-flex">
                        <select id="audioInputDevice" class="audio-device-select"></select>
                        <button class="btn" id="refreshDevicesBtn"
                            class="refresh-device-btn" data-i18n-key="btn_refresh">åˆ·æ–°è®¾å¤‡åˆ—è¡¨</button>
                    </div>

                    <div class="device-info" id="deviceInfo" data-i18n-key="hint_select_device">
                        æ£€æµ‹åˆ°è®¾å¤‡åï¼Œè¯·é€‰æ‹©æ‚¨çš„USBéŸ³é¢‘æ¥å£
                    </div>
                    <div class="settings-row settings-row-spacing">
                        <div class="settings-label">
                            <span data-i18n-key="device_gain">è¾“å…¥å¢ç›Š</span>
                        </div>
                        <div class="gain-control">
                            <input type="range" id="inputGain" min="0" max="200" value="100">
                            <span class="gain-value" id="inputGainValue">100%</span>
                        </div>
                    </div>

                    <div class="settings-row settings-row-spacing">
                        <div class="settings-label">
                            <span data-i18n-key="device_sensitivity">éŸ³é«˜æ£€æµ‹æ•æ„Ÿåº¦</span>
                        </div>
                        <div class="settings-flex">
                            <input type="range" id="sensitivity" min="0.1" max="1.0" step="0.1" value="0.5"
                                class="settings-flex-item">
                            <span id="sensitivityValue"
                                class="volume-label">0.5</span>
                        </div>
                    </div>

                    <div class="settings-row settings-row-bottom">
                        <div class="settings-label">
                            <span data-i18n-key="device_confidence">ç½®ä¿¡åº¦é˜ˆå€¼</span>
                        </div>
                        <div class="settings-flex">
                            <input type="range" id="confidenceThreshold" min="0.3" max="0.9" step="0.1" value="0.6"
                                class="settings-flex-item">
                            <span id="confidenceThresholdValue"
                                class="volume-label">0.6</span>
                        </div>
                    </div>

                    <div class="settings-section-title mt-md">
                        <i>âš™ï¸</i> <span data-i18n-key="practice_settings">ç»ƒä¹ è®¾ç½®</span>
                    </div>
                    
                    <!-- å†·å´æ—¶é—´è®¾ç½® -->
                    <div class="metronome-controls">
                        <div class="metronome-left">
                            <span class="switch-label" data-i18n-key="device_cooldown">éº¦å…‹é£å†·å´æ—¶é—´</span>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="enableCooldown" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                        <div class="metronome-right">
                            <span class="time-label" data-i18n-key="time_label">æ—¶é—´:</span>
                            <input type="range" id="cooldownDuration" min="200" max="3000" step="100" value="600"
                                class="time-slider">
                            <span id="cooldownDurationValue"
                                class="time-display">600ms</span>
                        </div>
                    </div>

                    <!-- å›ºå®šå»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜è®¾ç½® -->
                    <div class="metronome-controls">
                        <div class="metronome-left">
                            <span class="switch-label" data-i18n-key="fixed_delay_generation">å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜</span>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="enableFixedDelay" class="midi-slider-input">
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                        <div class="metronome-right">
                            <span class="time-label" data-i18n-key="time_label">æ—¶é—´:</span>
                            <input type="range" id="fixedDelayDuration" min="500" max="2000" step="100" value="800"
                                class="time-slider">
                            <span id="fixedDelayDurationValue"
                                class="time-display">800ms</span>
                        </div>
                    </div>



                    <div class="settings-section-title mt-md">
                        <i>ğŸ¯</i> <span data-i18n-key="metronome_settings">èŠ‚æ‹å™¨è®¾ç½®</span>
                    </div>
                    <div
                        class="metronome-controls">
                        <div class="metronome-left">
                            <span class="switch-label" data-i18n-key="device_metronome">å¯ç”¨èŠ‚æ‹å™¨</span>
                            <label class="midi-slider-container">
                                <input type="checkbox" id="metronomeToggle" class="midi-slider-input">
                                <span class="midi-slider"></span>
                            </label>
                        </div>
                        <div class="metronome-right">
                            <span class="time-label" data-i18n-key="device_tempo">é€Ÿåº¦:</span>
                            <input type="range" id="metronomeTempo" min="20" max="120" step="1" value="40"
                                class="time-slider">
                            <span id="metronomeTempoValue"
                                class="min-w-sm text-right text-sm">40</span>
                        </div>
                    </div>
                    
                    <!-- èŠ‚æ‹å™¨é€‰é¡¹ -->
                    <div class="flex-container flex-gap-md mb-sm ml-md">
                        <div class="flex-container flex-gap-sm flex-align-center">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="metronomeFlashToggle" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                            <span class="switch-label" data-i18n-key="background_flash">èƒŒæ™¯é—ªå…‰</span>
                        </div>
                        <div class="flex-container flex-gap-sm flex-align-center">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="metronomeSoundToggle" class="midi-slider-input" checked>
                                <span class="midi-slider"></span>
                            </label>
                            <span class="switch-label" data-i18n-key="sound_metronome">å£°éŸ³èŠ‚æ‹</span>
                        </div>
                    </div>

                    <!-- MIDIè®¾å¤‡æ”¯æŒ -->
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="midi_support">MIDIè®¾å¤‡æ”¯æŒ</span>
                        </div>
                        <div class="midi-toggle-container">
                            <label class="midi-slider-container">
                                <input type="checkbox" id="midiToggle" class="midi-slider-input">
                                <span class="midi-slider"></span>
                                <span class="midi-slider-text" data-i18n-key="midi_enable">MIDIè®¾å¤‡</span>
                            </label>
                        </div>
                    </div>

                    <!-- MIDIè®¾å¤‡ä¿¡æ¯ -->
                    <div id="midiDeviceInfo" class="midi-device-info hidden">
                        <div class="midi-device-status">
                            <span id="midiDeviceStatus">æœªæ£€æµ‹åˆ°MIDIè®¾å¤‡</span>
                        </div>
                        <div class="midi-device-list" id="midiDeviceList">
                            <!-- MIDIè®¾å¤‡åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                    
                    <!-- è¯­è¨€è®¾ç½® -->
                    <div class="settings-section-title mt-md">
                        <i>ğŸŒ</i> <span data-i18n-key="general_language">è¯­è¨€è®¾ç½®</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="interface_language">è¯­è¨€ / Language</span>
                        </div>
                        <div class="flex-container flex-gap-lg flex-1">
                            <button id="langZhBtn" class="btn btn-lang">ä¸­æ–‡</button>
                            <button id="langEnBtn" class="btn btn-lang">English</button>
                        </div>
                    </div>

                    <!-- ä¸»é¢˜è®¾ç½® -->
                    <div class="settings-section-title mt-md">
                        <i>ğŸ¨</i> <span data-i18n-key="general_theme">ä¸»é¢˜è®¾ç½®</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="general_theme_hint">é€‰æ‹©ç•Œé¢ä¸»é¢˜</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn theme-btn active" data-theme="dark" data-i18n-key="theme_dark">æ·±è‰²ä¸»é¢˜</div>
                            <div class="order-btn theme-btn" data-theme="light" data-i18n-key="theme_light">æµ…è‰²ä¸»é¢˜</div>
                            <div class="order-btn theme-btn" data-theme="auto" data-i18n-key="theme_auto">è·Ÿéšç³»ç»Ÿ</div>
                        </div>
                    </div>
                    
                    <!-- å’Œå¼¦åæ˜¾ç¤ºè®¾ç½® -->
                    <div class="settings-section-title mt-md">
                        <i>ğŸµ</i> <span data-i18n-key="chord_name_display">å’Œå¼¦åæ˜¾ç¤º</span>
                    </div>
                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_name_display_hint">é€‰æ‹©å’Œå¼¦åç§°çš„æ˜¾ç¤ºæ–¹å¼</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-name-display-btn active" data-value="english" data-i18n-key="chord_name_english">è‹±æ–‡å</div>
                            <div class="order-btn chord-name-display-btn" data-value="symbols" data-i18n-key="chord_name_symbols">ç¬¦å·å</div>
                        </div>
                    </div>
                    
                    <!-- è®¾ç½®ç®¡ç† -->
                    <div class="settings-section-title mt-md">
                        <i>ğŸ˜</i> <span data-i18n-key="settings_management">è®¾ç½®ç®¡ç†</span>
                    </div>
                    <div class="flex-container flex-gap-lg mt-sm">
                        <button id="resetSettingsBtn" class="btn-danger">
                            <span data-i18n-key="btn_reset">é‡ç½®æ‰€æœ‰è®¾ç½®</span>
                        </button>
                    </div>
                    <div class="text-xs text-secondary mt-sm text-center">
                        <span data-i18n-key="reset_settings_hint">ç‚¹å‡»é‡ç½®æŒ‰é’®å°†æ¢å¤æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼</span>
                    </div>
                </div>

                <!-- CAGEDç»ƒä¹ è®¾ç½® - ç‹¬ç«‹è®¾ç½®é¢æ¿ -->
                <div class="settings-section caged-settings-section hidden">
                    <div class="settings-section-title">
                        <i>ğŸ¸</i> <span data-i18n-key="caged_practice">CAGEDç»ƒä¹ </span>
                    </div>

                    <!-- CAGEDç»ƒä¹ æ¨¡å¼é€‰æ‹© -->
                    <div class="settings-row">

                        <div class="caged-toggle-container">
                            <label class="caged-slider-container">
                                <input type="checkbox" id="cagedModeToggle" class="caged-slider-input">
                                <span class="caged-slider"></span>
                                <span class="caged-slider-text" data-i18n-key="caged_practice_mode">CAGEDç»ƒä¹ æ¨¡å¼</span>
                            </label>
                        </div>
                    </div>

                    <!-- CAGEDè®¾ç½®é€‰é¡¹ -->
                    <div id="cagedSettings" class="caged-settings hidden">

                        <!-- CAGEDå½¢çŠ¶é€‰æ‹© -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_shape">CAGEDå½¢çŠ¶</span>
                            </div>
                            <div class="caged-shape-container">
                                <div class="caged-shape-btn order-btn active" data-shape="C" data-i18n-key="caged_c_shape">Cå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="A" data-i18n-key="caged_a_shape">Aå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="G" data-i18n-key="caged_g_shape">Gå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="E" data-i18n-key="caged_e_shape">Eå½¢çŠ¶</div>
                                <div class="caged-shape-btn order-btn active" data-shape="D" data-i18n-key="caged_d_shape">Då½¢çŠ¶</div>
                            </div>
                        </div>

                        <!-- CAGEDç»ƒä¹ æ¨¡å¼ -->
                        <div class="settings-row">
                            <div class="settings-label">
                                <span data-i18n-key="caged_mode">ç»ƒä¹ æ¨¡å¼</span>
                            </div>
                            <div class="order-btn-container">
                                <div class="order-btn caged-mode-btn active" data-mode="connection" data-i18n-key="caged_shape_connection">å½¢çŠ¶è¿æ¥</div>
                                <div class="order-btn caged-mode-btn" data-mode="random" data-i18n-key="caged_random_shapes">éšæœºå½¢çŠ¶</div>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- éŸ³é˜¶è®¾ç½® - åªåœ¨éŸ³é˜¶ç»ƒä¹ æ ‡ç­¾é¡µæ˜¾ç¤º -->
                <div class="settings-section scale-settings hidden">
                    <div class="settings-section-title">
                        <i>ğŸµ</i> <span data-i18n-key="settings_scale">éŸ³é˜¶ç»ƒä¹ é€‰é¡¹</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_root_note">è°ƒ</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="rootNote">
                                <option value="C" >C</option>
                                <option value="Câ™¯" >Câ™¯</option>
                                <option value="Dâ™­" >Dâ™­</option>
                                <option value="D" >D</option>
                                <option value="Dâ™¯" >Dâ™¯</option>
                                <option value="Eâ™­" >Eâ™­</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="Fâ™¯" >Fâ™¯</option>
                                <option value="Gâ™­" >Gâ™­</option>
                                <option value="G" >G</option>
                                <option value="Gâ™¯" >Gâ™¯</option>
                                <option value="Aâ™­" >Aâ™­</option>
                                <option value="A" >A</option>
                                <option value="Aâ™¯" >Aâ™¯</option>
                                <option value="Bâ™­" >Bâ™­</option>
                                <option value="B" >B</option>
                                <option value="random" selected data-i18n-key="random" >éšæœº</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_type">è°ƒå¼</span>
                        </div>
                        <div class="multiselect-dropdown">
                            <div class="dropdown-trigger" id="scaleTypeDropdown">
                                <div class="dropdown-display">
                                    <span class="selected-text">é€‰æ‹©è°ƒå¼...</span>
                                    <span class="dropdown-arrow">â–¼</span>
                                </div>
                            </div>
                            <div class="dropdown-content" id="scaleTypeDropdownContent">
                                <div class="dropdown-controls">
                                    <button type="button" class="dropdown-btn" id="selectAllScales">å…¨é€‰</button>
                                    <button type="button" class="dropdown-btn" id="deselectAllScales">å…¨ä¸é€‰</button>
                                    <button type="button" class="dropdown-btn" id="randomSelectScales">éšæœºé€‰æ‹©</button>
                                </div>

                                <div class="dropdown-groups">
                                    <!-- åŸºæœ¬è°ƒå¼ -->
                                    <div class="dropdown-group">
                                        <div class="group-header">åŸºæœ¬è°ƒå¼</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="major">
                                            <span class="option-text">
                                                <span class="scale-name">Major - 1 2 3 4 5 6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="minor">
                                            <span class="option-text">
                                                <span class="scale-name">Minor - 1 2 â™­3 4 5 â™­6 â™­7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- æ•™ä¼šè°ƒå¼ -->
                                    <div class="dropdown-group">
                                        <div class="group-header">æ•™ä¼šè°ƒå¼</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="ionian">
                                            <span class="option-text">
                                                <span class="scale-name">Ionian - 1 2 3 4 5 6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="dorian">
                                            <span class="option-text">
                                                <span class="scale-name">Dorian - 1 2 â™­3 4 5 6 â™­7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="phrygian">
                                            <span class="option-text">
                                                <span class="scale-name">Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="lydian">
                                            <span class="option-text">
                                                <span class="scale-name">Lydian - 1 2 3 â™¯4 5 6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="mixolydian">
                                            <span class="option-text">
                                                <span class="scale-name">Mixolydian - 1 2 3 4 5 6 â™­7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="aeolian">
                                            <span class="option-text">
                                                <span class="scale-name">Aeolian - 1 2 â™­3 4 5 â™­6 â™­7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="locrian">
                                            <span class="option-text">
                                                <span class="scale-name">Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- å°è°ƒç³»åˆ— -->
                                    <div class="dropdown-group">
                                        <div class="group-header">å°è°ƒç³»åˆ—</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="harmonicMinor">
                                            <span class="option-text">
                                                <span class="scale-name">Harmonic Minor - 1 2 â™­3 4 5 â™­6 7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="melodicMinor">
                                            <span class="option-text">
                                                <span class="scale-name">Melodic Minor - 1 2 â™­3 4 5 6 7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- äº”å£°éŸ³é˜¶ -->
                                    <div class="dropdown-group">
                                        <div class="group-header">äº”å£°éŸ³é˜¶</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="majorPentatonic">
                                            <span class="option-text">
                                                <span class="scale-name">Major Pentatonic - 1 2 3 5 6</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="minorPentatonic">
                                            <span class="option-text">
                                                <span class="scale-name">Minor Pentatonic - 1 â™­3 4 5 â™­7</span>
                                            </span>
                                        </label>
                                    </div>

                                    <!-- å…¶ä»–éŸ³é˜¶ -->
                                    <div class="dropdown-group">
                                        <div class="group-header">å…¶ä»–éŸ³é˜¶</div>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="blues">
                                            <span class="option-text">
                                                <span class="scale-name">Blues - 1 â™­3 4 â™¯4 5 â™­7</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="wholeTone">
                                            <span class="option-text">
                                                <span class="scale-name">Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6</span>
                                            </span>
                                        </label>
                                        <label class="dropdown-option">
                                            <input type="checkbox" value="diminished">
                                            <span class="option-text">
                                                <span class="scale-name">Diminished - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- éšè—çš„selectå…ƒç´ ç”¨äºå…¼å®¹ç°æœ‰ä»£ç  -->
                        <select id="scaleType" class="hidden-select">
                            <option value="major" selected>Major</option>
                        </select>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_direction">æ–¹å‘</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-order-btn active" data-value="ordered" data-i18n-key="order_ascending">ä¸Šè¡Œ</div>
                            <div class="order-btn scale-order-btn" data-value="reverse" data-i18n-key="order_descending">ä¸‹è¡Œ</div>
                            <div class="order-btn scale-order-btn" data-value="random" data-i18n-key="order_random">éšæœº</div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="scale_practice_sequence">ç»ƒä¹ åºåˆ—</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn scale-arpeggio-btn active" data-value="1to1">1â†’1</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="3to3" id="arpeggio-3-btn">3â†’3</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="5to5" id="arpeggio-5-btn">5â†’5</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="7to7" id="arpeggio-7-btn">7â†’7</div>
                            <div class="order-btn scale-arpeggio-btn" data-value="random-arpeggio" data-i18n-key="scale_random">éšæœº</div>
                        </div>
                    </div>

                    <script>
                    // ç›´æ¥åœ¨é¡µé¢ä¸­å®šä¹‰scaleTypeså¯¹è±¡ï¼Œé¿å…æ¨¡å—å¯¼å…¥é—®é¢˜
                    window.scaleTypes = {
                        // å¤§è°ƒç³»åˆ—
                        'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'minor': { name: 'Minor', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                        
                        // æ•™ä¼šè°ƒå¼ (Church Modes)
                        'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                        'dorian': { name: 'Dorian - 1 2 â™­3 4 5 6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', '6', 'â™­7'] },
                        'phrygian': { name: 'Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                        'lydian': { name: 'Lydian - 1 2 3 â™¯4 5 6 7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', '7'] },
                        'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 â™­7', intervals: ['1', '2', '3', '4', '5', '6', 'â™­7'] },
                        'aeolian': { name: 'Aeolian - 1 2 â™­3 4 5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                        'locrian': { name: 'Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                        
                        // å’Œå£°å°è°ƒç³»åˆ—
                        'harmonicMinor': { name: 'Harmonic Minor - 1 2 â™­3 4 5 â™­6 7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', '7'] },
                        'dorianSharp2': { name: 'Dorian â™¯2 - 1 â™¯2 3 4 5 6 â™­7', intervals: ['1', 'â™¯2', '3', '4', '5', '6', 'â™­7'] },
                        'phrygianMajor': { name: 'Phrygian Major - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                        'lydianSharp2': { name: 'Lydian â™¯2 - 1 â™¯2 3 â™¯4 5 6 7', intervals: ['1', 'â™¯2', '3', 'â™¯4', '5', '6', '7'] },
                        'mixolydianFlat6': { name: 'Mixolydian â™­6 - 1 2 3 4 5 â™­6 â™­7', intervals: ['1', '2', '3', '4', '5', 'â™­6', 'â™­7'] },
                        'lydianFlat2': { name: 'Lydian â™­2 - 1 â™­2 3 â™¯4 5 6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', '5', '6', '7'] },
                        'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 â™­2 â™­3 â™­4 â™­5 â™­6 6', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', '6'] },

                        // æ—‹å¾‹å°è°ƒç³»åˆ—
                        'melodicMinor': { name: 'Melodic Minor - 1 2 â™­3 4 5 6 7', intervals: ['1', '2', 'â™­3', '4', '5', '6', '7'] },
                        'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 â™­7 â™­6 5 4 â™­3 2 1', intervals: ['1', 'â™­7', 'â™­6', '5', '4', 'â™­3', '2', '1'] },
                        'dorianFlat2': { name: 'Dorian â™­2 - 1 â™­2 â™­3 4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', '6', 'â™­7'] },
                        'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 â™¯4 â™¯5 6 7', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', '6', '7'] },
                        'lydianFlat7': { name: 'Lydian â™­7 - 1 2 3 â™¯4 5 6 â™­7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', 'â™­7'] },
                        'aeolianFlat5': { name: 'Aeolian â™­5 - 1 2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                        'superLocrian': { name: 'Super Locrian - 1 â™­2 â™­3 â™­4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', 'â™­7'] },
                        
                        // äº”å£°éŸ³é˜¶ç³»åˆ—
                        'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                        'minorPentatonic': { name: 'Minor Pentatonic - 1 â™­3 4 5 â™­7', intervals: ['1', 'â™­3', '4', '5', 'â™­7'] },
                        'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 â™­3 5 6', intervals: ['1', '2', 'â™­3', '5', '6'] },
                        'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                        'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 â™­7', intervals: ['1', '2', '3', '5', 'â™­7'] },
                        
                        // å¸ƒé²æ–¯éŸ³é˜¶ç³»åˆ—
                        'blues': { name: 'Blues - 1 â™­3 4 â™¯4 5 â™­7', intervals: ['1', 'â™­3', '4', 'â™¯4', '5', 'â™­7'] },
                        'majorBlues': { name: 'Major Blues - 1 2 â™­3 3 5 6', intervals: ['1', '2', 'â™­3', '3', '5', '6'] },
                        
                        // å…¶ä»–å¸¸è§éŸ³é˜¶
                        'wholeTone': { name: 'Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', 'â™¯6'] },
                        'diminished': { name: 'Diminished (Half-Whole) - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '3', 'â™¯4', '5', '6', 'â™­7'] },
                        'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 â™­3 â™¯4 â™¯5 6 7', intervals: ['1', '2', 'â™­3', 'â™¯4', 'â™¯5', '6', '7'] },
                        
                        // å¼‚å›½é£æ ¼éŸ³é˜¶
                        'arabic': { name: 'Arabic - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                        'gypsy': { name: 'Gypsy - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                        'japanese': { name: 'Japanese - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                        'egyptian': { name: 'Egyptian - 1 2 4 5 â™­7', intervals: ['1', '2', '4', '5', 'â™­7'] },
                        'hungarian': { name: 'Hungarian - 1 â™¯2 3 â™¯4 5 â™­6 7', intervals: ['1', 'â™¯2', '3', 'â™¯4', '5', 'â™­6', '7'] },
                        'persian': { name: 'Persian - 1 â™­2 3 4 â™­5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', 'â™­5', 'â™­6', '7'] },
                        'byzantine': { name: 'Byzantine - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                        'enigmatic': { name: 'Enigmatic - 1 â™­2 3 â™¯4 â™¯5 â™¯6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', 'â™¯5', 'â™¯6', '7'] },
                        'neapolitan': { name: 'Neapolitan - 1 â™­2 â™­3 4 5 â™­6 7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', '7'] },
                        'spanish': { name: 'Spanish - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] }

                    };

                    // æ ‡å‡†ä¸‹æ‹‰é€‰æ‹©å™¨äº‹ä»¶å¤„ç†
                    function updateArpeggioButtons() {
                        const scaleType = document.getElementById('scaleType').value;

                        // è·å–éŸ³é˜¶ç±»å‹å¯¹åº”çš„éŸ³ç¨‹æ•°ç»„
                        let intervals = [];
                        if (window.scaleTypes && window.scaleTypes[scaleType] && window.scaleTypes[scaleType].intervals) {
                            intervals = window.scaleTypes[scaleType].intervals;
                        } else {
                            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°scaleTypeså¯¹è±¡æˆ–å¯¹åº”çš„éŸ³é˜¶ï¼Œä½¿ç”¨é»˜è®¤çš„å¤§è°ƒéŸ³é˜¶
                            intervals = ['1', '2', '3', '4', '5', '6', '7'];
                        }

                        // è·å–3éŸ³ã€5éŸ³ã€7éŸ³çš„éŸ³ç¨‹ï¼ˆä¼˜å…ˆæŸ¥æ‰¾å®é™…å­˜åœ¨çš„å˜éŸ³è®°å·ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰åˆ™æŸ¥æ‰¾æœ€è¿‘çš„éŸ³ç¨‹ï¼‰
                        const thirdInterval = findNearestIntervalInScale(intervals, '3');
                        const fifthInterval = findNearestIntervalInScale(intervals, '5');
                        const seventhInterval = findNearestIntervalInScale(intervals, '7');

                        // æ›´æ–°é¢„å®šä¹‰æŒ‰é’®æ–‡æœ¬å’Œç¡®ä¿æŒ‰é’®å¯ç‚¹å‡»
                        const arpeggio3Btn = document.getElementById('arpeggio-3-btn');
                        const arpeggio5Btn = document.getElementById('arpeggio-5-btn');
                        const arpeggio7Btn = document.getElementById('arpeggio-7-btn');
                        const randomArpeggioBtn = document.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');

                        if (arpeggio3Btn) {
                            arpeggio3Btn.textContent = `${thirdInterval}â†’${thirdInterval}`;
                            arpeggio3Btn.setAttribute('data-value', `${thirdInterval}to${thirdInterval}`);
                            arpeggio3Btn.style.pointerEvents = 'auto';
                            arpeggio3Btn.style.opacity = '1';
                        }

                        if (arpeggio5Btn) {
                            arpeggio5Btn.textContent = `${fifthInterval}â†’${fifthInterval}`;
                            arpeggio5Btn.setAttribute('data-value', `${fifthInterval}to${fifthInterval}`);
                            arpeggio5Btn.style.pointerEvents = 'auto';
                            arpeggio5Btn.style.opacity = '1';
                        }

                        if (arpeggio7Btn) {
                            arpeggio7Btn.textContent = `${seventhInterval}â†’${seventhInterval}`;
                            arpeggio7Btn.setAttribute('data-value', `${seventhInterval}to${seventhInterval}`);
                            arpeggio7Btn.style.pointerEvents = 'auto';
                            arpeggio7Btn.style.opacity = '1';
                        }

                        if (randomArpeggioBtn) {
                            randomArpeggioBtn.style.pointerEvents = 'auto';
                            randomArpeggioBtn.style.opacity = '1';
                        }

                        // åŠ¨æ€åˆ›å»ºé¢å¤–çš„æŒ‰é’®æ¥æ˜¾ç¤ºéŸ³é˜¶ä¸­å…¶ä»–å¯ç”¨çš„éŸ³ç¨‹
                        const container = document.querySelector('.order-btn-container');
                        if (container) {
                            // æŸ¥æ‰¾ç°æœ‰çš„åŠ¨æ€æŒ‰é’®å¹¶ç§»é™¤
                            const existingDynamicButtons = container.querySelectorAll('.scale-arpeggio-btn.dynamic');
                            existingDynamicButtons.forEach(btn => btn.remove());

                            // åªåœ¨éŸ³é˜¶ç»ƒä¹ æ¨¡å¼ä¸‹åˆ›å»ºåŠ¨æ€æŒ‰é’®ï¼Œå’Œå¼¦ç»ƒä¹ æ¨¡å¼ä¸‹ä¸åˆ›å»º
                            const activeTab = document.querySelector('.nav-item.active');
                            if (activeTab && activeTab.dataset.tab === 'scale') {
                                // ä¸ºéŸ³é˜¶ä¸­æ¯ä¸ªç‹¬ç‰¹çš„éŸ³ç¨‹åˆ›å»ºæŒ‰é’®ï¼ˆé™¤äº†1ã€3ã€5ã€7ï¼Œå› ä¸ºå®ƒä»¬å·²ç»æœ‰é¢„å®šä¹‰æŒ‰é’®äº†ï¼‰
                                const uniqueIntervals = [...new Set(intervals)];
                                const predefinedIntervals = ['1', '3', '5', '7'];

                                uniqueIntervals.forEach(interval => {
                                    // æå–æ•°å­—éƒ¨åˆ†
                                    const intervalNumber = interval.replace(/[^0-9]/g, '');

                                    // è·³è¿‡é¢„å®šä¹‰çš„éŸ³ç¨‹
                                    if (predefinedIntervals.includes(intervalNumber)) {
                                        return;
                                    }

                                    // åˆ›å»ºæŒ‰é’®
                                    const btn = document.createElement('div');
                                    btn.className = 'order-btn scale-arpeggio-btn dynamic';
                                    btn.setAttribute('data-value', `${interval}to${interval}`);
                                    btn.textContent = `${interval}â†’${interval}`;
                                    btn.style.pointerEvents = 'auto';
                                    btn.style.opacity = '1';

                                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                                    btn.addEventListener('click', function() {
                                        // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeçŠ¶æ€
                                        const allButtons = container.querySelectorAll('.scale-arpeggio-btn');
                                        allButtons.forEach(b => b.classList.remove('active'));
                                        // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                                        this.classList.add('active');
                                    });

                                    // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨ä¸­ï¼Œæ”¾åœ¨éšæœºæŒ‰é’®ä¹‹å‰
                                    const randomBtn = container.querySelector('.scale-arpeggio-btn[data-value="random-arpeggio"]');
                                    if (randomBtn) {
                                        container.insertBefore(btn, randomBtn);
                                    } else {
                                        container.appendChild(btn);
                                    }
                                });
                            }
                        }
                    }

                    // æŸ¥æ‰¾éŸ³é˜¶ä¸­ç¬¬ä¸€ä¸ªå‡ºç°çš„æŒ‡å®šéŸ³ç¨‹ï¼ˆå¦‚'3', 'â™­3', 'â™¯3'ç­‰ï¼‰
                    function findFirstIntervalOfType(intervals, degree) {
                        // ç‰¹æ®Šå¤„ç†ï¼šå¯¹äºblueséŸ³é˜¶ç­‰ç‰¹æ®ŠéŸ³é˜¶ï¼Œä¼˜å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”åº¦æ•°çš„å˜éŸ³è®°å·ç‰ˆæœ¬
                        if (degree === '3') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === 'â™­3') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '4') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === 'â™­4') {
                                    return intervals[i];
                                }
                            }
                        } else if (degree === '7') {
                            for (let i = 0; i < intervals.length; i++) {
                                if (intervals[i] === 'â™­7') {
                                    return intervals[i];
                                }
                            }
                        }

                        // æ£€æŸ¥éŸ³é˜¶ä¸­æ˜¯å¦åŒ…å«è¯¥åº¦æ•°çš„ä»»ä½•å˜ä½“
                        for (let i = 0; i < intervals.length; i++) {
                            const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                            if (intervalNumber === degree) {
                                return intervals[i];
                            }
                        }

                        return null;
                    }

                    // å½“éŸ³é˜¶ä¸­ç¼ºå°‘ç‰¹å®šéŸ³ç¨‹æ—¶ï¼ŒæŸ¥æ‰¾éŸ³é˜¶ä¸­å®é™…å­˜åœ¨çš„æœ€è¿‘éŸ³ç¨‹
                    function findNearestIntervalInScale(intervals, degree) {
                        // é¦–å…ˆå°è¯•æŸ¥æ‰¾æŒ‡å®šåº¦æ•°çš„éŸ³ç¨‹
                        const foundInterval = findFirstIntervalOfType(intervals, degree);
                        if (foundInterval) {
                            return foundInterval;
                        }

                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œæ ¹æ®éŸ³ç¨‹ç±»å‹é€‰æ‹©æœ€è¿‘çš„æ›¿ä»£éŸ³ç¨‹
                        switch (degree) {
                            case '3':
                                // 3éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾4éŸ³ï¼ˆä¼˜å…ˆï¼‰æˆ–2éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '2') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '5':
                                // 5éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾4éŸ³æˆ–6éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '4') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                break;
                            case '7':
                                // 7éŸ³ç¼ºå¤±æ—¶ï¼ŒæŸ¥æ‰¾6éŸ³ï¼ˆä¼˜å…ˆï¼‰æˆ–1éŸ³
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '6') {
                                        return intervals[i];
                                    }
                                }
                                for (let i = 0; i < intervals.length; i++) {
                                    const intervalNumber = intervals[i].replace(/[^0-9]/g, '');
                                    if (intervalNumber === '1') {
                                        return intervals[i];
                                    }
                                }
                                break;
                        }

                        // å¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œè¿”å›éŸ³é˜¶ä¸­çš„ç¬¬ä¸€ä¸ªéŸ³ç¨‹ä½œä¸ºé»˜è®¤å€¼
                        return intervals.length > 0 ? intervals[0] : '1';
                    }

                    // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶å’Œåˆå§‹åŒ–
                    document.addEventListener('DOMContentLoaded', function() {
                        const scaleTypeElement = document.getElementById('scaleType');
                        if (scaleTypeElement) {
                            scaleTypeElement.addEventListener('change', updateArpeggioButtons);
                        }
                        updateArpeggioButtons();
                    });
                    </script>
                </div>


                <!-- å’Œå¼¦è®¾ç½® -->
                <div class="settings-section chord-settings hidden">
                    <div class="settings-section-title">
                        <i>ğŸ¶</i> <span data-i18n-key="settings_chord">å’Œå¼¦è®¾ç½®</span>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_root_note">æ ¹éŸ³</span>
                        </div>
                        <div class="select-wrapper">
                            <select id="chordRootNoteScale">
                                <option value="C" >C</option>
                                <option value="Câ™¯" >Câ™¯</option>
                                <option value="Dâ™­" >Dâ™­</option>
                                <option value="D" >D</option>
                                <option value="Dâ™¯" >Dâ™¯</option>
                                <option value="Eâ™­" >Eâ™­</option>
                                <option value="E" >E</option>
                                <option value="F" >F</option>
                                <option value="Fâ™¯" >Fâ™¯</option>
                                <option value="Gâ™­" >Gâ™­</option>
                                <option value="G" >G</option>
                                <option value="Gâ™¯" >Gâ™¯</option>
                                <option value="Aâ™­" >Aâ™­</option>
                                <option value="A" >A</option>
                                <option value="Aâ™¯" >Aâ™¯</option>
                                <option value="Bâ™­" >Bâ™­</option>
                                <option value="B" >B</option>
                                <option value="random" selected data-i18n-key="random_root" >éšæœºæ ¹éŸ³</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_type">å’Œå¼¦ç±»å‹</span>
                        </div>
                        <div class="chord-type-container">
                            <div class="chord-type-btn" data-value="major">Major</div>
                            <div class="chord-type-btn" data-value="minor">Minor</div>
                            <div class="chord-type-btn" data-value="diminished">Dim</div>
                            <div class="chord-type-btn" data-value="augmented">Aug</div>
                            <div class="chord-type-btn" data-value="major6">6</div>
                            <div class="chord-type-btn" data-value="minor6">m6</div>
                            <div class="chord-type-btn" data-value="dominant7">7</div>
                            <div class="chord-type-btn" data-value="major7">Maj7</div>
                            <div class="chord-type-btn" data-value="minor7">m7</div>
                            <div class="chord-type-btn" data-value="minor7b5">m7â™­5</div>
                            <div class="chord-type-btn" data-value="diminished7">dim7</div>
                            <div class="chord-type-btn" data-value="dominant9">9</div>
                            <div class="chord-type-btn" data-value="major9">Maj9</div>
                            <div class="chord-type-btn" data-value="minor9">m9</div>
                            <div class="chord-type-btn" data-value="dominant7sharp9">7â™¯9</div>
                            <div class="chord-type-btn" data-value="dominant7flat9">7â™­9</div>
                            <div class="chord-type-btn" data-value="dominant11">11</div>
                            <div class="chord-type-btn" data-value="minor11">m11</div>
                            <div class="chord-type-btn" data-value="dominant7sharp11">7â™¯11</div>
                            <div class="chord-type-btn" data-value="dominant13">13</div>
                            <div class="chord-type-btn" data-value="minor13">m13</div>
                            <div class="chord-type-btn" data-value="sus2">sus2</div>
                            <div class="chord-type-btn" data-value="sus4">sus4</div>
                            <div class="chord-type-btn" data-value="add9">add9</div>
                            <div class="chord-type-btn" data-value="madd9">madd9</div>
                            <div class="chord-type-btn" data-value="6add9">6add9</div>
                            <div class="chord-type-btn" data-value="m6add9">m6add9</div>
                        </div>

                    </div>

                    <div class="settings-row">
                        <div class="settings-label">
                            <span data-i18n-key="chord_order">é¡ºåº</span>
                        </div>
                        <div class="order-btn-container">
                            <div class="order-btn chord-order-btn active" data-value="ordered" data-i18n-key="order_ascending">ä¸Šè¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="reverse" data-i18n-key="order_descending">ä¸‹è¡Œ</div>
                            <div class="order-btn chord-order-btn" data-value="random" data-i18n-key="order_random">éšæœº</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="controls">
            <button class="btn" id="startBtn" data-i18n-key="btn_start">å¼€å§‹ç»ƒä¹ </button>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="bottom-nav">
        <div class="nav-item active" data-tab="scale">
            <div class="nav-icon">ğŸ¼</div>
            <div class="nav-label" data-i18n-key="nav_scale">éŸ³é˜¶ç»ƒä¹ </div>
        </div>
        <div class="nav-item" data-tab="chord">
            <div class="nav-icon">ğŸ¹</div>
            <div class="nav-label" data-i18n-key="nav_chord">å’Œå¼¦ç»ƒä¹ </div>
        </div>
        <div class="nav-item" data-tab="progression">
            <div class="nav-icon">ğŸµ</div>
            <div class="nav-label" data-i18n-key="nav_progression">å’Œå¼¦è½¬æ¢</div>
        </div>
        <div class="nav-item" data-tab="pitch-finding">
            <div class="nav-icon">ğŸ“</div>
            <div class="nav-label" data-i18n-key="nav_pitch_finding">éŸ³ç¨‹ç»ƒä¹ </div>
        </div>
        <div class="nav-item" data-tab="device">
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-label" data-i18n-key="nav_settings">è®¾ç½®</div>
        </div>
    </div>

    <!-- ç»ƒä¹ æ¨¡å¼å…¨å±é¡µé¢ -->
    <div id="practiceScreen">
        <!-- ä¹æ›²åæ˜¾ç¤ºåŒºåŸŸ -->
        <div class="song-title-display hidden" id="songTitleDisplay">
            <div class="song-title" id="songTitle"></div>
        </div>
        
        <!-- CAGEDå½¢çŠ¶æ˜¾ç¤ºåŒºåŸŸ -->
        <div class="caged-shape-display" id="cagedShapeDisplay" class="hidden">
            <div class="caged-shape-buttons">
                <div class="caged-shape-btn-display" data-shape="C">C</div>
                <div class="caged-shape-btn-display" data-shape="A">A</div>
                <div class="caged-shape-btn-display" data-shape="G">G</div>
                <div class="caged-shape-btn-display" data-shape="E">E</div>
                <div class="caged-shape-btn-display" data-shape="D">D</div>
            </div>
        </div>
        
        <div class="exercise-container">
            <div class="scale-info">
                <div class="target-interval" id="targetInterval">C Major</div>
            </div>

            <div class="sequence-display">

                <div class="sequence-items" id="sequenceDisplay"></div>
            </div>
        </div>

        <div class="next-exercise">
            <div class="next-content-wrapper">
                <div class="next-label">ä¸‹ä¸€ä¸ª:</div>
                <div class="next-content" id="nextExercise">-</div>
            </div>
        </div>

        <!-- æ‰¾éŸ³ç»ƒä¹ ç‰¹å®šå…ƒç´  -->
        <div id="pitchFindingElements" class="hidden">
            <!-- ç»ƒä¹ æ—¶é—´æ˜¾ç¤ºï¼ˆç‹¬ç«‹æ˜¾ç¤ºï¼‰ -->
            <div class="pitch-finding-timer">
                <div class="timer-label" data-i18n-key="pitch_finding_time_remaining">å‰©ä½™æ—¶é—´</div>
                <div class="timer-display" id="timerDisplay">05:00</div>
            </div>

            <!-- å½“å‰éŸ³ç¬¦æ˜¾ç¤ºï¼ˆå±…ä¸­ï¼‰ -->
            <div class="pitch-finding-current-note">
                <div class="current-note-label" data-i18n-key="pitch_finding_current_note">å½“å‰éŸ³ç¬¦</div>
                <div class="current-note-display" id="currentNoteDisplay">C</div>
            </div>

            <!-- æŒ‡æ¿æ˜¾ç¤ºåŒºåŸŸ -->
            <div id="fretboardContainer" class="fretboard-container hidden">
                <div id="fretboard" class="fretboard"></div>
            </div>
            
            <!-- æŒ‡æ¿å“æ•° -->
            <div class="fretboard-footer" id="fretboardFooter" class="hidden">
                <div class="fret-numbers" id="fretNumbers"></div>
            </div>

            <!-- ä¸‹ä¸€é¢˜æŒ‰é’® -->
            <div class="pitch-finding-next-btn-container hidden">
                <button id="pitchFindingNextBtn" class="pitch-finding-next-btn" data-i18n-key="pitch_finding_next_question">ä¸‹ä¸€é¢˜</button>
            </div>

        </div>
    </div>

    <script>
        // PitchFinderåº“å†…è”ä»£ç  - ç›´æ¥åµŒå…¥å¢å¼ºç‰ˆYINç®—æ³•å®ç°
        (function (global) {
            // PitchFinderä¸»å¯¹è±¡
            var Pitchfinder = {};

            // å¢å¼ºç‰ˆYINç®—æ³•å®ç°
            Pitchfinder.YIN = function (config) {
                config = config || {};
                var threshold = config.threshold || 0.15;
                var probabilityCliff = config.probabilityCliff || 0.1;

                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);

                    // æ­¥éª¤1: å·®åˆ†å‡½æ•°
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }

                    // æ­¥éª¤2: ç´¯ç§¯å¹³å‡å½’ä¸€åŒ–
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }

                    // æ­¥éª¤3: é˜ˆå€¼æ£€æµ‹
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }

                    if (tauEstimate === -1) return null;

                    // æ­¥éª¤4: æŠ›ç‰©çº¿æ’å€¼æé«˜ç²¾åº¦
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }

                    const frequency = 48000 / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));

                    if (probability < probabilityCliff) return null;

                    return { frequency, probability };
                };
            };

            // å°†PitchFinderæš´éœ²ç»™å…¨å±€
            global.Pitchfinder = Pitchfinder;
        })(window);

        document.addEventListener('DOMContentLoaded', function () {
            // å‰ä»–æ ‡å‡†è°ƒå¼¦
            const standardTuning = ['E', 'B', 'G', 'D', 'A', 'E'];

            // æ‰€æœ‰å¯èƒ½çš„éŸ³çº§
            const intervals = ['1', 'â™­2', '2', 'â™­3', '3', '4', 'â™¯4', '5', 'â™­6', '6', 'â™­7', '7'];

            // éŸ³çº§åˆ°åŠéŸ³è·ç¦»çš„æ˜ å°„
            const intervalToSemitones = {
                '1': 0,
                'â™­2': 1,
                '2': 2,
                'â™¯2': 3,
                'â™­3': 3,
                '3': 4,
                '4': 5,
                'â™­4': 4,
                'â™¯4': 6,
                'â™­5': 6,
                '5': 7,
                'â™¯5': 8,
                'â™­6': 8,
                '6': 9,
                'â™¯6': 10,
                'â™­7': 10,
                '7': 11,
                // å¤åˆéŸ³ç¨‹æ˜ å°„ï¼ˆ9=2, 11=4, 13=6ï¼‰
                'â™­9': 1,
                '9': 2,
                'â™¯9': 3,
                '11': 4,
                'â™¯11': 6,
                'â™­13': 8,
                '13': 9
            };

            // éŸ³ååˆ°åŠéŸ³æ•°çš„æ˜ å°„ï¼ˆC = 0ï¼‰
            const noteToSemitones = {
                'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4,
                'F': 5, 'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8,
                'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
            };

            // éŸ³é˜¶ç±»å‹å®šä¹‰
            const scaleTypes = {
                // åŸºæœ¬è°ƒå¼
                'major': { name: 'Major', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'minor': { name: 'Minor', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                
                // æ•™ä¼šè°ƒå¼ (Church Modes)
                'ionian': { name: 'Ionian - 1 2 3 4 5 6 7', intervals: ['1', '2', '3', '4', '5', '6', '7'] },
                'dorian': { name: 'Dorian - 1 2 â™­3 4 5 6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', '6', 'â™­7'] },
                'phrygian': { name: 'Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                'lydian': { name: 'Lydian - 1 2 3 â™¯4 5 6 7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', '7'] },
                'mixolydian': { name: 'Mixolydian - 1 2 3 4 5 6 â™­7', intervals: ['1', '2', '3', '4', '5', '6', 'â™­7'] },
                'aeolian': { name: 'Aeolian - 1 2 â™­3 4 5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', 'â™­7'] },
                'locrian': { name: 'Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                
                // å’Œå£°å°è°ƒç³»åˆ—
                'harmonicMinor': { name: 'Harmonic Minor - 1 2 â™­3 4 5 â™­6 7', intervals: ['1', '2', 'â™­3', '4', '5', 'â™­6', '7'] },
                'dorianSharp2': { name: 'Dorian â™¯2 - 1 â™¯2 3 4 5 6 â™­7', intervals: ['1', 'â™¯2', '3', '4', '5', '6', 'â™­7'] },
                'phrygianMajor': { name: 'Phrygian Major - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                'lydianSharp2': { name: 'Lydian â™¯2 - 1 â™¯2 3 â™¯4 5 6 7', intervals: ['1', 'â™¯2', '3', 'â™¯4', '5', '6', '7'] },
                'mixolydianFlat6': { name: 'Mixolydian â™­6 - 1 2 3 4 5 â™­6 â™­7', intervals: ['1', '2', '3', '4', '5', 'â™­6', 'â™­7'] },
                'lydianFlat2': { name: 'Lydian â™­2 - 1 â™­2 3 â™¯4 5 6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', '5', '6', '7'] },
                'superLocrianDiminished': { name: 'Super Locrian Diminished - 1 â™­2 â™­3 â™­4 â™­5 â™­6 6', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', '6'] },
                
                // æ—‹å¾‹å°è°ƒç³»åˆ—
                'melodicMinor': { name: 'Melodic Minor - 1 2 â™­3 4 5 6 7', intervals: ['1', '2', 'â™­3', '4', '5', '6', '7'] },
                'melodicMinorDescending': { name: 'Melodic Minor Descending - 1 â™­7 â™­6 5 4 â™­3 2 1', intervals: ['1', 'â™­7', 'â™­6', '5', '4', 'â™­3', '2', '1'] },
                'dorianFlat2': { name: 'Dorian â™­2 - 1 â™­2 â™­3 4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', '6', 'â™­7'] },
                'lydianAugmented': { name: 'Lydian Augmented - 1 2 3 â™¯4 â™¯5 6 7', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', '6', '7'] },
                'lydianFlat7': { name: 'Lydian â™­7 - 1 2 3 â™¯4 5 6 â™­7', intervals: ['1', '2', '3', 'â™¯4', '5', '6', 'â™­7'] },
                'aeolianFlat5': { name: 'Aeolian â™­5 - 1 2 â™­3 4 â™­5 â™­6 â™­7', intervals: ['1', '2', 'â™­3', '4', 'â™­5', 'â™­6', 'â™­7'] },
                'superLocrian': { name: 'Super Locrian - 1 â™­2 â™­3 â™­4 â™­5 â™­6 â™­7', intervals: ['1', 'â™­2', 'â™­3', 'â™­4', 'â™­5', 'â™­6', 'â™­7'] },
                
                // äº”å£°éŸ³é˜¶ç³»åˆ—
                'majorPentatonic': { name: 'Major Pentatonic - 1 2 3 5 6', intervals: ['1', '2', '3', '5', '6'] },
                'minorPentatonic': { name: 'Minor Pentatonic - 1 â™­3 4 5 â™­7', intervals: ['1', 'â™­3', '4', '5', 'â™­7'] },
                'dorianPentatonic': { name: 'Dorian Pentatonic - 1 2 â™­3 5 6', intervals: ['1', '2', 'â™­3', '5', '6'] },
                'phrygianPentatonic': { name: 'Phrygian Pentatonic - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                'mixolydianPentatonic': { name: 'Mixolydian Pentatonic - 1 2 3 5 â™­7', intervals: ['1', '2', '3', '5', 'â™­7'] },
                
                // å¸ƒé²æ–¯éŸ³é˜¶ç³»åˆ—
                'blues': { name: 'Blues - 1 â™­3 4 â™¯4 5 â™­7', intervals: ['1', 'â™­3', '4', 'â™¯4', '5', 'â™­7'] },
                'majorBlues': { name: 'Major Blues - 1 2 â™­3 3 5 6', intervals: ['1', '2', 'â™­3', '3', '5', '6'] },
                
                // å…¶ä»–å¸¸è§éŸ³é˜¶
                'wholeTone': { name: 'Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6', intervals: ['1', '2', '3', 'â™¯4', 'â™¯5', 'â™¯6'] },
                'diminished': { name: 'Diminished (Half-Whole) - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7', intervals: ['1', 'â™­2', 'â™­3', '3', 'â™¯4', '5', '6', 'â™­7'] },
                'diminishedWhole': { name: 'Diminished (Whole-Half) - 1 2 â™­3 â™¯4 â™¯5 6 7', intervals: ['1', '2', 'â™­3', 'â™¯4', 'â™¯5', '6', '7'] },
                
                // å¼‚å›½é£æ ¼éŸ³é˜¶
                'arabic': { name: 'Arabic - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] },
                'gypsy': { name: 'Gypsy - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                'japanese': { name: 'Japanese - 1 â™­2 4 5 â™­6', intervals: ['1', 'â™­2', '4', '5', 'â™­6'] },
                'egyptian': { name: 'Egyptian - 1 2 4 5 â™­7', intervals: ['1', '2', '4', '5', 'â™­7'] },
                'hungarian': { name: 'Hungarian - 1 â™¯2 3 â™¯4 5 â™­6 7', intervals: ['1', 'â™¯2', '3', 'â™¯4', '5', 'â™­6', '7'] },
                'persian': { name: 'Persian - 1 â™­2 3 4 â™­5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', 'â™­5', 'â™­6', '7'] },
                'byzantine': { name: 'Byzantine - 1 â™­2 3 4 5 â™­6 7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', '7'] },
                'enigmatic': { name: 'Enigmatic - 1 â™­2 3 â™¯4 â™¯5 â™¯6 7', intervals: ['1', 'â™­2', '3', 'â™¯4', 'â™¯5', 'â™¯6', '7'] },
                'neapolitan': { name: 'Neapolitan - 1 â™­2 â™­3 4 5 â™­6 7', intervals: ['1', 'â™­2', 'â™­3', '4', '5', 'â™­6', '7'] },
                'spanish': { name: 'Spanish - 1 â™­2 3 4 5 â™­6 â™­7', intervals: ['1', 'â™­2', '3', '4', '5', 'â™­6', 'â™­7'] }

            };

            // å’Œå¼¦ç±»å‹å®šä¹‰
            const chordTypes = {
                // åŸºç¡€ä¸‰å’Œå¼¦
                'major': { name: 'å¤§ä¸‰å’Œå¼¦', intervals: ['1', '3', '5'] },
                'minor': { name: 'å°ä¸‰å’Œå¼¦', intervals: ['1', 'â™­3', '5'] },
                'diminished': { name: 'å‡ä¸‰å’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5'] },
                'augmented': { name: 'å¢ä¸‰å’Œå¼¦', intervals: ['1', '3', 'â™¯5'] },
                
                // å…­å’Œå¼¦
                'major6': { name: 'å¤§å…­å’Œå¼¦', intervals: ['1', '3', '5', '6'] },
                'minor6': { name: 'å°å…­å’Œå¼¦', intervals: ['1', 'â™­3', '5', '6'] },
                
                // ä¸ƒå’Œå¼¦
                'dominant7': { name: 'å±ä¸ƒå’Œå¼¦', intervals: ['1', '3', '5', 'â™­7'] },
                'major7': { name: 'å¤§ä¸ƒå’Œå¼¦', intervals: ['1', '3', '5', '7'] },
                'minor7': { name: 'å°ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7'] },
                'minor7b5': { name: 'åŠå‡ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5', 'â™­7'] },
                'diminished7': { name: 'å‡ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5', '6'] },
                
                // ä¹å’Œå¼¦
                'dominant9': { name: 'å±ä¹å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '9'] },
                'major9': { name: 'å¤§ä¹å’Œå¼¦', intervals: ['1', '3', '5', '7', '9'] },
                'minor9': { name: 'å°ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '9'] },
                'dominant7sharp9': { name: 'å±7â™¯9å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™¯9'] },
                'dominant7flat9': { name: 'å±7â™­9å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™­9'] },
                
                // åä¸€å’Œå¼¦
                'dominant11': { name: 'å±11å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '9', '11'] },
                'minor11': { name: 'å°11å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '9', '11'] },
                'dominant7sharp11': { name: 'å±7â™¯11å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™¯11'] },
                
                // åä¸‰å’Œå¼¦
                'dominant13': { name: 'å±13å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', '9', '13'] },
                'minor13': { name: 'å°13å’Œå¼¦', intervals: ['1', 'â™­3', '5', 'â™­7', '9', '13'] },
                
                // æŒ‚ç•™å’Œå¼¦
                'sus2': { name: 'æŒ‚äºŒå’Œå¼¦', intervals: ['1', '2', '5'] },
                'sus4': { name: 'æŒ‚å››å’Œå¼¦', intervals: ['1', '4', '5'] },
                '7sus4': { name: 'ä¸ƒæŒ‚å››å’Œå¼¦', intervals: ['1', '4', '5', 'â™­7'] },
                '7sus2': { name: 'ä¸ƒæŒ‚äºŒå’Œå¼¦', intervals: ['1', '2', '5', 'â™­7'] },
                
                // åŠ éŸ³å’Œå¼¦
                'add9': { name: 'åŠ ä¹å’Œå¼¦', intervals: ['1', '3', '5', '9'] },
                'madd9': { name: 'å°åŠ ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', '9'] },
                '6add9': { name: 'å…­åŠ ä¹å’Œå¼¦', intervals: ['1', '3', '5', '6', '9'] },
                'm6add9': { name: 'å°å…­åŠ ä¹å’Œå¼¦', intervals: ['1', 'â™­3', '5', '6', '9'] },

                // å¤æ‚å’Œå¼¦ç±»å‹ - ç”¨äºç»ƒä¹ æ›²ç›®
                'sus4b9': { name: 'æŒ‚ç•™å››é™ä¹å’Œå¼¦', intervals: ['1', '4', '5', 'â™­9'] },
                '13sus4b9': { name: 'åä¸‰æŒ‚ç•™å››é™ä¹å’Œå¼¦', intervals: ['1', '4', '5', 'â™­7', '9', '13'] },
                'Maj7#11': { name: 'å¤§ä¸ƒå‡åä¸€å’Œå¼¦', intervals: ['1', '3', '5', '7', 'â™¯11'] },
                'Maj7#5': { name: 'å¤§ä¸ƒå‡äº”å’Œå¼¦', intervals: ['1', '3', 'â™¯5', '7'] },
                '7#11': { name: 'å±ä¸ƒå‡åä¸€å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™¯11'] },
                'MinMaj7': { name: 'å°å¤§ä¸ƒå’Œå¼¦', intervals: ['1', 'â™­3', '5', '7'] },
                'Min7b5â™®9': { name: 'å°ä¸ƒé™äº”è‡ªç„¶ä¹å’Œå¼¦', intervals: ['1', 'â™­3', 'â™­5', 'â™­7', '9'] },
                '13b9': { name: 'åä¸‰é™ä¹å’Œå¼¦', intervals: ['1', '3', '5', 'â™­7', 'â™­9', '13'] }
            };

            // ç»å…¸çˆµå£«ä¹æ­Œæ›²å’Œå¼¦è¿›è¡Œï¼ˆåŸºäºéŸ³çº§å‚¨å­˜ï¼‰
            const jazzStandards = {
                '5': {
                    '500 Miles High': {
                        key: 'E',
                        chords: ['Im7', 'â™­IIIm7', 'Im7', 'â™­IIIm7', 'â™­VIM7', 'â™­IIM7', 'Im7', 'Im7']
                    }
                },
                'A': {
                    'All The Things You Are': {
                        key: 'C',
                        chords: ['VIIm7â™­5', 'III7', 'VIm7', 'II7', 'IIm7', 'V7', 'IM7', 'IM7'],
                        info: {
                            composer: 'Jerome Kern',
                            year: '1939',
                            style: 'çˆµå£«æ ‡å‡†æ›²/ç™¾è€æ±‡éŸ³ä¹å‰§',
                            tempo: 'Medium Ballad',
                            description: 'è¢«èª‰ä¸ºæœ€å®Œç¾çš„çˆµå£«æ ‡å‡†æ›²ä¹‹ä¸€ï¼Œå’Œå£°è¿›è¡Œå¤æ‚è€Œä¼˜ç¾ï¼Œæ˜¯å­¦ä¹ é«˜çº§å’Œå£°çš„ç»å…¸æ•™æã€‚'
                        }
                    },
                    'Autumn Leaves': {
                        key: 'G',
                        chords: ['IVm7', 'â™­VII7', 'â™­IIIM7', 'â™­VIM7', 'IIm7â™­5', 'V7', 'Im7', 'Im7'],
                        info: {
                            composer: 'Joseph Kosma',
                            year: '1945',
                            style: 'æ³•å¼é¦™é¢‚/çˆµå£«æ ‡å‡†æ›²',
                            tempo: 'Medium Ballad',
                            description: 'æ³•å›½ä½œæ›²å®¶åˆ›ä½œçš„ç»å…¸æ›²ç›®ï¼Œå±•ç°äº†ä»å¤§è°ƒåˆ°å°è°ƒçš„è‡ªç„¶è½¬æ¢ï¼Œæ˜¯å­¦ä¹ ii-V-iè¿›è¡Œçš„ç»ä½³æ•™æã€‚'
                        }
                    },
                    'All Of Me': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'IVM7', 'IIIm7â™­5', 'VI7'],
                        info: {
                            composer: 'Gerald Marks & Seymour Simons',
                            year: '1931',
                            style: 'çˆµå£«æ ‡å‡†æ›²',
                            tempo: 'Medium Swing',
                            description: 'ç»å…¸çš„32å°èŠ‚AABAç»“æ„çˆµå£«æ ‡å‡†æ›²ï¼Œä»¥å…¶ç®€å•è€Œä¼˜ç¾çš„å’Œå£°è¿›è¡Œè‘—ç§°ã€‚'
                        }
                    },
                    'A Night In Tunisia': {
                        key: 'D',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'Im7', 'â™­IIM7']
                    },
                    'All of You': {
                        key: 'C',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Alone Together': {
                        key: 'G',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'â™­VI7', 'â™­IIM7', 'IIm7â™­5', 'V7', 'Im7']
                    },
                    'Ambleside': {
                        key: 'C',
                        chords: ['IM7', 'V7sus4', 'IM7', 'IVM7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Anthropology': {
                        key: 'Bâ™­',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Ask Me Now': {
                        key: 'F',
                        chords: ['IM7', 'â™­II7', 'IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'IM7']
                    }
                },
                'B': {
                    'Blue Moon': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Body And Soul': {
                        key: 'Dâ™­',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'â™­VIIM7', 'Vm7', 'II7', 'V7']
                    },
                    'Bye Bye Blackbird': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'II7', 'VIIm7', 'III7', 'VIm7', 'IIm7']
                    },
                    'Beautiful Love': {
                        key: 'G',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'Im7', 'IVm7', 'â™­VII7', 'â™­IIIM7', 'â™­IIIM7']
                    },
                    'Blue Bossa': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'â™­VIIM7', 'â™­VIIM7']
                    },
                    'Blue in Green': {
                        key: 'C',
                        chords: ['IM7', 'â™­VII7', 'â™­IIIM7', 'â™­VIM7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    },
                    'Blues for Alice': {
                        key: 'F',
                        chords: ['I7', 'VI7', 'II7', 'V7', 'III7', 'VI7', 'II7', 'V7']
                    }
                },
                'C': {
                    'Cherokee': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Come Rain Or Come Shine': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Confirmation': {
                        key: 'F',
                        chords: ['IM7', 'â™­VII7', 'IIIm7â™­5', 'VI7', 'IIm7', 'V7', 'IIIm7â™­5', 'VI7']
                    },
                    'Coral': {
                        key: 'G',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Corcovado': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7']
                    },
                    'Countdown': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'â™­III7', 'â™­VIM7', 'â™­II7', 'VM7', 'I7', 'IVM7', 'â™­VII7']
                    }
                },
                'D': {
                    'Days Of Wine And Roses': {
                        key: 'F',
                        chords: ['IM7', 'IV7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Donna Lee': {
                        key: 'Aâ™­',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Doxy': {
                        key: 'Bâ™­',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'I7']
                    },
                    'Dream A Little Dream': {
                        key: 'C',
                        chords: ['IM7', 'â™­IIIdim', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'F': {
                    'Fall': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    },
                    'Falling Grace': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Fly Me To The Moon': {
                        key: 'C',
                        chords: ['VIm7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7']
                    },
                    'Four': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Footprints': {
                        key: 'C',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IVm7', 'IVm7', 'Im7', 'Im7']
                    }
                },
                'G': {
                    'Giant Steps': {
                        key: 'B',
                        chords: ['IM7', 'â™­III7', 'â™­VIM7', 'â™­VII7', 'â™­IIM7', 'â™­VIm7', 'â™­III7', 'â™­VIM7']
                    },
                    'Georgia On My Mind': {
                        key: 'F',
                        chords: ['IM7', 'III7', 'VIm7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7']
                    },
                    'Girl From Ipanema': {
                        key: 'F',
                        chords: ['IM7', 'II7', 'IIm7', 'V7', 'IIIm7â™­5', 'VI7', 'IIm7', 'IIm7']
                    }
                },
                'H': {
                    'Have You Met Miss Jones': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Here\'s That Rainy Day': {
                        key: 'G',
                        chords: ['â™­VII7', 'IVm7', 'â™­VII7', 'â™­IIIM7', 'â™­VIM7', 'IIm7â™­5', 'V7', 'Im7']
                    },
                    'How High The Moon': {
                        key: 'G',
                        chords: ['IM7', 'Im7', 'IV7', 'â™­VIIM7', 'â™­VIIM7', 'IIIm7â™­5', 'VI7', 'IIm7']
                    }
                },
                'I': {
                    'I Got Rhythm': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'I Can\'t Get Started': {
                        key: 'C',
                        chords: ['IM7', 'III7', 'VIm7', 'I7', 'IVM7', 'VI7', 'IIm7', 'V7']
                    },
                    'In A Sentimental Mood': {
                        key: 'D',
                        chords: ['Im7', 'IV7', 'IIm7â™­5', 'V7', 'Im7', 'IV7', 'â™­VIIM7', 'â™­VIIM7']
                    },
                    'Infant Eyes': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7']
                    },
                    'Inner Urge': {
                        key: 'Aâ™­',
                        chords: ['IM7', 'â™­II7', 'IM7', 'â™­II7', 'IVM7', 'â™­VII7', 'IM7', 'IM7']
                    }
                },
                'J': {
                    'Just Friends': {
                        key: 'G',
                        chords: ['IM7', 'IV7', 'IIM7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    },
                    'Joy Spring': {
                        key: 'F',
                        chords: ['IM7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Jordu': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'â™­VIIM7', 'â™­IIIM7', 'VIm7â™­5', 'II7', 'Vm7', 'IIm7']
                    }
                },
                'L': {
                    'Lady Bird': {
                        key: 'C',
                        chords: ['IM7', 'VIm7', 'IVm7â™­5', 'â™­VII7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Love For Sale': {
                        key: 'G',
                        chords: ['Im7', 'IV7', 'Im7', 'IV7', 'â™­VIIM7', 'Vm7', 'Im7', 'IV7']
                    },
                    'Lover Man': {
                        key: 'Aâ™­',
                        chords: ['IM7', 'VI7', 'IIm7', 'V7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    }
                },
                'M': {
                    'Misty': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'Vm7', 'I7', 'IVM7', 'IVm7', 'â™­VII7', 'IM7', 'VIm7']
                    },
                    'My Funny Valentine': {
                        key: 'C',
                        chords: ['Im7', 'IV7', 'â™­VIIM7', 'â™­IIIM7', 'VIm7â™­5', 'II7', 'Vm7', 'I7']
                    },
                    'Maiden Voyage': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IIm7', 'V7', 'â™­IIIm7', 'â™­VI7', 'â™­IIM7', 'â™­IIM7']
                    }
                },
                'N': {
                    'Night And Day': {
                        key: 'C',
                        chords: ['IM7', 'IIm7', 'IIIm7', 'IIm7', 'IM7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Nardis': {
                        key: 'E',
                        chords: ['Im7', 'â™­IIM7', 'Im7', 'â™­IIM7', 'â™­VIIM7', 'â™­IIM7', 'Im7', 'Im7']
                    },
                    'Night Train': {
                        key: 'G',
                        chords: ['I7', 'IV7', 'I7', 'I7', 'IV7', 'IV7', 'I7', 'V7']
                    }
                },
                'O': {
                    'Oleo': {
                        key: 'Bâ™­',
                        chords: ['I7', 'VI7', 'IIm7', 'V7', 'IIIm7', 'VI7', 'IIm7', 'V7']
                    }
                },
                'S': {
                    'Someday My Prince Will Come': {
                        key: 'Bâ™­',
                        chords: ['IM7', 'IV7', 'VIIm7â™­5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'Spain': {
                        key: 'A',
                        chords: ['IIm7', 'V7', 'IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7', 'VIm7']
                    },
                    'Stella By Starlight': {
                        key: 'D',
                        chords: ['IIm7â™­5', 'V7', 'Im7', 'â™­VI7', 'â™­IIIM7', 'IIm7â™­5', 'V7', 'Im7']
                    },
                    'Summertime': {
                        key: 'A',
                        chords: ['Im7', 'V7', 'Im7', 'V7', 'IVm7', 'â™­VII7', 'â™­IIIM7', 'â™­VIM7']
                    },
                    'Solar': {
                        key: 'C',
                        chords: ['Im7', 'IV7', 'â™­VIIM7', 'â™­IIIM7', 'VIm7â™­5', 'II7', 'Vm7', 'I7']
                    }
                },
                'T': {
                    'Take Five': {
                        key: 'Eâ™­m',
                        chords: ['Im7', 'IV7', 'â™­VIIM7', 'â™­IIIM7', 'IIm7', 'V7', 'Im7', 'Im7']
                    },
                    'Take the A-Train': {
                        key: 'C',
                        chords: ['IM7', 'IVM7', 'VIIm7â™­5', 'III7', 'VIm7', 'IIm7', 'V7', 'IM7']
                    },
                    'There Will Never Be Another You': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'IIIm7', 'VI7', 'IIm7', 'V7', 'IM7', 'IIIm7', 'VI7']
                    },
                    'The Way You Look Tonight': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'IV7', 'IM7', 'VIm7', 'IIm7', 'V7', 'IM7', 'IM7']
                    },
                    'Time Remembered': {
                        key: 'F',
                        chords: ['IM7', 'â™­VII7', 'IM7', 'â™­VII7', 'IVM7', 'â™­VII7', 'IM7', 'IM7']
                    }
                },
                'V': {
                    'Very Early': {
                        key: 'Eâ™­',
                        chords: ['IM7', 'VIm7', 'IIm7', 'V7', 'IIIm7', 'VIm7', 'IIm7', 'V7']
                    },
                    'Virgo': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Im7', 'Im7', 'IIm7â™­5', 'V7', 'Im7', 'Im7']
                    }
                },
                'ç»ƒä¹ ': {
                    'ç»ƒä¹ 1 - Maj7å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['IM7', 'IV7', 'V7', 'IM7'], // ç®€åŒ–çš„å’Œå¼¦è¿›è¡Œç¤ºä¾‹
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Maj7å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»AMaj7å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘ï¼ˆA-D-G-C-F-Bâ™­-Eâ™­-Aâ™­-Dâ™­-Gâ™­-B-Eï¼‰è¿›è¡Œ12ä¸ªè°ƒçš„Maj7å’Œå¼¦ç»ƒä¹ ã€‚æ¯ä¸ªå’Œå¼¦æŒç»­ä¸€ä¸ªå°èŠ‚ï¼Œå…±48å°èŠ‚çš„å®Œæ•´å¾ªç¯ã€‚é€‚åˆç»ƒä¹ å¤§ä¸ƒå’Œå¼¦åœ¨ä¸åŒè°ƒä¸­çš„æŒ‡æ³•å’Œå£°éŸ³è‰²å½©ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAMaj7 â†’ DMaj7 â†’ GMaj7 â†’ CMaj7 â†’ FMaj7 â†’ Bâ™­Maj7 â†’ Eâ™­Maj7 â†’ Aâ™­Maj7 â†’ Dâ™­Maj7 â†’ Gâ™­Maj7 â†’ BMaj7 â†’ EMaj7 â†’ å›åˆ°AMaj7ã€‚æ¯ä¸ªè°ƒçš„Maj7å’Œå¼¦ç»ƒä¹ å¸®åŠ©ä½ æŒæ¡ä¸åŒè°ƒæ€§ä¸‹çš„å£°éŸ³ç‰¹ç‚¹ã€‚'
                        }
                    },
                    'ç»ƒä¹ 2 - Min7å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['Im7', 'IVm7', 'Vm7', 'Im7'], // ç®€åŒ–çš„å’Œå¼¦è¿›è¡Œç¤ºä¾‹
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Min7å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»Am7å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘ï¼ˆA-D-G-C-F-Bâ™­-Eâ™­-Aâ™­-Dâ™­-Gâ™­-B-Eï¼‰è¿›è¡Œ12ä¸ªè°ƒçš„å°ä¸ƒå’Œå¼¦ç»ƒä¹ ã€‚æ¯ä¸ªå’Œå¼¦æŒç»­ä¸€ä¸ªå°èŠ‚ï¼Œå…±48å°èŠ‚çš„å®Œæ•´å¾ªç¯ã€‚é€‚åˆç»ƒä¹ å°ä¸ƒå’Œå¼¦åœ¨ä¸åŒè°ƒä¸­çš„æŒ‡æ³•å’Œå£°éŸ³è‰²å½©ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAm7 â†’ Dm7 â†’ Gm7 â†’ Cm7 â†’ Fm7 â†’ Bâ™­m7 â†’ Eâ™­m7 â†’ Aâ™­m7 â†’ Dâ™­m7 â†’ Gâ™­m7 â†’ Bm7 â†’ Em7 â†’ å›åˆ°Am7ã€‚æ¯ä¸ªè°ƒçš„å°ä¸ƒå’Œå¼¦ç»ƒä¹ å¸®åŠ©ä½ æŒæ¡ä¸åŒè°ƒæ€§ä¸‹çš„å’Œå£°è‰²å½©ã€‚'
                        }
                    },
                    'ç»ƒä¹ 3 - Sus4b9å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['Isus4(b9)', 'IVsus4(b9)', 'Vsus4(b9)', 'Isus4(b9)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Sus4(b9)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»Asus4(b9)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„æŒ‚ç•™å››å’Œå¼¦åŠ é™ä¹éŸ³ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦ç»„åˆå…·æœ‰ç´§å¼ å’Œè§£å†³çš„å¼ºçƒˆå€¾å‘æ€§ï¼Œé€‚åˆç»ƒä¹ çˆµå£«å’Œå£°çš„å¼ åŠ›å¤„ç†ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAsus4(b9) â†’ Dsus4(b9) â†’ Gsus4(b9) â†’ Csus4(b9) â†’ Fsus4(b9) â†’ Bâ™­sus4(b9) â†’ Eâ™­sus4(b9) â†’ Aâ™­sus4(b9) â†’ Dâ™­sus4(b9) â†’ Gâ™­sus4(b9) â†’ Bsus4(b9) â†’ Esus4(b9) â†’ å›åˆ°Asus4(b9)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 4 - Maj7#11å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['IMaj7(#11)', 'IVMaj7(#11)', 'VMaj7(#11)', 'IMaj7(#11)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Maj7(#11)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»AMaj7(#11)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å‡åä¸€éŸ³å¤§ä¸ƒå’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦å…·æœ‰å¼ºçƒˆçš„Lydianè°ƒå¼è‰²å½©ï¼Œæ˜¯ç°ä»£çˆµå£«å’Œå£°çš„é‡è¦å…ƒç´ ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAMaj7(#11) â†’ DMaj7(#11) â†’ GMaj7(#11) â†’ CMaj7(#11) â†’ FMaj7(#11) â†’ Bâ™­Maj7(#11) â†’ Eâ™­Maj7(#11) â†’ Aâ™­Maj7(#11) â†’ Dâ™­Maj7(#11) â†’ Gâ™­Maj7(#11) â†’ BMaj7(#11) â†’ EMaj7(#11) â†’ å›åˆ°AMaj7(#11)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 5 - 7sus4å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['I7sus4', 'IV7sus4', 'V7sus4', 'I7sus4'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: '7sus4å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»A7sus4å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å±ä¸ƒæŒ‚ç•™å››å’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦åœ¨ä¸è§£å†³å‰ä¿æŒé«˜åº¦å¼ åŠ›ï¼Œæ˜¯çˆµå£«å³å…´çš„å¸¸ç”¨æ‰‹æ³•ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šA7sus4 â†’ D7sus4 â†’ G7sus4 â†’ C7sus4 â†’ F7sus4 â†’ Bâ™­7sus4 â†’ Eâ™­7sus4 â†’ Aâ™­7sus4 â†’ Dâ™­7sus4 â†’ Gâ™­7sus4 â†’ B7sus4 â†’ E7sus4 â†’ å›åˆ°A7sus4ã€‚'
                        }
                    },
                    'ç»ƒä¹ 5a - Dom7å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['I7', 'IV7', 'V7', 'I7'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Dom7å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»A7å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å±ä¸ƒå’Œå¼¦ç»ƒä¹ ã€‚å±ä¸ƒå’Œå¼¦æ˜¯å¸ƒé²æ–¯å’Œçˆµå£«éŸ³ä¹çš„æ ¸å¿ƒï¼ŒæŒæ¡å…¶å¾ªç¯å¯¹äºç†è§£åŠŸèƒ½æ€§å’Œå£°è‡³å…³é‡è¦ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šA7 â†’ D7 â†’ G7 â†’ C7 â†’ F7 â†’ Bâ™­7 â†’ Eâ™­7 â†’ Aâ™­7 â†’ Dâ™­7 â†’ Gâ™­7 â†’ B7 â†’ E7 â†’ å›åˆ°A7ã€‚'
                        }
                    },
                    'ç»ƒä¹ 6 - Min7b5å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['Im7(b5)', 'IVm7(b5)', 'Vm7(b5)', 'Im7(b5)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Min7(b5)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»Am7(b5)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å°ä¸ƒé™äº”å’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦æ˜¯å°è°ƒå’Œå£°å’Œå‡éŸ³é˜¶çš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œå…·æœ‰å¼ºçƒˆçš„ç´§å¼ æ„Ÿã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAm7(b5) â†’ Dm7(b5) â†’ Gm7(b5) â†’ Cm7(b5) â†’ Fm7(b5) â†’ Bâ™­m7(b5) â†’ Eâ™­m7(b5) â†’ Aâ™­m7(b5) â†’ Dâ™­m7(b5) â†’ Gâ™­m7(b5) â†’ Bm7(b5) â†’ Em7(b5) â†’ å›åˆ°Am7(b5)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 7 - MinMaj7å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['Im(Maj7)', 'IVm(Maj7)', 'Vm(Maj7)', 'Im(Maj7)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'MinMaj7å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»Am(Maj7)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å°å¤§ä¸ƒå’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦å…·æœ‰ç‹¬ç‰¹çš„ç¥ç§˜è‰²å½©ï¼Œæ˜¯å°è°ƒå’Œå£°å’Œæ—‹å¾‹å°è°ƒéŸ³é˜¶çš„ä»£è¡¨æ€§å’Œå¼¦ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAm(Maj7) â†’ Dm(Maj7) â†’ Gm(Maj7) â†’ Cm(Maj7) â†’ Fm(Maj7) â†’ Bâ™­m(Maj7) â†’ Eâ™­m(Maj7) â†’ Aâ™­m(Maj7) â†’ Dâ™­m(Maj7) â†’ Gâ™­m(Maj7) â†’ Bm(Maj7) â†’ Em(Maj7) â†’ å›åˆ°Am(Maj7)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 8 - 13sus4b9å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['I13sus4(b9)', 'IV13sus4(b9)', 'V13sus4(b9)', 'I13sus4(b9)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: '13sus4(b9)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»A13sus4(b9)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„åä¸‰æŒ‚ç•™å››é™ä¹å’Œå¼¦ç»ƒä¹ ã€‚è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„å»¶ä¼¸å’Œå¼¦ï¼Œç»“åˆäº†å¤šä¸ªéŸ³ç¨‹å±‚æ¬¡ï¼Œé€‚åˆé«˜çº§å’Œå£°ç»ƒä¹ ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šA13sus4(b9) â†’ D13sus4(b9) â†’ G13sus4(b9) â†’ C13sus4(b9) â†’ F13sus4(b9) â†’ Bâ™­13sus4(b9) â†’ Eâ™­13sus4(b9) â†’ Aâ™­13sus4(b9) â†’ Dâ™­13sus4(b9) â†’ Gâ™­13sus4(b9) â†’ B13sus4(b9) â†’ E13sus4(b9) â†’ å›åˆ°A13sus4(b9)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 9 - Maj7#5å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['IMaj7(#5)', 'IVMaj7(#5)', 'VMaj7(#5)', 'IMaj7(#5)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Maj7(#5)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»AMaj7(#5)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å‡äº”å¤§ä¸ƒå’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦å…·æœ‰å¢ä¸‰å’Œå¼¦çš„è‰²å½©ï¼Œé€‚åˆç»ƒä¹ è°ƒæ€§å’Œå£°çš„æ‰©å±•ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAMaj7(#5) â†’ DMaj7(#5) â†’ GMaj7(#5) â†’ CMaj7(#5) â†’ FMaj7(#5) â†’ Bâ™­Maj7(#5) â†’ Eâ™­Maj7(#5) â†’ Aâ™­Maj7(#5) â†’ Dâ™­Maj7(#5) â†’ Gâ™­Maj7(#5) â†’ BMaj7(#5) â†’ EMaj7(#5) â†’ å›åˆ°AMaj7(#5)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 10 - 7#11å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['I7(#11)', 'IV7(#11)', 'V7(#11)', 'I7(#11)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: '7#11å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»A7(#11)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å‡åä¸€éŸ³å±ä¸ƒå’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦èåˆäº†å±åŠŸèƒ½å’ŒLydianè‰²å½©ï¼Œæ˜¯ç°ä»£çˆµå£«çš„é‡è¦å’Œå£°è¯æ±‡ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šA7(#11) â†’ D7(#11) â†’ G7(#11) â†’ C7(#11) â†’ F7(#11) â†’ Bâ™­7(#11) â†’ Eâ™­7(#11) â†’ Aâ™­7(#11) â†’ Dâ™­7(#11) â†’ Gâ™­7(#11) â†’ B7(#11) â†’ E7(#11) â†’ å›åˆ°A7(#11)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 11 - Min7b5â™®9å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['Im7(b5,â™®9)', 'IVm7(b5,â™®9)', 'Vm7(b5,â™®9)', 'Im7(b5,â™®9)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: 'Min7(b5,â™®9)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»Am7(b5,â™®9)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„å°ä¸ƒé™äº”è‡ªç„¶ä¹å’Œå¼¦ç»ƒä¹ ã€‚è¿™ä¸ªå’Œå¼¦ç»“åˆäº†å‡éŸ³ç¨‹å’Œè‡ªç„¶éŸ³ï¼Œåˆ›é€ å‡ºç‹¬ç‰¹çš„å’Œå£°å¼ åŠ›ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šAm7(b5,â™®9) â†’ Dm7(b5,â™®9) â†’ Gm7(b5,â™®9) â†’ Cm7(b5,â™®9) â†’ Fm7(b5,â™®9) â†’ Bâ™­m7(b5,â™®9) â†’ Eâ™­m7(b5,â™®9) â†’ Aâ™­m7(b5,â™®9) â†’ Dâ™­m7(b5,â™®9) â†’ Gâ™­m7(b5,â™®9) â†’ Bm7(b5,â™®9) â†’ Em7(b5,â™®9) â†’ å›åˆ°Am7(b5,â™®9)ã€‚'
                        }
                    },
                    'ç»ƒä¹ 12 - 13b9å’Œå¼¦(12ä¸ªè°ƒ)': {
                        key: 'A',
                        chords: ['I13(b9)', 'IV13(b9)', 'V13(b9)', 'I13(b9)'],
                        info: {
                            composer: 'ç³»ç»Ÿç”Ÿæˆ',
                            year: '2024',
                            style: 'å’Œå¼¦å¾ªç¯ç»ƒä¹ ',
                            tempo: 'Medium',
                            description: '13(b9)å’Œå¼¦äº”åº¦åœˆå¾ªç¯ç»ƒä¹ ã€‚ä»A13(b9)å¼€å§‹ï¼ŒæŒ‰ç…§äº”åº¦åœˆå€’åºæ–¹å‘è¿›è¡Œ12ä¸ªè°ƒçš„åä¸‰é™ä¹å’Œå¼¦ç»ƒä¹ ã€‚è¿™æ˜¯ä¸€ä¸ªå¤æ‚çš„å±åŠŸèƒ½å’Œå¼¦ï¼Œç»“åˆäº†å¤šä¸ªéŸ³ç¨‹å±‚æ¬¡ï¼Œé€‚åˆé«˜çº§çˆµå£«å’Œå£°ç»ƒä¹ ã€‚',
                            details: 'äº”åº¦åœˆå€’åºè¿›è¡Œï¼šA13(b9) â†’ D13(b9) â†’ G13(b9) â†’ C13(b9) â†’ F13(b9) â†’ Bâ™­13(b9) â†’ Eâ™­13(b9) â†’ Aâ™­13(b9) â†’ Dâ™­13(b9) â†’ Gâ™­13(b9) â†’ B13(b9) â†’ E13(b9) â†’ å›åˆ°A13(b9)ã€‚'
                        }
                    }
                }
            };
            
            // å°†jazzStandardsæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.jazzStandards = jazzStandards;

            // å…ƒç´ å¼•ç”¨
            const mainScreen = document.getElementById('mainScreen');
            const practiceScreen = document.getElementById('practiceScreen');
            const targetIntervalEl = document.getElementById('targetInterval');
            const sequenceDisplayEl = document.getElementById('sequenceDisplay');
            const nextExerciseEl = document.getElementById('nextExercise');
            const startBtn = document.getElementById('startBtn');
            const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
            const rootNoteEl = document.getElementById('rootNote');
            const scaleTypeEl = document.getElementById('scaleType');
            const chordRootNoteEl = document.getElementById('chordRootNote');
            const audioInputDeviceEl = document.getElementById('audioInputDevice');
            const inputGainEl = document.getElementById('inputGain');
            const inputGainValueEl = document.getElementById('inputGainValue');
            const deviceInfoEl = document.getElementById('deviceInfo');
            const statusIndicator = document.getElementById('statusIndicator');
            const shortcutHint = document.getElementById('shortcutHint');
            const metronomeToggleEl = document.getElementById('metronomeToggle');
            const metronomeTempoEl = document.getElementById('metronomeTempo');
            const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
            const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
            const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
            const deviceSettings = document.querySelector('.device-settings');

            // é€‰é¡¹å¡å…ƒç´ 
            // const settingsTabs = document.querySelectorAll('.settings-tab'); // å·²ç§»é™¤é¡¶éƒ¨é€‰é¡¹å¡
            const scaleSettings = document.querySelector('.scale-settings');
            const chordSettings = document.querySelector('.chord-settings');
            const progressionSettings = document.querySelector('.progression-settings');

            // å’Œå¼¦ç±»å‹æŒ‰é’®
            const chordTypeBtns = document.querySelectorAll('.chord-type-btn');

            // éŸ³é¢‘è®¾å¤‡ç®¡ç†
            let audioDevices = [];
            let selectedDeviceId = 'default';
            let inputGain = 1.0;
            let gainNode = null;

            // å±å¹•å”¤é†’é”å˜é‡
            let wakeLock = null;

            // éŸ³é¢‘åˆ†æå˜é‡
            let audioContext = null;
            let analyser = null;
            let microphone = null;
            let audioWorkletNode = null;
            let javascriptNode = null;
            let isRecording = false;
            let mediaStream = null;

            // ç»ƒä¹ çŠ¶æ€
            let state = {
                score: 0,
                correctCount: 0,
                totalCount: 0,
                accuracy: 0,
                rootNote: '',
                scaleType: '',
                chordType: '',
                currentIntervals: [],
                currentSequence: [],
                currentStep: 0,
                correctPositions: [],
                isCoolingDown: false,
                cooldownTimeout: null,
                cooldownDuration: 600, // å†·å´æœŸæŒç»­æ—¶é—´(æ¯«ç§’)
                enableCooldown: true, // æ˜¯å¦å¯ç”¨å†·å´æ—¶é—´
                enableFixedDelay: false, // æ˜¯å¦å¯ç”¨å›ºå®šå»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜
                fixedDelayDuration: 800, // å›ºå®šå»¶è¿Ÿæ—¶é—´(æ¯«ç§’)
                isAnswered: false,
                timeoutId: null,
                maxFret: 12,
                previousMaxFret: 12,
                isRecording: false,
                sensitivity: 0.5,
                confidenceThreshold: 0.5,
                noiseLevel: 0.001,
                minVolume: 0.001,
                microphoneInitialized: false,
                pitchBuffer: [],
                bufferSize: 3,
                zeroCrossingThreshold: 0.1,
                harmonicWeights: [1.0, 0.8, 0.6],
                nextExerciseInfo: '',
                nextExerciseIntervals: [],
                metronomeEnabled: document.getElementById('metronomeToggle').checked,
                metronomeTempo: parseInt(document.getElementById('metronomeTempo').value),
                metronomeFlashEnabled: document.getElementById('metronomeFlashToggle').checked,
                metronomeSoundEnabled: document.getElementById('metronomeSoundToggle').checked,
                metronomeInterval: null,
                // å’Œå¼¦è½¬æ¢ç»ƒä¹ çŠ¶æ€
                isInProgressionSession: false, // æ˜¯å¦åœ¨ç»ƒä¹ ä¼šè¯ä¸­
                // è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼çŠ¶æ€
                isCustomChordMode: false, // æ˜¯å¦åœ¨è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼
                // å’Œå¼¦åæ˜¾ç¤ºæ¨¡å¼
                chordNameDisplayMode: 'english' // 'english' æˆ– 'symbols'
            };

            // åˆå§‹åŒ–ç»ƒä¹ è®¾ç½®
            const cooldownDurationEl = document.getElementById('cooldownDuration');
            if (cooldownDurationEl) {
                state.cooldownDuration = parseInt(cooldownDurationEl.value);
            }

            const enableCooldownEl = document.getElementById('enableCooldown');
            if (enableCooldownEl) {
                state.enableCooldown = enableCooldownEl.checked;
            }

            const enableFixedDelayEl = document.getElementById('enableFixedDelay');
            if (enableFixedDelayEl) {
                state.enableFixedDelay = enableFixedDelayEl.checked;
            }

            const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
            if (fixedDelayDurationEl) {
                state.fixedDelayDuration = parseInt(fixedDelayDurationEl.value);
            }

            // åˆå§‹åŒ–éŸ³é«˜æ£€æµ‹è®¾ç½®
            const sensitivityEl = document.getElementById('sensitivity');
            if (sensitivityEl) {
                state.sensitivity = parseFloat(sensitivityEl.value);
            }

            const confidenceThresholdEl = document.getElementById('confidenceThreshold');
            if (confidenceThresholdEl) {
                state.confidenceThreshold = parseFloat(confidenceThresholdEl.value);
            }
            
            // åœ¨åˆå§‹åŒ–å®ŒæˆååŠ è½½ä¿å­˜çš„è®¾ç½®ï¼ˆè¿™æ ·å¯ä»¥è¦†ç›–é»˜è®¤å€¼ï¼‰
            setTimeout(() => {
                loadSettings();
            }, 100);

            // è®¾ç½®ç®¡ç†åŠŸèƒ½
            function saveSettings() {
                const settings = {
                    // ç»ƒä¹ è®¾ç½®
                    enableCooldown: state.enableCooldown,
                    cooldownDuration: state.cooldownDuration,
                    enableFixedDelay: state.enableFixedDelay,
                    fixedDelayDuration: state.fixedDelayDuration,
                    
                    // éŸ³é«˜æ£€æµ‹è®¾ç½®
                    sensitivity: state.sensitivity,
                    confidenceThreshold: state.confidenceThreshold,
                    noiseLevel: state.noiseLevel,
                    minVolume: state.minVolume,
                    
                    // èŠ‚æ‹å™¨è®¾ç½®
                    metronomeEnabled: state.metronomeEnabled,
                    metronomeTempo: state.metronomeTempo,
                    metronomeFlashEnabled: state.metronomeFlashEnabled,
                    metronomeSoundEnabled: state.metronomeSoundEnabled,
                    
                    // éŸ³é¢‘è®¾ç½®
                    selectedDeviceId: selectedDeviceId,
                    inputGain: inputGain,
                    
                    // æ˜¾ç¤ºè®¾ç½®
                    chordNameDisplayMode: state.chordNameDisplayMode,
                    
                    // ç‰ˆæœ¬ä¿¡æ¯ï¼ˆç”¨äºå…¼å®¹æ€§æ£€æŸ¥ï¼‰
                    version: '1.0'
                };
                
                try {
                    localStorage.setItem('guitarPracticeSettings', JSON.stringify(settings));
                    console.log('è®¾ç½®å·²ä¿å­˜');
                } catch (error) {
                    console.error('ä¿å­˜è®¾ç½®å¤±è´¥:', error);
                }
            }
            
            function loadSettings() {
                try {
                    const savedSettings = localStorage.getItem('guitarPracticeSettings');
                    if (savedSettings) {
                        const settings = JSON.parse(savedSettings);
                        
                        // æ›´æ–°stateå¯¹è±¡
                        if (settings.enableCooldown !== undefined) state.enableCooldown = settings.enableCooldown;
                        if (settings.cooldownDuration !== undefined) state.cooldownDuration = settings.cooldownDuration;
                        if (settings.enableFixedDelay !== undefined) state.enableFixedDelay = settings.enableFixedDelay;
                        if (settings.fixedDelayDuration !== undefined) state.fixedDelayDuration = settings.fixedDelayDuration;
                        if (settings.sensitivity !== undefined) state.sensitivity = settings.sensitivity;
                        if (settings.confidenceThreshold !== undefined) state.confidenceThreshold = settings.confidenceThreshold;
                        if (settings.noiseLevel !== undefined) state.noiseLevel = settings.noiseLevel;
                        if (settings.minVolume !== undefined) state.minVolume = settings.minVolume;
                        if (settings.metronomeEnabled !== undefined) state.metronomeEnabled = settings.metronomeEnabled;
                        if (settings.metronomeTempo !== undefined) state.metronomeTempo = settings.metronomeTempo;
                        if (settings.metronomeFlashEnabled !== undefined) state.metronomeFlashEnabled = settings.metronomeFlashEnabled;
                        if (settings.metronomeSoundEnabled !== undefined) state.metronomeSoundEnabled = settings.metronomeSoundEnabled;
                        if (settings.selectedDeviceId !== undefined) selectedDeviceId = settings.selectedDeviceId;
                        if (settings.inputGain !== undefined) inputGain = settings.inputGain;
                        if (settings.chordNameDisplayMode !== undefined) state.chordNameDisplayMode = settings.chordNameDisplayMode;
                        
                        // æ›´æ–°ç•Œé¢å…ƒç´ 
                        updateUIFromSettings();
                        
                        console.log('è®¾ç½®å·²åŠ è½½');
                        return true;
                    }
                } catch (error) {
                    console.error('åŠ è½½è®¾ç½®å¤±è´¥:', error);
                }
                return false;
            }
            
            function updateUIFromSettings() {
                // æ›´æ–°ç»ƒä¹ è®¾ç½®
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.checked = state.enableCooldown;
                }
                
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.value = state.cooldownDuration;
                    cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                }
                
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.checked = state.enableFixedDelay;
                }
                
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.value = state.fixedDelayDuration;
                    fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                }
                
                // æ›´æ–°éŸ³é«˜æ£€æµ‹è®¾ç½®
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.value = state.sensitivity;
                    sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                }
                
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.value = state.confidenceThreshold;
                    confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                }
                
                // æ›´æ–°èŠ‚æ‹å™¨è®¾ç½®
                const metronomeToggleEl = document.getElementById('metronomeToggle');
                if (metronomeToggleEl) {
                    metronomeToggleEl.checked = state.metronomeEnabled;
                }
                
                const metronomeTempoEl = document.getElementById('metronomeTempo');
                const metronomeTempoValueEl = document.getElementById('metronomeTempoValue');
                if (metronomeTempoEl && metronomeTempoValueEl) {
                    metronomeTempoEl.value = state.metronomeTempo;
                    metronomeTempoValueEl.textContent = state.metronomeTempo;
                }
                
                // æ›´æ–°èŠ‚æ‹å™¨é€‰é¡¹è®¾ç½®
                const metronomeFlashToggleEl = document.getElementById('metronomeFlashToggle');
                if (metronomeFlashToggleEl) {
                    metronomeFlashToggleEl.checked = state.metronomeFlashEnabled;
                }
                
                const metronomeSoundToggleEl = document.getElementById('metronomeSoundToggle');
                if (metronomeSoundToggleEl) {
                    metronomeSoundToggleEl.checked = state.metronomeSoundEnabled;
                }
                
                // æ›´æ–°éŸ³é¢‘è®¾ç½®
                const audioInputDeviceEl = document.getElementById('audioInputDevice');
                if (audioInputDeviceEl && selectedDeviceId) {
                    // ç­‰å¾…è®¾å¤‡åˆ—è¡¨æ›´æ–°å®Œæˆåå†è®¾ç½®é€‰ä¸­é¡¹
                    setTimeout(() => {
                        audioInputDeviceEl.value = selectedDeviceId;
                    }, 100);
                }
                
                const inputGainEl = document.getElementById('inputGain');
                const inputGainValueEl = document.getElementById('inputGainValue');
                if (inputGainEl && inputGainValueEl) {
                    inputGainEl.value = inputGain * 100;
                    inputGainValueEl.textContent = Math.round(inputGain * 100) + '%';
                }
                
                // æ›´æ–°å’Œå¼¦åæ˜¾ç¤ºæŒ‰é’®
                const chordNameDisplayBtns = document.querySelectorAll('.chord-name-display-btn');
                chordNameDisplayBtns.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.value === state.chordNameDisplayMode) {
                        btn.classList.add('active');
                    }
                });
                
                // æ›´æ–°å’Œå¼¦ç±»å‹æŒ‰é’®çš„æ˜¾ç¤ºæ–‡æœ¬
                updateChordTypeButtonTexts();
            }
            
            function resetSettings() {
                if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿè¿™å°†æ¢å¤åˆ°é»˜è®¤å€¼ã€‚')) {
                    try {
                        localStorage.removeItem('guitarPracticeSettings');
                        
                        // é‡ç½®ä¸ºé»˜è®¤å€¼
                        state.enableCooldown = true;
                        state.cooldownDuration = 600;
                        state.enableFixedDelay = false;
                        state.fixedDelayDuration = 800;
                        state.sensitivity = 0.5;
                        state.confidenceThreshold = 0.5;
                        state.noiseLevel = 0.001;
                        state.minVolume = 0.001;
                        state.metronomeEnabled = false;
                        state.metronomeTempo = 40;
                        state.metronomeFlashEnabled = true;
                        state.metronomeSoundEnabled = true;
                        selectedDeviceId = 'default';
                        inputGain = 1.0;
                        state.chordNameDisplayMode = 'english';
                        
                        updateUIFromSettings();
                        
                        console.log('è®¾ç½®å·²é‡ç½®');
                    } catch (error) {
                        console.error('é‡ç½®è®¾ç½®å¤±è´¥:', error);
                    }
                }
            }
            async function requestWakeLock() {
                try {
                    if ('wakeLock' in navigator) {
                        wakeLock = await navigator.wakeLock.request('screen');
                        console.log('å±å¹•å”¤é†’é”å·²æ¿€æ´»');

                        wakeLock.addEventListener('release', () => {
                            console.log('å±å¹•å”¤é†’é”å·²é‡Šæ”¾');
                        });
                    }
                } catch (err) {
                    console.error(`æ— æ³•è·å–å±å¹•å”¤é†’é”: ${err.message}`);
                }
            }

            // é‡Šæ”¾å±å¹•å”¤é†’é”
            function releaseWakeLock() {
                if (wakeLock !== null) {
                    wakeLock.release();
                    wakeLock = null;
                }
            }

            // è·å–éŸ³é¢‘è®¾å¤‡åˆ—è¡¨
            async function getAudioDevices() {
                try {
                    // è¯·æ±‚æƒé™ä»¥è·å–è®¾å¤‡æ ‡ç­¾
                    await navigator.mediaDevices.getUserMedia({ audio: true });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    audioDevices = devices.filter(device => device.kind === 'audioinput');

                    updateAudioDeviceSelector();
                    checkForAudioInterfaces();
                    
                    // ä¿å­˜è®¾ç½®ä»¥ç¡®ä¿è®¾å¤‡é€‰æ‹©è¢«è®°ä½
                    saveSettings();
                } catch (error) {
                    console.error('è·å–éŸ³é¢‘è®¾å¤‡å¤±è´¥:', error);
                    deviceInfoEl.textContent = "æ— æ³•è·å–éŸ³é¢‘è®¾å¤‡åˆ—è¡¨ï¼Œè¯·ç¡®ä¿å·²æˆäºˆéº¦å…‹é£æƒé™";
                }
            }

            // æ›´æ–°è®¾å¤‡é€‰æ‹©å™¨
            function updateAudioDeviceSelector() {
                const selector = document.getElementById('audioInputDevice');
                selector.innerHTML = '<option value="default" data-i18n-key="default_device" >é»˜è®¤è®¾å¤‡</option>';

                // è®¾å¤‡åç§°æ˜ å°„è¡¨
                const deviceNameMap = {
                    'Speakerphone': 'éº¦å…‹é£',
                    'Headset earpiece': 'USBéŸ³é¢‘'
                };

                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    
                    // åº”ç”¨è®¾å¤‡åç§°æ˜ å°„
                    let displayName = device.label || `éŸ³é¢‘è®¾å¤‡ ${selector.options.length}`;
                    if (deviceNameMap[displayName]) {
                        displayName = deviceNameMap[displayName];
                    }
                    
                    // ä¸ºè®¾å¤‡é€‰é¡¹æ·»åŠ å›½é™…åŒ–æ”¯æŒ
                    option.setAttribute('data-i18n-key', 'audio_device');
                    option.setAttribute('data-i18n-args', JSON.stringify({deviceName: displayName}));
                    
                    option.textContent = displayName;
                    selector.appendChild(option);
                });

                // æ¢å¤ä¹‹å‰ä¿å­˜çš„è®¾å¤‡é€‰æ‹©
                if (selectedDeviceId && selectedDeviceId !== 'default') {
                    selector.value = selectedDeviceId;
                }

                if (audioDevices.length > 0) {
                    deviceInfoEl.setAttribute('data-i18n-key', 'device_count_detected');
                    deviceInfoEl.setAttribute('data-i18n-args', JSON.stringify({count: audioDevices.length}));
                    deviceInfoEl.textContent = `${audioDevices.length} ä¸ªéŸ³é¢‘è¾“å…¥è®¾å¤‡`;
                } else {
                    deviceInfoEl.setAttribute('data-i18n-key', 'device_count_none');
                    deviceInfoEl.textContent = "æœªæ£€æµ‹åˆ°éŸ³é¢‘è¾“å…¥è®¾å¤‡";
                }
            }

            // æ£€æµ‹æ˜¯å¦æœ‰ä¸“ä¸šéŸ³é¢‘è®¾å¤‡
            function checkForAudioInterfaces() {
                const hasProfessionalDevices = audioDevices.some(device =>
                    device.label.toLowerCase().includes('interface') ||
                    device.label.toLowerCase().includes('usb') ||
                    device.label.toLowerCase().includes('focusrite') ||
                    device.label.toLowerCase().includes('scarlett') ||
                    device.label.toLowerCase().includes('presonus') ||
                    device.label.toLowerCase().includes('behringer') ||
                    device.label.toLowerCase().includes('steinberg') ||
                    device.label.toLowerCase().includes('zoom') ||
                    device.label.toLowerCase().includes('boss') ||
                    device.label.toLowerCase().includes('line6')
                );

                if (hasProfessionalDevices) {
                    showAudioInterfaceTip();
                }
            }

            function showAudioInterfaceTip() {
                const tip = document.createElement('div');
                tip.style.cssText = `
                    position: fixed;
                    top: 70px;
                    right: 20px;
                    background: rgba(56, 189, 248, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 8px;
                    font-size: 12px;
                    z-index: 1002;
                    max-width: 250px;
                    backdrop-filter: blur(10px);
                    border: 1px solid rgba(255,255,255,0.2);
                `;
                tip.innerHTML = `
                    <strong><span class="usb-indicator"></span> USBå£°å¡å·²æ£€æµ‹</strong><br>
                    å»ºè®®é€‰æ‹©æ‚¨çš„éŸ³é¢‘æ¥å£è®¾å¤‡ä»¥è·å¾—æœ€ä½³æ•ˆæœ
                `;
                document.body.appendChild(tip);

                setTimeout(() => {
                    if (tip.parentNode) {
                        tip.parentNode.removeChild(tip);
                    }
                }, 5000);
            }

            // ä½¿ç”¨æŒ‡å®šè®¾å¤‡é‡æ–°å¯åŠ¨éŸ³é¢‘
            async function restartAudioWithNewDevice() {
                stopRecording();
                await new Promise(resolve => setTimeout(resolve, 100));
                startRecording();
            }

            // å¯åŠ¨éº¦å…‹é£å½•éŸ³ - æ”¯æŒè®¾å¤‡é€‰æ‹©
            async function startRecording() {
                if (isRecording) return;

                try {
                    const constraints = {
                        audio: {
                            deviceId: selectedDeviceId !== 'default' ?
                                { exact: selectedDeviceId } : undefined,
                            sampleRate: 48000,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false,
                            latency: 0.01
                        }
                    };

                    mediaStream = await navigator.mediaDevices.getUserMedia(constraints);

                    if (!audioContext) {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)({
                            sampleRate: 48000,
                            latencyHint: 'interactive'
                        });
                    }

                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 4096;

                    // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹ç”¨äºéŸ³é‡æ§åˆ¶
                    gainNode = audioContext.createGain();
                    gainNode.gain.value = inputGain;

                    // é»˜è®¤ä½¿ç”¨ScriptProcessorNodeï¼ˆç¨³å®šæ€§æ›´å¥½ï¼‰
                    javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                    javascriptNode.onaudioprocess = processAudio;

                    microphone = audioContext.createMediaStreamSource(mediaStream);
                    microphone.connect(gainNode);
                    gainNode.connect(analyser);
                    analyser.connect(javascriptNode);
                    javascriptNode.connect(audioContext.destination);

                    console.log('ScriptProcessorNodeåˆå§‹åŒ–æˆåŠŸ');

                    isRecording = true;
                    state.microphoneInitialized = true;
                    updateStatusIndicator('å½•éŸ³ä¸­...', 'recording');

                    console.log('éŸ³é¢‘è¾“å…¥å·²å¯åŠ¨ï¼Œè®¾å¤‡:',
                        selectedDeviceId === 'default' ? 'é»˜è®¤è®¾å¤‡' :
                            audioDevices.find(d => d.deviceId === selectedDeviceId)?.label);

                } catch (e) {
                    console.error('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:', e);
                    updateStatusIndicator('éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥', 'error');

                    // å°è¯•ä½¿ç”¨é»˜è®¤è®¾ç½®
                    if (e.name === 'OverconstrainedError') {
                        console.log('å°è¯•ä½¿ç”¨å…¼å®¹çš„éŸ³é¢‘è®¾ç½®...');
                        try {
                            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                            initializeBasicAudio();
                        } catch (fallbackError) {
                            console.error('å¤‡ç”¨éŸ³é¢‘åˆå§‹åŒ–ä¹Ÿå¤±è´¥:', fallbackError);
                        }
                    }
                }
            }

            // ç®€åŒ–çš„éŸ³é¢‘åˆå§‹åŒ–ï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
            async function initializeBasicAudio() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 4096;
                
                // å…¼å®¹æ¨¡å¼ä¹Ÿä½¿ç”¨ScriptProcessorNodeï¼ˆæœ€ç¨³å®šçš„æ–¹æ¡ˆï¼‰
                javascriptNode = audioContext.createScriptProcessor(4096, 1, 1);
                javascriptNode.onaudioprocess = processAudio;

                microphone = audioContext.createMediaStreamSource(mediaStream);
                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                console.log('å…¼å®¹æ¨¡å¼ScriptProcessorNodeåˆå§‹åŒ–æˆåŠŸ');

                isRecording = true;
                state.microphoneInitialized = true;
                updateStatusIndicator('å½•éŸ³ä¸­(å…¼å®¹æ¨¡å¼)', 'recording');
            }

            // åœæ­¢éº¦å…‹é£å½•éŸ³
            function stopRecording() {
                if (!isRecording) return;

                // æ¸…ç†AudioWorkletNode
                if (audioWorkletNode) {
                    audioWorkletNode.disconnect();
                    audioWorkletNode = null;
                }
                
                // æ¸…ç†ScriptProcessorNodeï¼ˆå…¼å®¹æ¨¡å¼ï¼‰
                if (javascriptNode) {
                    javascriptNode.disconnect();
                    javascriptNode = null;
                }
                
                if (analyser) {
                    analyser.disconnect();
                }
                if (microphone) {
                    microphone.disconnect();
                }
                if (gainNode) {
                    gainNode.disconnect();
                }

                isRecording = false;
            }

            // å®Œå…¨å…³é—­éº¦å…‹é£ï¼ˆé€€å‡ºåº”ç”¨æ—¶ä½¿ç”¨ï¼‰
            function closeMicrophone() {
                stopRecording();

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                state.microphoneInitialized = false;
            }

            // è¾…åŠ©å‡½æ•°å’Œç±»
            class MedianFilter {
                constructor(size) {
                    this.size = Math.max(1, size | 0);
                    this.buffer = [];
                }
                push(val) {
                    this.buffer.push(val == null ? null : val);
                    if (this.buffer.length > this.size) this.buffer.shift();
                    const arr = this.buffer.filter(v => v != null);
                    if (arr.length === 0) return null;
                    const sorted = arr.slice().sort((a, b) => a - b);
                    const mid = Math.floor(sorted.length / 2);
                    if (sorted.length % 2 === 1) return sorted[mid];
                    return (sorted[mid - 1] + sorted[mid]) / 2;
                }
            }

            function ema(prev, current, alpha) {
                if (prev == null) return current;
                return alpha * current + (1 - alpha) * prev;
            }

            function applyHannWindow(buf) {
                const N = buf.length;
                for (let i = 0; i < N; i++) {
                    const w = 0.5 * (1 - Math.cos((2 * Math.PI * i) / (N - 1)));
                    buf[i] *= w;
                }
            }

            function rms(buf) {
                let sum = 0;
                for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
                return Math.sqrt(sum / buf.length);
            }

            function downsampleBuffer(buffer, originalRate, targetRate) {
                if (targetRate >= originalRate) return buffer.slice(0);
                const ratio = originalRate / targetRate;
                const newLength = Math.floor(buffer.length / ratio);
                const out = new Float32Array(newLength);
                for (let i = 0; i < newLength; i++) {
                    const start = Math.floor(i * ratio);
                    const end = Math.floor((i + 1) * ratio);
                    let sum = 0;
                    for (let j = start; j < end && j < buffer.length; j++) sum += buffer[j];
                    out[i] = sum / Math.max(1, end - start);
                }
                return out;
            }

            function YINDetectorFactory(sampleRate, config) {
                config = config || {};
                const threshold = config.threshold || 0.15;
                const probabilityCliff = config.probabilityCliff || 0.1;
                return function (float32AudioBuffer) {
                    const buffer = float32AudioBuffer;
                    const N = buffer.length;
                    const halfN = Math.floor(N / 2);
                    const d = new Float32Array(halfN);
                    for (let tau = 0; tau < halfN; tau++) {
                        let sum = 0;
                        for (let i = 0; i < halfN; i++) {
                            const diff = buffer[i] - buffer[i + tau];
                            sum += diff * diff;
                        }
                        d[tau] = sum;
                    }
                    let runningSum = 0;
                    d[0] = 1;
                    for (let tau = 1; tau < halfN; tau++) {
                        runningSum += d[tau];
                        d[tau] = d[tau] * tau / runningSum;
                    }
                    let tauEstimate = -1;
                    for (let tau = 1; tau < halfN; tau++) {
                        if (d[tau] < threshold) {
                            while (tau + 1 < halfN && d[tau + 1] < d[tau]) tau++;
                            tauEstimate = tau;
                            break;
                        }
                    }
                    if (tauEstimate === -1) return null;
                    let betterTau = tauEstimate;
                    if (tauEstimate > 0 && tauEstimate < halfN - 1) {
                        const s0 = d[tauEstimate - 1], s1 = d[tauEstimate], s2 = d[tauEstimate + 1];
                        const denom = (s0 + s2 - 2 * s1);
                        if (denom !== 0) {
                            const delta = (s0 - s2) / (2 * denom);
                            betterTau = tauEstimate + delta;
                        }
                    }
                    const frequency = sampleRate / betterTau;
                    const probability = Math.max(0, Math.min(1, 1 - d[tauEstimate]));
                    if (probability < probabilityCliff) return null;
                    return { frequency, probability };
                };
            }

            // å¢å¼ºç‰ˆéŸ³é«˜æ£€æµ‹å™¨
            class EnhancedPitchDetector {
                constructor() {
                    this.bufferSize = 8; // å¢åŠ ç¼“å†²åŒºå¤§å°ï¼Œæé«˜ç¨³å®šæ€§
                    this.pitchBuffer = [];
                    this.lastStablePitch = null;
                    this.stabilityCounter = 0;
                    this.frequencyBias = { // é’ˆå¯¹ç‰¹å®šé¢‘ç‡èŒƒå›´çš„åå·®æ ¡æ­£
                        'F': 1.02,  // è½»å¾®æå‡FåŒºåŸŸçš„æ£€æµ‹å€¼
                        'Fâ™¯': 0.98  // è½»å¾®é™ä½Fâ™¯åŒºåŸŸçš„æ£€æµ‹å€¼
                    };
                }

                detect(float32AudioBuffer, sampleRate) {
                    // ä½¿ç”¨YINç®—æ³•ä½œä¸ºåŸºç¡€ï¼Œä½†é™ä½é˜ˆå€¼æé«˜çµæ•åº¦
                    const yinPitch = Pitchfinder.YIN({ threshold: 0.08 })(float32AudioBuffer);

                    // ä½¿ç”¨å¢å¼ºçš„è‡ªç›¸å…³æ£€æµ‹
                    const autocorrPitch = this.autocorrelationDetect(float32AudioBuffer, sampleRate);

                    // ç»“åˆä¸¤ç§ç®—æ³•ç»“æœï¼Œå¹¶åº”ç”¨é¢‘ç‡åå·®æ ¡æ­£
                    let finalPitch = this.combineResults(yinPitch, autocorrPitch, sampleRate);

                    // åº”ç”¨æ›´ä¸¥æ ¼çš„æ»¤æ³¢å’Œç¼“å†²
                    finalPitch = this.applyFilter(finalPitch);

                    // åº”ç”¨é¢‘ç‡åå·®æ ¡æ­£
                    finalPitch = this.applyFrequencyBias(finalPitch);

                    return finalPitch;
                }

                autocorrelationDetect(buffer, sampleRate) {
                    // å¢å¼ºç‰ˆè‡ªç›¸å…³ç®—æ³•ï¼Œç‰¹åˆ«ä¼˜åŒ–ä¸­é¢‘åŒºåŸŸæ£€æµ‹
                    const maxLag = Math.floor(sampleRate / 65);
                    const minLag = Math.floor(sampleRate / 1000);

                    let bestLag = 0;
                    let bestCorrelation = -1;

                    // ä½¿ç”¨åŠ æƒçª—å£å¢å¼ºFå’ŒFâ™¯åŒºåŸŸçš„æ£€æµ‹
                    const fFreq = 349.23;
                    const fSharpFreq = 369.99;
                    const fLag = Math.floor(sampleRate / fFreq);
                    const fSharpLag = Math.floor(sampleRate / fSharpFreq);

                    for (let lag = minLag; lag <= maxLag; lag++) {
                        let correlation = 0;

                        for (let i = 0; i < buffer.length - lag; i++) {
                            correlation += buffer[i] * buffer[i + lag];
                        }

                        correlation /= (buffer.length - lag);

                        // åº”ç”¨æ±‰å®çª—å‡å°‘è¾¹ç•Œæ•ˆåº”
                        const window = 0.5 * (1 - Math.cos(2 * Math.PI * lag / maxLag));
                        correlation *= window;

                        // å¯¹Få’ŒFâ™¯åŒºåŸŸåº”ç”¨é¢å¤–æƒé‡
                        if (Math.abs(lag - fLag) < 10 || Math.abs(lag - fSharpLag) < 10) {
                            correlation *= 1.2; // å¢å¼ºè¿™äº›åŒºåŸŸçš„ç›¸å…³æ€§
                        }

                        if (correlation > bestCorrelation) {
                            bestCorrelation = correlation;
                            bestLag = lag;
                        }
                    }

                    return bestLag > 0 ? sampleRate / bestLag : null;
                }

                combineResults(yinPitch, autocorrPitch, sampleRate) {
                    if (!yinPitch || yinPitch <= 0) return autocorrPitch;
                    if (!autocorrPitch || autocorrPitch <= 0) return yinPitch;

                    const ratio = yinPitch / autocorrPitch;

                    // æ›´ä¸¥æ ¼çš„ä¸€è‡´æ€§æ£€æŸ¥
                    if (ratio > 0.9 && ratio < 1.1) {
                        // å¦‚æœä¸¤ç§ç®—æ³•ç»“æœæ¥è¿‘ï¼Œå–åŠ æƒå¹³å‡
                        return (yinPitch * 0.6 + autocorrPitch * 0.4);
                    }

                    // å¦åˆ™é€‰æ‹©ç½®ä¿¡åº¦æ›´é«˜çš„ç»“æœ
                    const yinConfidence = this.calculateConfidence(yinPitch, sampleRate);
                    const autocorrConfidence = this.calculateConfidence(autocorrPitch, sampleRate);

                    return yinConfidence > autocorrConfidence ? yinPitch : autocorrPitch;
                }

                applyFilter(pitch) {
                    if (!pitch || pitch <= 0) return null;

                    this.pitchBuffer.push(pitch);
                    if (this.pitchBuffer.length > this.bufferSize) {
                        this.pitchBuffer.shift();
                    }

                    // ä½¿ç”¨ä¸­ä½æ•°æ»¤æ³¢è€Œä¸æ˜¯å¹³å‡å€¼ï¼Œæ›´èƒ½æŠµæŠ—å¼‚å¸¸å€¼
                    const sorted = [...this.pitchBuffer].sort((a, b) => a - b);
                    const medianPitch = sorted[Math.floor(sorted.length / 2)];

                    // å¢å¼ºç¨³å®šæ€§æ£€æµ‹
                    if (this.lastStablePitch) {
                        const ratio = medianPitch / this.lastStablePitch;
                        if (ratio > 0.97 && ratio < 1.03) { // æ›´ä¸¥æ ¼çš„ç¨³å®šæ€§æ ‡å‡†
                            this.stabilityCounter++;
                        } else {
                            this.stabilityCounter = 0;
                        }
                    }

                    if (this.stabilityCounter >= 4) { // éœ€è¦æ›´å¤šçš„è¿ç»­ç¨³å®šæ ·æœ¬
                        this.lastStablePitch = medianPitch;
                    }

                    return this.lastStablePitch || medianPitch;
                }

                applyFrequencyBias(pitch) {
                    if (!pitch) return null;

                    // å°†é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦
                    const note = this.frequencyToNoteName(pitch);

                    // åº”ç”¨ç‰¹å®šéŸ³ç¬¦çš„é¢‘ç‡åå·®æ ¡æ­£
                    if (note && this.frequencyBias[note.name]) {
                        return pitch * this.frequencyBias[note.name];
                    }

                    return pitch;
                }

                frequencyToNoteName(frequency) {
                    const A4 = 440;
                    const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];

                    const noteNum = 12 * (Math.log2(frequency / A4)) + 69;
                    const noteIndex = Math.round(noteNum) % 12;
                    const octave = Math.floor(noteNum / 12) - 1;

                    return {
                        name: noteNames[noteIndex],
                        octave: octave
                    };
                }

                calculateConfidence(pitch, sampleRate) {
                    // å¢å¼ºçš„ç½®ä¿¡åº¦è®¡ç®—ï¼Œç‰¹åˆ«å…³æ³¨Få’ŒFâ™¯åŒºåŸŸ
                    if (pitch < 65 || pitch > 1000) return 0;

                    // Få’ŒFâ™¯çš„é¢‘ç‡èŒƒå›´
                    const isInFRange = pitch >= 340 && pitch <= 380;

                    // å¯¹Få’ŒFâ™¯åŒºåŸŸç»™äºˆæ›´é«˜çš„åŸºç¡€ç½®ä¿¡åº¦
                    let confidence = isInFRange ? 1.2 : 1.0;

                    // æ ¹æ®é¢‘ç‡èŒƒå›´è°ƒæ•´ç½®ä¿¡åº¦
                    if (pitch < 100) confidence *= 0.8;
                    else if (pitch > 800) confidence *= 0.8;

                    return Math.min(1.0, confidence);
                }
            }

            // éŸ³é«˜æ£€æµ‹è¾…åŠ©å˜é‡
            const medianFilter = new MedianFilter(5);
            let smoothedFreq = null;

            // é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦åç§°å’Œå…«åº¦
            function freqToNoteInfo(freq) {
                if (!freq || freq <= 0) return null;
                const A4 = 440;
                const noteNumber = 12 * (Math.log(freq / A4) / Math.log(2)) + 69;
                const rounded = Math.round(noteNumber);
                const noteIndex = (rounded + 120) % 12;
                const octave = Math.floor(rounded / 12) - 1;
                const name = NOTE_NAMES[noteIndex] + octave;
                const cents = Math.round((noteNumber - rounded) * 100);
                return { name, cents, midi: rounded };
            }

            
            // å°†é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦åï¼ˆä¸è€ƒè™‘å…«åº¦ï¼‰
            function frequencyToNoteName(frequency) {
                // A4 = 440Hz
                const A4 = 440;
                const semitones = Math.round(12 * Math.log2(frequency / A4));
                let noteIndex = (9 + semitones) % 12;
                
                // è°ƒè¯•ä¿¡æ¯
                console.log(`é¢‘ç‡è½¬æ¢è°ƒè¯•: ${frequency}Hz -> semitones=${semitones}, noteIndex=${noteIndex}`);
                
                // ç¡®ä¿noteIndexä¸ºæ­£æ•°
                if (noteIndex < 0) {
                    noteIndex = noteIndex + 12;
                    console.log(`ä¿®æ­£è´Ÿæ•°noteIndex: ${noteIndex}`);
                }
                
                // ä½¿ç”¨å‡å·è¡¨ç¤ºæ³•ï¼Œå› ä¸ºè¿™æ˜¯æ›´å¸¸è§çš„è¡¨ç¤ºæ–¹å¼
                const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                const result = noteNames[noteIndex];
                console.log(`æœ€ç»ˆç»“æœ: noteNames[${noteIndex}] = ${result}`);
                return result;
            }
            
            // åˆ¤æ–­ä¸¤ä¸ªéŸ³ç¬¦æ˜¯å¦ç­‰ä»·ï¼ˆè€ƒè™‘å‡å·å’Œé™å·ï¼‰
            function isEquivalentNote(note1, note2) {
                if (note1 === note2) return true;
                
                // å®šä¹‰ç­‰ä»·çš„éŸ³ç¬¦å¯¹
                const equivalentPairs = [
                    ['Câ™¯', 'Dâ™­'], ['Dâ™¯', 'Eâ™­'], ['Fâ™¯', 'Gâ™­'], 
                    ['Gâ™¯', 'Aâ™­'], ['Aâ™¯', 'Bâ™­']
                ];
                
                for (const pair of equivalentPairs) {
                    if ((note1 === pair[0] && note2 === pair[1]) || 
                        (note1 === pair[1] && note2 === pair[0])) {
                        return true;
                    }
                }
                
                return false;
            }
            
            // å¤„ç†æ‰¾éŸ³ç»ƒä¹ æ­£ç¡®ç­”æ¡ˆ
            function handlePitchFindingCorrect() {
                if (state.pitchFindingAnswered) return;

                state.pitchFindingAnswered = true;
                state.pitchFindingCorrect = true;

                // åœ¨æŒ‡æ¿ä¸Šæ˜¾ç¤ºè¯¥éŸ³ç¬¦çš„æ‰€æœ‰ä½ç½®
                showNoteOnFretboard(state.currentNote);

                // è·å–ä¸‹ä¸€é¢˜é—´éš”æ—¶é—´è®¾ç½®
                const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;

                // æ£€æŸ¥æŒ‡æ¿æ˜¯å¦æ˜¾ç¤º
                const fretboardContainer = document.getElementById('fretboardContainer');
                const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';

                // åŠ¨æ€è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼š
                // - æŒ‡æ¿éšè—æ—¶ï¼šç«‹å³è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜ï¼ˆå¿½ç•¥æ‰‹åŠ¨æ¨¡å¼è®¾ç½®ï¼‰
                // - æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼ï¼šä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                // - æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´
                let delayTime;
                if (!isFretboardVisible) {
                    // æŒ‡æ¿éšè—æ—¶ç«‹å³è‡ªåŠ¨åˆ‡æ¢ï¼ˆ100msæœ€å°å»¶è¿Ÿé¿å…é—ªçƒï¼‰
                    delayTime = 100;
                    console.log(`æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿éšè—: ç«‹å³è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¢˜`);
                } else if (intervalSeconds === 0) {
                    // æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼ï¼šä¸è®¾ç½®è‡ªåŠ¨åˆ‡æ¢
                    delayTime = 0;
                    console.log(`æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼: ä¸è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¢˜ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ`);
                } else {
                    // æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´
                    delayTime = intervalSeconds * 1000;
                    console.log(`æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼: å»¶è¿Ÿ${delayTime}msåˆ‡æ¢ä¸‹ä¸€é¢˜`);
                }

                if (delayTime > 0) {
                    console.log(`æ‰¾éŸ³ç»ƒä¹ è®¾ç½®è‡ªåŠ¨å»¶è¿Ÿ: ${delayTime}ms`);
                    // è®¾ç½®è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜çš„å®šæ—¶å™¨
                    state.pitchFindingNextTimeout = setTimeout(() => {
                        generateNextPitchFindingQuestion();
                    }, delayTime);
                }
            }

            // æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸï¼Œè®©MIDIå¤„ç†å¯ä»¥è®¿é—®
            window.handlePitchFindingCorrect = handlePitchFindingCorrect;
            
            // ç”Ÿæˆä¸‹ä¸€ä¸ªæ‰¾éŸ³ç»ƒä¹ é¢˜ç›®
            function generateNextPitchFindingQuestion() {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (state.pitchFindingNextTimeout) {
                    clearTimeout(state.pitchFindingNextTimeout);
                    state.pitchFindingNextTimeout = null;
                }
                
                // é‡ç½®çŠ¶æ€
                state.pitchFindingAnswered = false;
                state.pitchFindingCorrect = false;
                
                // æ¸…é™¤æŒ‡æ¿ä¸Šçš„é«˜äº®å’ŒéŸ³ç¬¦æ˜¾ç¤º
                clearFretboardHighlights();
                
                // ç”Ÿæˆæ–°çš„éšæœºéŸ³ç¬¦
                const notes = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                const randomNote = notes[Math.floor(Math.random() * notes.length)];
                
                // æ›´æ–°æ˜¾ç¤º
                document.getElementById('currentNoteDisplay').textContent = randomNote;
                state.currentNote = randomNote;
            }
            
            // åœ¨æŒ‡æ¿ä¸Šæ˜¾ç¤ºéŸ³ç¬¦çš„æ‰€æœ‰ä½ç½®
            function showNoteOnFretboard(noteName) {
                const fretboard = document.getElementById('fretboard');
                if (!fretboard) return;
                
                const frets = fretboard.querySelectorAll('.fretboard-fret');
                
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                clearFretboardHighlights();
                
                // å‰ä»–å¼¦çš„å¼€æ”¾éŸ³ï¼ˆä»1å¼¦åˆ°6å¼¦ï¼‰
                const strings = ['E', 'B', 'G', 'D', 'A', 'E'];
                
                // è·å–é€‰æ‹©çš„æŒ‡æ¿é•¿åº¦
                const selectedRangeBtn = document.querySelector('.pitch-finding-range-btn.active');
                const maxFret = selectedRangeBtn ? parseInt(selectedRangeBtn.dataset.value) : 12;
                
                // è®¡ç®—æ¯æ ¹å¼¦ä¸Šè¯¥éŸ³ç¬¦çš„ä½ç½®
                strings.forEach((openNote, stringIndex) => {
                    const openNoteValue = noteToSemitones[openNote];
                    const targetNoteValue = noteToSemitones[noteName];
                    
                    // è®¡ç®—ä»å¼€æ”¾éŸ³åˆ°ç›®æ ‡éŸ³ç¬¦çš„åŠéŸ³æ•°
                    let semitones = (targetNoteValue - openNoteValue + 12) % 12;
                    
                    // æ£€æŸ¥æ˜¯å¦åœ¨æŒ‡æ¿èŒƒå›´å†…
                    if (semitones <= maxFret) {
                        const fretElement = frets[stringIndex * (maxFret + 1) + semitones];
                        if (fretElement) {
                            // é«˜äº®èƒŒæ™¯
                            fretElement.style.backgroundColor = '#3b82f6';
                            fretElement.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.5)';
                            
                            // æ·»åŠ éŸ³ç¬¦åç§°æ˜¾ç¤ºï¼Œå±…ä¸­å®šä½
                            const noteDisplay = document.createElement('div');
                            noteDisplay.className = 'note-display';
                            noteDisplay.textContent = noteName;
                            noteDisplay.style.cssText = `
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                                font-size: 12px;
                                color: #fff;
                                font-weight: bold;
                                z-index: 10;
                                pointer-events: none;
                            `;
                            fretElement.appendChild(noteDisplay);
                        }
                    }
                });
            }
            
            // æ¸…é™¤æŒ‡æ¿ä¸Šçš„é«˜äº®
            function clearFretboardHighlights() {
                const fretboard = document.getElementById('fretboard');
                if (!fretboard) return;
                
                const frets = fretboard.querySelectorAll('.fretboard-fret');
                
                frets.forEach(fret => {
                    fret.style.backgroundColor = '';
                    fret.style.boxShadow = '';
                    
                    // ç§»é™¤éŸ³ç¬¦æ˜¾ç¤ºå’ŒéŸ³ç¨‹æ˜¾ç¤º
                    const noteDisplay = fret.querySelector('.note-display');
                    if (noteDisplay) {
                        noteDisplay.remove();
                    }
                    
                    const intervalDisplay = fret.querySelector('.interval-display');
                    if (intervalDisplay) {
                        intervalDisplay.remove();
                    }
                });
                
                // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„fretboard-noteå…ƒç´ ï¼ˆæ—§ç‰ˆæœ¬çš„éŸ³ç¬¦æ˜¾ç¤ºï¼‰
                const existingNotes = fretboard.querySelectorAll('.fretboard-note');
                existingNotes.forEach(note => note.remove());
                
                // æ¸…é™¤CAGEDç›¸å…³å…ƒç´ ï¼ˆé‡è¦ï¼šé˜²æ­¢åœ¨éCAGEDç»ƒä¹ ä¸­æ˜¾ç¤ºï¼‰
                const fretboardContainer = document.getElementById('fretboardContainer');
                if (fretboardContainer) {
                    const cagedElements = fretboardContainer.querySelectorAll('.caged-shape-highlight, .caged-fingering');
                    if (cagedElements.length > 0) {
                        cagedElements.forEach(el => el.remove());
                        console.log('æ¸…é™¤CAGEDå…ƒç´ :', cagedElements.length, 'ä¸ª');
                    }
                }
            }

            // æ£€æŸ¥éŸ³ç¨‹åŒ¹é…çš„è¾…åŠ©å‡½æ•°
            function checkIntervalMatch(detectedNote, targetIntervalPair, rootNote) {
                // è·å–æ ¹éŸ³å€¼
                const rootValue = noteToSemitones[rootNote] || 0;
                
                // è§£æç›®æ ‡éŸ³ç¨‹å¯¹ï¼ˆå¦‚ "1 7" æˆ– "7 b13"ï¼‰
                const intervals = targetIntervalPair.split(' ');
                if (intervals.length !== 2) {
                    console.error('ç›®æ ‡éŸ³ç¨‹æ ¼å¼é”™è¯¯:', targetIntervalPair);
                    return null;
                }
                
                // è®¡ç®—ä¸¤ä¸ªéŸ³ç¨‹çš„ç›®æ ‡éŸ³ç¬¦å€¼
                const interval1Semitones = intervalToSemitones[intervals[0]] || 0;
                const interval2Semitones = intervalToSemitones[intervals[1]] || 0;
                
                const targetNote1Value = (rootValue + interval1Semitones) % 12;
                const targetNote2Value = (rootValue + interval2Semitones) % 12;
                
                // è®¡ç®—æ£€æµ‹åˆ°çš„éŸ³ç¬¦å€¼
                const detectedNoteValue = noteToSemitones[detectedNote] || 0;
                
                // æ£€æŸ¥åŒ¹é…å“ªä¸ªéŸ³ç¨‹
                let matchedInterval = null;
                if (detectedNoteValue === targetNote1Value) {
                    matchedInterval = intervals[0];
                } else if (detectedNoteValue === targetNote2Value) {
                    matchedInterval = intervals[1];
                }
                
                // è°ƒè¯•ä¿¡æ¯
                console.log(`éŸ³ç¨‹ç»ƒä¹ åŒ¹é…æ£€æŸ¥:`);
                console.log(`- æ ¹éŸ³: ${rootNote} (${rootValue})`);
                console.log(`- ç›®æ ‡éŸ³ç¨‹å¯¹: ${targetIntervalPair}`);
                console.log(`- éŸ³ç¨‹1: ${intervals[0]} -> åŠéŸ³æ•° ${interval1Semitones} -> éŸ³ç¬¦å€¼ ${targetNote1Value}`);
                console.log(`- éŸ³ç¨‹2: ${intervals[1]} -> åŠéŸ³æ•° ${interval2Semitones} -> éŸ³ç¬¦å€¼ ${targetNote2Value}`);
                console.log(`- æ£€æµ‹åˆ°çš„éŸ³ç¬¦: ${detectedNote} (${detectedNoteValue})`);
                console.log(`- åŒ¹é…çš„éŸ³ç¨‹: ${matchedInterval}`);
                
                // é¢å¤–è°ƒè¯•ï¼šæ˜¾ç¤ºç›®æ ‡éŸ³ç¬¦åç§°
                const targetNote1Name = Object.keys(noteToSemitones).find(key => noteToSemitones[key] === targetNote1Value);
                const targetNote2Name = Object.keys(noteToSemitones).find(key => noteToSemitones[key] === targetNote2Value);
                console.log(`- ç›®æ ‡éŸ³ç¬¦1: ${targetNote1Name} (${targetNote1Value})`);
                console.log(`- ç›®æ ‡éŸ³ç¬¦2: ${targetNote2Name} (${targetNote2Value})`);
                
                return matchedInterval;
            }

            // å¤„ç†éŸ³ç¨‹ç»ƒä¹ éƒ¨åˆ†æ­£ç¡®çš„å‡½æ•°ï¼ˆå¼¹å¯¹äº†å…¶ä¸­ä¸€ä¸ªéŸ³ç¨‹ï¼‰
            function handleIntervalPartialCorrect(matchedInterval) {
                if (!state.currentIntervalExercise || state.currentIntervalExercise.answered) return;
                
                // åˆå§‹åŒ–å·²å®Œæˆçš„éŸ³ç¨‹æ•°ç»„
                if (!state.currentIntervalExercise.completedIntervals) {
                    state.currentIntervalExercise.completedIntervals = [];
                }
                
                // æ£€æŸ¥è¿™ä¸ªéŸ³ç¨‹æ˜¯å¦å·²ç»å¼¹å¯¹è¿‡äº†
                if (state.currentIntervalExercise.completedIntervals.includes(matchedInterval)) {
                    console.log(`éŸ³ç¨‹ ${matchedInterval} å·²ç»å¼¹å¯¹è¿‡äº†ï¼Œå¿½ç•¥é‡å¤`);
                    return;
                }
                
                // æ·»åŠ åˆ°å·²å®Œæˆåˆ—è¡¨
                state.currentIntervalExercise.completedIntervals.push(matchedInterval);
                console.log(`éŸ³ç¨‹ ${matchedInterval} å¼¹å¯¹äº†ï¼å·²å®Œæˆ: ${state.currentIntervalExercise.completedIntervals.join(', ')}`);
                
                // æ›´æ–°æ˜¾ç¤ºï¼Œå°†å¼¹å¯¹çš„éŸ³ç¨‹å˜ç°
                updateIntervalDisplay(matchedInterval);
                
                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰éŸ³ç¨‹éƒ½å¼¹å¯¹äº†
                const intervals = state.currentIntervalExercise.currentInterval.split(' ');
                if (state.currentIntervalExercise.completedIntervals.length >= intervals.length) {
                    // æ‰€æœ‰éŸ³ç¨‹éƒ½å¼¹å¯¹äº†ï¼Œå®Œæˆè¿™é“é¢˜
                    handleIntervalFullyCorrect();
                }
            }

            // æ›´æ–°éŸ³ç¨‹æ˜¾ç¤ºï¼Œå°†å¼¹å¯¹çš„éŸ³ç¨‹å˜ç°
            function updateIntervalDisplay(completedInterval) {
                const intervalDisplay = document.getElementById('intervalExerciseDisplay');
                if (!intervalDisplay) return;
                
                // æŸ¥æ‰¾å½“å‰é¢˜ç›®æ˜¾ç¤ºå…ƒç´ å¹¶æ›´æ–°
                const currentInterval = intervalDisplay.querySelector('.current-interval');
                if (currentInterval) {
                    const intervals = state.currentIntervalExercise.currentInterval.split(' ');
                    const completedIntervals = state.currentIntervalExercise.completedIntervals || [];
                    
                    // é‡æ–°æ„å»ºå½“å‰é¢˜ç›®æ˜¾ç¤ºï¼Œå·²å®Œæˆçš„éŸ³ç¨‹ç”¨ç°è‰²æ˜¾ç¤º
                    const displayText = intervals.map(interval => {
                        if (completedIntervals.includes(interval)) {
                            return `<span style="color: #888;">${interval}</span>`;
                        } else {
                            return interval;
                        }
                    }).join(' ');
                    
                    currentInterval.innerHTML = displayText;
                }
                
                console.log(`éŸ³ç¨‹æ˜¾ç¤ºå·²æ›´æ–°ï¼Œå·²å®Œæˆ: ${state.currentIntervalExercise.completedIntervals.join(', ')}`);
            }

            // å¤„ç†éŸ³ç¨‹ç»ƒä¹ å®Œå…¨æ­£ç¡®çš„å‡½æ•°ï¼ˆæ‰€æœ‰éŸ³ç¨‹éƒ½å¼¹å¯¹äº†ï¼‰
            function handleIntervalFullyCorrect() {
                if (!state.currentIntervalExercise || state.currentIntervalExercise.answered) return;
                
                state.currentIntervalExercise.answered = true;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæŒ‡æ¿ï¼ˆæ£€æŸ¥è®¾ç½®å’Œå½“å‰çŠ¶æ€ï¼‰
                const showFretboard = document.getElementById('showFretboard').checked;
                const fretboardContainer = document.getElementById('fretboardContainer');
                const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';
                
                if (showFretboard && isFretboardVisible) {
                    // åœ¨æŒ‡æ¿ä¸Šæ˜¾ç¤ºå½“å‰é¢˜ç›®çš„ä¸¤ä¸ªéŸ³çº§
                    showIntervalOnFretboard(state.currentIntervalExercise.currentInterval, state.currentIntervalExercise.rootNote);
                }
                
                // è·å–ä¸‹ä¸€é¢˜é—´éš”æ—¶é—´
                const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;
                
                // åŠ¨æ€è®¾ç½®å»¶è¿Ÿæ—¶é—´ï¼š
                // - æŒ‡æ¿éšè—æ—¶ï¼šç«‹å³è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜ï¼ˆå¿½ç•¥æ‰‹åŠ¨æ¨¡å¼è®¾ç½®ï¼‰
                // - æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼ï¼šä¸è‡ªåŠ¨åˆ‡æ¢ï¼Œç­‰å¾…ç”¨æˆ·æ‰‹åŠ¨æ“ä½œ
                // - æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´
                let delayTime;
                if (!isFretboardVisible) {
                    // æŒ‡æ¿éšè—æ—¶ç«‹å³è‡ªåŠ¨åˆ‡æ¢ï¼ˆ100msæœ€å°å»¶è¿Ÿé¿å…é—ªçƒï¼‰
                    delayTime = 100;
                    console.log(`éŸ³ç¨‹ç»ƒä¹ æŒ‡æ¿éšè—: ç«‹å³è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¢˜`);
                } else if (intervalSeconds === 0) {
                    // æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼ï¼šä¸è®¾ç½®è‡ªåŠ¨åˆ‡æ¢
                    delayTime = 0;
                    console.log(`éŸ³ç¨‹ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼: ä¸è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¢˜ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ`);
                } else {
                    // æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´
                    delayTime = intervalSeconds * 1000;
                    console.log(`éŸ³ç¨‹ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼: å»¶è¿Ÿ${delayTime}msåˆ‡æ¢ä¸‹ä¸€é¢˜`);
                }

                if (delayTime > 0) {
                    console.log(`éŸ³ç¨‹ç»ƒä¹ è‡ªåŠ¨å»¶è¿Ÿ: æŒ‡æ¿æ˜¾ç¤º=${isFretboardVisible}, å»¶è¿Ÿæ—¶é—´=${delayTime}ms`);
                    // è®¾ç½®éŸ³ç¨‹ç»ƒä¹ å»¶è¿Ÿå®šæ—¶å™¨
                    state.intervalNextTimeout = setTimeout(() => {
                        generateNextIntervalExercise();
                    }, delayTime);
                }
            }

            // åœ¨æŒ‡æ¿ä¸Šæ˜¾ç¤ºéŸ³ç¨‹ä½ç½®çš„å‡½æ•°
            function showIntervalOnFretboard(intervalPair, rootNote) {
                const fretboard = document.getElementById('fretboard');
                if (!fretboard) return;
                
                // è§£æéŸ³ç¨‹å¯¹
                const intervals = intervalPair.split(' ');
                if (intervals.length !== 2) return;
                
                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                clearFretboardHighlights();
                
                // è·å–æ ¹éŸ³å€¼
                const rootValue = noteToSemitones[rootNote] || 0;
                
                // å‰ä»–å¼¦çš„å¼€æ”¾éŸ³ï¼ˆä»1å¼¦åˆ°6å¼¦ï¼‰
                const strings = ['E', 'B', 'G', 'D', 'A', 'E'];
                
                // è·å–é€‰æ‹©çš„æŒ‡æ¿é•¿åº¦
                const selectedRangeBtn = document.querySelector('.pitch-finding-range-btn.active');
                const maxFret = selectedRangeBtn ? parseInt(selectedRangeBtn.dataset.value) : 12;
                
                // æ˜¾ç¤ºä¸¤ä¸ªéŸ³ç¨‹åœ¨æŒ‡æ¿ä¸Šçš„ä½ç½®
                intervals.forEach(interval => {
                    const intervalSemitones = intervalToSemitones[interval] || 0;
                    const targetNoteValue = (rootValue + intervalSemitones) % 12;
                    
                    // è®¡ç®—æ¯æ ¹å¼¦ä¸Šè¯¥éŸ³ç¬¦çš„ä½ç½®
                    strings.forEach((openNote, stringIndex) => {
                        const openNoteValue = noteToSemitones[openNote];
                        
                        // è®¡ç®—ä»å¼€æ”¾éŸ³åˆ°ç›®æ ‡éŸ³ç¬¦çš„åŠéŸ³æ•°
                        let semitones = (targetNoteValue - openNoteValue + 12) % 12;
                        
                        // æ£€æŸ¥æ˜¯å¦åœ¨æŒ‡æ¿èŒƒå›´å†…
                        if (semitones <= maxFret) {
                            const frets = fretboard.querySelectorAll('.fretboard-fret');
                            const fretElement = frets[stringIndex * (maxFret + 1) + semitones];
                            if (fretElement) {
                                // é«˜äº®èƒŒæ™¯
                                fretElement.style.backgroundColor = '#3b82f6';
                                fretElement.style.boxShadow = '0 0 10px rgba(59, 130, 246, 0.5)';
                                
                                // æ·»åŠ éŸ³ç¨‹æ ‡è®°ï¼Œå±…ä¸­å®šä½
                                const intervalDisplay = document.createElement('div');
                                intervalDisplay.className = 'interval-display';
                                intervalDisplay.textContent = interval;
                                intervalDisplay.style.cssText = `
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    font-size: 12px;
                                    color: #fff;
                                    font-weight: bold;
                                    z-index: 10;
                                    pointer-events: none;
                                `;
                                fretElement.appendChild(intervalDisplay);
                            }
                        }
                    });
                });
            }

            // éŸ³ç¨‹ç»ƒä¹ çš„éŸ³é¢‘å¤„ç†å‡½æ•°
            function processIntervalAudio(inputData, sampleRate) {
                if (!state.currentIntervalExercise || state.currentIntervalExercise.answered) return;
                
                const yinResult = Pitchfinder.YIN({ threshold: 0.1, probabilityCliff: 0.1 })(inputData);
                if (!yinResult || !yinResult.frequency) return;
                
                const energy = rms(inputData);
                if (energy < 0.002) return;
                
                const detectedNote = frequencyToNoteName(yinResult.frequency);
                const exercise = state.currentIntervalExercise;
                
                console.log(`éŸ³ç¨‹ç»ƒä¹ éŸ³é¢‘å¤„ç†: é¢‘ç‡=${yinResult.frequency.toFixed(2)}Hz, æ£€æµ‹éŸ³ç¬¦=${detectedNote}, ç›®æ ‡éŸ³ç¨‹=${exercise.currentInterval}, æ ¹éŸ³=${exercise.rootNote}`);
                
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…å½“å‰éŸ³ç¨‹å¯¹ä¸­çš„æŸä¸ªéŸ³ç¨‹
                const matchedInterval = checkIntervalMatch(detectedNote, exercise.currentInterval, exercise.rootNote);
                if (matchedInterval) {
                    handleIntervalPartialCorrect(matchedInterval);
                } else {
                    console.log(`éŸ³ç¨‹ç»ƒä¹ : æœªåŒ¹é…åˆ°ä»»ä½•éŸ³ç¨‹`);
                }
                
                updatePitchDisplay(yinResult.frequency, 0, yinResult.probability);
            }

            // æ‰¾éŸ³ç»ƒä¹ çš„éŸ³é¢‘å¤„ç†å‡½æ•°
            function processPitchFindingAudio(inputData, sampleRate) {
                console.log('processPitchFindingAudio è¢«è°ƒç”¨');
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºéŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                const practiceMode = document.querySelector('.practice-mode-btn.active');
                console.log('å½“å‰ç»ƒä¹ æ¨¡å¼:', practiceMode ? practiceMode.dataset.mode : 'null');
                
                if (practiceMode && practiceMode.dataset.mode === 'interval') {
                    // éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                    console.log('è·¯ç”±åˆ°éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼');
                    processIntervalAudio(inputData, sampleRate);
                    return;
                }
                
                // å•éŸ³ç»ƒä¹ æ¨¡å¼
                console.log('å•éŸ³ç»ƒä¹ æ¨¡å¼ - pitchFindingAnswered:', state.pitchFindingAnswered);
                console.log('å½“å‰ç›®æ ‡éŸ³ç¬¦:', state.currentNote);
                
                if (state.pitchFindingAnswered) return;

                const yinResult = Pitchfinder.YIN({ threshold: 0.1, probabilityCliff: 0.1 })(inputData);
                if (!yinResult || !yinResult.frequency) {
                    console.log('YINæ£€æµ‹å¤±è´¥æˆ–æ— é¢‘ç‡');
                    return;
                }

                const energy = rms(inputData);
                if (energy < 0.002) {
                    console.log('èƒ½é‡è¿‡ä½ï¼Œå¿½ç•¥');
                    return;
                }
                
                const detectedNote = frequencyToNoteName(yinResult.frequency); // ç›´æ¥è¿”å›éŸ³ç¬¦åå­—ç¬¦ä¸²
                console.log('æ£€æµ‹åˆ°éŸ³ç¬¦:', detectedNote, '(ç±»å‹:', typeof detectedNote, ') ç›®æ ‡éŸ³ç¬¦:', state.currentNote, '(ç±»å‹:', typeof state.currentNote, ')');
                
                if (detectedNote === state.currentNote || isEquivalentNote(detectedNote, state.currentNote)) {
                    console.log('éŸ³ç¬¦åŒ¹é…ï¼è°ƒç”¨handlePitchFindingCorrect');
                    handlePitchFindingCorrect();
                } else {
                    console.log('éŸ³ç¬¦ä¸åŒ¹é…');
                }
                updatePitchDisplay(yinResult.frequency, 0, yinResult.probability);
            }

            // å¤„ç†AudioWorkletçš„éŸ³é«˜æ£€æµ‹ç»“æœ
            function handlePitchDetectionResult(event) {
                if (!isRecording || state.isAnswered || (state.enableCooldown && state.isCoolingDown)) return;

                const { type, data } = event.data;

                // å¤„ç†è°ƒè¯•ä¿¡æ¯
                if (type === 'debug') {
                    console.log('AudioWorklet Debug:', data);
                    if (data.hasSignal) {
                        console.log('AudioWorklet: æ£€æµ‹åˆ°éŸ³é¢‘ä¿¡å·ï¼ŒæŒ¯å¹…:', data.amplitude.toFixed(6));
                    } else {
                        console.log('AudioWorklet: æ— éŸ³é¢‘ä¿¡å·');
                    }
                    return;
                }

                // å¤„ç†YINç®—æ³•è°ƒè¯•ä¿¡æ¯
                if (type === 'yinDebug') {
                    console.log('YINç®—æ³•ç»“æœ:', data);
                    if (data.hasResult && data.frequency > 0) {
                        console.log(`YINæ£€æµ‹åˆ°éŸ³é«˜: ${data.frequency.toFixed(2)}Hz, éŸ³ç¬¦: ${data.detectedNote}, æ¦‚ç‡: ${data.probability.toFixed(3)}`);

                        // è®¡ç®—æ ‡å‡†éŸ³é«˜å¯¹æ¯”
                        const noteFrequencies = {
                            'C': [130.81, 261.63, 523.25],  // C3, C4, C5
                            'B': [123.47, 246.94, 493.88],  // B2, B3, B4
                        };

                        console.log(`CéŸ³æ ‡å‡†é¢‘ç‡: ${noteFrequencies.C.join('Hz, ')}Hz`);
                        console.log(`BéŸ³æ ‡å‡†é¢‘ç‡: ${noteFrequencies.B.join('Hz, ')}Hz`);

                        // è®¡ç®—åå·®
                        const closestC = noteFrequencies.C.reduce((prev, curr) =>
                            Math.abs(curr - data.frequency) < Math.abs(prev - data.frequency) ? curr : prev
                        );
                        const closestB = noteFrequencies.B.reduce((prev, curr) =>
                            Math.abs(curr - data.frequency) < Math.abs(prev - data.frequency) ? curr : prev
                        );

                        console.log(`ä¸CéŸ³åå·®: ${Math.abs(data.frequency - closestC).toFixed(2)}Hz`);
                        console.log(`ä¸BéŸ³åå·®: ${Math.abs(data.frequency - closestB).toFixed(2)}Hz`);
                    } else {
                        console.log('YINæœªæ£€æµ‹åˆ°æœ‰æ•ˆéŸ³é«˜ï¼Œé˜ˆå€¼:', data.threshold);
                    }
                    return;
                }

                // å¤„ç†ä¿¡å·è°ƒè¯•ä¿¡æ¯
                if (type === 'signalDebug') {
                    console.log(`ä¿¡å·æ£€æµ‹: RMS=${data.rms.toFixed(6)}, ${data.message}`);
                    return;
                }

                if (type === 'pitchDetected') {
                    const { frequency, probability, detectedNote, isRaw, rms } = data;

                    if (isRaw) {
                        console.log(`AudioWorkletåŸå§‹éŸ³é«˜: ${frequency.toFixed(2)}Hz (${detectedNote}), æ¦‚ç‡: ${probability.toFixed(3)}, RMS: ${(rms || 0).toFixed(4)}`);
                    } else {
                        console.log('AudioWorklet: æ£€æµ‹åˆ°éŸ³é«˜', frequency.toFixed(2) + 'Hz, æ¦‚ç‡:', probability.toFixed(3));
                    }

                    // æ ¹æ®å½“å‰ç»ƒä¹ æ¨¡å¼å¤„ç†æ£€æµ‹åˆ°çš„éŸ³é«˜
                    if (window.cagedState && window.cagedState.enabled && state.cagedMode) {
                        processCagedAudioWithFrequency(frequency, probability);
                    } else if (state.pitchFindingMode) {
                        processPitchFindingAudioWithFrequency(frequency, probability);
                    } else {
                        processRegularAudioWithFrequency(frequency, probability);
                    }
                }
            }
            
            // å¤„ç†CAGEDç»ƒä¹ æ¨¡å¼çš„éŸ³é«˜æ£€æµ‹
            function processCagedAudioWithFrequency(frequency, probability) {
                if (!window.cagedState || !window.cagedState.enabled) return;
                
                const cagedState = window.cagedState;
                const currentInterval = cagedState.currentIntervals[cagedState.currentStep];
                
                if (!currentInterval) return;
                
                // è®¡ç®—ç›®æ ‡é¢‘ç‡
                const rootValue = noteToSemitones[cagedState.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);
                
                // è®¡ç®—éŸ³åˆ†å·®
                const cents = 1200 * Math.log2(frequency / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;
                
                // åŠ¨æ€è°ƒæ•´åŒ¹é…é˜ˆå€¼
                const baseThreshold = frequency < 110 ? 35 : 15;
                const sensitivity = parseFloat(document.getElementById('sensitivity').value) || 0.5;
                const threshold = baseThreshold * (2 - sensitivity);
                
                if (adjustedCents <= threshold) {
                    // CAGEDç»ƒä¹ ç­”å¯¹
                    handleCagedCorrect();
                } else {
                    // æ˜¾ç¤ºéŸ³åˆ†å·®
                    updatePitchDisplay(frequency, adjustedCents, probability);
                }
            }
            
            // å¤„ç†éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼çš„éŸ³é«˜æ£€æµ‹
            function processPitchFindingAudioWithFrequency(frequency, probability) {
                if (!state.currentIntervalExercise) return;
                
                const exercise = state.currentIntervalExercise;
                const targetNote = exercise.targetNote;
                
                // å°†é¢‘ç‡è½¬æ¢ä¸ºéŸ³ç¬¦å
                const detectedNote = frequencyToNoteName(frequency);
                
                if (detectedNote === targetNote || isEquivalentNote(detectedNote, targetNote)) {
                    // éŸ³ç¨‹ç»ƒä¹ ç­”å¯¹
                    handleIntervalPartialCorrect(exercise.targetInterval);
                } else {
                    // æ˜¾ç¤ºå½“å‰æ£€æµ‹åˆ°çš„éŸ³ç¬¦
                    updatePitchDisplay(frequency, 0, probability);
                }
            }
            
            // å¤„ç†å¸¸è§„ç»ƒä¹ æ¨¡å¼çš„éŸ³é«˜æ£€æµ‹
            function processRegularAudioWithFrequency(frequency, probability) {
                // åŠ¨æ€è°ƒæ•´YINç®—æ³•å‚æ•° - ä½é¢‘ä½¿ç”¨æ›´é«˜çµæ•åº¦
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    if (!interval || !intervalToSemitones.hasOwnProperty(interval)) {
                        console.error(`æœªçŸ¥çš„éŸ³çº§: ${interval}`, { interval, currentSequence: state.currentSequence });
                        return false;
                    }
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110;
                });

                // åŠ¨æ€èƒ½é‡æ£€æµ‹ - ä½é¢‘ä½¿ç”¨æ›´ä½é˜ˆå€¼
                const energyThreshold = frequency < 110 ? 0.001 : 0.002;
                
                // è°æ³¢å¢å¼ºå¤„ç† - ç‰¹åˆ«é’ˆå¯¹ä½é¢‘
                let detectedFreq = frequency;
                if (detectedFreq < 110) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŸºé¢‘çš„è°æ³¢
                    const possibleFundamental = detectedFreq / 2;
                    if (Math.abs(frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }

                // æ·»åŠ é˜²æŠ¤æ£€æŸ¥
                if (!state.currentSequence || state.currentStep >= state.currentSequence.length) {
                    console.error('processRegularAudioWithFrequencyä¸­currentSequenceæˆ–currentStepæ— æ•ˆ:', {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        sequenceLength: state.currentSequence ? state.currentSequence.length : 'undefined'
                    });
                    return;
                }

                const currentInterval = state.currentSequence[state.currentStep];
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`processRegularAudioWithFrequencyä¸­æœªçŸ¥çš„éŸ³çº§: ${currentInterval}`, {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        intervalValue: currentInterval
                    });
                    return;
                }
                
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // ä¼˜åŒ–éŸ³é«˜åŒ¹é…ç®—æ³•
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // åŠ¨æ€è°ƒæ•´åŒ¹é…é˜ˆå€¼ - ä½é¢‘æ›´å®½æ¾ï¼Œå¹¶ä¸”åŸºäºæ•æ„Ÿåº¦è®¾ç½®
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                const sensitivity = parseFloat(document.getElementById('sensitivity').value) || 0.5;
                const threshold = baseThreshold * (2 - sensitivity);

                if (adjustedCents <= threshold) {
                    // éŸ³é«˜åŒ¹é…æˆåŠŸ
                    handleCorrectAnswer();
                } else {
                    // æ˜¾ç¤ºéŸ³åˆ†å·®
                    updatePitchDisplay(detectedFreq, adjustedCents, probability);
                }
            }

            // å¢å¼ºä½é¢‘æ£€æµ‹çš„éŸ³é¢‘å¤„ç†å‡½æ•°
            // ä¿®æ”¹processAudioå‡½æ•°ï¼Œåœ¨å†·å´æœŸå†…ä¸å¤„ç†éŸ³é¢‘
            function processAudio(event) {
                if (!isRecording || state.isAnswered || (state.enableCooldown && state.isCoolingDown)) return;

                const inputData = event.inputBuffer.getChannelData(0);
                const sampleRate = audioContext.sampleRate;
                
                // è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰çŠ¶æ€
                // console.log('processAudio - pitchFindingMode:', state.pitchFindingMode, 'cagedMode:', state.cagedMode);
                
                // å¦‚æœæ˜¯CAGEDç»ƒä¹ æ¨¡å¼ï¼Œä½¿ç”¨CAGEDéŸ³é¢‘å¤„ç†
                if (window.cagedState && window.cagedState.enabled && state.cagedMode) {
                    processCagedAudio(inputData, sampleRate);
                    return;
                }
                
                // å¦‚æœæ˜¯æ‰¾éŸ³ç»ƒä¹ æ¨¡å¼ï¼Œä½¿ç”¨ä¸åŒçš„å¤„ç†é€»è¾‘
                if (state.pitchFindingMode) {
                    processPitchFindingAudio(inputData, sampleRate);
                    return;
                }
                

                // åŠ¨æ€è°ƒæ•´YINç®—æ³•å‚æ•° - ä½é¢‘ä½¿ç”¨æ›´é«˜çµæ•åº¦
                const isLowFrequencyTarget = state.currentSequence.some(interval => {
                    const rootValue = noteToSemitones[state.rootNote];
                    // æ£€æŸ¥éŸ³çº§æ˜¯å¦åœ¨æ˜ å°„ä¸­å­˜åœ¨
                    if (!interval || !intervalToSemitones.hasOwnProperty(interval)) {
                        console.error(`æœªçŸ¥çš„éŸ³çº§: ${interval}`, { interval, currentSequence: state.currentSequence });
                        return false;
                    }
                    const semitone = (rootValue + intervalToSemitones[interval]) % 12;
                    const freq = 440 * Math.pow(2, (semitone - 9) / 12);
                    return freq < 110;
                });

                const yinParams = isLowFrequencyTarget ?
                    { threshold: 0.05, probabilityCliff: 0.05 } : // ä½é¢‘å‚æ•°
                    { threshold: 0.1, probabilityCliff: 0.1 };   // å¸¸è§„å‚æ•°

                const yinResult = Pitchfinder.YIN(yinParams)(inputData);

                if (!yinResult || !yinResult.frequency) return;

                // åŠ¨æ€èƒ½é‡æ£€æµ‹ - ä½é¢‘ä½¿ç”¨æ›´ä½é˜ˆå€¼
                const energy = rms(inputData);
                const energyThreshold = yinResult.frequency < 110 ? 0.001 : 0.002;
                if (energy < energyThreshold) return;

                // è°æ³¢å¢å¼ºå¤„ç† - ç‰¹åˆ«é’ˆå¯¹ä½é¢‘
                let detectedFreq = yinResult.frequency;
                if (detectedFreq < 110) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯åŸºé¢‘çš„è°æ³¢
                    const possibleFundamental = detectedFreq / 2;
                    const fundamentalResult = Pitchfinder.YIN(yinParams)(inputData);
                    if (fundamentalResult && fundamentalResult.frequency &&
                        Math.abs(fundamentalResult.frequency - possibleFundamental) < 5) {
                        detectedFreq = possibleFundamental;
                    }
                }

                // æ·»åŠ é˜²æŠ¤æ£€æŸ¥
                if (!state.currentSequence || state.currentStep >= state.currentSequence.length) {
                    console.error('processAudioä¸­currentSequenceæˆ–currentStepæ— æ•ˆ:', {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        sequenceLength: state.currentSequence ? state.currentSequence.length : 'undefined'
                    });
                    return;
                }

                const currentInterval = state.currentSequence[state.currentStep];
                // æ£€æŸ¥éŸ³çº§æ˜¯å¦åœ¨æ˜ å°„ä¸­å­˜åœ¨
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`processAudioä¸­æœªçŸ¥çš„éŸ³çº§: ${currentInterval}`, {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        intervalValue: currentInterval
                    });
                    return;
                }
                
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;

                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // ä¼˜åŒ–éŸ³é«˜åŒ¹é…ç®—æ³•
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // åŠ¨æ€è°ƒæ•´åŒ¹é…é˜ˆå€¼ - ä½é¢‘æ›´å®½æ¾ï¼Œå¹¶ä¸”åŸºäºæ•æ„Ÿåº¦è®¾ç½®
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                
                // æ ¹æ®æ•æ„Ÿåº¦è°ƒæ•´é˜ˆå€¼ - æ•æ„Ÿåº¦è¶Šé«˜ï¼Œé˜ˆå€¼è¶Šå°
                const threshold = baseThreshold * (2 - state.sensitivity);

                if (adjustedCents <= threshold && yinResult.probability > state.confidenceThreshold) {
                    handleCorrectAnswer();
                }

                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }


            // åº”ç”¨é«˜é€šæ»¤æ³¢å™¨
            function applyHighPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = RC / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = alpha * (y + buffer[i] - buffer[i - 1]);
                    buffer[i] = y;
                }
            }

            // åº”ç”¨ä½é€šæ»¤æ³¢å™¨
            function applyLowPassFilter(buffer, cutoffFreq, sampleRate) {
                const RC = 1.0 / (cutoffFreq * 2 * Math.PI);
                const dt = 1.0 / sampleRate;
                const alpha = dt / (RC + dt);

                let y = buffer[0];
                for (let i = 1; i < buffer.length; i++) {
                    y = y + alpha * (buffer[i] - y);
                    buffer[i] = y;
                }
            }

            // è®¡ç®—ä¿¡å·å¼ºåº¦ä½œä¸ºç½®ä¿¡åº¦çš„ä¼°è®¡
            function calculateSignalStrength(buffer) {
                let sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    sum += Math.abs(buffer[i]);
                }
                const average = sum / buffer.length;
                return Math.min(1.0, average * 10);
            }


            // æ£€æŸ¥æ£€æµ‹åˆ°çš„éŸ³é«˜æ˜¯å¦åŒ¹é…å½“å‰æ­¥éª¤çš„ç›®æ ‡éŸ³é«˜
            function checkPitchMatch(detectedPitch, confidence) {
                if (state.isAnswered || confidence < state.confidenceThreshold) return;

                // æ·»åŠ é˜²æŠ¤æ£€æŸ¥
                if (!state.currentSequence || state.currentStep >= state.currentSequence.length) {
                    console.error('currentSequenceæˆ–currentStepæ— æ•ˆ:', {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        sequenceLength: state.currentSequence ? state.currentSequence.length : 'undefined'
                    });
                    return;
                }

                const currentInterval = state.currentSequence[state.currentStep];
                // æ£€æŸ¥éŸ³çº§æ˜¯å¦åœ¨æ˜ å°„ä¸­å­˜åœ¨
                if (!currentInterval || !intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`æœªçŸ¥çš„éŸ³çº§: ${currentInterval}`, {
                        currentSequence: state.currentSequence,
                        currentStep: state.currentStep,
                        intervalValue: currentInterval
                    });
                    return;
                }
                
                const rootValue = noteToSemitones[state.rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const targetFrequency = 440 * Math.pow(2, (targetSemitone - 9) / 12);

                // ä¼˜åŒ–éŸ³é«˜åŒ¹é…ç®—æ³•
                const cents = 1200 * Math.log2(detectedFreq / targetFrequency);
                const centsMod = Math.abs(cents) % 1200;
                const adjustedCents = centsMod > 600 ? 1200 - centsMod : centsMod;

                // åŠ¨æ€è°ƒæ•´åŒ¹é…é˜ˆå€¼ - ä½é¢‘æ›´å®½æ¾ï¼Œå¹¶ä¸”åŸºäºæ•æ„Ÿåº¦è®¾ç½®
                const baseThreshold = detectedFreq < 110 ? 35 :
                    currentInterval === '1' ? 25 : 15;
                
                // æ ¹æ®æ•æ„Ÿåº¦è°ƒæ•´é˜ˆå€¼ - æ•æ„Ÿåº¦è¶Šé«˜ï¼Œé˜ˆå€¼è¶Šå°
                const threshold = baseThreshold * (2 - state.sensitivity);

                if (adjustedCents <= threshold && yinResult.probability > state.confidenceThreshold) {
                    handleCorrectAnswer();
                }

                updatePitchDisplay(detectedFreq, cents, yinResult.probability);
            }

            // æ›´æ–°å®æ—¶éŸ³é«˜æ˜¾ç¤º
            function updatePitchDisplay(frequency, cents, confidence) {
                const pitchDisplay = document.getElementById('pitchDisplay');
                if (!pitchDisplay) return;

                const note = frequencyToNoteName(frequency);
                const centsMod = cents % 1200;
                const adjustedCents = centsMod > 600 ? centsMod - 1200 : centsMod;
                const roundedFreq = Math.round(frequency);
                const roundedCents = Math.round(adjustedCents);
                const confidencePercent = Math.round(confidence * 100);

                if (!pitchDisplay._cache) {
                    pitchDisplay._cache = {
                        note: '',
                        octave: '',
                        freq: 0,
                        cents: 0,
                        confidence: 0,
                        inTune: false
                    };
                }

                const cache = pitchDisplay._cache;
                const inTune = Math.abs(adjustedCents) <= 20;

                if (cache.note !== note.name ||
                    cache.octave !== note.octave ||
                    cache.freq !== roundedFreq ||
                    cache.cents !== roundedCents ||
                    cache.confidence !== confidencePercent ||
                    cache.inTune !== inTune) {

                    cache.note = note.name;
                    cache.octave = note.octave;
                    cache.freq = roundedFreq;
                    cache.cents = roundedCents;
                    cache.confidence = confidencePercent;
                    cache.inTune = inTune;

                    const children = pitchDisplay.children;

                    if (children.length < 3) {
                        pitchDisplay.innerHTML = `
                            <div>éŸ³é«˜: ${note.name}${note.octave} (${roundedFreq}Hz)</div>
                            <div>éŸ³åˆ†å·®: ${adjustedCents > 0 ? '+' : ''}${roundedCents}</div>
                            <div class="confidence-bar">
                                <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                            </div>
                        `;
                    } else {
                        children[0].textContent = `éŸ³é«˜: ${note.name}${note.octave} (${roundedFreq}Hz)`;
                        children[1].textContent = `éŸ³åˆ†å·®: ${adjustedCents > 0 ? '+' : ''}${roundedCents}`;
                        children[2].querySelector('.confidence-fill').style.width = `${confidencePercent}%`;
                    }

                    pitchDisplay.classList.toggle('in-tune', inTune);
                    pitchDisplay.classList.toggle('out-of-tune', !inTune);
                }
            }

            // ä¼˜åŒ–åçš„æ­£ç¡®ç­”æ¡ˆå¤„ç†
            function handleCorrectAnswer() {
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;

                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }

                requestAnimationFrame(() => {
                    if (state.currentStep >= state.currentSequence.length) {
                        state.isAnswered = true;

                        // æ ¹æ®è®¾ç½®å†³å®šæ˜¯å¦è¿›å…¥å†·å´æœŸ
                        if (state.enableCooldown) {
                            state.isCoolingDown = true;
                            if (state.cooldownTimeout) {
                                clearTimeout(state.cooldownTimeout);
                            }
                            state.cooldownTimeout = setTimeout(() => {
                                state.isCoolingDown = false;
                            }, state.cooldownDuration);
                        }

                        // æ ¹æ®è®¾ç½®å†³å®šå»¶è¿Ÿæ—¶é—´
                        let delayTime = 0; // é»˜è®¤æ— å»¶è¿Ÿ
                        if (state.enableFixedDelay) {
                            delayTime = state.fixedDelayDuration;
                        }

                        // å»¶è¿Ÿç”Ÿæˆä¸‹ä¸€é¢˜ï¼Œç»™ç”¨æˆ·åœæ­¢å¼¹å¥çš„æ—¶é—´
                        setTimeout(() => {
                            generateExercise();
                        }, delayTime);
                    } else {
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                    }
                });
            }

            // é€šç”¨å‡½æ•°ï¼šé‡ç½®CAGEDæ¨¡å¼çŠ¶æ€
            function resetCagedModeState() {
                state.cagedMode = false;
                
                // éšè—CAGEDå½¢çŠ¶æ˜¾ç¤ºåŒºåŸŸ
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'none';
                }
            }

            // é¢„ç”Ÿæˆä¸‹ä¸€ä¸ªç»ƒä¹ 
            function generateNextExercise() {
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;

                if (activeTab === 'scale') {
                    let rootNote = rootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }

                    let scaleType = 'random'; // åœ¨å¤šé€‰æ¨¡å¼ä¸‹ï¼Œæ€»æ˜¯ä½¿ç”¨éšæœºé€‰æ‹©
                    // ä½¿ç”¨å¤šé€‰è°ƒå¼é€‰æ‹©å™¨çš„éšæœºåŠŸèƒ½
                    scaleType = window.getRandomSelectedScaleType ?
                        window.getRandomSelectedScaleType() :
                        (function() {
                            const types = Object.keys(scaleTypes);
                            return types[Math.floor(Math.random() * types.length)];
                        })();

                    // ä¿å­˜é¢„é€‰çš„è°ƒå¼ï¼Œç¡®ä¿å®é™…ç”Ÿæˆä¸‹ä¸€é¢˜æ—¶ä½¿ç”¨ç›¸åŒçš„è°ƒå¼
                    state.nextScaleType = scaleType;
                    state.nextRootNote = rootNote;

                    // è·å–æ–¹å‘
                    const activeOrderBtn = document.querySelector('.scale-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                    // è·å–æ—‹å¾‹æ¨¡è¿›ç±»å‹
                    const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                    let arpeggioType = '1to1';
                    
                    for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                      if (arpeggioTypeButtons[i].classList.contains('active')) {
                        arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                        break;
                      }
                    }

                    // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒï¼šæ ¹æ®æ–¹å‘é€‰æ‹©ä¸Šè¡Œæˆ–ä¸‹è¡Œå½¢å¼
                    let intervals;
                    let isMelodicMinorDescending = false;
                    if (scaleType === 'melodicMinor' && order === 'reverse') {
                        // ä¸‹è¡Œæ—‹å¾‹å°è°ƒ
                        intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                        isMelodicMinorDescending = true;
                    } else {
                        // é»˜è®¤ä½¿ç”¨ä¸Šè¡Œå½¢å¼
                        intervals = [...scaleTypes[scaleType].intervals];
                    }
                    state.currentIntervals = intervals;
                    let startEndInterval = '1'; // é»˜è®¤ä½¿ç”¨1ä½œä¸ºé¦–å°¾éŸ³
                    
                    // æ ¹æ®ç»ƒä¹ åºåˆ—ç±»å‹ç¡®å®šé¦–å°¾éŸ³
                    if (arpeggioType === 'random-arpeggio') {
                        // éšæœºé€‰æ‹©1ã€3ã€5ã€7éŸ³ä½œä¸ºé¦–å°¾éŸ³ï¼Œä½†åªåŒ…å«éŸ³é˜¶ä¸­å®é™…å­˜åœ¨çš„éŸ³ç¨‹
                        const availableChordTones = [];
                        const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                        if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                        const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                        if (fifthInterval) availableChordTones.push(fifthInterval);
                        const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                        if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                        
                        // å¦‚æœæœ‰å¯ç”¨çš„3/5/7åº¦éŸ³ç¨‹ï¼Œåˆ™ä»ä¸­éšæœºé€‰æ‹©
                        if (availableChordTones.length > 0) {
                            startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                        } else {
                            startEndInterval = '1'; // å›é€€åˆ°æ ¹éŸ³
                        }
                    } else if (arpeggioType === '3to3') {
                        // ä½¿ç”¨3éŸ³ä½œä¸ºé¦–å°¾éŸ³
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    } else if (arpeggioType === '5to5') {
                        // ä½¿ç”¨5éŸ³ä½œä¸ºé¦–å°¾éŸ³
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    } else if (arpeggioType === '7to7') {
                        // ä½¿ç”¨7éŸ³ä½œä¸ºé¦–å°¾éŸ³
                        startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                        // å¤„ç†å…¶ä»–ç‰¹å®šéŸ³ç¨‹ä½œä¸ºé¦–å°¾éŸ³çš„æƒ…å†µï¼ˆå¦‚â™¯6â†’â™¯6ï¼‰
                        // arpeggioTypeæ ¼å¼ä¸º"xtox"ï¼Œæå–xéƒ¨åˆ†
                        const match = arpeggioType.match(/^(.+)to\1$/);
                        if (match) {
                            const intervalType = match[1];
                            console.log('å¤„ç†ç‰¹å®šéŸ³ç¨‹:', intervalType, 'åœ¨éŸ³é˜¶ä¸­:', state.currentIntervals);
                            // æŸ¥æ‰¾éŸ³é˜¶ä¸­å¯¹åº”çš„éŸ³ç¨‹
                            const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                            console.log('æ‰¾åˆ°çš„å®Œæ•´éŸ³ç¨‹:', completeInterval);
                            if (completeInterval) {
                                startEndInterval = completeInterval;
                            } else {
                                const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                                console.log('æ‰¾åˆ°çš„æœ€è¿‘éŸ³ç¨‹:', nearestInterval);
                                startEndInterval = nearestInterval || intervalType;
                            }
                            console.log('æœ€ç»ˆé¦–å°¾éŸ³:', startEndInterval);
                        }
                    }

                    // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒä¸‹è¡Œï¼šç›´æ¥ä½¿ç”¨é¢„å®šä¹‰çš„åºåˆ—ï¼Œä¸è¿›è¡Œé¢å¤–å¤„ç†
                    if (!isMelodicMinorDescending) {
                        if (order === 'reverse') {
                            // å€’åºæ¨¡å¼
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åå€’åºï¼Œæœ€åæ·»åŠ é¦–å°¾éŸ³
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                    const middleIntervals = state.currentIntervals.slice(1).reverse();
                                    state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // ä¿æŒåŸæœ‰çš„å€’åºé€»è¾‘
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else if (order === 'random') {
                            // éšæœºæ¨¡å¼
                            if (arpeggioType === 'random-arpeggio') {
                                // å¯¹äºéšæœºå’Œå¼¦ç±»å‹ï¼Œæ•´ä¸ªåºåˆ—éƒ½åº”è¯¥åªåŒ…å«å’Œå¼¦éŸ³ï¼ˆ1ã€3ã€5ã€7åº¦éŸ³ç¨‹ï¼‰
                                // æ”¶é›†æ‰€æœ‰å®é™…å­˜åœ¨çš„3/5/7åº¦éŸ³ç¨‹
                                const availableChordTones = [];
                                const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                                if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                                const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                                if (fifthInterval) availableChordTones.push(fifthInterval);
                                const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                                if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                                
                                // å¦‚æœæ‰¾ä¸åˆ°è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œå›é€€åˆ°ä½¿ç”¨é¦–å°¾éŸ³
                                if (availableChordTones.length > 0) {
                                    // éšæœºæ‰“ä¹±å’Œå¼¦éŸ³
                                    const shuffledChordTones = [...availableChordTones];
                                    for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                    }
                                    
                                    // ä»æ‰¾åˆ°çš„å’Œå¼¦éŸ³ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸ºé¦–å°¾éŸ³
                                    startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                    
                                    // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿åŒ…å«é¦–å°¾éŸ³
                                    state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                                } else {
                                    // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œä½¿ç”¨æ ¹éŸ³ä½œä¸ºæ•´ä¸ªåºåˆ—
                                    state.currentIntervals = ['1', '1'];
                                }
                            } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                                // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // æå–é™¤äº†é¦–å°¾éŸ³ä¹‹å¤–çš„æ‰€æœ‰éŸ³
                                    const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                    
                                    // éšæœºæ‰“ä¹±
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    
                                    // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿é¦–å°¾éƒ½æ˜¯æŒ‡å®šçš„éŸ³
                                    state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                    const otherIntervals = state.currentIntervals.slice(1);
                                    for (let i = otherIntervals.length - 1; i > 0; i--) {
                                        const j = Math.floor(Math.random() * (i + 1));
                                        [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                    }
                                    state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                                }
                            } else {
                                // ä¿æŒåŸæœ‰çš„éšæœºé€»è¾‘
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // é¡ºåºæ¨¡å¼
                            if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                                // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                                const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                                
                                if (startEndIndex !== -1) {
                                    // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åæ·»åŠ é¦–å°¾éŸ³
                                    const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                    state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                                } else {
                                    // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                    state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                                }
                            } else {
                                // ä¿æŒåŸæœ‰çš„é¡ºåºé€»è¾‘
                                state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                            }
                        }
                    }

                    state.nextExerciseInfo = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                    // ä¿®å¤ï¼šä½¿ç”¨å¤„ç†åçš„state.currentIntervalsè€Œä¸æ˜¯åŸå§‹çš„intervals
                    state.nextExerciseIntervals = [...state.currentIntervals];
                } else if (activeTab === 'progression') {
                    // å’Œå¼¦è½¬æ¢ç»ƒä¹ é¢„ç”Ÿæˆä¸‹ä¸€é¢˜ï¼ˆä½¿ç”¨å·²å­˜å‚¨çš„å’Œå¼¦è¿›è¡Œå’Œç´¢å¼•ï¼‰
                    if (state.progressionChords && state.progressionIndex !== undefined) {
                        const chords = state.progressionChords;
                        const enableRepeatEl = document.getElementById('enableRepeat');
                        const progressionLevelEl = document.getElementById('progressionLevel');
                        
                        // è·å–ä¸‹ä¸€ä¸ªå’Œå¼¦çš„ç´¢å¼•
                        let nextIndex = state.progressionIndex;
                        
                        // æ£€æŸ¥æ˜¯å¦è¶…å‡ºå’Œå¼¦æ•°é‡
                        if (nextIndex >= chords.length) {
                            const isRepeatEnabled = enableRepeatEl.checked;
                            if (isRepeatEnabled) {
                                nextIndex = 0; // é‡æ–°å¼€å§‹
                            } else {
                                state.nextExerciseInfo = 'ç»ƒä¹ å®Œæˆ';
                                state.nextExerciseIntervals = [];
                                return;
                            }
                        }
                        
                        if (nextIndex < chords.length) {
                            const nextChord = chords[nextIndex];
                            const level = progressionLevelEl.value;
                            
                            // è§£æä¸‹ä¸€ä¸ªå’Œå¼¦çš„ç±»å‹
                            const { root: nextRoot, type: nextType } = parseChordSymbol(nextChord);
                            
                            let intervals = getIntervalsForLevel(level, nextType);
                            
                            state.nextExerciseInfo = nextChord; // åªæ˜¾ç¤ºå’Œå¼¦å
                            state.nextExerciseIntervals = intervals;
                        }
                    }
                } else {
                    // å’Œå¼¦ç»ƒä¹ é¢„ç”Ÿæˆä¸‹ä¸€é¢˜
                    // å¦‚æœæ˜¯è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼ï¼Œç›´æ¥ä»è‡ªå®šä¹‰å’Œå¼¦åºåˆ—ä¸­è·å–ä¸‹ä¸€ä¸ªå’Œå¼¦
                    if (state.isCustomChordMode && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            const bass = item.querySelector('.remove-chord').dataset.bass || 'root';
                            return { root, type, bass };
                        });

                        const currentIndex = state.customChordIndex !== undefined ? state.customChordIndex : 0;
                        const nextIndex = (currentIndex + 1) % chords.length;
                        const nextChord = chords[nextIndex];

                        // åº”ç”¨è½¬ä½è®¾ç½®
                        let intervals = [...chordTypes[nextChord.type].intervals];
                        if (nextChord.bass && nextChord.bass !== 'root') {
                            intervals = applyChordInversion(intervals, nextChord.bass);
                        }
                        
                        state.nextExerciseInfo = getInversionChordName(nextChord.root, nextChord.type, nextChord.bass || 'root');
                        state.nextExerciseIntervals = intervals;
                    } else {
                        // å¸¸è§„å’Œå¼¦æ¨¡å¼ - å®æ—¶è·å–å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹
                        let rootNote = chordRootNoteEl.value;
                        if (rootNote === 'random') {
                            const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                            rootNote = notes[Math.floor(Math.random() * notes.length)];
                        }

                        // å®æ—¶è·å–å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹ï¼ˆä¸ä½¿ç”¨ç¼“å­˜ï¼‰
                        const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                        let chordType = 'major';
                        if (activeChordTypes.length > 0) {
                            const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                            chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                        } else {
                            // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œä¸ç”Ÿæˆé»˜è®¤å’Œå¼¦ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç©ºå€¼
                            console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œæ— æ³•ç”Ÿæˆç»ƒä¹ ');
                            return; // ä¸ç”Ÿæˆç»ƒä¹ 
                        }

                        const activeOrderBtn = document.querySelector('.chord-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';

                        let intervals = [...chordTypes[chordType].intervals];
                        
                        // å¤„ç†è½¬ä½å’Œå¼¦
                        const bassNoteSelect = document.getElementById('chordBassNote');
                        if (bassNoteSelect) {
                            const bassNote = bassNoteSelect.value;
                            if (bassNote !== 'root') {
                                intervals = applyChordInversion(intervals, bassNote);
                            }
                        }
                        
                        if (order === 'reverse') {
                            // ä¸‹è¡Œæ¨¡å¼ï¼šå€’åºæ’åˆ—
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }

                        // è·å–è½¬ä½å’Œå¼¦åç§°
                        const bassNote = bassNoteSelect ? bassNoteSelect.value : 'root';
                        const chordSymbol = getInversionChordName(rootNote, chordType, bassNote);
                        state.nextExerciseInfo = chordSymbol;
                        state.nextExerciseIntervals = intervals;
                    }
                }

                updateNextExerciseDisplay();
            }
            function requestRecordPermission() {
                // ä½¿ç”¨æ ‡å‡†Web APIè¯·æ±‚åª’ä½“æƒé™
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function(stream) {
                            // ç”¨æˆ·å·²æˆæƒï¼Œå¯ä»¥å¼€å§‹å½•éŸ³
                            console.log('å½•éŸ³æƒé™å·²è·å–');
                            // è°ƒç”¨ä½ çš„å¼€å§‹å½•éŸ³é€»è¾‘
                            // startRecording();
                            
                            // åœæ­¢ä¸´æ—¶æµï¼Œå› ä¸ºæˆ‘ä»¬åªæ˜¯åœ¨æ£€æŸ¥æƒé™
                            stream.getTracks().forEach(track => track.stop());
                        })
                        .catch(function(err) {
                            console.error('è·å–å½•éŸ³æƒé™å¤±è´¥:', err);
                            if (err.name === 'NotAllowedError') {
                                console.log('ç”¨æˆ·æ‹’ç»æˆæƒ');
                            } else if (err.name === 'NotFoundError') {
                                console.log('æœªæ‰¾åˆ°å½•éŸ³è®¾å¤‡');
                            } else {
                                console.log('æƒé™ç”³è¯·é”™è¯¯');
                            }
                        });
                } else {
                    console.warn('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒåª’ä½“è®¾å¤‡API');
                }
            }
            // æ›´æ–°ä¸‹ä¸€ä¸ªç»ƒä¹ æ˜¾ç¤º
            function updateNextExerciseDisplay() {
                if (state.nextExerciseInfo) {
                    // æ˜¾ç¤ºè°ƒæ€§å’ŒéŸ³é˜¶å/å’Œå¼¦åä»¥åŠéŸ³çº§ç»“æ„
                    let displayHTML = state.nextExerciseInfo;
                    if (state.nextExerciseIntervals && state.nextExerciseIntervals.length > 0) {
                        displayHTML += '<br><span style="font-size: 14px; color: #94a3b8;">' + state.nextExerciseIntervals.join(' ') + '</span>';
                    }
                    nextExerciseEl.innerHTML = displayHTML;
                } else {
                    nextExerciseEl.innerHTML = '-';
                }
            }

            // ä¼˜åŒ–åçš„ç»ƒä¹ ç”Ÿæˆå‡½æ•°
            // ä¿®æ”¹generateExerciseå‡½æ•°ï¼Œé‡ç½®å†·å´æœŸçŠ¶æ€
            function generateExercise() {
                console.log('generateExerciseå¼€å§‹ - å½“å‰çŠ¶æ€:', {
                    currentIntervals: state.currentIntervals,
                    currentSequence: state.currentSequence,
                    rootNote: state.rootNote,
                    scaleType: state.scaleType,
                    chordType: state.chordType
                });
                
                // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œç¡®ä¿ä»å½“å‰è®¾ç½®ç”Ÿæˆ
                state.nextExerciseInfo = '';
                state.nextExerciseIntervals = [];
                state.chordType = ''; // æ¸…é™¤ä¹‹å‰çš„å’Œå¼¦ç±»å‹

                // æ¸…é™¤é¢„é€‰çš„è°ƒå¼å’Œæ ¹éŸ³ï¼Œç¡®ä¿æ–°ä¸€è½®ç»ƒä¹ é‡æ–°éšæœºé€‰æ‹©
                state.nextScaleType = null;
                state.nextRootNote = null;
                
                // æ¸…ç†sequence-itemçš„CSSçŠ¶æ€
                const sequenceItems = document.querySelectorAll('.sequence-item');
                sequenceItems.forEach(item => {
                    item.classList.remove('current');
                    // åªæ¸…ç†å¯èƒ½å½±å“å¸ƒå±€çš„å±æ€§ï¼Œä¿ç•™å¿…è¦çš„flexå¸ƒå±€å±æ€§
                    item.style.width = '';
                    item.style.maxWidth = '';
                    item.style.transform = '';
                });
                
                // ç¡®ä¿sequenceDisplayä½¿ç”¨æ­£ç¡®çš„displayå±æ€§
                document.getElementById('sequenceDisplay').style.display = 'flex';
                
                // è·å–å½“å‰æ´»åŠ¨æ ‡ç­¾é¡µ
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                console.log('å½“å‰æ´»è·ƒæ ‡ç­¾é¡µ:', activeTab);
                
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                
                // åªåœ¨å’Œå¼¦è½¬æ¢ç»ƒä¹ æ—¶æ˜¾ç¤ºä¹æ›²åï¼Œå…¶ä»–æƒ…å†µä¸‹éšè—
                if (activeTab === 'progression') {
                    songTitleDisplayEl.style.display = 'block';
                } else {
                    songTitleDisplayEl.style.display = 'none';
                }
                
                state.pitchBuffer = [];
                state.isAnswered = false;
                state.currentStep = 0;

                // é‡ç½®å†·å´æœŸçŠ¶æ€
                if (state.enableCooldown) {
                    state.isCoolingDown = false;
                    if (state.cooldownTimeout) {
                        clearTimeout(state.cooldownTimeout);
                        state.cooldownTimeout = null;
                    }
                }

                // ç›´æ¥ç”Ÿæˆæ–°ç»ƒä¹ ï¼Œä¸ä½¿ç”¨é¢„åŠ è½½æ•°æ®
                    if (activeTab === 'scale') {
                        if (window.cagedState && window.cagedState.enabled) {
                            console.log('è°ƒç”¨generateCagedExercise - CAGEDæ¨¡å¼å¯ç”¨');
                            generateCagedExercise();
                        } else {
                            console.log('è°ƒç”¨generateScaleExercise - æ™®é€šéŸ³é˜¶æ¨¡å¼');
                            generateScaleExercise();
                        }
                    } else if (activeTab === 'chord') {
                        console.log('è°ƒç”¨generateChordExercise - å’Œå¼¦æ¨¡å¼');
                        generateChordExercise();
                    } else if (activeTab === 'progression') {
                        console.log('è°ƒç”¨generateProgressionExercise - å’Œå¼¦è¿›è¡Œæ¨¡å¼');
                        generateProgressionExercise();
                } else if (activeTab === 'pitch-finding') {
                    console.log('è°ƒç”¨generatePitchFindingExercise - æ‰¾éŸ³æ¨¡å¼');
                    generatePitchFindingExercise();
                    }

                    // ç«‹å³é¢„åŠ è½½ä¸‹ä¸€é¢˜ï¼ˆå¦‚æœåœ¨generateChordExerciseä¸­æ²¡æœ‰è°ƒç”¨ï¼‰
                    if (!state.nextExerciseInfo) {
                        generateNextExercise();
                    }
                }


            // ç”ŸæˆCAGEDç»ƒä¹ 
            function generateCagedExercise() {
                if (!window.cagedState || !window.cagedState.enabled) {
                    generateScaleExercise();
                    return;
                }

                if (!window.cagedSystem || !window.cagedSystem.shapes) {
                    console.error('CAGEDç³»ç»Ÿæ•°æ®æœªæ­£ç¡®åŠ è½½');
                    return;
                }
                
                // éšè—ä¹æ›²åæ˜¾ç¤º
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                if (songTitleDisplayEl) {
                    songTitleDisplayEl.style.display = 'none';
                }

                // å¦‚æœä¸æ˜¯æ‰‹åŠ¨åˆ‡æ¢ä¸”æ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆç»ƒä¹ ï¼Œé‡ç½®è½®æ¬¡çŠ¶æ€
                if (!window.cagedState.isManualSwitch && 
                    (!window.cagedState.currentScaleType || !window.cagedState.currentRootNote)) {
                    window.cagedState.completedShapesInCurrentRound = [];
                    window.cagedState.isNewRound = true;
                    console.log('å¼€å§‹æ–°çš„CAGEDç»ƒä¹ ï¼Œé‡ç½®è½®æ¬¡çŠ¶æ€');
                }

                // æ ¹æ®ç»ƒä¹ æ¨¡å¼ç”Ÿæˆç»ƒä¹ 
                switch (window.cagedState.practiceMode) {
                    case 'connection':
                        generateShapeConnectionExercise();
                        break;
                    case 'random':
                        generateRandomShapeExercise();
                        break;
                    default:
                        generateShapeConnectionExercise();
                }
            }

            // å•ä¸ªå½¢çŠ¶ç»ƒä¹ 
            function generateSingleShapeExercise() {
                // é‡ç½®ç»ƒä¹ çŠ¶æ€
                state.currentStep = 0;
                state.isAnswered = false;
                
                // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
                displayCagedShapeSelection();
                
                // è·å–å½“å‰å½¢çŠ¶
                const shape = window.cagedSystem.shapes[window.cagedState.currentShape];
                
                // ä½¿ç”¨Scale Settingsä¸­çš„æ ¹éŸ³è®¾ç½®
                let key = rootNoteEl.value;
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰æ ¹éŸ³å’ŒéŸ³é˜¶ç±»å‹
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    // ä¿æŒå½“å‰æ ¹éŸ³å’ŒéŸ³é˜¶ç±»å‹
                    key = window.cagedState.currentRootNote || key;
                    console.log('ä¿æŒå½“å‰æ ¹éŸ³:', key);
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©æ ¹éŸ³
                    if (key === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        key = notes[Math.floor(Math.random() * notes.length)];
                    }
                    window.cagedState.currentRootNote = key;
                    console.log('æ–°ä¸€è½®ç»ƒä¹  - é€‰æ‹©æ ¹éŸ³:', key);
                }
                
                // æ›´æ–°CAGEDçŠ¶æ€ä¸­çš„è°ƒæ€§ï¼ˆä¿æŒåŒæ­¥ï¼‰
                window.cagedState.currentKey = key;
                
                // ä½¿ç”¨Scale Settingsä¸­çš„éŸ³é˜¶ç±»å‹
                let scaleType = scaleTypeEl.value;
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰éŸ³é˜¶ç±»å‹
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    if (window.cagedState.currentScaleType) {
                        scaleType = window.cagedState.currentScaleType;
                        console.log('ä¿æŒå½“å‰éŸ³é˜¶ç±»å‹:', scaleType);
                    }
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©éŸ³é˜¶ç±»å‹
                    if (scaleType === 'random') {
                        scaleType = window.getRandomSelectedScaleType ?
                            window.getRandomSelectedScaleType() :
                            (function() {
                                const types = Object.keys(scaleTypes);
                                return types[Math.floor(Math.random() * types.length)];
                            })();
                        console.log('æ–°ä¸€è½®ç»ƒä¹  - éšæœºé€‰æ‹©éŸ³é˜¶ç±»å‹:', scaleType);
                    }
                    window.cagedState.currentScaleType = scaleType;
                }
                
                // æ ‡è®°ä¸å†æ˜¯æ–°ä¸€è½®
                window.cagedState.isNewRound = false;
                
                // æ›´æ–°ç›®æ ‡éŸ³ç¨‹æ˜¾ç¤º
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                
                // ç”ŸæˆCAGEDéŸ³é˜¶åºåˆ—ï¼ˆä½¿ç”¨é€‰æ‹©çš„éŸ³é˜¶ç±»å‹ï¼‰
                state.currentIntervals = [...scaleTypes[scaleType].intervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedState.currentShape;
                state.cagedKey = window.cagedState.currentKey;
                state.cagedPracticeType = window.cagedState.practiceType;
                state.scaleType = scaleType;
                
                displaySequence();
                
                // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
                generateCagedNextExercise();
                
            }

            // å½¢çŠ¶è¿æ¥ç»ƒä¹ 
            function generateShapeConnectionExercise() {
                // é‡ç½®ç»ƒä¹ çŠ¶æ€
                state.currentStep = 0;
                state.isAnswered = false;
                
                // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
                displayCagedShapeSelection();
                
                // è·å–å½“å‰å½¢çŠ¶å’Œä¸‹ä¸€ä¸ªå½¢çŠ¶
                const currentShape = window.cagedSystem.shapes[window.cagedState.currentShape];
                const nextShape = getNextShape();
                
                // ä½¿ç”¨Scale Settingsä¸­çš„æ ¹éŸ³è®¾ç½®
                let key = rootNoteEl.value;
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰æ ¹éŸ³å’ŒéŸ³é˜¶ç±»å‹
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    // ä¿æŒå½“å‰æ ¹éŸ³å’ŒéŸ³é˜¶ç±»å‹
                    key = window.cagedState.currentRootNote || key;
                    console.log('ä¿æŒå½“å‰æ ¹éŸ³:', key);
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©æ ¹éŸ³
                    if (key === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        key = notes[Math.floor(Math.random() * notes.length)];
                    }
                    window.cagedState.currentRootNote = key;
                    console.log('æ–°ä¸€è½®ç»ƒä¹  - é€‰æ‹©æ ¹éŸ³:', key);
                }
                
                // æ›´æ–°CAGEDçŠ¶æ€ä¸­çš„è°ƒæ€§ï¼ˆä¿æŒåŒæ­¥ï¼‰
                window.cagedState.currentKey = key;
                
                // ä½¿ç”¨Scale Settingsä¸­çš„éŸ³é˜¶ç±»å‹
                let scaleType = scaleTypeEl.value;
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰éŸ³é˜¶ç±»å‹
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    if (window.cagedState.currentScaleType) {
                        scaleType = window.cagedState.currentScaleType;
                        console.log('ä¿æŒå½“å‰éŸ³é˜¶ç±»å‹:', scaleType);
                    }
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©éŸ³é˜¶ç±»å‹
                    if (scaleType === 'random') {
                        scaleType = window.getRandomSelectedScaleType ?
                            window.getRandomSelectedScaleType() :
                            (function() {
                                const types = Object.keys(scaleTypes);
                                return types[Math.floor(Math.random() * types.length)];
                            })();
                        console.log('æ–°ä¸€è½®ç»ƒä¹  - éšæœºé€‰æ‹©éŸ³é˜¶ç±»å‹:', scaleType);
                    }
                    window.cagedState.currentScaleType = scaleType;
                }
                
                // æ ‡è®°ä¸å†æ˜¯æ–°ä¸€è½®
                window.cagedState.isNewRound = false;
                
                // æ›´æ–°ç›®æ ‡éŸ³ç¨‹æ˜¾ç¤º
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                
                // ç”Ÿæˆè¿æ¥ç»ƒä¹ çš„éŸ³é˜¶åºåˆ—ï¼ˆä½¿ç”¨é€‰æ‹©çš„éŸ³é˜¶ç±»å‹ï¼Œå•éå³å¯ï¼‰
                const scaleIntervals = [...scaleTypes[scaleType].intervals];
                state.currentIntervals = [...scaleIntervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedState.currentShape;
                state.cagedKey = window.cagedState.currentKey;
                state.cagedPracticeType = window.cagedState.practiceType;
                state.scaleType = scaleType;
                
                displaySequence();
                
                // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
                generateCagedNextExercise();
                
            }

            // éšæœºå½¢çŠ¶ç»ƒä¹ 
            function generateRandomShapeExercise() {
                // é‡ç½®ç»ƒä¹ çŠ¶æ€
                state.currentStep = 0;
                state.isAnswered = false;
                
                // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
                displayCagedShapeSelection();
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªå½¢çŠ¶
                const availableShapes = window.cagedState.selectedShapes;
                const randomIndex = Math.floor(Math.random() * availableShapes.length);
                const randomShapeName = availableShapes[randomIndex];
                const shape = window.cagedSystem.shapes[randomShapeName];
                
                // ä½¿ç”¨Scale Settingsä¸­çš„æ ¹éŸ³è®¾ç½®
                let key = rootNoteEl.value;
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰æ ¹éŸ³å’ŒéŸ³é˜¶ç±»å‹
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    // ä¿æŒå½“å‰æ ¹éŸ³å’ŒéŸ³é˜¶ç±»å‹
                    key = window.cagedState.currentRootNote || key;
                    console.log('ä¿æŒå½“å‰æ ¹éŸ³:', key);
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©æ ¹éŸ³
                    if (key === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        key = notes[Math.floor(Math.random() * notes.length)];
                    }
                    window.cagedState.currentRootNote = key;
                    console.log('æ–°ä¸€è½®ç»ƒä¹  - é€‰æ‹©æ ¹éŸ³:', key);
                }
                
                // æ›´æ–°CAGEDçŠ¶æ€ä¸­çš„è°ƒæ€§ï¼ˆä¿æŒåŒæ­¥ï¼‰
                window.cagedState.currentKey = key;
                
                // æ›´æ–°å½“å‰å½¢çŠ¶
                window.cagedState.currentShape = randomShapeName;
                
                // ä½¿ç”¨Scale Settingsä¸­çš„éŸ³é˜¶ç±»å‹
                let scaleType = scaleTypeEl.value;
                
                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰éŸ³é˜¶ç±»å‹
                if (window.cagedState.isManualSwitch || !window.cagedState.isNewRound) {
                    if (window.cagedState.currentScaleType) {
                        scaleType = window.cagedState.currentScaleType;
                        console.log('ä¿æŒå½“å‰éŸ³é˜¶ç±»å‹:', scaleType);
                    }
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©éŸ³é˜¶ç±»å‹
                    if (scaleType === 'random') {
                        scaleType = window.getRandomSelectedScaleType ?
                            window.getRandomSelectedScaleType() :
                            (function() {
                                const types = Object.keys(scaleTypes);
                                return types[Math.floor(Math.random() * types.length)];
                            })();
                        console.log('æ–°ä¸€è½®ç»ƒä¹  - éšæœºé€‰æ‹©éŸ³é˜¶ç±»å‹:', scaleType);
                    }
                    window.cagedState.currentScaleType = scaleType;
                }
                
                // æ ‡è®°ä¸å†æ˜¯æ–°ä¸€è½®
                window.cagedState.isNewRound = false;
                
                // æ›´æ–°ç›®æ ‡éŸ³ç¨‹æ˜¾ç¤º
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                
                // ç”ŸæˆCAGEDéŸ³é˜¶åºåˆ—ï¼ˆä½¿ç”¨é€‰æ‹©çš„éŸ³é˜¶ç±»å‹ï¼‰
                state.currentIntervals = [...scaleTypes[scaleType].intervals];
                state.cagedMode = true;
                state.cagedShape = randomShapeName;
                state.cagedKey = window.cagedState.currentKey;
                state.cagedPracticeType = window.cagedState.practiceType;
                state.scaleType = scaleType;
                
                displaySequence();
                
                // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
                generateCagedNextExercise();
                
            }

            // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
            function generateCagedNextExercise() {
                if (!window.cagedState || !window.cagedState.enabled) {
                    return;
                }
                
                const selectedShapes = window.cagedState.selectedShapes;
                const currentShape = window.cagedState.currentShape;
                const currentIndex = selectedShapes.indexOf(currentShape);
                
                // è·å–ä¸‹ä¸€ä¸ªå½¢çŠ¶
                let nextShapeName;
                if (window.cagedState.practiceMode === 'random') {
                    // éšæœºæ¨¡å¼ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªå½¢çŠ¶
                    nextShapeName = selectedShapes[Math.floor(Math.random() * selectedShapes.length)];
                } else {
                    // å•ä¸ªå½¢çŠ¶æˆ–è¿æ¥æ¨¡å¼ï¼šæŒ‰é¡ºåºå¾ªç¯
                    const nextIndex = (currentIndex + 1) % selectedShapes.length;
                    nextShapeName = selectedShapes[nextIndex];
                }
                
                const nextShape = window.cagedSystem.shapes[nextShapeName];
                const key = window.cagedState.currentKey;
                const scaleType = state.scaleType || 'major';
                
                // è®¾ç½®ä¸‹ä¸€é¢˜ä¿¡æ¯
                state.nextExerciseInfo = `${key} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                state.nextExerciseIntervals = [...scaleTypes[scaleType].intervals];
                
                updateNextExerciseDisplay();
            }

            // è·å–ä¸‹ä¸€ä¸ªå½¢çŠ¶
            function getNextShape() {
                const currentIndex = window.cagedState.selectedShapes.indexOf(window.cagedState.currentShape);
                const nextIndex = (currentIndex + 1) % window.cagedState.selectedShapes.length;
                const nextShapeName = window.cagedState.selectedShapes[nextIndex];
                return window.cagedSystem.shapes[nextShapeName];
            }

            // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
            function displayCagedShapeSelection() {
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedShapes();
                }
            }

            // åªæ˜¾ç¤ºé€‰ä¸­çš„å½¢çŠ¶
            function showOnlySelectedShapes() {
                const shapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                const container = document.querySelector('.caged-shape-buttons');
                const selectedShapes = window.cagedState.selectedShapes;

                // å¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼Œéœ€è¦é‡æ–°æ’åˆ—æŒ‰é’®é¡ºåº
                if (window.cagedState.practiceMode === 'random') {
                    // åˆ›å»ºé€‰ä¸­çš„å½¢çŠ¶æ•°ç»„å¹¶éšæœºæ’åº
                    const shuffledSelectedShapes = [...selectedShapes].sort(() => Math.random() - 0.5);

                    // å…ˆéšè—æ‰€æœ‰æŒ‰é’®
                    shapeButtons.forEach(btn => {
                        btn.style.display = 'none';
                    });

                    // æŒ‰éšæœºé¡ºåºé‡æ–°æ’åˆ—å’Œæ˜¾ç¤ºæŒ‰é’®
                    shuffledSelectedShapes.forEach((shape, index) => {
                        const btn = document.querySelector(`.caged-shape-btn-display[data-shape="${shape}"]`);
                        if (btn) {
                            btn.style.display = 'flex';
                            btn.style.order = index.toString(); // è®¾ç½®éšæœºé¡ºåº
                        }
                    });

                    // ç¡®ä¿å®¹å™¨ä½¿ç”¨flex orderæ’åº
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center';
                    container.style.gap = '15px';
                    container.style.flexWrap = 'wrap';
                } else {
                    // ééšæœºæ¨¡å¼ï¼ŒæŒ‰C-A-G-E-DåŸé¡ºåºæ˜¾ç¤ºé€‰ä¸­çš„å½¢çŠ¶
                    const fixedOrder = ['C', 'A', 'G', 'E', 'D'];
                    shapeButtons.forEach(btn => {
                        const shape = btn.dataset.shape;
                        if (selectedShapes.includes(shape)) {
                            btn.style.display = 'flex';
                            // æŒ‰å›ºå®šé¡ºåºè®¾ç½®order
                            btn.style.order = fixedOrder.indexOf(shape).toString();
                        } else {
                            btn.style.display = 'none';
                        }
                    });
                }
            }

            // åªæ˜¾ç¤ºé€‰ä¸­çš„å’Œå¼¦å½¢çŠ¶
            function showOnlySelectedChordShapes() {
                const shapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                const container = document.querySelector('.caged-shape-buttons');
                const selectedShapes = window.cagedChordState.selectedShapes;

                // å¦‚æœæ˜¯éšæœºæ¨¡å¼ï¼Œéœ€è¦é‡æ–°æ’åˆ—æŒ‰é’®é¡ºåº
                if (window.cagedChordState.practiceMode === 'random') {
                    // åˆ›å»ºé€‰ä¸­çš„å½¢çŠ¶æ•°ç»„å¹¶éšæœºæ’åº
                    const shuffledSelectedShapes = [...selectedShapes].sort(() => Math.random() - 0.5);

                    // å…ˆéšè—æ‰€æœ‰æŒ‰é’®
                    shapeButtons.forEach(btn => {
                        btn.style.display = 'none';
                    });

                    // æŒ‰éšæœºé¡ºåºé‡æ–°æ’åˆ—å’Œæ˜¾ç¤ºæŒ‰é’®
                    shuffledSelectedShapes.forEach((shape, index) => {
                        const btn = document.querySelector(`.caged-shape-btn-display[data-shape="${shape}"]`);
                        if (btn) {
                            btn.style.display = 'flex';
                            btn.style.order = index.toString(); // è®¾ç½®éšæœºé¡ºåº
                        }
                    });

                    // ç¡®ä¿å®¹å™¨ä½¿ç”¨flex orderæ’åº
                    container.style.display = 'flex';
                    container.style.justifyContent = 'center';
                    container.style.gap = '15px';
                    container.style.flexWrap = 'wrap';
                } else {
                    // ééšæœºæ¨¡å¼ï¼ŒæŒ‰C-A-G-E-DåŸé¡ºåºæ˜¾ç¤ºé€‰ä¸­çš„å½¢çŠ¶
                    const fixedOrder = ['C', 'A', 'G', 'E', 'D'];
                    shapeButtons.forEach(btn => {
                        const shape = btn.dataset.shape;
                        if (selectedShapes.includes(shape)) {
                            btn.style.display = 'flex';
                            // æŒ‰å›ºå®šé¡ºåºè®¾ç½®order
                            btn.style.order = fixedOrder.indexOf(shape).toString();
                        } else {
                            btn.style.display = 'none';
                        }
                    });
                }
            }

            // æ›´æ–°CAGEDå½¢çŠ¶æŒ‰é’®çŠ¶æ€
            function updateCagedShapeButtons() {
                const shapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                const selectedShapes = window.cagedState.selectedShapes;
                const currentShape = window.cagedState.currentShape;
                const completedShapes = window.cagedState.completedShapesInCurrentRound || [];

                shapeButtons.forEach(btn => {
                    const shape = btn.dataset.shape;
                    btn.classList.remove('current', 'completed', 'disabled', 'played');

                    // åªå¤„ç†é€‰ä¸­çš„å½¢çŠ¶
                    if (selectedShapes.includes(shape)) {
                        if (shape === currentShape) {
                            btn.classList.add('current');
                            btn.title = `å½“å‰å½¢çŠ¶: ${shape}`;
                        } else if (completedShapes.includes(shape)) {
                            // å¼¹è¿‡çš„å½¢çŠ¶æ˜¾ç¤ºä¸ºé€æ˜
                            btn.classList.add('played');
                            btn.title = `å·²å®Œæˆ ${shape} å½¢çŠ¶`;
                        } else {
                            btn.classList.add('completed');
                            btn.title = `ç‚¹å‡»åˆ‡æ¢åˆ° ${shape} å½¢çŠ¶`;
                        }
                    } else {
                        btn.classList.add('disabled');
                        btn.title = `${shape} å½¢çŠ¶æœªé€‰ä¸­`;
                    }
                });
            }

            // CAGEDå½¢çŠ¶è‡ªåŠ¨åˆ‡æ¢
            function switchToNextCagedShape() {
                // è·å–åŸå§‹é€‰æ‹©çš„å½¢çŠ¶åˆ—è¡¨ï¼ˆä¸ä¿®æ”¹ï¼Œç”¨äºå¾ªç¯ï¼‰
                const originalSelectedShapes = [...window.cagedState.selectedShapes];
                const currentShape = window.cagedState.currentShape;
                const currentIndex = originalSelectedShapes.indexOf(currentShape);
                
                // å°†å½“å‰å½¢çŠ¶æ ‡è®°ä¸ºå·²å®Œæˆ
                if (!window.cagedState.completedShapesInCurrentRound.includes(currentShape)) {
                    window.cagedState.completedShapesInCurrentRound.push(currentShape);
                }
                
                console.log('å·²å®Œæˆå½¢çŠ¶:', window.cagedState.completedShapesInCurrentRound);
                console.log('æ€»å…±éœ€è¦å®Œæˆ:', originalSelectedShapes);
                
                // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†å½“å‰è½®æ¬¡çš„æ‰€æœ‰å½¢çŠ¶
                if (window.cagedState.completedShapesInCurrentRound.length >= originalSelectedShapes.length) {
                    // å®Œæˆä¸€è½®ï¼Œå¼€å§‹æ–°ä¸€è½®
                    window.cagedState.completedShapesInCurrentRound = [];
                    window.cagedState.isNewRound = true;
                    console.log('å®Œæˆä¸€è½®CAGEDå½¢çŠ¶ï¼Œå¼€å§‹æ–°ä¸€è½®ç»ƒä¹ ');
                }
                
                // å¾ªç¯åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå½¢çŠ¶
                let nextIndex;
                if (window.cagedState.practiceMode === 'random') {
                    // éšæœºæ¨¡å¼ï¼šéšæœºé€‰æ‹©ä¸‹ä¸€ä¸ªå½¢çŠ¶
                    nextIndex = Math.floor(Math.random() * originalSelectedShapes.length);
                } else {
                    // å•ä¸ªå½¢çŠ¶æˆ–è¿æ¥æ¨¡å¼ï¼šæŒ‰é¡ºåºå¾ªç¯
                    nextIndex = (currentIndex + 1) % originalSelectedShapes.length;
                }
                
                window.cagedState.currentShape = originalSelectedShapes[nextIndex];
                    updateCagedShapeButtons();
                showOnlySelectedShapes();
                    
                    // ç«‹å³ç”Ÿæˆæ–°å½¢çŠ¶çš„ç»ƒä¹ ï¼ˆå»¶è¿Ÿå·²åœ¨handleCagedCorrectä¸­å¤„ç†ï¼‰
                        generateCagedExercise();
            }

            // å®Œæˆæ‰€æœ‰CAGEDå½¢çŠ¶
            function completeAllCagedShapes() {
                // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
                const targetIntervalEl = document.getElementById('targetInterval');
                targetIntervalEl.textContent = 'ğŸ‰ æ‰€æœ‰CAGEDå½¢çŠ¶ç»ƒä¹ å®Œæˆï¼';
                
                // éšè—CAGEDå½¢çŠ¶æ˜¾ç¤º
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'none';
                }
                
                // 3ç§’åé‡æ–°å¼€å§‹æˆ–é€€å‡ºç»ƒä¹ 
                setTimeout(() => {
                    if (confirm('æ‰€æœ‰CAGEDå½¢çŠ¶ç»ƒä¹ å®Œæˆï¼æ˜¯å¦é‡æ–°å¼€å§‹ï¼Ÿ')) {
                        // é‡æ–°å¼€å§‹CAGEDç»ƒä¹ 
                        resetCagedShapes();
                        generateCagedExercise();
                } else {
                        // é€€å‡ºCAGEDç»ƒä¹ 
                        window.cagedState.enabled = false;
                        generateScaleExercise();
                    }
                }, 3000);
            }

            // é‡ç½®CAGEDå½¢çŠ¶
            function resetCagedShapes() {
                // æ¢å¤æ‰€æœ‰é€‰ä¸­çš„å½¢çŠ¶
                window.cagedState.selectedShapes = ['C', 'A', 'G', 'E', 'D'];
                window.cagedState.currentShape = window.cagedState.selectedShapes[0];
            }

            // CAGEDéŸ³é¢‘å¤„ç†
            function processCagedAudio(inputData, sampleRate) {
                if (!window.cagedState || !window.cagedState.enabled) {
                    return;
                }

                // ä½¿ç”¨ä¸æ™®é€šæ¨¡å¼ç›¸åŒçš„YINç®—æ³•è°ƒç”¨æ–¹å¼
                const yinResult = Pitchfinder.YIN({ threshold: 0.1, probabilityCliff: 0.1 })(inputData);
                if (!yinResult || !yinResult.frequency) return;
                
                // èƒ½é‡æ£€æµ‹
                const energy = rms(inputData);
                if (energy < 0.002) return;
                
                const detectedNote = frequencyToNoteName(yinResult.frequency);
                
                console.log(`CAGEDéŸ³é¢‘å¤„ç†: æ£€æµ‹åˆ°éŸ³ç¬¦=${detectedNote}, é¢‘ç‡=${yinResult.frequency.toFixed(2)}Hz, èƒ½é‡=${energy.toFixed(4)}`);
                
                // æ£€æŸ¥æ£€æµ‹åˆ°çš„éŸ³ç¬¦æ˜¯å¦æœ‰æ•ˆ
                if (!detectedNote) {
                    console.error('CAGEDéŸ³é¢‘å¤„ç†: frequencyToNoteNameè¿”å›äº†undefinedæˆ–ç©ºå€¼');
                    return;
                }
                
                // è·å–å½“å‰åº”è¯¥å¼¹å¥çš„éŸ³çº§
                const currentInterval = state.currentSequence[state.currentStep];
                    const rootNote = window.cagedState.currentKey;
                    
                console.log(`CAGEDçŠ¶æ€æ£€æŸ¥: currentStep=${state.currentStep}, currentSequenceé•¿åº¦=${state.currentSequence.length}, currentInterval=${currentInterval}, rootNote=${rootNote}`);
                
                // æ£€æŸ¥çŠ¶æ€æ˜¯å¦æœ‰æ•ˆ
                if (!currentInterval) {
                    console.error('CAGEDéŸ³é¢‘å¤„ç†: å½“å‰éŸ³çº§ä¸ºundefined');
                    return;
                }
                
                if (!rootNote) {
                    console.error('CAGEDéŸ³é¢‘å¤„ç†: æ ¹éŸ³ä¸ºundefined');
                    return;
                }
                    
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…å½“å‰éŸ³çº§ï¼ˆä½¿ç”¨ä¸æ™®é€šéŸ³é˜¶ç»ƒä¹ ç›¸åŒçš„é€»è¾‘ï¼‰
                if (checkCagedCurrentInterval(detectedNote, rootNote, currentInterval)) {
                        handleCagedCorrect();
                    }
                }

            // æ£€æŸ¥CAGEDå½“å‰éŸ³çº§åŒ¹é…ï¼ˆä½¿ç”¨ä¸æ™®é€šéŸ³é˜¶ç»ƒä¹ ç›¸åŒçš„é€»è¾‘ï¼‰
            function checkCagedCurrentInterval(detectedNote, rootNote, currentInterval) {
                // æ£€æŸ¥è¾“å…¥å‚æ•°çš„æœ‰æ•ˆæ€§
                if (!detectedNote) {
                    console.error(`CAGEDæ£€æŸ¥: æ£€æµ‹éŸ³ç¬¦ä¸ºç©ºæˆ–undefined`);
                    return false;
                }
                
                if (!rootNote) {
                    console.error(`CAGEDæ£€æŸ¥: æ ¹éŸ³ä¸ºç©ºæˆ–undefined`);
                    return false;
                }
                
                if (!currentInterval) {
                    console.error(`CAGEDæ£€æŸ¥: å½“å‰éŸ³çº§ä¸ºç©ºæˆ–undefined`);
                    return false;
                }
                
                // æ£€æŸ¥éŸ³çº§æ˜¯å¦åœ¨æ˜ å°„ä¸­å­˜åœ¨
                if (!intervalToSemitones.hasOwnProperty(currentInterval)) {
                    console.error(`æœªçŸ¥çš„éŸ³çº§: ${currentInterval}`);
                    return false;
                }
                
                // æ£€æŸ¥éŸ³ç¬¦æ˜¯å¦åœ¨æ˜ å°„ä¸­å­˜åœ¨
                if (!noteToSemitones.hasOwnProperty(detectedNote)) {
                    console.error(`æœªçŸ¥çš„æ£€æµ‹éŸ³ç¬¦: ${detectedNote}`);
                    return false;
                }
                
                if (!noteToSemitones.hasOwnProperty(rootNote)) {
                    console.error(`æœªçŸ¥çš„æ ¹éŸ³: ${rootNote}`);
                    return false;
                }
                
                const rootValue = noteToSemitones[rootNote];
                const targetSemitone = (rootValue + intervalToSemitones[currentInterval]) % 12;
                const detectedSemitone = noteToSemitones[detectedNote] % 12;
                
                console.log(`CAGEDéŸ³çº§æ£€æŸ¥: å½“å‰éŸ³çº§=${currentInterval}, ç›®æ ‡éŸ³ç¬¦=${semitonesToNoteName(targetSemitone)}, æ£€æµ‹éŸ³ç¬¦=${detectedNote}`);
                
                // æ£€æŸ¥æ˜¯å¦åŒ¹é…ï¼ˆè€ƒè™‘ç­‰ä»·éŸ³ç¬¦ï¼‰
                const isMatch = detectedSemitone === targetSemitone || isEquivalentNote(detectedNote, semitonesToNoteName(targetSemitone));
                console.log(`CAGEDéŸ³çº§åŒ¹é…ç»“æœ: ${isMatch}`);
                
                return isMatch;
            }

            // æ£€æŸ¥CAGEDåŒ¹é…
            function checkCagedMatch(detectedNote, rootNote, shape) {
                // å‰ä»–æ ‡å‡†è°ƒå¼¦ï¼ˆä»ç²—åˆ°ç»†ï¼š6å¼¦åˆ°1å¼¦ï¼‰
                const guitarStrings = ['E', 'A', 'D', 'G', 'B', 'E']; // 6å¼¦åˆ°1å¼¦
                
                // è®¡ç®—è°ƒæ€§åç§»
                const keyOffsets = { 
                    'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4, 
                    'F': 5, 'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8, 'A': 9, 
                    'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11 
                };
                const keyOffset = keyOffsets[rootNote] || 0;
                
                // è·å–å½¢çŠ¶ä¸­çš„æ‰€æœ‰éŸ³ç¬¦
                const shapeNotes = shape.positions.map(pos => {
                    // CAGEDä¸­stringç¼–å·ï¼š5=5å¼¦ï¼Œ4=4å¼¦ï¼Œ3=3å¼¦ï¼Œ2=2å¼¦ï¼Œ1=1å¼¦ï¼Œ0=?
                    // guitarStringsæ•°ç»„ï¼š[6å¼¦E, 5å¼¦A, 4å¼¦D, 3å¼¦G, 2å¼¦B, 1å¼¦E]
                    // æ‰€ä»¥ pos.string=5 -> guitarStrings[1] (5å¼¦A)
                    const stringIndex = pos.string === 5 ? 1 : pos.string === 4 ? 2 : pos.string === 3 ? 3 : pos.string === 2 ? 4 : pos.string === 1 ? 5 : 0;
                    const openNote = guitarStrings[stringIndex];
                    const openNoteValue = noteToSemitones[openNote];
                    
                    // è®¡ç®—è¯¥ä½ç½®çš„å®é™…éŸ³ç¬¦å€¼ï¼ˆè€ƒè™‘è°ƒæ€§åç§»ï¼‰
                    const actualNoteValue = (openNoteValue + pos.fret + keyOffset) % 12;
                    
                    // è½¬æ¢å›éŸ³ç¬¦å
                    const noteName = semitonesToNoteName(actualNoteValue);
                    
                    // è¯¦ç»†è°ƒè¯•ä¿¡æ¯
                    const guitarStringNumber = pos.string === 5 ? 5 : pos.string === 4 ? 4 : pos.string === 3 ? 3 : pos.string === 2 ? 2 : pos.string === 1 ? 1 : 6;
                    console.log(`CAGEDå¼¦${pos.string} -> å‰ä»–ç¬¬${guitarStringNumber}å¼¦(${openNote}) ç¬¬${pos.fret}å“ + è°ƒæ€§åç§»${keyOffset} = ${noteName} (éŸ³ç¨‹${pos.interval})`);
                    
                    return noteName;
                });
                
                // è°ƒè¯•ä¿¡æ¯
                console.log(`CAGEDåŒ¹é…æ£€æŸ¥: æ£€æµ‹éŸ³ç¬¦=${detectedNote}, æ ¹éŸ³=${rootNote}, å½¢çŠ¶=${shape.name}`);
                console.log(`å½¢çŠ¶éŸ³ç¬¦:`, shapeNotes);
                console.log(`è°ƒæ€§åç§»:`, keyOffset);
                
                // æ£€æŸ¥æ£€æµ‹åˆ°çš„éŸ³ç¬¦æ˜¯å¦åœ¨å½¢çŠ¶ä¸­
                const isMatch = shapeNotes.some(note => isEquivalentNote(detectedNote, note));
                console.log(`åŒ¹é…ç»“æœ:`, isMatch);
                
                return isMatch;
            }
            
            // åŠéŸ³æ•°è½¬éŸ³ç¬¦å
            function semitonesToNoteName(semitones) {
                const noteNames = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                return noteNames[semitones % 12];
            }

            // å¤„ç†CAGEDæ­£ç¡®å›ç­”
            function handleCagedCorrect() {
                if (state.isAnswered) return;
                
                state.correctCount++;
                state.currentStep++;
                const justDone = state.currentStep - 1;
                
                // æ˜¾ç¤ºæ­£ç¡®åé¦ˆ
                const feedbackEl = document.getElementById('feedback');
                if (feedbackEl) {
                    feedbackEl.textContent = 'æ­£ç¡®ï¼';
                    feedbackEl.style.color = '#10b981';
                }
                
                // ä½¿ç”¨ä¸æ™®é€šç»ƒä¹ ç›¸åŒçš„é€»è¾‘æ ‡è®°åºåˆ—é¡¹
                const el = document.querySelector(`.sequence-item[data-index="${justDone}"]`);
                if (el) {
                    el.classList.remove('current');
                    el.classList.add('played');
                }
                
                requestAnimationFrame(() => {
                // æ£€æŸ¥æ˜¯å¦å®Œæˆå½“å‰å½¢çŠ¶çš„æ‰€æœ‰éŸ³é˜¶
                if (state.currentStep >= state.currentIntervals.length) {
                        state.isAnswered = true;
                    
                    // æ ¹æ®å…¨å±€è®¾ç½®å†³å®šå»¶è¿Ÿæ—¶é—´
                    let delayTime = 0; // é»˜è®¤æ— å»¶è¿Ÿ
                    if (state.enableFixedDelay) {
                        delayTime = state.fixedDelayDuration;
                    }
                    
                    console.log(`CAGEDå½¢çŠ¶åˆ‡æ¢å»¶è¿Ÿ: ${delayTime}ms (å…¨å±€è®¾ç½®: ${state.enableFixedDelay ? 'å¯ç”¨' : 'ç¦ç”¨'})`);
                    
                    // å½“å‰å½¢çŠ¶ç»ƒä¹ å®Œæˆï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå½¢çŠ¶
                    setTimeout(() => {
                        switchToNextCagedShape();
                    }, delayTime);
                } else {
                        // è®¾ç½®ä¸‹ä¸€ä¸ªåºåˆ—é¡¹ä¸ºå½“å‰é¡¹
                        const next = document.querySelector(`.sequence-item[data-index="${state.currentStep}"]`);
                        if (next) next.classList.add('current');
                        
                        // ç»§ç»­å½“å‰å½¢çŠ¶çš„ç»ƒä¹ ï¼Œé‡ç½®ç­”é¢˜çŠ¶æ€ï¼ˆéŸ³çº§é—´ä½¿ç”¨è¾ƒçŸ­å»¶è¿Ÿï¼‰
                    setTimeout(() => {
                            state.isAnswered = false;
                        }, 300); // éŸ³çº§é—´å»¶è¿Ÿå‡å°‘åˆ°300ms
                }
                });
            }


            // ç”ŸæˆéŸ³é˜¶ç»ƒä¹ 
            function generateScaleExercise() {
                resetCagedModeState();

                let rootNote = rootNoteEl.value;
                if (rootNote === 'random') {
                    // å¦‚æœæœ‰é¢„é€‰çš„æ ¹éŸ³ï¼ˆä»generateNextExerciseè®¾ç½®çš„ï¼‰ï¼Œä½¿ç”¨é¢„é€‰çš„æ ¹éŸ³
                    if (state.nextRootNote) {
                        rootNote = state.nextRootNote;
                        console.log('ä½¿ç”¨é¢„é€‰çš„æ ¹éŸ³:', rootNote);
                    } else {
                        // å¦åˆ™é‡æ–°éšæœºé€‰æ‹©
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                }
                state.rootNote = rootNote;

                // åœ¨å¤šé€‰æ¨¡å¼ä¸‹ï¼Œæ€»æ˜¯ä½¿ç”¨éšæœºé€‰æ‹©
                let scaleType;
                // å¦‚æœæœ‰é¢„é€‰çš„è°ƒå¼ï¼ˆä»generateNextExerciseè®¾ç½®çš„ï¼‰ï¼Œä½¿ç”¨é¢„é€‰çš„è°ƒå¼
                if (state.nextScaleType) {
                    scaleType = state.nextScaleType;
                } else {
                    // å¦åˆ™é‡æ–°éšæœºé€‰æ‹©
                    scaleType = window.getRandomSelectedScaleType ?
                        window.getRandomSelectedScaleType() :
                        (function() {
                            const types = Object.keys(scaleTypes);
                            return types[Math.floor(Math.random() * types.length)];
                        })();
                }
                state.scaleType = scaleType;

                // æ¸…é™¤é¢„é€‰çš„è°ƒå¼ï¼Œå› ä¸ºå·²ç»ä½¿ç”¨è¿‡äº†
                state.nextScaleType = null;
                state.nextRootNote = null;

                // è·å–ç»ƒä¹ åºåˆ—ç±»å‹
                const arpeggioTypeButtons = document.querySelectorAll('.scale-arpeggio-btn');
                let arpeggioType = '1to1';
                
                for (let i = 0; i < arpeggioTypeButtons.length; i++) {
                  if (arpeggioTypeButtons[i].classList.contains('active')) {
                    arpeggioType = arpeggioTypeButtons[i].getAttribute('data-value');
                    break;
                  }
                }
                
                console.log('å½“å‰é€‰æ‹©çš„ç»ƒä¹ åºåˆ—ç±»å‹:', arpeggioType);

                // è·å–æ–¹å‘
                const activeScaleOrderBtn = document.querySelector('.scale-order-btn.active');
                const order = activeScaleOrderBtn ? activeScaleOrderBtn.dataset.value : 'ordered';

                // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒï¼šæ ¹æ®æ–¹å‘é€‰æ‹©ä¸Šè¡Œæˆ–ä¸‹è¡Œå½¢å¼
                let intervals;
                let isMelodicMinorDescending = false;
                if (scaleType === 'melodicMinor' && order === 'reverse') {
                    // ä¸‹è¡Œæ—‹å¾‹å°è°ƒ
                    intervals = [...(scaleTypes['melodicMinorDescending']?.intervals || scaleTypes[scaleType].intervals)];
                    isMelodicMinorDescending = true;
                } else {
                    // é»˜è®¤ä½¿ç”¨ä¸Šè¡Œå½¢å¼
                    intervals = [...scaleTypes[scaleType].intervals];
                }
                state.currentIntervals = intervals;
                let startEndInterval = '1'; // é»˜è®¤ä½¿ç”¨1ä½œä¸ºé¦–å°¾éŸ³
                
                // æ ¹æ®ç»ƒä¹ åºåˆ—ç±»å‹ç¡®å®šé¦–å°¾éŸ³
                if (arpeggioType === 'random-arpeggio') {
                    // éšæœºé€‰æ‹©1ã€3ã€5ã€7éŸ³ä½œä¸ºé¦–å°¾éŸ³ï¼Œä½†åªåŒ…å«éŸ³é˜¶ä¸­å®é™…å­˜åœ¨çš„éŸ³ç¨‹
                    const availableChordTones = [];
                    const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                    if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                    const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                    if (fifthInterval) availableChordTones.push(fifthInterval);
                    const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                    if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                    
                    // å¦‚æœæœ‰å¯ç”¨çš„3/5/7åº¦éŸ³ç¨‹ï¼Œåˆ™ä»ä¸­éšæœºé€‰æ‹©
                    if (availableChordTones.length > 0) {
                        startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                    } else {
                        startEndInterval = '1'; // å›é€€åˆ°æ ¹éŸ³
                    }
                } else if (arpeggioType === '3to3') {
                    // ä½¿ç”¨3éŸ³ä½œä¸ºé¦–å°¾éŸ³
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                } else if (arpeggioType === '5to5') {
                    // ä½¿ç”¨5éŸ³ä½œä¸ºé¦–å°¾éŸ³
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                } else if (arpeggioType === '7to7') {
                    // ä½¿ç”¨7éŸ³ä½œä¸ºé¦–å°¾éŸ³
                    startEndInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                } else if (arpeggioType !== '1to1' && arpeggioType !== 'random') {
                    // å¤„ç†å…¶ä»–ç‰¹å®šéŸ³ç¨‹ä½œä¸ºé¦–å°¾éŸ³çš„æƒ…å†µï¼ˆå¦‚â™¯6â†’â™¯6ï¼‰
                    // arpeggioTypeæ ¼å¼ä¸º"xtox"ï¼Œæå–xéƒ¨åˆ†
                    const match = arpeggioType.match(/^(.+)to\1$/);
                    if (match) {
                        const intervalType = match[1];
                        console.log('å¤„ç†ç‰¹å®šéŸ³ç¨‹:', intervalType, 'åœ¨éŸ³é˜¶ä¸­:', state.currentIntervals);
                        // æŸ¥æ‰¾éŸ³é˜¶ä¸­å¯¹åº”çš„éŸ³ç¨‹
                        const completeInterval = findCompleteIntervalInScale(state.currentIntervals, intervalType);
                        console.log('æ‰¾åˆ°çš„å®Œæ•´éŸ³ç¨‹:', completeInterval);
                        if (completeInterval) {
                            startEndInterval = completeInterval;
                        } else {
                            const nearestInterval = findNearestIntervalInScale(state.currentIntervals, intervalType.replace(/[^\d]/g, ''));
                            console.log('æ‰¾åˆ°çš„æœ€è¿‘éŸ³ç¨‹:', nearestInterval);
                            startEndInterval = nearestInterval || intervalType;
                        }
                        console.log('æœ€ç»ˆé¦–å°¾éŸ³:', startEndInterval);
                    }
                }

                // ç‰¹æ®Šå¤„ç†æ—‹å¾‹å°è°ƒä¸‹è¡Œï¼šç›´æ¥ä½¿ç”¨é¢„å®šä¹‰çš„åºåˆ—ï¼Œä¸è¿›è¡Œé¢å¤–å¤„ç†
                if (!isMelodicMinorDescending) {
                    if (order === 'reverse') {
                        // å€’åºæ¨¡å¼
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åå€’åºï¼Œæœ€åæ·»åŠ é¦–å°¾éŸ³
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)].reverse();
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                const middleIntervals = state.currentIntervals.slice(1).reverse();
                                state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // ä¿æŒåŸæœ‰çš„å€’åºé€»è¾‘
                            const middleIntervals = state.currentIntervals.slice(1).reverse();
                            state.currentIntervals = [state.currentIntervals[0], ...middleIntervals, state.currentIntervals[0]];
                        }
                    } else if (order === 'random') {
                        // éšæœºæ¨¡å¼
                        if (arpeggioType === 'random-arpeggio') {
                            // å¯¹äºéšæœºå’Œå¼¦ç±»å‹ï¼Œæ•´ä¸ªåºåˆ—éƒ½åº”è¯¥åªåŒ…å«å’Œå¼¦éŸ³ï¼ˆ1ã€3ã€5ã€7åº¦éŸ³ç¨‹ï¼‰
                            // æ”¶é›†æ‰€æœ‰å®é™…å­˜åœ¨çš„3/5/7åº¦éŸ³ç¨‹
                            const availableChordTones = [];
                            const thirdInterval = findFirstIntervalOfType(state.currentIntervals, '3');
                            if (thirdInterval) availableChordTones.push(thirdInterval); // æ·»åŠ æ‰¾åˆ°çš„3åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­3, 3, â™¯3ç­‰ï¼‰
                            const fifthInterval = findFirstIntervalOfType(state.currentIntervals, '5');
                            if (fifthInterval) availableChordTones.push(fifthInterval);
                            const seventhInterval = findFirstIntervalOfType(state.currentIntervals, '7');
                            if (seventhInterval) availableChordTones.push(seventhInterval); // æ·»åŠ æ‰¾åˆ°çš„7åº¦éŸ³ï¼ˆå¯èƒ½æ˜¯â™­7, 7, â™¯7ç­‰ï¼‰
                            
                            // å¦‚æœæ‰¾ä¸åˆ°è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œå›é€€åˆ°ä½¿ç”¨é¦–å°¾éŸ³
                            if (availableChordTones.length > 0) {
                                // éšæœºæ‰“ä¹±å’Œå¼¦éŸ³
                                const shuffledChordTones = [...availableChordTones];
                                for (let i = shuffledChordTones.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [shuffledChordTones[i], shuffledChordTones[j]] = [shuffledChordTones[j], shuffledChordTones[i]];
                                }
                                
                                // ä»æ‰¾åˆ°çš„å’Œå¼¦éŸ³ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸ºé¦–å°¾éŸ³
                                startEndInterval = availableChordTones[Math.floor(Math.random() * availableChordTones.length)];
                                
                                // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿åŒ…å«é¦–å°¾éŸ³
                                state.currentIntervals = [startEndInterval, ...shuffledChordTones.filter(interval => interval !== startEndInterval), startEndInterval];
                            } else {
                                // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„å’Œå¼¦éŸ³ï¼Œä½¿ç”¨æ ¹éŸ³ä½œä¸ºæ•´ä¸ªåºåˆ—
                                state.currentIntervals = ['1', '1'];
                            }
                        } else if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType.match(/^.+to.+$/)) {
                            // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // æå–é™¤äº†é¦–å°¾éŸ³ä¹‹å¤–çš„æ‰€æœ‰éŸ³
                                const otherIntervals = [...state.currentIntervals.slice(0, startEndIndex), ...state.currentIntervals.slice(startEndIndex + 1)];
                                
                                // éšæœºæ‰“ä¹±
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                
                                // æ„å»ºæ–°åºåˆ—ï¼Œç¡®ä¿é¦–å°¾éƒ½æ˜¯æŒ‡å®šçš„éŸ³
                                state.currentIntervals = [startEndInterval, ...otherIntervals, startEndInterval];
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                const otherIntervals = state.currentIntervals.slice(1);
                                for (let i = otherIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                                }
                                state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                            }
                        } else {
                            // ä¿æŒåŸæœ‰çš„éšæœºé€»è¾‘
                            const otherIntervals = state.currentIntervals.slice(1);
                            for (let i = otherIntervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [otherIntervals[i], otherIntervals[j]] = [otherIntervals[j], otherIntervals[i]];
                            }
                            state.currentIntervals = [state.currentIntervals[0], ...otherIntervals, state.currentIntervals[0]];
                        }
                    } else {
                        // é¡ºåºæ¨¡å¼
                        if (arpeggioType === '1to1' || arpeggioType === '3to3' || arpeggioType === '5to5' || arpeggioType === '7to7' || arpeggioType === 'random-arpeggio' || arpeggioType.match(/^.+to.+$/)) {
                            // æ‰¾åˆ°é¦–å°¾éŸ³åœ¨åŸå§‹éŸ³é˜¶ä¸­çš„ä½ç½®
                            const startEndIndex = state.currentIntervals.indexOf(startEndInterval);
                            
                            if (startEndIndex !== -1) {
                                // æå–ä»é¦–å°¾éŸ³å¼€å§‹çš„æ‰€æœ‰éŸ³ï¼Œç„¶åæ·»åŠ é¦–å°¾éŸ³
                                const middleIntervals = [...state.currentIntervals.slice(startEndIndex + 1), ...state.currentIntervals.slice(0, startEndIndex)];
                                state.currentIntervals = [startEndInterval, ...middleIntervals, startEndInterval];
                            } else {
                                // å¦‚æœæ‰¾ä¸åˆ°é¦–å°¾éŸ³ï¼ˆè¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿï¼‰ï¼Œä½¿ç”¨é»˜è®¤è¡Œä¸º
                                state.currentIntervals = [startEndInterval, ...state.currentIntervals, startEndInterval];
                            }
                        } else {
                            // ä¿æŒåŸæœ‰çš„é¡ºåºé€»è¾‘
                            state.currentIntervals = [...state.currentIntervals, state.currentIntervals[0]];
                        }
                    }
                }

                targetIntervalEl.textContent = `${rootNote} ${getScaleDisplayName(scaleTypes[scaleType].name)}`;
                displaySequence();
            }

            // ç”Ÿæˆæ‰¾éŸ³ç»ƒä¹ 
            function generatePitchFindingExercise() {
                resetCagedModeState();
                
                // æ¸…ç†sequence-itemçš„CSSçŠ¶æ€
                const sequenceItems = document.querySelectorAll('.sequence-item');
                sequenceItems.forEach(item => {
                    item.classList.remove('current');
                    // åªæ¸…ç†å¯èƒ½å½±å“å¸ƒå±€çš„å±æ€§ï¼Œä¿ç•™å¿…è¦çš„flexå¸ƒå±€å±æ€§
                    item.style.width = '';
                    item.style.maxWidth = '';
                    item.style.transform = '';
                });
                
                // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨çŠ¶æ€
                if (state.pitchFindingTimer) {
                    clearInterval(state.pitchFindingTimer);
                    state.pitchFindingTimer = null;
                }
                
                // æ¸…é™¤æŒ‡æ¿ä¸Šçš„é«˜äº®å’ŒéŸ³ç¬¦æ˜¾ç¤º
                clearFretboardHighlights();
                
                // æ˜¾ç¤ºæ‰¾éŸ³ç»ƒä¹ ç‰¹å®šå…ƒç´ 
                document.getElementById('pitchFindingElements').style.display = 'block';
                
                // éšè—å…¶ä»–ç»ƒä¹ å…ƒç´ 
                document.getElementById('targetInterval').style.display = 'none';
                document.getElementById('sequenceDisplay').style.display = 'none';
                document.getElementById('nextExercise').style.display = 'none';
                
                // éšè—next-exerciseå®¹å™¨
                const nextExerciseContainer = document.querySelector('.next-exercise');
                if (nextExerciseContainer) {
                    nextExerciseContainer.style.display = 'none';
                }
                
                // éšè—ç»ƒä¹ å®¹å™¨ï¼Œå› ä¸ºæ‰¾éŸ³ç»ƒä¹ æœ‰è‡ªå·±çš„ç•Œé¢
                const exerciseContainer = document.querySelector('.exercise-container');
                if (exerciseContainer) {
                    exerciseContainer.style.display = 'none';
                }
                
                // ç”ŸæˆéšæœºéŸ³ç¬¦
                const notes = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                const randomNote = notes[Math.floor(Math.random() * notes.length)];
                
                // æ›´æ–°å½“å‰éŸ³ç¬¦æ˜¾ç¤º
                document.getElementById('currentNoteDisplay').textContent = randomNote;
                state.currentNote = randomNote;
                
                // è·å–è®¾ç½®
                const showFretboard = document.getElementById('showFretboard').checked;
                const practiceTime = parseInt(document.getElementById('pitchFindingTime').value);
                
                // æ˜¾ç¤ºæˆ–éšè—æŒ‡æ¿
                const fretboardContainer = document.getElementById('fretboardContainer');
                const fretboardFooter = document.getElementById('fretboardFooter');
                if (showFretboard) {
                    fretboardContainer.style.display = 'block';
                    fretboardFooter.style.display = 'block';
                    createFretboard();
                } else {
                    fretboardContainer.style.display = 'none';
                    fretboardFooter.style.display = 'none';
                }
                
                // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
                document.querySelector('.pitch-finding-next-btn-container').style.display = 'flex';
                
                // éšè—ä¹æ›²åæ˜¾ç¤º
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                if (songTitleDisplayEl) {
                    songTitleDisplayEl.style.display = 'none';
                }
                
                // å¯åŠ¨è®¡æ—¶å™¨
                startPitchFindingTimer(practiceTime);
                
                // è®¾ç½®éŸ³é«˜æ£€æµ‹å›è°ƒ
                state.pitchFindingMode = true;
                state.pitchFindingCorrect = false;
                state.pitchFindingAnswered = false;
                state.pitchFindingNextTimeout = null;
                
                console.log('generatePitchFindingExercise å®Œæˆ - ç›®æ ‡éŸ³ç¬¦:', randomNote, 'pitchFindingMode:', state.pitchFindingMode);
            }

            // åˆ›å»ºæŒ‡æ¿
            function createFretboard() {
                const fretboard = document.getElementById('fretboard');
                const fretNumbers = document.getElementById('fretNumbers');
                fretboard.innerHTML = '';
                fretNumbers.innerHTML = '';
                
                // è·å–é€‰æ‹©çš„æŒ‡æ¿é•¿åº¦
                const selectedRangeBtn = document.querySelector('.pitch-finding-range-btn.active');
                const maxFret = selectedRangeBtn ? parseInt(selectedRangeBtn.dataset.value) : 12;
                
                // å‰ä»–å¼¦çš„å¼€æ”¾éŸ³ï¼ˆä»1å¼¦åˆ°6å¼¦ï¼‰
                const strings = ['E', 'B', 'G', 'D', 'A', 'E'];
                
                // åˆ›å»º6æ ¹å¼¦
                for (let stringIdx = 0; stringIdx < 6; stringIdx++) {
                    const stringElement = document.createElement('div');
                    stringElement.className = 'fretboard-string';
                    
                    // æ·»åŠ å“æ ¼
                    for (let fret = 0; fret <= maxFret; fret++) {
                        const fretElement = document.createElement('div');
                        fretElement.className = 'fretboard-fret';
                        fretElement.dataset.string = stringIdx;
                        fretElement.dataset.fret = fret;
                        
                        // å¦‚æœæ˜¯0å“ï¼Œæ·»åŠ å¼€æ”¾éŸ³æ ‡è®°
                        if (fret === 0) {
                            const openNoteEl = document.createElement('div');
                            openNoteEl.className = 'fret-marker';
                            openNoteEl.textContent = strings[stringIdx];
                            fretElement.appendChild(openNoteEl);
                        }
                        
                        stringElement.appendChild(fretElement);
                    }
                    
                    fretboard.appendChild(stringElement);
                }
                
                // åˆ›å»ºå“æ ¼æ•°å­—æ ‡è®°
                for (let fret = 0; fret <= maxFret; fret++) {
                    const fretNumberEl = document.createElement('div');
                    fretNumberEl.className = 'fret-number';
                    if (fret > 0) fretNumberEl.textContent = fret;
                    fretNumbers.appendChild(fretNumberEl);
                }
            }


            // å¯åŠ¨æ‰¾éŸ³ç»ƒä¹ è®¡æ—¶å™¨
            function startPitchFindingTimer(minutes) {
                // ç¡®ä¿æ¸…ç†ä¹‹å‰çš„è®¡æ—¶å™¨
                if (state.pitchFindingTimer) {
                    clearInterval(state.pitchFindingTimer);
                    state.pitchFindingTimer = null;
                }
                
                let timeLeft = minutes * 60; // è½¬æ¢ä¸ºç§’
                const timerDisplay = document.getElementById('timerDisplay');
                
                if (!timerDisplay) {
                    return;
                }
                
                // ç«‹å³è®¾ç½®åˆå§‹æ˜¾ç¤º
                const initialMinutes = Math.floor(timeLeft / 60);
                const initialSeconds = timeLeft % 60;
                timerDisplay.textContent = `${initialMinutes.toString().padStart(2, '0')}:${initialSeconds.toString().padStart(2, '0')}`;
                
                const timer = setInterval(() => {
                    timeLeft--;
                    
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        endPitchFindingPractice();
                    }
                }, 1000);
                
                state.pitchFindingTimer = timer;
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨ï¼Œç‚¹å‡»å±å¹•ä»»ä½•ä½ç½®é€€å‡ºæ‰¾éŸ³ç»ƒä¹ 
                const pitchFindingClickHandler = function(event) {
                    // æ£€æŸ¥ç‚¹å‡»çš„æ˜¯å¦æ˜¯ä¸‹ä¸€é¢˜æŒ‰é’®æˆ–å…¶å®¹å™¨
                    if (event.target.closest('.pitch-finding-next-btn-container') || 
                        event.target.closest('.pitch-finding-next-btn') ||
                        event.target.id === 'pitchFindingNextBtn') {
                        return; // å¦‚æœç‚¹å‡»çš„æ˜¯ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œä¸é€€å‡ºç»ƒä¹ 
                    }
                    
                    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘å…¶ä»–ç‚¹å‡»äº‹ä»¶
                    event.stopPropagation();
                    
                    // é€€å‡ºæ‰¾éŸ³ç»ƒä¹ 
                    endPitchFindingPractice();
                    
                    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
                    document.removeEventListener('click', pitchFindingClickHandler);
                };
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
                document.addEventListener('click', pitchFindingClickHandler);
            }

            // ç»“æŸæ‰¾éŸ³ç»ƒä¹ 
            function endPitchFindingPractice() {
                if (state.pitchFindingTimer) {
                    clearInterval(state.pitchFindingTimer);
                    state.pitchFindingTimer = null;
                }
                
                // ç›´æ¥é€€å‡ºç»ƒä¹ ï¼Œä¸æ˜¾ç¤ºå®Œæˆæç¤º
                practiceScreen.click();
            }

            // ç”ŸæˆCAGEDå’Œå¼¦ç»ƒä¹ 
            function generateCagedChordExercise() {
                try {
                    if (!window.cagedChordState || !window.cagedChordState.enabled) {
                        console.error('CAGEDå’Œå¼¦ç»ƒä¹ æœªå¯ç”¨');
                        return;
                    }

                    if (!window.cagedSystem || !window.cagedSystem.shapes) {
                        console.error('CAGEDç³»ç»Ÿæ•°æ®æœªæ­£ç¡®åŠ è½½');
                        return;
                    }
                    
                    // éšè—ä¹æ›²åæ˜¾ç¤º
                    const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                    if (songTitleDisplayEl) {
                        songTitleDisplayEl.style.display = 'none';
                    }

                    // å¦‚æœä¸æ˜¯æ‰‹åŠ¨åˆ‡æ¢ä¸”æ˜¯ç¬¬ä¸€æ¬¡ç”Ÿæˆç»ƒä¹ ï¼Œé‡ç½®è½®æ¬¡çŠ¶æ€
                    if (!window.cagedChordState.isManualSwitch && 
                        (!window.cagedChordState.currentChordType || !window.cagedChordState.currentRootNote)) {
                        window.cagedChordState.completedShapesInCurrentRound = [];
                        window.cagedChordState.isNewRound = true;
                        console.log('å¼€å§‹æ–°çš„CAGEDå’Œå¼¦ç»ƒä¹ ï¼Œé‡ç½®è½®æ¬¡çŠ¶æ€');
                    }

                    // æ ¹æ®ç»ƒä¹ æ¨¡å¼ç”Ÿæˆç»ƒä¹ 
                    switch (window.cagedChordState.practiceMode) {
                        case 'connection':
                            generateCagedChordConnectionExercise();
                            break;
                        case 'random':
                            generateRandomCagedChordExercise();
                            break;
                        default:
                            generateCagedChordConnectionExercise();
                    }
                } catch (error) {
                    console.error('ç”ŸæˆCAGEDå’Œå¼¦ç»ƒä¹ å¤±è´¥:', error);
                    updateStatusIndicator('CAGEDå’Œå¼¦ç»ƒä¹ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                }
            }

            // å•ä¸ªCAGEDå½¢çŠ¶å’Œå¼¦ç»ƒä¹ 
            function generateSingleCagedChordExercise() {
                const selectedShapes = window.cagedChordState.selectedShapes;
                if (selectedShapes.length === 0) {
                    console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•CAGEDå½¢çŠ¶');
                    return;
                }

                // é€‰æ‹©å½“å‰å½¢çŠ¶
                let currentShapeName = window.cagedChordState.currentShape;
                if (!selectedShapes.includes(currentShapeName)) {
                    currentShapeName = selectedShapes[0];
                    window.cagedChordState.currentShape = currentShapeName;
                }

                // è·å–æ ¹éŸ³
                let key = window.cagedChordState.currentKey;
                if (key === 'random') {
                    const keys = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                    key = keys[Math.floor(Math.random() * keys.length)];
                    window.cagedChordState.currentKey = key;
                }

                // è·å–å’Œå¼¦ç±»å‹
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }

                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰å’Œå¼¦ç±»å‹
                if (window.cagedChordState.isManualSwitch || !window.cagedChordState.isNewRound) {
                    if (window.cagedChordState.currentChordType) {
                        chordType = window.cagedChordState.currentChordType;
                        console.log('ä¿æŒå½“å‰å’Œå¼¦ç±»å‹:', chordType);
                    }
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©å’Œå¼¦ç±»å‹
                    window.cagedChordState.currentChordType = chordType;
                }
                
                // æ ‡è®°ä¸å†æ˜¯æ–°ä¸€è½®
                window.cagedChordState.isNewRound = false;
                
                // æ›´æ–°ç›®æ ‡éŸ³ç¨‹æ˜¾ç¤º
                const targetIntervalEl = document.getElementById('targetInterval');
                const chordSymbol = formatChordSymbol(key, chordType);
                targetIntervalEl.textContent = chordSymbol;
                
                // ç”ŸæˆCAGEDå’Œå¼¦åºåˆ—
                state.currentIntervals = [...chordTypes[chordType].intervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedChordState.currentShape;
                state.cagedKey = window.cagedChordState.currentKey;
                state.cagedPracticeType = window.cagedChordState.practiceType;
                state.chordType = chordType;
                
                displaySequence();
                
                // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedChordShapes();
                }
                
                // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
                generateCagedChordNextExercise();
                
            }

            // CAGEDå½¢çŠ¶è¿æ¥å’Œå¼¦ç»ƒä¹ 
            function generateCagedChordConnectionExercise() {
                const selectedShapes = window.cagedChordState.selectedShapes;
                if (selectedShapes.length === 0) {
                    console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•CAGEDå½¢çŠ¶');
                    return;
                }

                // é€‰æ‹©ä¸‹ä¸€ä¸ªå½¢çŠ¶
                let currentShapeName = window.cagedChordState.currentShape;
                const currentIndex = selectedShapes.indexOf(currentShapeName);
                const nextIndex = (currentIndex + 1) % selectedShapes.length;
                const nextShapeName = selectedShapes[nextIndex];
                
                window.cagedChordState.currentShape = nextShapeName;

                // è·å–æ ¹éŸ³
                let key = window.cagedChordState.currentKey;
                if (key === 'random') {
                    const keys = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                    key = keys[Math.floor(Math.random() * keys.length)];
                    window.cagedChordState.currentKey = key;
                }

                // è·å–å’Œå¼¦ç±»å‹
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }

                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰å’Œå¼¦ç±»å‹
                if (window.cagedChordState.isManualSwitch || !window.cagedChordState.isNewRound) {
                    if (window.cagedChordState.currentChordType) {
                        chordType = window.cagedChordState.currentChordType;
                        console.log('ä¿æŒå½“å‰å’Œå¼¦ç±»å‹:', chordType);
                    }
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©å’Œå¼¦ç±»å‹
                    window.cagedChordState.currentChordType = chordType;
                }
                
                // æ ‡è®°ä¸å†æ˜¯æ–°ä¸€è½®
                window.cagedChordState.isNewRound = false;
                
                // æ›´æ–°ç›®æ ‡éŸ³ç¨‹æ˜¾ç¤º
                const targetIntervalEl = document.getElementById('targetInterval');
                const chordSymbol = formatChordSymbol(key, chordType);
                targetIntervalEl.textContent = chordSymbol;
                
                // ç”ŸæˆCAGEDå’Œå¼¦åºåˆ—
                state.currentIntervals = [...chordTypes[chordType].intervals];
                state.cagedMode = true;
                state.cagedShape = window.cagedChordState.currentShape;
                state.cagedKey = window.cagedChordState.currentKey;
                state.cagedPracticeType = window.cagedChordState.practiceType;
                state.chordType = chordType;
                
                displaySequence();
                
                // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedChordShapes();
                }
                
                // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
                generateCagedChordNextExercise();
                
            }

            // éšæœºCAGEDå½¢çŠ¶å’Œå¼¦ç»ƒä¹ 
            function generateRandomCagedChordExercise() {
                const selectedShapes = window.cagedChordState.selectedShapes;
                if (selectedShapes.length === 0) {
                    console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•CAGEDå½¢çŠ¶');
                    return;
                }

                // éšæœºé€‰æ‹©å½¢çŠ¶
                const randomShapeName = selectedShapes[Math.floor(Math.random() * selectedShapes.length)];
                window.cagedChordState.currentShape = randomShapeName;

                // è·å–æ ¹éŸ³
                let key = window.cagedChordState.currentKey;
                if (key === 'random') {
                    const keys = ['C', 'Câ™¯', 'D', 'Dâ™¯', 'E', 'F', 'Fâ™¯', 'G', 'Gâ™¯', 'A', 'Aâ™¯', 'B'];
                    key = keys[Math.floor(Math.random() * keys.length)];
                }
                
                // æ›´æ–°CAGEDçŠ¶æ€ä¸­çš„è°ƒæ€§ï¼ˆä¿æŒåŒæ­¥ï¼‰
                window.cagedChordState.currentKey = key;
                
                // è·å–å’Œå¼¦ç±»å‹
                const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                let chordType = 'major';
                if (activeChordTypes.length > 0) {
                    const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                    chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                }

                // å¦‚æœæ˜¯æ‰‹åŠ¨åˆ‡æ¢æˆ–åœ¨åŒä¸€è½®ç»ƒä¹ ä¸­ï¼Œä¿æŒå½“å‰å’Œå¼¦ç±»å‹
                if (window.cagedChordState.isManualSwitch || !window.cagedChordState.isNewRound) {
                    if (window.cagedChordState.currentChordType) {
                        chordType = window.cagedChordState.currentChordType;
                        console.log('ä¿æŒå½“å‰å’Œå¼¦ç±»å‹:', chordType);
                    }
                } else {
                    // æ–°ä¸€è½®ç»ƒä¹ ï¼Œå¯ä»¥é‡æ–°é€‰æ‹©å’Œå¼¦ç±»å‹
                    window.cagedChordState.currentChordType = chordType;
                }
                
                // æ ‡è®°ä¸å†æ˜¯æ–°ä¸€è½®
                window.cagedChordState.isNewRound = false;
                
                // æ›´æ–°ç›®æ ‡éŸ³ç¨‹æ˜¾ç¤º
                const targetIntervalEl = document.getElementById('targetInterval');
                const chordSymbol = formatChordSymbol(key, chordType);
                targetIntervalEl.textContent = chordSymbol;
                
                // ç”ŸæˆCAGEDå’Œå¼¦åºåˆ—
                state.currentIntervals = [...chordTypes[chordType].intervals];
                state.cagedMode = true;
                state.cagedShape = randomShapeName;
                state.cagedKey = window.cagedChordState.currentKey;
                state.cagedPracticeType = window.cagedChordState.practiceType;
                state.chordType = chordType;
                
                displaySequence();
                
                // æ˜¾ç¤ºCAGEDå½¢çŠ¶é€‰æ‹©ç•Œé¢
                const cagedShapeDisplay = document.getElementById('cagedShapeDisplay');
                if (cagedShapeDisplay) {
                    cagedShapeDisplay.style.display = 'block';
                    updateCagedShapeButtons();
                    showOnlySelectedChordShapes();
                }
                
                // ç”ŸæˆCAGEDä¸‹ä¸€é¢˜é¢„è§ˆ
                generateCagedChordNextExercise();
                
            }

            // ç”ŸæˆCAGEDå’Œå¼¦ä¸‹ä¸€é¢˜é¢„è§ˆ
            function generateCagedChordNextExercise() {
                if (!window.cagedChordState || !window.cagedChordState.enabled) {
                    return;
                }
                
                const selectedShapes = window.cagedChordState.selectedShapes;
                const currentShape = window.cagedChordState.currentShape;
                const currentIndex = selectedShapes.indexOf(currentShape);
                
                // è·å–ä¸‹ä¸€ä¸ªå½¢çŠ¶
                let nextShapeName;
                if (window.cagedChordState.practiceMode === 'random') {
                    // éšæœºæ¨¡å¼ï¼šéšæœºé€‰æ‹©ä¸€ä¸ªå½¢çŠ¶
                    nextShapeName = selectedShapes[Math.floor(Math.random() * selectedShapes.length)];
                } else {
                    // å•ä¸ªå½¢çŠ¶æˆ–è¿æ¥æ¨¡å¼ï¼šæŒ‰é¡ºåºå¾ªç¯
                    const nextIndex = (currentIndex + 1) % selectedShapes.length;
                    nextShapeName = selectedShapes[nextIndex];
                }
                
                const nextShape = window.cagedSystem.shapes[nextShapeName];
                const key = window.cagedChordState.currentKey;
                const chordType = state.chordType || 'major';
                
                // è®¾ç½®ä¸‹ä¸€é¢˜ä¿¡æ¯
                const chordSymbol = formatChordSymbol(key, chordType);
                state.nextExerciseInfo = chordSymbol;
                state.nextExerciseIntervals = [...chordTypes[chordType].intervals];
                
                updateNextExerciseDisplay();
            }


            // ç”Ÿæˆå’Œå¼¦ç»ƒä¹ 
            function generateChordExercise() {
                try {
                    // æ£€æŸ¥æ˜¯å¦å¯ç”¨CAGEDå’Œå¼¦ç»ƒä¹ æ¨¡å¼
                    if (window.cagedChordState && window.cagedChordState.enabled) {
                        generateCagedChordExercise();
                        return;
                    }
                    
                    resetCagedModeState();
                    
                    // éšè—ä¹æ›²åæ˜¾ç¤º
                    const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                    if (songTitleDisplayEl) {
                        songTitleDisplayEl.style.display = 'none';
                    }
                    
                    // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œç¡®ä¿ä»å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹ç”Ÿæˆ
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // æ¸…é™¤ä¹‹å‰çš„å’Œå¼¦ç±»å‹
                    
                    if (state.isCustomChordMode && customChordSequence.querySelectorAll('.chord-item').length > 0) {
                        // ä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                        const chordItems = customChordSequence.querySelectorAll('.chord-item');
                        const chords = Array.from(chordItems).map(item => {
                            const root = item.querySelector('.remove-chord').dataset.root;
                            const type = item.querySelector('.remove-chord').dataset.type;
                            const bass = item.querySelector('.remove-chord').dataset.bass || 'root';
                            return { root, type, bass };
                        });

                        // æŒ‰é¡ºåºç»ƒä¹ è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                        const currentChordIndex = state.customChordIndex || 0;
                        const chord = chords[currentChordIndex];

                        state.rootNote = chord.root;
                        state.chordType = chord.type;
                        state.bassNote = chord.bass || 'root';
                        
                        // æ£€æŸ¥å’Œå¼¦ç±»å‹æ˜¯å¦å­˜åœ¨
                        if (!chordTypes[state.chordType]) {
                            throw new Error(`æœªçŸ¥çš„å’Œå¼¦ç±»å‹: ${state.chordType}`);
                        }
                        
                        state.currentIntervals = [...chordTypes[state.chordType].intervals];
                        
                        // å¤„ç†è½¬ä½å’Œå¼¦
                        if (state.bassNote !== 'root') {
                            state.currentIntervals = applyChordInversion(state.currentIntervals, state.bassNote);
                        }

                    // å¤„ç†è½¬ä½å’Œå¼¦
                    const bassNoteSelect = document.getElementById('chordBassNote');
                    if (bassNoteSelect) {
                        const bassNote = bassNoteSelect.value;
                        if (bassNote !== 'root') {
                            state.currentIntervals = applyChordInversion(state.currentIntervals, bassNote);
                        }
                    }

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // ä¸‹è¡Œæ¨¡å¼ï¼šå€’åºæ’åˆ—
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    // è·å–è½¬ä½å’Œå¼¦åç§°
                    const bassNote = state.bassNote || (bassNoteSelect ? bassNoteSelect.value : 'root');
                    const chordSymbol = getInversionChordName(state.rootNote, state.chordType, bassNote);
                    // åªæ˜¾ç¤ºå’Œå¼¦åç§°ï¼Œä¸æ˜¾ç¤ºéŸ³çº§ç»“æ„
                    targetIntervalEl.textContent = chordSymbol;
                    targetIntervalEl.innerHTML = chordSymbol; // ç¡®ä¿åªæ˜¾ç¤ºå’Œå¼¦åç§°
                    displaySequence();

                    // è®¾ç½®ä¸‹ä¸€ä¸ªå’Œå¼¦ä¸ºåºåˆ—ä¸­çš„ä¸‹ä¸€ä¸ª
                    const nextIndex = (currentChordIndex + 1) % chords.length;
                    state.customChordIndex = nextIndex;
                    const nextChord = chords[nextIndex];

                    state.nextExerciseInfo = formatChordSymbol(nextChord.root, nextChord.type);                    state.nextExerciseIntervals = [...chordTypes[nextChord.type].intervals];
                    updateNextExerciseDisplay();
                } else {
                    // ä½¿ç”¨åŸå§‹å’Œå¼¦ç”Ÿæˆé€»è¾‘
                    state.customChordIndex = null;
                    originalGenerateChordExercise();
                }
                } catch (error) {
                    console.error('ç”Ÿæˆå’Œå¼¦ç»ƒä¹ å¤±è´¥:', error);
                    updateStatusIndicator('å’Œå¼¦ç»ƒä¹ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                    // å›é€€åˆ°é»˜è®¤å’Œå¼¦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // æ˜¾ç¤ºéŸ³é˜¶/å’Œå¼¦åºåˆ—
            function displaySequence() {
                console.log('displaySequenceè°ƒç”¨ - currentIntervals:', state.currentIntervals);
                
                const fragment = document.createDocumentFragment();
                state.currentSequence = [];

                // æ£€æŸ¥currentIntervalsæ˜¯å¦ä¸ºç©º
                if (!state.currentIntervals || state.currentIntervals.length === 0) {
                    console.error('displaySequence: currentIntervalsä¸ºç©ºæˆ–æœªå®šä¹‰', {
                        currentIntervals: state.currentIntervals,
                        rootNote: state.rootNote,
                        scaleType: state.scaleType,
                        chordType: state.chordType
                    });
                    return;
                }

                // ç›´æ¥ä½¿ç”¨åŸå§‹éŸ³ç¨‹è¿›è¡Œæ˜¾ç¤ºï¼ˆä¿æŒå¤åˆéŸ³ç¨‹9ã€11ã€13ç­‰ï¼‰
                state.currentIntervals.forEach((interval, index) => {
                    const span = document.createElement('div');
                    span.className = 'sequence-item';
                    if (index === 0) span.classList.add('current');
                    span.textContent = interval;
                    span.dataset.index = index;
                    fragment.appendChild(span);
                    state.currentSequence.push(interval);
                });

                sequenceDisplayEl.innerHTML = '';
                sequenceDisplayEl.appendChild(fragment);
            }

            // å¯åŠ¨èŠ‚æ‹å™¨
            function startMetronome() {
                if (state.metronomeInterval) {
                    stopMetronome();
                }

                if (!state.metronomeEnabled) return;

                const beatInterval = 60000 / state.metronomeTempo;

                document.documentElement.style.setProperty('--metronome-speed', `${beatInterval}ms`);

                if (practiceScreen.style.display === 'flex') {
                    practiceScreen.classList.add('metronome-active');
                }

                state.metronomeInterval = setInterval(() => {
                    // èƒŒæ™¯é—ªå…‰æ•ˆæœ
                    if (state.metronomeFlashEnabled) {
                        practiceScreen.classList.add('metronome-flash');
                        setTimeout(() => {
                            practiceScreen.classList.remove('metronome-flash');
                        }, 300);
                    }

                    // æ’­æ”¾èŠ‚æ‹å™¨å£°éŸ³
                    if (state.metronomeSoundEnabled && audioContext) {
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 892; //è¿œç¦»ä¸€èˆ¬ä¹éŸ³ï¼Œé¿å…å¹²æ‰°
                        gainNode.gain.value = 0.1;
                        oscillator.start();
                        oscillator.stop(audioContext.currentTime + 0.05);
                    }
                }, beatInterval);
            }

            // åœæ­¢èŠ‚æ‹å™¨
            function stopMetronome() {
                if (state.metronomeInterval) {
                    clearInterval(state.metronomeInterval);
                    state.metronomeInterval = null;
                }

                practiceScreen.classList.remove('metronome-active');
                practiceScreen.classList.remove('metronome-flash');
            }

            // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬å™¨
            function initEventListeners() {
                // éŸ³é¢‘è®¾å¤‡é€‰æ‹©äº‹ä»¶
                audioInputDeviceEl.addEventListener('change', function () {
                    selectedDeviceId = this.value;
                    if (isRecording) {
                        restartAudioWithNewDevice();
                    }
                    // ä¿å­˜è®¾ç½®
                    saveSettings();
                    console.log('éŸ³é¢‘è®¾å¤‡å·²ä¿å­˜åˆ°localStorage:', selectedDeviceId);
                });

                // è¾“å…¥å¢ç›Šæ§åˆ¶
                inputGainEl.addEventListener('input', function () {
                    inputGain = this.value / 100;
                    inputGainValueEl.textContent = this.value + '%';

                    if (gainNode) {
                        gainNode.gain.value = inputGain;
                    }
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // åˆ·æ–°è®¾å¤‡åˆ—è¡¨
                refreshDevicesBtn.addEventListener('click', function () {
                    getAudioDevices();
                    updateStatusIndicator('æ­£åœ¨åˆ·æ–°è®¾å¤‡åˆ—è¡¨...', 'ready');
                    setTimeout(() => {
                        updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                    }, 1000);
                });

                // æ­Œæ›²é€‰æ‹©äº‹ä»¶ç›‘å¬å™¨
                const jazzStandardEl = document.getElementById('jazzStandard');
                if (jazzStandardEl) {
                    jazzStandardEl.addEventListener('change', function() {
                        const selectedSong = this.value;
                        if (selectedSong) {
                            updateKeySelector(selectedSong);
                        }
                    });
                }

                // èŠ‚æ‹å™¨å¼€å…³äº‹ä»¶
                metronomeToggleEl.addEventListener('change', function () {
                    state.metronomeEnabled = this.checked;
                    if (state.metronomeEnabled && practiceScreen.style.display === 'flex') {
                        startMetronome();
                    } else {
                        stopMetronome();
                    }
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // èŠ‚æ‹å™¨é€Ÿåº¦æ»‘å—äº‹ä»¶
                metronomeTempoEl.addEventListener('input', function () {
                    state.metronomeTempo = parseInt(this.value);
                    metronomeTempoValueEl.textContent = state.metronomeTempo;

                    if (state.metronomeEnabled && state.metronomeInterval) {
                        startMetronome();
                    }
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // èŠ‚æ‹å™¨èƒŒæ™¯é—ªå…‰å¼€å…³äº‹ä»¶
                metronomeFlashToggleEl.addEventListener('change', function () {
                    state.metronomeFlashEnabled = this.checked;
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // èŠ‚æ‹å™¨å£°éŸ³å¼€å…³äº‹ä»¶
                metronomeSoundToggleEl.addEventListener('change', function () {
                    state.metronomeSoundEnabled = this.checked;
                    saveSettings(); // ä¿å­˜è®¾ç½®
                });

                // å†·å´æ—¶é—´å¼€å…³äº‹ä»¶
                const enableCooldownEl = document.getElementById('enableCooldown');
                if (enableCooldownEl) {
                    enableCooldownEl.addEventListener('change', function () {
                        state.enableCooldown = this.checked;
                        console.log('å†·å´æ—¶é—´åŠŸèƒ½:', this.checked ? 'å·²å¯ç”¨' : 'å·²å…³é—­');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // å†·å´æ—¶é—´æ»‘å—äº‹ä»¶
                const cooldownDurationEl = document.getElementById('cooldownDuration');
                const cooldownDurationValueEl = document.getElementById('cooldownDurationValue');
                if (cooldownDurationEl && cooldownDurationValueEl) {
                    cooldownDurationEl.addEventListener('input', function () {
                        state.cooldownDuration = parseInt(this.value);
                        cooldownDurationValueEl.textContent = state.cooldownDuration + 'ms';
                        console.log('å†·å´æ—¶é—´è®¾ç½®ä¸º:', state.cooldownDuration + 'ms');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // å›ºå®šå»¶è¿Ÿç”Ÿæˆå¼€å…³äº‹ä»¶
                const enableFixedDelayEl = document.getElementById('enableFixedDelay');
                if (enableFixedDelayEl) {
                    enableFixedDelayEl.addEventListener('change', function () {
                        state.enableFixedDelay = this.checked;
                        console.log('å›ºå®šå»¶è¿Ÿç”ŸæˆåŠŸèƒ½:', this.checked ? 'å·²å¯ç”¨' : 'å·²å…³é—­');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // å›ºå®šå»¶è¿Ÿæ—¶é—´æ»‘å—äº‹ä»¶
                const fixedDelayDurationEl = document.getElementById('fixedDelayDuration');
                const fixedDelayDurationValueEl = document.getElementById('fixedDelayDurationValue');
                if (fixedDelayDurationEl && fixedDelayDurationValueEl) {
                    fixedDelayDurationEl.addEventListener('input', function () {
                        state.fixedDelayDuration = parseInt(this.value);
                        fixedDelayDurationValueEl.textContent = state.fixedDelayDuration + 'ms';
                        console.log('å›ºå®šå»¶è¿Ÿæ—¶é—´è®¾ç½®ä¸º:', state.fixedDelayDuration + 'ms');
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // éŸ³é«˜æ£€æµ‹æ•æ„Ÿåº¦æ»‘å—äº‹ä»¶
                const sensitivityEl = document.getElementById('sensitivity');
                const sensitivityValueEl = document.getElementById('sensitivityValue');
                if (sensitivityEl && sensitivityValueEl) {
                    sensitivityEl.addEventListener('input', function () {
                        state.sensitivity = parseFloat(this.value);
                        sensitivityValueEl.textContent = state.sensitivity.toFixed(1);
                        console.log('éŸ³é«˜æ£€æµ‹æ•æ„Ÿåº¦è®¾ç½®ä¸º:', state.sensitivity);
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }

                // ç½®ä¿¡åº¦é˜ˆå€¼æ»‘å—äº‹ä»¶
                const confidenceThresholdEl = document.getElementById('confidenceThreshold');
                const confidenceThresholdValueEl = document.getElementById('confidenceThresholdValue');
                if (confidenceThresholdEl && confidenceThresholdValueEl) {
                    confidenceThresholdEl.addEventListener('input', function () {
                        state.confidenceThreshold = parseFloat(this.value);
                        confidenceThresholdValueEl.textContent = state.confidenceThreshold.toFixed(1);
                        console.log('ç½®ä¿¡åº¦é˜ˆå€¼è®¾ç½®ä¸º:', state.confidenceThreshold);
                        saveSettings(); // ä¿å­˜è®¾ç½®
                    });
                }
                
                // é‡ç½®è®¾ç½®æŒ‰é’®äº‹ä»¶
                const resetSettingsBtn = document.getElementById('resetSettingsBtn');
                if (resetSettingsBtn) {
                    resetSettingsBtn.addEventListener('click', function () {
                        resetSettings();
                    });
                }

                // å¼€å§‹ç»ƒä¹ æŒ‰é’®
                startBtn.addEventListener('click', function () {
                    console.log('å¼€å§‹ç»ƒä¹ æŒ‰é’®è¢«ç‚¹å‡»');
                    const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                    console.log('å½“å‰é€‰æ‹©çš„æ ‡ç­¾é¡µ:', activeTab);
                    
                    // éªŒè¯å’Œå¼¦è®¾ç½®
                    if (activeTab === 'chord') {
                        // useCustomChords å¼€å…³å·²ç§»é™¤ï¼Œç›´æ¥æ£€æŸ¥å’Œå¼¦ç±»å‹
                        if (!state.isCustomChordMode) {
                            const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                            if (activeChordTypes.length === 0) {
                                alert('è¯·å…ˆé€‰æ‹©è‡³å°‘ä¸€ä¸ªå’Œå¼¦ç±»å‹ï¼');
                                return;
                            }
                        } else {
                            const customChordItems = document.querySelectorAll('#customChordSequence .chord-item');
                            if (customChordItems.length === 0) {
                                alert('è¯·å…ˆæ·»åŠ è‡³å°‘ä¸€ä¸ªè‡ªå®šä¹‰å’Œå¼¦ï¼');
                                return;
                            }
                        }
                    }

                    // éªŒè¯éŸ³é˜¶è®¾ç½®
                    if (activeTab === 'scale') {
                        // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†è°ƒå¼
                        if (window.ScaleTypeManager && window.ScaleTypeManager.selectedScales.size === 0) {
                            alert('è¯·é€‰æ‹©è¦ç»ƒä¹ çš„è°ƒå¼ï¼');
                            return;
                        }
                    }
                    
                    updateStatusIndicator('æ­£åœ¨å¯åŠ¨éº¦å…‹é£...', 'recording');

                    // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒgetUserMedia
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        console.error('æµè§ˆå™¨ä¸æ”¯æŒgetUserMedia');
                        updateStatusIndicator('æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£è®¿é—®', 'error');
                        return;
                    }
                    
                    console.log('æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(function (stream) {
                            console.log('éº¦å…‹é£æƒé™è·å–æˆåŠŸï¼ŒéŸ³é¢‘æµ:', stream);
                            mediaStream = stream;

                            mainScreen.style.display = 'none';
                            practiceScreen.style.display = 'flex';
                            document.getElementById('pitchDisplay').style.display = 'block';

                            requestWakeLock();

                            state.nextExerciseInfo = '';
                            state.nextExerciseIntervals = [];

                            // æ ¹æ®æ ‡ç­¾é¡µç±»å‹ç”Ÿæˆç›¸åº”çš„ç»ƒä¹ 
                            if (activeTab === 'pitch-finding') {
                                const practiceMode = document.querySelector('.practice-mode-btn.active');
                                
                                if (practiceMode && practiceMode.dataset.mode === 'interval') {
                                    // éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                                    generateIntervalExercise();
                                } else {
                                    // å•éŸ³ç»ƒä¹ æ¨¡å¼
                                    generatePitchFindingExercise();
                                }
                            } else {
                                // å…¶ä»–ç»ƒä¹ æ¨¡å¼
                            generateExercise();
                            }

                            console.log('å¼€å§‹å½•éŸ³...');
                            startRecording();

                            state.metronomeEnabled = document.getElementById('metronomeToggle').checked;
                            state.metronomeTempo = parseInt(document.getElementById('metronomeTempo').value);
                            state.metronomeFlashEnabled = document.getElementById('metronomeFlashToggle').checked;
                            state.metronomeSoundEnabled = document.getElementById('metronomeSoundToggle').checked;

                            if (state.metronomeEnabled) {
                                startMetronome();
                                practiceScreen.classList.add('metronome-active');
                            }
                        })
                        .catch(function (err) {
                            console.error('éº¦å…‹é£è·å–å¤±è´¥:', err);
                            console.error('é”™è¯¯ç±»å‹:', err.name);
                            console.error('é”™è¯¯ä¿¡æ¯:', err.message);

                            updateStatusIndicator('æœªè·å–å½•éŸ³æƒé™', 'error');

                            const errorMessage = document.createElement('div');
                            errorMessage.style.position = 'fixed';
                            errorMessage.style.top = '50%';
                            errorMessage.style.left = '50%';
                            errorMessage.style.transform = 'translate(-50%, -50%)';
                            errorMessage.style.background = 'rgba(239, 68, 68, 0.9)';
                            errorMessage.style.color = 'white';
                            errorMessage.style.padding = '20px';
                            errorMessage.style.borderRadius = '10px';
                            errorMessage.style.zIndex = '2000';
                            errorMessage.style.maxWidth = '80%';
                            errorMessage.style.textAlign = 'center';
                            errorMessage.innerHTML = `
                                <h3 style="margin-bottom: 10px; font-size: 18px;" data-i18n-key="mic_permission_denied">éº¦å…‹é£æƒé™è¢«æ‹’ç»</h3>
                                <p style="margin-bottom: 15px;" data-i18n-key="mic_permission_needed">æ­¤åº”ç”¨éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½æ£€æµ‹éŸ³é«˜ã€‚</p>
                                <p data-i18n-key="mic_permission_steps">è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š</p>
                                <ol style="text-align: left; margin: 15px 0; padding-left: 20px;">
                                    <li data-i18n-key="mic_step_1">ç‚¹å‡»æµè§ˆå™¨åœ°å€æ å·¦ä¾§çš„é”å®š/ä¿¡æ¯å›¾æ ‡</li>
                                    <li data-i18n-key="mic_step_2">åœ¨å¼¹å‡ºçš„èœå•ä¸­æ‰¾åˆ°"éº¦å…‹é£"é€‰é¡¹</li>
                                    <li data-i18n-key="mic_step_3">å°†å…¶è®¾ç½®ä¸º"å…è®¸"</li>
                                    <li data-i18n-key="mic_step_4">åˆ·æ–°é¡µé¢åé‡è¯•</li>
                                </ol>
                                <div style="display: flex; justify-content: space-between; margin-top: 15px;">
                                    <button id="refreshPage" style="padding: 8px 16px; background: #3a9fc4; border: none; border-radius: 5px; color: white; cursor: pointer;" data-i18n-key="refresh_page">åˆ·æ–°é¡µé¢</button>
                                    <button id="returnToMain" style="padding: 8px 16px; background: #6c757d; border: none; border-radius: 5px; color: white; cursor: pointer;" data-i18n-key="return_to_main">è¿”å›ä¸»èœå•</button>
                                </div>
                            `;
                            document.body.appendChild(errorMessage);

                            document.getElementById('refreshPage').addEventListener('click', function() {
                                location.reload();
                            });
                            
                            document.getElementById('returnToMain').addEventListener('click', function () {
                                document.body.removeChild(errorMessage);
                                updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                            });
                        });
                });

                // åº•éƒ¨å¯¼èˆªæ åˆ‡æ¢
                const bottomNavItems = document.querySelectorAll('.nav-item');
                bottomNavItems.forEach(item => {
                    item.addEventListener('click', function () {
                        const tabName = this.dataset.tab;

                        // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„activeçŠ¶æ€
                        bottomNavItems.forEach(navItem => navItem.classList.remove('active'));
                        // ä¸ºå½“å‰ç‚¹å‡»çš„å¯¼èˆªé¡¹æ·»åŠ activeçŠ¶æ€
                        this.classList.add('active');

                        // é»˜è®¤éšè—æ‰€æœ‰è®¾ç½®åŒºåŸŸ
                        scaleSettings.style.display = 'none';
                        chordSettings.style.display = 'none';
                        progressionSettings.style.display = 'none';
                        deviceSettings.style.display = 'none';
                        const pitchFindingSettings = document.querySelector('.pitch-finding-settings');
                        if (pitchFindingSettings) {
                            pitchFindingSettings.style.display = 'none';
                        }
                                const cagedChordSettingsSection = document.querySelector('.caged-chord-settings-section');
                        if (cagedChordSettingsSection) {
                            cagedChordSettingsSection.style.display = 'none';
                        }
                        const cagedSettingsSection = document.querySelector('.caged-settings-section');
                        if (cagedSettingsSection) {
                            cagedSettingsSection.style.display = 'none';
                        }

                        // æ ¹æ®æ ‡ç­¾é¡µæ˜¾ç¤ºå¯¹åº”è®¾ç½®
                        if (tabName === 'scale') {
                            scaleSettings.style.display = 'block';
                            if (cagedSettingsSection) {
                                cagedSettingsSection.style.display = 'block';
                            }
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤º
                            updateArpeggioButtons();
                        } else if (tabName === 'chord') {
                            chordSettings.style.display = 'block';
                            const cagedChordSettingsSection = document.querySelector('.caged-chord-settings-section');
                            if (cagedChordSettingsSection) {
                                cagedChordSettingsSection.style.display = 'block';
                            }
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿ç§»é™¤åŠ¨æ€æŒ‰é’®
                            updateArpeggioButtons();
                        } else if (tabName === 'progression') {
                            progressionSettings.style.display = 'block';
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿ç§»é™¤åŠ¨æ€æŒ‰é’®
                            updateArpeggioButtons();
                        } else if (tabName === 'pitch-finding') {
                            if (pitchFindingSettings) {
                                pitchFindingSettings.style.display = 'block';
                            }
                        } else if (tabName === 'device') {
                            deviceSettings.style.display = 'block';
                            // æ›´æ–°éŸ³é˜¶ç»ƒä¹ æŒ‰é’®æ˜¾ç¤ºï¼Œç¡®ä¿ç§»é™¤åŠ¨æ€æŒ‰é’®
                            updateArpeggioButtons();
                        }
                        
                        // æ§åˆ¶å¼€å§‹ç»ƒä¹ æŒ‰é’®çš„æ˜¾ç¤º
                        const controls = document.querySelector('.controls');
                        if (controls) {
                            // åœ¨è®¾ç½®æ ‡ç­¾é¡µä¸­éšè—å¼€å§‹ç»ƒä¹ æŒ‰é’®
                            if (tabName === 'device') {
                                controls.style.display = 'none';
                            } else {
                                controls.style.display = 'flex';
                            }
                        }
                    });
                });

                // åˆå§‹åŒ–æ˜¾ç¤ºéŸ³é˜¶è®¾ç½®ï¼ˆå¦‚æœæ˜¯éŸ³é˜¶ç»ƒä¹ æ ‡ç­¾é¡µï¼‰
                const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                if (activeTab === 'scale') {
                    scaleSettings.style.display = 'block';
                    const cagedSettingsSection = document.querySelector('.caged-settings-section');
                    if (cagedSettingsSection) {
                        cagedSettingsSection.style.display = 'block';
                    }
                }
                
                // åˆå§‹åŒ–æ—¶æ ¹æ®é»˜è®¤é€‰ä¸­çš„æ ‡ç­¾é¡µæ¥æ§åˆ¶æŒ‰é’®çš„æ˜¾ç¤º
                const controls = document.querySelector('.controls');
                if (controls) {
                    // åœ¨è®¾ç½®æ ‡ç­¾é¡µä¸­éšè—å¼€å§‹ç»ƒä¹ æŒ‰é’®
                    if (activeTab === 'device') {
                        controls.style.display = 'none';
                    } else {
                        controls.style.display = 'flex';
                    }
                }

                // å’Œå¼¦ç±»å‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                // å®šä¹‰åˆ‡æ¢å’Œå¼¦ç±»å‹çš„å‡½æ•°
                function toggleChordType() {
                        this.classList.toggle('active');
                    console.log('å’Œå¼¦ç±»å‹æŒ‰é’®è¢«ç‚¹å‡»:', this.dataset.value, this.classList.contains('active') ? 'å·²æ¿€æ´»' : 'å·²å–æ¶ˆ');
                }
                
                chordTypeBtns.forEach(btn => {
                    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
                    btn.removeEventListener('click', toggleChordType);
                    // æ·»åŠ æ–°çš„ç›‘å¬å™¨
                    btn.addEventListener('click', toggleChordType);
                });

                // éŸ³é˜¶é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const scaleOrderBtns = document.querySelectorAll('.scale-order-btn');
                scaleOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // ç»ƒä¹ åºåˆ—æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const scaleArpeggioBtns = document.querySelectorAll('.scale-arpeggio-btn');
                scaleArpeggioBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        scaleArpeggioBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // å½“æŒ‰é’®è¢«ç‚¹å‡»æ—¶ï¼Œæ›´æ–°æŒ‰é’®æ˜¾ç¤ºä»¥åæ˜ å½“å‰éŸ³é˜¶
                        updateArpeggioButtons();
                    });
                });

                // å’Œå¼¦é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const chordOrderBtns = document.querySelectorAll('.chord-order-btn');
                chordOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        chordOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // å’Œå¼¦åæ˜¾ç¤ºæ¨¡å¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const chordNameDisplayBtns = document.querySelectorAll('.chord-name-display-btn');
                chordNameDisplayBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        chordNameDisplayBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // æ›´æ–°çŠ¶æ€
                        state.chordNameDisplayMode = this.dataset.value;
                        
                        // æ›´æ–°å’Œå¼¦ç±»å‹æŒ‰é’®çš„æ˜¾ç¤ºæ–‡æœ¬
                        updateChordTypeButtonTexts();
                        
                        // é‡æ–°ç”Ÿæˆå½“å‰ç»ƒä¹ ä»¥åº”ç”¨æ–°çš„æ˜¾ç¤ºæ¨¡å¼
                        const activeTab = document.querySelector('.nav-item.active').dataset.tab;
                        if (activeTab === 'chord') {
                            generateChordExercise();
                        } else if (activeTab === 'progression') {
                            generateProgressionExercise();
                        }
                        
                        // ä¿å­˜è®¾ç½®
                        saveSettings();
                    });
                });

                // å’Œå¼¦è½¬æ¢é¡ºåºæŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const progressionOrderBtns = document.querySelectorAll('.progression-order-btn');
                progressionOrderBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        progressionOrderBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿é•¿åº¦æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const pitchFindingRangeBtns = document.querySelectorAll('.pitch-finding-range-btn');
                pitchFindingRangeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        pitchFindingRangeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        // å¦‚æœå½“å‰åœ¨æ‰¾éŸ³ç»ƒä¹ æ¨¡å¼ä¸”æŒ‡æ¿å·²æ˜¾ç¤ºï¼Œé‡æ–°åˆ›å»ºæŒ‡æ¿
                        if (state.pitchFindingMode && document.getElementById('fretboardContainer').style.display !== 'none') {
                            createFretboard();
                        }
                    });
                });

                // æ‰¾éŸ³ç»ƒä¹ ä¸‹ä¸€é¢˜é—´éš”æ—¶é—´æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const pitchFindingIntervalBtns = document.querySelectorAll('.pitch-finding-interval-btn');
                pitchFindingIntervalBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        pitchFindingIntervalBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    });
                });

                // æ‰¾éŸ³ç»ƒä¹ ä¸‹ä¸€é¢˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const pitchFindingNextBtn = document.getElementById('pitchFindingNextBtn');
                if (pitchFindingNextBtn) {
                    pitchFindingNextBtn.addEventListener('click', function (event) {
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘é€€å‡ºç»ƒä¹ çš„é€»è¾‘
                        event.stopPropagation();
                        event.preventDefault();
                        
                        // æ£€æŸ¥å½“å‰ç»ƒä¹ æ¨¡å¼
                        const practiceMode = document.querySelector('.practice-mode-btn.active');
                        if (practiceMode && practiceMode.dataset.mode === 'interval') {
                            // éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                            generateNextIntervalExercise();
                        } else {
                            // å•éŸ³ç»ƒä¹ æ¨¡å¼
                            generateNextPitchFindingQuestion();
                        }
                    });
                }

                // ç»ƒä¹ æ¨¡å¼æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const practiceModeBtns = document.querySelectorAll('.practice-mode-btn');
                practiceModeBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        practiceModeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        
                        const mode = this.dataset.mode;
                        const intervalSettings = document.getElementById('intervalSettings');
                        
                        if (mode === 'interval') {
                            intervalSettings.style.display = 'block';
                        } else {
                            intervalSettings.style.display = 'none';
                        }
                    });
                });


                // éŸ³ç¨‹é€‰æ‹©æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                const intervalBtns = document.querySelectorAll('.interval-btn');
                intervalBtns.forEach(btn => {
                    btn.addEventListener('click', function () {
                        this.classList.toggle('active');
                    });
                });

                // æ·»åŠ ç¼ºå¤±çš„å˜é‡å’Œå‡½æ•°
                const noteToSemitones = {
                    'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4, 
                    'F': 5, 'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8, 
                    'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
                };
                
                const intervalToSemitones = {
                    '1': 0, 'â™­2': 1, '2': 2, 'â™¯2': 3, 'â™­3': 3, '3': 4, '4': 5,
                    'â™¯4': 6, 'â™­5': 6, '5': 7, 'â™¯5': 8, 'â™­6': 8, '6': 9, 'â™¯6': 10,
                    'â™­7': 10, '7': 11, 'â™­â™­7': 10, 
                    // å¤åˆéŸ³ç¨‹æ˜ å°„ï¼ˆ9=2, 11=4, 13=6ï¼‰
                    'â™­9': 1, '9': 2, 'â™¯9': 3,
                    '11': 4, 'â™¯11': 6, 
                    'â™­13': 8, '13': 9
                };
                
                // éŸ³ç¨‹ç»ƒä¹ ç›¸å…³å‡½æ•°
                function generateIntervalExercise() {
                    resetCagedModeState();

                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (state.intervalNextTimeout) {
                        clearTimeout(state.intervalNextTimeout);
                        state.intervalNextTimeout = null;
                    }

                    // è®¾ç½®éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                    window.state.intervalExerciseMode = true;
                    window.state.pitchFindingMode = false;

                    // éšè—ä¹æ›²åæ˜¾ç¤º
                    const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                    if (songTitleDisplayEl) {
                        songTitleDisplayEl.style.display = 'none';
                    }
                    
                    // æ¸…ç†sequence-itemçš„CSSçŠ¶æ€
                    const sequenceItems = document.querySelectorAll('.sequence-item');
                    sequenceItems.forEach(item => {
                        item.classList.remove('current');
                        item.style.width = '';
                        item.style.flex = '';
                        item.style.maxWidth = '';
                    });
                    
                    // å…ˆæ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†éŸ³ç¨‹
                    const selectedIntervals = Array.from(document.querySelectorAll('.interval-btn.active'))
                        .map(btn => btn.dataset.interval);
                    
                    if (selectedIntervals.length === 0) {
                        alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªéŸ³ç¨‹è¿›è¡Œç»ƒä¹ ï¼');
                        // é‡ç½®ç»ƒä¹ æ¨¡å¼çŠ¶æ€
                        state.cagedMode = false;
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;
                        console.log('éŸ³ç¨‹ç»ƒä¹ é€€å‡º - é‡ç½®ç»ƒä¹ æ¨¡å¼çŠ¶æ€');
                        // åœæ­¢å½•éŸ³å¹¶è¿”å›ä¸»é¡µé¢
                        stopRecording();
                        practiceScreen.style.display = 'none';
                        mainScreen.style.display = 'block';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        return;
                    }
                    
                    // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨çŠ¶æ€
                    if (state.pitchFindingTimer) {
                        clearInterval(state.pitchFindingTimer);
                        state.pitchFindingTimer = null;
                    }
                    
                    // æ˜¾ç¤ºéŸ³ç¨‹ç»ƒä¹ ç•Œé¢
                    document.getElementById('pitchFindingElements').style.display = 'block';
                    
                    // éšè—å…¶ä»–ç»ƒä¹ å…ƒç´ 
                    document.getElementById('targetInterval').style.display = 'none';
                    document.getElementById('sequenceDisplay').style.display = 'none';
                    document.getElementById('nextExercise').style.display = 'none';
                    
                    // éšè—ç»ƒä¹ å®¹å™¨ï¼Œå› ä¸ºéŸ³ç¨‹ç»ƒä¹ æœ‰è‡ªå·±çš„ç•Œé¢
                    const intervalExerciseContainer = document.querySelector('.exercise-container');
                    if (intervalExerciseContainer) {
                        intervalExerciseContainer.style.display = 'none';
                    }
                    
                    // è·å–æŒ‡æ¿è®¾ç½®
                    const showFretboard = document.getElementById('showFretboard').checked;
                    
                    // æ˜¾ç¤ºæˆ–éšè—æŒ‡æ¿
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    const fretboardFooter = document.getElementById('fretboardFooter');
                    if (showFretboard) {
                        fretboardContainer.style.display = 'block';
                        fretboardFooter.style.display = 'block';
                        createFretboard();
                    } else {
                        fretboardContainer.style.display = 'none';
                        fretboardFooter.style.display = 'none';
                    }
                    
                    // æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
                    document.querySelector('.pitch-finding-next-btn-container').style.display = 'flex';
                    
                    // éšè—next-exerciseå®¹å™¨
                    const nextExerciseContainer = document.querySelector('.next-exercise');
                    if (nextExerciseContainer) {
                        nextExerciseContainer.style.display = 'none';
                    }
                    const exerciseContainer = document.querySelector('.exercise-container');
                    if (exerciseContainer) {
                        exerciseContainer.style.display = 'none';
                    }
                    
                    // è·å–æ ¹éŸ³è®¾ç½®
                    const rootNoteSelect = document.getElementById('rootNoteSelect');
                    let selectedRootNote = rootNoteSelect.value;
                    
                    // å¦‚æœæ˜¯éšæœºï¼Œåˆ™éšæœºé€‰æ‹©ä¸€ä¸ªæ ¹éŸ³
                    if (selectedRootNote === 'random') {
                        const allNotes = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                        selectedRootNote = allNotes[Math.floor(Math.random() * allNotes.length)];
                    }
                    
                    // è·å–æ˜¯å¦å…ˆæ‰¾æ ¹éŸ³
                    const findRootFirst = document.getElementById('findRootFirst').checked;
                    
                    // ç”Ÿæˆé¢˜ç›®
                    let exerciseIntervals = [];
                    let currentInterval = '';
                    
                    if (findRootFirst) {
                        // å…ˆæ‰¾æ ¹éŸ³ï¼šç”Ÿæˆ 1 + å…¶ä»–éŸ³ç¨‹ çš„ç»„åˆ
                        exerciseIntervals = selectedIntervals;
                        // éšæœºé€‰æ‹©ä¸€ä¸ªéŸ³ç¨‹ä¸1é…å¯¹
                        const randomInterval = selectedIntervals[Math.floor(Math.random() * selectedIntervals.length)];
                        currentInterval = `1 ${randomInterval}`;
                    } else {
                        // ä¸å…ˆæ‰¾æ ¹éŸ³ï¼šä»é€‰ä¸­çš„éŸ³ç¨‹ä¸­éšæœºé€‰æ‹©ä¸¤ä¸ªé…å¯¹
                        exerciseIntervals = selectedIntervals;
                        if (selectedIntervals.length >= 2) {
                            // éšæœºé€‰æ‹©ä¸¤ä¸ªä¸åŒçš„éŸ³ç¨‹
                            const shuffled = [...selectedIntervals].sort(() => Math.random() - 0.5);
                            currentInterval = `${shuffled[0]} ${shuffled[1]}`;
                        } else {
                            // åªæœ‰ä¸€ä¸ªéŸ³ç¨‹ï¼Œé‡å¤æ˜¾ç¤º
                            currentInterval = `${selectedIntervals[0]} ${selectedIntervals[0]}`;
                        }
                    }
                    
                    // æ˜¾ç¤ºæ ¹éŸ³ä½œä¸ºå½“å‰éŸ³ç¬¦
                    const currentNoteDisplay = document.getElementById('currentNoteDisplay');
                    currentNoteDisplay.textContent = selectedRootNote;
                    
                    // ä¿å­˜å½“å‰ç»ƒä¹ çŠ¶æ€
                    state.currentIntervalExercise = {
                        intervals: exerciseIntervals,
                        currentInterval: currentInterval,
                        rootNote: selectedRootNote,
                        findRootFirst: findRootFirst,
                        answered: false,
                        completedIntervals: [] // è·Ÿè¸ªå·²å®Œæˆçš„éŸ³ç¨‹
                    };
                    
                    // æ˜¾ç¤ºéŸ³çº§ä¿¡æ¯
                    updateIntervalExerciseDisplay();
                    
                    // é‡ç½®å•éŸ³ç»ƒä¹ çŠ¶æ€ï¼Œé¿å…æ··æ·†
                    state.pitchFindingAnswered = false;
                    state.currentNote = null;
                    
                    // è®¾ç½®éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼æ ‡å¿—ï¼Œç¡®ä¿processAudioæ­£ç¡®è·¯ç”±
                    state.pitchFindingMode = true;
                    
                    // å¯åŠ¨éŸ³ç¨‹ç»ƒä¹ è®¡æ—¶å™¨
                    const practiceTimeSelect = document.getElementById('pitchFindingTime');
                    if (practiceTimeSelect) {
                        const minutes = parseInt(practiceTimeSelect.value);
                        startPitchFindingTimer(minutes);
                    }
                }
                
                // ç”Ÿæˆä¸‹ä¸€é¢˜éŸ³ç¨‹ç»ƒä¹ ï¼ˆä¸é‡æ–°å¯åŠ¨è®¡æ—¶å™¨ï¼‰
                function generateNextIntervalExercise() {
                    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                    if (state.intervalNextTimeout) {
                        clearTimeout(state.intervalNextTimeout);
                        state.intervalNextTimeout = null;
                    }

                    if (!state.currentIntervalExercise) return;
                    
                    const exercise = state.currentIntervalExercise;
                    const selectedIntervals = exercise.intervals.filter(interval => interval !== '1');
                    
                    // æ£€æŸ¥æ ¹éŸ³è®¾ç½®ï¼Œå¦‚æœæ˜¯éšæœºåˆ™ç”Ÿæˆæ–°çš„éšæœºæ ¹éŸ³
                    const rootNoteSelect = document.getElementById('rootNoteSelect');
                    let newRootNote = exercise.rootNote;
                    
                    if (rootNoteSelect.value === 'random') {
                        const allNotes = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                        newRootNote = allNotes[Math.floor(Math.random() * allNotes.length)];
                        
                        // æ›´æ–°æ ¹éŸ³æ˜¾ç¤º
                        const currentNoteDisplay = document.getElementById('currentNoteDisplay');
                        currentNoteDisplay.textContent = newRootNote;
                        
                        // æ›´æ–°ç»ƒä¹ çŠ¶æ€ä¸­çš„æ ¹éŸ³
                        state.currentIntervalExercise.rootNote = newRootNote;
                    }
                    
                    // éšæœºé€‰æ‹©å½“å‰éŸ³ç¨‹å¯¹
                    let currentInterval;
                    if (exercise.findRootFirst) {
                        // å¦‚æœå¼€å¯å…ˆæ‰¾æ ¹éŸ³ï¼Œåˆ™éšæœºé€‰æ‹©1å’ŒæŸä¸ªé€‰ä¸­çš„éŸ³ç¨‹
                        const randomInterval = selectedIntervals[Math.floor(Math.random() * selectedIntervals.length)];
                        currentInterval = `1 ${randomInterval}`;
                    } else {
                        // å¦‚æœå…³é—­å…ˆæ‰¾æ ¹éŸ³ï¼Œåˆ™éšæœºé€‰æ‹©ä¸¤ä¸ªé€‰ä¸­çš„éŸ³ç¨‹
                        if (selectedIntervals.length >= 2) {
                            const shuffled = [...selectedIntervals].sort(() => Math.random() - 0.5);
                            currentInterval = `${shuffled[0]} ${shuffled[1]}`;
                        } else {
                            currentInterval = `${selectedIntervals[0]} ${selectedIntervals[0]}`;
                        }
                    }
                    
                    // æ›´æ–°ç»ƒä¹ çŠ¶æ€
                    state.currentIntervalExercise.currentInterval = currentInterval;
                    state.currentIntervalExercise.answered = false;
                    state.currentIntervalExercise.completedIntervals = []; // é‡ç½®å·²å®Œæˆçš„éŸ³ç¨‹
                    
                    // æ¸…é™¤æŒ‡æ¿ä¸Šçš„é«˜äº®å’ŒéŸ³ç¨‹æ˜¾ç¤º
                    clearFretboardHighlights();
                    
                    // æ˜¾ç¤ºéŸ³çº§ä¿¡æ¯
                    updateIntervalExerciseDisplay();
                    
                    // é‡ç½®å•éŸ³ç»ƒä¹ çŠ¶æ€ï¼Œé¿å…æ··æ·†
                    state.pitchFindingAnswered = false;
                    state.currentNote = null;
                }
                
                // å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
                window.generateNextIntervalExercise = generateNextIntervalExercise;
                
                // æ˜¾ç¤ºæŒ‡æ¿åŠŸèƒ½
                function showFretboardForPractice() {
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    const fretboardFooter = document.getElementById('fretboardFooter');
                    
                    if (fretboardContainer && fretboardFooter) {
                        fretboardContainer.style.display = 'block';
                        fretboardFooter.style.display = 'block';
                        createFretboard();
                        
                        // è®¾ç½®æŒ‡æ¿æ˜¾ç¤ºçŠ¶æ€
                        state.fretboardVisible = true;
                        console.log('æŒ‡æ¿å·²æ˜¾ç¤º');
                        
                        // å¦‚æœå½“å‰æœ‰æ­£åœ¨ç­‰å¾…çš„å»¶è¿Ÿï¼Œé‡æ–°è®¾ç½®å»¶è¿Ÿæ—¶é—´
                        updateCurrentDelay();
                    }
                }
                
                // éšè—æŒ‡æ¿åŠŸèƒ½
                function hideFretboardForPractice() {
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    const fretboardFooter = document.getElementById('fretboardFooter');

                    if (fretboardContainer && fretboardFooter) {
                        fretboardContainer.style.display = 'none';
                        fretboardFooter.style.display = 'none';

                        // æ¸…é™¤æŒ‡æ¿é«˜äº®
                        clearFretboardHighlights();

                        // è®¾ç½®æŒ‡æ¿éšè—çŠ¶æ€
                        state.fretboardVisible = false;
                        console.log('æŒ‡æ¿å·²éšè—');

                        // éšè—æŒ‡æ¿æ—¶ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜ï¼ˆå¦‚æœå½“å‰ç»ƒä¹ å·²å®Œæˆï¼‰
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            const practiceMode = document.querySelector('.practice-mode-btn.active');

                            if (practiceMode && practiceMode.dataset.mode === 'interval') {
                                // éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼
                                if (state.currentIntervalExercise && state.currentIntervalExercise.answered) {
                                    console.log('éšè—æŒ‡æ¿ï¼ŒéŸ³ç¨‹ç»ƒä¹ ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜');
                                    // æ¸…é™¤å»¶è¿Ÿ
                                    if (state.intervalNextTimeout) {
                                        clearTimeout(state.intervalNextTimeout);
                                        state.intervalNextTimeout = null;
                                    }
                                    // ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
                                    generateNextIntervalExercise();
                                }
                            } else {
                                // å•éŸ³ç»ƒä¹ æ¨¡å¼
                                if (state.pitchFindingAnswered) {
                                    console.log('éšè—æŒ‡æ¿ï¼Œå•éŸ³ç»ƒä¹ ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜');
                                    // æ¸…é™¤å»¶è¿Ÿ
                                    if (state.pitchFindingNextTimeout) {
                                        clearTimeout(state.pitchFindingNextTimeout);
                                        state.pitchFindingNextTimeout = null;
                                    }
                                    // ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
                                    generateNextPitchFindingQuestion();
                                }
                            }
                        }
                    }
                }
                
                // æ›´æ–°å½“å‰å»¶è¿Ÿæ—¶é—´ï¼ˆå½“æŒ‡æ¿æ˜¾ç¤ºçŠ¶æ€æ”¹å˜æ—¶ï¼‰
                function updateCurrentDelay() {
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„æ‰¾éŸ³ç»ƒä¹ å»¶è¿Ÿ
                    if (state.pitchFindingNextTimeout && state.pitchFindingAnswered) {
                        console.log('æ£€æµ‹åˆ°æ‰¾éŸ³ç»ƒä¹ å»¶è¿Ÿï¼Œé‡æ–°è®¾ç½®å»¶è¿Ÿæ—¶é—´');
                        
                        // æ¸…é™¤å½“å‰çš„å»¶è¿Ÿ
                        clearTimeout(state.pitchFindingNextTimeout);
                        
                        // è·å–å½“å‰è®¾ç½®
                        const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                        const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;
                        
                        // æ£€æŸ¥æŒ‡æ¿æ˜¯å¦æ˜¾ç¤º
                        const fretboardContainer = document.getElementById('fretboardContainer');
                        const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';
                        
                        // é‡æ–°è®¡ç®—å»¶è¿Ÿæ—¶é—´
                        let delayTime;
                        if (!isFretboardVisible) {
                            // æŒ‡æ¿éšè—æ—¶ç«‹å³è‡ªåŠ¨åˆ‡æ¢ï¼ˆå¿½ç•¥æ‰‹åŠ¨æ¨¡å¼è®¾ç½®ï¼‰
                            delayTime = 100;
                            console.log(`é‡æ–°è®¾ç½®æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿éšè—: ç«‹å³è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¢˜`);
                        } else if (intervalSeconds === 0) {
                            // æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼ï¼šä¸è®¾ç½®è‡ªåŠ¨åˆ‡æ¢
                            delayTime = 0;
                            console.log(`é‡æ–°è®¾ç½®æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼: å–æ¶ˆè‡ªåŠ¨åˆ‡æ¢ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ`);
                        } else {
                            // æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´
                            delayTime = intervalSeconds * 1000;
                            console.log(`é‡æ–°è®¾ç½®æ‰¾éŸ³ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼: å»¶è¿Ÿ${delayTime}ms`);
                        }

                        if (delayTime > 0) {
                            console.log(`é‡æ–°è®¾ç½®æ‰¾éŸ³ç»ƒä¹ å»¶è¿Ÿ: æŒ‡æ¿æ˜¾ç¤º=${isFretboardVisible}, æ–°å»¶è¿Ÿæ—¶é—´=${delayTime}ms`);
                            // é‡æ–°è®¾ç½®å»¶è¿Ÿ
                            state.pitchFindingNextTimeout = setTimeout(() => {
                                generateNextPitchFindingQuestion();
                            }, delayTime);
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„éŸ³ç¨‹ç»ƒä¹ å»¶è¿Ÿ
                    if (state.intervalNextTimeout && state.currentIntervalExercise && state.currentIntervalExercise.answered) {
                        console.log('æ£€æµ‹åˆ°éŸ³ç¨‹ç»ƒä¹ å»¶è¿Ÿï¼Œé‡æ–°è®¾ç½®å»¶è¿Ÿæ—¶é—´');

                        // æ¸…é™¤å½“å‰çš„å»¶è¿Ÿ
                        clearTimeout(state.intervalNextTimeout);
                        state.intervalNextTimeout = null;

                        // è·å–å½“å‰è®¾ç½®
                        const selectedIntervalBtn = document.querySelector('.pitch-finding-interval-btn.active');
                        const intervalSeconds = selectedIntervalBtn ? parseInt(selectedIntervalBtn.dataset.value) : 0;

                        // æ£€æŸ¥æŒ‡æ¿æ˜¯å¦æ˜¾ç¤º
                        const fretboardContainer = document.getElementById('fretboardContainer');
                        const isFretboardVisible = fretboardContainer && fretboardContainer.style.display !== 'none';

                        // é‡æ–°è®¡ç®—å»¶è¿Ÿæ—¶é—´
                        let delayTime;
                        if (!isFretboardVisible) {
                            // æŒ‡æ¿éšè—æ—¶ç«‹å³è‡ªåŠ¨åˆ‡æ¢ï¼ˆå¿½ç•¥æ‰‹åŠ¨æ¨¡å¼è®¾ç½®ï¼‰
                            delayTime = 100;
                            console.log(`é‡æ–°è®¾ç½®éŸ³ç¨‹ç»ƒä¹ æŒ‡æ¿éšè—: ç«‹å³è‡ªåŠ¨åˆ‡æ¢ä¸‹ä¸€é¢˜`);
                        } else if (intervalSeconds === 0) {
                            // æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼ï¼šä¸è®¾ç½®è‡ªåŠ¨åˆ‡æ¢
                            delayTime = 0;
                            console.log(`é‡æ–°è®¾ç½®éŸ³ç¨‹ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”æ‰‹åŠ¨æ¨¡å¼: å–æ¶ˆè‡ªåŠ¨åˆ‡æ¢ï¼Œç­‰å¾…ç”¨æˆ·æ“ä½œ`);
                        } else {
                            // æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼ï¼šä½¿ç”¨è®¾ç½®çš„å»¶è¿Ÿæ—¶é—´
                            delayTime = intervalSeconds * 1000;
                            console.log(`é‡æ–°è®¾ç½®éŸ³ç¨‹ç»ƒä¹ æŒ‡æ¿æ˜¾ç¤ºä¸”è‡ªåŠ¨æ¨¡å¼: å»¶è¿Ÿ${delayTime}ms`);
                        }

                        if (delayTime > 0) {
                            console.log(`é‡æ–°è®¾ç½®éŸ³ç¨‹ç»ƒä¹ å»¶è¿Ÿ: æŒ‡æ¿æ˜¾ç¤º=${isFretboardVisible}, æ–°å»¶è¿Ÿæ—¶é—´=${delayTime}ms`);
                            // é‡æ–°è®¾ç½®å»¶è¿Ÿ
                            state.intervalNextTimeout = setTimeout(() => {
                                generateNextIntervalExercise();
                            }, delayTime);
                        }
                    }
                }
                
                // å°†æŒ‡æ¿æ§åˆ¶å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
                window.showFretboardForPractice = showFretboardForPractice;
                window.hideFretboardForPractice = hideFretboardForPractice;
                
                function updateIntervalExerciseDisplay() {
                    const exercise = state.currentIntervalExercise;
                    if (!exercise) return;
                    
                    // åˆ›å»ºæˆ–æ›´æ–°æ˜¾ç¤ºå…ƒç´ 
                    let intervalDisplay = document.getElementById('intervalExerciseDisplay');
                    if (!intervalDisplay) {
                        intervalDisplay = document.createElement('div');
                        intervalDisplay.id = 'intervalExerciseDisplay';
                        intervalDisplay.className = 'interval-exercise-display';
                        const currentNoteContainer = document.querySelector('.pitch-finding-current-note');
                        currentNoteContainer.appendChild(intervalDisplay);
                    }
                    
                    // æ¸…ç©ºå†…å®¹
                    intervalDisplay.innerHTML = '';
                    
                    // åˆ›å»ºèƒŒæ™¯éŸ³çº§æ˜¾ç¤º
                    const backgroundIntervals = document.createElement('div');
                    backgroundIntervals.className = 'background-intervals';
                    // åªæ˜¾ç¤ºé€‰ä¸­çš„éŸ³ç¨‹ï¼Œä¸æ˜¾ç¤º1
                    backgroundIntervals.textContent = exercise.intervals.join(' ');
                    
                    // åˆ›å»ºå½“å‰é¢˜ç›®æ˜¾ç¤º
                    const currentInterval = document.createElement('div');
                    currentInterval.className = 'current-interval';
                    currentInterval.textContent = exercise.currentInterval;
                    
                    intervalDisplay.appendChild(backgroundIntervals);
                    intervalDisplay.appendChild(currentInterval);
                }
                
                
                // æ¸…é™¤æŒ‡æ¿é«˜äº®
                function clearFretboardHighlights() {
                    const fretboard = document.getElementById('fretboard');
                    if (!fretboard) return;

                    const frets = fretboard.querySelectorAll('.fretboard-fret');
                    frets.forEach(fret => {
                        fret.style.backgroundColor = '';
                        fret.style.boxShadow = '';

                        // ç§»é™¤éŸ³ç¨‹æ ‡è®°
                        const intervalDisplay = fret.querySelector('.interval-display');
                        if (intervalDisplay) {
                            intervalDisplay.remove();
                        }
                    });

                    // æ¸…é™¤CAGEDç›¸å…³å…ƒç´ ï¼ˆé‡è¦ï¼šé˜²æ­¢åœ¨éCAGEDç»ƒä¹ ä¸­æ˜¾ç¤ºï¼‰
                    const fretboardContainer = document.getElementById('fretboardContainer');
                    if (fretboardContainer) {
                        const cagedElements = fretboardContainer.querySelectorAll('.caged-shape-highlight, .caged-fingering');
                        if (cagedElements.length > 0) {
                            cagedElements.forEach(el => el.remove());
                            console.log('éŸ³ç¨‹ç»ƒä¹  - æ¸…é™¤CAGEDå…ƒç´ :', cagedElements.length, 'ä¸ª');
                        }
                    }

                    // æ¢å¤æ‰€æœ‰è¢«éšè—çš„ç©ºå¼¦éŸ³å
                    const hiddenMarkers = document.querySelectorAll('.fret-marker.hidden');
                    hiddenMarkers.forEach(marker => {
                        const originalNote = marker.dataset.originalNote;
                        if (originalNote) {
                            marker.textContent = originalNote;
                            marker.classList.remove('hidden');
                            delete marker.dataset.originalNote;
                        }
                    });
                }
                

                
                

                // ç‚¹å‡»ç»ƒä¹ å±å¹•è¿”å›ä¸»é¡µé¢
                // ä¿®æ”¹ç»ƒä¹ å±å¹•ç‚¹å‡»äº‹ä»¶ï¼Œç¡®ä¿é€€å‡ºæ—¶é‡ç½®å†·å´æœŸ
                practiceScreen.addEventListener('click', function () {
                    updateStatusIndicator('æ­£åœ¨åœæ­¢å½•éŸ³...', 'ready');

                    // æ ¹æ®å½“å‰æ¨¡å¼é‡ç½®ç›¸åº”çš„çŠ¶æ€
                    if (state.isCustomChordMode) {
                        state.isCustomChordMode = false;
                        console.log('é€€å‡ºè‡ªå®šä¹‰å’Œå¼¦ç»ƒä¹ é¡µé¢ - é‡ç½® state.isCustomChordMode = false');
                    } else {
                    state.cagedMode = false;
                    console.log('é€€å‡ºç»ƒä¹ é¡µé¢ - é‡ç½® state.cagedMode = false');
                    }

                    // é‡ç½®å’Œå¼¦è½¬æ¢ç»ƒä¹ çš„ä¼šè¯çŠ¶æ€
                    state.isInProgressionSession = false;

                    // é‡ç½®æ‰¾éŸ³ç»ƒä¹ è®¡æ—¶å™¨
                    if (state.pitchFindingTimer) {
                        clearInterval(state.pitchFindingTimer);
                        state.pitchFindingTimer = null;
                    }

                    // åªæœ‰åœ¨å¯ç”¨å†·å´æ—¶é—´æ—¶æ‰é‡ç½®å†·å´æœŸçŠ¶æ€
                    if (state.enableCooldown) {
                        state.isCoolingDown = false;
                        if (state.cooldownTimeout) {
                            clearTimeout(state.cooldownTimeout);
                            state.cooldownTimeout = null;
                        }
                    }

                    setTimeout(() => {
                        stopRecording();
                        stopMetronome();
                        //releaseWakeLock();

                        // é‡ç½®ç»ƒä¹ æ¨¡å¼çŠ¶æ€
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;

                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';

                        // éšè—æ‰¾éŸ³ç»ƒä¹ ç‰¹å®šå…ƒç´ 
                        const pitchFindingElements = document.getElementById('pitchFindingElements');
                        if (pitchFindingElements) {
                            pitchFindingElements.style.display = 'none';
                        }
                        
                        // éšè—ä¸‹ä¸€é¢˜æŒ‰é’®
                        const nextBtnContainer = document.querySelector('.pitch-finding-next-btn-container');
                        if (nextBtnContainer) {
                            nextBtnContainer.style.display = 'none';
                        }
                        
                        // éšè—ä¹æ›²åæ˜¾ç¤º
                        const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                        if (songTitleDisplayEl) {
                            songTitleDisplayEl.style.display = 'none';
                        }
                        
                        // æ¢å¤ç»ƒä¹ å®¹å™¨æ˜¾ç¤º
                        const exerciseContainer = document.querySelector('.exercise-container');
                        if (exerciseContainer) {
                            exerciseContainer.style.display = 'block';
                        }
                        
                        // æ¢å¤å…¶ä»–ç»ƒä¹ å…ƒç´ æ˜¾ç¤º
                        document.getElementById('targetInterval').style.display = 'block';
                        document.getElementById('sequenceDisplay').style.display = 'flex';
                        document.getElementById('nextExercise').style.display = 'block';
                        
                        // æ¸…ç†sequence-itemçš„CSSçŠ¶æ€
                        const sequenceItems = document.querySelectorAll('.sequence-item');
                        sequenceItems.forEach(item => {
                            item.classList.remove('current');
                            // åªæ¸…ç†å¯èƒ½å½±å“å¸ƒå±€çš„å±æ€§ï¼Œä¿ç•™å¿…è¦çš„flexå¸ƒå±€å±æ€§
                            item.style.width = '';
                            item.style.maxWidth = '';
                            item.style.transform = '';
                        });
                        
                        // æ¢å¤next-exerciseå®¹å™¨æ˜¾ç¤º
                        const nextExerciseContainer = document.querySelector('.next-exercise');
                        if (nextExerciseContainer) {
                            nextExerciseContainer.style.display = 'flex';
                        }
                        
                        mainScreen.style.display = 'block';

                        updateStatusIndicator('å‡†å¤‡å°±ç»ª', 'ready');
                    }, 300);
                });
                // é¡µé¢å…³é—­æ—¶å®Œå…¨å…³é—­éº¦å…‹é£
                window.addEventListener('beforeunload', function () {
                    closeMicrophone();
                });
            }

            // åˆå§‹åŒ–CAGEDäº‹ä»¶ç›‘å¬å™¨
            function initCagedEventListeners() {
                // CAGEDè®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                const cagedModeToggle = document.getElementById('cagedModeToggle');
                const cagedSettings = document.getElementById('cagedSettings');
                
                // CAGEDå’Œå¼¦ç»ƒä¹ è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
                const cagedChordModeToggle = document.getElementById('cagedChordModeToggle');
                const cagedChordSettings = document.getElementById('cagedChordSettings');
                
                // CAGEDå’Œå¼¦ç»ƒä¹ æ¨¡å¼åˆ‡æ¢
                if (cagedChordModeToggle) {
                    // åˆå§‹åŒ–æ»‘å—çŠ¶æ€
                    cagedChordModeToggle.checked = window.cagedChordState.enabled;
                    if (cagedChordSettings) {
                        cagedChordSettings.style.display = window.cagedChordState.enabled ? 'block' : 'none';
                    }
                    
                    cagedChordModeToggle.addEventListener('change', function() {
                        window.cagedChordState.enabled = this.checked;
                        if (cagedChordSettings) {
                            cagedChordSettings.style.display = this.checked ? 'block' : 'none';
                        }
                        saveSettings();
                    });
                }
                
                // CAGEDå’Œå¼¦å½¢çŠ¶é€‰æ‹©
                const cagedChordShapeBtns = document.querySelectorAll('#cagedChordSettings .caged-shape-btn');
                cagedChordShapeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        const shape = this.dataset.shape;
                        if (this.classList.contains('active')) {
                            if (!window.cagedChordState.selectedShapes.includes(shape)) {
                                window.cagedChordState.selectedShapes.push(shape);
                            }
                        } else {
                            window.cagedChordState.selectedShapes = window.cagedChordState.selectedShapes.filter(s => s !== shape);
                        }
                        saveSettings();
                    });
                });
                
                // CAGEDå’Œå¼¦ç»ƒä¹ æ¨¡å¼é€‰æ‹©
                const cagedChordModeBtns = document.querySelectorAll('.caged-chord-mode-btn');
                cagedChordModeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        cagedChordModeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        window.cagedChordState.practiceMode = this.dataset.mode;
                        saveSettings();
                    });
                });
                
                
                if (cagedModeToggle) {
                    // åˆå§‹åŒ–æ»‘å—çŠ¶æ€
                    cagedModeToggle.checked = window.cagedState.enabled;
                    if (cagedSettings) {
                        cagedSettings.style.display = window.cagedState.enabled ? 'block' : 'none';
                    }
                    
                    cagedModeToggle.addEventListener('change', function() {
                        window.cagedState.enabled = this.checked;
                        
                        if (cagedSettings) {
                            cagedSettings.style.display = window.cagedState.enabled ? 'block' : 'none';
                        }
                    });
                }

                // MIDIå¼€å…³äº‹ä»¶
                const midiToggle = document.getElementById('midiToggle');
                if (midiToggle) {
                    // åˆå§‹åŒ–æ»‘å—çŠ¶æ€
                    midiToggle.checked = window.midiState.enabled;
                    
                    midiToggle.addEventListener('change', async function() {
                        if (this.checked) {
                            // å¯ç”¨MIDI
                            const success = await initializeMIDI();
                            if (success) {
                                window.midiState.enabled = true;
                                
                                // è¿æ¥æ‰€æœ‰MIDIè¾“å…¥è®¾å¤‡
                                connectMIDIDevices();
                            } else {
                                // å¦‚æœåˆå§‹åŒ–å¤±è´¥ï¼Œå–æ¶ˆé€‰ä¸­çŠ¶æ€
                                this.checked = false;
                                alert('æ— æ³•å¯ç”¨MIDIè®¾å¤‡ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ”¯æŒæˆ–è®¾å¤‡è¿æ¥');
                            }
                        } else {
                            // ç¦ç”¨MIDI
                            window.midiState.enabled = false;
                            
                            // æ–­å¼€æ‰€æœ‰MIDIè¾“å…¥è®¾å¤‡
                            disconnectMIDIDevices();
                        }
                    });
                }

                // CAGEDç»ƒä¹ ç±»å‹å›ºå®šä¸ºéŸ³é˜¶ç»ƒä¹ ï¼Œæ— éœ€äº‹ä»¶ç›‘å¬å™¨

                // CAGEDå½¢çŠ¶é€‰æ‹©æŒ‰é’®
                const cagedShapeBtns = document.querySelectorAll('.caged-shape-btn');
                cagedShapeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        this.classList.toggle('active');
                        const shape = this.dataset.shape;
                        if (this.classList.contains('active')) {
                            if (!window.cagedState.selectedShapes.includes(shape)) {
                                window.cagedState.selectedShapes.push(shape);
                            }
                        } else {
                            window.cagedState.selectedShapes = window.cagedState.selectedShapes.filter(s => s !== shape);
                        }
                        // æ›´æ–°å½“å‰å½¢çŠ¶
                        if (window.cagedState.selectedShapes.length > 0) {
                            window.cagedState.currentShape = window.cagedState.selectedShapes[0];
                        }
                    });
                });

                // CAGEDç»ƒä¹ æ¨¡å¼æŒ‰é’®
                const cagedModeBtns = document.querySelectorAll('.caged-mode-btn');
                cagedModeBtns.forEach(btn => {
                    btn.addEventListener('click', function() {
                        cagedModeBtns.forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                        window.cagedState.practiceMode = this.dataset.mode;
                    });
                });

                
                // ç»ƒä¹ ç•Œé¢ä¸­çš„CAGEDå½¢çŠ¶æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼ˆæ‰‹åŠ¨åˆ‡æ¢å½¢çŠ¶ï¼‰
                const practiceShapeButtons = document.querySelectorAll('.caged-shape-btn-display');
                practiceShapeButtons.forEach(btn => {
                    btn.addEventListener('click', function(event) {
                        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è§¦å‘ç»ƒä¹ å±å¹•çš„é€€å‡ºäº‹ä»¶
                        event.stopPropagation();
                        event.preventDefault();
                        
                        const targetShape = this.dataset.shape;
                        
                        // æ£€æŸ¥æ˜¯å¦æ˜¯é€‰ä¸­çš„å½¢çŠ¶ä¸”ä¸æ˜¯å½“å‰å½¢çŠ¶
                        if (window.cagedState.selectedShapes.includes(targetShape) && 
                            targetShape !== window.cagedState.currentShape) {
                            
                            console.log(`æ‰‹åŠ¨åˆ‡æ¢CAGEDå½¢çŠ¶: ${window.cagedState.currentShape} â†’ ${targetShape}`);
                            
                            // æ ‡è®°ä¸ºæ‰‹åŠ¨åˆ‡æ¢ï¼Œä¿æŒå½“å‰éŸ³é˜¶ç±»å‹
                            window.cagedState.isManualSwitch = true;
                            
                            // æ›´æ–°å½“å‰å½¢çŠ¶
                            window.cagedState.currentShape = targetShape;
                            
                            // æ›´æ–°æŒ‰é’®çŠ¶æ€
                            updateCagedShapeButtons();
                            
                            // é‡æ–°ç”Ÿæˆå½“å‰å½¢çŠ¶çš„ç»ƒä¹ 
                            generateCagedExercise();
                            
                            // é‡ç½®æ‰‹åŠ¨åˆ‡æ¢æ ‡è®°
                            window.cagedState.isManualSwitch = false;
                        }
                    });
                });
            }

            // åˆå§‹åŒ–åº”ç”¨
            function initApp() {
                if (typeof Pitchfinder === 'undefined') {
                    console.error('PitchFinderåº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    alert('éŸ³é«˜æ£€æµ‹åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ååˆ·æ–°é¡µé¢');
                } else {
                    console.log('PitchFinderåº“åŠ è½½æˆåŠŸ');
                }

                // è·å–éŸ³é¢‘è®¾å¤‡åˆ—è¡¨
                getAudioDevices();

                initEventListeners();
                initCagedEventListeners();
                initKeyboardShortcuts();
                
                // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨
                if (typeof window.initCustomDropdown === 'function') {
                    window.initCustomDropdown();
                } else {
                    console.error('initCustomDropdownå‡½æ•°æœªå®šä¹‰');
                }
                
                // åˆå§‹åŒ–ä¹æ›²ä¸‹æ‹‰åˆ—è¡¨
                if (typeof window.initJazzStandardDropdown === 'function') {
                    window.initJazzStandardDropdown();
                } else {
                    console.error('initJazzStandardDropdownå‡½æ•°æœªå®šä¹‰');
                }
                
                // åˆå§‹åŒ–è°ƒæ€§ä¸‹æ‹‰åˆ—è¡¨
                if (typeof window.initProgressionKeyDropdown === 'function') {
                    window.initProgressionKeyDropdown();
                } else {
                    console.error('initProgressionKeyDropdownå‡½æ•°æœªå®šä¹‰');
                }
                
                requestRecordPermission();
            }

            // åˆå§‹åŒ–é”®ç›˜å¿«æ·é”®
            function initKeyboardShortcuts() {
                document.addEventListener('keydown', function (e) {
                    if (e.key === 'Escape' && practiceScreen.style.display === 'flex') {
                        practiceScreen.click();
                    }

                    if ((e.key === ' ' || e.key === 'ArrowRight') && practiceScreen.style.display === 'flex') {
                        // é˜»æ­¢é»˜è®¤è¡Œä¸º
                        e.preventDefault();
                        
                        // æ£€æŸ¥å½“å‰ç»ƒä¹ æ¨¡å¼
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            // æ‰¾éŸ³ç»ƒä¹ æ¨¡å¼
                            const practiceMode = document.querySelector('.practice-mode-btn.active');
                            if (practiceMode && practiceMode.dataset.mode === 'interval') {
                                // éŸ³ç¨‹ç»ƒä¹ æ¨¡å¼ï¼šç›´æ¥è°ƒç”¨å‡½æ•°
                                console.log('éŸ³ç¨‹ç»ƒä¹ ä¸‹ä¸€é¢˜è§¦å‘');
                                // ä½¿ç”¨windowå¯¹è±¡è®¿é—®å‡½æ•°
                                if (window.generateNextIntervalExercise) {
                                    window.generateNextIntervalExercise();
                                } else {
                                    console.log('generateNextIntervalExerciseå‡½æ•°æœªæ‰¾åˆ°');
                                }
                            } else {
                                // å•éŸ³ç»ƒä¹ æ¨¡å¼ï¼šç”Ÿæˆä¸‹ä¸€é¢˜å•éŸ³ç»ƒä¹ 
                                console.log('å•éŸ³ç»ƒä¹ ä¸‹ä¸€é¢˜è§¦å‘');
                                if (typeof generateNextPitchFindingQuestion === 'function') {
                                    generateNextPitchFindingQuestion();
                                }
                            }
                        } else {
                            // å…¶ä»–ç»ƒä¹ æ¨¡å¼ï¼šç”Ÿæˆä¸‹ä¸€é¢˜
                            console.log('å…¶ä»–ç»ƒä¹ æ¨¡å¼ä¸‹ä¸€é¢˜è§¦å‘');
                        generateExercise();
                        }
                    }
                    
                    // å‘ä¸Šé”®ï¼šæ˜¾ç¤ºæŒ‡æ¿
                    if (e.key === 'ArrowUp' && practiceScreen.style.display === 'flex') {
                        e.preventDefault();
                        
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            console.log('æ˜¾ç¤ºæŒ‡æ¿');
                            showFretboardForPractice();
                        }
                    }
                    
                    // å‘ä¸‹é”®ï¼šéšè—æŒ‡æ¿
                    if (e.key === 'ArrowDown' && practiceScreen.style.display === 'flex') {
                        e.preventDefault();
                        
                        const activeTab = document.querySelector('.nav-item.active');
                        if (activeTab && activeTab.dataset.tab === 'pitch-finding') {
                            console.log('éšè—æŒ‡æ¿');
                            hideFretboardForPractice();
                        }
                    }
                });
            }

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            function updateStatusIndicator(status, type = 'ready') {
                statusIndicator.textContent = status;
                statusIndicator.className = `status-indicator status-${type}`;
            }
            
            // åº”ç”¨ç¿»è¯‘
            function applyTranslations() {
                if (typeof window.t !== 'function') {
                    return;
                }
                
                // æ›´æ–°é¡µé¢æ ‡é¢˜
                document.title = window.t('page_title');
                
                // ä½¿ç”¨data-i18n-keyå±æ€§ç¿»è¯‘æ‰€æœ‰å…ƒç´ 
                const elementsWithI18n = document.querySelectorAll('[data-i18n-key]');
                elementsWithI18n.forEach(element => {
                    const key = element.getAttribute('data-i18n-key');
                    const translation = window.t(key);
                    if (translation && translation !== key) {
                        // å¯¹äºoptgroupå…ƒç´ ï¼Œæ›´æ–°labelå±æ€§
                        if (element.tagName === 'OPTGROUP') {
                            element.setAttribute('label', translation);
                        } else {
                        element.textContent = translation;
                        }
                    }
                });
            }
            
            // ç¼“å­˜DOMå…ƒç´ å¼•ç”¨
            let langZhBtn, langEnBtn;
            
            // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢æŒ‰é’®
            function initLanguageButtons() {
                langZhBtn = document.getElementById('langZhBtn');
                langEnBtn = document.getElementById('langEnBtn');
                
                if (langZhBtn) {
                    langZhBtn.addEventListener('click', function () {
                        if (typeof window.switchLanguage === 'function') {
                            const success = window.switchLanguage('zh-CN');
                            if (success) {
                                updateLanguageButtons();
                                applyTranslations();
                            }
                        }
                    });
                }
                
                if (langEnBtn) {
                    langEnBtn.addEventListener('click', function () {
                        if (typeof window.switchLanguage === 'function') {
                            const success = window.switchLanguage('en');
                            if (success) {
                                updateLanguageButtons();
                                applyTranslations();
                            }
                        }
                    });
                }
                
                // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
                updateLanguageButtons();
            }
            
            // æ›´æ–°è¯­è¨€æŒ‰é’®çŠ¶æ€
            function updateLanguageButtons() {
                if (langZhBtn && langEnBtn) {
                    // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„activeçŠ¶æ€
                    langZhBtn.classList.remove('active');
                    langEnBtn.classList.remove('active');
                    
                    // æ ¹æ®å½“å‰è¯­è¨€è®¾ç½®activeçŠ¶æ€
                    const currentLang = window.getCurrentLanguage();
                    if (currentLang === 'zh-CN') {
                        langZhBtn.classList.add('active');
                    } else if (currentLang === 'en') {
                        langEnBtn.classList.add('active');
                    }
                }
            }

            // è‡ªå®šä¹‰å’Œå¼¦åŠŸèƒ½ - å·²æ”¹ä¸ºå¼¹çª—è®¾è®¡ï¼Œè¿™äº›å…ƒç´ ä¸å†éœ€è¦
            // æ‰€æœ‰è‡ªå®šä¹‰å’Œå¼¦åŠŸèƒ½ç°åœ¨é€šè¿‡ initCustomChordsDialog å‡½æ•°å¤„ç†

            // æ›´æ–°è‡ªå®šä¹‰å’Œå¼¦ç±»å‹ä¸‹æ‹‰æ¡†æ˜¾ç¤º
            function updateCustomChordTypeDisplay() {
                // ç”±äºæ”¹ä¸ºå¼¹çª—è®¾è®¡ï¼Œè¿™ä¸ªå‡½æ•°ç°åœ¨ä¸éœ€è¦æ›´æ–°ä¸‹æ‹‰æ¡†
                // å’Œå¼¦ç±»å‹é€‰æ‹©ç°åœ¨é€šè¿‡å…¨å±é€‰æ‹©å™¨å¤„ç†
                    return;
                }

            // æ—§çš„è‡ªå®šä¹‰å’Œå¼¦ä»£ç å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¼¹çª—è®¾è®¡

            // æ—§çš„è‡ªå®šä¹‰å’Œå¼¦ä»£ç å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¼¹çª—è®¾è®¡

            // æ—§çš„è‡ªå®šä¹‰å’Œå¼¦ä»£ç å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¼¹çª—è®¾è®¡
            // æ—§çš„è‡ªå®šä¹‰å’Œå¼¦ä»£ç å·²åˆ é™¤ï¼Œç°åœ¨ä½¿ç”¨å¼¹çª—è®¾è®¡

            // ä¿®æ”¹generateChordExerciseå‡½æ•°ä»¥æ”¯æŒè‡ªå®šä¹‰å’Œå¼¦
            function originalGenerateChordExercise() {
                try {
                    // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€ä¿¡æ¯ï¼Œç¡®ä¿ä»å½“å‰é€‰ä¸­çš„å’Œå¼¦ç±»å‹ç”Ÿæˆ
                    state.nextExerciseInfo = '';
                    state.nextExerciseIntervals = [];
                    state.chordType = ''; // æ¸…é™¤ä¹‹å‰çš„å’Œå¼¦ç±»å‹
                    
                    let rootNote = chordRootNoteEl.value;
                    if (rootNote === 'random') {
                        const notes = Object.keys(noteToSemitones).filter(n => n.length <= 2);
                        rootNote = notes[Math.floor(Math.random() * notes.length)];
                    }
                    state.rootNote = rootNote;

                    const activeChordTypes = document.querySelectorAll('.chord-type-btn.active');
                    let chordType = 'major';
                    if (activeChordTypes.length > 0) {
                        const selectedChordTypes = Array.from(activeChordTypes).map(btn => btn.dataset.value);
                        chordType = selectedChordTypes[Math.floor(Math.random() * selectedChordTypes.length)];
                    } else {
                        // å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œä¸ç”Ÿæˆé»˜è®¤å’Œå¼¦ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç©ºå€¼
                        console.warn('æ²¡æœ‰é€‰ä¸­ä»»ä½•å’Œå¼¦ç±»å‹ï¼Œæ— æ³•ç”Ÿæˆä¸‹ä¸€é¢˜');
                        return; // ä¸ç”Ÿæˆä¸‹ä¸€é¢˜
                    }
                    state.chordType = chordType;

                    // æ£€æŸ¥å’Œå¼¦ç±»å‹æ˜¯å¦å­˜åœ¨
                    if (!chordTypes[chordType]) {
                        throw new Error(`æœªçŸ¥çš„å’Œå¼¦ç±»å‹: ${chordType}`);
                    }

                    state.currentIntervals = [...chordTypes[chordType].intervals];

                    // å¤„ç†è½¬ä½å’Œå¼¦
                    const bassNoteSelect = document.getElementById('chordBassNote');
                    if (bassNoteSelect) {
                        const bassNote = bassNoteSelect.value;
                        if (bassNote !== 'root') {
                            state.currentIntervals = applyChordInversion(state.currentIntervals, bassNote);
                        }
                    }

                    const activeChordOrderBtn = document.querySelector('.chord-order-btn.active');
                    const order = activeChordOrderBtn ? activeChordOrderBtn.dataset.value : 'ordered';
                    if (order === 'reverse') {
                        // ä¸‹è¡Œæ¨¡å¼ï¼šå€’åºæ’åˆ—
                        state.currentIntervals = state.currentIntervals.reverse();
                    } else if (order === 'random') {
                        for (let i = state.currentIntervals.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [state.currentIntervals[i], state.currentIntervals[j]] = [state.currentIntervals[j], state.currentIntervals[i]];
                        }
                    }

                    // è·å–è½¬ä½å’Œå¼¦åç§°
                    const bassNote = bassNoteSelect ? bassNoteSelect.value : 'root';
                    const chordSymbol = getInversionChordName(rootNote, chordType, bassNote);
                    // åªæ˜¾ç¤ºå’Œå¼¦åç§°ï¼Œä¸æ˜¾ç¤ºéŸ³çº§ç»“æ„
                    targetIntervalEl.textContent = chordSymbol;
                    targetIntervalEl.innerHTML = chordSymbol; // ç¡®ä¿åªæ˜¾ç¤ºå’Œå¼¦åç§°
                    displaySequence();
                    
                    // é¢„ç”Ÿæˆä¸‹ä¸€é¢˜
                    generateNextExercise();
                } catch (error) {
                    console.error('ç”Ÿæˆå’Œå¼¦ç»ƒä¹ å¤±è´¥:', error);
                    updateStatusIndicator('å’Œå¼¦ç»ƒä¹ ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
                    // å›é€€åˆ°é»˜è®¤å’Œå¼¦
                    state.chordType = 'major';
                    state.currentIntervals = ['1', '3', '5'];
                    const targetIntervalEl = document.getElementById('targetInterval');
                    if (targetIntervalEl) targetIntervalEl.textContent = 'C Major';
                    displaySequence();
                }
            }

            // ç”Ÿæˆå’Œå¼¦è½¬æ¢ç»ƒä¹ 
            function generateProgressionExercise() {
                resetCagedModeState();
                
                const jazzStandardEl = document.getElementById('jazzStandard');
                const progressionKeyEl = document.getElementById('progressionKey');
                const progressionLevelEl = document.getElementById('progressionLevel');
                const enableRepeatEl = document.getElementById('enableRepeat');
                const songTitleEl = document.getElementById('songTitle');
                const songTitleDisplayEl = document.getElementById('songTitleDisplay');
                // useCustomChords å¼€å…³å·²ç§»é™¤ï¼Œç°åœ¨å®Œå…¨åŸºäº state.isCustomChordMode çŠ¶æ€
                
                // æ ¹æ®è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼çŠ¶æ€å†³å®šç»ƒä¹ ç±»å‹
                if (state.isCustomChordMode) {
                    // è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼ï¼šä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                    console.log('ä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼');
                } else {
                    // éè‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼ï¼šæ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦çŠ¶æ€ï¼Œä½¿ç”¨æ­Œæ›²ç»ƒä¹ 
                    console.log('ä½¿ç”¨æ­Œæ›²ç»ƒä¹ æ¨¡å¼');
                    window.customChordSequence = [];
                    state.progressionChords = null;
                    state.progressionSong = null;
                    state.progressionOrder = null;
                    state.progressionKey = null;
                    state.progressionLevel = null;
                    state.progressionIndex = 0;
                }
                
                // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ
                if (state.isCustomChordMode && window.customChordSequence && window.customChordSequence.length > 0) {
                    // ä½¿ç”¨è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ
                    const sequenceName = document.getElementById('sequenceName').value || 'è‡ªå®šä¹‰å’Œå¼¦è¿›è¡Œ';
                    songTitleEl.textContent = sequenceName;
                    songTitleDisplayEl.style.display = 'block';
                    
                    // å°†è‡ªå®šä¹‰å’Œå¼¦åºåˆ—è½¬æ¢ä¸ºå’Œå¼¦ç¬¦å·
                    const chords = window.customChordSequence.map(chord => {
                        const root = chord.root;
                        const type = chord.type;
                        const bass = chord.bass;
                        
                        // æ ¹æ®å’Œå¼¦ç±»å‹ç”Ÿæˆç¬¦å·
                        let chordSymbol = root;
                        if (type === 'minor') chordSymbol += 'm';
                        else if (type === 'diminished') chordSymbol += 'dim';
                        else if (type === 'augmented') chordSymbol += 'aug';
                        else if (type === 'major6') chordSymbol += '6';
                        else if (type === 'minor6') chordSymbol += 'm6';
                        else if (type === 'dominant7') chordSymbol += '7';
                        else if (type === 'major7') chordSymbol += 'Maj7';
                        else if (type === 'minor7') chordSymbol += 'm7';
                        else if (type === 'minor7b5') chordSymbol += 'm7â™­5';
                        else if (type === 'diminished7') chordSymbol += 'dim7';
                        else if (type === 'dominant9') chordSymbol += '9';
                        else if (type === 'major9') chordSymbol += 'Maj9';
                        else if (type === 'minor9') chordSymbol += 'm9';
                        else if (type === 'dominant7sharp9') chordSymbol += '7â™¯9';
                        else if (type === 'dominant7flat9') chordSymbol += '7â™­9';
                        else if (type === 'dominant11') chordSymbol += '11';
                        else if (type === 'minor11') chordSymbol += 'm11';
                        else if (type === 'dominant7sharp11') chordSymbol += '7â™¯11';
                        else if (type === 'dominant13') chordSymbol += '13';
                        else if (type === 'minor13') chordSymbol += 'm13';
                        else if (type === 'sus2') chordSymbol += 'sus2';
                        else if (type === 'sus4') chordSymbol += 'sus4';
                        else if (type === 'add9') chordSymbol += 'add9';
                        else if (type === 'madd9') chordSymbol += 'madd9';
                        else if (type === '6add9') chordSymbol += '6add9';
                        else if (type === 'm6add9') chordSymbol += 'm6add9';
                        
                        // æ·»åŠ è½¬ä½ä¿¡æ¯
                        if (bass !== 'root') {
                            if (bass === '3rd') chordSymbol += '/3';
                            else if (bass === '5th') chordSymbol += '/5';
                            else if (bass === '7th') chordSymbol += '/7';
                        }
                        
                        return chordSymbol;
                    });
                    
                    // åº”ç”¨å’Œå¼¦è¿›è¡Œçš„é¡ºåºè®¾ç½®
                    const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                    const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                    
                    let finalChords = [...chords];
                    if (order === 'reverse') {
                        finalChords = finalChords.reverse();
                    } else if (order === 'random') {
                        // æ‰“ä¹±å’Œå¼¦é¡ºåº
                        for (let i = finalChords.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [finalChords[i], finalChords[j]] = [finalChords[j], finalChords[i]];
                        }
                    }
                    
                    // åˆå§‹åŒ–æˆ–é‡ç½®å’Œå¼¦è¿›è¡Œç´¢å¼•
                    const currentOrderBtn = document.querySelector('.progression-order-btn.active');
                    const currentOrder = currentOrderBtn ? currentOrderBtn.dataset.value : 'ordered';
                    const currentLevel = progressionLevelEl.value;
                    
                    if (!state.progressionChords || 
                        state.progressionSong !== sequenceName ||
                        state.progressionOrder !== currentOrder ||
                        state.progressionLevel !== currentLevel) {
                        
                        state.progressionChords = finalChords;
                        state.progressionSong = sequenceName;
                        state.progressionOrder = currentOrder;
                        state.progressionLevel = currentLevel;
                        state.progressionIndex = 0;
                    }
                    
                    // æ¯æ¬¡å¼€å§‹æ–°çš„ç»ƒä¹ ä¼šè¯æ—¶ï¼Œéƒ½ä»ç¬¬ä¸€ä¸ªå’Œå¼¦å¼€å§‹
                    if (!state.isInProgressionSession) {
                        state.progressionIndex = 0;
                        state.isInProgressionSession = true;
                    }
                    
                    // ç”Ÿæˆå½“å‰å’Œå¼¦çš„ç»ƒä¹ 
                    generateCurrentProgressionChord();
                    return;
                }
                
                const selectedSong = jazzStandardEl.value;
                if (!selectedSong) {
                    alert('è¯·é€‰æ‹©ä¸€é¦–æ­Œæ›²');
                    return;
                }

                // æ˜¾ç¤ºä¹æ›²å
                songTitleEl.textContent = selectedSong;
                songTitleDisplayEl.style.display = 'block';

                // è·å–æ­Œæ›²å’Œå¼¦è¿›è¡Œæ•°æ®
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][selectedSong]) {
                        songData = jazzStandards[letter][selectedSong];
                        break;
                    }
                }

                if (!songData) {
                    alert('æ‰¾ä¸åˆ°æ­Œæ›²å’Œå¼¦è¿›è¡Œ');
                    return;
                }

                // è·å–åŸè°ƒå’ŒéŸ³çº§å’Œå¼¦è¿›è¡Œ
                const originalKey = songData.key;
                let chords = [];

                // æ£€æŸ¥æ˜¯å¦æ˜¯ç»ƒä¹ æ›²ç›®
                if (selectedSong.includes('ç»ƒä¹ ') && selectedSong.includes('ä¸ªè°ƒ')) {
                    console.log('æ£€æµ‹åˆ°ç»ƒä¹ æ›²ç›®ï¼Œç”Ÿæˆå’Œå¼¦å¾ªç¯');

                    const circleOfFifthsReverse = ['A', 'D', 'G', 'C', 'F', 'Bâ™­', 'Eâ™­', 'Aâ™­', 'Dâ™­', 'Gâ™­', 'B', 'E'];

                    if (selectedSong.includes('Maj7') && !selectedSong.includes('#11') && !selectedSong.includes('#5')) {
                        // Maj7å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}Maj7`);
                    } else if (selectedSong.includes('Min7') && !selectedSong.includes('b5') && !selectedSong.includes('Maj7')) {
                        // Min7å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}m7`);
                    } else if (selectedSong.includes('Sus4b9')) {
                        // Sus4b9å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}sus4(b9)`);
                    } else if (selectedSong.includes('Maj7#11')) {
                        // Maj7#11å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}Maj7(#11)`);
                    } else if (selectedSong.includes('7sus4') && !selectedSong.includes('b9') && !selectedSong.includes('13')) {
                        // 7sus4å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}7sus4`);
                    } else if (selectedSong.includes('Dom7')) {
                        // Dom7å’Œå¼¦ç»ƒä¹ ï¼ˆ7å’Œå¼¦ï¼‰
                        chords = circleOfFifthsReverse.map(key => `${key}7`);
                    } else if (selectedSong.includes('Min7b5') && !selectedSong.includes('â™®9')) {
                        // Min7b5å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}m7(b5)`);
                    } else if (selectedSong.includes('MinMaj7')) {
                        // MinMaj7å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}m(Maj7)`);
                    } else if (selectedSong.includes('13sus4b9')) {
                        // 13sus4b9å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}13sus4(b9)`);
                    } else if (selectedSong.includes('Maj7#5')) {
                        // Maj7#5å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}Maj7(#5)`);
                    } else if (selectedSong.includes('7#11') && !selectedSong.includes('13')) {
                        // 7#11å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}7(#11)`);
                    } else if (selectedSong.includes('Min7b5â™®9')) {
                        // Min7b5â™®9å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}m7(b5,â™®9)`);
                    } else if (selectedSong.includes('13b9')) {
                        // 13b9å’Œå¼¦ç»ƒä¹ 
                        chords = circleOfFifthsReverse.map(key => `${key}13(b9)`);
                    }

                    console.log(`ç”Ÿæˆçš„${selectedSong}å’Œå¼¦å¾ªç¯ï¼š`, chords);

                } else {
                    // æ™®é€šæ­Œæ›²å¤„ç†
                    const degreeChords = [...songData.chords];
                    const selectedKey = progressionKeyEl.value;

                    // ç§»è°ƒåˆ°ç›®æ ‡è°ƒ
                    chords = degreeChords.map(degreeChord =>
                        transposeChordFromDegree(degreeChord, originalKey, selectedKey)
                    );
                }

    
                // æ˜¾ç¤ºè°ƒæ€§è½¬æ¢ä¿¡æ¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
                if (selectedSong.includes('ç»ƒä¹ ') && selectedSong.includes('ä¸ªè°ƒ')) {
                    console.log(`ç»ƒä¹ æ›²ç›®ï¼š${selectedSong}`);
                    console.log(`å’Œå¼¦å¾ªç¯ï¼š`, chords);
                } else {
                    const keyInfo = selectedKey === originalKey ?
                        `åŸè°ƒï¼š${originalKey}` :
                        `${originalKey} â†’ ${selectedKey}`;
                    console.log(`æ­Œæ›²ï¼š${selectedSong}`);
                    console.log(`è°ƒæ€§è½¬æ¢ï¼š${keyInfo}`);
                    console.log(`éŸ³çº§å’Œå¼¦ï¼š`, songData.chords);
                    console.log(`è½¬æ¢åå’Œå¼¦ï¼š`, chords);
                }

                // åº”ç”¨å’Œå¼¦è¿›è¡Œçš„é¡ºåºè®¾ç½®ï¼ˆé¡ºåºæŒ‰é’®æ§åˆ¶æ•´ä¸ªå’Œå¼¦è¿›è¡Œçš„é¡ºåºï¼‰
                const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                
                if (order === 'reverse') {
                    chords = chords.reverse();
                } else if (order === 'random') {
                    // æ‰“ä¹±å’Œå¼¦é¡ºåº
                    for (let i = chords.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [chords[i], chords[j]] = [chords[j], chords[i]];
                    }
                }

                // åˆå§‹åŒ–æˆ–é‡ç½®å’Œå¼¦è¿›è¡Œç´¢å¼•ï¼ˆå½“æ­Œæ›²æˆ–è®¾ç½®æ”¹å˜æ—¶ï¼‰
                const currentOrderBtn = document.querySelector('.progression-order-btn.active');
                const currentOrder = currentOrderBtn ? currentOrderBtn.dataset.value : 'ordered';
                const currentKey = progressionKeyEl.value;
                const currentLevel = progressionLevelEl.value;
                
                // åªæœ‰åœ¨æ­Œæ›²ã€é¡ºåºã€è°ƒæ€§æˆ–ç­‰çº§æ”¹å˜æ—¶æ‰é‡ç½®ï¼Œå¦åˆ™ä¿æŒå½“å‰è¿›åº¦
                if (!state.progressionChords || 
                    state.progressionSong !== selectedSong ||
                    state.progressionOrder !== currentOrder ||
                    state.progressionKey !== currentKey ||
                    state.progressionLevel !== currentLevel) {
                    
                    state.progressionChords = chords;
                    state.progressionSong = selectedSong;
                    state.progressionOrder = currentOrder;
                    state.progressionKey = currentKey;
                    state.progressionLevel = currentLevel;
                    state.progressionIndex = 0; // é‡æ–°å¼€å§‹
                }
                
                // æ¯æ¬¡å¼€å§‹æ–°çš„ç»ƒä¹ ä¼šè¯æ—¶ï¼Œéƒ½ä»ç¬¬ä¸€ä¸ªå’Œå¼¦å¼€å§‹
                if (!state.isInProgressionSession) {
                    state.progressionIndex = 0;
                    state.isInProgressionSession = true;
                }

                // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰å’Œå¼¦
                if (state.progressionIndex >= chords.length) {
                    const isRepeatEnabled = enableRepeatEl.checked;
                    if (isRepeatEnabled) {
                        state.progressionIndex = 0; // é‡æ–°å¼€å§‹
                    } else {
                        // é‡ç½®è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼çŠ¶æ€ï¼ˆé€€å‡ºç»ƒä¹ æ—¶ç«‹å³é‡ç½®ï¼‰
                        state.isCustomChordMode = false;
                        console.log('è‡ªå®šä¹‰å’Œå¼¦ç»ƒä¹ å®Œæˆé€€å‡º - é‡ç½® state.isCustomChordMode = false');
                        
                        // æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦ç›¸å…³çŠ¶æ€
                        // useCustomChords å¼€å…³å·²ç§»é™¤
                        
                        // æ¸…ç©ºå…¨å±€è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                        window.customChordSequence = [];
                        console.log('ç»ƒä¹ å®Œæˆ - æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦åºåˆ—');
                        
                        // æ¸…ç©ºå’Œå¼¦è¿›è¡ŒçŠ¶æ€
                        state.progressionChords = null;
                        state.progressionSong = null;
                        state.progressionOrder = null;
                        state.progressionKey = null;
                        state.progressionLevel = null;
                        state.progressionIndex = 0;
                        
                        // ç›´æ¥é€€å‡ºç»ƒä¹ ç•Œé¢ï¼Œä¸å¼¹å‡ºæç¤ºçª—å£
                        stopRecording();
                        stopMetronome();
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        updateStatusIndicator('ç»ƒä¹ å·²å®Œæˆ', 'ready');

                        // é‡ç½®æ‰€æœ‰ç»ƒä¹ æ¨¡å¼çŠ¶æ€
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;
                        state.isInProgressionSession = false;
                        return;
                    }
                }

                const currentChord = chords[state.progressionIndex];
                
                // å°†éŸ³çº§ç¬¦å·è½¬æ¢ä¸ºå®é™…çš„å’Œå¼¦åç§°
                let actualChord = currentChord;
                if (currentChord.match(/^[IVX]+[mM]?[0-9â™­â™¯]*/)) {
                    // è¿™æ˜¯ä¸€ä¸ªéŸ³çº§ç¬¦å·ï¼Œéœ€è¦è½¬æ¢ä¸ºå®é™…å’Œå¼¦
                    const songData = jazzStandards[state.progressionKey][state.progressionSong];
                    const keyRoot = songData.key;
                    actualChord = transposeChordFromDegree(currentChord, keyRoot, keyRoot);
                }
                
                const { root, type } = parseChordSymbol(actualChord);

                state.rootNote = root;
                state.chordType = type;

                // æ ¹æ®ç»ƒä¹ ç­‰çº§ç”ŸæˆéŸ³ç¨‹
                const level = progressionLevelEl.value;
                let intervals = getIntervalsForLevel(level, type);
                
                // å¦‚æœé€‰æ‹©äº†"å…¨éƒ¨"é€‰é¡¹ï¼Œåˆ™ä½¿ç”¨å’Œå¼¦çš„æ‰€æœ‰éŸ³ç¨‹
                if (level === 'all-notes') {
                    // è·å–å’Œå¼¦ç±»å‹å¯¹åº”çš„å®Œæ•´éŸ³ç¨‹
                    if (chordTypes[type]) {
                        intervals = [...chordTypes[type].intervals];
                        
                        // æ ¹æ®é¡ºåºè®¾ç½®è°ƒæ•´éŸ³ç¨‹é¡ºåº
                        const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                        
                        if (order === 'reverse') {
                            // å€’åº
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            // éšæœº
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }
                        // å¦‚æœæ˜¯é¡ºåº(ordered)ï¼Œä¿æŒåŸé¡ºåº
                    } else {
                        // å¦‚æœæ— æ³•è·å–å’Œå¼¦ç±»å‹ä¿¡æ¯ï¼Œå›é€€åˆ°é»˜è®¤è®¾ç½®
                        intervals = ['1', '3', '5'];
                    }
                }

                state.currentIntervals = intervals;
                // åªæ˜¾ç¤ºå’Œå¼¦åç§°ï¼Œä¸æ˜¾ç¤ºéŸ³çº§ç»“æ„
                targetIntervalEl.textContent = currentChord;
                targetIntervalEl.innerHTML = currentChord; // ç¡®ä¿åªæ˜¾ç¤ºå’Œå¼¦åç§°ï¼Œä¸æ˜¾ç¤ºéŸ³çº§ç»“æ„
                displaySequence();

                // å‡†å¤‡ä¸‹ä¸€ä¸ªå’Œå¼¦ï¼ˆä¿æŒç›¸åŒçš„é¡ºåºï¼‰
                const nextIndex = (state.progressionIndex + 1) % chords.length;
                const isRepeatEnabled = enableRepeatEl.checked;
                
                if (isRepeatEnabled || nextIndex !== 0) {
                    const nextChord = chords[nextIndex];
                    state.nextExerciseInfo = nextChord; // åªæ˜¾ç¤ºå’Œå¼¦å
                    
                    // ä¸ºä¸‹ä¸€ä¸ªå’Œå¼¦ç”ŸæˆéŸ³ç¨‹
                    const level = progressionLevelEl.value;
                        const { root: nextRoot, type: nextType } = parseChordSymbol(nextChord);
                    
                    if (level === 'all-notes') {
                        // å¯¹äº"å…¨éƒ¨"é€‰é¡¹ï¼Œä½¿ç”¨å’Œå¼¦çš„å®Œæ•´éŸ³ç¨‹
                        if (chordTypes[nextType]) {
                            let nextIntervals = [...chordTypes[nextType].intervals];
                            
                            // æ ¹æ®é¡ºåºè®¾ç½®è°ƒæ•´éŸ³ç¨‹é¡ºåº
                            const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                            const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                            
                            if (order === 'reverse') {
                                // å€’åº
                                nextIntervals = nextIntervals.reverse();
                            } else if (order === 'random') {
                                // éšæœº
                                for (let i = nextIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [nextIntervals[i], nextIntervals[j]] = [nextIntervals[j], nextIntervals[i]];
                                }
                            }
                            // å¦‚æœæ˜¯é¡ºåº(ordered)ï¼Œä¿æŒåŸé¡ºåº
                            
                            state.nextExerciseIntervals = nextIntervals;
                        } else {
                            // å¦‚æœæ— æ³•è·å–å’Œå¼¦ç±»å‹ä¿¡æ¯ï¼Œå›é€€åˆ°é»˜è®¤è®¾ç½®
                            state.nextExerciseIntervals = getIntervalsForLevel(level);
                        }
                    } else {
                        // å¯¹äºé"å…¨éƒ¨"çº§åˆ«ï¼Œä½¿ç”¨getIntervalsForLevelå¹¶ä¼ å…¥å’Œå¼¦ç±»å‹
                        state.nextExerciseIntervals = getIntervalsForLevel(level, nextType);
                    }
                } else {
                    state.nextExerciseInfo = 'ç»ƒä¹ å®Œæˆ';
                    state.nextExerciseIntervals = [];
                }
                
                // æ›´æ–°ä¸‹ä¸€é¢˜æ˜¾ç¤º
                updateNextExerciseDisplay();

                // æ›´æ–°ç´¢å¼•å‡†å¤‡ä¸‹ä¸€é¢˜
                // ä¿®å¤ï¼šåªæœ‰åœ¨æˆåŠŸæ˜¾ç¤ºå½“å‰å’Œå¼¦åæ‰é€’å¢ç´¢å¼•
                // è¿™æ ·å¯ä»¥ç¡®ä¿ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ˜¾ç¤ºç¬¬ä¸€ä¸ªå’Œå¼¦
                if (state.progressionIndex < chords.length) {
                    state.progressionIndex++;
                }
            }
            
            // ç”Ÿæˆå½“å‰å’Œå¼¦è¿›è¡Œç»ƒä¹ 
            function generateCurrentProgressionChord() {
                if (!state.progressionChords || state.progressionChords.length === 0) {
                    console.error('æ²¡æœ‰å¯ç”¨çš„å’Œå¼¦è¿›è¡Œæ•°æ®');
                    return;
                }
                
                const progressionLevelEl = document.getElementById('progressionLevel');
                const enableRepeatEl = document.getElementById('enableRepeat');
                const targetIntervalEl = document.getElementById('targetInterval');
                
                // æ£€æŸ¥æ˜¯å¦å·²å®Œæˆæ‰€æœ‰å’Œå¼¦
                if (state.progressionIndex >= state.progressionChords.length) {
                    const isRepeatEnabled = enableRepeatEl.checked;
                    if (isRepeatEnabled) {
                        state.progressionIndex = 0; // é‡æ–°å¼€å§‹
                    } else {
                        // é‡ç½®è‡ªå®šä¹‰å’Œå¼¦æ¨¡å¼çŠ¶æ€ï¼ˆé€€å‡ºç»ƒä¹ æ—¶ç«‹å³é‡ç½®ï¼‰
                        state.isCustomChordMode = false;
                        console.log('è‡ªå®šä¹‰å’Œå¼¦ç»ƒä¹ å®Œæˆé€€å‡º - é‡ç½® state.isCustomChordMode = false');
                        
                        // æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦ç›¸å…³çŠ¶æ€
                        // useCustomChords å¼€å…³å·²ç§»é™¤
                        
                        // æ¸…ç©ºå…¨å±€è‡ªå®šä¹‰å’Œå¼¦åºåˆ—
                        window.customChordSequence = [];
                        console.log('ç»ƒä¹ å®Œæˆ - æ¸…ç©ºè‡ªå®šä¹‰å’Œå¼¦åºåˆ—');
                        
                        // æ¸…ç©ºå’Œå¼¦è¿›è¡ŒçŠ¶æ€
                        state.progressionChords = null;
                        state.progressionSong = null;
                        state.progressionOrder = null;
                        state.progressionKey = null;
                        state.progressionLevel = null;
                        state.progressionIndex = 0;
                        
                        // ç›´æ¥é€€å‡ºç»ƒä¹ ç•Œé¢ï¼Œä¸å¼¹å‡ºæç¤ºçª—å£
                        stopRecording();
                        stopMetronome();
                        practiceScreen.style.display = 'none';
                        document.getElementById('pitchDisplay').style.display = 'none';
                        mainScreen.style.display = 'block';
                        updateStatusIndicator('ç»ƒä¹ å·²å®Œæˆ', 'ready');

                        // é‡ç½®æ‰€æœ‰ç»ƒä¹ æ¨¡å¼çŠ¶æ€
                        window.state.intervalExerciseMode = false;
                        window.state.pitchFindingMode = false;
                        state.isInProgressionSession = false;
                        return;
                    }
                }

                const currentChord = state.progressionChords[state.progressionIndex];
                const { root, type } = parseChordSymbol(currentChord);

                state.rootNote = root;
                state.chordType = type;

                // æ ¹æ®ç»ƒä¹ ç­‰çº§ç”ŸæˆéŸ³ç¨‹
                const level = progressionLevelEl.value;
                let intervals = getIntervalsForLevel(level, type);
                
                // å¦‚æœé€‰æ‹©äº†"å…¨éƒ¨"é€‰é¡¹ï¼Œåˆ™ä½¿ç”¨å’Œå¼¦çš„æ‰€æœ‰éŸ³ç¨‹
                if (level === 'all-notes') {
                    // è·å–å’Œå¼¦ç±»å‹å¯¹åº”çš„å®Œæ•´éŸ³ç¨‹
                    if (chordTypes[type]) {
                        intervals = [...chordTypes[type].intervals];
                        
                        // æ ¹æ®é¡ºåºè®¾ç½®è°ƒæ•´éŸ³ç¨‹é¡ºåº
                        const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                        const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                        
                        if (order === 'reverse') {
                            // å€’åº
                            intervals = intervals.reverse();
                        } else if (order === 'random') {
                            // éšæœº
                            for (let i = intervals.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [intervals[i], intervals[j]] = [intervals[j], intervals[i]];
                            }
                        }
                        // å¦‚æœæ˜¯é¡ºåº(ordered)ï¼Œä¿æŒåŸé¡ºåº
                    } else {
                        // å¦‚æœæ— æ³•è·å–å’Œå¼¦ç±»å‹ä¿¡æ¯ï¼Œå›é€€åˆ°é»˜è®¤è®¾ç½®
                        intervals = ['1', '3', '5'];
                    }
                }

                state.currentIntervals = intervals;
                // åªæ˜¾ç¤ºå’Œå¼¦åç§°ï¼Œä¸æ˜¾ç¤ºéŸ³çº§ç»“æ„
                targetIntervalEl.textContent = currentChord;
                targetIntervalEl.innerHTML = currentChord; // ç¡®ä¿åªæ˜¾ç¤ºå’Œå¼¦åç§°ï¼Œä¸æ˜¾ç¤ºéŸ³çº§ç»“æ„
                displaySequence();

                // å‡†å¤‡ä¸‹ä¸€ä¸ªå’Œå¼¦ï¼ˆä¿æŒç›¸åŒçš„é¡ºåºï¼‰
                const nextIndex = (state.progressionIndex + 1) % state.progressionChords.length;
                if (nextIndex < state.progressionChords.length) {
                    const nextChord = state.progressionChords[nextIndex];
                    const { root: nextRoot, type: nextType } = parseChordSymbol(nextChord);
                    
                    state.nextExerciseInfo = nextChord;
                    
                    // æ ¹æ®ç»ƒä¹ ç­‰çº§ç”Ÿæˆä¸‹ä¸€é¢˜çš„éŸ³ç¨‹
                    const level = progressionLevelEl.value;
                    if (level === 'all-notes') {
                        // å¯¹äº"å…¨éƒ¨"é€‰é¡¹ï¼Œä½¿ç”¨å’Œå¼¦çš„å®Œæ•´éŸ³ç¨‹
                        if (chordTypes[nextType]) {
                            let nextIntervals = [...chordTypes[nextType].intervals];
                            
                            // æ ¹æ®é¡ºåºè®¾ç½®è°ƒæ•´éŸ³ç¨‹é¡ºåº
                            const activeOrderBtn = document.querySelector('.progression-order-btn.active');
                            const order = activeOrderBtn ? activeOrderBtn.dataset.value : 'ordered';
                            
                            if (order === 'reverse') {
                                // å€’åº
                                nextIntervals = nextIntervals.reverse();
                            } else if (order === 'random') {
                                // éšæœº
                                for (let i = nextIntervals.length - 1; i > 0; i--) {
                                    const j = Math.floor(Math.random() * (i + 1));
                                    [nextIntervals[i], nextIntervals[j]] = [nextIntervals[j], nextIntervals[i]];
                                }
                            }
                            // å¦‚æœæ˜¯é¡ºåº(ordered)ï¼Œä¿æŒåŸé¡ºåº
                            
                            state.nextExerciseIntervals = nextIntervals;
                        } else {
                            // å¦‚æœæ— æ³•è·å–å’Œå¼¦ç±»å‹ä¿¡æ¯ï¼Œå›é€€åˆ°é»˜è®¤è®¾ç½®
                            state.nextExerciseIntervals = getIntervalsForLevel(level);
                        }
                    } else {
                        // å¯¹äºé"å…¨éƒ¨"çº§åˆ«ï¼Œä½¿ç”¨getIntervalsForLevelå¹¶ä¼ å…¥å’Œå¼¦ç±»å‹
                        state.nextExerciseIntervals = getIntervalsForLevel(level, nextType);
                    }
                } else {
                    state.nextExerciseInfo = 'ç»ƒä¹ å®Œæˆ';
                    state.nextExerciseIntervals = [];
                }
                
                // æ›´æ–°ä¸‹ä¸€é¢˜æ˜¾ç¤º
                updateNextExerciseDisplay();

                // æ›´æ–°ç´¢å¼•å‡†å¤‡ä¸‹ä¸€é¢˜
                // ä¿®å¤ï¼šåªæœ‰åœ¨æˆåŠŸæ˜¾ç¤ºå½“å‰å’Œå¼¦åæ‰é€’å¢ç´¢å¼•
                // è¿™æ ·å¯ä»¥ç¡®ä¿ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶æ˜¾ç¤ºç¬¬ä¸€ä¸ªå’Œå¼¦
                if (state.progressionIndex < state.progressionChords.length) {
                    state.progressionIndex++;
                }
            }
            
            // æ ¹æ®ç»ƒä¹ ç­‰çº§è·å–å¯¹åº”çš„éŸ³ç¨‹
            // æ ¹æ®å’Œå¼¦ç±»å‹è°ƒæ•´éŸ³ç¨‹çš„å‡½æ•°
            function adjustIntervalsForChordType(intervals, chordType) {
                if (!chordTypes[chordType]) {
                    return intervals;
                }
                
                const chordIntervals = chordTypes[chordType].intervals;
                const adjustedIntervals = [];
                
                for (const interval of intervals) {
                    if (chordIntervals.includes(interval)) {
                        // å¦‚æœå’Œå¼¦åŒ…å«è¿™ä¸ªéŸ³ç¨‹ï¼Œç›´æ¥ä½¿ç”¨
                        adjustedIntervals.push(interval);
                    } else {
                        // å¦‚æœå’Œå¼¦ä¸åŒ…å«è¿™ä¸ªéŸ³ç¨‹ï¼Œå¯»æ‰¾æ›¿ä»£
                        let replacement = null;
                        
                        switch (interval) {
                            case '3':
                                // 3åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('2')) {
                                    replacement = '2'; // sus2å’Œå¼¦ç”¨2æ›¿ä»£3
                                } else if (chordIntervals.includes('4')) {
                                    replacement = '4'; // sus4å’Œå¼¦ç”¨4æ›¿ä»£3
                                } else if (chordIntervals.includes('â™­3')) {
                                    replacement = 'â™­3'; // å°å’Œå¼¦ç”¨â™­3æ›¿ä»£3
                                }
                                break;
                            case 'â™­3':
                                // â™­3åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('2')) {
                                    replacement = '2'; // sus2å’Œå¼¦ç”¨2æ›¿ä»£â™­3
                                } else if (chordIntervals.includes('4')) {
                                    replacement = '4'; // sus4å’Œå¼¦ç”¨4æ›¿ä»£â™­3
                                } else if (chordIntervals.includes('3')) {
                                    replacement = '3'; // å¤§å’Œå¼¦ç”¨3æ›¿ä»£â™­3
                                }
                                break;
                            case '7':
                                // 7åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('6')) {
                                    replacement = '6'; // 6å’Œå¼¦ç”¨6æ›¿ä»£7
                                } else if (chordIntervals.includes('â™­7')) {
                                    replacement = 'â™­7'; // å°7å’Œå¼¦ç”¨â™­7æ›¿ä»£7
                                }
                                break;
                            case 'â™­7':
                                // â™­7åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('6')) {
                                    replacement = '6'; // 6å’Œå¼¦ç”¨6æ›¿ä»£â™­7
                                } else if (chordIntervals.includes('7')) {
                                    replacement = '7'; // å¤§7å’Œå¼¦ç”¨7æ›¿ä»£â™­7
                                }
                                break;
                            case '5':
                                // 5åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('â™­5')) {
                                    replacement = 'â™­5'; // å‡å’Œå¼¦ç”¨â™­5æ›¿ä»£5
                                } else if (chordIntervals.includes('â™¯5')) {
                                    replacement = 'â™¯5'; // å¢å’Œå¼¦ç”¨â™¯5æ›¿ä»£5
                                }
                                break;
                            case 'â™­5':
                                // â™­5åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('5')) {
                                    replacement = '5'; // å¤§ä¸‰å’Œå¼¦ç”¨5æ›¿ä»£â™­5
                                } else if (chordIntervals.includes('â™¯5')) {
                                    replacement = 'â™¯5'; // å¢å’Œå¼¦ç”¨â™¯5æ›¿ä»£â™­5
                                }
                                break;
                            case 'â™¯5':
                                // â™¯5åº¦éŸ³ç¨‹çš„æ›¿ä»£
                                if (chordIntervals.includes('5')) {
                                    replacement = '5'; // å¤§ä¸‰å’Œå¼¦ç”¨5æ›¿ä»£â™¯5
                                } else if (chordIntervals.includes('â™­5')) {
                                    replacement = 'â™­5'; // å‡å’Œå¼¦ç”¨â™­5æ›¿ä»£â™¯5
                                }
                                break;
                        }
                        
                        if (replacement && chordIntervals.includes(replacement)) {
                            adjustedIntervals.push(replacement);
                        } else {
                            // å¦‚æœæ‰¾ä¸åˆ°åˆé€‚çš„æ›¿ä»£ï¼Œå¯¹äº7éŸ³å’Œâ™­7éŸ³ï¼Œç›´æ¥è·³è¿‡ä¸æ˜¾ç¤º
                            if (interval === '7' || interval === 'â™­7') {
                                // å¯¹äºæ²¡æœ‰7éŸ³çš„å’Œå¼¦ï¼Œä¸æ˜¾ç¤º7éŸ³
                                // ä¸æ·»åŠ ä»»ä½•éŸ³ç¨‹ï¼Œç›´æ¥è·³è¿‡
                            } else {
                                // å¯¹äºå…¶ä»–éŸ³ç¨‹ï¼Œå°è¯•ä½¿ç”¨å’Œå¼¦ä¸­å­˜åœ¨çš„éŸ³ç¨‹
                            const availableIntervals = chordIntervals.filter(i => i !== '1');
                            if (availableIntervals.length > 0) {
                                adjustedIntervals.push(availableIntervals[0]);
                                }
                            }
                        }
                    }
                }
                
                return adjustedIntervals;
            }

            // æ—‹å¾‹ç»“æ„1çš„éŸ³ç¨‹æ˜ å°„å‡½æ•°
            function getMelodicStructure1Intervals(chordType) {
                // æ ¹æ®å’Œå¼¦ç±»å‹æ˜ å°„åˆ°ä¸åŒçš„ç»“æ„
                // æè¿°ï¼šå¤§è°ƒå’Œå¼¦/å±ä¸ƒå’Œå¼¦: 1,2,3,5ï¼›å°ä¸‰å’Œå¼¦: 1,3,4,5ï¼›æŒ‚ç•™å’Œå¼¦: 1,2,4,5ï¼›å‡å’Œå¼¦: 1,2,3,5ï¼ˆå±ä¸ƒå’Œå¼¦ä¸å«å˜åŒ–äº”éŸ³ï¼‰

                if (!chordType) {
                    // é»˜è®¤è¿”å›å¤§è°ƒå’Œå¼¦ç»“æ„
                    return ['1', '2', '3', '5'];
                }

                // åˆ¤æ–­å’Œå¼¦ç±»å‹ç±»åˆ«
                if (chordType === 'major' || chordType === 'major7' || chordType === 'major9' ||
                    chordType === 'dominant7' || chordType === 'dominant9' || chordType === 'dominant13' ||
                    chordType === 'dominant7b5' || chordType === 'dominant7#5' || chordType === 'dominant9b5' ||
                    chordType === 'augmented' || chordType === 'augmented7') {
                    // å¤§è°ƒå’Œå¼¦/å±ä¸ƒå’Œå¼¦: 1,2,3,5 (æ³¨æ„ï¼šæè¿°ä¸­è¯´å±ä¸ƒå’Œå¼¦ä¸å«å˜åŒ–äº”éŸ³ï¼Œæ‰€ä»¥è¿™é‡Œç”¨çº¯äº”åº¦)
                    return ['1', '2', '3', '5'];

                } else if (chordType === 'minor' || chordType === 'minor7' || chordType === 'minor9' ||
                          chordType === 'minor11' || chordType === 'minor6' || chordType === 'minMaj7') {
                    // å°ä¸‰å’Œå¼¦: 1,3,4,5
                    return ['1', '3', '4', '5'];

                } else if (chordType === 'sus4' || chordType === 'sus2' || chordType === 'sus4b9' ||
                          chordType === 'sus4b9b13' || chordType === '7sus4' || chordType === '7sus2' ||
                          chordType === 'sus4add3' || chordType === 'sus2add3') {
                    // æŒ‚ç•™å’Œå¼¦: 1,2,4,5
                    return ['1', '2', '4', '5'];

                } else if (chordType === 'dim' || chordType === 'dim7' || chordType === 'minor7b5' ||
                          chordType === 'diminished' || chordType === 'diminished7' || chordType === 'halfDiminished') {
                    // å‡å’Œå¼¦: 1,2,3,5
                    return ['1', '2', '3', '5'];

                } else {
                    // å…¶ä»–å’Œå¼¦ç±»å‹é»˜è®¤ä½¿ç”¨å¤§è°ƒå’Œå¼¦ç»“æ„
                    return ['1', '2', '3', '5'];
                }
            }

            function getIntervalsForLevel(level, chordType = null) {
                let intervals = [];
                
                switch (level) {
                    // å•å’Œå¼¦éŸ³
                    case 'single-root':
                        intervals = ['1'];
                        break;
                    case 'single-3':
                        intervals = ['3'];
                        break;
                    case 'single-5':
                        intervals = ['5'];
                        break;
                    case 'single-7':
                        intervals = ['7'];
                        break;
                    
                    // åŒå’Œå¼¦éŸ³
                    case 'double-root-3':
                        intervals = ['1', '3'];
                        break;
                    case 'double-root-5':
                        intervals = ['1', '5'];
                        break;
                    case 'double-root-7':
                        intervals = ['1', '7'];
                        break;
                    case 'double-3-5':
                        intervals = ['3', '5'];
                        break;
                    case 'double-3-7':
                        intervals = ['3', '7'];
                        break;
                    case 'double-5-7':
                        intervals = ['5', '7'];
                        break;
                    
                    // ä¸‰å’Œå¼¦éŸ³
                    case 'triple-root-3-5':
                        intervals = ['1', '3', '5'];
                        break;
                    case 'triple-3-5-7':
                        intervals = ['3', '5', '7'];
                        break;
                    case 'triple-random-inversion':
                        // 1,3,5éšæœºè½¬ä½
                        const tripleInversions = [
                            ['1', '3', '5'], // åŸä½
                            ['3', '5', '1'], // ç¬¬ä¸€è½¬ä½  
                            ['5', '1', '3']  // ç¬¬äºŒè½¬ä½
                        ];
                        intervals = tripleInversions[Math.floor(Math.random() * tripleInversions.length)];
                        break;
                    
                    // å››å’Œå¼¦éŸ³
                    case 'quad-root-3-5-7':
                        intervals = ['1', '3', '5', '7'];
                        break;
                    case 'quad-3-5-7-root':
                        intervals = ['3', '5', '7', '1'];
                        break;
                    case 'quad-5-7-root-3':
                        intervals = ['5', '7', '1', '3'];
                        break;
                    case 'quad-7-root-3-5':
                        intervals = ['7', '1', '3', '5'];
                        break;
                    case 'quad-random-inversion':
                        // 1,3,5,7éšæœºè½¬ä½
                        const quadInversions = [
                            ['1', '3', '5', '7'], // åŸä½
                            ['3', '5', '7', '1'], // ç¬¬ä¸€è½¬ä½
                            ['5', '7', '1', '3'], // ç¬¬äºŒè½¬ä½
                            ['7', '1', '3', '5']  // ç¬¬ä¸‰è½¬ä½
                        ];
                        intervals = quadInversions[Math.floor(Math.random() * quadInversions.length)];
                        break;
                    case 'quad-root-3-5-7-root':
                        intervals = ['1', '3', '5', '7', '1'];
                        break;
                    
                    // æ—‹å¾‹ç»“æ„ - Râ†’5th
                    case 'melodic-r-3':
                        // æ—‹å¾‹ç»“æ„1: æ ¹æ®å’Œå¼¦ç±»å‹æ˜ å°„åˆ°ä¸åŒç»“æ„
                        intervals = getMelodicStructure1Intervals(chordType);
                        break;
                    case 'melodic-r-5':
                        intervals = ['1', '5'];
                        break;
                    case 'melodic-3-5':
                        intervals = ['3', '5'];
                        break;
                    case 'melodic-r-3-5':
                        intervals = ['1', '3', '5'];
                        break;
                    case 'melodic-random-inversions':
                        const melodicInversions = [
                            ['1', '3', '5'],
                            ['3', '5', '1'],
                            ['5', '1', '3']
                        ];
                        intervals = melodicInversions[Math.floor(Math.random() * melodicInversions.length)];
                        break;

                    // å…¨éƒ¨å’Œå¼¦éŸ³
                    case 'all-notes':
                        // è¿™ä¸ªé€‰é¡¹ä¼šåœ¨è°ƒç”¨å¤„ç‰¹æ®Šå¤„ç†ï¼Œè¿”å›å’Œå¼¦çš„æ‰€æœ‰éŸ³ç¬¦
                        // è¿™é‡Œè¿”å›ç©ºæ•°ç»„ï¼Œè¡¨ç¤ºéœ€è¦ä½¿ç”¨å’Œå¼¦çš„å®Œæ•´éŸ³ç¨‹
                        intervals = [];
                        break;

                    default:
                        intervals = ['1', '3', '5'];
                }
                
                // å¦‚æœæä¾›äº†å’Œå¼¦ç±»å‹ï¼Œåˆ™æ ¹æ®å’Œå¼¦ç±»å‹è°ƒæ•´éŸ³ç¨‹
                if (chordType) {
                    intervals = adjustIntervalsForChordType(intervals, chordType);
                }
                
                return intervals;
            }
            
            // è·å–å’Œå¼¦çš„ç‰¹å®šéŸ³çº§å¯¹åº”çš„éŸ³ç¬¦
            function getChordTone(root, chordType, interval) {
                const noteIndex = notes.indexOf(root);
                if (noteIndex === -1) return null;
                
                let semitones = 0;
                
                // æ ¹æ®éŸ³çº§å’Œå’Œå¼¦ç±»å‹è®¡ç®—åŠéŸ³æ•°
                switch (interval) {
                    case '1':
                        semitones = 0; // æ ¹éŸ³
                        break;
                    case '3':
                        // ä¸‰éŸ³ï¼šå¤§ä¸‰åº¦æˆ–å°ä¸‰åº¦
                        if (chordType === 'minor' || chordType === 'minor7' || chordType === 'minor6' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 3; // å°ä¸‰åº¦
                        } else {
                            semitones = 4; // å¤§ä¸‰åº¦
                        }
                        break;
                    case '5':
                        // äº”éŸ³ï¼šçº¯äº”åº¦æˆ–å‡äº”åº¦
                        if (chordType === 'minor7b5') {
                            semitones = 6; // å‡äº”åº¦
                        } else {
                            semitones = 7; // çº¯äº”åº¦
                        }
                        break;
                    case '7':
                        // ä¸ƒéŸ³ï¼šå¤§ä¸ƒåº¦æˆ–å°ä¸ƒåº¦
                        if (chordType === 'major7' || chordType === 'major9') {
                            semitones = 11; // å¤§ä¸ƒåº¦
                        } else if (chordType === 'dominant7' || chordType === 'minor7' || chordType === 'dominant9' || chordType === 'minor9' || chordType === 'minor7b5') {
                            semitones = 10; // å°ä¸ƒåº¦
                        } else {
                            semitones = 11; // é»˜è®¤å¤§ä¸ƒåº¦
                        }
                        break;
                    default:
                        semitones = 0;
                }
                
                const targetIndex = (noteIndex + semitones) % 12;
                return notes[targetIndex];
            }


            // è§£æå’Œå¼¦ç¬¦å·

            // æå–éŸ³é˜¶åç§°ï¼ˆä¸åŒ…å«ç»“æ„ä¿¡æ¯ï¼‰
            function getScaleDisplayName(scaleName) {
                // ä»å®Œæ•´åç§°ä¸­æå–éŸ³é˜¶åç§°ï¼Œç§»é™¤ç»“æ„éƒ¨åˆ†
                // ä¾‹å¦‚ï¼š"Major" -> "Major"
                // ä¾‹å¦‚ï¼š"Dorian - 1 2 â™­3 4 5 6 â™­7" -> "Dorian"
                // ä¾‹å¦‚ï¼š"Diminished (Half-Whole) - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7" -> "Diminished"
                
                let displayName = scaleName;
                
                // ç§»é™¤ç ´æŠ˜å·åŠå…¶åé¢çš„æ‰€æœ‰å†…å®¹ï¼ˆéŸ³ç¨‹ç»“æ„ï¼‰
                const dashIndex = displayName.indexOf(' - ');
                if (dashIndex !== -1) {
                    displayName = displayName.substring(0, dashIndex);
                }
                
                // ç§»é™¤æ‹¬å·éƒ¨åˆ†ï¼Œå¦‚ (Half-Whole), (Whole-Half) ç­‰
                displayName = displayName.replace(/\s*\([^)]*\)\s*/g, '');
                
                return displayName.trim();
            }

            // è·å–å’Œå¼¦ç±»å‹çš„æ˜¾ç¤ºåç§°
            function getChordTypeDisplayName(chordType) {
                const displayMode = state.chordNameDisplayMode || 'english';
                
                // è‹±æ–‡åç§°æ˜ å°„
                const englishNames = {
                    'major': 'Major',
                    'minor': 'Minor',
                    'diminished': 'Dim',
                    'augmented': 'Aug',
                    'major6': '6',
                    'minor6': 'm6',
                    'dominant7': '7',
                    'major7': 'Maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7â™­5',
                    'diminished7': 'dim7',
                    'dominant9': '9',
                    'major9': 'Maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7â™¯9',
                    'dominant7flat9': '7â™­9',
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7â™¯11',
                    'dominant13': '13',
                    'minor13': 'm13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                // ç¬¦å·åç§°æ˜ å°„
                const symbolNames = {
                    'major': 'Major',
                    'minor': '-',
                    'diminished': 'Â°',
                    'augmented': '+',
                    'major6': '6',
                    'minor6': '-6',
                    'dominant7': '7',
                    'major7': 'âˆ†7',
                    'minor7': '-7',
                    'minor7b5': 'Ã¸7',
                    'diminished7': 'Â°7',
                    'dominant9': '9',
                    'major9': 'âˆ†9',
                    'minor9': '-9',
                    'dominant7sharp9': '7â™¯9',
                    'dominant7flat9': '7â™­9',
                    'dominant11': '11',
                    'minor11': '-11',
                    'dominant7sharp11': '7â™¯11',
                    'dominant13': '13',
                    'minor13': '-13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    'add9': 'add9',
                    'madd9': '-add9',
                    '6add9': '6add9',
                    'm6add9': '-6add9'
                };
                
                const nameMap = displayMode === 'symbols' ? symbolNames : englishNames;
                return nameMap[chordType] || chordType;
            }

            // æ›´æ–°å’Œå¼¦ç±»å‹æŒ‰é’®çš„æ˜¾ç¤ºæ–‡æœ¬
            function updateChordTypeButtonTexts() {
                const chordTypeBtns = document.querySelectorAll('.chord-type-btn');
                chordTypeBtns.forEach(btn => {
                    const chordType = btn.dataset.value;
                    btn.textContent = getChordTypeDisplayName(chordType);
                });
                
                // æ›´æ–°è‡ªå®šä¹‰å’Œå¼¦ä¸‹æ‹‰æ¡†æ˜¾ç¤º
                updateCustomChordTypeDisplay();
            }

            // å°†å¤åˆéŸ³ç¨‹è½¬æ¢ä¸ºå•éŸ³ç¨‹ï¼ˆç”¨äºæ˜¾ç¤ºå’Œè¯†åˆ«ï¼‰
            function convertCompoundIntervals(intervals) {
                // å¤åˆéŸ³ç¨‹åœ¨å…«åº¦å†…åº”è¯¥æ˜¾ç¤ºä¸ºå¯¹åº”çš„å•éŸ³ç¨‹
                const compoundToSimple = {
                    '9': '2',      // ä¹åº¦ = äºŒåº¦
                    'â™¯9': 'â™¯2',    // å‡ä¹åº¦ = å‡äºŒåº¦
                    'â™­9': 'â™­2',    // é™ä¹åº¦ = é™äºŒåº¦
                    '11': '4',     // åä¸€åº¦ = å››åº¦
                    'â™¯11': 'â™¯4',   // å‡åä¸€åº¦ = å‡å››åº¦
                    'â™­11': 'â™­4',   // é™åä¸€åº¦ = é™å››åº¦
                    '13': '6',     // åä¸‰åº¦ = å…­åº¦
                    'â™¯13': 'â™¯6',   // å‡åä¸‰åº¦ = å‡å…­åº¦
                    'â™­13': 'â™­6'    // é™åä¸‰åº¦ = é™å…­åº¦
                };
                
                return intervals.map(interval => {
                    return compoundToSimple[interval] || interval;
                });
            }

            // åº”ç”¨å’Œå¼¦è½¬ä½
            function applyChordInversion(intervals, bassNote) {
                if (bassNote === 'root') {
                    return intervals;
                }
                
                // æ‰¾åˆ°ç›®æ ‡éŸ³ç¨‹ï¼ˆæ”¯æŒå˜åŒ–éŸ³ç¨‹ï¼‰
                let targetInterval = null;
                let targetIndex = -1;
                
                if (bassNote === '3rd') {
                    // æŸ¥æ‰¾ä¸‰åº¦éŸ³ç¨‹ï¼ˆå¯èƒ½æ˜¯3, â™­3, â™¯3ç­‰ï¼‰
                    for (let i = 0; i < intervals.length; i++) {
                        if (intervals[i].includes('3')) {
                            targetInterval = intervals[i];
                            targetIndex = i;
                            break;
                        }
                    }
                } else if (bassNote === '5th') {
                    // æŸ¥æ‰¾äº”åº¦éŸ³ç¨‹ï¼ˆå¯èƒ½æ˜¯5, â™­5, â™¯5ç­‰ï¼‰
                    for (let i = 0; i < intervals.length; i++) {
                        if (intervals[i].includes('5')) {
                            targetInterval = intervals[i];
                            targetIndex = i;
                            break;
                        }
                    }
                } else if (bassNote === '7th') {
                    // æŸ¥æ‰¾ä¸ƒåº¦éŸ³ç¨‹ï¼ˆå¯èƒ½æ˜¯7, â™­7, â™¯7ç­‰ï¼‰
                    for (let i = 0; i < intervals.length; i++) {
                        if (intervals[i].includes('7')) {
                            targetInterval = intervals[i];
                            targetIndex = i;
                            break;
                        }
                    }
                }
                
                if (!targetInterval || targetIndex === -1) {
                    return intervals;
                }
                
                // åˆ›å»ºæ–°çš„éŸ³ç¨‹æ•°ç»„ï¼Œå°†ç›®æ ‡éŸ³ç¨‹ç§»åˆ°å‰é¢
                const newIntervals = [...intervals];
                const targetIntervalValue = newIntervals.splice(targetIndex, 1)[0];
                newIntervals.unshift(targetIntervalValue);
                
                return newIntervals;
            }

            // è·å–è½¬ä½å’Œå¼¦çš„æ˜¾ç¤ºåç§°
            function getInversionChordName(rootNote, chordType, bassNote) {
                if (bassNote === 'root') {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // è·å–å’Œå¼¦çš„éŸ³ç¨‹ç»“æ„
                const chordIntervals = chordTypes[chordType]?.intervals;
                if (!chordIntervals) {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // æ‰¾åˆ°ç›®æ ‡éŸ³ç¨‹
                let targetInterval = null;
                if (bassNote === '3rd') {
                    targetInterval = chordIntervals.find(interval => interval.includes('3'));
                } else if (bassNote === '5th') {
                    targetInterval = chordIntervals.find(interval => interval.includes('5'));
                } else if (bassNote === '7th') {
                    targetInterval = chordIntervals.find(interval => interval.includes('7'));
                }
                
                if (!targetInterval) {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // è®¡ç®—ä½éŸ³éŸ³ç¬¦çš„åŠéŸ³åç§»
                const semitoneOffset = intervalToSemitones[targetInterval] || 0;
                
                // è®¡ç®—ä½éŸ³éŸ³ç¬¦
                const rootSemitones = noteToSemitones[rootNote] || 0;
                const bassSemitones = (rootSemitones + semitoneOffset) % 12;
                const bassNoteName = Object.keys(noteToSemitones).find(note => 
                    noteToSemitones[note] === bassSemitones
                );
                
                if (!bassNoteName) {
                    return formatChordSymbol(rootNote, chordType);
                }
                
                // è¿”å›æ–œçº¿å’Œå¼¦æ ¼å¼ (å¦‚ C/E)
                const chordSymbol = formatChordSymbol(rootNote, chordType);
                return `${chordSymbol}/${bassNoteName}`;
            }

            // æ ¼å¼åŒ–å’Œå¼¦ç¬¦å·
            function formatChordSymbol(rootNote, chordType) {
                const displayMode = state.chordNameDisplayMode || 'english';
                
                // è‹±æ–‡åç§°æ˜ å°„
                const englishSuffixMap = {
                    // åŸºç¡€ä¸‰å’Œå¼¦
                    'major': '',
                    'minor': 'm',
                    'diminished': 'dim',
                    'augmented': 'aug',
                    
                    // å…­å’Œå¼¦
                    'major6': '6',
                    'minor6': 'm6',
                    
                    // ä¸ƒå’Œå¼¦
                    'dominant7': '7',
                    'major7': 'maj7',
                    'minor7': 'm7',
                    'minor7b5': 'm7â™­5',
                    'diminished7': 'dim7',
                    
                    // ä¹å’Œå¼¦
                    'dominant9': '9',
                    'major9': 'maj9',
                    'minor9': 'm9',
                    'dominant7sharp9': '7â™¯9',
                    'dominant7flat9': '7â™­9',
                    
                    // åä¸€å’Œå¼¦
                    'dominant11': '11',
                    'minor11': 'm11',
                    'dominant7sharp11': '7â™¯11',
                    
                    // åä¸‰å’Œå¼¦
                    'dominant13': '13',
                    'minor13': 'm13',
                    
                    // æŒ‚ç•™å’Œå¼¦
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    
                    // åŠ éŸ³å’Œå¼¦
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                // ç¬¦å·åç§°æ˜ å°„ï¼ˆç”¨âˆ†ä»£æ›¿majç­‰ï¼‰
                const symbolSuffixMap = {
                    // åŸºç¡€ä¸‰å’Œå¼¦
                    'major': '',
                    'minor': '-',
                    'diminished': 'Â°',
                    'augmented': '+',
                    
                    // å…­å’Œå¼¦
                    'major6': '6',
                    'minor6': '-6',
                    
                    // ä¸ƒå’Œå¼¦
                    'dominant7': '7',
                    'major7': 'âˆ†7',
                    'minor7': '-7',
                    'minor7b5': 'Ã¸7',
                    'diminished7': 'Â°7',
                    
                    // ä¹å’Œå¼¦
                    'dominant9': '9',
                    'major9': 'âˆ†9',
                    'minor9': '-9',
                    'dominant7sharp9': '7â™¯9',
                    'dominant7flat9': '7â™­9',
                    
                    // åä¸€å’Œå¼¦
                    'dominant11': '11',
                    'minor11': '-11',
                    'dominant7sharp11': '7â™¯11',
                    
                    // åä¸‰å’Œå¼¦
                    'dominant13': '13',
                    'minor13': '-13',
                    
                    // æŒ‚ç•™å’Œå¼¦
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    
                    // åŠ éŸ³å’Œå¼¦
                    'add9': 'add9',
                    'madd9': '-add9',
                    '6add9': '6add9',
                    'm6add9': '-6add9'
                };
                
                const suffixMap = displayMode === 'symbols' ? symbolSuffixMap : englishSuffixMap;
                return `${rootNote}${suffixMap[chordType] || ''}`;
            }

            // è§£æå’Œå¼¦ç¬¦å·
            function parseChordSymbol(chordSymbol) {
                const match = chordSymbol.match(/^([A-G][\u266f\u266d]?)(.*)$/);
                if (!match) {
                    return { root: 'C', type: 'major' };
                }
                
                const root = match[1];
                let suffix = match[2];
                
                // ç‰¹æ®Šå¤„ç†å¤åˆåç¼€ï¼Œå¦‚7sus4åº”è¯¥ä¿æŒä¸º7sus4ç±»å‹
                // æ£€æŸ¥æ˜¯å¦åŒ…å«sus4ä½†ä¸æ˜¯ä»¥sus4ç»“å°¾
                if (suffix.includes('sus4') && !suffix.endsWith('sus4')) {
                    // å¯¹äº7sus4è¿™æ ·çš„åç¼€ï¼Œæˆ‘ä»¬ä¿æŒä¸º7sus4ç±»å‹
                    // suffix = 'sus4'; // æ³¨é‡Šæ‰ï¼Œä¿æŒåŸå§‹åç¼€
                }
                // åŒæ ·å¤„ç†sus2
                else if (suffix.includes('sus2') && !suffix.endsWith('sus2')) {
                    // å¯¹äº7sus2è¿™æ ·çš„åç¼€ï¼Œæˆ‘ä»¬ä¿æŒä¸º7sus2ç±»å‹
                    // suffix = 'sus2'; // æ³¨é‡Šæ‰ï¼Œä¿æŒåŸå§‹åç¼€
                }
                
                // åˆ›å»ºåç¼€åˆ°å’Œå¼¦ç±»å‹çš„æ˜ å°„
                const typeMap = {
                    '': 'major',
                    'm': 'minor',
                    'dim': 'diminished',
                    'aug': 'augmented',
                    '6': 'major6',
                    'm6': 'minor6',
                    '7': 'dominant7',
                    'maj7': 'major7',
                    'm7': 'minor7',
                    'm7â™­5': 'minor7b5',
                    'dim7': 'diminished7',
                    '9': 'dominant9',
                    'maj9': 'major9',
                    'm9': 'minor9',
                    '7â™¯9': 'dominant7sharp9',
                    '7â™­9': 'dominant7flat9',
                    '11': 'dominant11',
                    'm11': 'minor11',
                    '7â™¯11': 'dominant7sharp11',
                    '13': 'dominant13',
                    'm13': 'minor13',
                    'sus2': 'sus2',
                    'sus4': 'sus4',
                    '7sus2': '7sus2',
                    '7sus4': '7sus4',
                    'add9': 'add9',
                    'madd9': 'madd9',
                    '6add9': '6add9',
                    'm6add9': 'm6add9'
                };
                
                const type = typeMap[suffix] || 'major';
                return { root, type };
            }

            // æ›´æ–°è°ƒæ€§é€‰æ‹©å™¨ï¼Œè®¾ç½®æ­Œæ›²çš„åŸè°ƒä¸ºé»˜è®¤é€‰é¡¹
            function updateKeySelector(songName) {
                const progressionKeyEl = document.getElementById('progressionKey');
                const customDropdown = document.getElementById('progressionKeyDropdown');
                
                // è·å–æ­Œæ›²æ•°æ®
                let songData = null;
                for (const letter in jazzStandards) {
                    if (jazzStandards[letter][songName]) {
                        songData = jazzStandards[letter][songName];
                        break;
                    }
                }
                
                if (!songData) return;
                
                const originalKey = songData.key;
                
                // é‡æ–°ç”ŸæˆåŸç”Ÿselecté€‰é¡¹åˆ—è¡¨
                const allKeys = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                
                progressionKeyEl.innerHTML = '';
                
                allKeys.forEach(key => {
                    const option = document.createElement('option');
                    option.value = key;
                    
                    if (key === originalKey) {
                        option.textContent = `${key} é»˜è®¤`;
                        option.selected = true;
                    } else {
                        option.textContent = key;
                    }
                    
                    progressionKeyEl.appendChild(option);
                });
                
                // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†çš„æ˜¾ç¤º
                if (customDropdown) {
                    const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                    if (trigger) {
                        trigger.textContent = `${originalKey} é»˜è®¤`;
                    }
                    
                    // é‡æ–°ç”Ÿæˆè‡ªå®šä¹‰ä¸‹æ‹‰æ¡†çš„é€‰é¡¹
                    const menu = customDropdown.querySelector('.dropdown-menu');
                    if (menu) {
                        menu.innerHTML = '';
                        
                        allKeys.forEach(key => {
                            const keyLi = document.createElement('li');
                            keyLi.className = 'dropdown-item';
                            keyLi.setAttribute('data-value', key);
                            
                            const itemText = document.createElement('span');
                            itemText.className = 'item-text';
                            if (key === originalKey) {
                                itemText.textContent = `${key} é»˜è®¤`;
                            } else {
                                itemText.textContent = key;
                            }
                            keyLi.appendChild(itemText);
                            
                            menu.appendChild(keyLi);
                        });
                        
                        // é‡æ–°ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
                        const items = menu.querySelectorAll('.dropdown-item');
                        items.forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const value = this.dataset.value;
                                const text = this.querySelector('.item-text').textContent;
                                
                                // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                                trigger.textContent = text;
                                
                                // æ›´æ–°åŸç”Ÿselectçš„å€¼
                                progressionKeyEl.value = value;
                                
                                // è§¦å‘changeäº‹ä»¶
                                const changeEvent = new Event('change', { bubbles: true });
                                progressionKeyEl.dispatchEvent(changeEvent);
                                
                                // å…³é—­ä¸‹æ‹‰èœå•
                                menu.classList.remove('show');
                                customDropdown.querySelector('.dropdown-trigger').classList.remove('active');
                                customDropdown.querySelector('.dropdown-arrow').textContent = 'â–¼';
                            });
                        });
                    }
                }
            }

            // ä¸»é¢˜ç®¡ç†
            const ThemeManager = {
                currentTheme: 'dark',

                init() {
                    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¿å­˜çš„ä¸»é¢˜
                    const savedTheme = localStorage.getItem('appTheme') || 'dark';
                    this.setTheme(savedTheme);
                    this.updateThemeButtons();
                },

                setTheme(theme) {
                    this.currentTheme = theme;
                    localStorage.setItem('appTheme', theme);

                    if (theme === 'light') {
                        document.documentElement.setAttribute('data-theme', 'light');
                        this.applyLightTheme();
                    } else if (theme === 'dark') {
                        document.documentElement.setAttribute('data-theme', 'dark');
                        this.applyDarkTheme();
                    } else if (theme === 'auto') {
                        // è·Ÿéšç³»ç»Ÿä¸»é¢˜
                        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                        const actualTheme = prefersDark ? 'dark' : 'light';
                        document.documentElement.setAttribute('data-theme', actualTheme);

                        if (actualTheme === 'light') {
                            this.applyLightTheme();
                        } else {
                            this.applyDarkTheme();
                        }

                        // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
                        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                            if (this.currentTheme === 'auto') {
                                const newTheme = e.matches ? 'dark' : 'light';
                                document.documentElement.setAttribute('data-theme', newTheme);
                                if (newTheme === 'light') {
                                    this.applyLightTheme();
                                } else {
                                    this.applyDarkTheme();
                                }
                            }
                        });
                    }
                },

                applyLightTheme() {
                    const root = document.documentElement;
                    // èƒŒæ™¯è‰²
                    root.style.setProperty('--bg-glass', 'rgba(255, 255, 255, 0.8)');
                    root.style.setProperty('--bg-glass-hover', 'rgba(255, 255, 255, 0.95)');
                    root.style.setProperty('--bg-white-glass', 'rgba(0, 0, 0, 0.03)');
                    root.style.setProperty('--bg-white-glass-hover', 'rgba(0, 0, 0, 0.08)');
                    root.style.setProperty('--bg-white-glass-disabled', 'rgba(0, 0, 0, 0.01)');

                    // è¾¹æ¡†è‰²
                    root.style.setProperty('--border-glass', 'rgba(0, 0, 0, 0.08)');
                    root.style.setProperty('--border-glass-hover', 'rgba(0, 0, 0, 0.15)');
                    root.style.setProperty('--border-glass-strong', 'rgba(0, 0, 0, 0.25)');

                    // æ–‡å­—è‰²
                    root.style.setProperty('--text-primary', '#1e293b');
                    root.style.setProperty('--text-secondary', '#475569');
                    root.style.setProperty('--text-disabled', 'rgba(0, 0, 0, 0.25)');

                    // æŒ‰é’®å’Œäº¤äº’å…ƒç´ 
                    root.style.setProperty('--btn-primary-bg', 'linear-gradient(135deg, #3b82f6, #2563eb)');
                    root.style.setProperty('--btn-primary-border', '#3b82f6');
                    root.style.setProperty('--btn-primary-text', '#ffffff');
                    root.style.setProperty('--btn-secondary-bg', 'rgba(0, 0, 0, 0.05)');
                    root.style.setProperty('--btn-secondary-border', 'rgba(0, 0, 0, 0.15)');
                    root.style.setProperty('--btn-secondary-text', '#1e293b');

                    // çŠ¶æ€é¢œè‰²
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--warning-color', '#f59e0b');
                    root.style.setProperty('--error-color', '#ef4444');
                    root.style.setProperty('--info-color', '#3b82f6');

                    // é˜´å½±
                    root.style.setProperty('--shadow-light', '0 4px 12px rgba(0, 0, 0, 0.05)');
                    root.style.setProperty('--shadow-medium', '0 8px 24px rgba(0, 0, 0, 0.08)');
                    root.style.setProperty('--shadow-heavy', '0 16px 48px rgba(0, 0, 0, 0.12)');
                },

                applyDarkTheme() {
                    const root = document.documentElement;
                    // èƒŒæ™¯è‰²
                    root.style.setProperty('--bg-glass', 'rgba(30, 41, 59, 0.3)');
                    root.style.setProperty('--bg-glass-hover', 'rgba(30, 41, 59, 0.5)');
                    root.style.setProperty('--bg-white-glass', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--bg-white-glass-hover', 'rgba(255, 255, 255, 0.2)');
                    root.style.setProperty('--bg-white-glass-disabled', 'rgba(255, 255, 255, 0.05)');

                    // è¾¹æ¡†è‰²
                    root.style.setProperty('--border-glass', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--border-glass-hover', 'rgba(255, 255, 255, 0.2)');
                    root.style.setProperty('--border-glass-strong', 'rgba(255, 255, 255, 0.4)');

                    // æ–‡å­—è‰²
                    root.style.setProperty('--text-primary', '#e2e8f0');
                    root.style.setProperty('--text-secondary', '#94a3b8');
                    root.style.setProperty('--text-disabled', 'rgba(255, 255, 255, 0.3)');

                    // æŒ‰é’®å’Œäº¤äº’å…ƒç´ 
                    root.style.setProperty('--btn-primary-bg', 'linear-gradient(135deg, #3b82f6, #1d4ed8)');
                    root.style.setProperty('--btn-primary-border', '#3b82f6');
                    root.style.setProperty('--btn-primary-text', '#ffffff');
                    root.style.setProperty('--btn-secondary-bg', 'rgba(255, 255, 255, 0.1)');
                    root.style.setProperty('--btn-secondary-border', 'rgba(255, 255, 255, 0.2)');
                    root.style.setProperty('--btn-secondary-text', '#e2e8f0');

                    // çŠ¶æ€é¢œè‰²
                    root.style.setProperty('--success-color', '#10b981');
                    root.style.setProperty('--warning-color', '#f59e0b');
                    root.style.setProperty('--error-color', '#ef4444');
                    root.style.setProperty('--info-color', '#3b82f6');

                    // é˜´å½±
                    root.style.setProperty('--shadow-light', '0 4px 12px rgba(0, 0, 0, 0.15)');
                    root.style.setProperty('--shadow-medium', '0 8px 24px rgba(0, 0, 0, 0.25)');
                    root.style.setProperty('--shadow-heavy', '0 16px 48px rgba(0, 0, 0, 0.35)');
                },

                updateThemeButtons() {
                    const themeButtons = document.querySelectorAll('.theme-btn');
                    themeButtons.forEach(btn => {
                        btn.classList.remove('active');
                        if (btn.dataset.theme === this.currentTheme) {
                            btn.classList.add('active');
                        }
                    });
                }
            };

            // åˆå§‹åŒ–ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
            function initThemeButtons() {
                const themeButtons = document.querySelectorAll('.theme-btn');

                themeButtons.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const theme = this.dataset.theme;
                        ThemeManager.setTheme(theme);
                        ThemeManager.updateThemeButtons();
                    });
                });

                // åˆå§‹åŒ–ä¸»é¢˜ç®¡ç†å™¨
                ThemeManager.init();
            }

            // å¤§è°ƒéŸ³é˜¶çš„éŸ³çº§å¯¹åº”å…³ç³»
            const majorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5, 
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // å°è°ƒéŸ³é˜¶çš„éŸ³çº§å¯¹åº”å…³ç³»ï¼ˆä»¥è‡ªç„¶å°è°ƒä¸ºåŸºç¡€ï¼‰
            const minorScaleDegrees = {
                'I': 0, 'bII': 1, 'II': 2, 'bIII': 3, 'III': 4, 'IV': 5,
                'bV': 6, 'V': 7, 'bVI': 8, 'VI': 9, 'bVII': 10, 'VII': 11
            };
            
            // åäºŒå¹³å‡å¾‹éŸ³åæ•°ç»„
            const chromaticNotes = ['C', 'Câ™¯', 'D', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'G', 'Aâ™­', 'A', 'Bâ™­', 'B'];
            const chromaticNotesFlat = ['C', 'Dâ™­', 'D', 'Eâ™­', 'E', 'F', 'Gâ™­', 'G', 'Aâ™­', 'A', 'Bâ™­', 'B'];
            
            // éŸ³ååˆ°æ•°å­—çš„æ˜ å°„
            const noteToNumber = {
                'C': 0, 'Câ™¯': 1, 'Dâ™­': 1, 'D': 2, 'Dâ™¯': 3, 'Eâ™­': 3, 'E': 4, 'F': 5,
                'Fâ™¯': 6, 'Gâ™­': 6, 'G': 7, 'Gâ™¯': 8, 'Aâ™­': 8, 'A': 9, 'Aâ™¯': 10, 'Bâ™­': 10, 'B': 11
            };
            
            // æ ¹æ®è°ƒæ€§é€‰æ‹©åˆé€‚çš„éŸ³åæ•°ç»„ï¼ˆä¼˜å…ˆä½¿ç”¨å‡å·æˆ–é™å·ï¼‰
            function getNotesForKey(key) {
                // å‡å·è°ƒï¼šG, D, A, E, B, Fâ™¯, Câ™¯
                const sharpKeys = ['G', 'D', 'A', 'E', 'B', 'Fâ™¯', 'Câ™¯'];
                // é™å·è°ƒï¼šF, Bâ™­, Eâ™­, Aâ™­, Dâ™­, Gâ™­, Câ™­
                const flatKeys = ['F', 'Bâ™­', 'Eâ™­', 'Aâ™­', 'Dâ™­', 'Gâ™­', 'Câ™­'];
                
                if (sharpKeys.includes(key)) {
                    return chromaticNotes; // ä½¿ç”¨å‡å·
                } else {
                    return chromaticNotesFlat; // ä½¿ç”¨é™å·
                }
            }
            
            // è§£æç½—é©¬æ•°å­—çº§æ•°
            function parseRomanNumeral(roman) {
                // åŒ¹é…ç½—é©¬æ•°å­—éƒ¨åˆ†ï¼ˆåŒ…æ‹¬å¯èƒ½çš„é™å·å‰ç¼€ï¼Œæ”¯æŒâ™­å’Œbï¼‰
                const match = roman.match(/^([â™­b]?)([IVX]+|[ivx]+)/); 
                if (!match) {
                    console.warn(`Cannot parse roman numeral: ${roman}`);
                    return { degree: 'I', isMinor: false, suffix: '' };
                }
                
                const flatPrefix = match[1]; // 'â™­'ã€'b' æˆ–ç©ºå­—ç¬¦ä¸²
                const romanPart = match[2];
                const suffix = roman.replace(match[0], ''); // ç§»é™¤ç½—é©¬æ•°å­—éƒ¨åˆ†åçš„éƒ¨åˆ†
                
                // åˆ¤æ–­æ˜¯å¦ä¸ºå°å†™ï¼ˆå°è°ƒï¼‰
                const isMinor = /[ivx]/.test(romanPart);
                const upperRoman = flatPrefix + romanPart.toUpperCase();
                
                return {
                    degree: upperRoman,
                    isMinor: isMinor,
                    suffix: suffix
                };
            }
            
            // å°†éŸ³çº§è½¬æ¢ä¸ºå…·ä½“çš„éŸ³å
            function degreeToNote(degree, keyRoot, keyMode = 'major') {
                const keyRootNumber = noteToNumber[keyRoot];
                const scaleDegrees = keyMode === 'major' ? majorScaleDegrees : minorScaleDegrees;
                
                if (!(degree in scaleDegrees)) {
                    console.warn(`Unknown degree: ${degree}`);
                    return keyRoot;
                }
                
                const semitones = scaleDegrees[degree];
                const resultNumber = (keyRootNumber + semitones) % 12;
                
                const notesArray = getNotesForKey(keyRoot);
                return notesArray[resultNumber];
            }
            
            // å°†åŸºäºéŸ³çº§çš„å’Œå¼¦è½¬æ¢ä¸ºå…·ä½“è°ƒæ€§çš„å’Œå¼¦
            function transposeChordFromDegree(degreeChord, originalKey, targetKey) {
                const parsed = parseRomanNumeral(degreeChord);
                const targetNote = degreeToNote(parsed.degree, targetKey, 'major');
                
                // æ„å»ºå’Œå¼¦ç¬¦å·
                let chordSymbol = targetNote;
                
                // æ·»åŠ å’Œå¼¦ç±»å‹
                if (parsed.isMinor) {
                    chordSymbol += 'm';
                }
                
                // æ·»åŠ å…¶ä»–åç¼€
                chordSymbol += parsed.suffix;
                
                // å¤„ç†ç‰¹æ®Šç¬¦å·æ›¿æ¢
                chordSymbol = chordSymbol.replace('M7', 'maj7').replace('M', 'maj');
                
                return chordSymbol;
            }

            // è°ƒå¼å¤šé€‰ä¸‹æ‹‰æ¡†ç®¡ç†å™¨
            const ScaleTypeManager = {
                // é€‰ä¸­çš„è°ƒå¼
                selectedScales: new Set(['major']),
                isOpen: false,

                // åˆå§‹åŒ–å¤šé€‰è°ƒå¼åŠŸèƒ½
                init() {
                    console.log('åˆå§‹åŒ–è°ƒå¼å¤šé€‰ä¸‹æ‹‰æ¡†');
                    this.bindEvents();
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                    // é»˜è®¤é€‰ä¸­major
                    this.checkInitialScale();
                },

                // æ£€æŸ¥åˆå§‹è°ƒå¼
                checkInitialScale() {
                    // æ¸…ç©ºselectedScalesï¼Œç„¶åæ ¹æ®å®é™…å¤é€‰æ¡†çŠ¶æ€é‡æ–°è®¾ç½®
                    this.selectedScales.clear();

                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.checked) {
                            this.selectedScales.add(checkbox.value);
                        }
                    });

                    // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„ï¼Œé»˜è®¤é€‰ä¸­major
                    if (this.selectedScales.size === 0) {
                        const majorCheckbox = document.querySelector('.dropdown-option input[value="major"]');
                        if (majorCheckbox) {
                            majorCheckbox.checked = true;
                            this.selectedScales.add('major');
                        }
                    }
                },

                // ç»‘å®šäº‹ä»¶
                bindEvents() {
                    const dropdown = document.getElementById('scaleTypeDropdown');
                    const content = document.getElementById('scaleTypeDropdownContent');

                    // ä¸‹æ‹‰æ¡†ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨å…¨å±é€‰æ‹©å™¨
                    if (dropdown) {
                        dropdown.addEventListener('click', (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            // æ‰“å¼€å…¨å±é€‰æ‹©å™¨è€Œä¸æ˜¯åŸæ¥çš„ä¸‹æ‹‰æ¡†
                            if (typeof openFullscreenSelector === 'function') {
                                openFullscreenSelector('scaleType', 'é€‰æ‹©è°ƒå¼', null);
                            } else {
                                this.toggleDropdown(); // å¤‡ç”¨æ–¹æ¡ˆ
                            }
                        }, true);
                    }

                    // æ§åˆ¶æŒ‰é’®äº‹ä»¶
                    document.getElementById('selectAllScales')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectAll();
                    });

                    document.getElementById('deselectAllScales')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.deselectAll();
                    });

                    document.getElementById('randomSelectScales')?.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.randomSelect();
                    });

                    // è°ƒå¼å¤é€‰æ¡†äº‹ä»¶
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener('change', (e) => {
                            e.stopPropagation();
                            if (checkbox.checked) {
                                this.selectedScales.add(checkbox.value);
                            } else {
                                this.selectedScales.delete(checkbox.value);
                            }
                            this.updateHiddenSelect();
                            this.updateDisplayText();
                            this.updateArpeggioButtons();
                        });
                    });

                    // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
                    document.addEventListener('click', (e) => {
                        if (!dropdown?.contains(e.target)) {
                            this.closeDropdown();
                        }
                    });

                    // é˜»æ­¢ä¸‹æ‹‰å†…å®¹ç‚¹å‡»äº‹ä»¶å†’æ³¡
                    if (content) {
                        content.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                    }
                },

                // åˆ‡æ¢ä¸‹æ‹‰æ¡†æ˜¾ç¤ºçŠ¶æ€
                toggleDropdown() {
                    if (this.isOpen) {
                        this.closeDropdown();
                    } else {
                        this.openDropdown();
                    }
                },

                // æ‰“å¼€ä¸‹æ‹‰æ¡†
                openDropdown() {
                    const dropdown = document.getElementById('scaleTypeDropdown');
                    const content = document.getElementById('scaleTypeDropdownContent');
                    const startBtn = document.getElementById('startBtn');

                    if (dropdown && content) {
                        dropdown.classList.add('active');
                        content.classList.add('show');
                        this.isOpen = true;

                        // éšè—å¼€å§‹ç»ƒä¹ æŒ‰é’®ä»¥é¿å…é®æŒ¡
                        if (startBtn) {
                            startBtn.style.visibility = 'hidden';
                            startBtn.style.opacity = '0';
                            startBtn.style.pointerEvents = 'none';
                        }
                    }
                },

                // å…³é—­ä¸‹æ‹‰æ¡†
                closeDropdown() {
                    const dropdown = document.getElementById('scaleTypeDropdown');
                    const content = document.getElementById('scaleTypeDropdownContent');
                    const startBtn = document.getElementById('startBtn');

                    if (dropdown && content) {
                        dropdown.classList.remove('active');
                        content.classList.remove('show');
                        this.isOpen = false;

                        // æ¢å¤å¼€å§‹ç»ƒä¹ æŒ‰é’®æ˜¾ç¤º
                        if (startBtn) {
                            startBtn.style.visibility = 'visible';
                            startBtn.style.opacity = '1';
                            startBtn.style.pointerEvents = 'auto';
                        }
                    }
                },

                // å…¨é€‰
                selectAll() {
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                        this.selectedScales.add(checkbox.value);
                    });
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                },

                // å…¨ä¸é€‰
                deselectAll() {
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    this.selectedScales.clear();
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                },

                // éšæœºé€‰æ‹©
                randomSelect() {
                    const checkboxes = document.querySelectorAll('.dropdown-option input[type="checkbox"]');
                    const availableScales = Array.from(checkboxes).map(cb => cb.value);

                    // éšæœºé€‰æ‹©1-5ä¸ªè°ƒå¼
                    const count = Math.floor(Math.random() * 5) + 1;
                    const selected = this.shuffleArray(availableScales).slice(0, count);

                    // æ›´æ–°å¤é€‰æ¡†çŠ¶æ€
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = selected.includes(checkbox.value);
                    });

                    // æ›´æ–°é€‰ä¸­çš„è°ƒå¼
                    this.selectedScales = new Set(selected);
                    this.updateHiddenSelect();
                    this.updateDisplayText();
                    this.updateArpeggioButtons();
                },

                // æ´—ç‰Œç®—æ³•
                shuffleArray(array) {
                    const shuffled = [...array];
                    for (let i = shuffled.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                    }
                    return shuffled;
                },

                // æ›´æ–°æ˜¾ç¤ºæ–‡æœ¬
                updateDisplayText() {
                    const displayText = document.querySelector('.selected-text');
                    if (displayText) {
                        if (this.selectedScales.size === 0) {
                            displayText.textContent = 'é€‰æ‹©è°ƒå¼...';
                        } else {
                            // æ ¹æ®é€‰æ‹©æ•°é‡å†³å®šæ˜¾ç¤ºæ–¹å¼
                            if (this.selectedScales.size <= 2) {
                                // 1-2ä¸ªè°ƒå¼ï¼Œæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼ˆåŒ…å«éŸ³çº§ç»“æ„ï¼‰
                                const selectedNames = Array.from(this.selectedScales).map(scale => this.getScaleDisplayName(scale));
                                displayText.textContent = selectedNames.join(', ');
                            } else {
                                // è¶…è¿‡2ä¸ªè°ƒå¼ï¼Œåªæ˜¾ç¤ºè°ƒå¼åï¼ˆä¸åŒ…å«éŸ³çº§ç»“æ„ï¼‰
                                const selectedShortNames = Array.from(this.selectedScales).map(scale => this.getScaleShortName(scale));

                                if (this.selectedScales.size <= 5) {
                                    // 3-5ä¸ªè°ƒå¼ï¼Œæ˜¾ç¤ºå…¨éƒ¨ç®€ç§°
                                    displayText.textContent = selectedShortNames.join(', ');
                                } else {
                                    // è¶…è¿‡5ä¸ªï¼Œæ˜¾ç¤ºå‰å‡ ä¸ª + "ç­‰Nä¸ª"
                                    const firstFew = selectedShortNames.slice(0, 4);
                                    displayText.textContent = `${firstFew.join(', ')} ç­‰${this.selectedScales.size}ä¸ª`;
                                }
                            }
                        }
                    }
                },

                // æ›´æ–°éšè—çš„selectå…ƒç´ 
                updateHiddenSelect() {
                    const hiddenSelect = document.getElementById('scaleType');
                    if (hiddenSelect && this.selectedScales.size > 0) {
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹
                        hiddenSelect.innerHTML = '';

                        // æ·»åŠ é€‰ä¸­çš„è°ƒå¼
                        this.selectedScales.forEach(scale => {
                            const option = document.createElement('option');
                            option.value = scale;
                            option.selected = true;
                            option.textContent = this.getScaleDisplayName(scale);
                            hiddenSelect.appendChild(option);
                        });
                    }
                },

                // è·å–è°ƒå¼æ˜¾ç¤ºåç§°
                getScaleDisplayName(scaleType) {
                    const scaleNames = {
                        'major': 'Major - 1 2 3 4 5 6 7',
                        'minor': 'Minor - 1 2 â™­3 4 5 â™­6 â™­7',
                        'ionian': 'Ionian - 1 2 3 4 5 6 7',
                        'dorian': 'Dorian - 1 2 â™­3 4 5 6 â™­7',
                        'phrygian': 'Phrygian - 1 â™­2 â™­3 4 5 â™­6 â™­7',
                        'lydian': 'Lydian - 1 2 3 â™¯4 5 6 7',
                        'mixolydian': 'Mixolydian - 1 2 3 4 5 6 â™­7',
                        'aeolian': 'Aeolian - 1 2 â™­3 4 5 â™­6 â™­7',
                        'locrian': 'Locrian - 1 â™­2 â™­3 4 â™­5 â™­6 â™­7',
                        'harmonicMinor': 'Harmonic Minor - 1 2 â™­3 4 5 â™­6 7',
                        'melodicMinor': 'Melodic Minor - 1 2 â™­3 4 5 6 7',
                        'majorPentatonic': 'Major Pentatonic - 1 2 3 5 6',
                        'minorPentatonic': 'Minor Pentatonic - 1 â™­3 4 5 â™­7',
                        'blues': 'Blues - 1 â™­3 4 â™¯4 5 â™­7',
                        'wholeTone': 'Whole Tone - 1 2 3 â™¯4 â™¯5 â™¯6',
                        'diminished': 'Diminished - 1 â™­2 â™­3 3 â™¯4 5 6 â™­7'
                    };
                    return scaleNames[scaleType] || scaleType;
                },

                // è·å–è°ƒå¼ç®€ç§°ï¼ˆä¸åŒ…å«éŸ³çº§ç»“æ„ï¼‰
                getScaleShortName(scaleType) {
                    const scaleNames = {
                        'major': 'Major',
                        'minor': 'Minor',
                        'ionian': 'Ionian',
                        'dorian': 'Dorian',
                        'phrygian': 'Phrygian',
                        'lydian': 'Lydian',
                        'mixolydian': 'Mixolydian',
                        'aeolian': 'Aeolian',
                        'locrian': 'Locrian',
                        'harmonicMinor': 'Harmonic Minor',
                        'melodicMinor': 'Melodic Minor',
                        'majorPentatonic': 'Major Pentatonic',
                        'minorPentatonic': 'Minor Pentatonic',
                        'blues': 'Blues',
                        'wholeTone': 'Whole Tone',
                        'diminished': 'Diminished'
                    };
                    return scaleNames[scaleType] || scaleType;
                },

                // è·å–éšæœºé€‰ä¸­çš„è°ƒå¼ç±»å‹
                getRandomSelectedScaleType() {
                    if (this.selectedScales.size === 0) return 'major';
                    const selectedArray = Array.from(this.selectedScales);
                    return selectedArray[Math.floor(Math.random() * selectedArray.length)];
                },

                // æ›´æ–°ç¶éŸ³æŒ‰é’®
                updateArpeggioButtons() {
                    // è·å–å½“å‰é€‰ä¸­çš„è°ƒå¼
                    let currentScaleType = 'major';
                    if (this.selectedScales.size > 0) {
                        currentScaleType = Array.from(this.selectedScales)[0];
                    }

                    // è°ƒç”¨åŸæœ‰çš„ç¶éŸ³æŒ‰é’®æ›´æ–°å‡½æ•°
                    if (typeof updateArpeggioButtons === 'function') {
                        // ä¸´æ—¶ä¿®æ”¹scaleTypeçš„å€¼ä¸ºå½“å‰é€‰ä¸­çš„è°ƒå¼
                        const hiddenSelect = document.getElementById('scaleType');
                        if (hiddenSelect) {
                            const originalValue = hiddenSelect.value;
                            hiddenSelect.value = currentScaleType;
                            updateArpeggioButtons();
                            hiddenSelect.value = originalValue;
                        }
                    }
                }
            };

            // å°†ScaleTypeManageræš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.ScaleTypeManager = ScaleTypeManager;
            window.getRandomSelectedScaleType = ScaleTypeManager.getRandomSelectedScaleType.bind(ScaleTypeManager);

            // åº”ç”¨åˆå§‹åŒ–æ ‡å¿—
            let appInitialized = false;
            
            // åˆå§‹åŒ–åº”ç”¨å‡½æ•°
            function initializeApplication() {
                if (appInitialized) {
                    console.log('åº”ç”¨å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
                    return;
                }
                
                console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨');
                appInitialized = true;

                // åˆå§‹åŒ–è°ƒå¼å¤šé€‰åŠŸèƒ½
                ScaleTypeManager.init();

                // å¯åŠ¨åº”ç”¨
                if (typeof initApp === 'function') {
                    initApp();
                } else {
                    console.error('initAppå‡½æ•°æœªå®šä¹‰');
                }
                
                // è¯­è¨€è®¾ç½®å·²åœ¨ç¬¬ä¸€ä¸ªscriptæ ‡ç­¾ä¸­åˆå§‹åŒ–
                
                // åº”ç”¨ç¿»è¯‘
                if (typeof applyTranslations === 'function') {
                    applyTranslations();
                } else {
                    console.error('applyTranslationså‡½æ•°æœªå®šä¹‰');
                }
                
                // åˆå§‹åŒ–è¯­è¨€åˆ‡æ¢æŒ‰é’®
                initLanguageButtons();

                // åˆå§‹åŒ–ä¸»é¢˜åˆ‡æ¢æŒ‰é’®
                initThemeButtons();
                
                // åˆå§‹åŒ–å’Œå¼¦ç±»å‹æŒ‰é’®æ–‡æœ¬
                setTimeout(() => {
                    updateChordTypeButtonTexts();
                }, 100);
            }
            
            // å°†stateæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.state = state;
            
            // ç­‰å¾…DOMåŠ è½½å®Œæˆåå†åˆå§‹åŒ–åº”ç”¨
            if (document.readyState === 'complete' || document.readyState === 'interactive') {
                console.log('DOMå·²åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–åº”ç”¨');
                initializeApplication();
            } else {
                console.log('DOMæœªåŠ è½½å®Œæˆï¼Œç­‰å¾…DOMContentLoadedäº‹ä»¶');
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('DOMContentLoadedäº‹ä»¶è§¦å‘ï¼Œåˆå§‹åŒ–åº”ç”¨');
                    initializeApplication();
                });
            }
        });
    </script>
    
    <script>
        // å…¨å±é€‰æ‹©å™¨åŠŸèƒ½
        (function() {
            const fullscreenSelector = document.getElementById('fullscreenSelector');
            const fullscreenSelectorBack = document.getElementById('fullscreenSelectorBack');
            const fullscreenSelectorTitle = document.getElementById('fullscreenSelectorTitle');
            const fullscreenSelectorContent = document.getElementById('fullscreenSelectorContent');
            
            let currentSelectorType = null;
            let currentCallback = null;
            
            // æ‰“å¼€å…¨å±é€‰æ‹©å™¨
            window.openFullscreenSelector = function(type, title, callback, selectId) {
                currentSelectorType = type;
                currentCallback = callback;
                fullscreenSelectorTitle.textContent = title;
                
                // æ ¹æ®ç±»å‹ç”Ÿæˆä¸åŒçš„å†…å®¹
                if (type === 'progressionLevel') {
                    generateProgressionLevelContent();
                } else if (type === 'jazzStandard') {
                    generateJazzStandardContent();
                } else if (type === 'progressionKey') {
                    generateProgressionKeyContent();
                } else if (type === 'rootNote') {
                    generateRootNoteContent(selectId || 'rootNote');
                } else if (type === 'scaleType') {
                    generateScaleTypeContent();
                } else if (type === 'chordRootNote') {
                    generateRootNoteContent(selectId || 'chordRootNote');
                } else if (type === 'customChordRoot') {
                    generateRootNoteContent('customChordRoot');
                } else if (type === 'customChordType') {
                    generateChordTypeContent();
                } else if (type === 'customChordBass') {
                    generateCustomChordBassContent();
                } else if (type === 'pitchFindingTime') {
                    generatePitchFindingTimeContent();
                } else if (type === 'rootNoteSelect') {
                    generateRootNoteSelectContent();
                }
                
                fullscreenSelector.classList.add('active');
            };
            
            // ç®€å•æ–¹æ¡ˆ1: ç›´æ¥ä½¿ç”¨æµè§ˆå™¨åŸç”Ÿtooltip
            function showNativeTooltip(element, descKey) {
                const infoText = window.t ? window.t(descKey) : descKey;
                element.title = infoText.replace(/\n/g, ' | ');
            }

            // ç®€å•æ–¹æ¡ˆ2: åœ¨æŒ‰é’®ä¸‹æ–¹æ·»åŠ å¯å±•å¼€çš„è¯´æ˜æ–‡å­—
            function toggleDescription(element, descKey) {
                const infoText = window.t ? window.t(descKey) : descKey;
                const selectorItem = element.closest('.selector-item');

                // æŸ¥æ‰¾æˆ–åˆ›å»ºè¯´æ˜å®¹å™¨
                let descContainer = selectorItem.querySelector('.item-description');
                if (descContainer) {
                    // å¦‚æœå·²å­˜åœ¨ï¼Œåˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
                    descContainer.style.display = descContainer.style.display === 'none' ? 'block' : 'none';
                    if (descContainer.style.display === 'none') {
                        element.textContent = 'â„¹ï¸';
                    } else {
                        element.textContent = 'âœ–ï¸';
                    }
                } else {
                    // åˆ›å»ºè¯´æ˜å®¹å™¨
                    descContainer = document.createElement('div');
                    descContainer.className = 'item-description';
                    descContainer.innerHTML = infoText.replace(/\n/g, '<br>');
                    selectorItem.appendChild(descContainer);
                    element.textContent = 'âœ–ï¸';

                    // è‡ªåŠ¨å…³é—­å…¶ä»–è¯´æ˜
                    document.querySelectorAll('.item-description').forEach(desc => {
                        if (desc !== descContainer) {
                            desc.remove();
                            const otherIcon = desc.closest('.selector-item').querySelector('.info-icon');
                            if (otherIcon) otherIcon.textContent = 'â„¹ï¸';
                        }
                    });
                }
            }

            // ç®€å•æ–¹æ¡ˆ3: åœ¨é€‰æ‹©å™¨é¡¶éƒ¨æ˜¾ç¤ºè¯´æ˜åŒºåŸŸ
            let currentTopDescription = null;
            function showTopDescription(descKey, buttonText) {
                const infoText = window.t ? window.t(descKey) : descKey;

                // ç§»é™¤ä¹‹å‰çš„è¯´æ˜
                if (currentTopDescription) {
                    currentTopDescription.remove();
                }

                // æŸ¥æ‰¾æˆ–åˆ›å»ºé¡¶éƒ¨è¯´æ˜åŒºåŸŸ
                let topDesc = document.querySelector('.top-description');
                if (!topDesc) {
                    topDesc = document.createElement('div');
                    topDesc.className = 'top-description';
                    const content = document.querySelector('.fullscreen-selector-content');
                    if (content) {
                        content.insertBefore(topDesc, content.firstChild);
                    }
                }

                topDesc.innerHTML = `
                    <strong>${buttonText}</strong>: ${infoText.replace(/\n/g, ' | ')}
                    <button class="close-desc" onclick="this.parentElement.remove()">Ã—</button>
                `;

                currentTopDescription = topDesc;
            }

            // æ˜¾ç¤ºhoveræç¤º
            function showTooltip(element, descKey) {
                const infoText = window.t ? window.t(descKey) : descKey;

                // åˆ›å»ºtooltipå…ƒç´ 
                const tooltip = document.createElement('div');
                tooltip.className = 'info-tooltip';
                tooltip.innerHTML = infoText.replace(/\n/g, '<br>');

                document.body.appendChild(tooltip);

                // è®¡ç®—ä½ç½®
                const rect = element.getBoundingClientRect();
                const tooltipRect = tooltip.getBoundingClientRect();

                // è®¾ç½®tooltipä½ç½®ï¼Œåœ¨æŒ‰é’®ä¸Šæ–¹
                tooltip.style.left = rect.left + (rect.width / 2) - (tooltipRect.width / 2) + 'px';
                tooltip.style.top = rect.top - tooltipRect.height - 8 + 'px';

                // æ·»åŠ æ˜¾ç¤ºåŠ¨ç”»
                requestAnimationFrame(() => {
                    tooltip.classList.add('show');
                });

                return tooltip;
            }

            // éšè—hoveræç¤º
            function hideTooltip(tooltip) {
                if (tooltip && tooltip.parentNode) {
                    tooltip.classList.remove('show');
                    setTimeout(() => {
                        if (tooltip.parentNode) {
                            tooltip.parentNode.removeChild(tooltip);
                        }
                    }, 200);
                }
            }

            // å…³é—­å…¨å±é€‰æ‹©å™¨
            function closeFullscreenSelector() {
                fullscreenSelector.classList.remove('active');
                currentSelectorType = null;
                currentCallback = null;
            }
            
            // è¿”å›æŒ‰é’®äº‹ä»¶
            fullscreenSelectorBack.addEventListener('click', closeFullscreenSelector);
            
            // ç”Ÿæˆç»ƒä¹ ç­‰çº§é€‰æ‹©å†…å®¹
            function generateProgressionLevelContent() {
                const levelSelect = document.getElementById('progressionLevel');
                const currentValue = levelSelect.value;

                const levels = {
                    'chord_single_notes': [
                        { value: 'single-root', text: '1', desc: 'root' },
                        { value: 'single-3', text: '3', desc: 'third' },
                        { value: 'single-5', text: '5', desc: 'fifth' },
                        { value: 'single-7', text: '7', desc: 'seventh' }
                    ],
                    'chord_double_notes': [
                        { value: 'double-root-3', text: '1,3', desc: 'root_third' },
                        { value: 'double-root-5', text: '1,5', desc: 'root_fifth' },
                        { value: 'double-root-7', text: '1,7', desc: 'root_seventh' },
                        { value: 'double-3-5', text: '3,5', desc: 'third_fifth' },
                        { value: 'double-3-7', text: '3,7', desc: 'third_seventh' }
                    ],
                    'chord_triple_notes': [
                        { value: 'triple-root-3-5', text: '1,3,5', desc: 'root_third_fifth' },
                        { value: 'triple-3-5-7', text: '3,5,7', desc: 'third_fifth_seventh' },
                        { value: 'triple-random-inversion', text: '1,3,5éšæœºè½¬ä½', desc: 'random_inversions_135' }
                    ],
                    'chord_quad_notes': [
                        { value: 'quad-root-3-5-7', text: '1,3,5,7', desc: 'root_third_fifth_seventh' },
                        { value: 'quad-3-5-7-root', text: '3,5,7,1', desc: 'first_inversion' },
                        { value: 'quad-5-7-root-3', text: '5,7,1,3', desc: 'second_inversion' },
                        { value: 'quad-7-root-3-5', text: '7,1,3,5', desc: 'third_inversion' },
                        { value: 'quad-random-inversion', text: '1,3,5,7éšæœºè½¬ä½', desc: 'random_inversions_1357' },
                        { value: 'quad-root-3-5-7-root', text: '1,3,5,7,1', desc: 'with_octave_root' }
                    ],
                    'chord_all_notes': [
                        { value: 'all-notes', text: 'å…¨éƒ¨', desc: 'all_notes' }
                    ],
                    'melodic_structure_r_to_5th': [
                        { value: 'melodic-r-3', text: 'æ—‹å¾‹ç»“æ„1', desc: 'root_to_third' },
                        { value: 'melodic-r-5', text: 'æ—‹å¾‹ç»“æ„2', desc: 'root_to_fifth' },
                        { value: 'melodic-3-5', text: 'æ—‹å¾‹ç»“æ„3', desc: 'third_to_fifth' },
                        { value: 'melodic-r-3-5', text: 'æ—‹å¾‹ç»“æ„4', desc: 'root_third_fifth_line' },
                        { value: 'melodic-random-inversions', text: 'æ—‹å¾‹ç»“æ„5-éšæœºè½¬ä½', desc: 'random_inversions' }
                    ],
                    'melodic_structure_5th_to_9th': [
                        { value: 'melodic-5-7', text: '5â†’7', desc: 'fifth_to_seventh' },
                        { value: 'melodic-7-9', text: '7â†’9', desc: 'seventh_to_ninth' },
                        { value: 'melodic-5-9', text: '5â†’9', desc: 'fifth_to_ninth' },
                        { value: 'melodic-5-7-9', text: '5â†’7â†’9', desc: 'fifth_seventh_ninth_line' }
                    ],
                    'voice_led_structure': [
                        { value: 'voice-led-stepwise', text: 'çº§è¿›è¿æ¥', desc: 'stepwise_voice_leading' },
                        { value: 'voice-led-common', text: 'å…±åŒéŸ³ä¿æŒ', desc: 'common_tone_voice_leading' },
                        { value: 'voice-led-contrary', text: 'åå‘è¿›è¡Œ', desc: 'contrary_motion_voice_leading' },
                        { value: 'voice-led-parallel', text: 'å¹³è¡Œè¿›è¡Œ', desc: 'parallel_motion_voice_leading' }
                    ],
                    'suspension_structure': [
                        { value: 'sus4-sus2', text: 'Sus4â†’Sus2', desc: 'sus4_to_sus2' },
                        { value: 'sus4-resolve', text: 'Sus4â†’3', desc: 'sus4_to_third' },
                        { value: 'sus2-resolve', text: 'Sus2â†’3', desc: 'sus2_to_third' },
                        { value: 'sus-resolve-chain', text: 'æŒ‚ç•™è§£å†³é“¾', desc: 'suspension_resolution_chain' }
                    ],
                    'chord_scale_structure': [
                        { value: 'chord-scale-triadic', text: 'ä¸‰å’Œå¼¦éŸ³é˜¶', desc: 'triadic_chord_scales' },
                        { value: 'chord-scale-seventh', text: 'ä¸ƒå’Œå¼¦éŸ³é˜¶', desc: 'seventh_chord_scales' },
                        { value: 'chord-scale-extended', text: 'æ‰©å±•å’Œå¼¦éŸ³é˜¶', desc: 'extended_chord_scales' },
                        { value: 'chord-scale-modal', text: 'è°ƒå¼å’Œå¼¦éŸ³é˜¶', desc: 'modal_chord_scales' }
                    ],
                    'passing_tone_structure': [
                        { value: 'passing-diatonic', text: 'è‡ªç„¶ç»è¿‡éŸ³', desc: 'diatonic_passing_tones' },
                        { value: 'passing-chromatic', text: 'åŠéŸ³ç»è¿‡éŸ³', desc: 'chromatic_passing_tones' },
                        { value: 'passing-enclosure', text: 'åŒ…å›´éŸ³', desc: 'enclosure_passing_tones' },
                        { value: 'passing-appoggiatura', text: 'è£…é¥°éŸ³', desc: 'appoggiatura_passing_tones' }
                    ]
                };

                let html = '<div class="selector-grid">';

                for (const [groupName, items] of Object.entries(levels)) {
                    html += `<div class="selector-group-title" data-i18n-key="${groupName}">â— ${window.t ? window.t(groupName) : groupName}</div>`;
                    html += '<div class="selector-group">';
                    items.forEach(item => {
                        const isActive = item.value === currentValue ? 'active' : '';
                        const translatedText = item.text.includes('éšæœºè½¬ä½') ? (window.t && window.getCurrentLanguage() === 'en' ? item.text.replace('éšæœºè½¬ä½', 'Random Inversions') : item.text) : item.text;

                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ—‹å¾‹ç»“æ„ç›¸å…³çš„åˆ†ç»„
                        const isMelodicStructureGroup = groupName.includes('melodic_structure') ||
                                                   groupName.includes('voice_led_structure') ||
                                                   groupName.includes('suspension_structure') ||
                                                   groupName.includes('chord_scale_structure') ||
                                                   groupName.includes('passing_tone_structure');

                        if (isMelodicStructureGroup) {
                            html += `
                                <div class="selector-item ${isActive}" data-value="${item.value}">
                                    <div class="selector-item-title">${translatedText}</div>
                                    <div class="info-icon" data-info="${item.desc}" title="ç‚¹å‡»æŸ¥çœ‹è¯´æ˜">â„¹ï¸</div>
                                </div>
                            `;
                        } else {
                            html += `
                                <div class="selector-item ${isActive}" data-value="${item.value}">
                                    <div class="selector-item-title">${translatedText}</div>
                                    <div class="selector-item-desc" data-i18n-key="${item.desc}">${window.t ? window.t(item.desc) : item.desc}</div>
                                </div>
                            `;
                        }
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;

                // ä½¿ç”¨é€šç”¨çš„äº‹ä»¶ç»‘å®šå‡½æ•°
                bindSelectorItemClickEvents();

                // ç»‘å®šinfoå›¾æ ‡ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç®€å•æ–¹æ¡ˆ
                const infoIcons = fullscreenSelectorContent.querySelectorAll('.info-icon');
                infoIcons.forEach(icon => {
                    // è®¾ç½®åŸç”Ÿtooltipï¼ˆæœ€ç®€å•çš„æ–¹æ¡ˆï¼‰
                    const descKey = icon.getAttribute('data-info');
                    showNativeTooltip(icon, descKey);

                    // ç‚¹å‡»ä½¿ç”¨æ–¹æ¡ˆ2ï¼šåœ¨æŒ‰é’®ä¸‹æ–¹å±•å¼€è¯´æ˜
                    icon.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        const descKey = this.getAttribute('data-info');
                        const buttonText = this.previousElementSibling.textContent;

                        // æ–¹æ¡ˆ2ï¼šå±•å¼€è¯´æ˜
                        toggleDescription(this, descKey);

                        // æˆ–è€…ä½¿ç”¨æ–¹æ¡ˆ3ï¼šåœ¨é¡¶éƒ¨æ˜¾ç¤ºï¼ˆå–æ¶ˆä¸‹é¢çš„æ³¨é‡Šï¼Œæ³¨é‡Šä¸Šé¢çš„æ–¹æ¡ˆ2ï¼‰
                        // showTopDescription(descKey, buttonText);
                    });
                });

                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­çš„é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }

            // ç›‘å¬è¯­è¨€å˜åŒ–äº‹ä»¶ï¼Œæ›´æ–°å½“å‰æ˜¾ç¤ºçš„é€‰æ‹©å™¨å†…å®¹
            window.addEventListener('languageChanged', function(event) {
                if (currentSelectorType && fullscreenSelector.classList.contains('active')) {
                    // æ›´æ–°æ ‡é¢˜
                    const titleKey = currentSelectorType === 'progressionLevel' ? 'progression_level' :
                                   currentSelectorType === 'jazzStandard' ? 'select_tune' :
                                   currentSelectorType === 'progressionKey' ? 'select_key' : '';
                    if (titleKey && window.t) {
                        fullscreenSelectorTitle.textContent = window.t(titleKey);
                    }

                    // é‡æ–°ç”Ÿæˆå½“å‰é€‰æ‹©å™¨å†…å®¹ä»¥æ›´æ–°è¯­è¨€
                    if (currentSelectorType === 'progressionLevel') {
                        generateProgressionLevelContent();
                    } else if (currentSelectorType === 'jazzStandard') {
                        generateJazzStandardContent();
                    } else if (currentSelectorType === 'progressionKey') {
                        generateProgressionKeyContent();
                    }
                    // é‡æ–°ç»‘å®šç‚¹å‡»äº‹ä»¶
                    bindSelectorItemClickEvents();

                    // é‡æ–°ç»‘å®šinfoå›¾æ ‡ç‚¹å‡»äº‹ä»¶ - ä½¿ç”¨ç®€å•æ–¹æ¡ˆ
                    const infoIcons = fullscreenSelectorContent.querySelectorAll('.info-icon');
                    infoIcons.forEach(icon => {
                        // è®¾ç½®åŸç”Ÿtooltip
                        const descKey = icon.getAttribute('data-info');
                        showNativeTooltip(icon, descKey);

                        // ç‚¹å‡»äº‹ä»¶
                        icon.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();

                            const descKey = this.getAttribute('data-info');
                            const buttonText = this.previousElementSibling.textContent;

                            // æ–¹æ¡ˆ2ï¼šå±•å¼€è¯´æ˜
                            toggleDescription(this, descKey);

                            // æˆ–è€…ä½¿ç”¨æ–¹æ¡ˆ3ï¼šåœ¨é¡¶éƒ¨æ˜¾ç¤º
                            // showTopDescription(descKey, buttonText);
                        });
                    });
                }
            });

            // ç»‘å®šé€‰æ‹©å™¨é¡¹ç›®ç‚¹å‡»äº‹ä»¶çš„é€šç”¨å‡½æ•°
            function bindSelectorItemClickEvents() {
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.replaceWith(item.cloneNode(true)); // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨
                });

                const newItems = fullscreenSelectorContent.querySelectorAll('.selector-item');
                newItems.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;

                        if (currentSelectorType === 'progressionLevel') {
                            const levelSelect = document.getElementById('progressionLevel');
                            levelSelect.value = value;

                            // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ˜¾ç¤º
                            const customDropdown = document.getElementById('progressionLevelDropdown');
                            if (customDropdown) {
                                const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                                if (trigger) {
                                    trigger.textContent = text;
                                }

                                // æ›´æ–°activeçŠ¶æ€
                                const allItems = customDropdown.querySelectorAll('.dropdown-item');
                                allItems.forEach(item => item.classList.remove('active'));
                                const activeItem = customDropdown.querySelector(`.dropdown-item[data-value="${value}"]`);
                                if (activeItem) {
                                    activeItem.classList.add('active');
                                }
                            }

                            // è§¦å‘changeäº‹ä»¶
                            levelSelect.dispatchEvent(new Event('change'));
                        }

                        if (currentCallback) {
                            currentCallback(value, text);
                        }

                        closeFullscreenSelector();
                    });
                });
            }

            // ç”Ÿæˆä¹æ›²é€‰æ‹©å†…å®¹
            function generateJazzStandardContent() {
                const jazzStandardSelect = document.getElementById('jazzStandard');
                const currentValue = jazzStandardSelect.value;
                
                // æŒ‰å­—æ¯åˆ†ç»„çš„æ­Œæ›²
                const groups = {};
                const options = jazzStandardSelect.querySelectorAll('option');
                
                let currentGroup = '';
                options.forEach(option => {
                    const parent = option.parentElement;
                    if (parent.tagName === 'OPTGROUP') {
                        currentGroup = parent.label;
                        if (!groups[currentGroup]) {
                            groups[currentGroup] = [];
                        }
                        groups[currentGroup].push({
                            value: option.value,
                            text: option.textContent
                        });
                    }
                });
                
                // æ·»åŠ æœç´¢æ¡†
                let html = `
                    <div class="selector-search-box">
                        <input type="text" 
                               id="songSearchInput" 
                               class="selector-search-input" 
                               placeholder="æœç´¢æ­Œæ›²å..." data-i18n-key="search_song_placeholder" 
                               autocomplete="off">
                        <span class="selector-search-icon">ğŸ”</span>
                    </div>
                    <div class="selector-list" id="songListContainer">
                `;
                
                for (const [groupName, songs] of Object.entries(groups)) {
                    html += `<div class="selector-group-title" data-group="${groupName}">â— ${groupName}</div>`;
                    songs.forEach(song => {
                        const isActive = song.value === currentValue ? 'active' : '';
                        html += `
                            <div class="selector-list-item ${isActive}" data-value="${song.value}" data-song-name="${song.text}" data-group="${groupName}">
                                <div class="selector-list-item-name">${song.text}</div>
                                <div class="selector-list-item-info">
                                    <div class="selector-list-item-badge">${groupName}</div>
                                    <span class="selector-info-icon" data-song-info="${song.value}">â„¹ï¸</span>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-list-item');
                items.forEach(item => {
                    item.addEventListener('click', function(e) {
                        // å¦‚æœç‚¹å‡»çš„æ˜¯ä¿¡æ¯å›¾æ ‡ï¼Œä¸æ‰§è¡Œé€‰æ‹©æ“ä½œ
                        if (e.target.classList.contains('selector-info-icon')) {
                            return;
                        }
                        
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-list-item-name').textContent;
                        
                        // æ›´æ–°åŸç”Ÿselect
                        jazzStandardSelect.value = value;
                        
                        // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ˜¾ç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        const customDropdown = document.getElementById('jazzStandardDropdown');
                        if (customDropdown) {
                            const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                            if (trigger) {
                                trigger.textContent = text;
                            }
                        }
                        
                        // è§¦å‘changeäº‹ä»¶
                        jazzStandardSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // ç»‘å®šä¿¡æ¯å›¾æ ‡ç‚¹å‡»äº‹ä»¶
                const infoIcons = fullscreenSelectorContent.querySelectorAll('.selector-info-icon');
                infoIcons.forEach(icon => {
                    icon.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const songName = this.dataset.songInfo;
                        
                        // è°ƒç”¨æ˜¾ç¤ºæ­Œæ›²ä¿¡æ¯çš„å‡½æ•°
                        if (typeof window.showSongInfo === 'function') {
                            window.showSongInfo(songName);
                        }
                    });
                });
                
                // æœç´¢åŠŸèƒ½
                const searchInput = document.getElementById('songSearchInput');
                if (searchInput) {
                    searchInput.focus(); // è‡ªåŠ¨èšç„¦æœç´¢æ¡†
                    
                    searchInput.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase().trim();
                        const allItems = fullscreenSelectorContent.querySelectorAll('.selector-list-item');
                        const allGroupTitles = fullscreenSelectorContent.querySelectorAll('.selector-group-title');
                        
                        if (!searchTerm) {
                            // æ¸…ç©ºæœç´¢æ—¶æ˜¾ç¤ºæ‰€æœ‰é¡¹ç›®
                            allItems.forEach(item => item.style.display = '');
                            allGroupTitles.forEach(title => title.style.display = '');
                        } else {
                            // æœç´¢åŒ¹é…
                            const visibleGroups = new Set();
                            
                            allItems.forEach(item => {
                                const songName = item.dataset.songName.toLowerCase();
                                if (songName.includes(searchTerm)) {
                                    item.style.display = '';
                                    visibleGroups.add(item.dataset.group);
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                            
                            // åªæ˜¾ç¤ºæœ‰æ­Œæ›²çš„åˆ†ç»„æ ‡é¢˜
                            allGroupTitles.forEach(title => {
                                if (visibleGroups.has(title.dataset.group)) {
                                    title.style.display = '';
                                } else {
                                    title.style.display = 'none';
                                }
                            });
                        }
                    });
                }
                
                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­çš„é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-list-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // ç”Ÿæˆè°ƒæ€§é€‰æ‹©å†…å®¹
            function generateProgressionKeyContent() {
                const keySelect = document.getElementById('progressionKey');
                const currentValue = keySelect.value;
                
                const keys = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                
                // è·å–å½“å‰é€‰ä¸­ä¹æ›²çš„åŸè°ƒ
                const jazzStandardSelect = document.getElementById('jazzStandard');
                const selectedSong = jazzStandardSelect.value;
                
                // æŸ¥æ‰¾åŸè°ƒ
                let originalKey = 'C';
                if (typeof jazzStandards !== 'undefined') {
                    for (const letter in jazzStandards) {
                        if (jazzStandards[letter][selectedSong]) {
                            originalKey = jazzStandards[letter][selectedSong].key;
                            break;
                        }
                    }
                }
                
                let html = '<div class="selector-grid">';
                
                keys.forEach(key => {
                    const isActive = key === currentValue ? 'active' : '';
                    const isOriginal = key === originalKey;
                    const displayText = isOriginal ? `${key} é»˜è®¤` : key;
                    const desc = isOriginal ? 'æ­Œæ›²åŸè°ƒ' : 'ç§»è°ƒ';
                    
                    html += `
                        <div class="selector-item ${isActive}" data-value="${key}">
                            <div class="selector-item-title">${displayText}</div>
                            <div class="selector-item-desc">${desc}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        // æ›´æ–°åŸç”Ÿselect
                        keySelect.value = value;
                        
                        // æ›´æ–°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ˜¾ç¤º
                        const customDropdown = document.getElementById('progressionKeyDropdown');
                        if (customDropdown) {
                            const trigger = customDropdown.querySelector('.dropdown-trigger .dropdown-text');
                            if (trigger) {
                                trigger.textContent = text;
                            }
                        }
                        
                        // è§¦å‘changeäº‹ä»¶
                        keySelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­çš„é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // ç”Ÿæˆæ ¹éŸ³é€‰æ‹©å†…å®¹ï¼ˆé€šç”¨ï¼‰
            function generateRootNoteContent(selectId) {
                let currentValue;
                
                // å¯¹äºè‡ªå®šä¹‰å’Œå¼¦å¼¹çª—ï¼Œä½¿ç”¨å½“å‰é€‰æ‹©çš„æ ¹éŸ³å€¼
                if (selectId === 'customChordRoot') {
                    currentValue = window.currentChordRoot;
                } else {
                const rootNoteSelect = document.getElementById(selectId);
                    currentValue = rootNoteSelect ? rootNoteSelect.value : 'C';
                }
                
                const notes = ['C', 'Câ™¯', 'Dâ™­', 'D', 'Dâ™¯', 'Eâ™­', 'E', 'F', 'Fâ™¯', 'Gâ™­', 'G', 'Gâ™¯', 'Aâ™­', 'A', 'Aâ™¯', 'Bâ™­', 'B'];
                
                let html = '<div class="selector-grid">';
                
                notes.forEach(note => {
                    const isActive = note === currentValue ? 'active' : '';
                    html += `
                        <div class="selector-item ${isActive}" data-value="${note}">
                            <div class="selector-item-title">${note}</div>
                            <div class="selector-item-desc" data-i18n-key="key_desc">è°ƒæ€§</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        rootNoteSelect.value = value;
                        rootNoteSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, value);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // ç”ŸæˆéŸ³é˜¶ç±»å‹é€‰æ‹©å†…å®¹
            // ç”ŸæˆéŸ³é˜¶ç±»å‹é€‰æ‹©å†…å®¹ï¼ˆå¤šé€‰æ¨¡å¼ï¼‰
            function generateScaleTypeContent() {
                // è·å–å½“å‰å·²é€‰ä¸­çš„è°ƒå¼
                const currentSelectedScales = window.ScaleTypeManager ?
                    Array.from(window.ScaleTypeManager.selectedScales) : ['major'];

                // æ·»åŠ æ§åˆ¶æŒ‰é’®åˆ°header
                const fullscreenSelectorHeader = document.querySelector('.fullscreen-selector-header');
                const originalButtons = fullscreenSelectorHeader.innerHTML;

                // æ·»åŠ æ§åˆ¶æŒ‰é’®
                fullscreenSelectorHeader.innerHTML = `
                    <button class="fullscreen-selector-back" id="fullscreenSelectorBack">
                        <span>â†</span>
                        <span data-i18n-key="btn_back">è¿”å›</span>
                    </button>
                    <h2 class="fullscreen-selector-title" id="fullscreenSelectorTitle">é€‰æ‹©è°ƒå¼</h2>
                    <div class="scale-controls" style="margin-left: auto; display: flex; gap: 8px;">
                        <button class="scale-control-btn" id="selectAllScales" data-i18n-key="select_all">å…¨é€‰</button>
                        <button class="scale-control-btn" id="deselectAllScales" data-i18n-key="deselect_all">å…¨ä¸é€‰</button>
                        <button class="scale-control-btn" id="randomSelectScales" data-i18n-key="random_select">éšæœºé€‰æ‹©</button>
                    </div>
                `;

                // ä½¿ç”¨window.scaleTypeså¯¹è±¡ç»„ç»‡éŸ³é˜¶ç±»å‹æ•°æ®
                const scaleGroups = {
                    'åŸºæœ¬è°ƒå¼': [
                        { value: 'major', title: 'Major', desc: '1 2 3 4 5 6 7' },
                        { value: 'minor', title: 'Minor', desc: '1 2 â™­3 4 5 â™­6 â™­7' }
                    ],
                    'æ•™ä¼šè°ƒå¼ (Church Modes)': [
                        { value: 'ionian', title: 'Ionian', desc: '1 2 3 4 5 6 7' },
                        { value: 'dorian', title: 'Dorian', desc: '1 2 â™­3 4 5 6 â™­7' },
                        { value: 'phrygian', title: 'Phrygian', desc: '1 â™­2 â™­3 4 5 â™­6 â™­7' },
                        { value: 'lydian', title: 'Lydian', desc: '1 2 3 â™¯4 5 6 7' },
                        { value: 'mixolydian', title: 'Mixolydian', desc: '1 2 3 4 5 6 â™­7' },
                        { value: 'aeolian', title: 'Aeolian', desc: '1 2 â™­3 4 5 â™­6 â™­7' },
                        { value: 'locrian', title: 'Locrian', desc: '1 â™­2 â™­3 4 â™­5 â™­6 â™­7' }
                    ],
                    'å’Œå£°å°è°ƒç³»åˆ—': [
                        { value: 'harmonicMinor', title: 'Harmonic Minor', desc: '1 2 â™­3 4 5 â™­6 7' },
                        { value: 'dorianSharp2', title: 'Dorian â™¯2', desc: '1 â™¯2 3 4 5 6 â™­7' },
                        { value: 'phrygianMajor', title: 'Phrygian Major', desc: '1 â™­2 3 4 5 â™­6 â™­7' },
                        { value: 'lydianSharp2', title: 'Lydian â™¯2', desc: '1 â™¯2 3 â™¯4 5 6 7' },
                        { value: 'mixolydianFlat6', title: 'Mixolydian â™­6', desc: '1 2 3 4 5 â™­6 â™­7' },
                        { value: 'lydianFlat2', title: 'Lydian â™­2', desc: '1 â™­2 3 â™¯4 5 6 7' },
                        { value: 'superLocrianDiminished', title: 'Super Locrian Dim', desc: '1 â™­2 â™­3 â™­4 â™­5 â™­6 6' }
                    ],
                    'æ—‹å¾‹å°è°ƒç³»åˆ—': [
                        { value: 'melodicMinor', title: 'Melodic Minor', desc: '1 2 â™­3 4 5 6 7' },
                        { value: 'melodicMinorDescending', title: 'Melodic Minor Desc', desc: '1 â™­7 â™­6 5 4 â™­3 2 1' },
                        { value: 'dorianFlat2', title: 'Dorian â™­2', desc: '1 â™­2 â™­3 4 5 6 â™­7' },
                        { value: 'lydianAugmented', title: 'Lydian Augmented', desc: '1 2 3 â™¯4 â™¯5 6 7' },
                        { value: 'lydianFlat7', title: 'Lydian â™­7', desc: '1 2 3 â™¯4 5 6 â™­7' },
                        { value: 'aeolianFlat5', title: 'Aeolian â™­5', desc: '1 2 â™­3 4 â™­5 â™­6 â™­7' },
                        { value: 'superLocrian', title: 'Super Locrian', desc: '1 â™­2 â™­3 â™­4 â™­5 â™­6 â™­7' }
                    ],
                    'äº”å£°éŸ³é˜¶': [
                        { value: 'majorPentatonic', title: 'Major Pentatonic', desc: '1 2 3 5 6' },
                        { value: 'minorPentatonic', title: 'Minor Pentatonic', desc: '1 â™­3 4 5 â™­7' },
                        { value: 'dorianPentatonic', title: 'Dorian Pentatonic', desc: '1 2 â™­3 5 6' },
                        { value: 'phrygianPentatonic', title: 'Phrygian Pentatonic', desc: '1 â™­2 4 5 â™­6' },
                        { value: 'mixolydianPentatonic', title: 'Mixolydian Pentatonic', desc: '1 2 3 5 â™­7' }
                    ],
                    'å¸ƒé²æ–¯éŸ³é˜¶': [
                        { value: 'blues', title: 'Blues', desc: '1 â™­3 4 â™¯4 5 â™­7' },
                        { value: 'majorBlues', title: 'Major Blues', desc: '1 2 â™­3 3 5 6' }
                    ],
                    'ç‰¹æ®ŠéŸ³é˜¶': [
                        { value: 'wholeTone', title: 'Whole Tone', desc: '1 2 3 â™¯4 â™¯5 â™¯6' },
                        { value: 'diminished', title: 'Diminished HW', desc: '1 â™­2 â™­3 3 â™¯4 5 6 â™­7' },
                        { value: 'diminishedWhole', title: 'Diminished WH', desc: '1 2 â™­3 â™¯4 â™¯5 6 7' },
                        { value: 'arabic', title: 'Arabic', desc: '1 â™­2 3 4 5 â™­6 â™­7' },
                        { value: 'gypsy', title: 'Gypsy', desc: '1 â™­2 3 4 5 â™­6 7' },
                        { value: 'japanese', title: 'Japanese', desc: '1 â™­2 4 5 â™­6' },
                        { value: 'egyptian', title: 'Egyptian', desc: '1 2 4 5 â™­7' },
                        { value: 'hungarian', title: 'Hungarian', desc: '1 â™¯2 3 â™¯4 5 â™­6 7' },
                        { value: 'persian', title: 'Persian', desc: '1 â™­2 3 4 â™­5 â™­6 7' },
                        { value: 'byzantine', title: 'Byzantine', desc: '1 â™­2 3 4 5 â™­6 7' },
                        { value: 'enigmatic', title: 'Enigmatic', desc: '1 â™­2 3 â™¯4 â™¯5 â™¯6 7' },
                        { value: 'neapolitan', title: 'Neapolitan', desc: '1 â™­2 â™­3 4 5 â™­6 7' },
                        { value: 'spanish', title: 'Spanish', desc: '1 â™­2 3 4 5 â™­6 â™­7' }
                    ]
                };

                let html = '<div class="selector-grid">';

                for (const [groupName, scales] of Object.entries(scaleGroups)) {
                    html += `<div class="selector-group-title">â— ${groupName}</div>`;
                    html += '<div class="selector-group">';
                    scales.forEach(scale => {
                        const isActive = currentSelectedScales.includes(scale.value) ? 'active' : '';
                        html += `
                            <div class="selector-item ${isActive}" data-value="${scale.value}">
                                <div class="selector-item-title">${scale.title}</div>
                                <div class="selector-item-desc">${scale.desc}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;

                // ç»‘å®šæ§åˆ¶æŒ‰é’®äº‹ä»¶
                const allScales = [];
                for (const scales of Object.values(scaleGroups)) {
                    allScales.push(...scales.map(s => s.value));
                }

                document.getElementById('selectAllScales').addEventListener('click', () => {
                    const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                    items.forEach(item => item.classList.add('active'));
                    if (window.ScaleTypeManager) {
                        window.ScaleTypeManager.selectedScales.clear();
                        allScales.forEach(scale => window.ScaleTypeManager.selectedScales.add(scale));
                        window.ScaleTypeManager.updateHiddenSelect();
                        window.ScaleTypeManager.updateDisplayText();
                        window.ScaleTypeManager.updateArpeggioButtons();
                    }
                });

                document.getElementById('deselectAllScales').addEventListener('click', () => {
                    const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                    items.forEach(item => item.classList.remove('active'));
                    if (window.ScaleTypeManager) {
                        window.ScaleTypeManager.selectedScales.clear();
                        window.ScaleTypeManager.updateHiddenSelect();
                        window.ScaleTypeManager.updateDisplayText();
                        window.ScaleTypeManager.updateArpeggioButtons();
                    }
                });

                document.getElementById('randomSelectScales').addEventListener('click', () => {
                    const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                    items.forEach(item => item.classList.remove('active'));

                    // éšæœºé€‰æ‹©3-8ä¸ªè°ƒå¼
                    const randomCount = Math.floor(Math.random() * 6) + 3;
                    const shuffled = [...allScales].sort(() => Math.random() - 0.5);
                    const selected = shuffled.slice(0, randomCount);

                    items.forEach(item => {
                        if (selected.includes(item.dataset.value)) {
                            item.classList.add('active');
                        }
                    });

                    if (window.ScaleTypeManager) {
                        window.ScaleTypeManager.selectedScales.clear();
                        selected.forEach(scale => window.ScaleTypeManager.selectedScales.add(scale));
                        window.ScaleTypeManager.updateHiddenSelect();
                        window.ScaleTypeManager.updateDisplayText();
                        window.ScaleTypeManager.updateArpeggioButtons();
                    }
                });

                // ç»‘å®šè°ƒå¼é€‰æ‹©ç‚¹å‡»äº‹ä»¶ï¼ˆå¤šé€‰æ¨¡å¼ï¼‰
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;

                        // åˆ‡æ¢é€‰ä¸­çŠ¶æ€
                        this.classList.toggle('active');

                        // æ›´æ–°ScaleTypeManagerçš„çŠ¶æ€
                        if (window.ScaleTypeManager) {
                            if (this.classList.contains('active')) {
                                window.ScaleTypeManager.selectedScales.add(value);
                            } else {
                                window.ScaleTypeManager.selectedScales.delete(value);
                            }
                            window.ScaleTypeManager.updateHiddenSelect();
                            window.ScaleTypeManager.updateDisplayText();
                            window.ScaleTypeManager.updateArpeggioButtons();
                        }
                    });
                });

                // æ»šåŠ¨åˆ°ç¬¬ä¸€ä¸ªé€‰ä¸­é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);

                // è¿”å›æ—¶æ¢å¤åŸå§‹header
                const originalBackHandler = fullscreenSelectorBack.onclick;
                const newBackHandler = function() {
                    // æ¢å¤åŸå§‹headerå†…å®¹
                    fullscreenSelectorHeader.innerHTML = originalButtons;
                    // é‡æ–°ç»‘å®šè¿”å›æŒ‰é’®
                    const backBtn = fullscreenSelectorHeader.querySelector('.fullscreen-selector-back');
                    if (backBtn) {
                        backBtn.addEventListener('click', originalBackHandler);
                    }
                    // å…³é—­é€‰æ‹©å™¨
                    closeFullscreenSelector();
                };

                // é‡æ–°ç»‘å®šè¿”å›æŒ‰é’®
                const backBtn = fullscreenSelectorHeader.querySelector('.fullscreen-selector-back');
                if (backBtn) {
                    backBtn.addEventListener('click', newBackHandler);
                }
            }
            
            // ç”Ÿæˆå’Œå¼¦ç±»å‹é€‰æ‹©å†…å®¹
            function generateChordTypeContent() {
                // å¯¹äºè‡ªå®šä¹‰å’Œå¼¦å¼¹çª—ï¼Œä½¿ç”¨å½“å‰é€‰æ‹©çš„å’Œå¼¦ç±»å‹å€¼
                const currentValue = window.currentChordType;
                
                const chordTypes = {
                    'åŸºç¡€å’Œå¼¦': [
                        { value: 'major', text: 'å¤§ä¸‰å’Œå¼¦' },
                        { value: 'minor', text: 'å°ä¸‰å’Œå¼¦' },
                        { value: 'diminished', text: 'å‡ä¸‰å’Œå¼¦' },
                        { value: 'augmented', text: 'å¢ä¸‰å’Œå¼¦' }
                    ],
                    'å…­å’Œå¼¦': [
                        { value: 'major6', text: 'å¤§å…­å’Œå¼¦' },
                        { value: 'minor6', text: 'å°å…­å’Œå¼¦' }
                    ],
                    'ä¸ƒå’Œå¼¦': [
                        { value: 'dominant7', text: 'å±ä¸ƒå’Œå¼¦' },
                        { value: 'major7', text: 'å¤§ä¸ƒå’Œå¼¦' },
                        { value: 'minor7', text: 'å°ä¸ƒå’Œå¼¦' },
                        { value: 'minor7b5', text: 'åŠå‡ä¸ƒå’Œå¼¦' },
                        { value: 'diminished7', text: 'å‡ä¸ƒå’Œå¼¦' }
                    ],
                    'æ‰©å±•å’Œå¼¦': [
                        { value: 'dominant9', text: 'å±ä¹å’Œå¼¦' },
                        { value: 'major9', text: 'å¤§ä¹å’Œå¼¦' },
                        { value: 'minor9', text: 'å°ä¹å’Œå¼¦' },
                        { value: 'dominant7sharp9', text: 'å±7â™¯9å’Œå¼¦' },
                        { value: 'dominant7flat9', text: 'å±7â™­9å’Œå¼¦' },
                        { value: 'dominant11', text: 'å±11å’Œå¼¦' },
                        { value: 'minor11', text: 'å°11å’Œå¼¦' },
                        { value: 'dominant7sharp11', text: 'å±7â™¯11å’Œå¼¦' },
                        { value: 'dominant13', text: 'å±13å’Œå¼¦' },
                        { value: 'minor13', text: 'å°13å’Œå¼¦' }
                    ],
                    'æŒ‚ç•™å’Œå¼¦': [
                        { value: 'sus2', text: 'æŒ‚äºŒå’Œå¼¦' },
                        { value: 'sus4', text: 'æŒ‚å››å’Œå¼¦' }
                    ],
                    'åŠ éŸ³å’Œå¼¦': [
                        { value: 'add9', text: 'åŠ ä¹å’Œå¼¦' },
                        { value: 'madd9', text: 'å°åŠ ä¹å’Œå¼¦' },
                        { value: '6add9', text: 'å…­åŠ ä¹å’Œå¼¦' },
                        { value: 'm6add9', text: 'å°å…­åŠ ä¹å’Œå¼¦' }
                    ]
                };
                
                let html = '<div class="selector-grid">';
                
                for (const [groupName, chords] of Object.entries(chordTypes)) {
                    html += `<div class="selector-group-title">â— ${groupName}</div>`;
                    html += '<div class="selector-group">';
                    chords.forEach(chord => {
                        const isActive = chord.value === currentValue ? 'active' : '';
                        html += `
                            <div class="selector-item ${isActive}" data-value="${chord.value}">
                                <div class="selector-item-title">${chord.text}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        chordTypeSelect.value = value;
                        chordTypeSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }

            // ç”Ÿæˆè½¬ä½é€‰æ‹©å†…å®¹
            function generateCustomChordBassContent() {
                const currentValue = window.currentChordBass;
                
                const bassOptions = [
                    { value: 'root', text: 'æ ¹éŸ³', desc: 'åŸä½å’Œå¼¦' },
                    { value: '3rd', text: 'ä¸‰éŸ³', desc: 'ç¬¬ä¸€è½¬ä½' },
                    { value: '5th', text: 'äº”éŸ³', desc: 'ç¬¬äºŒè½¬ä½' },
                    { value: '7th', text: 'ä¸ƒéŸ³', desc: 'ç¬¬ä¸‰è½¬ä½' }
                ];

                let html = '<div class="selector-grid">';

                bassOptions.forEach(option => {
                    const isActive = option.value === currentValue ? 'active' : '';

                    html += `
                        <div class="selector-item ${isActive}" data-value="${option.value}">
                            <div class="selector-item-title">${option.text}</div>
                            <div class="selector-item-desc">${window.t ? window.t(option.desc) : option.desc}</div>
                        </div>
                    `;
                });

                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
            }
            
            // ç”Ÿæˆæ‰¾éŸ³ç»ƒä¹ æ—¶é—´é€‰æ‹©å†…å®¹
            function generatePitchFindingTimeContent() {
                const timeSelect = document.getElementById('pitchFindingTime');
                const currentValue = timeSelect.value;
                
                const times = [
                    { value: '1', text: '1åˆ†é’Ÿ', desc: 'å¿«é€Ÿç»ƒä¹ ' },
                    { value: '2', text: '2åˆ†é’Ÿ', desc: 'çŸ­æ—¶ç»ƒä¹ ' },
                    { value: '3', text: '3åˆ†é’Ÿ', desc: 'å¸¸è§„ç»ƒä¹ ' },
                    { value: '5', text: '5åˆ†é’Ÿ', desc: 'æ ‡å‡†ç»ƒä¹ ' },
                    { value: '10', text: '10åˆ†é’Ÿ', desc: 'æ·±åº¦ç»ƒä¹ ' },
                    { value: '15', text: '15åˆ†é’Ÿ', desc: 'å¼ºåŒ–ç»ƒä¹ ' },
                    { value: '30', text: '30åˆ†é’Ÿ', desc: 'ä¸“ä¸šç»ƒä¹ ' }
                ];
                
                let html = '<div class="selector-grid">';
                
                times.forEach(time => {
                    const isActive = time.value === currentValue ? 'active' : '';
                    html += `
                        <div class="selector-item ${isActive}" data-value="${time.value}">
                            <div class="selector-item-title">${time.text}</div>
                            <div class="selector-item-desc">${time.desc}</div>
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        timeSelect.value = value;
                        timeSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // ç”Ÿæˆæ ¹éŸ³é€‰æ‹©å†…å®¹ï¼ˆéŸ³ç¨‹ç»ƒä¹ ï¼‰
            function generateRootNoteSelectContent() {
                const rootNoteSelect = document.getElementById('rootNoteSelect');
                const currentValue = rootNoteSelect.value;
                
                const notes = [
                    { value: 'random', text: 'éšæœº', desc: 'éšæœºæ ¹éŸ³' },
                    { value: 'C', text: 'C', desc: '' },
                    { value: 'Câ™¯', text: 'Câ™¯', desc: '' },
                    { value: 'Dâ™­', text: 'Dâ™­', desc: '' },
                    { value: 'D', text: 'D', desc: '' },
                    { value: 'Dâ™¯', text: 'Dâ™¯', desc: '' },
                    { value: 'Eâ™­', text: 'Eâ™­', desc: '' },
                    { value: 'E', text: 'E', desc: '' },
                    { value: 'F', text: 'F', desc: '' },
                    { value: 'Fâ™¯', text: 'Fâ™¯', desc: '' },
                    { value: 'Gâ™­', text: 'Gâ™­', desc: '' },
                    { value: 'G', text: 'G', desc: '' },
                    { value: 'Gâ™¯', text: 'Gâ™¯', desc: '' },
                    { value: 'Aâ™­', text: 'Aâ™­', desc: '' },
                    { value: 'A', text: 'A', desc: '' },
                    { value: 'Aâ™¯', text: 'Aâ™¯', desc: '' },
                    { value: 'Bâ™­', text: 'Bâ™­', desc: '' },
                    { value: 'B', text: 'B', desc: '' }
                ];
                
                let html = '<div class="selector-grid">';
                
                notes.forEach(note => {
                    const isActive = note.value === currentValue ? 'active' : '';
                    html += `
                        <div class="selector-item ${isActive}" data-value="${note.value}">
                            <div class="selector-item-title">${note.text}</div>
                            ${note.desc ? `<div class="selector-item-desc">${note.desc}</div>` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                fullscreenSelectorContent.innerHTML = html;
                
                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                const items = fullscreenSelectorContent.querySelectorAll('.selector-item');
                items.forEach(item => {
                    item.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.querySelector('.selector-item-title').textContent;
                        
                        rootNoteSelect.value = value;
                        rootNoteSelect.dispatchEvent(new Event('change'));
                        
                        if (currentCallback) {
                            currentCallback(value, text);
                        }
                        
                        closeFullscreenSelector();
                    });
                });
                
                // æ»šåŠ¨åˆ°å½“å‰é€‰ä¸­é¡¹
                setTimeout(() => {
                    const activeItem = fullscreenSelectorContent.querySelector('.selector-item.active');
                    if (activeItem) {
                        activeItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 100);
            }
            
            // ä¸ºselectæ·»åŠ ç‚¹å‡»è¦†ç›–å±‚çš„é€šç”¨å‡½æ•°
            function addSelectOverlay(selectId, type, title) {
                const select = document.getElementById(selectId);
                if (!select) return;
                
                const wrapper = select.parentElement;
                if (!wrapper) return;
                
                // æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¦†ç›–å±‚
                if (wrapper.querySelector('.select-overlay')) return;
                
                const overlay = document.createElement('div');
                overlay.className = 'select-overlay';
                overlay.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    cursor: pointer;
                    z-index: 1;
                `;
                
                wrapper.style.position = 'relative';
                wrapper.appendChild(overlay);
                
                overlay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openFullscreenSelector(type, title, null, selectId);
                });
            }
            
            // ä¿®æ”¹ç°æœ‰ä¸‹æ‹‰æ¡†çš„ç‚¹å‡»äº‹ä»¶
            document.addEventListener('DOMContentLoaded', function() {
                // åˆå§‹åŒ–è‡ªå®šä¹‰å’Œå¼¦å¼¹çª—
                initCustomChordsDialog();
                // ç»ƒä¹ ç­‰çº§ä¸‹æ‹‰æ¡†
                const progressionLevelDropdown = document.getElementById('progressionLevelDropdown');
                if (progressionLevelDropdown) {
                    const trigger = progressionLevelDropdown.querySelector('.dropdown-trigger');
                    if (trigger) {
                        // ç§»é™¤åŸæœ‰äº‹ä»¶ï¼Œæ·»åŠ æ–°äº‹ä»¶
                        const newTrigger = trigger.cloneNode(true);
                        trigger.parentNode.replaceChild(newTrigger, trigger);
                        
                        newTrigger.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenSelector('progressionLevel', 'ç»ƒä¹ ç­‰çº§', null);
                        });
                    }
                }
                
                // ä¹æ›²ä¸‹æ‹‰æ¡†
                const jazzStandardDropdown = document.getElementById('jazzStandardDropdown');
                if (jazzStandardDropdown) {
                    const trigger = jazzStandardDropdown.querySelector('.dropdown-trigger');
                    if (trigger) {
                        // ç§»é™¤åŸæœ‰äº‹ä»¶ï¼Œæ·»åŠ æ–°äº‹ä»¶
                        const newTrigger = trigger.cloneNode(true);
                        trigger.parentNode.replaceChild(newTrigger, trigger);
                        
                        newTrigger.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenSelector('jazzStandard', 'é€‰æ‹©ä¹æ›²', null);
                        });
                    }
                }
                
                // è°ƒæ€§ä¸‹æ‹‰æ¡†
                const progressionKeyDropdown = document.getElementById('progressionKeyDropdown');
                if (progressionKeyDropdown) {
                    const trigger = progressionKeyDropdown.querySelector('.dropdown-trigger');
                    if (trigger) {
                        // ç§»é™¤åŸæœ‰äº‹ä»¶ï¼Œæ·»åŠ æ–°äº‹ä»¶
                        const newTrigger = trigger.cloneNode(true);
                        trigger.parentNode.replaceChild(newTrigger, trigger);
                        
                        newTrigger.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            openFullscreenSelector('progressionKey', 'é€‰æ‹©è°ƒæ€§', null);
                        });
                    }
                }
                
                // éŸ³é˜¶è®¾ç½® - æ ¹éŸ³é€‰æ‹©
                addSelectOverlay('rootNote', 'rootNote', 'é€‰æ‹©è°ƒæ€§');

                // éŸ³é˜¶è®¾ç½® - éŸ³é˜¶ç±»å‹é€‰æ‹© - å·²åœ¨ScaleTypeManagerä¸­å¤„ç†å…¨å±é€‰æ‹©å™¨
                
                // å’Œå¼¦è®¾ç½® - å’Œå¼¦æ ¹éŸ³é€‰æ‹©
                addSelectOverlay('chordRootNote', 'chordRootNote', 'é€‰æ‹©å’Œå¼¦æ ¹éŸ³');
                
                // æ‰¾éŸ³ç»ƒä¹  - ç»ƒä¹ æ—¶é—´
                addSelectOverlay('pitchFindingTime', 'pitchFindingTime', 'é€‰æ‹©ç»ƒä¹ æ—¶é—´');
                
                // æ‰¾éŸ³ç»ƒä¹  - æ ¹éŸ³è®¾ç½®
                addSelectOverlay('rootNoteSelect', 'rootNoteSelect', 'é€‰æ‹©æ ¹éŸ³');
            });
        })();
    </script>
    
    <script>
        // æµ‹è¯•è‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨åˆå§‹åŒ–ï¼ˆå·²ç§»é™¤é‡å¤è°ƒç”¨ï¼‰
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œè‡ªå®šä¹‰ä¸‹æ‹‰åˆ—è¡¨åº”è¯¥å·²ç»åˆå§‹åŒ–');
    </script>


  </body>
</html>
