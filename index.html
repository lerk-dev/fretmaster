<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="dark">
    <meta name="theme-color" content="#0f0f0f">
    <meta name="msapplication-navbutton-color" content="#0f0f0f">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title data-i18n-key="page_title">🎸 吉他练习工具 v3.7</title>

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="styles/main.css">

    <!-- 轻量 i18n 引导（会懒加载 locales/*.json） -->
    <script type="module">
    // 简化的 i18n 客户端：按需加载 /locales/{locale}.json 并把文本插入到具有 data-i18n-key 的元素
    const DEFAULT_LOCALE = 'zh-CN';
    const LOCALE_STORAGE_KEY = 'fm_locale';

    async function loadLocale(locale) {
      try {
        const res = await fetch(`/locales/${locale}.json`, {cache: 'no-cache'});
        if (!res.ok) throw new Error('locale not found: ' + locale);
        return await res.json();
      } catch (err) {
        console.warn('Failed to load locale', locale, err);
        if (locale !== DEFAULT_LOCALE) {
          // 回退到默认
          return loadLocale(DEFAULT_LOCALE);
        }
        return {};
      }
    }

    function applyTranslations(translations) {
      document.querySelectorAll('[data-i18n-key]').forEach(el => {
        const key = el.dataset.i18nKey;
        if (!key) return;
        const txt = translations[key];
        if (typeof txt === 'string') {
          // 如果元素有 data-i18n-html="true" 则使用 innerHTML（谨慎）
          if (el.dataset.i18nHtml === 'true') {
            el.innerHTML = txt;
          } else {
            el.textContent = txt;
          }
        }
      });
    }

    async function initI18n() {
      const saved = localStorage.getItem(LOCALE_STORAGE_KEY);
      let locale = saved || (navigator.language && navigator.language.startsWith('en') ? 'en' : 'zh-CN');
      // 暴露切换函数
      window.FM = window.FM || {};
      window.FM.setLocale = async (newLocale) => {
        localStorage.setItem(LOCALE_STORAGE_KEY, newLocale);
        const t = await loadLocale(newLocale);
        applyTranslations(t);
      };
      // 首次加载
      const translations = await loadLocale(locale);
      applyTranslations(translations);
    }

    // 初始化（非阻塞）
    document.addEventListener('DOMContentLoaded', initI18n);
    </script>
</head>

<body>
  <header>
    <h1 data-i18n-key="app_title">🎸 吉他指板视觉化练习工具</h1>
    <div>
      <label for="langSelect" data-i18n-key="interface_language">界面语言</label>
      <select id="langSelect" aria-label="语言选择">
        <option value="zh-CN">中文</option>
        <option value="en">English</option>
      </select>
    </div>
  </header>

  <main>
    <button id="startBtn" data-i18n-key="btn_start">开始练习</button>
    <p id="status" data-i18n-key="status_ready">准备就绪</p>
  </main>

  <script>
    // 语言选择 UI 绑定（简单）
    const sel = document.getElementById('langSelect');
    const LOCALE_STORAGE_KEY = 'fm_locale';
    const saved = localStorage.getItem(LOCALE_STORAGE_KEY);
    if (saved) sel.value = saved;
    sel.addEventListener('change', async (e) => {
      const newLoc = e.target.value;
      if (window.FM && typeof window.FM.setLocale === 'function') {
        await window.FM.setLocale(newLoc);
      }
      localStorage.setItem(LOCALE_STORAGE_KEY, newLoc);
    });
  </script>
</body>

</html>